This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*.elm, **/*.ts
- Files matching these patterns are excluded: node_modules/
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded

Additional Info:
----------------

================================================================
Directory Structure
================================================================
src/
  Components/
    AccountStatusBanner.elm
    LimitBanner.elm
    ProgressIndicator.elm
    SetupLayout.elm
  Onboarding/
    Steps/
      AddAgents.elm
      CompanyDetails.elm
      EnterpriseForm.elm
      LicensingSettings.elm
      Payment.elm
      PlanSelection.elm
      UserDetails.elm
    Onboarding.elm
  Utils/
    MyDate.elm
    QuoteHeader.elm
    RandomOrgName.elm
  Accept.elm
  AddAgent.elm
  AgeCalc.elm
  BirthdayRules.elm
  Calculator.elm
  CarrierNaic.elm
  ChangePlan.elm
  ChoosePlan.elm
  Compare.elm
  Contact.elm
  Contacts.elm
  CsvProcessor.elm
  Dashboard.elm
  Decline.elm
  Eligibility.elm
  EmailScheduler.elm
  Home.elm
  Login.elm
  Logout.elm
  Main.elm
  main.ts
  MyIcon.elm
  OnboardingNew.elm
  Ports.elm
  Profile.elm
  Quote.elm
  QuoteBirthdayRules.elm
  Schedule.elm
  SelfServiceOnboarding.elm
  Settings.elm
  Signup.elm
  StateRegions.elm
  Subscription.elm
  TempLanding.elm
  vite-env.d.ts
  Waitlist.elm
  Walkthrough.elm
vite.config.ts

================================================================
Files
================================================================

================
File: src/Components/AccountStatusBanner.elm
================
module Components.AccountStatusBanner exposing (AccountStatusDetails, view)

import Html exposing (Html, a, button, div, h3, p, span, text)
import Html.Attributes exposing (attribute, class, href)
import Html.Events exposing (onClick)
import Json.Decode as Decode exposing (Decoder, int, string)
import Json.Decode.Pipeline as Pipeline
import Svg exposing (path, svg)
import Svg.Attributes as SvgAttr exposing (clipRule, d, fill, fillRule, viewBox)



-- Account status types


type alias AccountStatus =
    String


type alias AccountStatusDetails =
    { status : AccountStatus
    , message : String
    , organizationId : Int
    , organizationName : String
    , organizationSlug : String
    , subscriptionTier : String
    , subscriptionStatus : String
    , agentLimit : Int
    , contactLimit : Int
    , currentAgentCount : Int
    , currentContactCount : Int
    , billingCycleEnd : Maybe String
    , paymentFailureCount : Int
    }



-- Decoder for account status details


accountStatusDetailsDecoder : Decoder AccountStatusDetails
accountStatusDetailsDecoder =
    Decode.succeed AccountStatusDetails
        |> Pipeline.required "status" string
        |> Pipeline.required "message" string
        |> Pipeline.required "organizationId" int
        |> Pipeline.required "organizationName" string
        |> Pipeline.required "organizationSlug" string
        |> Pipeline.required "subscriptionTier" string
        |> Pipeline.required "subscriptionStatus" string
        |> Pipeline.required "agentLimit" int
        |> Pipeline.required "contactLimit" int
        |> Pipeline.required "currentAgentCount" int
        |> Pipeline.required "currentContactCount" int
        |> Pipeline.optional "billingCycleEnd" (Decode.nullable string) Nothing
        |> Pipeline.required "paymentFailureCount" int



-- Function to determine banner color class based on status


getBannerColorClass : AccountStatus -> String
getBannerColorClass status =
    case status of
        "warning" ->
            "bg-yellow-50 border-yellow-200 text-yellow-800"

        "error" ->
            "bg-red-50 border-red-200 text-red-800"

        "success" ->
            "bg-green-50 border-green-200 text-green-800"

        "info" ->
            "bg-blue-50 border-blue-200 text-blue-800"

        _ ->
            "bg-gray-50 border-gray-200 text-gray-800"



-- Function to determine icon color class based on status


getIconColorClass : AccountStatus -> String
getIconColorClass status =
    case status of
        "warning" ->
            "text-yellow-600"

        "error" ->
            "text-red-600"

        "success" ->
            "text-green-600"

        "info" ->
            "text-blue-600"

        _ ->
            "text-gray-600"



-- Function to determine button color class based on status


getButtonColorClass : AccountStatus -> String
getButtonColorClass status =
    case status of
        "warning" ->
            "bg-yellow-100 hover:bg-yellow-200 text-yellow-700"

        "error" ->
            "bg-red-100 hover:bg-red-200 text-red-700"

        "success" ->
            "bg-green-100 hover:bg-green-200 text-green-700"

        "info" ->
            "bg-blue-100 hover:bg-blue-200 text-blue-700"

        _ ->
            "bg-gray-100 hover:bg-gray-200 text-gray-700"



-- Main view function for the account status banner


view : Maybe AccountStatusDetails -> msg -> Html msg
view maybeStatus closeMsg =
    case maybeStatus of
        Just status ->
            div
                [ class ("p-3 sm:p-4 mb-3 sm:mb-4 border rounded-lg flex flex-col sm:flex-row sm:items-start sm:justify-between " ++ getBannerColorClass status.status)
                , attribute "role" "alert"
                ]
                [ div [ class "flex items-start" ]
                    [ div [ class "flex-shrink-0" ]
                        [ div [ class ("p-1 rounded-full mr-2 sm:mr-3 " ++ getIconColorClass status.status) ]
                            [ svg
                                [ SvgAttr.class "w-4 h-4 sm:w-5 sm:h-5"
                                , SvgAttr.fill "currentColor"
                                , SvgAttr.viewBox "0 0 20 20"
                                ]
                                [ path
                                    [ SvgAttr.fillRule "evenodd"
                                    , SvgAttr.d "M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    , SvgAttr.clipRule "evenodd"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    , div [ class "flex-grow pr-8 sm:pr-0" ]
                        [ div [ class "font-medium text-sm sm:text-base" ] [ text (getStatusTitle status.status) ]
                        , p [ class "text-xs sm:text-sm" ] [ text status.message ]
                        , viewLimitsInfo status
                        ]
                    ]
                , button
                    [ class ("p-1.5 rounded-lg absolute top-2 right-2 sm:static " ++ getButtonColorClass status.status)
                    , onClick closeMsg
                    ]
                    [ svg
                        [ SvgAttr.class "w-4 h-4"
                        , SvgAttr.fill "currentColor"
                        , SvgAttr.viewBox "0 0 20 20"
                        ]
                        [ path
                            [ SvgAttr.fillRule "evenodd"
                            , SvgAttr.d "M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            , SvgAttr.clipRule "evenodd"
                            ]
                            []
                        ]
                    ]
                ]

        Nothing ->
            div [] []



-- Helper function to display resource limits information


viewLimitsInfo : AccountStatusDetails -> Html msg
viewLimitsInfo status =
    if status.currentAgentCount >= status.agentLimit || status.currentContactCount >= status.contactLimit then
        div [ class "mt-1 sm:mt-2 text-xs sm:text-sm" ]
            [ if status.currentAgentCount >= status.agentLimit then
                div [ class "mb-1" ]
                    [ text ("Agents: " ++ String.fromInt status.currentAgentCount ++ "/" ++ String.fromInt status.agentLimit ++ " ")
                    , a [ href "/change-plan", class "underline" ] [ text "Upgrade" ]
                    ]

              else
                text ""
            , if status.currentContactCount >= status.contactLimit then
                div []
                    [ text ("Contacts: " ++ String.fromInt status.currentContactCount ++ "/" ++ String.fromInt status.contactLimit ++ " ")
                    , a [ href "/change-plan", class "underline" ] [ text "Upgrade" ]
                    ]

              else
                text ""
            ]

    else
        text ""



-- Helper function to get a human-readable status title


getStatusTitle : AccountStatus -> String
getStatusTitle status =
    case status of
        "warning" ->
            "Warning"

        "error" ->
            "Error"

        "success" ->
            "Success"

        "info" ->
            "Information"

        "limit_reached" ->
            "Resource Limit Reached"

        "payment_failed" ->
            "Payment Failed"

        "subscription_expiring" ->
            "Subscription Expiring"

        _ ->
            "Notice"

================
File: src/Components/LimitBanner.elm
================
module Components.LimitBanner exposing (LimitWarning(..), Model, Msg, init, update, view, viewLimitBanner)

import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick)
import Http
import Json.Decode as Decode exposing (Decoder, int, string)
import Json.Decode.Pipeline as Pipeline
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)


type LimitWarning
    = AgentLimit Int Int -- currentCount, maxAllowed
    | ContactLimit Int Int -- currentCount, maxAllowed
    | TrialEnding String -- date when trial ends
    | CustomWarning String String -- title, message


type alias Model =
    { warning : Maybe LimitWarning
    , limits : Maybe LimitInfo
    , error : Maybe String
    }


type alias LimitInfo =
    { tierId : String
    , tierName : String
    , agentLimit : Int
    , contactLimit : Int
    }


type Msg
    = GotLimits (Result Http.Error LimitInfo)
    | CloseBanner


init : ( Model, Cmd Msg )
init =
    ( { warning = Nothing
      , limits = Nothing
      , error = Nothing
      }
    , fetchLimits GotLimits
    )


fetchLimits : (Result Http.Error LimitInfo -> msg) -> Cmd msg
fetchLimits toMsg =
    Http.request
        { method = "GET"
        , url = "/api/organizations/my-subscription"
        , headers = []
        , body = Http.emptyBody
        , expect = Http.expectJson toMsg limitInfoDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


limitInfoDecoder : Decoder LimitInfo
limitInfoDecoder =
    Decode.succeed LimitInfo
        |> Pipeline.required "tierId" string
        |> Pipeline.required "tierName" string
        |> Pipeline.required "agentLimit" int
        |> Pipeline.required "contactLimit" int


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GotLimits (Ok limitInfo) ->
            ( { model | limits = Just limitInfo }, Cmd.none )

        GotLimits (Err error) ->
            ( { model | error = Just (httpErrorToString error) }, Cmd.none )

        CloseBanner ->
            ( { model | warning = Nothing }, Cmd.none )


httpErrorToString : Http.Error -> String
httpErrorToString error =
    case error of
        Http.BadUrl url ->
            "Bad URL: " ++ url

        Http.Timeout ->
            "Request timed out"

        Http.NetworkError ->
            "Network error"

        Http.BadStatus statusCode ->
            "Bad status: " ++ String.fromInt statusCode

        Http.BadBody message ->
            "Bad body: " ++ message


view : Model -> Html Msg
view model =
    case model.warning of
        Nothing ->
            text ""

        Just warning ->
            viewLimitBanner warning CloseBanner


viewLimitBanner : LimitWarning -> msg -> Html msg
viewLimitBanner warning closeMsg =
    let
        ( title, message, upgradeText ) =
            case warning of
                AgentLimit current max ->
                    ( "Notice"
                    , "Your account has " ++ String.fromInt current ++ " agents, but your plan only allows for " ++ String.fromInt max ++ ". Please remove some agents or upgrade your plan."
                    , "Upgrade"
                    )

                ContactLimit current max ->
                    ( "Notice"
                    , "Your account has " ++ String.fromInt current ++ " contacts, but your plan only allows for " ++ String.fromInt max ++ ". Please upgrade your plan to add more contacts."
                    , "Upgrade"
                    )

                TrialEnding date ->
                    ( "Trial Ending Soon"
                    , "Your trial will end on " ++ date ++ ". Please upgrade your plan to continue using all features."
                    , "Upgrade"
                    )

                CustomWarning customTitle customMessage ->
                    ( customTitle
                    , customMessage
                    , "Upgrade"
                    )
    in
    div [ class "bg-amber-50 border-l-4 border-amber-400 p-4 mb-6" ]
        [ div [ class "flex justify-between" ]
            [ div [ class "flex" ]
                [ div [ class "flex-shrink-0" ]
                    [ div [ class "h-5 w-5 text-amber-400" ]
                        [ svg [ viewBox "0 0 20 20", fill "currentColor" ]
                            [ path [ fillRule "evenodd", d "M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z", clipRule "evenodd" ] []
                            ]
                        ]
                    ]
                , div [ class "ml-3" ]
                    [ p [ class "text-sm text-amber-700 font-medium" ]
                        [ text title ]
                    , p [ class "text-sm text-amber-700 mt-1" ]
                        [ text message ]
                    ]
                ]
            , div [ class "flex items-center" ]
                [ a [ href "/change-plan", class "mr-4 text-sm font-medium text-amber-700 underline hover:text-amber-600" ]
                    [ text upgradeText ]
                , button
                    [ class "rounded-md text-amber-500 hover:bg-amber-100 focus:outline-none focus:ring-2 focus:ring-amber-500"
                    , onClick closeMsg
                    ]
                    [ span [ class "sr-only" ] [ text "Dismiss" ]
                    , div [ class "h-5 w-5" ]
                        [ svg [ viewBox "0 0 20 20", fill "currentColor" ]
                            [ path [ fillRule "evenodd", d "M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z", clipRule "evenodd" ] []
                            ]
                        ]
                    ]
                ]
            ]
        ]

================
File: src/Components/ProgressIndicator.elm
================
module Components.ProgressIndicator exposing (Step, view)

import Html exposing (..)
import Html.Attributes exposing (..)


type alias Step =
    { icon : String
    , title : String
    , description : String
    , isCompleted : Bool
    , isActive : Bool
    }


view : List Step -> Html msg
view steps =
    div 
        [ class "md:fixed hidden md:block left-0 top-0 bottom-0 w-[280px] bg-white border-r border-[#eaecf0] overflow-y-auto" ]
        [ div [ class "flex flex-col h-full px-4 sm:px-8 py-6 sm:py-8" ]
            [ -- Logo
              div [ class "mb-6 sm:mb-14" ]
                [ div [ class "flex items-center" ]
                    [ a
                        [ href "/"
                        , class "cursor-pointer"
                        ]
                        [ img
                            [ src "/images/medicare-max-logo.png"
                            , class "h-6 sm:h-8 w-auto"
                            , alt "Medicare Max logo"
                            ]
                            []
                        ]
                    ]
                ]

            -- Steps
            , div [ class "flex-1" ]
                [ div [ class "space-y-4 sm:space-y-7" ] (List.map viewStep steps)
                ]

            -- Help email
            , div [ class "text-xs sm:text-sm text-[#667085] flex items-center mt-6 sm:mt-8" ]
                [ span [ class "mr-2" ] [ text "✉️" ]
                , text "help@medicaremax.com"
                ]
            ]
        ]


viewStep : Step -> Html msg
viewStep step =
    div
        [ class "flex items-start"
        , classList [ ( "opacity-60", not step.isActive && not step.isCompleted ) ]
        ]
        [ div
            [ class "shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-3 transition-all duration-300"
            , classList
                [ ( "bg-[#03045e] text-white", step.isActive )
                , ( "bg-[#03045e]/90 text-white", step.isCompleted )
                , ( "bg-[#f9fafb] text-[#667085] border border-[#eaecf0]", not step.isActive && not step.isCompleted )
                ]
            ]
            [ span [ class "text-base" ] [ text step.icon ]
            ]
        , div [ class "flex-1" ]
            [ h3
                [ class "text-sm font-medium transition-colors duration-300"
                , classList
                    [ ( "text-[#101828]", step.isActive )
                    , ( "text-[#101828]/90", step.isCompleted )
                    , ( "text-[#667085]", not step.isActive && not step.isCompleted )
                    ]
                ]
                [ text step.title ]
            , p [ class "text-sm text-[#667085] mt-1 leading-relaxed" ]
                [ text step.description ]
            ]
        ]

================
File: src/Components/SetupLayout.elm
================
module Components.SetupLayout exposing (SetupStep(..), view)

import Components.ProgressIndicator as ProgressIndicator
import Html exposing (..)
import Html.Attributes exposing (alt, class, src, style)


type SetupStep
    = PlanSelection
    | OrganizationSetup
    | AgentSetup


type alias StepInfo =
    { step : SetupStep
    , icon : String
    , title : String
    , description : String
    }


view : SetupStep -> Bool -> Int -> List (Html msg) -> Html msg
view currentStep isBasicPlan stepNumber content =
    div [ class "min-h-screen bg-gray-50 flex" ]
        [ viewProgressIndicator currentStep isBasicPlan stepNumber
        , div [ class "flex-1 md:ml-[280px] pb-16 sm:pb-24" ]
            [ div [ class "max-w-3xl mx-auto py-4 sm:py-6 px-4 sm:px-6 lg:px-8" ]
                (viewMobileProgressSteps currentStep isBasicPlan stepNumber :: content)
            ]
        ]

-- Mobile progress steps shown at the top of the content area on small screens
viewMobileProgressSteps : SetupStep -> Bool -> Int -> Html msg
viewMobileProgressSteps currentStep isBasicPlan stepNumber =
    let
        steps = 
            if isBasicPlan then
                5 -- Basic plan has 5 steps
            else
                6 -- Multi-agent plan has 6 steps
                
        currentStepIndex =
            case currentStep of
                PlanSelection ->
                    0
                    
                OrganizationSetup ->
                    stepNumber
                    
                AgentSetup ->
                    stepNumber
                    
        -- Calculate progress percentage
        progressPercentage =
            String.fromInt (min 100 (ceiling (toFloat (currentStepIndex * 100) / toFloat (steps - 1))))
            
        -- Get current step number and title
        stepTitle =
            case (currentStep, stepNumber) of
                (PlanSelection, _) ->
                    "Choose Plan"
                    
                (OrganizationSetup, 2) ->
                    "Personal Details"
                    
                (OrganizationSetup, 3) ->
                    "Company Details"
                    
                (OrganizationSetup, 4) ->
                    "Licensing Settings"
                    
                (AgentSetup, 5) ->
                    "Add Team Members"
                    
                (OrganizationSetup, 5) ->
                    if isBasicPlan then
                        "Payment"
                    else
                        "Licensing Settings"
                    
                (OrganizationSetup, 6) ->
                    "Payment"
                    
                _ ->
                    "Setup"
    in
    div [ class "md:hidden mb-6 pb-4 border-b border-gray-200" ]
        [ div [ class "flex justify-between items-center mb-4" ]
            [ img
                [ src "/images/medicare-max-logo.png"
                , class "h-6 w-auto"
                , alt "Medicare Max logo"
                ]
                []
            , div [ class "text-xs text-gray-500" ]
                [ text "Step "
                , text (String.fromInt (currentStepIndex + 1))
                , text " of "
                , text (String.fromInt steps)
                ]
            ]
        , h1 [ class "text-xl font-semibold text-gray-900 mb-2" ]
            [ text stepTitle ]
        , div [ class "h-1 w-full bg-gray-200 rounded overflow-hidden" ]
            [ div
                [ class "h-full bg-[#03045e] transition-all duration-300"
                , style "width" (progressPercentage ++ "%")
                ]
                []
            ]
        ]


viewProgressIndicator : SetupStep -> Bool -> Int -> Html msg
viewProgressIndicator currentStep isBasicPlan stepNumber =
    let
        basicSteps =
            [ { step = PlanSelection
              , icon = "1"
              , title = "Choose Plan"
              , description = "Select your subscription"
              }
            , { step = OrganizationSetup
              , icon = "2"
              , title = "Personal Details"
              , description = "Enter your information"
              }
            , { step = OrganizationSetup
              , icon = "3"
              , title = "Company Details"
              , description = "Agency information"
              }
            , { step = OrganizationSetup
              , icon = "4"
              , title = "Licensing Settings"
              , description = "States and carriers"
              }
            , { step = OrganizationSetup
              , icon = "5"
              , title = "Payment"
              , description = "Complete setup"
              }
            ]

        multiAgentSteps =
            [ { step = PlanSelection
              , icon = "1"
              , title = "Choose Plan"
              , description = "Select your subscription"
              }
            , { step = OrganizationSetup
              , icon = "2"
              , title = "Personal Details"
              , description = "Enter your information"
              }
            , { step = OrganizationSetup
              , icon = "3"
              , title = "Company Details"
              , description = "Agency information"
              }
            , { step = OrganizationSetup
              , icon = "4"
              , title = "Licensing Settings"
              , description = "States and carriers"
              }
            , { step = AgentSetup
              , icon = "5"
              , title = "Add Team Members"
              , description = "Invite your team"
              }
            , { step = OrganizationSetup
              , icon = "6"
              , title = "Payment"
              , description = "Complete setup"
              }
            ]

        steps =
            if isBasicPlan then
                basicSteps

            else
                multiAgentSteps

        makeStep index info =
            { icon = info.icon
            , title = info.title
            , description = info.description
            , isCompleted = isStepComplete currentStep info.step index stepNumber
            , isActive = info.step == currentStep && index == stepNumber
            }

        -- Calculate progress percentage for the progress bar
        totalSteps =
            List.length steps

        currentStepIndex =
            case currentStep of
                PlanSelection ->
                    0

                OrganizationSetup ->
                    stepNumber

                AgentSetup ->
                    stepNumber

        progressPercentage =
            String.fromInt (min 100 (ceiling (toFloat (currentStepIndex * 100) / toFloat (totalSteps - 1))))

        progressBar =
            div [ class "px-8 mt-4" ]
                [ div [ class "h-1 w-full bg-gray-200 rounded overflow-hidden" ]
                    [ div
                        [ class "h-full bg-[#03045e] transition-all duration-300"
                        , style "width" (progressPercentage ++ "%")
                        ]
                        []
                    ]
                , div [ class "mt-2 text-xs text-gray-500 flex justify-between" ]
                    [ span [] [ text "Setup Progress" ]
                    , span [] [ text (progressPercentage ++ "%") ]
                    ]
                ]
    in
    div []
        [ ProgressIndicator.view (List.indexedMap makeStep steps)
        , progressBar
        ]


isStepComplete : SetupStep -> SetupStep -> Int -> Int -> Bool
isStepComplete currentStep step stepIndex currentStepNumber =
    case ( currentStep, step ) of
        ( PlanSelection, _ ) ->
            -- When on plan selection, no steps are completed
            False

        ( OrganizationSetup, PlanSelection ) ->
            -- When on org settings, plan selection is completed
            True

        ( OrganizationSetup, OrganizationSetup ) ->
            -- For org setup steps, complete those before the current one
            stepIndex < currentStepNumber

        ( OrganizationSetup, _ ) ->
            -- Other steps aren't completed yet
            False

        ( AgentSetup, AgentSetup ) ->
            -- The current step isn't completed
            False

        ( AgentSetup, _ ) ->
            -- When on agent setup, all previous steps are completed
            True

================
File: src/Onboarding/Steps/AddAgents.elm
================
module Onboarding.Steps.AddAgents exposing
    ( Model
    , Msg
    , OutMsg(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)
import Time
import Url



-- MODEL


type alias Model =
    { agents : List Agent
    , newAgent : NewAgentForm
    , isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , showAddForm : Bool
    , pendingSave : Maybe String
    , emailStatus : EmailStatus
    , isOnboarding : Bool
    }


type alias Agent =
    { id : String
    , firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    }


type alias NewAgentForm =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    }


type EmailStatus
    = NotChecked
    | Checking
    | Valid
    | Invalid String


init : Nav.Key -> String -> Bool -> ( Model, Cmd Msg )
init key orgSlug isOnboarding =
    ( { agents = []
      , newAgent =
            { firstName = ""
            , lastName = ""
            , email = ""
            , phone = ""
            , isAdmin = False
            , isAgent = True
            }
      , isLoading = not isOnboarding -- Only set loading true if not in onboarding
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , showAddForm = isOnboarding -- Auto-show the add form in onboarding
      , pendingSave = Nothing
      , emailStatus = NotChecked
      , isOnboarding = isOnboarding
      }
    , if isOnboarding then
        -- Skip fetching agents during onboarding
        Cmd.none

      else
        -- Fetch existing agents when not in onboarding
        fetchAgents orgSlug
    )



-- UPDATE


type Msg
    = UpdateFirstName String
    | UpdateLastName String
    | UpdateEmail String
    | UpdatePhone String
    | UpdateAdminCheckbox Bool
    | UpdateAgentCheckbox Bool
    | AddAgent
    | SaveAgent
    | CancelAddAgent
    | NextStepClicked
    | GotAgents (Result Http.Error (List Agent))
    | AgentSaved (Result Http.Error ())
    | CheckAgentEmail
    | GotEmailResponse (Result Http.Error EmailResponse)
    | NoOp


type OutMsg
    = NoOutMsg
    | NextStep
    | ShowError String


type alias EmailResponse =
    { available : Bool
    , message : String
    }


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        UpdateFirstName value ->
            ( { model | newAgent = updateNewAgentField model.newAgent "firstName" value }
            , Cmd.none
            , NoOutMsg
            )

        UpdateLastName value ->
            ( { model | newAgent = updateNewAgentField model.newAgent "lastName" value }
            , Cmd.none
            , NoOutMsg
            )

        UpdateEmail value ->
            ( { model | newAgent = updateNewAgentField model.newAgent "email" value, emailStatus = NotChecked }
            , Cmd.none
            , NoOutMsg
            )

        UpdatePhone value ->
            ( { model | newAgent = updateNewAgentField model.newAgent "phone" value }
            , Cmd.none
            , NoOutMsg
            )

        UpdateAdminCheckbox value ->
            let
                -- Ensure at least one role is selected
                newIsAgent =
                    if not value then
                        True
                        -- If admin is being unchecked, ensure agent is checked

                    else
                        model.newAgent.isAgent

                updatedNewAgent =
                    { firstName = model.newAgent.firstName
                    , lastName = model.newAgent.lastName
                    , email = model.newAgent.email
                    , phone = model.newAgent.phone
                    , isAdmin = value
                    , isAgent = newIsAgent
                    }
            in
            ( { model | newAgent = updatedNewAgent }
            , Cmd.none
            , NoOutMsg
            )

        UpdateAgentCheckbox value ->
            let
                -- Ensure at least one role is selected
                newIsAdmin =
                    if not value then
                        True
                        -- If agent is being unchecked, ensure admin is checked

                    else
                        model.newAgent.isAdmin

                updatedNewAgent =
                    { firstName = model.newAgent.firstName
                    , lastName = model.newAgent.lastName
                    , email = model.newAgent.email
                    , phone = model.newAgent.phone
                    , isAgent = value
                    , isAdmin = newIsAdmin
                    }
            in
            ( { model | newAgent = updatedNewAgent }
            , Cmd.none
            , NoOutMsg
            )

        AddAgent ->
            ( { model | showAddForm = True }
            , Cmd.none
            , NoOutMsg
            )

        SaveAgent ->
            if isFormValid model then
                ( { model | isLoading = True }
                , saveAgent model.orgSlug model.newAgent
                , NoOutMsg
                )

            else
                ( { model | error = Just "Please fill out all required fields and ensure email is valid" }
                , Cmd.none
                , ShowError "Please fill out all required fields and ensure email is valid"
                )

        CancelAddAgent ->
            ( { model | showAddForm = False }
            , Cmd.none
            , NoOutMsg
            )

        NextStepClicked ->
            ( model
            , Cmd.none
            , NextStep
            )

        GotAgents result ->
            case result of
                Ok agents ->
                    ( { model | agents = agents, isLoading = False }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to load agents"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to load agents"
                    )

        AgentSaved result ->
            case result of
                Ok _ ->
                    ( { model
                        | isLoading = False
                        , showAddForm = False
                        , newAgent =
                            { firstName = ""
                            , lastName = ""
                            , email = ""
                            , phone = ""
                            , isAdmin = False
                            , isAgent = True
                            }
                        , emailStatus = NotChecked
                      }
                    , fetchAgents model.orgSlug
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to save agent"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to save agent"
                    )

        CheckAgentEmail ->
            if String.isEmpty (String.trim model.newAgent.email) then
                ( { model | emailStatus = NotChecked }
                , Cmd.none
                , NoOutMsg
                )

            else if model.emailStatus == Checking then
                ( model, Cmd.none, NoOutMsg )

            else
                ( { model | emailStatus = Checking }
                , checkAgentEmail model.orgSlug model.newAgent.email
                , NoOutMsg
                )

        GotEmailResponse result ->
            case result of
                Ok response ->
                    ( { model
                        | emailStatus =
                            if response.available then
                                Valid

                            else
                                Invalid response.message
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | emailStatus = Invalid "Failed to check email availability"
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Add Team Members" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Invite agents to join your organization" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , viewAgentsList model
                , viewAddAgentSection model
                , div [ class "flex justify-end space-x-4 mt-8" ]
                    [ button
                        [ class "px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick NextStepClicked
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewLoading : Html msg
viewLoading =
    div [ class "text-center py-12" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading..." ]
        ]


viewAgentsList : Model -> Html Msg
viewAgentsList model =
    if model.isOnboarding && List.isEmpty model.agents then
        -- In onboarding with no agents, show a more appropriate message
        div [ class "bg-gray-50 p-6 rounded-lg text-center" ]
            [ p [ class "text-gray-500" ]
                [ text "Add team members who will have access to your Medicare Max portal." ]
            ]

    else if List.isEmpty model.agents then
        div [ class "bg-gray-50 p-6 rounded-lg text-center" ]
            [ p [ class "text-gray-500" ]
                [ text "No agents added yet. Add your first agent below." ]
            ]

    else
        div [ class "bg-white shadow rounded-lg overflow-hidden" ]
            [ div [ class "px-6 py-4 border-b border-gray-200" ]
                [ h2 [ class "text-lg font-medium text-gray-900" ]
                    [ text "Team Members" ]
                ]
            , div [ class "divide-y divide-gray-200" ]
                (List.map viewAgentItem model.agents)
            ]


viewAgentItem : Agent -> Html Msg
viewAgentItem agent =
    div [ class "px-6 py-4" ]
        [ div [ class "flex items-center justify-between" ]
            [ div [ class "flex items-center" ]
                [ div [ class "ml-4" ]
                    [ div [ class "text-sm font-medium text-gray-900" ]
                        [ text (agent.firstName ++ " " ++ agent.lastName) ]
                    , div [ class "text-sm text-gray-500" ]
                        [ text agent.email ]
                    ]
                ]
            , div [ class "flex space-x-2" ]
                [ if agent.isAdmin then
                    span [ class "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" ]
                        [ text "Admin" ]

                  else
                    text ""
                , if agent.isAgent then
                    span [ class "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" ]
                        [ text "Agent" ]

                  else
                    text ""
                ]
            ]
        ]


viewAddAgentSection : Model -> Html Msg
viewAddAgentSection model =
    div [ class "bg-white shadow rounded-lg overflow-hidden" ]
        [ div [ class "px-6 py-4 border-b border-gray-200" ]
            [ h2 [ class "text-lg font-medium text-gray-900" ]
                [ text "Add New Agent" ]
            ]
        , if model.showAddForm then
            div [ class "px-6 py-4" ]
                [ div [ class "space-y-6" ]
                    [ div [ class "grid grid-cols-2 gap-6" ]
                        [ div []
                            [ label [ class "block text-sm font-medium text-gray-700" ]
                                [ text "First Name" ]
                            , input
                                [ type_ "text"
                                , class "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                , value model.newAgent.firstName
                                , onInput UpdateFirstName
                                , placeholder "Enter first name"
                                ]
                                []
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700" ]
                                [ text "Last Name" ]
                            , input
                                [ type_ "text"
                                , class "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                , value model.newAgent.lastName
                                , onInput UpdateLastName
                                , placeholder "Enter last name"
                                ]
                                []
                            ]
                        ]
                    , div [ class "grid grid-cols-2 gap-6" ]
                        [ div []
                            [ label [ class "block text-sm font-medium text-gray-700" ]
                                [ text "Email" ]
                            , input
                                [ type_ "email"
                                , class "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                , value model.newAgent.email
                                , onInput UpdateEmail
                                , onBlur CheckAgentEmail
                                , placeholder "name@example.com"
                                ]
                                []
                            , viewEmailStatus model.emailStatus
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700" ]
                                [ text "Phone" ]
                            , input
                                [ type_ "tel"
                                , class "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                , value model.newAgent.phone
                                , onInput UpdatePhone
                                , placeholder "(555) 555-5555"
                                ]
                                []
                            ]
                        ]
                    , div []
                        [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                            [ text "Role (at least one required)" ]
                        , div [ class "flex items-center space-x-6" ]
                            [ label [ class "inline-flex items-center" ]
                                [ input
                                    [ type_ "checkbox"
                                    , class "rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    , checked model.newAgent.isAdmin
                                    , onClick (UpdateAdminCheckbox (not model.newAgent.isAdmin))
                                    ]
                                    []
                                , span [ class "ml-2 text-sm text-gray-700" ]
                                    [ text "Admin" ]
                                ]
                            , label [ class "inline-flex items-center" ]
                                [ input
                                    [ type_ "checkbox"
                                    , class "rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    , checked model.newAgent.isAgent
                                    , onClick (UpdateAgentCheckbox (not model.newAgent.isAgent))
                                    ]
                                    []
                                , span [ class "ml-2 text-sm text-gray-700" ]
                                    [ text "Agent" ]
                                ]
                            ]
                        ]
                    , div [ class "flex justify-end space-x-4 mt-6" ]
                        [ button
                            [ class "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                            , onClick CancelAddAgent
                            ]
                            [ text "Cancel" ]
                        , button
                            [ class "px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            , onClick SaveAgent
                            , disabled (not (isFormValid model))
                            ]
                            [ text "Add Agent" ]
                        ]
                    ]
                ]

          else
            div [ class "px-6 py-4 flex justify-center" ]
                [ button
                    [ class "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                    , onClick AddAgent
                    ]
                    [ span [ class "mr-2" ] [ text "+" ]
                    , text "Add Agent"
                    ]
                ]
        ]


viewEmailStatus : EmailStatus -> Html Msg
viewEmailStatus status =
    div [ class "mt-1 transition-all duration-200" ]
        [ case status of
            NotChecked ->
                text ""

            Checking ->
                div [ class "text-blue-600 text-sm flex items-center" ]
                    [ div [ class "animate-spin h-4 w-4 mr-2 border-2 border-blue-600 border-t-transparent rounded-full" ] []
                    , text "Checking availability..."
                    ]

            Valid ->
                div [ class "text-green-600 text-sm flex items-center" ]
                    [ -- Checkmark icon
                      svg
                        [ class "h-4 w-4 mr-1"
                        , viewBox "0 0 20 20"
                        , fill "currentColor"
                        ]
                        [ path
                            [ fillRule "evenodd"
                            , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                            , clipRule "evenodd"
                            ]
                            []
                        ]
                    , text "Email is available"
                    ]

            Invalid message ->
                div [ class "text-red-600 text-sm flex items-center" ]
                    [ -- X icon
                      svg
                        [ class "h-4 w-4 mr-1"
                        , viewBox "0 0 20 20"
                        , fill "currentColor"
                        ]
                        [ path
                            [ fillRule "evenodd"
                            , d "M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            , clipRule "evenodd"
                            ]
                            []
                        ]
                    , text message
                    ]
        ]



-- HELPERS


updateNewAgentField : NewAgentForm -> String -> String -> NewAgentForm
updateNewAgentField form field value =
    case field of
        "firstName" ->
            { form | firstName = value }

        "lastName" ->
            { form | lastName = value }

        "email" ->
            { form | email = value }

        "phone" ->
            { form | phone = value }

        _ ->
            form


isFormValid : Model -> Bool
isFormValid model =
    let
        isEmailValid =
            model.emailStatus == Valid

        areNamesValid =
            not (String.isEmpty (String.trim model.newAgent.firstName))
                && not (String.isEmpty (String.trim model.newAgent.lastName))

        isPhoneValid =
            not (String.isEmpty (String.trim model.newAgent.phone))

        hasValidRole =
            model.newAgent.isAdmin || model.newAgent.isAgent
    in
    isEmailValid && areNamesValid && isPhoneValid && hasValidRole



-- API CALLS


fetchAgents : String -> Cmd Msg
fetchAgents orgSlug =
    Http.get
        { url = "/api/organizations/" ++ orgSlug ++ "/agents"
        , expect = Http.expectJson GotAgents (Decode.list agentDecoder)
        }


saveAgent : String -> NewAgentForm -> Cmd Msg
saveAgent orgSlug agent =
    Http.post
        { url = "/api/organizations/" ++ orgSlug ++ "/agents"
        , body = Http.jsonBody (encodeNewAgent agent)
        , expect = Http.expectWhatever AgentSaved
        }


checkAgentEmail : String -> String -> Cmd Msg
checkAgentEmail orgSlug email =
    Http.get
        { url = "/api/organizations/" ++ orgSlug ++ "/check-email/" ++ Url.percentEncode email
        , expect = Http.expectJson GotEmailResponse emailResponseDecoder
        }



-- DECODERS & ENCODERS


agentDecoder : Decode.Decoder Agent
agentDecoder =
    Decode.succeed Agent
        |> Pipeline.required "id" Decode.string
        |> Pipeline.required "firstName" Decode.string
        |> Pipeline.required "lastName" Decode.string
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "phone" Decode.string
        |> Pipeline.required "isAdmin" Decode.bool
        |> Pipeline.required "isAgent" Decode.bool


encodeNewAgent : NewAgentForm -> Encode.Value
encodeNewAgent agent =
    Encode.object
        [ ( "firstName", Encode.string agent.firstName )
        , ( "lastName", Encode.string agent.lastName )
        , ( "email", Encode.string agent.email )
        , ( "phone", Encode.string agent.phone )
        , ( "isAdmin", Encode.bool agent.isAdmin )
        , ( "isAgent", Encode.bool agent.isAgent )
        ]


emailResponseDecoder : Decode.Decoder EmailResponse
emailResponseDecoder =
    Decode.map2 EmailResponse
        (Decode.field "available" Decode.bool)
        (Decode.field "message" Decode.string)



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Onboarding/Steps/CompanyDetails.elm
================
module Onboarding.Steps.CompanyDetails exposing
    ( Model
    , Msg
    , OutMsg(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import File exposing (File)
import File.Select as Select
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Task



-- MODEL


type alias Model =
    { agencyName : String
    , website : String
    , phone : String
    , primaryColor : String
    , secondaryColor : String
    , logo : Maybe String
    , isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , uploadingLogo : Bool
    , sessionToken : String
    , loadedFromSession : Bool
    }


init : Nav.Key -> String -> String -> ( Model, Cmd Msg )
init key orgSlug sessionToken =
    ( { agencyName = ""
      , website = ""
      , phone = ""
      , primaryColor = "#6B46C1"
      , secondaryColor = "#9F7AEA"
      , logo = Nothing
      , isLoading = True
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , uploadingLogo = False
      , sessionToken = sessionToken
      , loadedFromSession = False
      }
    , fetchCompanyDetails orgSlug
    )



-- UPDATE


type Msg
    = UpdateAgencyName String
    | UpdateWebsite String
    | UpdatePhone String
    | UpdatePrimaryColor String
    | UpdateSecondaryColor String
    | UploadLogo
    | GotLogo File
    | GotLogoUrl String
    | LogoUploaded (Result Http.Error String)
    | NextStepClicked
    | SkipStepClicked
    | GotCompanyDetails (Result Http.Error CompanyDetailsResponse)
    | CompanyDetailsSaved (Result Http.Error ())
    | NoOp


type OutMsg
    = NoOutMsg
    | NextStep
    | ShowError String


type alias CompanyDetailsResponse =
    { agencyName : String
    , website : String
    , phone : String
    , primaryColor : String
    , secondaryColor : String
    , logo : Maybe String
    }


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        UpdateAgencyName value ->
            ( { model | agencyName = value }, Cmd.none, NoOutMsg )

        UpdateWebsite value ->
            ( { model | website = value }, Cmd.none, NoOutMsg )

        UpdatePhone value ->
            ( { model | phone = value }, Cmd.none, NoOutMsg )

        UpdatePrimaryColor value ->
            ( { model | primaryColor = value }, Cmd.none, NoOutMsg )

        UpdateSecondaryColor value ->
            ( { model | secondaryColor = value }, Cmd.none, NoOutMsg )

        UploadLogo ->
            ( model, Select.file [ "image/png", "image/jpeg" ] GotLogo, NoOutMsg )

        GotLogo file ->
            ( { model | uploadingLogo = True }, Task.perform GotLogoUrl (File.toUrl file), NoOutMsg )

        GotLogoUrl url ->
            ( { model | logo = Just url, uploadingLogo = False }, Cmd.none, NoOutMsg )

        LogoUploaded result ->
            case result of
                Ok url ->
                    ( { model | logo = Just url, uploadingLogo = False }, Cmd.none, NoOutMsg )

                Err _ ->
                    ( { model | error = Just "Failed to upload logo", uploadingLogo = False }
                    , Cmd.none
                    , ShowError "Failed to upload logo"
                    )

        NextStepClicked ->
            ( { model | isLoading = True }
            , saveCompanyDetails model
            , NoOutMsg
            )

        SkipStepClicked ->
            ( model, Cmd.none, NextStep )

        GotCompanyDetails result ->
            case result of
                Ok response ->
                    ( { model
                        | agencyName = response.agencyName
                        , website = response.website
                        , phone = response.phone
                        , primaryColor = response.primaryColor
                        , secondaryColor = response.secondaryColor
                        , logo = response.logo
                        , isLoading = False
                        , loadedFromSession = True
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model | isLoading = False }, Cmd.none, NoOutMsg )

        CompanyDetailsSaved result ->
            case result of
                Ok _ ->
                    ( { model | isLoading = False }
                    , Cmd.none
                    , NextStep
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to save company details"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to save company details"
                    )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Company Details" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Tell us about your agency (all fields are optional)" ]
            , if model.loadedFromSession then
                p [ class "text-blue-600 mt-2 italic" ]
                    [ text "Your previously entered information has been loaded." ]

              else
                text ""
            ]
        , if model.isLoading then
            viewLoading

          else
            viewCompanyDetailsForm model
        ]


viewCompanyDetailsForm : Model -> Html Msg
viewCompanyDetailsForm model =
    div [ class "space-y-8" ]
        [ div [ class "bg-white shadow rounded-lg p-6" ]
            [ h2 [ class "text-lg font-medium mb-4" ] [ text "Agency Settings" ]
            , div [ class "space-y-6" ]
                [ div [ class "space-y-4" ]
                    [ viewFormGroup "Agency Name"
                        (input
                            [ type_ "text"
                            , class "w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                            , value model.agencyName
                            , onInput UpdateAgencyName
                            , placeholder "Enter your agency name"
                            ]
                            []
                        )
                    , viewFormGroup "Primary Color"
                        (div [ class "flex items-center space-x-4" ]
                            [ input
                                [ type_ "color"
                                , class "w-16 h-10 p-1 border border-gray-300 rounded"
                                , value model.primaryColor
                                , onInput UpdatePrimaryColor
                                ]
                                []
                            , input
                                [ type_ "text"
                                , class "flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                , value model.primaryColor
                                , onInput UpdatePrimaryColor
                                ]
                                []
                            ]
                        )
                    , viewFormGroup "Secondary Color"
                        (div [ class "flex items-center space-x-4" ]
                            [ input
                                [ type_ "color"
                                , class "w-16 h-10 p-1 border border-gray-300 rounded"
                                , value model.secondaryColor
                                , onInput UpdateSecondaryColor
                                ]
                                []
                            , input
                                [ type_ "text"
                                , class "flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                , value model.secondaryColor
                                , onInput UpdateSecondaryColor
                                ]
                                []
                            ]
                        )
                    , viewFormGroup "Logo"
                        (div [ class "flex items-center space-x-4" ]
                            [ case model.logo of
                                Just logoUrl ->
                                    div [ class "flex items-center space-x-4" ]
                                        [ img
                                            [ src logoUrl
                                            , class "h-16 w-16 object-contain border border-gray-200 rounded"
                                            ]
                                            []
                                        , button
                                            [ class "px-4 py-2 text-sm text-blue-600 hover:text-blue-800 border border-blue-200 rounded"
                                            , onClick UploadLogo
                                            , disabled model.uploadingLogo
                                            ]
                                            [ text "Change Logo" ]
                                        ]

                                Nothing ->
                                    if model.uploadingLogo then
                                        div [ class "flex items-center space-x-2" ]
                                            [ div [ class "animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-blue-500" ] []
                                            , text "Uploading..."
                                            ]

                                    else
                                        button
                                            [ class "px-4 py-2 text-sm text-blue-600 hover:text-blue-800 border border-blue-200 rounded"
                                            , onClick UploadLogo
                                            ]
                                            [ text "Upload Logo" ]
                            ]
                        )
                    ]
                ]
            ]
        , if model.error /= Nothing then
            div [ class "bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded" ]
                [ text (Maybe.withDefault "" model.error) ]

          else
            text ""
        , div [ class "flex justify-center mt-8" ]
            [ button
                [ class "px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                , onClick NextStepClicked
                , disabled model.isLoading
                ]
                [ if model.isLoading then
                    div [ class "flex items-center justify-center" ]
                        [ div [ class "animate-spin mr-2 h-4 w-4 border-t-2 border-b-2 border-white rounded-full" ] []
                        , text "Saving..."
                        ]

                  else
                    text "Continue"
                ]
            ]
        ]


viewFormGroup : String -> Html Msg -> Html Msg
viewFormGroup labelText content =
    div [ class "mb-4" ]
        [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
            [ text labelText ]
        , content
        ]


viewLoading : Html msg
viewLoading =
    div [ class "flex justify-center items-center py-12" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading..." ]
        ]



-- HELPERS


isFormValid : Model -> Bool
isFormValid model =
    -- Agency name is now optional as it will be auto-generated
    True



-- API CALLS


fetchCompanyDetails : String -> Cmd Msg
fetchCompanyDetails _ =
    Http.get
        { url = "/api/onboarding/settings"
        , expect = Http.expectJson GotCompanyDetails companyDetailsDecoder
        }


saveCompanyDetails : Model -> Cmd Msg
saveCompanyDetails model =
    let
        url =
            "/api/onboarding/company-details"
    in
    Http.request
        { method = "POST"
        , headers = [] -- The session token is in the cookies, no need to pass it
        , url = url
        , body = Http.jsonBody (encodeCompanyDetails model)
        , expect = Http.expectWhatever CompanyDetailsSaved
        , timeout = Nothing
        , tracker = Nothing
        }



-- DECODERS & ENCODERS


companyDetailsDecoder : Decode.Decoder CompanyDetailsResponse
companyDetailsDecoder =
    Decode.field "companyDetailsModel"
        (Decode.map6 CompanyDetailsResponse
            (Decode.field "agencyName" Decode.string)
            (Decode.field "website" Decode.string)
            (Decode.field "phone" Decode.string)
            (Decode.field "primaryColor" Decode.string)
            (Decode.field "secondaryColor" Decode.string)
            (Decode.field "logo" (Decode.nullable Decode.string))
        )


encodeCompanyDetails : Model -> Encode.Value
encodeCompanyDetails model =
    Encode.object
        [ ( "agencyName", Encode.string model.agencyName )
        , ( "website", Encode.string model.website )
        , ( "phone", Encode.string model.phone )
        , ( "primaryColor", Encode.string model.primaryColor )
        , ( "secondaryColor", Encode.string model.secondaryColor )
        , ( "logo", Maybe.withDefault Encode.null (Maybe.map Encode.string model.logo) )
        ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Onboarding/Steps/EnterpriseForm.elm
================
module Onboarding.Steps.EnterpriseForm exposing
    ( Model
    , Msg
    , OutMsg(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)



-- MODEL


type alias Model =
    { companyName : String
    , contactName : String
    , email : String
    , phone : String
    , displayPhone : String
    , message : String
    , isSubmitting : Bool
    , isSubmitted : Bool
    , error : Maybe String
    , key : Nav.Key
    }


type Msg
    = UpdateCompanyName String
    | UpdateContactName String
    | UpdateEmail String
    | UpdatePhone String
    | UpdateMessage String
    | SubmitForm
    | SubmitSuccess
    | SubmitError String
    | BackToPlans


type OutMsg
    = NoOutMsg
    | BackToPlanSelection
    | ShowError String


init : Nav.Key -> ( Model, Cmd Msg )
init key =
    ( { companyName = ""
      , contactName = ""
      , email = ""
      , phone = ""
      , displayPhone = ""
      , message = ""
      , isSubmitting = False
      , isSubmitted = False
      , error = Nothing
      , key = key
      }
    , Cmd.none
    )



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        UpdateCompanyName value ->
            ( { model | companyName = value }
            , Cmd.none
            , NoOutMsg
            )

        UpdateContactName value ->
            ( { model | contactName = value }
            , Cmd.none
            , NoOutMsg
            )

        UpdateEmail value ->
            ( { model | email = value }
            , Cmd.none
            , NoOutMsg
            )

        UpdatePhone value ->
            let
                digitsOnly =
                    String.filter Char.isDigit value

                updatedPhone =
                    String.left 10 digitsOnly
            in
            ( { model
                | phone = updatedPhone
                , displayPhone = formatPhoneNumber updatedPhone
              }
            , Cmd.none
            , NoOutMsg
            )

        UpdateMessage value ->
            ( { model | message = value }
            , Cmd.none
            , NoOutMsg
            )

        SubmitForm ->
            if isFormValid model then
                ( { model | isSubmitting = True, error = Nothing }
                , submitEnterpriseForm model
                , NoOutMsg
                )

            else
                ( { model | error = Just "Please fill out all required fields" }
                , Cmd.none
                , NoOutMsg
                )

        SubmitSuccess ->
            ( { model | isSubmitted = True, isSubmitting = False }
            , Cmd.none
            , NoOutMsg
            )

        SubmitError errorMsg ->
            ( { model | error = Just errorMsg, isSubmitting = False }
            , Cmd.none
            , NoOutMsg
            )

        BackToPlans ->
            ( model
            , Cmd.none
            , BackToPlanSelection
            )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Enterprise Plan Inquiry" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Please provide your information and we'll contact you about our Enterprise plan options." ]
            ]
        , if model.isSubmitted then
            viewSuccess

          else
            viewForm model
        ]


viewSuccess : Html Msg
viewSuccess =
    div [ class "bg-green-50 border border-green-200 rounded-lg p-8 text-center" ]
        [ div [ class "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4" ]
            [ -- Checkmark icon
              svg
                [ Svg.Attributes.class "h-6 w-6 text-green-600"
                , Svg.Attributes.viewBox "0 0 20 20"
                , Svg.Attributes.fill "currentColor"
                ]
                [ path
                    [ fillRule "evenodd"
                    , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    , clipRule "evenodd"
                    ]
                    []
                ]
            ]
        , h3 [ class "text-lg font-medium text-gray-900 mb-2" ]
            [ text "Thank you for your interest!" ]
        , p [ class "text-gray-600" ]
            [ text "We've received your inquiry and will contact you soon to discuss our Enterprise plan options." ]
        , div [ class "mt-6" ]
            [ button
                [ class "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                , onClick BackToPlans
                ]
                [ text "Back to Plans" ]
            ]
        ]


viewForm : Model -> Html Msg
viewForm model =
    let
        isValid =
            isFormValid model
    in
    Html.form [ onSubmit SubmitForm, class "bg-white rounded-lg shadow-sm p-6 space-y-6" ]
        [ -- Form error message
          case model.error of
            Just errorMsg ->
                div [ class "bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4" ]
                    [ text errorMsg ]

            Nothing ->
                text ""
        , -- Company Name
          div []
            [ label [ for "company-name", class "block text-sm font-medium text-gray-700 mb-1" ]
                [ text "Company Name *" ]
            , input
                [ type_ "text"
                , id "company-name"
                , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                , value model.companyName
                , onInput UpdateCompanyName
                , placeholder "Enter your company name"
                , required True
                ]
                []
            ]
        , -- Contact Name
          div []
            [ label [ for "contact-name", class "block text-sm font-medium text-gray-700 mb-1" ]
                [ text "Contact Name *" ]
            , input
                [ type_ "text"
                , id "contact-name"
                , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                , value model.contactName
                , onInput UpdateContactName
                , placeholder "Enter your full name"
                , required True
                ]
                []
            ]
        , -- Email
          div []
            [ label [ for "email", class "block text-sm font-medium text-gray-700 mb-1" ]
                [ text "Email *" ]
            , input
                [ type_ "email"
                , id "email"
                , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                , value model.email
                , onInput UpdateEmail
                , placeholder "Enter your email address"
                , required True
                ]
                []
            , if not (String.isEmpty model.email) && not (isValidEmail model.email) then
                div [ class "text-red-500 text-sm mt-1" ]
                    [ text "Please enter a valid email address" ]

              else
                text ""
            ]
        , -- Phone
          div []
            [ label [ for "phone", class "block text-sm font-medium text-gray-700 mb-1" ]
                [ text "Phone *" ]
            , input
                [ type_ "tel"
                , id "phone"
                , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                , value model.displayPhone
                , onInput UpdatePhone
                , placeholder "Enter your phone number"
                , required True
                ]
                []
            , if not (String.isEmpty model.phone) && not (isValidPhone model.phone) then
                div [ class "text-red-500 text-sm mt-1" ]
                    [ text "Please enter a valid 10-digit phone number" ]

              else
                text ""
            ]
        , -- Message
          div []
            [ label [ for "message", class "block text-sm font-medium text-gray-700 mb-1" ]
                [ text "Message" ]
            , textarea
                [ id "message"
                , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                , value model.message
                , onInput UpdateMessage
                , placeholder "Tell us about your needs and requirements"
                , rows 4
                ]
                []
            ]
        , -- Submit button
          div [ class "flex items-center justify-between pt-4" ]
            [ button
                [ type_ "button"
                , class "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50"
                , onClick BackToPlans
                ]
                [ text "Back to Plans" ]
            , button
                [ type_ "submit"
                , class
                    ("px-4 py-2 text-sm font-medium text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 "
                        ++ (if isValid then
                                "bg-blue-600 border border-transparent hover:bg-blue-700 focus:ring-blue-500"

                            else
                                "bg-gray-400 border border-transparent cursor-not-allowed"
                           )
                    )
                , disabled (not isValid || model.isSubmitting)
                ]
                [ if model.isSubmitting then
                    text "Submitting..."

                  else
                    text "Submit Inquiry"
                ]
            ]
        ]



-- HELPERS


isFormValid : Model -> Bool
isFormValid model =
    not (String.isEmpty (String.trim model.companyName))
        && not (String.isEmpty (String.trim model.contactName))
        && not (String.isEmpty (String.trim model.email))
        && isValidEmail model.email
        && not (String.isEmpty model.phone)
        && isValidPhone model.phone


isValidEmail : String -> Bool
isValidEmail email =
    let
        trimmedEmail =
            String.trim email
    in
    not (String.isEmpty trimmedEmail)
        && String.contains "@" trimmedEmail
        && String.contains "." trimmedEmail
        && not (String.startsWith "@" trimmedEmail)
        && not (String.endsWith "@" trimmedEmail)
        && not (String.endsWith "." trimmedEmail)
        && (String.indexes "@" trimmedEmail |> List.length)
        == 1


isValidPhone : String -> Bool
isValidPhone phone =
    let
        -- Remove all non-digit characters
        digits =
            String.filter Char.isDigit phone
    in
    String.length digits == 10


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        digits =
            String.filter Char.isDigit phone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "("
            ++ String.left 3 digits
            ++ ") "
            ++ String.slice 3 6 digits
            ++ "-"
            ++ String.dropLeft 6 digits



-- API


submitEnterpriseForm : Model -> Cmd Msg
submitEnterpriseForm model =
    let
        body =
            Encode.object
                [ ( "companyName", Encode.string model.companyName )
                , ( "contactName", Encode.string model.contactName )
                , ( "email", Encode.string model.email )
                , ( "phone", Encode.string model.phone )
                , ( "message", Encode.string model.message )
                ]
    in
    Http.post
        { url = "/api/enterprise-inquiry"
        , body = Http.jsonBody body
        , expect = Http.expectJson handleSubmitResponse (Decode.field "success" Decode.bool)
        }


handleSubmitResponse : Result Http.Error Bool -> Msg
handleSubmitResponse result =
    case result of
        Ok True ->
            SubmitSuccess

        Ok False ->
            SubmitError "The server couldn't process your request. Please try again."

        Err httpError ->
            case httpError of
                Http.BadUrl _ ->
                    SubmitError "Invalid URL. Please contact support."

                Http.Timeout ->
                    SubmitError "Request timed out. Please check your connection and try again."

                Http.NetworkError ->
                    SubmitError "Network error. Please check your connection and try again."

                Http.BadStatus statusCode ->
                    SubmitError ("Server error: " ++ String.fromInt statusCode)

                Http.BadBody _ ->
                    SubmitError "Invalid response from server. Please try again."



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Onboarding/Steps/LicensingSettings.elm
================
module Onboarding.Steps.LicensingSettings exposing
    ( Model
    , Msg
    , OutMsg(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode



-- MODEL


type alias Model =
    { carrierContracts : List String
    , useSmartSendForGI : Bool
    , isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , expandedSections : List String
    }


init : Nav.Key -> String -> ( Model, Cmd Msg )
init key orgSlug =
    ( { carrierContracts = []
      , useSmartSendForGI = True
      , isLoading = True
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , expandedSections = [ "Carrier Contracts", "Guaranteed Issue Settings" ]
      }
    , fetchLicensingSettings orgSlug
    )



-- UPDATE


type Msg
    = AddCarrierContract String
    | RemoveCarrierContract String
    | ToggleSection String
    | ToggleAllCarriers Bool
    | ToggleSmartSendForGI Bool
    | NextStepClicked
    | GotLicensingSettings (Result Http.Error LicensingSettingsResponse)
    | LicensingSettingsSaved (Result Http.Error LicensingSettingsUpdateResponse)
    | NoOp


type OutMsg
    = NoOutMsg
    | NextStep
    | ShowError String


type alias LicensingSettingsResponse =
    { carrierContracts : List String
    , useSmartSendForGI : Bool
    }


type alias LicensingSettingsUpdateResponse =
    { success : Bool
    , message : String
    , isBasicPlan : Bool
    }


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        AddCarrierContract carrier ->
            let
                newModel =
                    if List.member carrier model.carrierContracts then
                        model

                    else
                        { model | carrierContracts = carrier :: model.carrierContracts }
            in
            ( newModel, Cmd.none, NoOutMsg )

        RemoveCarrierContract carrier ->
            let
                newModel =
                    { model | carrierContracts = List.filter (\x -> x /= carrier) model.carrierContracts }
            in
            ( newModel, Cmd.none, NoOutMsg )

        ToggleSection title ->
            let
                newExpandedSections =
                    if List.member title model.expandedSections then
                        List.filter ((/=) title) model.expandedSections

                    else
                        title :: model.expandedSections
            in
            ( { model | expandedSections = newExpandedSections }, Cmd.none, NoOutMsg )

        ToggleAllCarriers checked ->
            let
                newModel =
                    { model
                        | carrierContracts =
                            if checked then
                                allCarriers

                            else
                                []
                    }
            in
            ( newModel, Cmd.none, NoOutMsg )

        ToggleSmartSendForGI useSmartSend ->
            ( { model | useSmartSendForGI = useSmartSend }, Cmd.none, NoOutMsg )

        NextStepClicked ->
            if List.isEmpty model.carrierContracts then
                ( { model | error = Just "Please select at least one carrier contract" }
                , Cmd.none
                , ShowError "Please select at least one carrier contract"
                )

            else
                ( { model | isLoading = True }
                , saveLicensingSettings model
                , NoOutMsg
                )

        GotLicensingSettings result ->
            case result of
                Ok response ->
                    ( { model
                        | carrierContracts = response.carrierContracts
                        , useSmartSendForGI = response.useSmartSendForGI
                        , isLoading = False
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err error ->
                    ( { model
                        | error = Just "Failed to load licensing settings"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to load licensing settings"
                    )

        LicensingSettingsSaved result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | isLoading = False }
                        , Cmd.none
                        , NextStep
                        )

                    else
                        ( { model
                            | error = Just response.message
                            , isLoading = False
                          }
                        , Cmd.none
                        , ShowError response.message
                        )

                Err error ->
                    ( { model
                        | error = Just "Failed to save licensing settings"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to save licensing settings"
                    )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Licensing & Carriers" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Configure your carrier contracts" ]
            ]
        , if model.isLoading && List.isEmpty model.carrierContracts then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ viewExpandableSection "Carrier Contracts"
                    (viewCarriersGrid model)
                    model.expandedSections
                , viewGISettings model
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class "px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick NextStepClicked
                        , disabled (List.isEmpty model.carrierContracts || model.isLoading)
                        , title
                            (if List.isEmpty model.carrierContracts then
                                "Please select at least one carrier contract"

                             else
                                ""
                            )
                        ]
                        [ if model.isLoading then
                            div [ class "flex items-center justify-center" ]
                                [ div [ class "animate-spin mr-2 h-4 w-4 border-t-2 border-b-2 border-white rounded-full" ] []
                                , text "Saving..."
                                ]

                          else
                            text "Continue"
                        ]
                    ]
                ]
        ]


viewLoading : Html msg
viewLoading =
    div [ class "text-center py-12" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading..." ]
        ]


viewExpandableSection : String -> Html Msg -> List String -> Html Msg
viewExpandableSection title content expandedSections =
    let
        isExpanded =
            List.member title expandedSections
    in
    div [ class "bg-white shadow rounded-lg overflow-hidden" ]
        [ button
            [ class "w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50"
            , onClick (ToggleSection title)
            ]
            [ h2 [ class "text-lg font-medium" ] [ text title ]
            , div
                [ class "transform transition-transform"
                , classList [ ( "rotate-180", isExpanded ) ]
                ]
                [ text "▼" ]
            ]
        , div
            [ class "px-6 pb-6"
            , classList [ ( "hidden", not isExpanded ) ]
            ]
            [ content ]
        ]


viewCarriersGrid : Model -> Html Msg
viewCarriersGrid model =
    div []
        [ div [ class "mb-4 flex items-center" ]
            [ checkbox "Select All Carriers"
                (List.length model.carrierContracts == List.length allCarriers)
                ToggleAllCarriers
            ]
        , div [ class "grid grid-cols-2 sm:grid-cols-3 gap-4" ]
            (List.map
                (\carrier ->
                    checkbox carrier
                        (List.member carrier model.carrierContracts)
                        (\checked ->
                            if checked then
                                AddCarrierContract carrier

                            else
                                RemoveCarrierContract carrier
                        )
                )
                allCarriers
            )
        ]


viewGISettings : Model -> Html Msg
viewGISettings model =
    div [ class "bg-white shadow rounded-lg overflow-hidden" ]
        [ div [ class "px-6 py-4 border-b border-gray-200" ]
            [ h2 [ class "text-lg font-medium" ] [ text "Guaranteed Issue Settings" ]
            ]
        , div [ class "p-6 space-y-6" ]
            [ div [ class "mb-4 p-4 bg-blue-50 border border-blue-100 rounded-md" ]
                [ div [ class "flex items-start" ]
                    [ div [ class "flex items-center h-5" ]
                        [ input
                            [ type_ "checkbox"
                            , checked model.useSmartSendForGI
                            , onCheck ToggleSmartSendForGI
                            , class "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                            ]
                            []
                        ]
                    , div [ class "ml-3 text-sm" ]
                        [ label [ class "font-medium text-gray-700" ]
                            [ text "Use SmartSend for Guaranteed Issue" ]
                        , p [ class "text-gray-500 mt-1" ]
                            [ text "When enabled, SmartSend will automatically identify which carrier combinations offer full compensation for Guaranteed Issue (GI) policies." ]
                        ]
                    ]
                ]
            , div [ class "mt-4 p-4 bg-gray-50 rounded-md" ]
                [ h3 [ class "text-lg font-medium text-gray-900 mb-2" ]
                    [ text "How SmartSend Works" ]
                , p [ class "text-gray-600" ]
                    [ text "SmartSend analyzes each carrier to determine which ones offer full carrier compensation for Guaranteed Issue policies. This helps maximize your commissions while ensuring your quotes are always compliant with the latest carrier regulations." ]
                ]
            ]
        ]


checkbox : String -> Bool -> (Bool -> msg) -> Html msg
checkbox labelText isChecked onToggle =
    Html.label [ class "flex items-center space-x-3" ]
        [ input
            [ type_ "checkbox"
            , checked isChecked
            , onCheck onToggle
            , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            ]
            []
        , span [ class "text-gray-700" ] [ text labelText ]
        ]


th : List (Attribute msg) -> List (Html msg) -> Html msg
th attributes children =
    Html.th attributes children


td : List (Attribute msg) -> List (Html msg) -> Html msg
td attributes children =
    Html.td attributes children



-- HELPERS
-- API CALLS


fetchLicensingSettings : String -> Cmd Msg
fetchLicensingSettings _ =
    Http.get
        { url = "/api/onboarding/settings"
        , expect = Http.expectJson GotLicensingSettings licensingSettingsDecoder
        }


saveLicensingSettings : Model -> Cmd Msg
saveLicensingSettings model =
    Http.post
        { url = "/api/onboarding/licensing-settings"
        , body = Http.jsonBody (encodeLicensingSettings model)
        , expect = Http.expectJson LicensingSettingsSaved licensingSettingsUpdateResponseDecoder
        }



-- DECODERS & ENCODERS


licensingSettingsDecoder : Decode.Decoder LicensingSettingsResponse
licensingSettingsDecoder =
    Decode.field "licensingSettingsModel"
        (Decode.succeed LicensingSettingsResponse
            |> Pipeline.required "carrierContracts" (Decode.list Decode.string)
            |> Pipeline.required "useSmartSendForGI" Decode.bool
        )


licensingSettingsUpdateResponseDecoder : Decode.Decoder LicensingSettingsUpdateResponse
licensingSettingsUpdateResponseDecoder =
    Decode.succeed LicensingSettingsUpdateResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.required "message" Decode.string
        |> Pipeline.required "isBasicPlan" Decode.bool


encodeLicensingSettings : Model -> Encode.Value
encodeLicensingSettings model =
    Encode.object
        [ ( "carrierContracts", Encode.list Encode.string model.carrierContracts )
        , ( "useSmartSendForGI", Encode.bool model.useSmartSendForGI )
        ]



-- CONSTANTS


allCarriers : List String
allCarriers =
    [ "Aetna"
    , "Humana"
    , "UnitedHealthcare"
    , "Cigna"
    , "Aflac"
    , "Allstate"
    , "Mutual of Omaha"
    , "Ace Chubb"
    ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Onboarding/Steps/Payment.elm
================
module Onboarding.Steps.Payment exposing
    ( Model
    , Msg
    , OutMsg(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Url
import Url.Builder as UrlBuilder



-- MODEL


type alias Model =
    { isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , subscriptionDetails : Maybe SubscriptionDetails
    , processingPayment : Bool
    , email : String
    }


type alias SubscriptionDetails =
    { planName : String
    , planPrice : String
    , extraAgents : Int
    , extraAgentsCost : Int
    , extraContacts : Int
    , extraContactsCost : Int
    , totalPrice : String
    , isTrial : Bool
    , trialEndsAt : Maybe String
    }


init : Nav.Key -> String -> ( Model, Cmd Msg )
init key orgSlug =
    ( { isLoading = False
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , subscriptionDetails =
            Just
                { planName = "Your Selected Plan"
                , planPrice = "$29/mo"
                , extraAgents = 0
                , extraAgentsCost = 0
                , extraContacts = 0
                , extraContactsCost = 0
                , totalPrice = "$29/mo"
                , isTrial = True
                , trialEndsAt = Just "30 days after signup"
                }
      , processingPayment = False
      , email = ""
      }
    , fetchUserEmail
    )



-- UPDATE


type Msg
    = CompleteOnboarding
    | ProcessPayment
    | GotSubscriptionDetails (Result Http.Error SubscriptionDetails)
    | PaymentProcessed (Result Http.Error String)
    | OnboardingCompleted (Result Http.Error ())
    | GotUserEmail (Result Http.Error String)
    | NoOp


type OutMsg
    = NoOutMsg
    | Completed
    | ShowError String
    | NavigateToWalkthrough


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        CompleteOnboarding ->
            ( { model | processingPayment = True }
            , completeOnboarding model.orgSlug
            , NoOutMsg
            )

        ProcessPayment ->
            ( { model | processingPayment = True }
            , createStripeCheckoutSession model.orgSlug
            , NoOutMsg
            )

        GotSubscriptionDetails result ->
            case result of
                Ok details ->
                    ( { model
                        | subscriptionDetails = Just details
                        , isLoading = False
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to load subscription details"
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError "Failed to load subscription details"
                    )

        PaymentProcessed result ->
            case result of
                Ok sessionId ->
                    -- Redirect to Stripe checkout
                    ( { model | processingPayment = False }
                    , redirectToStripeCheckout sessionId
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to process payment"
                        , processingPayment = False
                      }
                    , Cmd.none
                    , ShowError "Failed to process payment"
                    )

        GotUserEmail result ->
            case result of
                Ok email ->
                    ( { model | email = email }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    -- If we can't get the email, just continue without it
                    ( model, Cmd.none, NoOutMsg )

        OnboardingCompleted result ->
            case result of
                Ok _ ->
                    -- Directly navigate to walkthrough, bypassing login
                    ( { model | isLoading = False, processingPayment = False }
                    , Nav.load "/walkthrough"
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to complete onboarding"
                        , isLoading = False
                        , processingPayment = False
                      }
                    , Cmd.none
                    , ShowError "Failed to complete onboarding"
                    )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Complete Your Account Setup" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "You're almost done! Click 'Continue to Walkthrough' to finish the onboarding process." ]
            ]
        , div [ class "bg-white shadow rounded-lg p-6" ]
            [ div [ class "text-center space-y-6" ]
                [ div [ class "mb-4 text-green-500 text-6xl" ]
                    [ text "✓" ]
                , h2 [ class "text-xl font-medium text-gray-900" ]
                    [ text "All Set!" ]
                , p [ class "text-gray-600" ]
                    [ text "Your account is ready to be created with the details you've provided." ]
                , div [ class "mt-6" ]
                    [ button
                        [ class "px-8 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick CompleteOnboarding
                        , disabled model.processingPayment
                        ]
                        [ if model.processingPayment then
                            div [ class "flex items-center justify-center" ]
                                [ div [ class "mr-2 animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white" ] []
                                , text "Finalizing your account... You'll be redirected to login shortly."
                                ]

                          else
                            text "Continue to Walkthrough"
                        ]
                    ]
                ]
            ]
        , if model.error /= Nothing then
            div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                [ text (Maybe.withDefault "" model.error) ]

          else
            text ""
        ]


viewLoading : Html msg
viewLoading =
    div [ class "text-center py-12" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading..." ]
        ]


viewSubscriptionSummary : Model -> Html Msg
viewSubscriptionSummary model =
    case model.subscriptionDetails of
        Just details ->
            div [ class "bg-white shadow rounded-lg overflow-hidden" ]
                [ div [ class "px-6 py-4 border-b border-gray-200" ]
                    [ h2 [ class "text-lg font-medium text-gray-900" ]
                        [ text "Subscription Summary" ]
                    ]
                , div [ class "px-6 py-4" ]
                    [ div [ class "space-y-4" ]
                        [ div [ class "flex justify-between" ]
                            [ span [ class "text-gray-600" ] [ text "Plan" ]
                            , span [ class "font-medium" ] [ text details.planName ]
                            ]
                        , div [ class "flex justify-between" ]
                            [ span [ class "text-gray-600" ] [ text "Base Price" ]
                            , span [ class "font-medium" ] [ text details.planPrice ]
                            ]
                        , if details.extraAgents > 0 then
                            div [ class "flex justify-between" ]
                                [ span [ class "text-gray-600" ]
                                    [ text ("Extra Agents (" ++ String.fromInt details.extraAgents ++ ")") ]
                                , span [ class "font-medium" ]
                                    [ text ("$" ++ String.fromInt details.extraAgentsCost) ]
                                ]

                          else
                            text ""
                        , if details.extraContacts > 0 then
                            div [ class "flex justify-between" ]
                                [ span [ class "text-gray-600" ]
                                    [ text ("Extra Contacts (" ++ String.fromInt details.extraContacts ++ ")") ]
                                , span [ class "font-medium" ]
                                    [ text ("$" ++ String.fromInt details.extraContactsCost) ]
                                ]

                          else
                            text ""
                        , div [ class "pt-4 border-t border-gray-200 flex justify-between" ]
                            [ span [ class "font-medium text-gray-900" ] [ text "Total" ]
                            , span [ class "font-bold text-gray-900" ] [ text details.totalPrice ]
                            ]
                        ]
                    ]
                , if details.isTrial then
                    div [ class "px-6 py-4 bg-blue-50 border-t border-blue-100" ]
                        [ div [ class "flex items-start" ]
                            [ div [ class "flex-shrink-0 pt-0.5" ]
                                [ span [ class "text-blue-500 text-lg" ] [ text "ℹ" ]
                                ]
                            , div [ class "ml-3" ]
                                [ h3 [ class "text-sm font-medium text-blue-800" ]
                                    [ text "Free Trial" ]
                                , div [ class "mt-2 text-sm text-blue-700" ]
                                    [ p []
                                        [ text
                                            (case details.trialEndsAt of
                                                Just date ->
                                                    "Your free trial will end on " ++ date ++ ". No payment is required today."

                                                Nothing ->
                                                    "You're starting with a free trial. No payment is required today."
                                            )
                                        ]
                                    ]
                                ]
                            ]
                        ]

                  else
                    text ""
                ]

        Nothing ->
            div [ class "bg-gray-100 p-6 rounded-lg text-center" ]
                [ text "No subscription details available" ]



-- API CALLS


fetchSubscriptionDetails : String -> Cmd Msg
fetchSubscriptionDetails orgSlug =
    Http.get
        { url = "/api/organizations/" ++ orgSlug ++ "/subscription-details"
        , expect = Http.expectJson GotSubscriptionDetails subscriptionDetailsDecoder
        }


createStripeCheckoutSession : String -> Cmd Msg
createStripeCheckoutSession orgSlug =
    Http.post
        { url = "/api/organizations/" ++ orgSlug ++ "/create-checkout-session"
        , body = Http.jsonBody (encodeCheckoutRequest orgSlug)
        , expect = Http.expectJson PaymentProcessed Decode.string
        }


redirectToStripeCheckout : String -> Cmd Msg
redirectToStripeCheckout sessionId =
    Nav.load ("/api/stripe/redirect-to-checkout?session_id=" ++ sessionId)


completeOnboarding : String -> Cmd Msg
completeOnboarding orgSlug =
    Http.post
        { url = "/api/onboarding/complete"
        , body = Http.emptyBody
        , expect = Http.expectWhatever OnboardingCompleted
        }



-- DECODERS & ENCODERS


subscriptionDetailsDecoder : Decode.Decoder SubscriptionDetails
subscriptionDetailsDecoder =
    Decode.succeed SubscriptionDetails
        |> Pipeline.required "planName" Decode.string
        |> Pipeline.required "planPrice" Decode.string
        |> Pipeline.required "extraAgents" Decode.int
        |> Pipeline.required "extraAgentsCost" Decode.int
        |> Pipeline.required "extraContacts" Decode.int
        |> Pipeline.required "extraContactsCost" Decode.int
        |> Pipeline.required "totalPrice" Decode.string
        |> Pipeline.required "isTrial" Decode.bool
        |> Pipeline.required "trialEndsAt" (Decode.nullable Decode.string)


encodeCheckoutRequest : String -> Encode.Value
encodeCheckoutRequest orgSlug =
    Encode.object
        [ ( "orgSlug", Encode.string orgSlug )
        ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none



-- New function to fetch user email


fetchUserEmail : Cmd Msg
fetchUserEmail =
    Http.get
        { url = "/api/onboarding/user-details"
        , expect = Http.expectJson GotUserEmail userEmailDecoder
        }



-- New decoder for user email


userEmailDecoder : Decode.Decoder String
userEmailDecoder =
    Decode.field "email" Decode.string

================
File: src/Onboarding/Steps/PlanSelection.elm
================
module Onboarding.Steps.PlanSelection exposing
    ( Model
    , Msg(..)
    , OutMsg(..)
    , fetchSubscriptionTiers
    , init
    , initWithFetch
    , initWithSavedState
    , subscriptions
    , update
    , view
    )

import Basics
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder, field)
import Json.Encode as Encode
import Process
import Task



-- MODEL


type alias SubscriptionTier =
    { id : String
    , name : String
    , price : String
    , agentLimit : Int
    , contactLimit : Int
    , features : List String
    }


type alias Model =
    { selectedPlan : Maybe String
    , extraAgents : Int
    , extraContacts : Int
    , tiers : List SubscriptionTier
    , isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , session : String
    , loadedFromSession : Bool
    }


init : Nav.Key -> String -> String -> ( Model, Cmd Msg )
init key orgSlug session =
    initWithFetch key orgSlug session True



-- Add a version that allows controlling whether to fetch tiers


initWithFetch : Nav.Key -> String -> String -> Bool -> ( Model, Cmd Msg )
initWithFetch key orgSlug session shouldFetchTiers =
    ( { selectedPlan = Nothing
      , extraAgents = 0
      , extraContacts = 0
      , tiers = []
      , isLoading = shouldFetchTiers
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , session = session
      , loadedFromSession = False
      }
    , if shouldFetchTiers then
        Cmd.batch
            [ fetchSubscriptionTiers
            , -- Also check if we have a plan type in localStorage
              checkSessionForPlan key orgSlug session
            , -- Add a timeout to clear loading state after 2 seconds (reduced from 5)
              Process.sleep 2000
                |> Task.perform (\_ -> LoadingTimeout)
            ]

      else
        Cmd.none
    )



-- Initialize with saved state from session


initWithSavedState : Nav.Key -> String -> String -> String -> ( Model, Cmd Msg )
initWithSavedState key orgSlug session savedPlan =
    let
        initialModel =
            { selectedPlan = Just savedPlan
            , extraAgents = 0 -- We could load these from session too if needed
            , extraContacts = 0
            , tiers = []
            , isLoading = True
            , error = Nothing
            , key = key
            , orgSlug = orgSlug
            , session = session
            , loadedFromSession = True
            }
    in
    ( initialModel
    , fetchSubscriptionTiers
    )



-- UPDATE


type Msg
    = SelectPlan String
    | SetExtraAgents String
    | SetExtraContacts String
    | GotTiers (Result Http.Error (List SubscriptionTier))
    | NextStepClicked
    | LoadingTimeout
    | OnboardingInitialized (Result Http.Error { organizationId : Int, slug : String, sessionToken : String, onboardingStep : Int, planType : String })
    | LoadPlanFromSession String
    | NoOp


type OutMsg
    = NoOutMsg
    | SelectedPlan String
    | NextStep
    | OnboardingInitializedSuccess { organizationId : Int, slug : String, sessionToken : String, onboardingStep : Int, planType : String }
    | ShowError String


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        SelectPlan planId ->
            ( { model | selectedPlan = Just planId }
            , Cmd.none
            , SelectedPlan planId
            )

        SetExtraAgents value ->
            let
                extraAgents =
                    String.toInt value |> Maybe.withDefault 0
            in
            ( { model | extraAgents = extraAgents }
            , Cmd.none
            , NoOutMsg
            )

        SetExtraContacts value ->
            let
                extraContacts =
                    String.toInt value |> Maybe.withDefault 0
            in
            ( { model | extraContacts = extraContacts }
            , Cmd.none
            , NoOutMsg
            )

        GotTiers result ->
            case result of
                Ok tiers ->
                    ( { model | tiers = tiers, isLoading = False }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    ( { model | isLoading = False }
                    , Cmd.none
                    , NoOutMsg
                    )

        OnboardingInitialized result ->
            case result of
                Ok response ->
                    ( { model | isLoading = False }
                    , Cmd.none
                    , OnboardingInitializedSuccess response
                    )

                Err error ->
                    let
                        errorMsg =
                            case error of
                                Http.BadUrl url ->
                                    "Bad URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus code ->
                                    "Bad status: " ++ String.fromInt code

                                Http.BadBody message ->
                                    "Onboarding initialized successfully, but there was an issue with the response format. Continuing..."
                    in
                    -- Check for the specific error case without using Debug
                    case error of
                        Http.BadBody message ->
                            if String.contains "planType" message then
                                -- This is the specific error we're looking for - missing planType field
                                ( { model | isLoading = False }
                                , Cmd.none
                                , NextStep
                                )

                            else
                                ( { model | error = Just errorMsg, isLoading = False }
                                , Cmd.none
                                , ShowError errorMsg
                                )

                        -- For all other error types, show the error message
                        _ ->
                            ( { model | error = Just errorMsg, isLoading = False }
                            , Cmd.none
                            , ShowError errorMsg
                            )

        LoadPlanFromSession planType ->
            -- Handle loading a plan selection from the session
            ( { model | selectedPlan = Just planType, loadedFromSession = True }
            , Cmd.none
            , NoOutMsg
            )

        NextStepClicked ->
            case model.selectedPlan of
                Just planId ->
                    if planId == "enterprise" then
                        -- For Enterprise, redirect to the Enterprise form
                        ( model
                        , Cmd.none
                        , SelectedPlan "enterprise"
                        )

                    else
                        -- Initialize onboarding with selected plan
                        ( { model | isLoading = True }
                        , initializeOnboarding planId
                        , NextStep
                        )

                Nothing ->
                    ( { model | error = Just "Please select a plan" }
                    , Cmd.none
                    , ShowError "Please select a plan"
                    )

        LoadingTimeout ->
            -- If we're still loading after the timeout, clear the loading state
            if model.isLoading then
                ( { model | isLoading = False }
                , Cmd.none
                , NoOutMsg
                )

            else
                ( model, Cmd.none, NoOutMsg )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8 max-w-5xl mx-auto px-4 -ml-24" ]
        [ div [ class "mb-8 text-center" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Choose your plan" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Select a plan that best fits your organization's needs" ]
            , if model.loadedFromSession && model.selectedPlan /= Nothing then
                p [ class "text-blue-600 mt-2 italic" ]
                    [ text "Your previously selected plan has been loaded." ]

              else
                text ""
            ]
        , if model.isLoading && List.isEmpty model.tiers then
            viewLoading

          else
            div [ class "flex flex-col items-center" ]
                [ div [ class "grid grid-cols-1 md:grid-cols-3 gap-6 w-full" ]
                    (if List.isEmpty model.tiers then
                        -- Fallback to hardcoded plans if no tiers available
                        [ viewPlanOption
                            "basic"
                            "Solo"
                            "$29/mo"
                            [ "1 Agent Seat"
                            , "Up to 1,000 Clients"
                            , "Analytics Dashboard"
                            , "Quote Tool"
                            , "Customizable Booking Options"
                            , "Access to our Smart Send Technology"
                            ]
                            1
                            1000
                            model.selectedPlan
                        , viewPlanOption
                            "pro"
                            "Agency / Solo+"
                            "$99/mo"
                            [ "Everything in the Solo package plus:"
                            , "5+ Agent Seats"
                            , "5,000+ Clients"
                            , "Admin and Organization Settings"
                            , "Organization Wide Analytics"
                            ]
                            5
                            5000
                            model.selectedPlan
                        , viewPlanOption
                            "enterprise"
                            "Enterprise"
                            "Contact Us"
                            [ "Everything in Solo & Agency Packages"
                            , "10+ Agent Seats"
                            , "Unlimited Clients"
                            , "24/7 Platform Support"
                            , "White-Labeled Quote Tool and Dashboard"
                            ]
                            -1
                            -1
                            model.selectedPlan
                        ]

                     else
                        List.map
                            (\tier ->
                                viewPlanOption
                                    tier.id
                                    tier.name
                                    tier.price
                                    tier.features
                                    tier.agentLimit
                                    tier.contactLimit
                                    model.selectedPlan
                            )
                            model.tiers
                    )
                , if canAddExtraResources model.selectedPlan then
                    div [ class "w-full mt-8" ]
                        [ viewExtraResources model ]

                  else
                    text ""
                , if model.error /= Nothing then
                    div [ class "mt-4 text-red-500" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "mt-8 flex justify-center" ]
                    [ button
                        [ class
                            ("px-6 py-3 rounded-lg transition-colors duration-200 "
                                ++ (if model.selectedPlan == Nothing then
                                        "bg-[#2563EB]/50 cursor-not-allowed text-white"

                                    else
                                        "bg-[#2563EB] hover:bg-[#1D4ED8] text-white"
                                   )
                            )
                        , onClick NextStepClicked
                        , disabled (model.selectedPlan == Nothing)
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewLoading : Html msg
viewLoading =
    div [ class "flex flex-col items-center justify-center py-12" ]
        [ div [ class "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading subscription tiers..." ]
        ]


viewPlanOption : String -> String -> String -> List String -> Int -> Int -> Maybe String -> Html Msg
viewPlanOption id name price features agentLimit contactLimit selectedPlan =
    div
        [ class
            ("p-6 rounded-lg cursor-pointer transition-all h-full flex flex-col min-h-[500px] "
                ++ (if Just id == selectedPlan then
                        "bg-[#2563EB]/10 ring-2 ring-[#2563EB]"

                    else
                        "bg-gray-50 hover:bg-gray-100 border border-gray-200"
                   )
            )
        , onClick (SelectPlan id)
        ]
        [ div [ class "flex-1 flex flex-col" ]
            [ div [ class "mb-4" ]
                [ h3 [ class "text-xl font-semibold text-gray-900" ] [ text name ]
                , p [ class "text-3xl font-bold text-gray-900 mt-2" ]
                    [ text
                        (if id == "enterprise" then
                            "Contact Us"

                         else
                            price
                        )
                    ]
                ]
            , div [ class "space-y-2 py-4 border-t border-b border-gray-200 mb-4" ]
                [ if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "5+ agent seats"

                             else if agentLimit == -1 then
                                "Unlimited agent seats"

                             else if agentLimit == 1 then
                                "1 agent seat"

                             else
                                "Up to " ++ String.fromInt agentLimit ++ " agent seats"
                            )
                        ]

                  else
                    div [ class "text-gray-600" ]
                        [ text "Custom agent seats" ]
                , if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "5,000+ clients"

                             else if contactLimit == -1 then
                                "Unlimited clients"

                             else if contactLimit == 1000 then
                                "1,000 clients"

                             else
                                "Up to " ++ String.fromInt contactLimit ++ " clients"
                            )
                        ]

                  else
                    div [ class "text-gray-600" ]
                        [ text "Unlimited clients" ]
                ]
            , div [ class "mt-auto" ]
                [ p [ class "text-sm font-medium text-gray-900 mb-2" ] [ text "Features:" ]
                , ul [ class "space-y-2" ]
                    (List.map
                        (\feature ->
                            li [ class "flex items-start text-sm text-gray-600" ]
                                [ span [ class "text-[#059669] mr-2 flex-shrink-0 mt-0.5" ] [ text "✓" ]
                                , span [ class "leading-relaxed" ] [ text feature ]
                                ]
                        )
                        features
                    )
                ]
            ]
        ]


viewExtraResources : Model -> Html Msg
viewExtraResources model =
    div [ class "p-6 bg-gray-50 rounded-lg border border-gray-200 w-full" ]
        [ h3 [ class "text-lg font-semibold text-gray-900 mb-4 text-center" ]
            [ text "Additional Resources" ]
        , div [ class "grid grid-cols-1 md:grid-cols-2 gap-6" ]
            [ div [ class "space-y-2" ]
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Extra Agents" ]
                , p [ class "text-xs text-gray-500" ]
                    [ text "Add more agent seats beyond your plan's included limit ($20/agent seat/month)" ]
                , div [ class "flex items-center" ]
                    [ button
                        [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                        , onClick (SetExtraAgents (String.fromInt (Basics.max 0 (model.extraAgents - 1))))
                        ]
                        [ text "-" ]
                    , input
                        [ type_ "number"
                        , class "w-16 text-center border-y border-gray-200 py-1"
                        , value (String.fromInt model.extraAgents)
                        , onInput SetExtraAgents
                        ]
                        []
                    , button
                        [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                        , onClick (SetExtraAgents (String.fromInt (model.extraAgents + 1)))
                        ]
                        [ text "+" ]
                    , span [ class "ml-2 text-sm font-medium" ]
                        [ text ("$" ++ String.fromInt (model.extraAgents * 20) ++ "/mo") ]
                    ]
                ]
            , div [ class "space-y-2" ]
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Extra Clients" ]
                , p [ class "text-xs text-gray-500" ]
                    [ text "Add more clients beyond your plan's included limit ($50/5,000 clients/month)" ]
                , div [ class "flex items-center" ]
                    [ button
                        [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                        , onClick (SetExtraContacts (String.fromInt (Basics.max 0 (model.extraContacts - 5000))))
                        ]
                        [ text "-" ]
                    , input
                        [ type_ "number"
                        , class "w-20 text-center border-y border-gray-200 py-1"
                        , value (String.fromInt model.extraContacts)
                        , onInput SetExtraContacts
                        , Html.Attributes.step "5000"
                        ]
                        []
                    , button
                        [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                        , onClick (SetExtraContacts (String.fromInt (model.extraContacts + 5000)))
                        ]
                        [ text "+" ]
                    , span [ class "ml-2 text-sm font-medium" ]
                        [ text ("$" ++ String.fromInt (model.extraContacts // 5000 * 50) ++ "/mo") ]
                    ]
                ]
            ]
        ]



-- HELPERS


canAddExtraResources : Maybe String -> Bool
canAddExtraResources selectedPlan =
    case selectedPlan of
        Just plan ->
            plan == "pro"

        Nothing ->
            False



-- API CALLS


fetchSubscriptionTiers : Cmd Msg
fetchSubscriptionTiers =
    Http.get
        { url = "/api/organizations/subscription-tiers"
        , expect = Http.expectJson GotTiers subscriptionTiersDecoder
        }


initializeOnboarding : String -> Cmd Msg
initializeOnboarding planType =
    let
        url =
            "/api/onboarding/initialize"

        body =
            Encode.object
                [ ( "planType", Encode.string planType )
                , ( "organizationName", Encode.string "New Medicare Agency" )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map5
                (\organizationId slug sessionToken onboardingStep planTypeValue ->
                    { organizationId = organizationId
                    , slug = slug
                    , sessionToken = sessionToken
                    , onboardingStep = onboardingStep
                    , planType = planTypeValue
                    }
                )
                (Decode.field "organizationId" Decode.int)
                (Decode.field "slug" Decode.string)
                (Decode.field "sessionToken" Decode.string)
                (Decode.field "onboardingStep" Decode.int)
                (Decode.oneOf
                    [ Decode.field "planType" Decode.string
                    , Decode.succeed planType -- Default to the planType we sent in the request
                    ]
                )
    in
    Http.post
        { url = url
        , body = body
        , expect = Http.expectJson OnboardingInitialized decoder
        }



-- DECODERS & ENCODERS


subscriptionTiersDecoder : Decoder (List SubscriptionTier)
subscriptionTiersDecoder =
    field "tiers"
        (Decode.list
            (Decode.map6 SubscriptionTier
                (field "id" Decode.string)
                (field "name" Decode.string)
                (field "price" Decode.string)
                (field "agentLimit" Decode.int)
                (field "contactLimit" Decode.int)
                (field "features" (Decode.list Decode.string))
            )
        )



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none



-- Helper function to check session for plan type and dispatch appropriate message


checkSessionForPlan : Nav.Key -> String -> String -> Cmd Msg
checkSessionForPlan key orgSlug session =
    -- This would be replaced with an actual API call in a real implementation
    -- For now, we'll just simulate finding the plan in the session by checking localStorage
    -- via the port system. The port would return the plan type if found.
    -- Since we can't directly call a port from here, we'll use a Task.succeed
    -- to simulate waiting for the response
    Task.perform (\_ -> NoOp) (Task.succeed ())

================
File: src/Onboarding/Steps/UserDetails.elm
================
module Onboarding.Steps.UserDetails exposing
    ( EmailStatus(..)
    , Model
    , Msg
    , OutMsg(..)
    , fetchUserDetails
    , init
    , loadUserFromSession
    , subscriptions
    , update
    , view
    )

import Browser.Navigation as Nav
import Char
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Svg exposing (circle, path, svg)
import Svg.Attributes as SvgAttr exposing (clipRule, cx, cy, d, fill, fillRule, r, stroke, strokeWidth, viewBox)
import Task
import Utils.RandomOrgName exposing (generateOrgName)



-- PORTS
-- These ports are defined in Onboarding.elm, we just use them here
-- MODEL


type alias Model =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isLoading : Bool
    , error : Maybe String
    , key : Nav.Key
    , orgSlug : String
    , emailStatus : EmailStatus
    , loadedFromSession : Bool
    , sessionToken : String
    }


type EmailStatus
    = NotChecked
    | Checking
    | Available
    | Unavailable String


init : Nav.Key -> String -> Bool -> ( Model, Cmd Msg )
init key orgSlug isNewSignup =
    ( { firstName = ""
      , lastName = ""
      , email = ""
      , phone = ""
      , isLoading = True -- Set to true while loading
      , error = Nothing
      , key = key
      , orgSlug = orgSlug
      , emailStatus = NotChecked
      , loadedFromSession = False
      , sessionToken = ""
      }
    , fetchUserDetails orgSlug
      -- Fetch user details from backend using session cookie
    )



-- New function to load user details from session/localStorage


loadUserFromSession : { firstName : String, lastName : String, email : String, phone : String } -> Msg
loadUserFromSession userData =
    LoadUserFromSession userData



-- UPDATE


type Msg
    = UpdateFirstName String
    | UpdateLastName String
    | UpdateEmail String
    | UpdatePhone String
    | NextStepClicked
    | GotUserDetails (Result Http.Error UserDetailsResponse)
    | UserDetailsSaved (Result Http.Error SignupResponse)
    | NoOp
    | EmailBlurred
    | EmailFocused
    | GotEmailCheckResponse (Result Http.Error EmailCheckResponse)
    | LoadUserFromSession { firstName : String, lastName : String, email : String, phone : String }
    | SaveUserDetails


type OutMsg
    = NoOutMsg
    | NextStep
    | ShowError String
    | SaveUserToCookie { firstName : String, lastName : String, email : String, phone : String }
    | UpdateOrgSlug String
    | NextStepAndUpdateSlug String


type alias UserDetailsResponse =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    , slug : String
    }


type alias EmailCheckResponse =
    { available : Bool
    , message : String
    }


type alias SignupResponse =
    { success : Bool
    , message : String
    , slug : String
    }


update : Msg -> Model -> ( Model, Cmd Msg, OutMsg )
update msg model =
    case msg of
        UpdateFirstName value ->
            ( { model | firstName = value }, Cmd.none, NoOutMsg )

        UpdateLastName value ->
            ( { model | lastName = value }, Cmd.none, NoOutMsg )

        UpdateEmail value ->
            ( { model
                | email = value
                , emailStatus = NotChecked -- Reset status
              }
            , Cmd.none
            , NoOutMsg
            )

        EmailFocused ->
            -- Immediately clear validation state when field gets focus
            ( { model | emailStatus = NotChecked }
            , Cmd.none
            , NoOutMsg
            )

        UpdatePhone value ->
            -- Store only the digits, but display formatted version
            ( { model | phone = String.filter Char.isDigit value }, Cmd.none, NoOutMsg )

        EmailBlurred ->
            if String.isEmpty (String.trim model.email) then
                -- Don't validate empty emails
                ( model, Cmd.none, NoOutMsg )

            else
                -- Always check email validity when field loses focus
                ( { model | emailStatus = Checking }
                , checkEmailAvailability model.email
                , NoOutMsg
                )

        GotEmailCheckResponse result ->
            case result of
                Ok response ->
                    if response.available then
                        ( { model | emailStatus = Available }
                        , Cmd.none
                        , NoOutMsg
                        )

                    else
                        ( { model | emailStatus = Unavailable response.message }
                        , Cmd.none
                        , NoOutMsg
                        )

                Err httpError ->
                    let
                        errorMsg =
                            case httpError of
                                Http.BadBody message ->
                                    "Decoder error: " ++ message

                                Http.BadStatus status ->
                                    "Server error: " ++ String.fromInt status

                                _ ->
                                    "Error checking email availability"
                    in
                    ( { model | emailStatus = Unavailable errorMsg }
                    , Cmd.none
                    , NoOutMsg
                    )

        NextStepClicked ->
            if isFormValid model then
                -- Save user details and move to next step
                let
                    userData =
                        { firstName = model.firstName
                        , lastName = model.lastName
                        , email = model.email
                        , phone = model.phone
                        }
                in
                ( { model | isLoading = True }
                , saveUserDetails model
                , SaveUserToCookie userData
                )

            else
                ( { model | error = Just "Please fill out all required fields" }
                , Cmd.none
                , ShowError "Please fill out all required fields"
                )

        GotUserDetails result ->
            case result of
                Ok response ->
                    let
                        -- Use the slug from the response if it's not empty
                        updatedSlug =
                            if String.isEmpty response.slug then
                                model.orgSlug

                            else
                                response.slug
                    in
                    ( { model
                        | firstName = response.firstName
                        , lastName = response.lastName
                        , email = response.email
                        , phone = response.phone
                        , isLoading = False
                        , emailStatus = Available -- Consider email as valid since it's already registered
                        , loadedFromSession = True -- Mark as loaded from session
                        , orgSlug = updatedSlug
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

                Err _ ->
                    -- On error, we don't cause a fatal error, just keep the form empty
                    ( { model
                        | isLoading = False
                      }
                    , Cmd.none
                    , NoOutMsg
                    )

        UserDetailsSaved result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | isLoading = False, orgSlug = response.slug }
                        , Cmd.none
                        , NextStepAndUpdateSlug response.slug
                        )

                    else
                        ( { model
                            | error = Just response.message
                            , isLoading = False
                          }
                        , Cmd.none
                        , ShowError response.message
                        )

                Err httpError ->
                    let
                        errorMsg =
                            case httpError of
                                Http.BadUrl url ->
                                    "Invalid URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus statusCode ->
                                    "Bad status: " ++ String.fromInt statusCode

                                Http.BadBody errorMessage ->
                                    if String.contains "phone" errorMessage then
                                        "Invalid phone number format. Please enter a valid phone number."

                                    else
                                        "Bad body: " ++ errorMessage
                    in
                    ( { model
                        | error = Just ("Failed to save user details: " ++ errorMsg)
                        , isLoading = False
                      }
                    , Cmd.none
                    , ShowError ("Failed to save user details: " ++ errorMsg)
                    )

        LoadUserFromSession userData ->
            -- Load user details from session/cookies
            ( { model
                | firstName = userData.firstName
                , lastName = userData.lastName
                , email = userData.email
                , phone = userData.phone
                , loadedFromSession = True

                -- Auto-validate email if it's been loaded from session
                , emailStatus =
                    if String.isEmpty userData.email then
                        NotChecked

                    else
                        Available
              }
            , Cmd.none
            , NoOutMsg
            )

        SaveUserDetails ->
            -- Explicit action to save user details to backend
            if isFormValid model then
                ( { model | isLoading = True }
                , saveUserDetails model
                , NoOutMsg
                )

            else
                ( model, Cmd.none, NoOutMsg )

        NoOp ->
            ( model, Cmd.none, NoOutMsg )



-- VIEW


view : Model -> Html Msg
view model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Personal Details" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Tell us about yourself" ]
            , if model.loadedFromSession then
                p [ class "text-blue-600 mt-2 italic" ]
                    [ text "Your previously entered information has been loaded." ]

              else
                text ""
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "bg-white shadow rounded-lg p-6" ]
                    [ div [ class "space-y-6" ]
                        [ div [ class "grid grid-cols-1 sm:grid-cols-2 gap-6" ]
                            [ div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "First Name" ]
                                , input
                                    [ type_ "text"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value model.firstName
                                    , onInput UpdateFirstName
                                    , placeholder "Enter your first name"
                                    ]
                                    []
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Last Name" ]
                                , input
                                    [ type_ "text"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value model.lastName
                                    , onInput UpdateLastName
                                    , placeholder "Enter your last name"
                                    ]
                                    []
                                ]
                            ]
                        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-6 pt-2" ]
                            [ div [ class "relative pb-6" ]
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Email" ]
                                , div [ class "relative" ]
                                    [ input
                                        [ type_ "email"
                                        , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        , value model.email
                                        , onInput UpdateEmail
                                        , onFocus EmailFocused
                                        , onBlur EmailBlurred
                                        , placeholder "you@example.com"
                                        ]
                                        []
                                    , viewEmailStatus model.emailStatus
                                    ]
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Phone" ]
                                , input
                                    [ type_ "tel"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value (formatPhoneNumber model.phone)
                                    , onInput UpdatePhone
                                    , placeholder "(555) 555-5555"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    ]

                {--
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                --}
                , div [ class "flex justify-center" ]
                    [ button
                        [ class
                            (if isFormValid model then
                                "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"

                             else
                                "px-4 py-2 sm:px-6 sm:py-3 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed"
                            )
                        , onClick NextStepClicked
                        , disabled (not (isFormValid model) || model.isLoading)
                        ]
                        [ if model.isLoading then
                            div [ class "flex items-center justify-center" ]
                                [ div [ class "animate-spin mr-2 h-4 w-4 border-t-2 border-b-2 border-white rounded-full" ] []
                                , text "Saving..."
                                ]

                          else
                            text "Continue"
                        ]
                    ]
                ]
        ]


viewEmailStatus : EmailStatus -> Html msg
viewEmailStatus status =
    case status of
        NotChecked ->
            -- When not checked, explicitly render an empty div structure to properly replace any previous status
            div []
                [ div [ class "absolute right-0 inset-y-0" ] [ text "" ]
                , text "" -- Empty text element to replace any error message
                ]

        Checking ->
            -- Show loading spinner while checking
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "animate-spin h-5 w-5 text-blue-500" ]
                            [ svg
                                [ viewBox "0 0 24 24"
                                , SvgAttr.class "h-5 w-5"
                                ]
                                [ circle
                                    [ cx "12"
                                    , cy "12"
                                    , r "10"
                                    , stroke "currentColor"
                                    , strokeWidth "4"
                                    , SvgAttr.class "opacity-25"
                                    ]
                                    []
                                , path
                                    [ fill "currentColor"
                                    , d "M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    , SvgAttr.class "opacity-75"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    ]
                , text "" -- Empty text element to replace any error message
                ]

        Available ->
            -- Show only the success icon for available emails
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "text-green-500" ]
                            [ svg
                                [ viewBox "0 0 20 20"
                                , fill "currentColor"
                                , SvgAttr.class "h-5 w-5"
                                ]
                                [ path
                                    [ fillRule "evenodd"
                                    , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                    , clipRule "evenodd"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    ]
                , text "" -- Empty text element to replace the error message
                ]

        Unavailable message ->
            -- For unavailable emails, show icon and error message
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "text-red-500" ]
                            [ svg
                                [ viewBox "0 0 20 20"
                                , fill "currentColor"
                                , SvgAttr.class "h-5 w-5"
                                ]
                                [ path
                                    [ fillRule "evenodd"
                                    , d "M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                    , clipRule "evenodd"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    ]
                , p
                    [ class "text-xs text-red-600 mt-1 absolute left-0 top-full w-full" ]
                    [ text message ]
                ]


viewLoading : Html msg
viewLoading =
    div [ class "text-center py-12" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading..." ]
        ]



-- HELPERS


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        digits =
            String.filter Char.isDigit phone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "("
            ++ String.left 3 digits
            ++ ") "
            ++ String.slice 3 6 digits
            ++ "-"
            ++ String.dropLeft 6 digits


isFormValid : Model -> Bool
isFormValid model =
    let
        emailValid =
            case model.emailStatus of
                Available ->
                    True

                -- If the email hasn't been checked yet, consider it invalid
                NotChecked ->
                    False

                -- Email is being checked, consider it invalid until check completes
                Checking ->
                    False

                -- Email is unavailable (error state)
                Unavailable _ ->
                    False
    in
    not (String.isEmpty (String.trim model.firstName))
        && not (String.isEmpty (String.trim model.lastName))
        && not (String.isEmpty (String.trim model.email))
        && not (String.isEmpty (String.trim model.phone))
        && emailValid



-- API CALLS


fetchUserDetails : String -> Cmd Msg
fetchUserDetails _ =
    Http.get
        { url = "/api/onboarding/user-details"
        , expect = Http.expectJson GotUserDetails userDetailsDecoder
        }


saveUserDetails : Model -> Cmd Msg
saveUserDetails model =
    let
        -- Ensure phone number only contains digits
        phoneDigits =
            String.filter Char.isDigit model.phone

        requestBody =
            Encode.object
                [ ( "firstName", Encode.string model.firstName )
                , ( "lastName", Encode.string model.lastName )
                , ( "email", Encode.string model.email )
                , ( "phone", Encode.string phoneDigits )
                ]

        url =
            "/api/onboarding/user-details"
    in
    Http.request
        { method = "POST"
        , url = url
        , headers = [] -- The session token is in the cookies, no need to pass it
        , body = Http.jsonBody requestBody
        , expect =
            Http.expectJson UserDetailsSaved
                (Decode.map3 SignupResponse
                    (Decode.field "success" Decode.bool)
                    (Decode.field "message" Decode.string)
                    (Decode.field "slug" Decode.string)
                )
        , timeout = Nothing
        , tracker = Nothing
        }


checkEmailAvailability : String -> Cmd Msg
checkEmailAvailability email =
    Http.request
        { method = "GET"
        , headers = []
        , url = "/api/organizations/check-email/" ++ email
        , body = Http.emptyBody
        , expect = Http.expectStringResponse GotEmailCheckResponse handleEmailCheckResponse
        , timeout = Nothing
        , tracker = Nothing
        }



-- Custom response handler to deal with empty responses and provide better error logging


handleEmailCheckResponse : Http.Response String -> Result Http.Error EmailCheckResponse
handleEmailCheckResponse response =
    case response of
        Http.BadUrl_ url ->
            Err (Http.BadUrl url)

        Http.Timeout_ ->
            Err Http.Timeout

        Http.NetworkError_ ->
            Err Http.NetworkError

        Http.BadStatus_ metadata body ->
            Err (Http.BadStatus metadata.statusCode)

        Http.GoodStatus_ metadata body ->
            -- If we get a 200 status but empty body, consider it a success
            if String.isEmpty (String.trim body) then
                Ok { available = True, message = "Email is available" }

            else
                -- Try to decode the response as JSON
                case Decode.decodeString emailCheckDecoder body of
                    Ok value ->
                        Ok value

                    Err error ->
                        -- Consider most 200 responses as success even with decode errors
                        Ok { available = True, message = "Email is available (decode error)" }



-- DECODERS & ENCODERS


userDetailsDecoder : Decode.Decoder UserDetailsResponse
userDetailsDecoder =
    Decode.map5 UserDetailsResponse
        (Decode.field "firstName" Decode.string)
        (Decode.field "lastName" Decode.string)
        (Decode.field "email" Decode.string)
        (Decode.field "phone" Decode.string)
        (Decode.oneOf
            [ Decode.field "slug" Decode.string
            , Decode.succeed "" -- Default to empty string if slug is not present
            ]
        )


emailCheckDecoder : Decode.Decoder EmailCheckResponse
emailCheckDecoder =
    let
        -- Try to be more flexible with the response format
        baseDecoder =
            Decode.map2 EmailCheckResponse
                (Decode.oneOf
                    [ Decode.field "available" Decode.bool
                    , Decode.field "success" Decode.bool
                    , Decode.succeed True -- Default to true if field not found (changed from false)
                    ]
                )
                (Decode.oneOf
                    [ Decode.field "message" Decode.string
                    , Decode.field "error" Decode.string
                    , Decode.succeed "Email is available" -- Changed default message
                    ]
                )
    in
    Decode.oneOf
        [ baseDecoder
        , Decode.field "data" baseDecoder
        , Decode.succeed { available = True, message = "Email is available" } -- Last resort fallback
        ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Onboarding/Onboarding.elm
================
port module Onboarding.Onboarding exposing
    ( Model
    , Msg(..)
    , Step(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser
import Browser.Dom as Dom
import Browser.Navigation as Nav
import Components.SetupLayout as SetupLayout
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Onboarding.Steps.AddAgents as AddAgents
import Onboarding.Steps.CompanyDetails as CompanyDetails
import Onboarding.Steps.EnterpriseForm as EnterpriseForm
import Onboarding.Steps.LicensingSettings as LicensingSettings
import Onboarding.Steps.Payment as Payment
import Onboarding.Steps.PlanSelection as PlanSelection exposing (fetchSubscriptionTiers)
import Onboarding.Steps.UserDetails as UserDetails
import Random
import Task
import Url
import Utils.RandomOrgName exposing (generateOrgName)



-- Ports for local storage


port storeOnboardingState : { organizationId : String, slug : String, sessionToken : String, step : Int, planType : String } -> Cmd msg


port retrieveOnboardingState : () -> Cmd msg


port onboardingStateReceived : (Maybe { organizationId : String, slug : String, sessionToken : String, step : Int, planType : String } -> msg) -> Sub msg



-- New ports for plan type


port retrievePlanType :
    String
    -> Cmd msg -- Send organization slug to get plan


port planTypeReceived :
    (Maybe String -> msg)
    -> Sub msg -- Receive plan type


port storePlanType :
    { orgSlug : String, planType : String }
    -> Cmd msg -- Store plan type in localStorage



-- New ports for user details


port storeUserDetails : { organizationId : String, firstName : String, lastName : String, email : String, phone : String } -> Cmd msg


port retrieveUserDetails :
    String
    -> Cmd msg -- Pass organization ID to get user details


port userDetailsReceived : (Maybe { firstName : String, lastName : String, email : String, phone : String } -> msg) -> Sub msg



-- MODEL


type Step
    = PlanSelectionStep
    | UserDetailsStep
    | CompanyDetailsStep
    | LicensingSettingsStep
    | AddAgentsStep
    | PaymentStep
    | EnterpriseFormStep


type alias Model =
    { step : Step
    , planSelectionModel : PlanSelection.Model
    , userDetailsModel : UserDetails.Model
    , companyDetailsModel : CompanyDetails.Model
    , licensingSettingsModel : LicensingSettings.Model
    , addAgentsModel : Maybe AddAgents.Model -- Optional, only for Pro plans
    , paymentModel : Payment.Model
    , enterpriseFormModel : Maybe EnterpriseForm.Model -- Optional, only for Enterprise plan
    , key : Nav.Key
    , orgSlug : String
    , session : String
    , isBasicPlan : Bool
    , error : Maybe String
    , isLoading : Bool

    -- New fields for progressive onboarding
    , organizationId : Maybe Int
    , sessionToken : Maybe String
    , onboardingInProgress : Bool

    -- Track if each step's model has been initialized
    , userDetailsInitialized : Bool
    , companyDetailsInitialized : Bool
    , licensingSettingsInitialized : Bool
    , addAgentsInitialized : Bool
    , paymentInitialized : Bool
    , enterpriseFormInitialized : Bool

    -- Track step history for back navigation
    , stepHistory : List Step
    }


init : Nav.Key -> String -> String -> Step -> ( Model, Cmd Msg )
init key orgSlug session initialStep =
    let
        -- Only fetch tiers when we're on the plan selection step
        isOnPlanSelectionStep =
            initialStep == PlanSelectionStep

        -- Check localStorage for any stored onboarding state
        ( planSelectionModel, planSelectionCmd ) =
            -- If we're not on the plan selection step but have a stored state with plan selection,
            -- we should initialize with the saved plan to ensure consistency
            if isOnPlanSelectionStep then
                PlanSelection.initWithFetch key orgSlug session True

            else
                PlanSelection.initWithFetch key orgSlug session False

        -- Determine if this is a new signup
        isNewSignup =
            String.isEmpty (String.trim orgSlug) || initialStep == PlanSelectionStep

        -- Initialize UserDetails model
        ( userDetailsModel, userDetailsCmd ) =
            UserDetails.init key orgSlug isNewSignup

        -- Initialize CompanyDetails model only if needed
        ( companyDetailsModel, companyDetailsCmd ) =
            if initialStep == CompanyDetailsStep then
                CompanyDetails.init key orgSlug session

            else
                -- Create an empty model without making API calls
                ( { agencyName = ""
                  , website = ""
                  , phone = ""
                  , primaryColor = "#0047AB" -- Default blue
                  , secondaryColor = "#FFFFFF" -- Default white
                  , logo = Nothing
                  , isLoading = False
                  , error = Nothing
                  , key = key
                  , orgSlug = orgSlug
                  , uploadingLogo = False
                  , sessionToken = session
                  , loadedFromSession = False
                  }
                , Cmd.none
                )

        -- Initialize LicensingSettings model only if needed
        ( licensingSettingsModel, licensingSettingsCmd ) =
            if initialStep == LicensingSettingsStep then
                LicensingSettings.init key orgSlug

            else
                -- Create an empty model without making API calls
                ( { carrierContracts = []
                  , useSmartSendForGI = True
                  , isLoading = False
                  , error = Nothing
                  , key = key
                  , orgSlug = orgSlug
                  , expandedSections = [ "Carrier Contracts", "Guaranteed Issue Settings" ]
                  }
                , Cmd.none
                )

        -- Initialize Payment model only if needed
        ( paymentModel, paymentCmd ) =
            if initialStep == PaymentStep then
                Payment.init key orgSlug

            else
                -- Create an empty model without making API calls
                ( { isLoading = False
                  , error = Nothing
                  , key = key
                  , orgSlug = orgSlug
                  , subscriptionDetails = Nothing
                  , processingPayment = False
                  , email = ""
                  }
                , Cmd.none
                )

        -- Check if we need to initialize the AddAgents model based on the initial step
        -- or if we're starting with a non-basic plan
        shouldInitAddAgents =
            initialStep
                == AddAgentsStep
                && (planSelectionModel.selectedPlan |> Maybe.map (\p -> p /= "basic") |> Maybe.withDefault False)

        ( addAgentsModel, addAgentsCmd ) =
            if shouldInitAddAgents then
                let
                    ( model, cmd ) =
                        AddAgents.init key orgSlug True
                in
                ( Just model, Cmd.map AddAgentsMsg cmd )

            else
                ( Nothing, Cmd.none )

        -- Initialize enterprise form model if needed
        ( enterpriseFormModel, enterpriseFormCmd ) =
            if initialStep == EnterpriseFormStep then
                let
                    ( model, cmd ) =
                        EnterpriseForm.init key
                in
                ( Just model, Cmd.map EnterpriseFormMsg cmd )

            else
                ( Nothing, Cmd.none )

        -- Determine if we're on a basic plan
        isBasicPlan =
            planSelectionModel.selectedPlan
                |> Maybe.map (\p -> p == "basic")
                |> Maybe.withDefault True

        -- Determine which commands to run based on the current step
        initCmds =
            case initialStep of
                PlanSelectionStep ->
                    [ Cmd.map PlanSelectionMsg planSelectionCmd
                    , retrieveOnboardingState () -- Check for any in-progress onboarding
                    , if not (String.isEmpty orgSlug) then
                        -- When on plan selection, also try to get the plan type directly
                        retrievePlanType orgSlug

                      else
                        Cmd.none
                    ]

                UserDetailsStep ->
                    [ Cmd.map UserDetailsMsg userDetailsCmd
                    , retrieveOnboardingState () -- Check for any in-progress onboarding
                    , if not isNewSignup && not (String.isEmpty orgSlug) then
                        -- When on user details step and not a new signup, fetch user details
                        fetchUserDetails orgSlug ""

                      else
                        Cmd.none
                    ]

                CompanyDetailsStep ->
                    [ Cmd.map CompanyDetailsMsg companyDetailsCmd ]

                LicensingSettingsStep ->
                    [ Cmd.map LicensingSettingsMsg licensingSettingsCmd ]

                AddAgentsStep ->
                    [ addAgentsCmd ]

                PaymentStep ->
                    [ Cmd.map PaymentMsg paymentCmd ]

                EnterpriseFormStep ->
                    [ enterpriseFormCmd ]
    in
    ( { step = initialStep
      , planSelectionModel = planSelectionModel
      , userDetailsModel = userDetailsModel
      , companyDetailsModel = companyDetailsModel
      , licensingSettingsModel = licensingSettingsModel
      , addAgentsModel = addAgentsModel
      , paymentModel = paymentModel
      , enterpriseFormModel = enterpriseFormModel
      , key = key
      , orgSlug = orgSlug
      , session = session
      , isBasicPlan = isBasicPlan
      , error = Nothing
      , isLoading = False

      -- Initialize new fields
      , organizationId = Nothing
      , sessionToken = Nothing
      , onboardingInProgress = False

      -- Initialize step tracking to match current models
      , userDetailsInitialized = initialStep == UserDetailsStep
      , companyDetailsInitialized = initialStep == CompanyDetailsStep
      , licensingSettingsInitialized = initialStep == LicensingSettingsStep
      , addAgentsInitialized = shouldInitAddAgents
      , paymentInitialized = initialStep == PaymentStep
      , enterpriseFormInitialized = initialStep == EnterpriseFormStep

      -- Initialize step history
      , stepHistory = []
      }
    , Cmd.batch initCmds
    )



-- Helper function to update step and maintain history


changeStep : Step -> Model -> Model
changeStep newStep model =
    -- Only add to history if actually changing step
    if newStep /= model.step then
        { model
            | step = newStep
            , stepHistory = model.step :: model.stepHistory

            -- Reset initialization flags based on the new step
            , userDetailsInitialized =
                if newStep == UserDetailsStep then
                    False

                else
                    model.userDetailsInitialized
            , companyDetailsInitialized =
                if newStep == CompanyDetailsStep then
                    False

                else
                    model.companyDetailsInitialized
            , licensingSettingsInitialized =
                if newStep == LicensingSettingsStep then
                    False

                else
                    model.licensingSettingsInitialized
            , addAgentsInitialized =
                if newStep == AddAgentsStep then
                    False

                else
                    model.addAgentsInitialized
            , paymentInitialized =
                if newStep == PaymentStep then
                    False

                else
                    model.paymentInitialized
            , enterpriseFormInitialized =
                if newStep == EnterpriseFormStep then
                    False

                else
                    model.enterpriseFormInitialized
        }

    else
        model



-- UPDATE


type Msg
    = PlanSelectionMsg PlanSelection.Msg
    | UserDetailsMsg UserDetails.Msg
    | CompanyDetailsMsg CompanyDetails.Msg
    | LicensingSettingsMsg LicensingSettings.Msg
    | AddAgentsMsg AddAgents.Msg
    | PaymentMsg Payment.Msg
    | EnterpriseFormMsg EnterpriseForm.Msg
    | NavigateToStep Step
    | NavigateBack
    | SkipStep
    | CompleteOnboarding (Result Http.Error ())
    | GotError String
    | NoOp
      -- New messages for progressive onboarding
    | InitOnboarding String String -- planType, email
    | OnboardingInitialized (Result Http.Error { organizationId : Int, slug : String, sessionToken : String, onboardingStep : Int, planType : String })
    | OnboardingStateReceived (Maybe { organizationId : String, slug : String, sessionToken : String, step : Int, planType : String })
    | UpdateUser
    | UserUpdated (Result Http.Error { onboardingStep : Int })
    | UpdateCompany
    | CompanyUpdated (Result Http.Error { onboardingStep : Int })
    | UpdateLicensing
    | LicensingUpdated (Result Http.Error { onboardingStep : Int, nextStep : Int, isBasicPlan : Bool })
    | AddTeamMembers
    | TeamMembersAdded (Result Http.Error { onboardingStep : Int })
    | CompleteSubscription
    | SubscriptionCompleted (Result Http.Error { clientSecret : String, publishableKey : String })
    | ResumeOnboarding String -- email
    | PlanTypeReceived (Maybe String) -- New message for plan type
    | UserDetailsReceived (Maybe { firstName : String, lastName : String, email : String, phone : String })
    | ScrollToTop
    | RandomOrgNameGenerated String
    | GotUserDetails (Result Http.Error { firstName : String, lastName : String, email : String, phone : String })
    | InitializeCurrentStep
    | CompanyDetailsSaved (Result Http.Error { onboardingStep : Int })


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        PlanSelectionMsg subMsg ->
            let
                ( updatedPlanModel, planCmd, outMsg ) =
                    PlanSelection.update subMsg model.planSelectionModel

                -- Handle the selected plan type to determine if we need to initialize the AddAgents model
                ( isBasicPlan, storePlanCmd ) =
                    case outMsg of
                        PlanSelection.SelectedPlan planType ->
                            -- Only store plan type if we haven't already
                            if model.sessionToken == Nothing then
                                ( planType == "basic"
                                , storePlanType { orgSlug = model.orgSlug, planType = planType }
                                )

                            else
                                ( planType == "basic", Cmd.none )

                        _ ->
                            ( model.isBasicPlan, Cmd.none )

                -- Initialize AddAgents model if needed and not already initialized
                ( addAgentsModel, addAgentsInitialized, addAgentsCmd ) =
                    if not isBasicPlan && model.addAgentsModel == Nothing then
                        let
                            ( newModel, cmd ) =
                                AddAgents.init model.key model.orgSlug True
                        in
                        ( Just newModel, True, Cmd.map AddAgentsMsg cmd )

                    else
                        ( model.addAgentsModel, model.addAgentsInitialized, Cmd.none )

                -- Create navigation command (now just updates the model)
                updatedModelWithStep =
                    case outMsg of
                        PlanSelection.NextStep ->
                            changeStep UserDetailsStep model

                        _ ->
                            model

                -- Process onboarding initialization if needed
                ( updatedModel, onboardingCmd ) =
                    case outMsg of
                        PlanSelection.OnboardingInitializedSuccess response ->
                            -- Only store onboarding state if we haven't already
                            if model.sessionToken == Nothing then
                                let
                                    state =
                                        { organizationId = String.fromInt response.organizationId
                                        , slug = response.slug
                                        , sessionToken = response.sessionToken
                                        , step = response.onboardingStep
                                        , planType = response.planType
                                        }

                                    oldUserDetailsModel =
                                        model.userDetailsModel

                                    updatedUserDetailsModel =
                                        { oldUserDetailsModel | orgSlug = response.slug }

                                    navigationCmd =
                                        Nav.pushUrl model.key "/onboarding/personal"
                                in
                                ( { updatedModelWithStep
                                    | organizationId = Just response.organizationId
                                    , orgSlug = response.slug
                                    , sessionToken = Just response.sessionToken
                                    , onboardingInProgress = True
                                    , step = UserDetailsStep
                                    , userDetailsModel = updatedUserDetailsModel
                                  }
                                , Cmd.batch
                                    [ storeOnboardingState state
                                    , navigationCmd
                                    ]
                                )

                            else
                                ( updatedModelWithStep, Cmd.none )

                        PlanSelection.NextStep ->
                            let
                                navigationCmd =
                                    Nav.pushUrl model.key "/onboarding/personal"
                            in
                            ( updatedModelWithStep
                            , navigationCmd
                            )

                        _ ->
                            ( updatedModelWithStep, Cmd.none )

                -- Handle error messages
                errorCmd =
                    case outMsg of
                        PlanSelection.ShowError err ->
                            Cmd.none

                        _ ->
                            Cmd.none
            in
            ( { updatedModel
                | planSelectionModel = updatedPlanModel
                , isBasicPlan = isBasicPlan
                , addAgentsModel = addAgentsModel
                , addAgentsInitialized = addAgentsInitialized
              }
            , Cmd.batch
                [ Cmd.map PlanSelectionMsg planCmd
                , errorCmd
                , addAgentsCmd
                , onboardingCmd
                , storePlanCmd
                , Task.perform (\_ -> ScrollToTop) (Task.succeed ())
                ]
            )

        UserDetailsMsg subMsg ->
            let
                ( updatedUserDetailsModel, userDetailsCmd, outMsg ) =
                    UserDetails.update subMsg model.userDetailsModel

                -- Update navigation without URL changes
                updatedModelWithStep =
                    case outMsg of
                        UserDetails.NextStep ->
                            let
                                nextStep =
                                    getNextStep UserDetailsStep model.isBasicPlan

                                stepChangedModel =
                                    changeStep nextStep model

                                -- Initialize the next step
                                ( _, initializedModel ) =
                                    initializeStep nextStep stepChangedModel
                            in
                            initializedModel

                        _ ->
                            model

                -- Handle the new slug update
                updatedModelWithSlug =
                    case outMsg of
                        UserDetails.UpdateOrgSlug newSlug ->
                            let
                                -- Update all sub-models that need the slug
                                oldCompanyDetails =
                                    model.companyDetailsModel

                                updatedCompanyDetailsModel =
                                    { oldCompanyDetails | orgSlug = newSlug }

                                oldLicensingSettings =
                                    model.licensingSettingsModel

                                updatedLicensingSettingsModel =
                                    { oldLicensingSettings | orgSlug = newSlug }

                                updatedAddAgentsModel =
                                    model.addAgentsModel
                                        |> Maybe.map (\m -> { m | orgSlug = newSlug })
                            in
                            { updatedModelWithStep
                                | orgSlug = newSlug
                                , companyDetailsModel = updatedCompanyDetailsModel
                                , licensingSettingsModel = updatedLicensingSettingsModel
                                , addAgentsModel = updatedAddAgentsModel
                            }

                        UserDetails.NextStepAndUpdateSlug newSlug ->
                            let
                                -- Update all sub-models that need the slug
                                oldCompanyDetails =
                                    model.companyDetailsModel

                                updatedCompanyDetailsModel =
                                    { oldCompanyDetails | orgSlug = newSlug }

                                oldLicensingSettings =
                                    model.licensingSettingsModel

                                updatedLicensingSettingsModel =
                                    { oldLicensingSettings | orgSlug = newSlug }

                                updatedAddAgentsModel =
                                    model.addAgentsModel
                                        |> Maybe.map (\m -> { m | orgSlug = newSlug })

                                nextStep =
                                    getNextStep UserDetailsStep model.isBasicPlan
                            in
                            { model
                                | orgSlug = newSlug
                                , companyDetailsModel = updatedCompanyDetailsModel
                                , licensingSettingsModel = updatedLicensingSettingsModel
                                , addAgentsModel = updatedAddAgentsModel
                                , step = nextStep
                                , sessionToken = Just updatedUserDetailsModel.sessionToken
                            }

                        _ ->
                            updatedModelWithStep

                outCmd =
                    case outMsg of
                        UserDetails.NoOutMsg ->
                            Cmd.none

                        UserDetails.NextStep ->
                            case model.sessionToken of
                                Just token ->
                                    updateUserDetails updatedUserDetailsModel.orgSlug token updatedUserDetailsModel

                                Nothing ->
                                    -- Generate a random org name when creating a new organization
                                    Random.generate RandomOrgNameGenerated generateOrgName

                        UserDetails.ShowError err ->
                            Cmd.none

                        UserDetails.SaveUserToCookie userData ->
                            -- Store user details in localStorage
                            case model.organizationId of
                                Just orgId ->
                                    storeUserDetails
                                        { organizationId = String.fromInt orgId
                                        , firstName = userData.firstName
                                        , lastName = userData.lastName
                                        , email = userData.email
                                        , phone = userData.phone
                                        }

                                Nothing ->
                                    -- If no organization ID, try to use slug
                                    if not (String.isEmpty model.orgSlug) then
                                        storeUserDetails
                                            { organizationId = model.orgSlug
                                            , firstName = userData.firstName
                                            , lastName = userData.lastName
                                            , email = userData.email
                                            , phone = userData.phone
                                            }

                                    else
                                        Cmd.none

                        UserDetails.UpdateOrgSlug _ ->
                            Cmd.none

                        UserDetails.NextStepAndUpdateSlug _ ->
                            case model.sessionToken of
                                Just token ->
                                    updateUserDetails updatedUserDetailsModel.orgSlug token updatedUserDetailsModel

                                Nothing ->
                                    -- Generate a random org name when creating a new organization
                                    Random.generate RandomOrgNameGenerated generateOrgName
            in
            ( { updatedModelWithSlug
                | userDetailsModel = updatedUserDetailsModel
                , userDetailsInitialized = True
                , sessionToken = Just updatedUserDetailsModel.sessionToken
              }
            , Cmd.batch
                [ Cmd.map UserDetailsMsg userDetailsCmd
                , outCmd
                ]
            )

        CompanyDetailsMsg subMsg ->
            let
                ( updatedCompanyDetailsModel, companyDetailsCmd, outMsg ) =
                    CompanyDetails.update subMsg model.companyDetailsModel

                -- Update navigation without URL changes
                updatedModelWithStep =
                    case outMsg of
                        CompanyDetails.NextStep ->
                            let
                                nextStep =
                                    getNextStep CompanyDetailsStep model.isBasicPlan

                                -- Add navigation command
                                navigationCmd =
                                    Nav.pushUrl model.key (getStepFragment nextStep)

                                stepChangedModel =
                                    changeStep nextStep model
                            in
                            stepChangedModel

                        _ ->
                            model

                -- When NextStep is triggered, also update company details and navigate
                outCmd =
                    case outMsg of
                        CompanyDetails.NoOutMsg ->
                            Cmd.none

                        CompanyDetails.NextStep ->
                            let
                                nextStep =
                                    getNextStep CompanyDetailsStep model.isBasicPlan

                                -- Add URL navigation command
                                navCmd =
                                    Nav.pushUrl model.key (getStepFragment nextStep)

                                updateCmd =
                                    case model.sessionToken of
                                        Just token ->
                                            updateCompanyDetails model.orgSlug token updatedCompanyDetailsModel

                                        Nothing ->
                                            Cmd.none
                            in
                            Cmd.batch [ updateCmd, navCmd ]

                        CompanyDetails.ShowError err ->
                            Cmd.none

                -- Always ensure the company details model has the latest orgSlug
                updatedCompanyDetailsModelWithSlug =
                    { updatedCompanyDetailsModel | orgSlug = model.orgSlug }
            in
            ( { updatedModelWithStep
                | companyDetailsModel = updatedCompanyDetailsModelWithSlug
              }
            , Cmd.batch
                [ Cmd.map CompanyDetailsMsg companyDetailsCmd
                , outCmd
                ]
            )

        CompanyDetailsSaved result ->
            case result of
                Ok response ->
                    let
                        nextStep =
                            getNextStep CompanyDetailsStep model.isBasicPlan

                        -- Add URL navigation command
                        navCmd =
                            Nav.pushUrl model.key (getStepFragment nextStep)
                    in
                    ( { model | isLoading = False, companyDetailsInitialized = True }
                    , navCmd
                    )

                Err error ->
                    ( { model | error = Just "Failed to save company details. Please try again." }
                    , Cmd.none
                    )

        LicensingSettingsMsg subMsg ->
            let
                ( updatedLicensingSettingsModel, licensingSettingsCmd, outMsg ) =
                    LicensingSettings.update subMsg model.licensingSettingsModel

                -- Ensure addAgentsModel is initialized if we're on a non-basic plan
                ( addAgentsModel, addAgentsInitialized, addAgentsCmd ) =
                    if not model.isBasicPlan && model.addAgentsModel == Nothing then
                        let
                            ( newModel, cmd ) =
                                AddAgents.init model.key model.orgSlug True
                        in
                        ( Just newModel, True, Cmd.map AddAgentsMsg cmd )

                    else
                        ( model.addAgentsModel, model.addAgentsInitialized, Cmd.none )

                -- Update navigation without URL changes
                updatedModelWithStep =
                    case outMsg of
                        LicensingSettings.NextStep ->
                            let
                                nextStep =
                                    getNextStep LicensingSettingsStep model.isBasicPlan

                                stepChangedModel =
                                    changeStep nextStep model

                                -- Initialize the next step
                                ( _, initializedModel ) =
                                    initializeStep nextStep stepChangedModel
                            in
                            initializedModel

                        _ ->
                            model

                -- When NextStep is triggered, also update licensing settings
                outCmd =
                    case outMsg of
                        LicensingSettings.NoOutMsg ->
                            Cmd.none

                        LicensingSettings.NextStep ->
                            case model.sessionToken of
                                Just token ->
                                    updateLicensingDetails model.orgSlug token updatedLicensingSettingsModel

                                Nothing ->
                                    Cmd.none

                        LicensingSettings.ShowError err ->
                            Cmd.none
            in
            ( { updatedModelWithStep
                | licensingSettingsModel = updatedLicensingSettingsModel
                , addAgentsModel = addAgentsModel
                , addAgentsInitialized = addAgentsInitialized
              }
            , Cmd.batch
                [ Cmd.map LicensingSettingsMsg licensingSettingsCmd
                , outCmd
                , addAgentsCmd
                ]
            )

        AddAgentsMsg subMsg ->
            case model.addAgentsModel of
                Just addAgentsModel ->
                    let
                        ( updatedAddAgentsModel, addAgentsCmd, outMsg ) =
                            AddAgents.update subMsg addAgentsModel

                        -- Update navigation without URL changes
                        updatedModelWithStep =
                            case outMsg of
                                AddAgents.NextStep ->
                                    let
                                        nextStep =
                                            getNextStep AddAgentsStep model.isBasicPlan
                                    in
                                    changeStep nextStep model

                                _ ->
                                    model

                        outCmd =
                            case outMsg of
                                AddAgents.NoOutMsg ->
                                    Cmd.none

                                AddAgents.NextStep ->
                                    Task.perform (\_ -> ScrollToTop) (Task.succeed ())

                                AddAgents.ShowError err ->
                                    Cmd.none
                    in
                    ( { updatedModelWithStep
                        | addAgentsModel = Just updatedAddAgentsModel
                        , addAgentsInitialized = True
                      }
                    , Cmd.batch
                        [ Cmd.map AddAgentsMsg addAgentsCmd
                        , outCmd
                        ]
                    )

                Nothing ->
                    -- Initialize the model if it doesn't exist
                    let
                        ( newAddAgentsModel, addAgentsCmd ) =
                            AddAgents.init model.key model.orgSlug True
                    in
                    ( { model
                        | addAgentsModel = Just newAddAgentsModel
                        , addAgentsInitialized = True
                      }
                    , Cmd.map AddAgentsMsg addAgentsCmd
                    )

        PaymentMsg subMsg ->
            let
                ( updatedPaymentModel, paymentCmd, outMsg ) =
                    Payment.update subMsg model.paymentModel

                outCmd =
                    case outMsg of
                        Payment.NoOutMsg ->
                            Cmd.none

                        Payment.Completed ->
                            -- Only complete onboarding if we're at the final step
                            if model.step == PaymentStep then
                                -- First update company details if needed
                                if not model.companyDetailsInitialized then
                                    case model.sessionToken of
                                        Just token ->
                                            updateCompanyDetails model.orgSlug token model.companyDetailsModel

                                        Nothing ->
                                            Cmd.none
                                    -- Then update licensing settings if needed

                                else if not model.licensingSettingsInitialized then
                                    case model.sessionToken of
                                        Just token ->
                                            updateLicensingDetails model.orgSlug token model.licensingSettingsModel

                                        Nothing ->
                                            Cmd.none
                                    -- Then add team members if needed (for non-basic plans)

                                else if not model.isBasicPlan && not model.addAgentsInitialized then
                                    case ( model.sessionToken, model.addAgentsModel ) of
                                        ( Just token, Just agentsModel ) ->
                                            addTeamMembers model.orgSlug token agentsModel

                                        _ ->
                                            Cmd.none
                                    -- Finally complete the onboarding

                                else
                                    completeOnboarding model

                            else
                                Cmd.none

                        Payment.NavigateToWalkthrough ->
                            -- Only complete onboarding if we're at the final step
                            if model.step == PaymentStep then
                                -- Same flow as Completed
                                if not model.companyDetailsInitialized then
                                    case model.sessionToken of
                                        Just token ->
                                            updateCompanyDetails model.orgSlug token model.companyDetailsModel

                                        Nothing ->
                                            Cmd.none

                                else if not model.licensingSettingsInitialized then
                                    case model.sessionToken of
                                        Just token ->
                                            updateLicensingDetails model.orgSlug token model.licensingSettingsModel

                                        Nothing ->
                                            Cmd.none

                                else if not model.isBasicPlan && not model.addAgentsInitialized then
                                    case ( model.sessionToken, model.addAgentsModel ) of
                                        ( Just token, Just agentsModel ) ->
                                            addTeamMembers model.orgSlug token agentsModel

                                        _ ->
                                            Cmd.none

                                else
                                    completeOnboarding model

                            else
                                Cmd.none

                        Payment.ShowError err ->
                            Cmd.none
            in
            ( { model
                | paymentModel = updatedPaymentModel
                , paymentInitialized = True
              }
            , Cmd.batch
                [ Cmd.map PaymentMsg paymentCmd
                , outCmd
                ]
            )

        EnterpriseFormMsg subMsg ->
            case model.enterpriseFormModel of
                Just enterpriseFormModel ->
                    let
                        ( updatedEnterpriseFormModel, enterpriseFormCmd, outMsg ) =
                            EnterpriseForm.update subMsg enterpriseFormModel

                        -- Check if we're navigating back to plan selection
                        updatedModelWithStep =
                            if outMsg == EnterpriseForm.BackToPlanSelection then
                                changeStep PlanSelectionStep model

                            else
                                model

                        outCmd =
                            case outMsg of
                                EnterpriseForm.NoOutMsg ->
                                    Cmd.none

                                EnterpriseForm.BackToPlanSelection ->
                                    Task.perform (\_ -> ScrollToTop) (Task.succeed ())

                                EnterpriseForm.ShowError err ->
                                    Cmd.none
                    in
                    ( { updatedModelWithStep
                        | enterpriseFormModel = Just updatedEnterpriseFormModel
                        , enterpriseFormInitialized = True
                      }
                    , Cmd.batch
                        [ Cmd.map EnterpriseFormMsg enterpriseFormCmd
                        , outCmd
                        ]
                    )

                Nothing ->
                    -- If the model doesn't exist, create it
                    let
                        ( enterpriseFormModel, enterpriseFormCmd ) =
                            EnterpriseForm.init model.key
                    in
                    ( { model
                        | enterpriseFormModel = Just enterpriseFormModel
                        , enterpriseFormInitialized = True
                      }
                    , Cmd.map EnterpriseFormMsg enterpriseFormCmd
                    )

        NavigateToStep step ->
            let
                updatedModel =
                    changeStep step model

                -- Update URL fragment without page reload to preserve state in browser history
                urlUpdateCmd =
                    Nav.pushUrl model.key (getStepFragment step)

                -- Initialize the step directly
                ( initCmd, finalModel ) =
                    initializeStep step updatedModel
            in
            ( finalModel
            , Cmd.batch
                [ urlUpdateCmd
                , initCmd
                , Task.perform (\_ -> ScrollToTop) (Task.succeed ())
                ]
            )

        NavigateBack ->
            case model.stepHistory of
                previousStep :: restHistory ->
                    let
                        updatedModel =
                            { model
                                | step = previousStep
                                , stepHistory = restHistory
                            }

                        -- Initialize the step directly
                        ( initCmd, finalModel ) =
                            initializeStep previousStep updatedModel
                    in
                    ( finalModel
                    , Cmd.batch
                        [ Nav.pushUrl model.key (getStepFragment previousStep)
                        , initCmd
                        , Task.perform (\_ -> ScrollToTop) (Task.succeed ())
                        ]
                    )

                [] ->
                    -- If no history, stay on current step
                    ( model, Cmd.none )

        SkipStep ->
            let
                nextStep =
                    getNextStep model.step model.isBasicPlan

                updatedModel =
                    changeStep nextStep model

                -- Initialize the step directly
                ( initCmd, finalModel ) =
                    initializeStep nextStep updatedModel
            in
            ( finalModel
            , Cmd.batch
                [ Nav.pushUrl model.key (getStepFragment nextStep)
                , initCmd
                , Task.perform (\_ -> ScrollToTop) (Task.succeed ())
                ]
            )

        ScrollToTop ->
            ( model, Dom.setViewport 0 0 |> Task.attempt (\_ -> NoOp) )

        CompleteOnboarding result ->
            case result of
                Ok _ ->
                    -- Redirect directly to walkthrough, bypassing login
                    ( { model | isLoading = False }
                    , Nav.pushUrl model.key "/walkthrough"
                    )

                Err _ ->
                    ( { model | isLoading = False, error = Just "Failed to complete onboarding. Please try again." }
                    , Cmd.none
                    )

        GotError errorMsg ->
            ( { model | error = Just errorMsg, isLoading = False }, Cmd.none )

        NoOp ->
            ( model, Cmd.none )

        -- New messages for progressive onboarding
        InitOnboarding planType email ->
            ( { model | isLoading = True }
            , initializeOnboarding planType email model.orgSlug
            )

        OnboardingInitialized result ->
            case result of
                Ok response ->
                    -- Store state in localStorage
                    let
                        state =
                            { organizationId = String.fromInt response.organizationId
                            , slug = response.slug
                            , sessionToken = response.sessionToken
                            , step = response.onboardingStep
                            , planType = response.planType
                            }

                        -- Reinitialize the user details model with the proper org slug
                        ( newUserDetailsModel, userDetailsCmd ) =
                            UserDetails.init model.key response.slug True

                        -- Update plan selection model with the plan type
                        oldPlanSelectionModel =
                            model.planSelectionModel

                        newPlanSelectionModel =
                            { oldPlanSelectionModel | selectedPlan = Just response.planType }
                    in
                    ( { model
                        | isLoading = False
                        , organizationId = Just response.organizationId
                        , orgSlug = response.slug
                        , sessionToken = Just response.sessionToken
                        , onboardingInProgress = True
                        , step = UserDetailsStep
                        , userDetailsModel = newUserDetailsModel
                        , planSelectionModel = newPlanSelectionModel
                      }
                    , Cmd.batch
                        [ storeOnboardingState state
                        , Nav.pushUrl model.key "/onboarding/personal"
                        , Cmd.map UserDetailsMsg userDetailsCmd
                        ]
                    )

                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to initialize onboarding. Please try again."
                      }
                    , Cmd.none
                    )

        OnboardingStateReceived maybeState ->
            case maybeState of
                Just state ->
                    -- If we have a stored state, resume onboarding
                    let
                        step =
                            case state.step of
                                1 ->
                                    UserDetailsStep

                                2 ->
                                    CompanyDetailsStep

                                3 ->
                                    LicensingSettingsStep

                                4 ->
                                    AddAgentsStep

                                5 ->
                                    PaymentStep

                                _ ->
                                    PlanSelectionStep

                        organizationId =
                            String.toInt state.organizationId

                        -- Use the planType from the state
                        planType =
                            state.planType

                        -- Extract plan type from session - in a real app this should be retrieved from API
                        -- For now we'll load it from cookie/session storage via a port
                        fetchPlanTypeCmd =
                            if not (String.isEmpty state.slug) && not (String.isEmpty state.sessionToken) then
                                -- In a real implementation, issue an API request to get the plan
                                -- For now, trigger the port to get the plan type from localStorage
                                retrievePlanType state.slug

                            else
                                Cmd.none

                        -- Update the plan selection model with the saved plan
                        updatedPlanSelectionModel =
                            let
                                currentModel =
                                    model.planSelectionModel

                                -- Only update if we don't already have a selection
                                planSelectionWithSession =
                                    if currentModel.selectedPlan == Nothing then
                                        -- Set the selected plan and mark as loaded from session
                                        { currentModel
                                            | selectedPlan = Just planType
                                            , loadedFromSession = True
                                            , orgSlug = state.slug
                                        }

                                    else
                                        currentModel
                            in
                            planSelectionWithSession

                        oldUserDetailsModel =
                            model.userDetailsModel

                        updatedUserDetailsModel =
                            { oldUserDetailsModel | orgSlug = state.slug }

                        updatedModel =
                            { model
                                | orgSlug = state.slug
                                , sessionToken = Just state.sessionToken
                                , organizationId = organizationId
                                , onboardingInProgress = True
                                , step = step
                                , planSelectionModel = updatedPlanSelectionModel
                                , isBasicPlan = planType == "basic"
                                , userDetailsModel = updatedUserDetailsModel
                            }

                        -- Command to navigate to the appropriate step
                        navigateCmd =
                            Nav.pushUrl model.key (getStepFragment step)

                        -- If we're on the plan selection step, send the plan type to PlanSelection
                        planSelectionCmd =
                            if step == PlanSelectionStep then
                                -- Send command to load the plan from session if we have one
                                case updatedPlanSelectionModel.selectedPlan of
                                    Just plan ->
                                        Cmd.map PlanSelectionMsg (Task.perform (\_ -> PlanSelection.LoadPlanFromSession plan) (Task.succeed ()))

                                    Nothing ->
                                        Cmd.none

                            else
                                Cmd.none
                    in
                    ( updatedModel
                    , Cmd.batch
                        [ navigateCmd
                        , fetchPlanTypeCmd
                        , planSelectionCmd
                        ]
                    )

                Nothing ->
                    -- No stored state, continue as normal
                    ( model, Cmd.none )

        UpdateUser ->
            case model.sessionToken of
                Just token ->
                    ( { model | isLoading = True }
                    , updateUserDetails model.orgSlug token model.userDetailsModel
                    )

                Nothing ->
                    ( { model | error = Just "Session information is missing. Please try again." }
                    , Cmd.none
                    )

        UserUpdated result ->
            case result of
                Ok response ->
                    ( { model
                        | isLoading = False
                        , step = CompanyDetailsStep
                      }
                    , Nav.pushUrl model.key "/onboarding/company"
                    )

                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to update user details. Please try again."
                      }
                    , Cmd.none
                    )

        UpdateCompany ->
            case model.sessionToken of
                Just token ->
                    ( { model | isLoading = True }
                    , updateCompanyDetails model.orgSlug token model.companyDetailsModel
                    )

                Nothing ->
                    ( { model | error = Just "Session information is missing. Please try again." }
                    , Cmd.none
                    )

        CompanyUpdated result ->
            case result of
                Ok response ->
                    -- After company details are updated, update licensing settings
                    let
                        nextCmd =
                            case model.sessionToken of
                                Just token ->
                                    updateLicensingDetails model.orgSlug token model.licensingSettingsModel

                                Nothing ->
                                    Cmd.none
                    in
                    ( { model
                        | isLoading = False
                        , companyDetailsInitialized = True
                      }
                    , nextCmd
                    )

                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to update company details. Please try again."
                      }
                    , Cmd.none
                    )

        UpdateLicensing ->
            case model.sessionToken of
                Just token ->
                    ( { model | isLoading = True }
                    , updateLicensingDetails model.orgSlug token model.licensingSettingsModel
                    )

                Nothing ->
                    ( { model | error = Just "Session information is missing. Please try again." }
                    , Cmd.none
                    )

        LicensingUpdated result ->
            case result of
                Ok response ->
                    -- After licensing settings are updated, navigate to the next step
                    let
                        nextStep =
                            if not response.isBasicPlan then
                                AddAgentsStep

                            else
                                PaymentStep

                        -- Use the nextStep field from the response to determine if we should navigate
                        -- instead of checking carrierContracts which doesn't exist in the response
                        gotoNextStep =
                            response.nextStep > 0

                        navCmd =
                            if gotoNextStep then
                                Nav.pushUrl model.key (getStepFragment nextStep)

                            else
                                Cmd.none
                    in
                    ( { model
                        | isLoading = False
                        , licensingSettingsInitialized = True
                        , isBasicPlan = response.isBasicPlan
                        , step =
                            --if gotoNextStep then
                            --    nextStep
                            --else
                            model.step
                      }
                    , Cmd.none
                      -- navCmd
                    )

                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to update licensing details. Please try again."
                      }
                    , Cmd.none
                    )

        AddTeamMembers ->
            case model.sessionToken of
                Just token ->
                    case model.addAgentsModel of
                        Just agentsModel ->
                            ( { model | isLoading = True }
                            , addTeamMembers model.orgSlug token agentsModel
                            )

                        Nothing ->
                            ( { model | error = Just "Team members information is missing. Please try again." }
                            , Cmd.none
                            )

                Nothing ->
                    ( { model | error = Just "Session information is missing. Please try again." }
                    , Cmd.none
                    )

        TeamMembersAdded result ->
            case result of
                Ok response ->
                    -- After team members are added, navigate to payment step
                    let
                        nextStep =
                            PaymentStep

                        navCmd =
                            Nav.pushUrl model.key (getStepFragment nextStep)
                    in
                    ( { model
                        | isLoading = False
                        , addAgentsInitialized = True
                        , step = nextStep
                      }
                    , navCmd
                    )

                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to add team members. Please try again."
                      }
                    , Cmd.none
                    )

        CompleteSubscription ->
            case model.sessionToken of
                Just token ->
                    let
                        selectedPlan =
                            model.planSelectionModel.selectedPlan |> Maybe.withDefault "basic"

                        extraAgents =
                            model.planSelectionModel.extraAgents

                        extraContacts =
                            model.planSelectionModel.extraContacts
                    in
                    ( { model | isLoading = True }
                    , completeSubscription model.orgSlug token selectedPlan extraAgents extraContacts
                    )

                Nothing ->
                    ( { model | error = Just "Session information is missing. Please try again." }
                    , Cmd.none
                    )

        SubscriptionCompleted result ->
            case result of
                Ok response ->
                    -- Clear onboarding state from localStorage and redirect to success page
                    ( { model | isLoading = False }
                    , Cmd.batch
                        [ Nav.pushUrl model.key ("/login?onboarding=completed&email=" ++ Url.percentEncode model.userDetailsModel.email)
                        ]
                    )

                -- don't remove the parens here
                Err error ->
                    ( { model
                        | isLoading = False
                        , error = Just "Failed to complete subscription. Please try again."
                      }
                    , Cmd.none
                    )

        ResumeOnboarding email ->
            ( { model | isLoading = True }
            , resumeOnboarding email
            )

        PlanTypeReceived maybePlanType ->
            let
                planType =
                    Maybe.withDefault "basic" maybePlanType

                updatedPlanSelectionModel =
                    let
                        currentModel =
                            model.planSelectionModel
                    in
                    { currentModel
                        | selectedPlan = Just planType
                        , loadedFromSession = True
                    }

                -- Update the model with the plan type
                updatedModel =
                    { model
                        | planSelectionModel = updatedPlanSelectionModel
                        , isBasicPlan = planType == "basic"
                    }

                -- Command to update the PlanSelection model with the received plan
                planSelectionCmd =
                    if model.step == PlanSelectionStep then
                        -- Pass the plan type to PlanSelection module
                        Cmd.map PlanSelectionMsg (Task.perform (\_ -> PlanSelection.LoadPlanFromSession planType) (Task.succeed ()))

                    else
                        Cmd.none
            in
            ( updatedModel, planSelectionCmd )

        UserDetailsReceived maybeUserData ->
            case maybeUserData of
                Just userData ->
                    ( model
                    , Cmd.map UserDetailsMsg (Task.perform (\_ -> UserDetails.loadUserFromSession userData) (Task.succeed ()))
                    )

                -- don't remove the parens here
                Nothing ->
                    ( model, Cmd.none )

        RandomOrgNameGenerated orgName ->
            -- When we get a random org name, update both the org slug and the CompanyDetails model
            let
                oldCompanyDetailsModel =
                    model.companyDetailsModel

                updatedCompanyDetailsModel =
                    { oldCompanyDetailsModel | orgSlug = orgName }

                oldUserDetailsModel =
                    model.userDetailsModel

                updatedUserDetailsModel =
                    { oldUserDetailsModel | orgSlug = orgName }
            in
            ( { model
                | companyDetailsModel = updatedCompanyDetailsModel
                , userDetailsModel = updatedUserDetailsModel
                , orgSlug = orgName -- Update the orgSlug in the main model
              }
            , Cmd.none
            )

        GotUserDetails result ->
            case result of
                Ok userDetails ->
                    let
                        oldUserDetailsModel =
                            model.userDetailsModel

                        updatedUserDetailsModel =
                            { oldUserDetailsModel
                                | firstName = userDetails.firstName
                                , lastName = userDetails.lastName
                                , email = userDetails.email
                                , phone = userDetails.phone
                                , emailStatus = UserDetails.Available -- Consider email as valid since it's already registered
                            }
                    in
                    ( { model | userDetailsModel = updatedUserDetailsModel }, Cmd.none )

                Err error ->
                    ( { model | error = Just ("Failed to load user details: " ++ httpErrorToString error) }, Cmd.none )

        InitializeCurrentStep ->
            -- Initialize the current step based on the model's step field
            let
                ( cmd, updatedModel ) =
                    initializeStep model.step model
            in
            ( updatedModel, cmd )



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = getStepTitle model.step
    , body =
        [ div []
            [ if model.isLoading then
                -- Show loading spinner when loading
                div [ class "flex justify-center items-center h-screen" ]
                    [ div [ class "animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500" ] [] ]

              else
                div []
                    [ SetupLayout.view
                        (mapStepToSetupStep model.step)
                        model.isBasicPlan
                        (getStepNumber model.step)
                        [ div [ class "max-w-3xl mx-auto" ]
                            [ viewCurrentStep model
                            , viewNavigationControls model
                            ]
                        ]
                    ]
            ]
        ]
    }


viewCurrentStep : Model -> Html Msg
viewCurrentStep model =
    if model.step == PlanSelectionStep && not model.onboardingInProgress then
        -- On the first step, show the plan selection
        Html.map PlanSelectionMsg (PlanSelection.view model.planSelectionModel)

    else if model.step == PlanSelectionStep && model.onboardingInProgress then
        -- If we have an in-progress onboarding, show the resume view
        viewResumeOnboarding model

    else
        case model.step of
            PlanSelectionStep ->
                -- This case is handled above
                text ""

            UserDetailsStep ->
                Html.map UserDetailsMsg (UserDetails.view model.userDetailsModel)

            CompanyDetailsStep ->
                Html.map CompanyDetailsMsg (CompanyDetails.view model.companyDetailsModel)

            LicensingSettingsStep ->
                Html.map LicensingSettingsMsg (LicensingSettings.view model.licensingSettingsModel)

            AddAgentsStep ->
                if model.isBasicPlan then
                    div [ class "text-center p-8" ]
                        [ text "This step is not available for the basic plan. Please continue to payment."
                        , div [ class "mt-4" ]
                            [ button
                                [ class "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                , onClick (NavigateToStep PaymentStep)
                                ]
                                [ text "Continue to Payment" ]
                            ]
                        ]
                    -- don't add another bracket here

                else
                    case model.addAgentsModel of
                        Just aamodel ->
                            Html.map AddAgentsMsg (AddAgents.view aamodel)

                        Nothing ->
                            div [ class "text-center p-8" ]
                                [ text "Error: Add Agents model not initialized."
                                , button
                                    [ class "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    , onClick (NavigateToStep PaymentStep)
                                    ]
                                    [ text "Continue to Payment" ]
                                ]

            -- don't add another bracket here
            PaymentStep ->
                Html.map PaymentMsg (Payment.view model.paymentModel)

            EnterpriseFormStep ->
                case model.enterpriseFormModel of
                    Just enterpriseFormModel ->
                        Html.map EnterpriseFormMsg (EnterpriseForm.view enterpriseFormModel)

                    Nothing ->
                        div [ class "text-center p-8" ]
                            [ text "Error: Enterprise Form model not initialized." ]



-- Add navigation controls to every step


viewNavigationControls : Model -> Html Msg
viewNavigationControls model =
    div [ class "flex justify-between mt-8 border-t pt-4" ]
        [ if not (List.isEmpty model.stepHistory) then
            button
                [ class "px-4 py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50"
                , onClick NavigateBack
                ]
                [ text "Back" ]

          else
            div [] []

        -- Empty spacer
        , div [] [] -- Removed "Skip to X" link
        ]



-- UTILS


getStepTitle : Step -> String
getStepTitle step =
    case step of
        PlanSelectionStep ->
            "Choose Your Plan - Onboarding"

        UserDetailsStep ->
            "Personal Details - Onboarding"

        CompanyDetailsStep ->
            "Company Details - Onboarding"

        LicensingSettingsStep ->
            "Licensing & Carriers - Onboarding"

        AddAgentsStep ->
            "Add Team Members - Onboarding"

        PaymentStep ->
            "Payment - Onboarding"

        EnterpriseFormStep ->
            "Enterprise Form - Onboarding"


mapStepToSetupStep : Step -> SetupLayout.SetupStep
mapStepToSetupStep step =
    case step of
        PlanSelectionStep ->
            SetupLayout.PlanSelection

        UserDetailsStep ->
            SetupLayout.OrganizationSetup

        CompanyDetailsStep ->
            SetupLayout.OrganizationSetup

        LicensingSettingsStep ->
            SetupLayout.OrganizationSetup

        AddAgentsStep ->
            SetupLayout.AgentSetup

        PaymentStep ->
            SetupLayout.OrganizationSetup

        EnterpriseFormStep ->
            SetupLayout.OrganizationSetup



-- Define the Agent type locally


type alias Agent =
    { id : String
    , firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    }



-- Helper function to encode agent data


encodeAgent : Agent -> Encode.Value
encodeAgent agent =
    Encode.object
        [ ( "id", Encode.string agent.id )
        , ( "firstName", Encode.string agent.firstName )
        , ( "lastName", Encode.string agent.lastName )
        , ( "email", Encode.string agent.email )
        , ( "phone", Encode.string agent.phone )
        , ( "isAdmin", Encode.bool agent.isAdmin )
        , ( "isAgent", Encode.bool agent.isAgent )
        ]



-- Update agents list handling to convert AddAgents.Model.agents to our local Agent type


encodeOnboardingData : Model -> Encode.Value
encodeOnboardingData model =
    let
        selectedPlan =
            model.planSelectionModel.selectedPlan |> Maybe.withDefault "basic"

        extraAgents =
            model.planSelectionModel.extraAgents

        extraContacts =
            model.planSelectionModel.extraContacts

        -- User details
        firstName =
            model.userDetailsModel.firstName

        lastName =
            model.userDetailsModel.lastName

        email =
            model.userDetailsModel.email

        phone =
            model.userDetailsModel.phone

        -- Company details
        agencyName =
            model.companyDetailsModel.agencyName

        website =
            model.companyDetailsModel.website

        companyPhone =
            model.companyDetailsModel.phone

        primaryColor =
            model.companyDetailsModel.primaryColor

        secondaryColor =
            model.companyDetailsModel.secondaryColor

        logo =
            model.companyDetailsModel.logo

        -- Licensing settings
        carrierContracts =
            model.licensingSettingsModel.carrierContracts

        stateCarrierSettings =
            -- Create state carrier settings based on whether SmartSend for GI is enabled
            List.map
                (\carrier ->
                    { carrier = carrier
                    , active = True
                    , targetGI = model.licensingSettingsModel.useSmartSendForGI
                    }
                )
                carrierContracts

        -- Agents (if applicable)
        agents =
            case model.addAgentsModel of
                Just addAgentsModel ->
                    -- Use the agents from the model (already correct type)
                    Encode.list encodeAgent addAgentsModel.agents

                Nothing ->
                    Encode.list identity []
    in
    Encode.object
        [ ( "plan"
          , Encode.object
                [ ( "type", Encode.string selectedPlan )
                , ( "extraAgents", Encode.int extraAgents )
                , ( "extraContacts", Encode.int extraContacts )
                , ( "price", Encode.int (getPlanPrice selectedPlan) )
                , ( "billingCycle", Encode.string "monthly" )
                ]
          )
        , ( "user"
          , Encode.object
                [ ( "firstName", Encode.string firstName )
                , ( "lastName", Encode.string lastName )
                , ( "email", Encode.string email )
                , ( "phone", Encode.string phone )
                ]
          )
        , ( "company"
          , Encode.object
                [ ( "agencyName", Encode.string agencyName )
                , ( "website", Encode.string website )
                , ( "phone", Encode.string companyPhone )
                , ( "primaryColor", Encode.string primaryColor )
                , ( "secondaryColor", Encode.string secondaryColor )
                , ( "logo", Maybe.withDefault Encode.null (Maybe.map Encode.string logo) )
                ]
          )
        , ( "licensing"
          , Encode.object
                [ ( "carrierContracts", Encode.list Encode.string carrierContracts )
                , ( "useSmartSendForGI", Encode.bool model.licensingSettingsModel.useSmartSendForGI )
                ]
          )
        , ( "agents", agents )
        ]



-- Update the completeOnboarding function to submit all data at once


completeOnboarding : Model -> Cmd Msg
completeOnboarding model =
    case model.sessionToken of
        Just token ->
            Http.post
                { url = "/api/onboarding/complete"
                , body = Http.emptyBody
                , expect = Http.expectWhatever CompleteOnboarding
                }

        Nothing ->
            -- If we don't have a session token, something went wrong
            Cmd.none



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.batch
        [ Sub.map PlanSelectionMsg (PlanSelection.subscriptions model.planSelectionModel)
        , Sub.map UserDetailsMsg (UserDetails.subscriptions model.userDetailsModel)
        , Sub.map CompanyDetailsMsg (CompanyDetails.subscriptions model.companyDetailsModel)
        , Sub.map LicensingSettingsMsg (LicensingSettings.subscriptions model.licensingSettingsModel)
        , case model.addAgentsModel of
            Just addAgentsModel ->
                Sub.map AddAgentsMsg (AddAgents.subscriptions addAgentsModel)

            Nothing ->
                Sub.none
        , Sub.map PaymentMsg (Payment.subscriptions model.paymentModel)
        , case model.enterpriseFormModel of
            Just enterpriseFormModel ->
                Sub.map EnterpriseFormMsg (EnterpriseForm.subscriptions enterpriseFormModel)

            Nothing ->
                Sub.none
        , onboardingStateReceived OnboardingStateReceived
        , planTypeReceived PlanTypeReceived
        , userDetailsReceived UserDetailsReceived
        ]



-- Define StateCarrierSetting type locally


type alias StateCarrierSetting =
    { state : String
    , carrier : String
    , active : Bool
    , targetGI : Bool
    }



-- Encode StateCarrierSetting


encodeStateCarrierSetting : StateCarrierSetting -> Encode.Value
encodeStateCarrierSetting setting =
    Encode.object
        [ ( "state", Encode.string setting.state )
        , ( "carrier", Encode.string setting.carrier )
        , ( "active", Encode.bool setting.active )
        , ( "targetGI", Encode.bool setting.targetGI )
        ]



-- Helper function to get URL for a step (full URL instead of just fragment)


getStepFragment : Step -> String
getStepFragment step =
    "/onboarding/"
        ++ (case step of
                PlanSelectionStep ->
                    "plan"

                UserDetailsStep ->
                    "personal"

                CompanyDetailsStep ->
                    "company"

                LicensingSettingsStep ->
                    "licensing"

                AddAgentsStep ->
                    "agents"

                PaymentStep ->
                    "payment"

                EnterpriseFormStep ->
                    "enterprise"
           )



-- Helper function to get readable label for a step


getStepLabel : Step -> String
getStepLabel step =
    case step of
        PlanSelectionStep ->
            "Plan Selection"

        UserDetailsStep ->
            "Personal Details"

        CompanyDetailsStep ->
            "Company Details"

        LicensingSettingsStep ->
            "Licensing Settings"

        AddAgentsStep ->
            "Add Agents"

        PaymentStep ->
            "Payment"

        EnterpriseFormStep ->
            "Enterprise Form"



-- Helper function to convert the step to a number for progress tracking


getStepNumber : Step -> Int
getStepNumber step =
    case step of
        PlanSelectionStep ->
            0

        UserDetailsStep ->
            1

        CompanyDetailsStep ->
            2

        LicensingSettingsStep ->
            3

        AddAgentsStep ->
            4

        PaymentStep ->
            5

        EnterpriseFormStep ->
            6



-- Helper function to get the next step in sequence


getNextStep : Step -> Bool -> Step
getNextStep currentStep isBasicPlan =
    case currentStep of
        PlanSelectionStep ->
            UserDetailsStep

        UserDetailsStep ->
            CompanyDetailsStep

        CompanyDetailsStep ->
            LicensingSettingsStep

        LicensingSettingsStep ->
            if isBasicPlan then
                PaymentStep

            else
                AddAgentsStep

        AddAgentsStep ->
            PaymentStep

        PaymentStep ->
            PaymentStep

        -- No next step after payment
        EnterpriseFormStep ->
            EnterpriseFormStep



-- Can't proceed from enterprise form
-- Helper function to get plan price based on type


getPlanPrice : String -> Int
getPlanPrice planType =
    case planType of
        "basic" ->
            29

        "pro" ->
            99

        "enterprise" ->
            499

        _ ->
            29



-- Default to basic price
-- HTTP functions for progressive onboarding


initializeOnboarding : String -> String -> String -> Cmd Msg
initializeOnboarding planType email orgSlug =
    let
        url =
            "/api/onboarding/initialize"

        body =
            Encode.object
                [ ( "planType", Encode.string planType )
                , ( "email", Encode.string email )
                , ( "organizationName", Encode.string orgSlug )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map5
                (\organizationId slug sessionToken onboardingStep planTypeValue ->
                    { organizationId = organizationId
                    , slug = slug
                    , sessionToken = sessionToken
                    , onboardingStep = onboardingStep
                    , planType = planTypeValue
                    }
                )
                (Decode.field "organizationId" Decode.int)
                (Decode.field "slug" Decode.string)
                (Decode.field "sessionToken" Decode.string)
                (Decode.field "onboardingStep" Decode.int)
                (Decode.field "planType" (Decode.oneOf [ Decode.string, Decode.null "basic" ]))
    in
    Http.post
        { url = url
        , body = body
        , expect = Http.expectJson OnboardingInitialized decoder
        }


resumeOnboarding : String -> Cmd Msg
resumeOnboarding email =
    let
        url =
            "/api/onboarding/resume-onboarding"

        body =
            Encode.object
                [ ( "email", Encode.string email )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map5
                (\organizationId slug sessionToken onboardingStep planTypeValue ->
                    { organizationId = organizationId
                    , slug = slug
                    , sessionToken = sessionToken
                    , onboardingStep = onboardingStep
                    , planType = planTypeValue
                    }
                )
                (Decode.field "organizationId" Decode.int)
                (Decode.field "slug" Decode.string)
                (Decode.field "sessionToken" Decode.string)
                (Decode.field "onboardingStep" Decode.int)
                (Decode.field "planType" (Decode.oneOf [ Decode.string, Decode.null "basic" ]))
    in
    Http.post
        { url = url
        , body = body
        , expect = Http.expectJson OnboardingInitialized decoder
        }


updateUserDetails : String -> String -> UserDetails.Model -> Cmd Msg
updateUserDetails orgSlug sessionToken model =
    let
        url =
            "/api/onboarding/user-details"

        -- Ensure phone number only contains digits
        phoneDigits =
            String.filter Char.isDigit model.phone

        body =
            Encode.object
                [ ( "firstName", Encode.string model.firstName )
                , ( "lastName", Encode.string model.lastName )
                , ( "email", Encode.string model.email )
                , ( "phone", Encode.string phoneDigits )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map
                (\onboardingStep ->
                    { onboardingStep = onboardingStep }
                )
                (Decode.field "onboardingStep" Decode.int)
    in
    Http.request
        { method = "POST"
        , url = url
        , body = body
        , expect = Http.expectJson UserUpdated decoder
        , headers = [] -- The session token is in the cookies, no need to pass it
        , timeout = Nothing
        , tracker = Nothing
        }


updateCompanyDetails : String -> String -> CompanyDetails.Model -> Cmd Msg
updateCompanyDetails orgSlug sessionToken model =
    let
        url =
            "/api/onboarding/company-details"

        body =
            Encode.object
                [ ( "agencyName", Encode.string model.agencyName )
                , ( "website", Encode.string model.website )
                , ( "phone", Encode.string model.phone )
                , ( "primaryColor", Encode.string model.primaryColor )
                , ( "secondaryColor", Encode.string model.secondaryColor )
                , ( "logo", Maybe.map Encode.string model.logo |> Maybe.withDefault Encode.null )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map
                (\onboardingStep ->
                    { onboardingStep = onboardingStep }
                )
                (Decode.field "onboardingStep" Decode.int)
    in
    Http.request
        { method = "POST"
        , url = url
        , body = body
        , expect = Http.expectJson CompanyUpdated decoder
        , headers = [] -- The session token is in the cookies, no need to pass it
        , timeout = Nothing
        , tracker = Nothing
        }


updateLicensingDetails : String -> String -> LicensingSettings.Model -> Cmd Msg
updateLicensingDetails orgSlug sessionToken model =
    let
        url =
            "/api/onboarding/licensing-settings"

        body =
            Encode.object
                [ ( "carrierContracts", Encode.list Encode.string model.carrierContracts )
                , ( "useSmartSendForGI", Encode.bool model.useSmartSendForGI )
                ]
                |> Http.jsonBody

        decoder =
            Decode.map3
                (\onboardingStep nextStep isBasicPlan ->
                    { onboardingStep = onboardingStep
                    , nextStep = nextStep
                    , isBasicPlan = isBasicPlan
                    }
                )
                (Decode.field "onboardingStep" Decode.int)
                (Decode.field "nextStep" Decode.int)
                (Decode.field "isBasicPlan" Decode.bool)
    in
    Http.request
        { method = "POST"
        , url = url
        , body = body
        , expect = Http.expectJson LicensingUpdated decoder
        , headers =
            if String.isEmpty sessionToken then
                []

            else
                [ Http.header "x-onboarding-session" sessionToken ]
        , timeout = Nothing
        , tracker = Nothing
        }


addTeamMembers : String -> String -> AddAgents.Model -> Cmd Msg
addTeamMembers orgSlug sessionToken model =
    let
        url =
            "/api/onboarding/agents"

        encodeTeamMember agent =
            Encode.object
                [ ( "firstName", Encode.string agent.firstName )
                , ( "lastName", Encode.string agent.lastName )
                , ( "email", Encode.string agent.email )
                , ( "phone", Encode.string agent.phone )
                , ( "isAdmin", Encode.bool agent.isAdmin )
                , ( "isAgent", Encode.bool agent.isAgent )
                ]

        body =
            Encode.object
                [ ( "agents", Encode.list encodeTeamMember model.agents )
                ]
                |> Http.jsonBody

        headers =
            [ Http.header "x-onboarding-session" sessionToken ]

        decoder =
            Decode.map
                (\onboardingStep ->
                    { onboardingStep = onboardingStep }
                )
                (Decode.field "onboardingStep" Decode.int)
    in
    Http.request
        { method = "POST"
        , url = url
        , body = body
        , expect = Http.expectJson TeamMembersAdded decoder
        , headers = headers
        , timeout = Nothing
        , tracker = Nothing
        }


completeSubscription : String -> String -> String -> Int -> Int -> Cmd Msg
completeSubscription orgSlug sessionToken selectedPlan extraAgents extraContacts =
    let
        url =
            "/api/onboarding/" ++ orgSlug ++ "/complete"

        body =
            Encode.object
                [ ( "planType", Encode.string selectedPlan )
                , ( "extraAgents", Encode.int extraAgents )
                , ( "extraContacts", Encode.int extraContacts )
                ]
                |> Http.jsonBody

        headers =
            [ Http.header "Authorization" ("Bearer " ++ sessionToken) ]

        decoder =
            Decode.map2
                (\clientSecret publishableKey ->
                    { clientSecret = clientSecret
                    , publishableKey = publishableKey
                    }
                )
                (Decode.field "clientSecret" Decode.string)
                (Decode.field "publishableKey" Decode.string)
    in
    Http.request
        { method = "POST"
        , url = url
        , body = body
        , expect = Http.expectJson SubscriptionCompleted decoder
        , headers = headers
        , timeout = Nothing
        , tracker = Nothing
        }



-- Add a function to handle the email input for resuming onboarding


viewResumeOnboarding : Model -> Html Msg
viewResumeOnboarding model =
    let
        emailValue =
            model.userDetailsModel.email
    in
    div [ class "max-w-md mx-auto mt-10 p-6 bg-white rounded-lg shadow-md" ]
        [ h2 [ class "text-2xl font-bold mb-6 text-center" ] [ text "Resume Your Onboarding" ]
        , p [ class "mb-6 text-gray-600" ]
            [ text "It looks like you've already started the onboarding process. Enter your email to continue where you left off." ]
        , div [ class "mb-4" ]
            [ label [ class "block text-gray-700 text-sm font-bold mb-2", for "email" ] [ text "Email" ]
            , input
                [ class "shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                , id "email"
                , type_ "email"
                , placeholder "your.email@example.com"
                , value emailValue
                , onInput (\email -> ResumeOnboarding email)
                ]
                []
            ]
        , div [ class "flex items-center justify-between" ]
            [ button
                [ class "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                , onClick (ResumeOnboarding emailValue)
                ]
                [ text "Resume Onboarding" ]
            , button
                [ class "bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                , onClick (NavigateToStep PlanSelectionStep)
                ]
                [ text "Start New" ]
            ]
        ]



-- Add this function near the other HTTP functions


fetchUserDetails : String -> String -> Cmd Msg
fetchUserDetails _ _ =
    let
        url =
            "/api/onboarding/user-details"

        decoder =
            Decode.map4
                (\firstName lastName email phone ->
                    { firstName = firstName
                    , lastName = lastName
                    , email = email
                    , phone = phone
                    }
                )
                (Decode.field "firstName" Decode.string)
                (Decode.field "lastName" Decode.string)
                (Decode.field "email" Decode.string)
                (Decode.field "phone" Decode.string)
    in
    Http.request
        { method = "GET"
        , url = url
        , body = Http.emptyBody
        , expect = Http.expectJson GotUserDetails decoder
        , headers = [] -- The session token is in the cookies, no need to pass it
        , timeout = Nothing
        , tracker = Nothing
        }



-- Helper function to convert Http.Error to a readable string


httpErrorToString : Http.Error -> String
httpErrorToString error =
    case error of
        Http.BadUrl url ->
            "Bad URL: " ++ url

        Http.Timeout ->
            "Request timed out"

        Http.NetworkError ->
            "Network error"

        Http.BadStatus statusCode ->
            "Bad status: " ++ String.fromInt statusCode

        Http.BadBody message ->
            "Bad body: " ++ message



-- Helper function to initialize a specific step


initializeStep : Step -> Model -> ( Cmd Msg, Model )
initializeStep step model =
    case step of
        PlanSelectionStep ->
            -- Plan selection is always initialized in init, so just return the model
            ( Cmd.none, model )

        UserDetailsStep ->
            -- Always fetch user details from backend when navigating to this step
            let
                fetchCmd =
                    case model.sessionToken of
                        Just token ->
                            -- If we have a session token, fetch user details from backend
                            fetchUserDetails model.orgSlug token

                        Nothing ->
                            -- Otherwise, just initialize the model
                            Cmd.map UserDetailsMsg (UserDetails.fetchUserDetails model.orgSlug)
            in
            ( fetchCmd, { model | userDetailsInitialized = True } )

        CompanyDetailsStep ->
            -- Always initialize company details from backend when navigating to this step
            let
                ( newModel, subCmd ) =
                    case model.sessionToken of
                        Just token ->
                            CompanyDetails.init model.key model.orgSlug token

                        Nothing ->
                            CompanyDetails.init model.key model.orgSlug model.session

                -- Preserve existing company details if they exist
                modelWithDetails =
                    { newModel
                        | agencyName = model.companyDetailsModel.agencyName
                        , website = model.companyDetailsModel.website
                        , phone = model.companyDetailsModel.phone
                        , primaryColor = model.companyDetailsModel.primaryColor
                        , secondaryColor = model.companyDetailsModel.secondaryColor
                        , logo = model.companyDetailsModel.logo
                    }
            in
            ( Cmd.map CompanyDetailsMsg subCmd
            , { model | companyDetailsModel = modelWithDetails, companyDetailsInitialized = True }
            )

        LicensingSettingsStep ->
            -- Always initialize licensing settings from backend when navigating to this step
            let
                ( newModel, subCmd ) =
                    LicensingSettings.init model.key model.orgSlug
            in
            ( Cmd.map LicensingSettingsMsg subCmd
            , { model | licensingSettingsModel = newModel, licensingSettingsInitialized = True }
            )

        AddAgentsStep ->
            -- Always initialize add agents from backend when navigating to this step
            let
                ( newModel, subCmd ) =
                    AddAgents.init model.key model.orgSlug True
            in
            ( Cmd.map AddAgentsMsg subCmd
            , { model | addAgentsModel = Just newModel, addAgentsInitialized = True }
            )

        PaymentStep ->
            -- Always initialize payment from backend when navigating to this step
            let
                ( newModel, subCmd ) =
                    Payment.init model.key model.orgSlug
            in
            ( Cmd.map PaymentMsg subCmd
            , { model | paymentModel = newModel, paymentInitialized = True }
            )

        EnterpriseFormStep ->
            -- Always initialize enterprise form from backend when navigating to this step
            let
                ( newModel, subCmd ) =
                    EnterpriseForm.init model.key
            in
            ( Cmd.map EnterpriseFormMsg subCmd
            , { model | enterpriseFormModel = Just newModel, enterpriseFormInitialized = True }
            )

================
File: src/Utils/MyDate.elm
================
module Utils.MyDate exposing (dateFromMonthDayYear)

import Date exposing (Date)
import List.Extra


dateFromMonthDayYear : String -> Result String Date
dateFromMonthDayYear dateString =
    let
        monthDayYear =
            String.split "/" dateString

        has3 =
            List.length monthDayYear == 3

        year =
            List.Extra.last monthDayYear

        month =
            List.head monthDayYear

        day =
            List.tail monthDayYear
                |> Maybe.withDefault []
                |> List.head
    in
    if has3 then
        case ( year, month, day ) of
            ( Just y, Just m, Just d ) ->
                let
                    mm =
                        if String.length m == 1 then
                            "0" ++ m

                        else
                            m

                    dd =
                        if String.length d == 1 then
                            "0" ++ d

                        else
                            d
                in
                Date.fromIsoString (String.join "-" [ y, mm, dd ])

            _ ->
                Err "Invalid date format 1"

    else
        Err "Invalid date format 2"

================
File: src/Utils/QuoteHeader.elm
================
module Utils.QuoteHeader exposing (..)

import Html exposing (..)
import Html.Attributes exposing (..)


viewHeader : Maybe String -> Maybe String -> Html msg
viewHeader maybeImage maybeName =
    div [ class "flex justify-center items-center mt-4 mb-2" ]
        [ case ( maybeImage, maybeName ) of
            ( Just logo, _ ) ->
                img [ src logo, alt "Organization Logo", class "h-24 max-w-[400px] object-contain px-4" ] []

            ( _, Just name ) ->
                div [ class "text-2xl font-bold text-[#101828] leading-[1.2]" ] [ text name ]

            _ ->
                text ""
        ]

================
File: src/Utils/RandomOrgName.elm
================
module Utils.RandomOrgName exposing (generateOrgName)

import Random


chars : List Char
chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890"
        |> String.toList


generateOrgName : Random.Generator String
generateOrgName =
    Random.list 10 (Random.int 0 (List.length chars - 1))
        |> Random.map
            (\indices ->
                indices
                    |> List.map
                        (\i ->
                            chars
                                |> List.drop i
                                |> List.head
                                |> Maybe.withDefault ' '
                        )
                    |> String.fromList
            )

================
File: src/Accept.elm
================
module Accept exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onInput, onSubmit)
import Http
import Json.Decode as D
import Json.Encode as E
import Url.Parser.Query as Query


type alias Model =
    { name : String
    , email : String
    , isSubmitting : Bool
    , error : Maybe String
    , success : Bool
    , quoteId : Maybe String
    , key : Nav.Key
    }


type Msg
    = UpdateName String
    | UpdateEmail String
    | SubmitForm
    | GotSubmitResponse (Result Http.Error ())
    | GotContactInfo (Result Http.Error ContactInfo)


type alias ContactInfo =
    { email : String
    , firstName : String
    , lastName : String
    }


init : Nav.Key -> Maybe String -> ( Model, Cmd Msg )
init key maybeQuoteId =
    ( { name = ""
      , email = ""
      , isSubmitting = False
      , error = Nothing
      , success = False
      , quoteId = maybeQuoteId
      , key = key
      }
    , case maybeQuoteId of
        Just quoteId ->
            Http.get
                { url = "/api/quotes/decode/" ++ quoteId
                , expect = Http.expectJson GotContactInfo contactInfoDecoder
                }

        Nothing ->
            Cmd.none
    )


contactInfoDecoder : D.Decoder ContactInfo
contactInfoDecoder =
    D.field "contact"
        (D.map3 ContactInfo
            (D.field "email" D.string)
            (D.field "firstName" D.string)
            (D.field "lastName" D.string)
        )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateName name ->
            ( { model | name = name }, Cmd.none )

        UpdateEmail email ->
            ( { model | email = email }, Cmd.none )

        SubmitForm ->
            ( { model | isSubmitting = True }
            , Http.post
                { url = "/api/contact-request"
                , body = Http.jsonBody (encodeForm model)
                , expect = Http.expectWhatever GotSubmitResponse
                }
            )

        GotSubmitResponse result ->
            case result of
                Ok _ ->
                    ( { model | isSubmitting = False, success = True }, Cmd.none )

                Err _ ->
                    ( { model | isSubmitting = False, error = Just "Failed to submit form. Please try again." }, Cmd.none )

        GotContactInfo result ->
            case result of
                Ok info ->
                    ( { model
                        | email = info.email
                        , name = info.firstName ++ " " ++ info.lastName
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( model, Cmd.none )


encodeForm : Model -> E.Value
encodeForm model =
    E.object
        [ ( "name", E.string model.name )
        , ( "email", E.string model.email )
        , ( "type", E.string "accept" )
        , ( "quoteId", Maybe.map E.string model.quoteId |> Maybe.withDefault E.null )
        ]


view : Model -> Browser.Document Msg
view model =
    { title = "Good News! - Medicare Max"
    , body =
        [ div [ class "min-h-screen bg-white" ]
            [ nav [ class "bg-white border-b border-gray-200" ]
                [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" ]
                    [ div [ class "flex justify-between h-16 items-center" ]
                        [ div [ class "flex-shrink-0" ]
                            [ img [ src "/images/medicare-max-logo.png", class "h-8 w-auto", alt "Medicare Max" ] [] ]
                        ]
                    ]
                ]
            , div [ class "max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12" ]
                [ if model.success then
                    div [ class "text-center" ]
                        [ h1 [ class "text-3xl font-bold text-gray-900 mb-4" ]
                            [ text "Thank You" ]
                        , p [ class "text-gray-600" ]
                            [ text "We'll be in touch soon to schedule your follow-up." ]
                        ]

                  else
                    div []
                        [ h1 [ class "text-3xl font-bold text-center text-gray-900 mb-4" ]
                            [ text "Great News!" ]
                        , p [ class "text-gray-600 text-center mb-8" ]
                            [ text "Based on your answers, you look like a good candidate to switch plans. Let's schedule a follow-up to discuss your options." ]
                        , case model.error of
                            Just error ->
                                div [ class "bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" ]
                                    [ text error ]

                            Nothing ->
                                text ""
                        , Html.form [ onSubmit SubmitForm, class "space-y-6 max-w-lg mx-auto" ]
                            [ div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                    [ text "Name" ]
                                , input
                                    [ type_ "text"
                                    , class "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                    , value model.name
                                    , onInput UpdateName
                                    , required True
                                    ]
                                    []
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                    [ text "Email" ]
                                , input
                                    [ type_ "email"
                                    , class "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                    , value model.email
                                    , onInput UpdateEmail
                                    , required True
                                    ]
                                    []
                                ]
                            , button
                                [ class "w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 disabled:opacity-50"
                                , type_ "submit"
                                , disabled model.isSubmitting
                                ]
                                [ if model.isSubmitting then
                                    text "Submitting..."

                                  else
                                    text "Schedule Follow-up"
                                ]
                            ]
                        ]
                ]
            ]
        ]
    }


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/AddAgent.elm
================
module AddAgent exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Components.ProgressIndicator
import Components.SetupLayout as SetupLayout
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Parser exposing ((|.), (|=), Parser, chompIf, chompWhile, end, succeed, symbol)
import StateRegions exposing (Region(..), getRegionStates, regionToString)
import Svg exposing (path, svg)
import Svg.Attributes exposing (d, fill, stroke, strokeLinecap, strokeLinejoin, strokeWidth, viewBox)
import Time
import Url



-- Constants


allStates : List String
allStates =
    [ "AL"
    , "AK"
    , "AZ"
    , "AR"
    , "CA"
    , "CO"
    , "CT"
    , "DE"
    , "FL"
    , "GA"
    , "HI"
    , "ID"
    , "IL"
    , "IN"
    , "IA"
    , "KS"
    , "KY"
    , "LA"
    , "ME"
    , "MD"
    , "MA"
    , "MI"
    , "MN"
    , "MS"
    , "MO"
    , "MT"
    , "NE"
    , "NV"
    , "NH"
    , "NJ"
    , "NM"
    , "NY"
    , "NC"
    , "ND"
    , "OH"
    , "OK"
    , "OR"
    , "PA"
    , "RI"
    , "SC"
    , "SD"
    , "TN"
    , "TX"
    , "UT"
    , "VT"
    , "VA"
    , "WA"
    , "WV"
    , "WI"
    , "WY"
    , "DC"
    ]


allCarriers : List String
allCarriers =
    [ "Aetna"
    , "Humana"
    , "UnitedHealthcare"
    , "Cigna"
    , "Aflac"
    , "Allstate"
    , "Mutual of Omaha"
    , "Ace Chubb"
    ]


type alias Model =
    { email : String
    , firstName : String
    , lastName : String
    , rawPhone : String
    , displayPhone : String
    , isAdmin : Bool
    , isAgent : Bool
    , carriers : List String
    , stateLicenses : List String
    , error : Maybe String
    , isSetup : Bool
    , key : Nav.Key
    , isLoading : Bool
    , agents : List Agent
    , showAddForm : Bool
    , currentUser : Maybe CurrentUser
    , isLoadingForAgent : Maybe String
    , orgSettings : Maybe Settings
    , pendingSave : Maybe String
    , planType : String
    , showDeleteConfirm : Maybe String
    , reassignAgentId : Maybe String
    , contacts : List ContactSummary
    , emailStatus : EmailStatus
    }


type alias User =
    { id : String
    , email : String
    , firstName : String
    , lastName : String
    , isAdmin : Bool
    , isAgent : Bool
    , phone : String
    }


type alias Agent =
    { id : String
    , firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    , carriers : List String
    , stateLicenses : List String
    , expanded : Bool
    }


type alias CurrentUser =
    { id : String
    , email : String
    , firstName : String
    , lastName : String
    , isAdmin : Bool
    , isAgent : Bool
    , phone : String
    }


type alias ContactSummary =
    { id : Int
    , agentId : Maybe String
    }


type EmailStatus
    = NotChecked
    | Checking
    | Valid
    | Invalid String


type Msg
    = NoOp
    | UpdateEmail String
    | UpdateFirstName String
    | UpdateLastName String
    | UpdatePhone String
    | ToggleAdmin String
    | ToggleAgent String
    | UpdateField String String
    | UpdateAdminCheckbox Bool
    | UpdateAgentCheckbox Bool
    | SaveAgent
    | AgentSaved (Result Http.Error ())
    | NavigateTo String
    | CloseModal
    | ShowModal
    | ToggleCarrier String Bool
    | ToggleState String Bool
    | SelectAllCarriers Bool
    | SelectAllStates Bool
    | DeleteAgent String
    | ConfirmDeleteAgent String (Maybe String)
    | CloseDeleteConfirmModal
    | AgentDeleted (Result Http.Error ())
    | FinishSetup
    | SelectCommonStates Region
    | LoadFromOrg
    | GotOrgSettings (Result Http.Error Settings)
    | AddAnotherAgent
    | CancelAddAgent
    | RemoveAgent String
    | FetchAgents
    | GotAgents (Result Http.Error (List Agent))
    | GotCurrentUser (Result Http.Error CurrentUserResponse)
    | ToggleAgentRole String String
    | UpdateAgentField String String String
    | ToggleAgentExpanded String
    | UpdateAgentCarrier String String Bool
    | UpdateAgentState String String Bool
    | SelectAllStatesForAgent String Bool
    | SelectCommonStatesForAgent String Region
    | LoadFromOrgForAgent String
    | GotOrgSettingsForAgent String (Result Http.Error Settings)
    | SelectAllCarriersForAgent String Bool
    | SaveAgentDetails String
    | AgentDetailsSaved String (Result Http.Error ())
    | DebounceSaveAgent String
    | EditAgent Agent
    | CheckAgentEmail
    | GotEmailResponse (Result Http.Error EmailResponse)


type alias CurrentUserResponse =
    { success : Bool
    , user : Maybe User
    }


type alias EmailResponse =
    { available : Bool
    , message : String
    }


init : Bool -> Nav.Key -> Maybe CurrentUser -> String -> ( Model, Cmd Msg )
init isSetup key currentUser planType =
    let
        initialAgents =
            case currentUser of
                Just user ->
                    -- Create an initial agent from the current user for setup mode
                    let
                        initialAgent =
                            { id = user.id
                            , firstName = user.firstName
                            , lastName = user.lastName
                            , email = user.email
                            , phone = user.phone
                            , isAdmin = user.isAdmin
                            , isAgent = user.isAgent -- Use actual agent status
                            , carriers = []
                            , stateLicenses = []
                            , expanded = False
                            }
                    in
                    if isSetup then
                        [ initialAgent ]

                    else
                        []

                Nothing ->
                    []
    in
    ( { email = ""
      , firstName = ""
      , lastName = ""
      , rawPhone = ""
      , displayPhone = ""
      , isAdmin = False
      , isAgent = True -- Default to agent role being checked
      , carriers = []
      , stateLicenses = []
      , error = Nothing
      , isSetup = isSetup
      , key = key
      , isLoading = True
      , agents = initialAgents
      , showAddForm = False
      , currentUser = currentUser
      , isLoadingForAgent = Nothing
      , orgSettings = Nothing
      , pendingSave = Nothing
      , planType = planType
      , showDeleteConfirm = Nothing
      , reassignAgentId = Nothing
      , contacts = []
      , emailStatus = NotChecked
      }
    , fetchAgents
    )


view : Model -> Browser.Document Msg
view model =
    { title =
        if model.isSetup then
            "Add Team Members"

        else
            "Manage Agents"
    , body =
        [ if model.isSetup then
            -- Show setup UI with sidebar
            SetupLayout.view SetupLayout.AgentSetup
                (model.planType == "basic")
                4
                -- Using 4 for AddAgent as it's typically the 5th step (0-indexed)
                [ div [ class "max-w-3xl mx-auto pb-24" ]
                    [ viewSetupHeader model
                    , viewAgentsList model
                    ]
                , viewBottomBar model
                ]

          else
            -- Show regular UI without sidebar
            div [ class "min-h-screen bg-gray-50 pb-24" ]
                [ div [ class "max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8" ]
                    [ viewNormalHeader
                    , div [ class "bg-white shadow rounded-lg p-6" ]
                        [ viewAgentsList model
                        ]
                    ]
                , text "" -- No bottom bar in regular mode
                ]
        , viewDeleteConfirmationModal model
        ]
    }


viewSetupHeader : Model -> Html Msg
viewSetupHeader model =
    div [ class "mb-8 flex justify-between items-center" ]
        [ div []
            [ h1 [ class "text-3xl font-bold text-gray-900" ]
                [ text "Add Your First Agent" ]
            , p [ class "mt-2 text-gray-600" ]
                [ text "Set up your first agent to get started" ]
            ]
        , if not model.showAddForm then
            button
                [ class "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                , onClick AddAnotherAgent
                ]
                [ span [ class "mr-2" ] [ text "+" ]
                , text "Add Agent"
                ]

          else
            text ""
        ]


viewNormalHeader : Html Msg
viewNormalHeader =
    div [ class "mb-8 flex justify-center items-center" ]
        [ h1 [ class "text-2xl font-semibold text-gray-900" ]
            [ text "Manage Agents" ]
        ]


viewBasicInfo : Model -> Html Msg
viewBasicInfo model =
    div [ class "space-y-4" ]
        [ div [ class "grid grid-cols-2 gap-4" ]
            [ div []
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "First Name" ]
                , input
                    ([ type_ "text"
                     , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                     , value
                        (if isAdminBecomingAgent model then
                            case model.currentUser of
                                Just user ->
                                    user.firstName

                                Nothing ->
                                    model.firstName

                         else
                            model.firstName
                        )
                     , placeholder "Enter first name"
                     ]
                        ++ (if isAdminBecomingAgent model then
                                [ disabled True ]

                            else
                                [ onInput UpdateFirstName ]
                           )
                    )
                    []
                ]
            , div []
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Last Name" ]
                , input
                    ([ type_ "text"
                     , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                     , value
                        (if isAdminBecomingAgent model then
                            case model.currentUser of
                                Just user ->
                                    user.lastName

                                Nothing ->
                                    model.lastName

                         else
                            model.lastName
                        )
                     , placeholder "Enter last name"
                     ]
                        ++ (if isAdminBecomingAgent model then
                                [ disabled True ]

                            else
                                [ onInput UpdateLastName ]
                           )
                    )
                    []
                ]
            ]
        , div [ class "grid grid-cols-2 gap-4" ]
            [ div []
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Email" ]
                , input
                    ([ type_ "email"
                     , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                     , value
                        (if isAdminBecomingAgent model then
                            Maybe.map .email model.currentUser |> Maybe.withDefault ""

                         else
                            model.email
                        )
                     , placeholder "name@example.com"
                     ]
                        ++ (if isAdminBecomingAgent model then
                                [ disabled True ]

                            else
                                [ onInput UpdateEmail, onBlur CheckAgentEmail ]
                           )
                    )
                    []
                , viewEmailStatus model.emailStatus
                ]
            , div []
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Phone" ]
                , input
                    [ type_ "tel"
                    , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                    , value model.displayPhone
                    , onInput UpdatePhone
                    , placeholder "(555) 555-5555"
                    ]
                    []
                ]
            ]
        , div [ class "mt-4" ]
            [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                [ text "Administrator Status" ]
            , div [ class "flex items-center space-x-6" ]
                [ label
                    [ class "inline-flex items-center" ]
                    [ input
                        [ type_ "checkbox"
                        , class "rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        , checked model.isAdmin
                        , onClick (UpdateAdminCheckbox (not model.isAdmin))
                        ]
                        []
                    , span [ class "ml-2 text-sm text-gray-700" ]
                        [ text "Admin" ]
                    ]
                ]
            ]
        ]


viewAgentsList : Model -> Html Msg
viewAgentsList model =
    div [ class "space-y-6" ]
        [ if model.error /= Nothing then
            div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" ]
                [ text (Maybe.withDefault "" model.error) ]

          else
            text ""
        , div [ class "grid grid-cols-1 gap-6" ]
            (List.map
                (\agent ->
                    let
                        isSelfUser =
                            case model.currentUser of
                                Just user ->
                                    user.id == agent.id

                                Nothing ->
                                    False
                    in
                    div [ class "bg-white shadow rounded-lg p-6" ]
                        [ div [ class "flex items-center justify-between" ]
                            [ div [ class "flex items-center" ]
                                [ div [ class "ml-4" ]
                                    [ div [ class "text-lg font-medium text-gray-900" ]
                                        [ text (agent.firstName ++ " " ++ agent.lastName) ]
                                    , div [ class "text-sm text-gray-500" ]
                                        [ text agent.email ]
                                    ]
                                ]
                            , div [ class "flex items-center space-x-4" ]
                                [ button
                                    [ class "text-blue-600 hover:text-blue-800 font-medium"
                                    , onClick (ToggleAgentExpanded agent.id)
                                    ]
                                    [ text "Edit" ]
                                , button
                                    [ class
                                        ("text-red-400 "
                                            ++ (if isSelfUser then
                                                    "opacity-50 cursor-not-allowed"

                                                else
                                                    "hover:text-red-500"
                                               )
                                        )
                                    , onClick (DeleteAgent agent.id)
                                    , disabled isSelfUser
                                    , title
                                        (if isSelfUser then
                                            "You cannot delete your own account"

                                         else
                                            "Delete"
                                        )
                                    ]
                                    [ text "Delete" ]
                                ]
                            ]
                        , if agent.expanded then
                            div [ class "border-t border-gray-200 mt-4 pt-4" ]
                                [ viewAgentDetails model agent ]

                          else
                            text ""
                        ]
                )
                model.agents
            )
        , div [ class "mt-8 bg-white shadow rounded-lg p-6" ]
            [ if model.showAddForm then
                div [ class "space-y-6" ]
                    [ div [ class "border-b border-gray-200 pb-4" ]
                        [ h2 [ class "text-lg font-medium text-gray-900" ]
                            [ text "Add New Agent" ]
                        , p [ class "mt-1 text-sm text-gray-500" ]
                            [ text "Fill in the agent's information below" ]
                        ]
                    , viewBasicInfo model
                    , div [ class "flex justify-end space-x-4 mt-6" ]
                        [ button
                            [ class "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                            , onClick CancelAddAgent
                            ]
                            [ text "Cancel" ]
                        , button
                            [ class "px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                            , onClick SaveAgent
                            , disabled (not (isFormValid model))
                            ]
                            [ text "Add Agent" ]
                        ]
                    ]

              else
                div [ class "flex justify-between items-center" ]
                    [ div []
                        [ h3 [ class "text-lg font-medium text-gray-900" ]
                            [ text "Add New Agent" ]
                        , p [ class "text-sm text-gray-500" ]
                            [ text "Add a team member to your organization" ]
                        ]
                    , button
                        [ class "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
                        , onClick AddAnotherAgent
                        ]
                        [ span [ class "mr-2" ] [ text "+" ]
                        , text "Add Agent"
                        ]
                    ]
            ]
        ]


viewAgentDetails : Model -> Agent -> Html Msg
viewAgentDetails model agent =
    let
        orgCarriers =
            model.orgSettings
                |> Maybe.map .carrierContracts
                |> Maybe.withDefault []

        orgStates =
            model.orgSettings
                |> Maybe.map .stateLicenses
                |> Maybe.withDefault []

        fieldError field =
            case field of
                "phone" ->
                    String.isEmpty agent.phone

                "firstName" ->
                    String.isEmpty agent.firstName

                "lastName" ->
                    String.isEmpty agent.lastName

                "email" ->
                    String.isEmpty agent.email

                _ ->
                    False

        errorIndicator field =
            if fieldError field then
                span [ class "text-red-500 ml-1" ] [ text "*" ]

            else
                text ""

        isCurrentUserAgent =
            case model.currentUser of
                Just user ->
                    user.id == agent.id

                Nothing ->
                    False

        formattedPhone =
            formatPhoneNumber (String.filter Char.isDigit agent.phone)

        isLoading =
            model.isLoadingForAgent == Just agent.id

        canEdit =
            canModifySettings model agent.id

        -- Allow current user to edit their own details
        canEditField =
            isCurrentUserAgent || canEdit

        hasChanges =
            model.pendingSave == Just agent.id

        isSaving =
            model.isLoadingForAgent == Just agent.id

        onFieldInput : String -> String -> Msg
        onFieldInput field value =
            UpdateAgentField agent.id field value

        onSelectAllCarriers : Bool -> Msg
        onSelectAllCarriers isSelected =
            SelectAllCarriersForAgent agent.id isSelected
    in
    div [ class "space-y-6" ]
        [ div [ class "space-y-4" ]
            [ div [ class "grid grid-cols-2 gap-4" ]
                [ div []
                    [ label [ class "block text-sm font-medium text-gray-700" ]
                        [ text "First Name"
                        , errorIndicator "firstName"
                        ]
                    , input
                        [ type_ "text"
                        , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                        , value agent.firstName
                        , onInput (onFieldInput "firstName")
                        , disabled (not canEditField)
                        ]
                        []
                    ]
                , div []
                    [ label [ class "block text-sm font-medium text-gray-700" ]
                        [ text "Last Name"
                        , errorIndicator "lastName"
                        ]
                    , input
                        [ type_ "text"
                        , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                        , value agent.lastName
                        , onInput (onFieldInput "lastName")
                        , disabled (not canEditField)
                        ]
                        []
                    ]
                ]
            , div [ class "grid grid-cols-2 gap-4" ]
                [ div []
                    [ label [ class "block text-sm font-medium text-gray-700" ]
                        [ text "Email"
                        , errorIndicator "email"
                        ]
                    , input
                        [ type_ "email"
                        , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
                        , value agent.email
                        , onInput (onFieldInput "email")
                        , disabled (not canEditField)
                        ]
                        []
                    ]
                , div []
                    [ label [ class "block text-sm font-medium text-gray-700" ]
                        [ text "Phone"
                        , errorIndicator "phone"
                        ]
                    , input
                        [ type_ "tel"
                        , class "mt-1 px-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        , value formattedPhone
                        , onInput (onFieldInput "phone")
                        , placeholder "(555) 555-5555"
                        , disabled (not canEditField)
                        ]
                        []
                    ]
                ]
            ]
        , div [ class "mt-4" ]
            [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                [ text "Administrator Status" ]
            , div [ class "flex items-center space-x-6" ]
                [ label
                    [ class "inline-flex items-center"
                    , classList [ ( "opacity-60", isCurrentUserAgent && agent.isAdmin ) ]
                    ]
                    [ input
                        [ type_ "checkbox"
                        , class "rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        , checked agent.isAdmin
                        , onClick (ToggleAgentRole agent.id "admin")
                        , disabled ((isCurrentUserAgent && agent.isAdmin) || not canEdit)
                        , title
                            (if isCurrentUserAgent && agent.isAdmin then
                                "You cannot remove your admin role"

                             else
                                ""
                            )
                        ]
                        []
                    , span [ class "ml-2 text-sm text-gray-700" ]
                        [ text "Admin" ]
                    ]
                ]
            ]
        , div [ class "mt-6" ]
            [ p [ class "text-sm text-gray-500" ]
                [ text "This agent will automatically use the carriers and state licenses from your organization settings." ]
            ]
        , if hasChanges then
            div [ class "mt-4 flex justify-end" ]
                [ button
                    [ class "px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    , onClick (SaveAgentDetails agent.id)
                    , disabled isSaving
                    ]
                    [ if isSaving then
                        text "Saving..."

                      else
                        text "Save Changes"
                    ]
                ]

          else
            text ""
        ]


viewAddAgentButton : Html Msg
viewAddAgentButton =
    div [ class "text-center mt-8" ]
        [ button
            [ class "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
            , onClick AddAnotherAgent
            ]
            [ span [ class "mr-2" ] [ text "+" ]
            , text "Add Agent"
            ]
        ]


viewBottomBar : Model -> Html Msg
viewBottomBar model =
    let
        allAgentsValid =
            List.all
                (\agent ->
                    not (String.isEmpty agent.phone)
                        && not (String.isEmpty agent.firstName)
                        && not (String.isEmpty agent.lastName)
                        && not (String.isEmpty agent.email)
                        && (agent.isAdmin || agent.isAgent)
                )
                model.agents

        canAdd =
            not (String.isEmpty (String.trim model.firstName))
                && not (String.isEmpty (String.trim model.lastName))
                && model.emailStatus
                == Valid
                && isValidPhone model.displayPhone
                && (model.isAdmin || model.isAgent)
    in
    div [ class "fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-4 sm:px-6 z-10" ]
        [ div [ class "max-w-3xl mx-auto" ]
            [ if model.error /= Nothing then
                div [ class "mb-4" ]
                    [ p [ class "text-red-600" ]
                        [ text (Maybe.withDefault "" model.error) ]
                    ]

              else
                text ""
            , if model.isSetup then
                div [ class "flex justify-center" ]
                    [ button
                        [ class "px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                        , onClick FinishSetup
                        , disabled (not allAgentsValid || List.isEmpty model.agents)
                        ]
                        [ text "Continue to Dashboard" ]
                    ]

              else
                text ""
            ]
        ]


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )

        UpdateEmail email ->
            ( { model | email = email, emailStatus = NotChecked }, Cmd.none )

        UpdateFirstName name ->
            ( { model | firstName = name }, Cmd.none )

        UpdateLastName name ->
            ( { model | lastName = name }, Cmd.none )

        UpdatePhone input ->
            let
                rawDigits =
                    String.filter Char.isDigit input
                        |> String.left 10

                formattedPhone =
                    formatPhoneNumber rawDigits
            in
            ( { model
                | rawPhone = rawDigits
                , displayPhone = formattedPhone
                , pendingSave = Just "main" -- Add pending save for main agent
              }
            , Cmd.none
            )

        ToggleAdmin agentId ->
            let
                updatedAgents =
                    List.map
                        (\agent ->
                            if agent.id == agentId then
                                { agent | isAdmin = not agent.isAdmin }

                            else
                                agent
                        )
                        model.agents
            in
            ( { model | agents = updatedAgents }
            , case List.head (List.filter (\a -> a.id == agentId) updatedAgents) of
                Just agent ->
                    saveAgentDetails agent

                Nothing ->
                    Cmd.none
            )

        ToggleAgent agentId ->
            let
                updatedAgents =
                    List.map
                        (\agent ->
                            if agent.id == agentId then
                                { agent | isAgent = not agent.isAgent }

                            else
                                agent
                        )
                        model.agents
            in
            ( { model | agents = updatedAgents }
            , case List.head (List.filter (\a -> a.id == agentId) updatedAgents) of
                Just agent ->
                    saveAgentDetails agent

                Nothing ->
                    Cmd.none
            )

        UpdateField field value ->
            case model.currentUser of
                Just user ->
                    let
                        updatedUser =
                            case field of
                                "firstName" ->
                                    { user | firstName = value }

                                "lastName" ->
                                    { user | lastName = value }

                                "phone" ->
                                    { user | phone = String.filter Char.isDigit value }

                                _ ->
                                    user
                    in
                    ( { model | currentUser = Just updatedUser }
                    , Cmd.none
                    )

                Nothing ->
                    ( model, Cmd.none )

        SaveAgent ->
            if isFormValid model then
                ( { model | isLoading = True }
                , submitNewAgent model
                )

            else
                ( { model | error = Just "Please fill out all fields, ensure email is valid, and select at least one role (admin or agent)" }
                , Cmd.none
                )

        AgentSaved (Ok ()) ->
            if model.isSetup then
                ( { model
                    | showAddForm = False
                    , isAdmin = False
                    , firstName = ""
                    , lastName = ""
                    , email = ""
                    , rawPhone = ""
                    , displayPhone = ""
                    , carriers = []
                    , stateLicenses = []
                  }
                , Cmd.batch
                    [ fetchAgents -- Refresh the agents list
                    , fetchCurrentUser -- Refresh current user to get updated role
                    ]
                )

            else
                ( { model | error = Nothing }
                , Nav.pushUrl model.key "/add-agents"
                )

        AgentSaved (Err _) ->
            ( { model | error = Just "Failed to save agent" }
            , Cmd.none
            )

        ToggleAgentRole agentId role ->
            let
                isSelfUser agId =
                    case model.currentUser of
                        Just user ->
                            user.id == agId

                        Nothing ->
                            False

                updateAgent agent =
                    { agent | isAgent = True }

                -- hardcodding everyone as agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        CheckAgentEmail ->
            if String.isEmpty (String.trim model.email) then
                ( { model | emailStatus = NotChecked }
                , Cmd.none
                )

            else if model.emailStatus == Checking then
                ( model, Cmd.none )

            else
                ( { model | emailStatus = Checking }
                , checkAgentEmail model.email
                )

        FinishSetup ->
            ( model
            , Nav.pushUrl model.key "/dashboard"
            )

        LoadFromOrg ->
            ( { model | isLoading = True }
            , Http.get
                { url = "/api/settings"
                , expect = Http.expectJson GotOrgSettings (Decode.field "orgSettings" settingsObjectDecoder)
                }
            )

        GotOrgSettings (Ok settings) ->
            ( { model
                | carriers = settings.carrierContracts
                , stateLicenses = settings.stateLicenses
                , isLoading = False
                , orgSettings = Just settings
              }
            , Cmd.none
            )

        GotOrgSettings (Err _) ->
            ( { model
                | error = Just "Failed to load organization settings"
                , isLoading = False
              }
            , Cmd.none
            )

        AddAnotherAgent ->
            ( { model
                | showAddForm = True
                , firstName = ""
                , lastName = ""
                , email = ""
                , rawPhone = ""
                , displayPhone = ""
                , carriers = []
                , stateLicenses = []
                , isAdmin = False
                , isAgent = True
              }
            , Cmd.none
            )

        CancelAddAgent ->
            ( { model | showAddForm = False }, Cmd.none )

        RemoveAgent id ->
            ( { model | agents = List.filter (\agent -> agent.id /= id) model.agents }, Cmd.none )

        FetchAgents ->
            ( model, fetchAgents )

        GotAgents result ->
            case result of
                Ok agents ->
                    let
                        finalAgents =
                            if model.isSetup then
                                -- In setup mode, make sure we have at least the current user as an agent
                                case model.currentUser of
                                    Just user ->
                                        -- Check if the current user is already in the agents list
                                        if List.any (\a -> a.id == user.id) agents then
                                            -- Current user is already in the list, use the API result
                                            agents

                                        else
                                            -- Add the current user to the agents list
                                            { id = user.id
                                            , firstName = user.firstName
                                            , lastName = user.lastName
                                            , email = user.email
                                            , phone = user.phone
                                            , isAdmin = user.isAdmin
                                            , isAgent = user.isAgent -- Use actual agent status from user
                                            , carriers = []
                                            , stateLicenses = []
                                            , expanded = False
                                            }
                                                :: agents

                                    Nothing ->
                                        agents

                            else
                                -- In normal mode, use the API result
                                agents
                    in
                    ( { model | agents = finalAgents }, Cmd.none )

                Err error ->
                    case error of
                        Http.BadStatus 403 ->
                            -- For 403, keep the current user in the agents list
                            -- Don't show an error since this is expected for non-admin users
                            ( model, Cmd.none )

                        _ ->
                            let
                                errorMessage =
                                    case error of
                                        Http.BadUrl url ->
                                            "Invalid URL: " ++ url

                                        Http.Timeout ->
                                            "Request timed out"

                                        Http.NetworkError ->
                                            "Network error occurred"

                                        Http.BadStatus status ->
                                            "Server error: " ++ String.fromInt status

                                        Http.BadBody message ->
                                            "Data error: " ++ message
                            in
                            ( { model | error = Just errorMessage }, Cmd.none )

        GotCurrentUser result ->
            case result of
                Ok response ->
                    case response.user of
                        Just user ->
                            let
                                -- Create agent from current user
                                initialAgent =
                                    { id = user.id
                                    , firstName = user.firstName
                                    , lastName = user.lastName
                                    , email = user.email
                                    , phone = user.phone
                                    , isAdmin = user.isAdmin
                                    , isAgent = user.isAgent -- Use actual agent status
                                    , carriers = []
                                    , stateLicenses = []
                                    , expanded = False
                                    }

                                -- Include the current user in agents list for setup mode
                                updatedAgents =
                                    if model.isSetup then
                                        -- In setup mode, always have current user as the first agent
                                        if List.any (\a -> a.id == user.id) model.agents then
                                            -- If current user is already in the list, keep existing agents
                                            model.agents

                                        else
                                            -- Add current user to the list
                                            initialAgent :: model.agents

                                    else
                                        -- In normal mode, keep the existing agents
                                        model.agents
                            in
                            ( { model
                                | currentUser = Just user
                                , agents = updatedAgents
                                , error = Nothing -- Clear any previous errors
                              }
                            , Cmd.none
                            )

                        Nothing ->
                            ( { model | currentUser = Nothing }, Cmd.none )

                Err _ ->
                    ( { model | error = Just "Failed to load current user" }
                    , Cmd.none
                    )

        ToggleAgentExpanded agentId ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent | expanded = not agent.expanded }

                    else
                        agent
            in
            ( { model | agents = List.map updateAgent model.agents }, Cmd.none )

        UpdateAgentCarrier agentId carrier isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | carriers =
                                if isSelected then
                                    agent.carriers ++ [ carrier ]

                                else
                                    List.filter ((/=) carrier) agent.carriers
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        UpdateAgentState agentId state isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | stateLicenses =
                                if isSelected then
                                    agent.stateLicenses ++ [ state ]

                                else
                                    List.filter ((/=) state) agent.stateLicenses
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        SelectAllStatesForAgent agentId isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | stateLicenses =
                                if isSelected then
                                    allStates

                                else
                                    []
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        SelectCommonStatesForAgent agentId region ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | stateLicenses = agent.stateLicenses ++ getRegionStates region
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        LoadFromOrgForAgent agentId ->
            ( { model | isLoadingForAgent = Just agentId }
            , Http.get
                { url = "/api/settings"
                , expect = Http.expectJson (GotOrgSettingsForAgent agentId) (Decode.field "orgSettings" settingsObjectDecoder)
                }
            )

        GotOrgSettingsForAgent agentId (Ok settings) ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | carriers = settings.carrierContracts
                            , stateLicenses = settings.stateLicenses
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , isLoadingForAgent = Nothing -- Clear the Loading state
              }
            , Cmd.none
            )

        GotOrgSettingsForAgent agentId (Err _) ->
            ( { model
                | error = Just "Failed to load organization settings"
                , isLoadingForAgent = Nothing -- Clear the Loading state
              }
            , Cmd.none
            )

        SelectAllCarriers isSelected ->
            ( { model
                | carriers =
                    if isSelected then
                        allCarriers

                    else
                        []
              }
            , Cmd.none
            )

        SelectAllStates isSelected ->
            ( { model
                | stateLicenses =
                    if isSelected then
                        allStates

                    else
                        []
              }
            , Cmd.none
            )

        DeleteAgent agentId ->
            ( { model | showDeleteConfirm = Just agentId, reassignAgentId = Nothing }, Cmd.none )

        ConfirmDeleteAgent agentId reassignToAgentId ->
            ( { model | showDeleteConfirm = Nothing, reassignAgentId = reassignToAgentId, isLoading = True }
            , deleteAgent agentId reassignToAgentId
            )

        CloseDeleteConfirmModal ->
            ( { model | showDeleteConfirm = Nothing, error = Nothing }, Cmd.none )

        SelectCommonStates region ->
            ( { model | stateLicenses = model.stateLicenses ++ getRegionStates region }
            , Cmd.none
            )

        NavigateTo path ->
            ( model, Nav.pushUrl model.key path )

        ShowModal ->
            ( { model | showAddForm = True }, Cmd.none )

        CloseModal ->
            ( { model | showAddForm = False }, Cmd.none )

        ToggleCarrier agentId isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | carriers =
                                if isSelected then
                                    agent.carriers ++ [ agentId ]

                                else
                                    List.filter ((/=) agentId) agent.carriers
                        }

                    else
                        agent
            in
            ( { model | agents = List.map updateAgent model.agents }
            , Cmd.none
            )

        ToggleState agentId isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | stateLicenses =
                                if isSelected then
                                    agent.stateLicenses ++ [ agentId ]

                                else
                                    List.filter ((/=) agentId) agent.stateLicenses
                        }

                    else
                        agent
            in
            ( { model | agents = List.map updateAgent model.agents }
            , Cmd.none
            )

        SelectAllCarriersForAgent agentId isSelected ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        { agent
                            | carriers =
                                if isSelected then
                                    allCarriers

                                else
                                    []
                        }

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )

        SaveAgentDetails agentId ->
            ( { model
                | pendingSave = Nothing
                , isLoadingForAgent = Just agentId
              }
            , case List.filter (\a -> a.id == agentId) model.agents of
                agent :: _ ->
                    saveAgentDetails agent

                [] ->
                    Cmd.none
            )

        AgentDetailsSaved agentId result ->
            case result of
                Ok _ ->
                    let
                        updateAgent agent =
                            if agent.id == agentId then
                                { agent | expanded = False }

                            else
                                agent
                    in
                    ( { model
                        | agents = List.map updateAgent model.agents
                        , isLoadingForAgent = Nothing
                        , error = Nothing
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to save agent details"
                        , isLoadingForAgent = Nothing
                      }
                    , Cmd.none
                    )

        AgentDeleted result ->
            case result of
                Ok _ ->
                    ( { model | isLoading = False, error = Nothing }
                    , fetchAgents
                    )

                Err _ ->
                    ( { model
                        | error = Just "Failed to delete agent"
                        , isLoading = False
                      }
                    , Cmd.none
                    )

        DebounceSaveAgent agentId ->
            if agentId == "main" then
                -- Handle main agent save
                case model.currentUser of
                    Just user ->
                        let
                            agent =
                                { id = user.id
                                , firstName = user.firstName
                                , lastName = user.lastName
                                , email = user.email
                                , phone = user.phone
                                , isAdmin = user.isAdmin
                                , isAgent = user.isAgent
                                , carriers = []
                                , stateLicenses = []
                                , expanded = False
                                }
                        in
                        ( { model | pendingSave = Nothing }
                        , saveAgentDetails agent
                        )

                    Nothing ->
                        ( model, Cmd.none )

            else
                -- Handle sub-agent save
                ( { model | pendingSave = Nothing }
                , case List.filter (\a -> a.id == agentId) model.agents of
                    agent :: _ ->
                        saveAgentDetails agent

                    [] ->
                        Cmd.none
                )

        EditAgent agent ->
            ( { model
                | agents =
                    List.map
                        (\a ->
                            if a.id == agent.id then
                                { a | expanded = not a.expanded }

                            else
                                a
                        )
                        model.agents
              }
            , Cmd.none
            )

        UpdateAdminCheckbox value ->
            ( { model | isAdmin = value, isAgent = True }, Cmd.none )

        UpdateAgentCheckbox value ->
            -- not using anymore
            let
                -- Ensure at least one role is selected
                newIsAdmin =
                    if not value then
                        True
                        -- If agent is being unchecked, ensure admin is checked

                    else
                        model.isAdmin
            in
            ( { model | isAgent = value, isAdmin = newIsAdmin }, Cmd.none )

        GotEmailResponse result ->
            case result of
                Ok response ->
                    ( { model
                        | emailStatus =
                            if response.available then
                                Valid

                            else
                                Invalid response.message
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model
                        | emailStatus = Invalid "Failed to check email availability"
                      }
                    , Cmd.none
                    )

        UpdateAgentField agentId field value ->
            let
                updateAgent agent =
                    if agent.id == agentId then
                        case field of
                            "firstName" ->
                                { agent | firstName = value }

                            "lastName" ->
                                { agent | lastName = value }

                            "phone" ->
                                { agent | phone = formatPhoneNumber (String.filter Char.isDigit value) }

                            _ ->
                                agent

                    else
                        agent
            in
            ( { model
                | agents = List.map updateAgent model.agents
                , pendingSave = Just agentId
              }
            , Cmd.none
            )



-- Helper functions


formatPhoneNumber : String -> String
formatPhoneNumber rawPhone =
    let
        digits =
            String.filter Char.isDigit rawPhone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "("
            ++ String.left 3 digits
            ++ ") "
            ++ String.slice 3 6 digits
            ++ "-"
            ++ String.dropLeft 6 digits


saveAgent : User -> Model -> Cmd Msg
saveAgent user model =
    let
        carriers =
            case model.orgSettings of
                Just settings ->
                    settings.carrierContracts

                Nothing ->
                    []

        stateLicenses =
            case model.orgSettings of
                Just settings ->
                    settings.stateLicenses

                Nothing ->
                    []

        agent =
            { id = user.id
            , firstName = user.firstName
            , lastName = user.lastName
            , email = user.email
            , phone = user.phone
            , isAdmin = user.isAdmin
            , isAgent = True -- always true
            , carriers = carriers
            , stateLicenses = stateLicenses
            , expanded = False
            }
    in
    Http.post
        { url = "/api/agents"
        , body = Http.jsonBody (encodeAgent agent)
        , expect = Http.expectWhatever AgentSaved
        }


settingsDecoder : Decoder SettingsResponse
settingsDecoder =
    Decode.map2 SettingsResponse
        (Decode.field "orgSettings" settingsObjectDecoder)
        (Decode.field "canEditOrgSettings" Decode.bool)


type alias SettingsResponse =
    { orgSettings : Settings
    , canEditOrgSettings : Bool
    }


type alias Settings =
    { stateLicenses : List String
    , carrierContracts : List String
    , stateCarrierSettings : List StateCarrierSetting
    , allowAgentSettings : Bool
    , emailSendBirthday : Bool
    , emailSendPolicyAnniversary : Bool
    , emailSendAep : Bool
    , smartSendEnabled : Bool
    }


type alias StateCarrierSetting =
    { state : String
    , carrier : String
    , active : Bool
    , targetGI : Bool
    }


settingsObjectDecoder : Decoder Settings
settingsObjectDecoder =
    Decode.map8 Settings
        (Decode.field "stateLicenses" (Decode.list Decode.string))
        (Decode.field "carrierContracts" (Decode.list Decode.string))
        (Decode.field "stateCarrierSettings" (Decode.list stateCarrierSettingDecoder))
        (Decode.field "allowAgentSettings" Decode.bool)
        (Decode.field "emailSendBirthday" Decode.bool)
        (Decode.field "emailSendPolicyAnniversary" Decode.bool)
        (Decode.field "emailSendAep" Decode.bool)
        (Decode.field "smartSendEnabled" Decode.bool)


stateCarrierSettingDecoder : Decoder StateCarrierSetting
stateCarrierSettingDecoder =
    Decode.map4 StateCarrierSetting
        (Decode.field "state" Decode.string)
        (Decode.field "carrier" Decode.string)
        (Decode.field "active" Decode.bool)
        (Decode.field "targetGI" Decode.bool)


subscriptions : Model -> Sub Msg
subscriptions model =
    case model.pendingSave of
        Just agentId ->
            Time.every 2000 (\_ -> DebounceSaveAgent agentId)

        Nothing ->
            Sub.none


isValidEmail : String -> Bool
isValidEmail email =
    let
        containsAtSign =
            String.contains "@" email

        containsDot =
            String.contains "." email

        hasValidLength =
            String.length email >= 5
    in
    containsAtSign && containsDot && hasValidLength


isValidPhone : String -> Bool
isValidPhone phone =
    let
        -- Remove all non-digit characters
        digits =
            String.filter Char.isDigit phone
    in
    String.length digits == 10


canSave : Model -> Bool
canSave model =
    let
        hasValidName =
            not (String.isEmpty (String.trim model.firstName))
                && not (String.isEmpty (String.trim model.lastName))

        hasValidEmail =
            isValidEmail model.email

        hasValidPhone =
            isValidPhone model.displayPhone

        hasValidRole =
            model.isAdmin || model.isAgent

        allAgentsValid =
            List.all
                (\agent ->
                    not (String.isEmpty agent.phone)
                        && not (String.isEmpty agent.firstName)
                        && not (String.isEmpty agent.lastName)
                        && not (String.isEmpty agent.email)
                        && (agent.isAdmin || agent.isAgent)
                )
                model.agents
    in
    if model.showAddForm then
        hasValidName && hasValidEmail && hasValidPhone && hasValidRole

    else
        allAgentsValid


fetchAgents : Cmd Msg
fetchAgents =
    Http.get
        { url = "/api/agents"
        , expect =
            Http.expectStringResponse GotAgents
                (\response ->
                    case response of
                        Http.BadUrl_ url ->
                            Err (Http.BadUrl url)

                        Http.Timeout_ ->
                            Err Http.Timeout

                        Http.NetworkError_ ->
                            Err Http.NetworkError

                        Http.BadStatus_ metadata body ->
                            Err (Http.BadStatus metadata.statusCode)

                        Http.GoodStatus_ metadata body ->
                            case Decode.decodeString (Decode.list agentDecoder) body of
                                Ok value ->
                                    Ok value

                                Err err ->
                                    Err (Http.BadBody (Decode.errorToString err))
                )
        }


agentDecoder : Decoder Agent
agentDecoder =
    Decode.succeed Agent
        |> Pipeline.required "id" Decode.string
        |> Pipeline.required "firstName" Decode.string
        |> Pipeline.required "lastName" Decode.string
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "phone" Decode.string
        |> Pipeline.required "isAdmin" Decode.bool
        |> Pipeline.required "isAgent" Decode.bool
        |> Pipeline.optional "carriers" (Decode.list Decode.string) []
        |> Pipeline.optional "stateLicenses" (Decode.list Decode.string) []
        |> Pipeline.hardcoded False


encodeAgent : Agent -> Encode.Value
encodeAgent agent =
    Encode.object
        [ ( "firstName", Encode.string agent.firstName )
        , ( "lastName", Encode.string agent.lastName )
        , ( "email", Encode.string agent.email )
        , ( "phone", Encode.string agent.phone )
        , ( "isAdmin", Encode.bool agent.isAdmin )
        , ( "isAgent", Encode.bool agent.isAgent )
        , ( "carriers", Encode.list Encode.string agent.carriers )
        , ( "stateLicenses", Encode.list Encode.string agent.stateLicenses )
        ]


isAdminBecomingAgent : Model -> Bool
isAdminBecomingAgent model =
    case model.currentUser of
        Just user ->
            model.isAdmin && user.isAdmin

        Nothing ->
            False


fetchCurrentUser : Cmd Msg
fetchCurrentUser =
    Http.get
        { url = "/api/me"
        , expect = Http.expectJson GotCurrentUser currentUserResponseDecoder
        }


currentUserResponseDecoder : Decoder CurrentUserResponse
currentUserResponseDecoder =
    Decode.map2 CurrentUserResponse
        (Decode.field "success" Decode.bool)
        (Decode.maybe (Decode.field "user" userDecoder))


userDecoder : Decoder User
userDecoder =
    let
        idDecoder =
            Decode.oneOf
                [ Decode.field "id" Decode.string
                , Decode.field "id" (Decode.map String.fromInt Decode.int)
                ]

        -- Add decoders that handle different boolean formats
        boolDecoder =
            Decode.oneOf
                [ Decode.bool
                , Decode.map (\n -> n == 1) Decode.int
                , Decode.map (\s -> s == "1" || s == "true") Decode.string
                ]
    in
    Decode.map7 User
        idDecoder
        (Decode.field "email" Decode.string)
        (Decode.field "firstName" Decode.string)
        (Decode.field "lastName" Decode.string)
        (Decode.field "is_admin" boolDecoder)
        (Decode.field "is_agent" boolDecoder)
        (Decode.oneOf
            [ Decode.field "phone" Decode.string
            , Decode.succeed ""
            ]
        )


saveAgentDetails : Agent -> Cmd Msg
saveAgentDetails agent =
    Http.request
        { method = "PUT"
        , headers = []
        , url = "/api/agents/" ++ agent.id
        , body = Http.jsonBody (encodeAgent agent)
        , expect = Http.expectWhatever (AgentDetailsSaved agent.id)
        , timeout = Nothing
        , tracker = Nothing
        }


isCurrentUser : Agent -> Model -> Bool
isCurrentUser agent model =
    case model.currentUser of
        Just user ->
            user.id == agent.id

        Nothing ->
            False


canModifySettings : Model -> String -> Bool
canModifySettings model agentId =
    case ( model.currentUser, model.orgSettings ) of
        ( Just user, Just settings ) ->
            -- Admin and admin_agent can always modify settings
            user.isAdmin

        _ ->
            False


deleteAgent : String -> Maybe String -> Cmd Msg
deleteAgent agentId maybeReassignToAgentId =
    let
        url =
            case maybeReassignToAgentId of
                Just reassignToAgentId ->
                    "/api/agents/" ++ agentId ++ "?reassignTo=" ++ reassignToAgentId

                Nothing ->
                    "/api/agents/" ++ agentId
    in
    Http.request
        { method = "DELETE"
        , headers = []
        , url = url
        , body = Http.emptyBody
        , expect = Http.expectWhatever AgentDeleted
        , timeout = Nothing
        , tracker = Nothing
        }


viewDeleteConfirmationModal : Model -> Html Msg
viewDeleteConfirmationModal model =
    case model.showDeleteConfirm of
        Just agentId ->
            let
                targetAgent =
                    List.filter (\a -> a.id == agentId) model.agents
                        |> List.head

                otherAgents =
                    List.filter (\a -> a.id /= agentId) model.agents

                agentName =
                    case targetAgent of
                        Just agent ->
                            agent.firstName ++ " " ++ agent.lastName

                        Nothing ->
                            "this agent"

                errorMessageBlock =
                    if model.error /= Nothing && model.showDeleteConfirm /= Nothing then
                        div [ class "mb-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                            [ text (Maybe.withDefault "" model.error) ]

                    else
                        text ""
            in
            div [ class "fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-50" ]
                [ div [ class "bg-white rounded-lg max-w-lg w-full p-6" ]
                    [ h3 [ class "text-lg font-medium text-gray-900 mb-4" ]
                        [ text ("Delete " ++ agentName ++ "?") ]
                    , p [ class "text-sm text-gray-500 mb-4" ]
                        [ text "This will permanently remove this agent from your organization and cannot be undone." ]
                    , errorMessageBlock
                    , if not (List.isEmpty model.contacts) then
                        div [ class "mb-6" ]
                            [ p [ class "text-sm text-gray-500 mb-2" ]
                                [ text "This agent has contacts assigned to them. What would you like to do with these contacts?" ]
                            , div [ class "mt-4" ]
                                [ select
                                    [ class "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
                                    , onInput
                                        (\val ->
                                            if val == "" then
                                                NoOp

                                            else
                                                ConfirmDeleteAgent agentId (Just val)
                                        )
                                    ]
                                    (option [ value "" ] [ text "Select an agent to reassign contacts" ]
                                        :: List.map
                                            (\agent ->
                                                option [ value agent.id ]
                                                    [ text (agent.firstName ++ " " ++ agent.lastName) ]
                                            )
                                            otherAgents
                                    )
                                ]
                            ]

                      else
                        text ""
                    , div [ class "flex justify-end space-x-3" ]
                        [ button
                            [ class "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                            , onClick (ConfirmDeleteAgent agentId Nothing)
                            ]
                            [ text "Delete Without Reassigning" ]
                        , button
                            [ class "px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"
                            , onClick (ConfirmDeleteAgent agentId model.reassignAgentId)
                            ]
                            [ text "Delete" ]
                        , button
                            [ class "px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
                            , onClick CloseDeleteConfirmModal
                            ]
                            [ text "Cancel" ]
                        ]
                    ]
                ]

        Nothing ->
            text ""


viewEmailStatus : EmailStatus -> Html Msg
viewEmailStatus status =
    div [ class "mt-1 transition-all duration-200" ]
        [ case status of
            NotChecked ->
                text ""

            Checking ->
                div [ class "text-blue-600 text-sm flex items-center" ]
                    [ div [ class "animate-spin h-4 w-4 mr-2 border-2 border-blue-600 border-t-transparent rounded-full" ] []
                    , text "Checking availability..."
                    ]

            Valid ->
                div [ class "text-green-600 text-sm flex items-center" ]
                    [ -- Checkmark icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M5 13l4 4L19 7"
                            ]
                            []
                        ]
                    , text "Email is available"
                    ]

            Invalid message ->
                div [ class "text-red-600 text-sm flex items-center" ]
                    [ -- X icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M6 18L18 6M6 6l12 12"
                            ]
                            []
                        ]
                    , text message
                    ]
        ]


checkAgentEmail : String -> Cmd Msg
checkAgentEmail email =
    Http.get
        { url = "/api/organizations/check-email/" ++ Url.percentEncode email
        , expect = Http.expectJson GotEmailResponse emailResponseDecoder
        }


emailResponseDecoder : Decode.Decoder EmailResponse
emailResponseDecoder =
    Decode.map2 EmailResponse
        (Decode.field "available" Decode.bool)
        (Decode.field "message" Decode.string)


isFormValid : Model -> Bool
isFormValid model =
    let
        isEmailValid =
            model.emailStatus == Valid

        areNamesValid =
            not (String.isEmpty (String.trim model.firstName))
                && not (String.isEmpty (String.trim model.lastName))

        isPhoneValid =
            not (String.isEmpty (String.trim model.displayPhone))

        hasValidRole =
            model.isAdmin || model.isAgent
    in
    isEmailValid && areNamesValid && isPhoneValid && hasValidRole


submitNewAgent : Model -> Cmd Msg
submitNewAgent model =
    -- For new agents, we need to send a POST to /api/agents/create
    -- This endpoint should be more permissive than updating an existing agent
    Http.post
        { url = "/api/agents/create"
        , body =
            Http.jsonBody
                (Encode.object
                    [ ( "firstName", Encode.string model.firstName )
                    , ( "lastName", Encode.string model.lastName )
                    , ( "email", Encode.string model.email )
                    , ( "phone", Encode.string model.rawPhone )
                    , ( "isAdmin", Encode.bool model.isAdmin )
                    , ( "isAgent", Encode.bool model.isAgent )
                    , ( "carriers", Encode.list Encode.string model.carriers )
                    , ( "stateLicenses", Encode.list Encode.string model.stateLicenses )
                    ]
                )
        , expect = Http.expectWhatever AgentSaved
        }

================
File: src/AgeCalc.elm
================
module AgeCalc exposing (getAgeNextMonth)

import Date exposing (Date, Interval(..), Unit(..), add, fromIsoString, toIsoString)
import Time exposing (Month(..))


getAgeNextMonth : String -> Date -> Int
getAgeNextMonth birthDateStr currentDate =
    case fromIsoString birthDateStr of
        Ok birthDate ->
            let
                -- Get first of next month
                nextMonth =
                    currentDate
                        |> add Months 1
                        |> Date.floor Month

                -- Calculate years between birth date and first of next month
                years =
                    Date.diff Years birthDate nextMonth
            in
            years

        Err _ ->
            0

================
File: src/BirthdayRules.elm
================
module BirthdayRules exposing
    ( BirthdayRuleType(..)
    , StateRule
    , canPresentDifferentPlanOnly
    , getDelayedEmailDate
    , getStateRule
    , isInBirthdayRuleWindow
    , isInContinuousOpenEnrollment
    )

{-| This module handles birthday rules for different states.
It provides functionality to check if a contact is in a birthday rule window,
if they are in a continuous open enrollment state, and if they can only be
presented with different plan types during their birthday window.
-}

import Date exposing (Date)
import Time exposing (Month(..))


{-| Represents the type of birthday rule for a state.
-}
type BirthdayRuleType
    = BirthdayRule
    | AnniversaryRule
    | ContinuousOpenEnrollment
    | NoSpecialRule


{-| Represents a state's birthday rule configuration.
-}
type alias StateRule =
    { state : String
    , ruleType : BirthdayRuleType
    , daysBeforeBirthday : Int
    , totalDays : Int
    , canPresentDifferentPlan : Bool
    , notes : String
    }


{-| List of states with their birthday rules.
-}
stateRules : List StateRule
stateRules =
    [ { state = "CA"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 30
      , totalDays = 60
      , canPresentDifferentPlan = False
      , notes = "60-day period starting 30 days before your birthday"
      }
    , { state = "ID"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 63
      , canPresentDifferentPlan = False
      , notes = "63-day period starting on your birthday"
      }
    , { state = "IL"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 45
      , canPresentDifferentPlan = False
      , notes = "45-day period starting on your birthday; 76+ no special GI right"
      }
    , { state = "KY"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 60
      , canPresentDifferentPlan = True
      , notes = "60-day period following your birthday; Can switch sideways and get GI right; Only present different plans."
      }
    , { state = "LA"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 30
      , totalDays = 93
      , canPresentDifferentPlan = False
      , notes = "93-day period starting 30 days before your birthday"
      }
    , { state = "MD"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 31
      , canPresentDifferentPlan = False
      , notes = "31-day period starting on your birthday"
      }
    , { state = "NV"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 60
      , canPresentDifferentPlan = False
      , notes = "60-day period starting on the first day of your birth month"
      }
    , { state = "OK"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 60
      , canPresentDifferentPlan = False
      , notes = "60-day period starting on your birthday"
      }
    , { state = "OR"
      , ruleType = BirthdayRule
      , daysBeforeBirthday = 0
      , totalDays = 31
      , canPresentDifferentPlan = False
      , notes = "31-day period starting on your birthday"
      }
    , { state = "MO"
      , ruleType = AnniversaryRule
      , daysBeforeBirthday = 30
      , totalDays = 63
      , canPresentDifferentPlan = True
      , notes = "63-day period starting 30 days before your policy anniversary date; Can switch sideways and get GI right; Only present different plans."
      }
    , { state = "CT"
      , ruleType = ContinuousOpenEnrollment
      , daysBeforeBirthday = 0
      , totalDays = 0
      , canPresentDifferentPlan = False
      , notes = "Continuous"
      }
    , { state = "MA"
      , ruleType = ContinuousOpenEnrollment
      , daysBeforeBirthday = 0
      , totalDays = 0
      , canPresentDifferentPlan = False
      , notes = "Continuous"
      }
    , { state = "NY"
      , ruleType = ContinuousOpenEnrollment
      , daysBeforeBirthday = 0
      , totalDays = 0
      , canPresentDifferentPlan = False
      , notes = "Continuous"
      }
    , { state = "WA"
      , ruleType = ContinuousOpenEnrollment
      , daysBeforeBirthday = 0
      , totalDays = 0
      , canPresentDifferentPlan = False
      , notes = "Continuous"
      }
    ]


{-| Get the birthday rule for a specific state.
-}
getStateRule : String -> Maybe StateRule
getStateRule state =
    let
        normalizedState =
            String.toUpper state
    in
    List.filter (\rule -> rule.state == normalizedState) stateRules
        |> List.head


{-| Check if a state has continuous open enrollment.
-}
isInContinuousOpenEnrollment : String -> Bool
isInContinuousOpenEnrollment state =
    case getStateRule state of
        Just rule ->
            rule.ruleType == ContinuousOpenEnrollment

        Nothing ->
            False


{-| Check if a contact can only be presented with different plan types during their birthday window.
-}
canPresentDifferentPlanOnly : String -> Bool
canPresentDifferentPlanOnly state =
    case getStateRule state of
        Just rule ->
            rule.canPresentDifferentPlan

        Nothing ->
            False


{-| Calculate the start date of a birthday rule window.
-}
getBirthdayRuleStartDate : StateRule -> Date -> Date
getBirthdayRuleStartDate rule birthDate =
    let
        currentYear =
            Date.year (Date.fromCalendarDate 2024 Jan 1)

        -- This is just a placeholder, will be replaced with actual current date
        -- For Nevada, the window starts on the first day of the birth month
        startDate =
            if rule.state == "NV" then
                Date.fromCalendarDate currentYear (Date.month birthDate) 1

            else
                -- For other states, subtract the days before birthday from the birthday
                Date.add Date.Days -rule.daysBeforeBirthday (Date.fromCalendarDate currentYear (Date.month birthDate) (Date.day birthDate))
    in
    startDate


{-| Calculate the end date of a birthday rule window.
-}
getBirthdayRuleEndDate : StateRule -> Date -> Date
getBirthdayRuleEndDate rule birthDate =
    let
        startDate =
            getBirthdayRuleStartDate rule birthDate
    in
    Date.add Date.Days rule.totalDays startDate


{-| Check if a date is within a birthday rule window.
For Anniversary rules (Missouri), pass the effectiveDate as the second parameter.
For Birthday rules, pass the birthDate as the second parameter.
-}
isInBirthdayRuleWindow : String -> Date -> Date -> Bool
isInBirthdayRuleWindow state baseDate currentDate =
    case getStateRule state of
        Just rule ->
            let
                currentYear =
                    Date.year currentDate

                -- Adjust base date to current year
                adjustedBaseDate =
                    Date.fromCalendarDate currentYear (Date.month baseDate) (Date.day baseDate)

                startDate =
                    getBirthdayRuleStartDate rule adjustedBaseDate

                endDate =
                    getBirthdayRuleEndDate rule adjustedBaseDate
            in
            -- Only check window for Birthday and Anniversary rules
            case rule.ruleType of
                BirthdayRule ->
                    Date.compare currentDate startDate /= LT && Date.compare currentDate endDate /= GT

                AnniversaryRule ->
                    Date.compare currentDate startDate /= LT && Date.compare currentDate endDate /= GT

                ContinuousOpenEnrollment ->
                    -- For continuous open enrollment states, they're always in an "open enrollment window"
                    True

                NoSpecialRule ->
                    False

        Nothing ->
            False


{-| Calculate the date when an email should be sent after a birthday rule window.
For Anniversary rules (Missouri), pass the effectiveDate as the second parameter.
For Birthday rules, pass the birthDate as the second parameter.
The third parameter should be the scheduled date that needs to be delayed.
-}
getDelayedEmailDate : String -> Date -> Date -> Date
getDelayedEmailDate state baseDate scheduledDate =
    case getStateRule state of
        Just rule ->
            let
                -- Use the year from the scheduled date
                scheduledYear =
                    Date.year scheduledDate

                -- Adjust base date to scheduled year
                adjustedBaseDate =
                    Date.fromCalendarDate scheduledYear (Date.month baseDate) (Date.day baseDate)

                -- For Nevada, the window starts on the first day of the birth month
                windowStartDate =
                    if rule.state == "NV" then
                        Date.fromCalendarDate scheduledYear (Date.month baseDate) 1

                    else
                        -- For other states, subtract the days before birthday from the birthday
                        Date.add Date.Days -rule.daysBeforeBirthday adjustedBaseDate

                -- Calculate the end date of the window
                windowEndDate =
                    Date.add Date.Days rule.totalDays windowStartDate

                -- Add one month to the end date
                delayedDate =
                    Date.add Date.Months 1 windowEndDate
            in
            delayedDate

        Nothing ->
            -- If no rule exists, just return the scheduled date
            scheduledDate

================
File: src/Calculator.elm
================
module Calculator exposing (main)

import Browser
import Html exposing (Html, div, h3, input, li, p, text, ul)
import Html.Attributes exposing (max, min, step, type_, value)
import Html.Events exposing (onInput)



-- Model Definition


type alias Model =
    { totalContacts : String -- Total book of business size as string input
    , yearWeights : List Float -- Weights for distribution over 6 years
    , responseRate : String -- Response rate as percentage (e.g., "5" for 5%)
    }



-- Initial State


init : Model
init =
    { totalContacts = ""
    , yearWeights = [ 10.0, 20.0, 30.0, 40.0, 50.0, 60.0 ] -- Initial weights, heavier toward recent years
    , responseRate = "5" -- Default response rate of 5%
    }



-- Messages


type Msg
    = SetTotalContacts String -- Update total contacts
    | SetYearWeight Int String -- Update weight for a specific year (index, value)
    | SetResponseRate String -- Update response rate



-- Update Function


update : Msg -> Model -> Model
update msg model =
    case msg of
        SetTotalContacts s ->
            { model | totalContacts = s }

        SetYearWeight i s ->
            case String.toFloat s of
                Just f ->
                    let
                        yearWeights =
                            List.indexedMap
                                (\j w ->
                                    if j == i then
                                        f

                                    else
                                        w
                                )
                                model.yearWeights
                    in
                    { model | yearWeights = yearWeights }

                Nothing ->
                    model

        -- Ignore invalid slider input (shouldn’t happen with range)
        SetResponseRate s ->
            { model | responseRate = s }



-- View Function


view : Model -> Html Msg
view model =
    div []
        [ -- Input for Total Contacts
          p [] [ text "Total Book of Business Size:" ]
        , input [ type_ "text", value model.totalContacts, onInput SetTotalContacts ] []

        -- Sliders for Year Distribution
        , h3 [] [ text "Adjust Distribution Over Years:" ]
        , div []
            (List.indexedMap
                (\i weight ->
                    div []
                        [ text ("Policies started " ++ String.fromInt (5 - i) ++ " years ago: ")
                        , input
                            [ type_ "range"
                            , min "0"
                            , max "100"
                            , step "1"
                            , value (String.fromFloat weight)
                            , onInput (SetYearWeight i)
                            ]
                            []
                        ]
                )
                model.yearWeights
            )

        -- Input for Response Rate
        , p [] [ text "Response Rate (%):" ]
        , input [ type_ "text", value model.responseRate, onInput SetResponseRate ] []

        -- Calculated Outputs
        , case ( String.toFloat model.totalContacts, String.toFloat model.responseRate ) of
            ( Ok n, Ok r ) ->
                let
                    -- Distribution Calculation
                    sumWeights =
                        List.sum model.yearWeights

                    contactsPerYear =
                        if sumWeights > 0 then
                            List.map (\w -> (w / sumWeights) * n) model.yearWeights

                        else
                            List.repeat 6 0.0

                    -- Core Calculations
                    weeklyCalls =
                        (n / 52) * (r / 100)

                    -- Calls based on one event per contact per year
                    monthlyCost =
                        (n / 10000) * 100

                    -- $100 per 10,000 contacts
                    annualCost =
                        12 * monthlyCost

                    -- Yearly cost
                    totalCallsPerYear =
                        n * (r / 100)

                    -- Total calls in a year
                    numberOfSales =
                        totalCallsPerYear * 0.5

                    -- 50% close rate
                    totalRevenue =
                        numberOfSales * 500

                    -- $500 increased LTV
                    roi =
                        if annualCost > 0 then
                            ((totalRevenue - annualCost) / annualCost) * 100
                            -- ROI as percentage

                        else
                            0
                in
                div []
                    [ -- Distribution Display (Placeholder for Chart)
                      h3 [] [ text "Distribution of Contacts:" ]
                    , ul []
                        (List.indexedMap
                            (\i c ->
                                li [] [ text ("Year -" ++ String.fromInt (5 - i) ++ ": " ++ String.fromFloat c ++ " contacts") ]
                            )
                            contactsPerYear
                        )

                    -- Calculated Metrics
                    , h3 [] [ text "Results:" ]
                    , p [] [ text ("Weekly Calls: " ++ String.fromFloat weeklyCalls) ]
                    , p [] [ text ("Monthly Cost: $" ++ String.fromFloat monthlyCost) ]
                    , p [] [ text ("Annual Cost: $" ++ String.fromFloat annualCost) ]
                    , p [] [ text ("Total Calls per Year: " ++ String.fromFloat totalCallsPerYear) ]
                    , p [] [ text ("Number of Sales: " ++ String.fromFloat numberOfSales) ]
                    , p [] [ text ("Total Revenue: $" ++ String.fromFloat totalRevenue) ]
                    , p [] [ text ("ROI: " ++ String.fromFloat roi ++ "%") ]
                    ]

            _ ->
                p [] [ text "Please enter valid numbers for total contacts and response rate." ]
        ]



-- Main Program


main : Program () Model Msg
main =
    Browser.sandbox { init = init, update = update, view = view }

================
File: src/CarrierNaic.elm
================
module CarrierNaic exposing
    ( Carrier(..)
    , allCarriers
    , carrierDecoder
    , carrierToNaics
    , carrierToString
    , naicToCarrier
    , stringToCarrier
    )

import Json.Decode as Decode exposing (Decoder)


type Carrier
    = Aetna
    | Humana
    | UnitedHealthcare
    | Cigna
    | Aflac
    | Allstate
    | MutualOfOmaha
    | AceChubb


allCarriers : List Carrier
allCarriers =
    [ Aetna
    , Humana
    , UnitedHealthcare
    , Cigna
    , Aflac
    , Allstate
    , MutualOfOmaha
    , AceChubb
    ]


carrierToString : Carrier -> String
carrierToString carrier =
    case carrier of
        Aetna ->
            "Aetna"

        Humana ->
            "Humana"

        UnitedHealthcare ->
            "UnitedHealthcare"

        Cigna ->
            "Cigna"

        Aflac ->
            "Aflac"

        Allstate ->
            "Allstate"

        MutualOfOmaha ->
            "Mutual of Omaha"

        AceChubb ->
            "Ace Chubb"


stringToCarrier : String -> Maybe Carrier
stringToCarrier str =
    case String.toLower str of
        "aetna" ->
            Just Aetna

        "humana" ->
            Just Humana

        "unitedhealthcare" ->
            Just UnitedHealthcare

        "uhc" ->
            Just UnitedHealthcare

        "united healthcare" ->
            Just UnitedHealthcare

        "cigna" ->
            Just Cigna

        "aflac" ->
            Just Aflac

        "allstate" ->
            Just Allstate

        "mutual of omaha" ->
            Just MutualOfOmaha

        "ace chubb" ->
            Just AceChubb

        "ace" ->
            Just AceChubb

        "chubb" ->
            Just AceChubb

        _ ->
            Nothing


carrierToNaics : Carrier -> List String
carrierToNaics carrier =
    case carrier of
        Aetna ->
            [ "72052" -- Aetna Hlth Ins Co
            , "78700" -- Aetna Hlth & Life Ins Co
            , "68500" -- Continental Life Ins Co Brentwood
            ]

        Humana ->
            [ "12634" -- Humana Ins Co of NY
            , "60052" -- Humana Insurance Company
            , "60219" -- Humana Insurance Company
            , "60984" -- Humana Insurance Company
            , "69671" -- Humana Insurance Company
            , "70580" -- Humana Insurance Company
            , "73288" -- Humana Ins Co
            , "88595" -- Humana Insurance Company
            , "95158" -- Humana Insurance Company
            ]

        UnitedHealthcare ->
            [ "60093" -- United Hlthcare Ins Co Of NY
            , "79413" -- UnitedHealthcare Ins Co
            ]

        Cigna ->
            [ "61727" -- Cigna National Health Ins Co
            , "65269" -- Cigna Ins Co
            , "65722" -- Loyal Amer Life Ins Co (CIGNA)
            , "67369" -- Cigna Hlth & Life Ins Co
            , "88366" -- American Retirement Life Ins Co (CIGNA)
            ]

        Aflac ->
            [ "60380" -- AFLAC
            ]

        Allstate ->
            [ "60534" -- Allstate Health Solutions (AHL)
            , "82538" -- Allstate Health Solutions
            ]

        MutualOfOmaha ->
            [ "13100" -- Omaha Ins Co
            , "71412" -- Mutual Of Omaha Ins Co
            , "72850" -- United World Life Ins Co
            ]

        AceChubb ->
            [ "20699" -- Ace Prop & Cas Ins Co
            ]


naicToCarrier : String -> Maybe Carrier
naicToCarrier naic =
    case naic of
        -- Aetna
        "72052" ->
            Just Aetna

        "78700" ->
            Just Aetna

        "68500" ->
            Just Aetna

        -- Humana
        "12634" ->
            Just Humana

        "60052" ->
            Just Humana

        "60219" ->
            Just Humana

        "60984" ->
            Just Humana

        "69671" ->
            Just Humana

        "70580" ->
            Just Humana

        "73288" ->
            Just Humana

        "88595" ->
            Just Humana

        "95158" ->
            Just Humana

        -- UnitedHealthcare
        "60093" ->
            Just UnitedHealthcare

        "79413" ->
            Just UnitedHealthcare

        -- Cigna
        "61727" ->
            Just Cigna

        "65269" ->
            Just Cigna

        "65722" ->
            Just Cigna

        "67369" ->
            Just Cigna

        "88366" ->
            Just Cigna

        -- Aflac
        "60380" ->
            Just Aflac

        -- Allstate
        "60534" ->
            Just Allstate

        "82538" ->
            Just Allstate

        -- Mutual of Omaha
        "13100" ->
            Just MutualOfOmaha

        "71412" ->
            Just MutualOfOmaha

        "72850" ->
            Just MutualOfOmaha

        -- Ace Chubb
        "20699" ->
            Just AceChubb

        _ ->
            Nothing


carrierDecoder : Decoder Carrier
carrierDecoder =
    Decode.string
        |> Decode.andThen
            (\str ->
                case stringToCarrier str of
                    Just carrier ->
                        Decode.succeed carrier

                    Nothing ->
                        Decode.fail "Invalid carrier"
            )

================
File: src/ChangePlan.elm
================
module ChangePlan exposing (Model, Msg, init, subscriptions, update, view)

import Browser exposing (Document)
import Browser.Navigation as Nav
import ChoosePlan
import Components.LimitBanner as LimitBanner
import Html exposing (Html, div, text)
import Html.Attributes exposing (class)
import Json.Decode as Decode


type alias Model =
    { choosePlanModel : ChoosePlan.Model
    , limitBanner : LimitBanner.Model
    }


type Msg
    = ChoosePlanMsg ChoosePlan.Msg
    | ChooseBannerMsg LimitBanner.Msg


init : { key : Nav.Key, session : String, orgSlug : String } -> ( Model, Cmd Msg )
init { key, session, orgSlug } =
    let
        ( choosePlanModel, choosePlanCmd ) =
            ChoosePlan.init orgSlug session key True

        ( limitBannerModel, limitBannerCmd ) =
            LimitBanner.init
    in
    ( { choosePlanModel = choosePlanModel
      , limitBanner = limitBannerModel
      }
    , Cmd.batch
        [ Cmd.map ChoosePlanMsg choosePlanCmd
        , Cmd.map ChooseBannerMsg limitBannerCmd
        ]
    )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        ChoosePlanMsg choosePlanMsg ->
            let
                ( updatedChoosePlanModel, choosePlanCmd ) =
                    ChoosePlan.update choosePlanMsg model.choosePlanModel
            in
            ( { model | choosePlanModel = updatedChoosePlanModel }
            , Cmd.map ChoosePlanMsg choosePlanCmd
            )

        ChooseBannerMsg chooseBannerMsg ->
            let
                ( updatedChooseBannerModel, chooseBannerCmd ) =
                    LimitBanner.update chooseBannerMsg model.limitBanner
            in
            ( { model | limitBanner = updatedChooseBannerModel }
            , Cmd.map ChooseBannerMsg chooseBannerCmd
            )


view : Model -> Document Msg
view model =
    { title = "Change Plan - Medicare Max"
    , body =
        [ LimitBanner.view model.limitBanner
            |> Html.map ChooseBannerMsg
        , ChoosePlan.viewChangePlan model.choosePlanModel
            |> Html.map ChoosePlanMsg
        ]
    }


subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.map ChoosePlanMsg (ChoosePlan.subscriptions model.choosePlanModel)

================
File: src/ChoosePlan.elm
================
port module ChoosePlan exposing (Model, Msg(..), init, subscriptions, update, view, viewChangePlan)

import Browser exposing (Document)
import Browser.Navigation as Nav
import Components.LimitBanner as LimitBanner exposing (LimitWarning(..))
import Components.SetupLayout as SetupLayout
import Html exposing (Html, button, div, h1, h2, h3, h4, input, label, li, node, p, span, text, ul)
import Html.Attributes exposing (attribute, class, disabled, type_, value)
import Html.Events exposing (onClick, onInput)
import Http
import Json.Decode as Decode exposing (Decoder, field, int, list, string)
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)


type SetupStep
    = PlanSelection
    | Payment
    | Complete


type alias SubscriptionTier =
    { id : String
    , name : String
    , price : String
    , agentLimit : Int
    , contactLimit : Int
    , features : List String
    }


type alias CustomTierPricing =
    { price : String
    , agentLimit : Int
    , tierName : String
    , contactLimit : Int
    , features : List String
    }


type alias Model =
    { session : Maybe String
    , orgSlug : String
    , currentStep : SetupStep
    , selectedPlan : Maybe String
    , extraAgents : Int
    , extraContacts : Int
    , error : Maybe String
    , tiers : List SubscriptionTier
    , isLoading : Bool
    , key : Nav.Key
    , isProcessingPayment : Bool
    , showChangePlan : Bool
    , currentTier : Maybe String
    , currentAgentLimit : Int
    , currentContactLimit : Int
    , showTrialBanner : Bool
    , customContactCount : String
    , isLoadingCustomTier : Bool
    , customTierPricing : Maybe CustomTierPricing
    }


type Msg
    = NextStep
    | SelectPlan String
    | SubmitPayment
    | CompleteSetup
    | GotTiers (Result Http.Error (List SubscriptionTier))
    | SubscriptionSaved (Result Http.Error ())
    | NavigateToTempLanding
    | GotSaveResponse (Result Http.Error ())
    | SetExtraAgents String
    | SetExtraContacts String
    | StripeCheckoutReady (Result Http.Error String)
    | ProcessPayment
    | CancelPayment
    | GotCurrentSubscription (Result Http.Error { tierId : String, agentLimit : Int, contactLimit : Int })
    | ConfirmPlan
    | GotConfirmation (Result Http.Error { success : Bool, redirectUrl : String })
    | NoOp
    | NavigateTo String
    | CloseBanner
    | SetCustomContactCount String
    | CalculateCustomTier
    | GotCustomTierPricing (Result Http.Error CustomTierPricing)
    | SelectCustomTier
    | StripeTableSelection String


init : String -> String -> Nav.Key -> Bool -> ( Model, Cmd Msg )
init orgSlug session key showChangePlan =
    ( { session = Just session
      , orgSlug = orgSlug
      , currentStep = PlanSelection
      , selectedPlan = Nothing
      , extraAgents = 0
      , extraContacts = 0
      , error = Nothing
      , tiers = []
      , isLoading = True
      , key = key
      , isProcessingPayment = False
      , showChangePlan = showChangePlan
      , currentTier = Nothing
      , currentAgentLimit = 0
      , currentContactLimit = 0
      , showTrialBanner = True
      , customContactCount = ""
      , isLoadingCustomTier = False
      , customTierPricing = Nothing
      }
    , Cmd.batch
        [ fetchSubscriptionTiers
        , if showChangePlan then
            fetchCurrentSubscription orgSlug

          else
            Cmd.none
        ]
    )


fetchCurrentSubscription : String -> Cmd Msg
fetchCurrentSubscription orgSlug =
    let
        url =
            "/api/organizations/" ++ orgSlug ++ "/subscription"
    in
    Http.get
        { url = url
        , expect = Http.expectJson GotCurrentSubscription currentSubscriptionDecoder
        }


fetchSubscriptionTiers : Cmd Msg
fetchSubscriptionTiers =
    Http.get
        { url = "/api/organizations/subscription-tiers"
        , expect = Http.expectJson GotTiers subscriptionTiersDecoder
        }


saveSubscription : String -> String -> Int -> Int -> Cmd Msg
saveSubscription orgSlug tierId extraAgents extraContacts =
    let
        url =
            "/api/organizations/" ++ orgSlug ++ "/subscription"
    in
    Http.post
        { url = url
        , body = Http.jsonBody (encodeSubscriptionUpdate tierId extraAgents extraContacts)
        , expect = Http.expectWhatever SubscriptionSaved
        }


createStripeCheckoutSession : String -> String -> Int -> Int -> Cmd Msg
createStripeCheckoutSession orgSlug tierId extraAgents extraContacts =
    let
        url =
            "/api/stripe/create-checkout-session"
    in
    Http.post
        { url = url
        , body = Http.jsonBody (encodeStripeCheckoutRequest orgSlug tierId extraAgents extraContacts)
        , expect = Http.expectJson StripeCheckoutReady (field "sessionId" string)
        }


redirectToStripeCheckout : String -> Cmd Msg
redirectToStripeCheckout sessionId =
    -- Use the session ID to redirect to Stripe Checkout
    -- In a real implementation, this would likely be a port to JavaScript
    -- For this demo, we're just simulating with a navigation
    Nav.load ("/api/stripe/redirect-to-checkout?session_id=" ++ sessionId)


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        SubscriptionSaved result ->
            case result of
                Ok _ ->
                    ( { model | error = Nothing }
                    , if model.showChangePlan then
                        -- For change plan, just reload the current page to show updated info
                        Nav.reload

                      else
                        -- For initial setup, continue to next step
                        case model.selectedPlan of
                            Just planId ->
                                Nav.pushUrl model.key ("/setup/settings?plan=" ++ planId)

                            Nothing ->
                                Nav.pushUrl model.key "/setup/settings"
                    )

                Err error ->
                    ( { model | error = Just "Failed to save subscription", isProcessingPayment = False }
                    , Cmd.none
                    )

        NextStep ->
            case model.currentStep of
                PlanSelection ->
                    case model.selectedPlan of
                        Just planId ->
                            if model.showChangePlan then
                                -- For change plan, we go directly to payment
                                ( { model | currentStep = Payment, isProcessingPayment = True }
                                , createStripeCheckoutSession model.orgSlug planId model.extraAgents model.extraContacts
                                )

                            else
                                -- For initial setup, save subscription then go to next page
                                ( { model | currentStep = Payment }
                                , saveSubscription model.orgSlug planId model.extraAgents model.extraContacts
                                )

                        Nothing ->
                            ( { model | error = Just "Please select a plan" }
                            , Cmd.none
                            )

                Payment ->
                    ( { model | currentStep = Complete }
                    , if model.showChangePlan then
                        Nav.pushUrl model.key "/dashboard"

                      else
                        Nav.pushUrl model.key "/templanding"
                    )

                Complete ->
                    ( model
                    , if model.showChangePlan then
                        Nav.pushUrl model.key "/dashboard"

                      else
                        Nav.pushUrl model.key "/templanding"
                    )

        SelectPlan plan ->
            ( { model | selectedPlan = Just plan }
            , Cmd.none
            )

        SetExtraAgents value ->
            let
                extraAgents =
                    String.toInt value |> Maybe.withDefault 0
            in
            ( { model | extraAgents = extraAgents }, Cmd.none )

        SetExtraContacts value ->
            let
                extraContacts =
                    String.toInt value |> Maybe.withDefault 0
            in
            ( { model | extraContacts = extraContacts }, Cmd.none )

        GotTiers result ->
            case result of
                Ok tiers ->
                    let
                        -- Look for Pro plans specifically
                        proPlans =
                            List.filter (\t -> t.id == "pro") tiers

                        -- Look for $99 Pro plan
                        proPlans99 =
                            List.filter (\t -> t.id == "pro" && t.price == "$99/mo") tiers

                        -- Apply filter
                        filteredTiers =
                            filterTiers tiers
                    in
                    ( { model
                        | tiers = filteredTiers
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err error ->
                    let
                        errorString =
                            case error of
                                Http.BadUrl url ->
                                    "Bad URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus statusCode ->
                                    "Bad status: " ++ String.fromInt statusCode

                                Http.BadBody message ->
                                    "Bad body: " ++ message
                    in
                    ( { model | error = Just "Failed to load subscription tiers", isLoading = False }
                    , Cmd.none
                    )

        GotCurrentSubscription result ->
            case result of
                Ok subscription ->
                    ( { model
                        | currentTier = Just subscription.tierId
                        , currentAgentLimit = subscription.agentLimit
                        , currentContactLimit = subscription.contactLimit
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err error ->
                    -- Log the error in console using Debug.log
                    let
                        errorString =
                            case error of
                                Http.BadUrl url ->
                                    "Bad URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus statusCode ->
                                    "Bad status: " ++ String.fromInt statusCode

                                Http.BadBody message ->
                                    "Bad body: " ++ message
                    in
                    ( { model | error = Just "Failed to load current subscription", isLoading = False }
                    , Cmd.none
                    )

        StripeCheckoutReady result ->
            case result of
                Ok sessionId ->
                    ( model
                    , redirectToStripeCheckout sessionId
                    )

                Err error ->
                    ( { model | error = Just "Failed to create payment session", isProcessingPayment = False }
                    , Cmd.none
                    )

        ProcessPayment ->
            case model.selectedPlan of
                Just planId ->
                    if model.showChangePlan && not (hasChanges model) then
                        -- No changes, show an error
                        ( { model | error = Just "No changes made to your subscription." }
                        , Cmd.none
                        )

                    else
                        -- Process payment for changes
                        ( { model | isProcessingPayment = True }
                        , createStripeCheckoutSession model.orgSlug planId model.extraAgents model.extraContacts
                        )

                Nothing ->
                    ( { model | error = Just "Please select a plan" }
                    , Cmd.none
                    )

        CancelPayment ->
            ( { model | isProcessingPayment = False }
            , Cmd.none
            )

        GotSaveResponse result ->
            case result of
                Ok _ ->
                    ( { model | error = Nothing }
                    , Nav.pushUrl model.key "/brand-settings"
                    )

                Err error ->
                    ( { model
                        | error = Just "Failed to save subscription. Please try again."
                        , isLoading = False
                      }
                    , Cmd.none
                    )

        ConfirmPlan ->
            let
                plan =
                    model.selectedPlan |> Maybe.withDefault "basic"
            in
            ( { model | isLoading = True }
            , Http.post
                { url = "/api/choose-plan"
                , body =
                    Http.jsonBody
                        (Encode.object
                            [ ( "plan", Encode.string plan )
                            , ( "orgSlug", Encode.string model.orgSlug )
                            ]
                        )
                , expect = Http.expectJson GotConfirmation confirmationDecoder
                }
            )

        GotConfirmation (Ok response) ->
            if response.success then
                ( model
                , Nav.pushUrl model.key response.redirectUrl
                )

            else
                ( { model | isLoading = False, error = Just "Failed to update plan. Please try again." }
                , Cmd.none
                )

        GotConfirmation (Err _) ->
            ( { model | isLoading = False, error = Just "Failed to connect to server. Please try again." }
            , Cmd.none
            )

        NavigateTo url ->
            ( model
            , Nav.pushUrl model.key url
            )

        CloseBanner ->
            ( { model | showTrialBanner = False }, Cmd.none )

        SetCustomContactCount value ->
            ( { model | customContactCount = value }, Cmd.none )

        CalculateCustomTier ->
            ( { model | isLoadingCustomTier = True }, calculateCustomTier model )

        GotCustomTierPricing result ->
            case result of
                Ok pricing ->
                    ( { model | customTierPricing = Just pricing, isLoadingCustomTier = False }, Cmd.none )

                Err error ->
                    ( { model | error = Just "Failed to calculate custom tier pricing", isLoadingCustomTier = False }, Cmd.none )

        SelectCustomTier ->
            ( model, selectCustomTier model )

        StripeTableSelection priceId ->
            ( { model | selectedPlan = Just priceId, error = Nothing }
            , Cmd.none
            )

        _ ->
            ( model, Cmd.none )


view : Model -> Browser.Document Msg
view model =
    { title =
        if model.showChangePlan then
            "Change Plan - Medicare Max"

        else
            "Choose Plan - Medicare Max"
    , body =
        [ if model.showTrialBanner then
            getPlanLimitBanner model

          else
            text ""
        , if model.showChangePlan then
            -- Change Plan is not part of setup flow, but a standalone page
            -- Return just the content portion which will be wrapped by Main.elm
            viewChangePlan model

          else
            -- This is the setup flow which uses a different layout
            SetupLayout.view SetupLayout.PlanSelection
                -- For plan selection, we determine basic vs pro based on what the user has selected
                (case model.selectedPlan of
                    Just "basic" ->
                        True

                    _ ->
                        False
                )
                0
                -- Using 0 for PlanSelection as it's the first step
                [ if model.isLoading then
                    viewLoading

                  else
                    viewPlanSelection model
                ]
        ]
    }


viewChangePlan : Model -> Html Msg
viewChangePlan model =
    div [ class "container mx-auto py-8 px-4" ]
        [ div [ class "space-y-8" ]
            [ div [ class "mb-8" ]
                [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                    [ text "Change Your Plan" ]
                , p [ class "text-gray-600 mt-2" ]
                    [ text "Modify your subscription to better fit your organization's needs" ]
                ]
            , case model.currentTier of
                Just currentTierId ->
                    div [ class "p-4 bg-blue-50 rounded-lg border border-blue-200 mb-8" ]
                        [ h3 [ class "text-lg font-semibold text-gray-900" ]
                            [ text "Current Plan" ]
                        , p [ class "text-sm text-gray-600" ]
                            [ text
                                ("You are currently on the "
                                    ++ (model.tiers
                                            |> List.filter (\t -> t.id == currentTierId)
                                            |> List.head
                                            |> Maybe.map .name
                                            |> Maybe.withDefault currentTierId
                                       )
                                    ++ " plan with "
                                    ++ String.fromInt model.currentAgentLimit
                                    ++ " agent seats and "
                                    ++ String.fromInt model.currentContactLimit
                                    ++ " clients."
                                )
                            ]
                        ]

                Nothing ->
                    text ""
            , if model.isProcessingPayment then
                div [ class "text-center py-8" ]
                    [ div [ class "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
                    , p [ class "mt-4 text-gray-500" ]
                        [ text "Preparing payment session..." ]
                    , button
                        [ class "mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
                        , onClick CancelPayment
                        ]
                        [ text "Cancel" ]
                    ]

              else
                div []
                    [ div [ class "grid grid-cols-1 md:grid-cols-3 gap-4" ]
                        (List.map
                            (\tier ->
                                viewPlanOption
                                    tier.id
                                    tier.name
                                    tier.price
                                    tier.features
                                    tier.agentLimit
                                    tier.contactLimit
                                    model.selectedPlan
                            )
                            model.tiers
                        )

                    -- Add custom tier calculator section
                    , div [ class "mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200" ]
                        [ h3 [ class "text-lg font-semibold text-gray-900 mb-4" ]
                            [ text "Need a custom plan?" ]
                        , p [ class "text-gray-600 mb-4" ]
                            [ text "Enter your expected number of contacts to calculate a custom tier." ]
                        , div [ class "flex items-end space-x-4" ]
                            [ div [ class "flex-grow" ]
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                    [ text "Number of Contacts" ]
                                , input
                                    [ type_ "number"
                                    , class "w-full px-4 py-2 border border-gray-300 rounded-md"
                                    , value model.customContactCount
                                    , onInput SetCustomContactCount
                                    , Html.Attributes.placeholder "Enter contact count (e.g. 15000)"
                                    ]
                                    []
                                ]
                            , button
                                [ class "px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700"
                                , onClick CalculateCustomTier
                                ]
                                [ if model.isLoadingCustomTier then
                                    text "Calculating..."

                                  else
                                    text "Calculate"
                                ]
                            ]

                        -- Display custom tier result if available
                        , case model.customTierPricing of
                            Just pricing ->
                                div [ class "mt-6 p-4 bg-white rounded-lg border border-blue-200" ]
                                    [ div [ class "flex items-center justify-between mb-3" ]
                                        [ h4 [ class "text-lg font-semibold text-gray-900" ]
                                            [ text pricing.tierName ]
                                        , div [ class "rounded-full px-3 py-1 text-sm font-medium bg-blue-50 text-blue-700" ]
                                            [ text pricing.price ]
                                        ]
                                    , p [ class "text-gray-600 mb-3" ]
                                        [ text ("Up to " ++ String.fromInt pricing.contactLimit ++ " contacts with " ++ String.fromInt pricing.agentLimit ++ " agent accounts") ]
                                    , div [ class "mt-3" ]
                                        [ ul [ class "space-y-2" ]
                                            (List.map viewFeature pricing.features)
                                        ]
                                    , div [ class "mt-4" ]
                                        [ button
                                            [ class "px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 w-full"
                                            , onClick (SelectPlan ("tier-custom-" ++ String.fromInt pricing.contactLimit))
                                            ]
                                            [ text "Select This Plan" ]
                                        ]
                                    ]

                            Nothing ->
                                text ""
                        ]
                    , if canAddExtraResources model.selectedPlan then
                        div [ class "mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200" ]
                            [ h3 [ class "text-lg font-semibold text-gray-900 mb-4" ]
                                [ text "Additional Resources" ]
                            , div [ class "grid grid-cols-1 md:grid-cols-2 gap-6" ]
                                [ div [ class "space-y-2" ]
                                    [ label [ class "block text-sm font-medium text-gray-700" ]
                                        [ text "Extra Agents" ]
                                    , p [ class "text-xs text-gray-500" ]
                                        [ text "Add more agent seats beyond your plan's included limit ($20/agent seat/month)" ]
                                    , div [ class "flex items-center" ]
                                        [ button
                                            [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                                            , onClick (SetExtraAgents (String.fromInt (max 0 (model.extraAgents - 1))))
                                            ]
                                            [ text "-" ]
                                        , input
                                            [ type_ "number"
                                            , class "w-16 text-center border-y border-gray-200 py-1"
                                            , value (String.fromInt model.extraAgents)
                                            , onInput SetExtraAgents
                                            ]
                                            []
                                        , button
                                            [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                                            , onClick (SetExtraAgents (String.fromInt (model.extraAgents + 1)))
                                            ]
                                            [ text "+" ]
                                        , span [ class "ml-2 text-sm font-medium" ]
                                            [ text ("$" ++ String.fromInt (model.extraAgents * 20) ++ "/mo") ]
                                        ]
                                    ]
                                , div [ class "space-y-2" ]
                                    [ label [ class "block text-sm font-medium text-gray-700" ]
                                        [ text "Extra Clients" ]
                                    , p [ class "text-xs text-gray-500" ]
                                        [ text "Add more clients beyond your plan's included limit ($50/5,000 clients/month)" ]
                                    , div [ class "flex items-center" ]
                                        [ button
                                            [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                                            , onClick (SetExtraContacts (String.fromInt (max 0 (model.extraContacts - 5000))))
                                            ]
                                            [ text "-" ]
                                        , input
                                            [ type_ "number"
                                            , class "w-20 text-center border-y border-gray-200 py-1"
                                            , value (String.fromInt model.extraContacts)
                                            , onInput SetExtraContacts
                                            , Html.Attributes.step "5000"
                                            ]
                                            []
                                        , button
                                            [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                                            , onClick (SetExtraContacts (String.fromInt (model.extraContacts + 5000)))
                                            ]
                                            [ text "+" ]
                                        , span [ class "ml-2 text-sm font-medium" ]
                                            [ text ("$" ++ String.fromInt (model.extraContacts // 5000 * 50) ++ "/mo") ]
                                        ]
                                    ]
                                ]
                            ]

                      else
                        text ""
                    , if model.error /= Nothing then
                        div [ class "mt-4 text-red-500" ]
                            [ text (Maybe.withDefault "" model.error) ]

                      else
                        text ""
                    , div [ class "mt-8 flex justify-center space-x-4" ]
                        [ button
                            [ class
                                ("px-6 py-3 rounded-lg transition-colors duration-200 "
                                    ++ (if model.selectedPlan == Nothing || (model.showChangePlan && not (hasChanges model)) then
                                            "bg-[#2563EB]/50 cursor-not-allowed text-white"

                                        else
                                            "bg-[#2563EB] hover:bg-[#1D4ED8] text-white"
                                       )
                                )
                            , onClick
                                (if model.showChangePlan then
                                    ProcessPayment

                                 else
                                    NextStep
                                )
                            , Html.Attributes.disabled (model.selectedPlan == Nothing || (model.showChangePlan && not (hasChanges model)))
                            ]
                            [ text
                                (if model.showChangePlan then
                                    "Change Plan"

                                 else
                                    "Select"
                                )
                            ]
                        , if model.showChangePlan then
                            button
                                [ class "px-6 py-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800"
                                , onClick NavigateToTempLanding
                                ]
                                [ text "Cancel" ]

                          else
                            text ""
                        ]
                    ]
            ]
        ]


viewLoading : Html Msg
viewLoading =
    div [ class "text-center" ]
        [ div [ class "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading subscription tiers..." ]
        ]


viewPlanSelection : Model -> Html Msg
viewPlanSelection model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Choose your plan" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Select a plan that fits your organization's needs" ]
            ]
        , div [ class "w-full" ]
            [ -- Embedded Stripe pricing table
              node "stripe-pricing-table"
                [ attribute "pricing-table-id" "prctbl_1RAfz9CBUPXAZKNG0EyV8bRU"
                , attribute "publishable-key" "pk_test_51Qyh7RCBUPXAZKNGAvsWikdxCCaV1R9Vc79IgPqCul8AJsln69ABDQZE0zzOtOlH5rqrlw2maRebndvPl8xDaIVl00Nn2OOBCX"
                ]
                []
            , div [ class "mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200" ]
                [ h3 [ class "text-lg font-semibold text-gray-900 mb-2" ]
                    [ text "Usage-Based Pricing" ]
                , p [ class "text-gray-600" ]
                    [ text "Our subscription includes the following:" ]
                , ul [ class "list-disc list-inside mt-2 space-y-1 text-gray-600" ]
                    [ li [] [ text "Base plan includes 500 contacts" ]
                    , li [] [ text "$40 for each additional 500 contacts used" ]
                    , li [] [ text "You will only be billed for the contacts you actually have" ]
                    , li [] [ text "We'll automatically adjust your billing as your contact count changes" ]
                    ]
                ]
            ]

        -- Add a button to continue after selection
        , div [ class "mt-8 flex justify-center" ]
            [ button
                [ class
                    ("px-6 py-3 rounded-lg transition-colors duration-200 "
                        ++ (if model.selectedPlan == Nothing then
                                "bg-blue-400 cursor-not-allowed text-white"

                            else
                                "bg-blue-600 hover:bg-blue-700 text-white"
                           )
                    )
                , onClick NextStep
                , disabled (model.selectedPlan == Nothing)
                ]
                [ text "Continue" ]
            ]
        ]


viewPlanOption : String -> String -> String -> List String -> Int -> Int -> Maybe String -> Html Msg
viewPlanOption id name price features agentLimit contactLimit selectedPlan =
    div
        [ class
            ("p-6 rounded-lg cursor-pointer transition-all "
                ++ (if Just id == selectedPlan then
                        "bg-[#2563EB]/10 ring-2 ring-[#2563EB]"

                    else
                        "bg-gray-50 hover:bg-gray-100"
                   )
            )
        , onClick (SelectPlan id)
        ]
        [ div [ class "space-y-4" ]
            [ div []
                [ h3 [ class "text-xl font-semibold text-gray-900" ] [ text name ]
                , p [ class "text-3xl font-bold text-gray-900 mt-2" ]
                    [ text
                        (if id == "enterprise" then
                            "Contact Us"

                         else
                            price
                        )
                    ]
                ]
            , div [ class "space-y-2 py-4 border-t border-b border-gray-200" ]
                [ if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "Starts with up to " ++ String.fromInt agentLimit ++ " agent seats"

                             else if agentLimit == -1 then
                                "Unlimited agent seats"

                             else
                                "Up to " ++ String.fromInt agentLimit ++ " agent seats"
                            )
                        ]

                  else
                    text ""
                , if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "Starts with up to " ++ String.fromInt contactLimit ++ " clients"

                             else if contactLimit == -1 then
                                "Unlimited clients"

                             else
                                "Up to " ++ String.fromInt contactLimit ++ " clients"
                            )
                        ]

                  else
                    text ""
                ]
            , div [ class "mt-4" ]
                [ p [ class "text-sm font-medium text-gray-900 mb-2" ] [ text "Features:" ]
                , ul [ class "space-y-2" ]
                    (List.map
                        (\feature ->
                            li [ class "flex items-start" ]
                                [ span [ class "text-[#059669] mr-2" ] [ text "✓" ]
                                , text feature
                                ]
                        )
                        features
                    )
                ]
            ]
        ]


viewFeature : String -> Html Msg
viewFeature feature =
    li [ class "flex items-start" ]
        [ div [ class "flex-shrink-0 h-5 w-5 text-green-500" ]
            [ viewSmallCheckIcon ]
        , div [ class "ml-3 text-sm text-gray-500" ]
            [ text feature ]
        ]


viewCheckIcon : Html Msg
viewCheckIcon =
    svg
        [ Svg.Attributes.class "h-5 w-5"
        , viewBox "0 0 20 20"
        , fill "currentColor"
        ]
        [ path
            [ fillRule "evenodd"
            , clipRule "evenodd"
            , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            ]
            []
        ]


viewSmallCheckIcon : Html Msg
viewSmallCheckIcon =
    svg
        [ Svg.Attributes.class "h-4 w-4"
        , viewBox "0 0 20 20"
        , fill "currentColor"
        ]
        [ path
            [ fillRule "evenodd"
            , clipRule "evenodd"
            , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            ]
            []
        ]


calculateCustomTier : Model -> Cmd Msg
calculateCustomTier model =
    case String.toInt model.customContactCount of
        Just contactCount ->
            if contactCount > 0 then
                Http.get
                    { url = "/api/subscription/calculate-tier/" ++ String.fromInt contactCount
                    , expect = Http.expectJson GotCustomTierPricing customTierPricingDecoder
                    }

            else
                Cmd.none

        Nothing ->
            Cmd.none


customTierPricingDecoder : Decoder CustomTierPricing
customTierPricingDecoder =
    field "success" Decode.bool
        |> Decode.andThen
            (\success ->
                if success then
                    field "pricing"
                        (Decode.map5 CustomTierPricing
                            (field "price" string)
                            (field "agentLimit" int)
                            (field "tierName" string)
                            (field "contactLimit" int)
                            (field "features" (list string))
                        )

                else
                    Decode.fail "API returned error"
            )


selectCustomTier : Model -> Cmd Msg
selectCustomTier model =
    case model.customTierPricing of
        Just pricing ->
            -- Create a custom tier ID based on the contact limit
            let
                customTierId =
                    "tier-custom-" ++ String.fromInt pricing.contactLimit
            in
            -- Simulate selecting this plan
            Cmd.none

        Nothing ->
            Cmd.none


subscriptions : Model -> Sub Msg
subscriptions _ =
    stripeTableSelected StripeTableSelection


subscriptionTiersDecoder : Decoder (List SubscriptionTier)
subscriptionTiersDecoder =
    field "tiers"
        (list
            (Decode.map6 SubscriptionTier
                (field "id" string)
                (field "name" string)
                (field "price" string)
                (field "agentLimit" int)
                (field "contactLimit" int)
                (field "features" (list string))
            )
        )


currentSubscriptionDecoder : Decoder { tierId : String, agentLimit : Int, contactLimit : Int }
currentSubscriptionDecoder =
    let
        -- Try to decode from a success field first (for API format consistency)
        successDecoder =
            field "success" Decode.bool
                |> Decode.andThen
                    (\success ->
                        if success then
                            -- If success is true, look for the fields at the top level
                            Decode.map3
                                (\tierId agentLimit contactLimit ->
                                    { tierId = tierId
                                    , agentLimit = agentLimit
                                    , contactLimit = contactLimit
                                    }
                                )
                                (field "tierId" string)
                                (field "agentLimit" int)
                                (field "contactLimit" int)

                        else
                            -- If success is false, fail with the error message
                            field "error" string
                                |> Decode.andThen (\err -> Decode.fail err)
                    )

        -- Try the direct decoder as a fallback
        directDecoder =
            Decode.map3
                (\tierId agentLimit contactLimit ->
                    { tierId = tierId
                    , agentLimit = agentLimit
                    , contactLimit = contactLimit
                    }
                )
                (field "tierId" string)
                (field "agentLimit" int)
                (field "contactLimit" int)
    in
    -- Try to use the success wrapper first, fall back to direct decoder
    Decode.oneOf [ successDecoder, directDecoder ]


encodeSubscriptionUpdate : String -> Int -> Int -> Encode.Value
encodeSubscriptionUpdate tierId extraAgents extraContacts =
    Encode.object
        [ ( "tierId", Encode.string tierId )
        , ( "extraAgents", Encode.int extraAgents )
        , ( "extraContacts", Encode.int extraContacts )
        ]


encodeStripeCheckoutRequest : String -> String -> Int -> Int -> Encode.Value
encodeStripeCheckoutRequest orgSlug tierId extraAgents extraContacts =
    Encode.object
        [ ( "orgSlug", Encode.string orgSlug )
        , ( "tierId", Encode.string tierId )
        , ( "extraAgents", Encode.int extraAgents )
        , ( "extraContacts", Encode.int extraContacts )
        ]


filterTiers : List SubscriptionTier -> List SubscriptionTier
filterTiers tiers =
    -- No need to filter out enterprise options with the new contact-based pricing model
    tiers


canAddExtraResources : Maybe String -> Bool
canAddExtraResources selectedPlan =
    case selectedPlan of
        Just plan ->
            plan == "pro"

        -- Only Pro plan can add extra resources
        Nothing ->
            False


hasChanges : Model -> Bool
hasChanges model =
    let
        -- Check if the plan has changed
        planChanged =
            case ( model.currentTier, model.selectedPlan ) of
                ( Just currentTier, Just selectedTier ) ->
                    currentTier /= selectedTier

                _ ->
                    False

        -- Check if resources have changed
        resourcesChanged =
            model.extraAgents > 0 || model.extraContacts > 0
    in
    planChanged || resourcesChanged


confirmationDecoder : Decoder { success : Bool, redirectUrl : String }
confirmationDecoder =
    Decode.map2 (\success redirectUrl -> { success = success, redirectUrl = redirectUrl })
        (Decode.field "success" Decode.bool)
        (Decode.field "redirectUrl" Decode.string)


getPlanLimitBanner : Model -> Html Msg
getPlanLimitBanner model =
    -- When user is on trial plan
    if model.currentAgentLimit > 0 && model.extraAgents > model.currentAgentLimit then
        LimitBanner.viewLimitBanner
            (AgentLimit (model.currentAgentLimit + model.extraAgents) model.currentAgentLimit)
            CloseBanner
        -- When user is on basic plan (which only allows 1 agent)

    else if model.currentTier == Just "basic" then
        LimitBanner.viewLimitBanner
            (CustomWarning
                "Basic Plan Limitations"
                "Your current Basic plan only supports 1 agent. Please upgrade to a higher tier plan to add more agents."
            )
            CloseBanner
        -- When approaching contact limit (subscription data from API)

    else if model.currentContactLimit > 0 && model.extraContacts >= (model.currentContactLimit * 1 // 10) then
        LimitBanner.viewLimitBanner
            (ContactLimit (model.currentContactLimit + model.extraContacts) model.currentContactLimit)
            CloseBanner
        -- Default for new users or when no specific warning is needed

    else
        LimitBanner.viewLimitBanner
            (TrialEnding "June 15, 2024")
            CloseBanner


viewPlan : Maybe String -> SubscriptionTier -> Html Msg
viewPlan selectedPlan tier =
    let
        isSelected =
            selectedPlan == Just tier.id

        selectedClass =
            if isSelected then
                "border-[#03045E] ring-2 ring-[#03045E]"

            else
                "border-gray-200 hover:border-gray-300"
    in
    div
        [ class ("border rounded-lg p-6 cursor-pointer " ++ selectedClass)
        , onClick (SelectPlan tier.id)
        ]
        [ -- Plan header with tier name
          div [ class "flex items-center justify-between" ]
            [ div [ class "flex items-center" ]
                [ h3 [ class "text-lg font-semibold text-gray-900" ]
                    [ text tier.name ]
                , if isSelected then
                    -- Checkmark for selected plan
                    div [ class "ml-2 text-[#03045E]" ]
                        [ viewCheckIcon ]

                  else
                    text ""
                ]
            , div [ class "rounded-full px-3 py-1 text-sm font-medium bg-blue-50 text-blue-700" ]
                [ text tier.price ]
            ]

        -- Limits
        , div [ class "mt-4 space-y-3" ]
            [ div [ class "flex items-start" ]
                [ div [ class "flex-shrink-0 h-5 w-5 text-green-500" ]
                    [ viewSmallCheckIcon ]
                , div [ class "ml-3 text-sm text-gray-500" ]
                    [ text ("Up to " ++ String.fromInt tier.contactLimit ++ " contacts") ]
                ]
            , div [ class "flex items-start" ]
                [ div [ class "flex-shrink-0 h-5 w-5 text-green-500" ]
                    [ viewSmallCheckIcon ]
                , div [ class "ml-3 text-sm text-gray-500" ]
                    [ text ("Up to " ++ String.fromInt tier.agentLimit ++ " agents") ]
                ]
            ]

        -- Features
        , div [ class "mt-6" ]
            [ h4 [ class "text-sm font-medium text-gray-900" ]
                [ text "Includes:" ]
            , ul [ class "mt-2 space-y-2" ]
                (List.map viewFeature tier.features)
            ]
        ]



-- Add this port for the embedded Stripe pricing table


port stripeTableSelected : (String -> msg) -> Sub msg

================
File: src/Compare.elm
================
module Compare exposing
    ( CompareParams
    , Model
    , Msg(..)
    , PlanType(..)
    , fetchPlans
    , init
    , subscriptions
    , update
    , view
    )

import BirthdayRules exposing (isInBirthdayRuleWindow)
import Browser
import Browser.Dom as Dom
import Browser.Events
import Browser.Navigation as Nav
import CarrierNaic exposing (Carrier(..), carrierDecoder, carrierToNaics, carrierToString, naicToCarrier, stringToCarrier)
import Date exposing (Date)
import Dict
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput)
import Http
import Json.Decode as D exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as E
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, height, stroke, strokeLinecap, viewBox, width)
import Task
import Time
import Url exposing (Url)
import Url.Parser as UrlParser
import Url.Parser.Query as Query
import Utils.QuoteHeader exposing (viewHeader)



-- TYPES


type PlanType
    = PlanG
    | PlanN


type alias CompareParams =
    { quoteId : Maybe String
    , orgId : Maybe String
    }


type alias ContactResponse =
    { contact : Contact
    , agent : Agent
    , orgSlug : String
    , orgName : String
    , orgLogo : Maybe String
    , carrierContracts : List Carrier
    }


type alias Agent =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    }


type alias Contact =
    { id : Int
    , firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , age : Int
    , gender : String
    , tobacco : Bool
    , state : String
    , zipCode : String
    , county : Maybe String
    , currentCarrier : Maybe String
    , planType : Maybe String
    }


type alias CoverageItem =
    { name : String
    , percentageCovered : Int
    , note : Maybe String
    }


type alias CoverageList =
    List CoverageItem


type alias Plan =
    { price : Float
    , priceDiscount : Float
    , flag : Maybe String
    , age : Int
    , description : String
    , gender : String
    , id : Int
    , image : String
    , naic : String
    , name : String
    , planType : String
    , premiumStability : String
    , ratingCategory : String
    , score : Int
    , select : Bool
    , state : String
    , tobacco : Bool
    , coverageSummary : CoverageList
    }


type alias Plans =
    { planG : List Plan
    , planN : List Plan
    }


type alias LocationUpdateResponse =
    { success : Bool
    , zipCode : String
    , state : String
    , counties : List String
    }


type alias Model =
    { isLoading : Bool
    , error : Maybe String
    , plans : Plans
    , state : Maybe String
    , county : Maybe String
    , zip : Maybe String
    , age : Maybe Int
    , gender : Maybe String
    , tobacco : Maybe Bool
    , selectedPlanType : PlanType
    , selectedPlan : Maybe Plan
    , showReviewVideo : Bool
    , showQualificationVideo : Bool
    , showGvsNVideo : Bool
    , showFAQ : Bool
    , currentCardIndex : Int
    , showRatesVideo : Bool
    , key : Nav.Key
    , showDiscount : Bool
    , currentCarrier : Maybe String
    , planType : Maybe String
    , dateOfBirth : Maybe String
    , quoteId : Maybe String
    , carrierContracts : List Carrier
    , currentDate : Maybe Date
    , orgId : Maybe String
    , orgName : Maybe String
    , orgLogo : Maybe String
    , name : Maybe String
    , contact : Maybe Contact
    , agent : Maybe Agent
    , orgSlug : Maybe String
    , loadingContact : Bool
    , showDiscountInfo : Bool
    , showLocationModal : Bool
    , editingZipCode : Maybe String
    , editingCounty : Maybe String
    , availableCounties : List String
    , locationUpdateError : Maybe String
    , submittingLocation : Bool
    }


type Msg
    = GotPlans (Result Http.Error Plans)
    | TogglePlanType
    | SelectPlan Plan
    | SelectPlanCard Plan
    | ScrollDown Dom.Viewport
    | CloseReviewVideo
    | OpenGvsNVideo
    | CloseGvsNVideo
    | ShowQualificationVideo
    | CloseQualificationVideo
    | ShowFAQ
    | CloseFAQ
    | NextCard
    | PreviousCard
    | CloseRatesVideo
    | NavigateTo String
    | ToggleDiscount
    | ToggleDiscountInfo
    | GotCarrierContracts (Result Http.Error (List Carrier))
    | GotCurrentDate Date
    | GotContactData (Result Http.Error ContactResponse)
    | ShowLocationModal
    | CloseLocationModal
    | UpdateZipCode String
    | UpdateCounty String
    | SubmitLocationUpdate
    | GotLocationUpdate (Result Http.Error LocationUpdateResponse)
    | NoOp


type alias Flags =
    { state : String
    , zip : String
    , county : String
    , gender : String
    , tobacco : Bool
    , age : Int
    , planType : String
    , currentCarrier : Maybe String
    , dateOfBirth : String
    , quoteId : Maybe String
    }



-- INIT


init : Nav.Key -> Maybe CompareParams -> ( Model, Cmd Msg )
init key maybeParams =
    let
        -- Empty model with loading state
        emptyModel =
            { isLoading = True
            , error = Nothing
            , plans = { planG = [], planN = [] }
            , state = Nothing
            , county = Nothing
            , zip = Nothing
            , age = Nothing
            , gender = Nothing
            , tobacco = Nothing
            , selectedPlanType = PlanG
            , selectedPlan = Nothing
            , showReviewVideo = False
            , showQualificationVideo = False
            , showGvsNVideo = False
            , showFAQ = False
            , currentCardIndex = 0
            , showRatesVideo = False
            , key = key
            , showDiscount = False
            , currentCarrier = Nothing
            , planType = Nothing
            , dateOfBirth = Nothing
            , quoteId = Nothing
            , carrierContracts = []
            , currentDate = Nothing
            , orgId = Nothing
            , orgName = Nothing
            , orgLogo = Nothing
            , name = Nothing
            , contact = Nothing
            , agent = Nothing
            , orgSlug = Nothing
            , loadingContact = True
            , showDiscountInfo = False
            , showLocationModal = False
            , editingZipCode = Nothing
            , editingCounty = Nothing
            , availableCounties = []
            , locationUpdateError = Nothing
            , submittingLocation = False
            }
    in
    case maybeParams of
        Just params ->
            case params.quoteId of
                Just quoteId ->
                    -- We have a quote ID, fetch contact data
                    ( { emptyModel | quoteId = Just quoteId, orgId = params.orgId }
                    , Cmd.batch
                        [ fetchContactData quoteId
                        , Task.perform GotCurrentDate Date.today
                        ]
                    )

                Nothing ->
                    -- No quote ID, check if we have an org ID
                    case params.orgId of
                        Just orgId ->
                            -- Redirect to self-service onboarding
                            ( emptyModel
                            , Nav.pushUrl key ("/self-onboarding/" ++ orgId)
                            )

                        Nothing ->
                            -- No valid parameters
                            ( { emptyModel
                                | isLoading = False
                                , error = Just "Missing required parameters. Please provide either a quote ID or organization ID."
                              }
                            , Cmd.none
                            )

        Nothing ->
            -- No parameters provided
            ( { emptyModel
                | isLoading = False
                , error = Just "No parameters provided. Please provide either a quote ID or organization ID."
              }
            , Cmd.none
            )


defaultPlanType : Flags -> PlanType
defaultPlanType flags =
    case flags.planType of
        "G" ->
            PlanG

        "N" ->
            PlanN

        _ ->
            PlanG



-- HTTP


fetchContactData : String -> Cmd Msg
fetchContactData quoteId =
    Http.get
        { url = "/api/quotes/decode/" ++ quoteId
        , expect = Http.expectJson GotContactData contactResponseDecoder
        }


fetchPlans : Model -> Cmd Msg
fetchPlans model =
    case model.contact of
        Just contact ->
            Http.request
                { method = "POST"
                , headers = []
                , url = "/api/quotes"
                , body = Http.jsonBody (buildPlansBody contact)
                , expect = Http.expectJson GotPlans (plansDecoder model)
                , timeout = Nothing
                , tracker = Nothing
                }

        Nothing ->
            -- Don't fetch plans until we have contact data
            Cmd.none


buildPlansBody : Contact -> E.Value
buildPlansBody contact =
    E.object
        [ ( "zip_code", E.string contact.zipCode )
        , ( "state", E.string contact.state )
        , ( "county", E.string (Maybe.withDefault "" contact.county) )
        , ( "age", E.int contact.age )
        , ( "gender"
          , E.string
                (if contact.gender == "Male" then
                    "M"

                 else
                    "F"
                )
          )
        , ( "tobacco", E.bool contact.tobacco )
        , ( "plans", E.list E.string [ "G", "N" ] )
        , ( "carriers", E.string "supported" )
        ]


calculateAge : String -> Int
calculateAge dateOfBirth =
    -- TODO: Implement proper age calculation from dateOfBirth string
    -- For now, default to 65 which is the minimum age for Medicare
    65



-- DECODERS


plansDecoder : Model -> Decoder Plans
plansDecoder model =
    D.oneOf
        [ D.list quoteResponseDecoder
            |> D.map (\responses -> groupQuotesByPlan responses model)
        , D.succeed { planG = [], planN = [] }
        ]


type alias QuoteResponse =
    { naic : String
    , group : Int
    , companyName : String
    , quotes : List QuoteData
    }


type alias QuoteData =
    { rate : Float
    , discountRate : Float
    , discountCategory : Maybe String
    , age : Int
    , gender : String
    , plan : String
    , tobacco : Int
    }


quoteResponseDecoder : Decoder QuoteResponse
quoteResponseDecoder =
    D.map4 QuoteResponse
        (D.field "naic" D.string)
        (D.field "group" D.int)
        (D.field "company_name" D.string)
        (D.field "quotes" (D.list quoteDataDecoder))


quoteDataDecoder : Decoder QuoteData
quoteDataDecoder =
    D.map7 QuoteData
        (D.field "rate" D.float)
        (D.field "discount_rate" D.float)
        (D.field "discount_category" (D.nullable D.string))
        (D.field "age" D.int)
        (D.field "gender" D.string)
        (D.field "plan" D.string)
        (D.field "tobacco" D.int)


isCarrierSupported : String -> List Carrier -> Bool
isCarrierSupported naic carrierContracts =
    case naicToCarrier naic of
        Just carrierName ->
            List.member carrierName carrierContracts

        Nothing ->
            False


filterPlansByCarrier : Plans -> List Carrier -> Plans
filterPlansByCarrier plans carrierContracts =
    { planG = List.filter (\plan -> isCarrierSupported plan.naic carrierContracts) plans.planG
    , planN = List.filter (\plan -> isCarrierSupported plan.naic carrierContracts) plans.planN
    }


groupQuotesByPlan : List QuoteResponse -> Model -> Plans
groupQuotesByPlan responses model =
    let
        convertToPlan : QuoteResponse -> QuoteData -> Plan
        convertToPlan response quote =
            let
                carrierImagePath =
                    case naicToCarrier response.naic of
                        Just carrier ->
                            "/images/" ++ (carrier |> carrierToString |> String.filter (\c -> c /= ' ')) ++ ".svg"

                        Nothing ->
                            -- Fallback to png if we can't match the carrier
                            "/images/medicare-max-logo.png"
            in
            { price = quote.rate / 100
            , priceDiscount = quote.discountRate / 100
            , flag = quote.discountCategory
            , age = quote.age
            , description = ""
            , gender = quote.gender
            , id = 0
            , image = carrierImagePath
            , naic = response.naic
            , name = response.companyName
            , planType = quote.plan
            , premiumStability = ""
            , ratingCategory = ""
            , score = 0
            , select = False
            , state = Maybe.withDefault "" model.state
            , tobacco = quote.tobacco == 1
            , coverageSummary =
                if String.toUpper quote.plan == "G" then
                    planGCoverageList

                else
                    planNCoverageList
            }

        allQuotes =
            List.concatMap
                (\response ->
                    List.concatMap
                        (\quote ->
                            let
                                upperPlan =
                                    String.toUpper quote.plan
                            in
                            if List.member upperPlan [ "G", "N" ] then
                                [ convertToPlan response quote ]

                            else
                                []
                        )
                        response.quotes
                )
                responses

        planG =
            List.filter (\q -> String.toUpper q.planType == "G") allQuotes
                |> List.sortBy .price

        planN =
            List.filter (\q -> String.toUpper q.planType == "N") allQuotes
                |> List.sortBy .price

        result =
            { planG = planG
            , planN = planN
            }
    in
    result



-- COVERAGE LISTS


planGCoverageList : CoverageList
planGCoverageList =
    [ { name = "Part A Deductible", percentageCovered = 100, note = Nothing }
    , { name = "Hospital Co-Pays", percentageCovered = 100, note = Nothing }
    , { name = "Skilled Nursing Facility Co-Pays", percentageCovered = 100, note = Nothing }
    , { name = "Part B Annual Deductible", percentageCovered = 0, note = Just "$240 annual deductible" }
    , { name = "Part B Coinsurance", percentageCovered = 100, note = Nothing }
    , { name = "Excess Charges", percentageCovered = 100, note = Nothing }
    , { name = "Foreign Travel Emergency", percentageCovered = 80, note = Nothing }
    ]


planNCoverageList : CoverageList
planNCoverageList =
    [ { name = "Part A Deductible", percentageCovered = 100, note = Nothing }
    , { name = "Hospital Co-Pays", percentageCovered = 100, note = Nothing }
    , { name = "Skilled Nursing Facility Co-Pays", percentageCovered = 100, note = Nothing }
    , { name = "Part B Annual Deductible", percentageCovered = 0, note = Just "$240 annual deductible" }
    , { name = "Part B Coinsurance", percentageCovered = 100, note = Just "w/ some copayments" }
    , { name = "Excess Charges", percentageCovered = 0, note = Nothing }
    , { name = "Foreign Travel Emergency", percentageCovered = 80, note = Nothing }
    ]



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GotCarrierContracts (Ok carrierContracts) ->
            let
                updatedModel =
                    { model | carrierContracts = carrierContracts }
            in
            ( updatedModel
            , fetchPlans updatedModel
            )

        GotCarrierContracts (Err _) ->
            ( { model | error = Just "Failed to load organization settings" }
            , Cmd.none
            )

        ToggleDiscount ->
            ( { model | showDiscount = not model.showDiscount }
            , Cmd.none
            )

        ToggleDiscountInfo ->
            ( { model | showDiscountInfo = not model.showDiscountInfo }
            , Cmd.none
            )

        GotPlans result ->
            case result of
                Ok plansRaw ->
                    let
                        plans =
                            filterPlansByCarrier plansRaw model.carrierContracts

                        hasPlans =
                            not (List.isEmpty plans.planG && List.isEmpty plans.planN)

                        errorMsg =
                            if not hasPlans then
                                Just "No plans available for the selected criteria. Please try different parameters."

                            else
                                Nothing
                    in
                    ( { model
                        | plans = plans
                        , isLoading = False
                        , error = errorMsg
                      }
                    , Cmd.none
                    )

                Err error ->
                    let
                        detailedError =
                            case error of
                                Http.BadStatus 401 ->
                                    "Authentication error: Please check your session and try again."

                                Http.BadStatus 403 ->
                                    "Access forbidden: You don't have permission to access these quotes."

                                Http.BadStatus 500 ->
                                    "Server error: The quote service is experiencing issues. Please try again later."

                                Http.NetworkError ->
                                    "Network error: Please check your internet connection and try again."

                                Http.Timeout ->
                                    "Request timed out: The quote service took too long to respond. Please try again."

                                Http.BadUrl url ->
                                    "Invalid URL: " ++ url

                                Http.BadBody message ->
                                    "Invalid response format: " ++ message

                                _ ->
                                    httpErrorToString error
                    in
                    ( { model
                        | error = Just detailedError
                        , isLoading = False
                      }
                    , Cmd.none
                    )

        TogglePlanType ->
            ( { model
                | selectedPlanType = togglePlanType model.selectedPlanType
                , currentCardIndex = 0
                , selectedPlan = Nothing
              }
            , Cmd.none
            )

        SelectPlan plan ->
            ( { model | showQualificationVideo = True }
            , Cmd.batch
                [ Nav.pushUrl model.key
                    (case model.quoteId of
                        Just id ->
                            let
                                orgIdParam =
                                    case model.orgId of
                                        Just orgId ->
                                            "&orgId=" ++ orgId

                                        Nothing ->
                                            -- Try to extract orgId from the quoteId as a fallback
                                            case String.split "-" id |> List.head of
                                                Just extractedOrgId ->
                                                    "&orgId=" ++ extractedOrgId

                                                Nothing ->
                                                    ""
                            in
                            "/eligibility?id=" ++ id ++ orgIdParam

                        Nothing ->
                            let
                                orgIdParam =
                                    case model.orgId of
                                        Just orgId ->
                                            "?orgId=" ++ orgId

                                        Nothing ->
                                            ""
                            in
                            "/eligibility" ++ orgIdParam
                    )
                , Task.perform (\_ -> NoOp) (Dom.setViewport 0 0)
                ]
            )

        SelectPlanCard plan ->
            ( { model
                | selectedPlan =
                    if Just plan == model.selectedPlan then
                        Nothing
                        -- Deselect if clicking the same plan again

                    else
                        Just plan

                -- Otherwise select the new plan
              }
            , Cmd.none
            )

        ScrollDown viewport ->
            ( model, Cmd.none )

        CloseReviewVideo ->
            ( { model | showReviewVideo = False }
            , Cmd.none
            )

        OpenGvsNVideo ->
            ( { model | showGvsNVideo = True }, Cmd.none )

        CloseGvsNVideo ->
            ( { model | showGvsNVideo = False }, Cmd.none )

        ShowQualificationVideo ->
            ( { model | showQualificationVideo = True }
            , Cmd.none
            )

        CloseQualificationVideo ->
            ( { model | showQualificationVideo = False }
            , Nav.pushUrl model.key
                (let
                    orgIdParam =
                        case model.orgId of
                            Just orgId ->
                                "?orgId=" ++ orgId

                            Nothing ->
                                -- Try to extract orgId from the quoteId as a fallback
                                case model.quoteId of
                                    Just id ->
                                        case String.split "-" id |> List.head of
                                            Just extractedOrgId ->
                                                "?orgId=" ++ extractedOrgId

                                            Nothing ->
                                                ""

                                    Nothing ->
                                        ""
                 in
                 "/eligibility" ++ orgIdParam
                )
            )

        ShowFAQ ->
            ( { model | showFAQ = True }
            , Cmd.none
            )

        CloseFAQ ->
            ( { model | showFAQ = False }
            , Cmd.none
            )

        NextCard ->
            ( { model | currentCardIndex = Basics.min (model.currentCardIndex + 1) (List.length (getSelectedPlans model) - 1) }
            , Cmd.none
            )

        PreviousCard ->
            ( { model | currentCardIndex = Basics.max (model.currentCardIndex - 1) 0 }
            , Cmd.none
            )

        CloseRatesVideo ->
            ( { model | showRatesVideo = False }, Cmd.none )

        NavigateTo path ->
            ( model, Nav.pushUrl model.key path )

        GotCurrentDate date ->
            ( { model | currentDate = Just date }, Cmd.none )

        GotContactData result ->
            case result of
                Ok response ->
                    let
                        -- Update model with contact data
                        updatedModel =
                            { model
                                | contact = Just response.contact
                                , agent = Just response.agent
                                , orgSlug = Just response.orgSlug
                                , orgName = Just response.orgName
                                , orgLogo = response.orgLogo
                                , carrierContracts = response.carrierContracts
                                , loadingContact = False
                                , name = Just (response.contact.firstName ++ " " ++ response.contact.lastName)
                                , gender = Just response.contact.gender
                                , tobacco = Just response.contact.tobacco
                                , state = Just response.contact.state
                                , zip = Just response.contact.zipCode
                                , age = Just response.contact.age
                                , currentCarrier = response.contact.currentCarrier
                                , planType = response.contact.planType
                            }
                    in
                    ( updatedModel
                    , fetchPlans updatedModel
                    )

                Err error ->
                    ( { model
                        | error = Just "This quote link appears to be invalid or has expired. Please get a new quote to continue."
                        , loadingContact = False
                        , isLoading = False
                      }
                    , Cmd.none
                    )

        ShowLocationModal ->
            ( { model
                | showLocationModal = True
                , editingZipCode = model.zip
                , editingCounty = Nothing
                , availableCounties = []
                , locationUpdateError = Nothing
              }
            , Cmd.none
            )

        CloseLocationModal ->
            ( { model
                | showLocationModal = False
                , editingZipCode = Nothing
                , editingCounty = Nothing
                , availableCounties = []
                , locationUpdateError = Nothing
              }
            , Cmd.none
            )

        UpdateZipCode newZip ->
            ( { model | editingZipCode = Just newZip }
            , Cmd.none
            )

        UpdateCounty county ->
            ( { model | editingCounty = Just county }
            , Cmd.none
            )

        SubmitLocationUpdate ->
            case model.contact of
                Just contact ->
                    case model.orgSlug of
                        Just orgSlug ->
                            ( { model | submittingLocation = True, locationUpdateError = Nothing }
                            , Http.post
                                { url = "/api/self-service/update-location"
                                , body =
                                    Http.jsonBody
                                        (E.object
                                            [ ( "orgSlug", E.string orgSlug )
                                            , ( "contactId", E.string (String.fromInt contact.id) )
                                            , ( "zipCode", E.string (Maybe.withDefault "" model.editingZipCode) )
                                            , ( "county", E.string (Maybe.withDefault "" model.editingCounty) )
                                            ]
                                        )
                                , expect = Http.expectJson GotLocationUpdate locationUpdateResponseDecoder
                                }
                            )

                        Nothing ->
                            ( { model | locationUpdateError = Just "Organization ID not found" }
                            , Cmd.none
                            )

                Nothing ->
                    ( { model | locationUpdateError = Just "Contact information not found" }
                    , Cmd.none
                    )

        GotLocationUpdate result ->
            case result of
                Ok response ->
                    if response.success then
                        case response.counties of
                            [] ->
                                -- No counties returned, show error
                                ( { model
                                    | locationUpdateError = Just "No counties found for this ZIP code"
                                    , submittingLocation = False
                                  }
                                , Cmd.none
                                )

                            [ singleCounty ] ->
                                -- Only one county, use it and close modal
                                let
                                    -- Update contact with new location info
                                    updatedContact =
                                        model.contact
                                            |> Maybe.map
                                                (\contact ->
                                                    { contact
                                                        | zipCode = response.zipCode
                                                        , state = response.state
                                                        , county = Just singleCounty
                                                    }
                                                )

                                    updatedModel =
                                        { model
                                            | zip = Just response.zipCode
                                            , state = Just response.state
                                            , county = Just singleCounty
                                            , contact = updatedContact
                                            , showLocationModal = False
                                            , editingZipCode = Nothing
                                            , editingCounty = Nothing
                                            , availableCounties = []
                                            , locationUpdateError = Nothing
                                            , submittingLocation = False
                                        }
                                in
                                -- Reload the page to refresh everything
                                ( updatedModel
                                , Nav.reload
                                )

                            multipleCounties ->
                                -- Multiple counties, show dropdown
                                ( { model
                                    | availableCounties = multipleCounties
                                    , zip = Just response.zipCode
                                    , state = Just response.state
                                    , editingCounty = Nothing
                                    , submittingLocation = False
                                  }
                                , Cmd.none
                                )

                    else
                        ( { model
                            | locationUpdateError = Just "Failed to update location"
                            , submittingLocation = False
                          }
                        , Cmd.none
                        )

                Err error ->
                    ( { model
                        | locationUpdateError = Just (httpErrorToString error)
                        , submittingLocation = False
                      }
                    , Cmd.none
                    )

        NoOp ->
            ( model, Cmd.none )



-- HELPERS


togglePlanType : PlanType -> PlanType
togglePlanType planType =
    case planType of
        PlanG ->
            PlanN

        PlanN ->
            PlanG


getSelectedPlans : Model -> List Plan
getSelectedPlans model =
    let
        plans =
            case model.selectedPlan of
                Just plan ->
                    [ plan ]

                Nothing ->
                    case model.selectedPlanType of
                        PlanG ->
                            model.plans.planG

                        PlanN ->
                            model.plans.planN

        carrierNaics =
            model.currentCarrier
                |> Maybe.andThen stringToCarrier
                |> Maybe.map carrierToNaics

        filteredPlans =
            case carrierNaics of
                Just naicList ->
                    List.filter
                        (\plan ->
                            not (List.member plan.naic naicList)
                        )
                        plans

                Nothing ->
                    plans

        sortedAndLimited =
            List.sortBy .price filteredPlans
                |> List.take 3
    in
    sortedAndLimited



-- Get the top N cheapest plans for a specific plan type


getTopPlans : Model -> List Plan -> Int -> List Plan
getTopPlans model plans count =
    let
        carrierNaics =
            model.currentCarrier
                |> Maybe.andThen stringToCarrier
                |> Maybe.map carrierToNaics

        filteredPlans =
            case carrierNaics of
                Just naicList ->
                    List.filter
                        (\plan ->
                            not (List.member plan.naic naicList)
                        )
                        plans

                Nothing ->
                    plans
    in
    List.sortBy
        (\plan ->
            {--
            if model.showDiscount then
                plan.priceDiscount

            else
            --}
            plan.price
        )
        filteredPlans
        |> List.take count


httpErrorToString : Http.Error -> String
httpErrorToString error =
    case error of
        Http.BadUrl url ->
            "Bad URL: " ++ url ++ ". Please check the URL and try again."

        Http.Timeout ->
            "Request timed out. The server took too long to respond. Please try again later or check your internet connection."

        Http.NetworkError ->
            "Network error. Unable to connect to the server. Please check your internet connection and try again."

        Http.BadStatus statusCode ->
            "Bad status: " ++ String.fromInt statusCode ++ ". The server returned an unexpected status code. Please try again later or contact support if the issue persists."

        Http.BadBody message ->
            "Bad body: " ++ message ++ ". The server response was not in the expected format. Please try again or contact support if the issue persists."



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions model =
    let
        closeModalOnEscape : String -> Msg
        closeModalOnEscape key =
            if key == "Escape" then
                case model of
                    _ ->
                        if model.showLocationModal then
                            CloseLocationModal

                        else if model.showGvsNVideo then
                            CloseGvsNVideo

                        else if model.showQualificationVideo then
                            CloseQualificationVideo

                        else if model.showRatesVideo then
                            CloseRatesVideo

                        else if model.showFAQ then
                            CloseFAQ

                        else
                            NoOp

            else
                NoOp

        shouldListenForEscape =
            model.showLocationModal
                || model.showGvsNVideo
                || model.showQualificationVideo
                || model.showRatesVideo
                || model.showFAQ
    in
    if shouldListenForEscape then
        Browser.Events.onKeyDown
            (D.map closeModalOnEscape (D.field "key" D.string))

    else
        Sub.none



-- VIEW


viewPersonalInfo : Model -> Html Msg
viewPersonalInfo model =
    div [ class "flex flex-col gap-4 sm:gap-10" ]
        [ div [ class "bg-white rounded-[10px] border border-[#DCE2E5] shadow-[0_1px_2px_rgba(16,24,40,0.05)]" ]
            [ -- Personal Quote Header
              div
                [ class "border-b border-[#DCE2E5] bg-[#F9F5FF] px-4 sm:px-6 py-3 rounded-t-[10px]" ]
                [ h2 [ class "text-2xl font-extrabold tracking-tight leading-[2] -tracking-[0.04em]" ] [ text "Personal Quote" ]
                ]
            , div
                [ class "p-4 sm:p-6 flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4 sm:gap-6 bg-white rounded-b-[10px]" ]
                [ div [ class "flex flex-col sm:flex-row gap-4 sm:gap-12" ]
                    [ -- Quote For section
                      div [ class "flex flex-col" ]
                        [ div [ class "mb-2" ]
                            [ p [ class "text-sm text-[#667085] mb-1" ] [ text "Quote For" ]
                            , p [ class "text-[16px] font-medium" ] [ text (Maybe.withDefault "Loading..." model.name) ]
                            , p [ class "text-[12px] text-[#667085]" ]
                                [ text
                                    (if String.contains "F" (model.gender |> Maybe.withDefault "" |> String.toUpper) then
                                        "F"

                                     else
                                        "M"
                                    )
                                , span [ class "text-[#475569] mx-2 font-medium" ] [ text "│" ]
                                , text
                                    (if Maybe.withDefault False model.tobacco then
                                        "Tobacco"

                                     else
                                        "Non-Tobacco"
                                    )
                                , span [ class "text-[#475569] mx-2 font-medium" ] [ text "│" ]
                                , text (String.fromInt (Maybe.withDefault 0 model.age))
                                , text " years"
                                , span [ class "text-[#475569] mx-2 font-medium" ] [ text "│" ]
                                , text (Maybe.withDefault "" model.state)
                                , text " "
                                , text (Maybe.withDefault "" model.zip)
                                ]
                            ]
                        , div [ class "flex flex-col gap-2" ]
                            [ button [ class "text-xs text-[#2563EB] underline text-left", onClick ShowLocationModal ] [ text "Edit Location" ]
                            , div [ class "hidden sm:block" ]
                                [ div [ class "flex flex-col mt-4 gap-1" ]
                                    [ p [ class "text-xs text-[#667085]" ] [ text "Need a Quote for Someone else?" ]
                                    , a [ href ("/self-onboarding/" ++ Maybe.withDefault "" model.orgSlug), class "text-xs text-[#667085] underline" ] [ text "Start Here" ]
                                    ]
                                ]
                            ]
                        ]

                    -- Mobile divider
                    , div [ class "block sm:hidden h-[1px] bg-[#DCE2E5] my-4" ] []

                    -- Desktop divider
                    , div [ class "hidden sm:block w-[1px] bg-[#DCE2E5]" ] []

                    -- Quote From section
                    , div [ class "flex flex-col min-w-[200px]" ]
                        [ p [ class "text-sm text-[#667085] mb-1" ] [ text "Quote From" ]
                        , p [ class "text-[16px] font-medium mb-2" ]
                            [ text
                                (case model.agent of
                                    Just agent ->
                                        agent.firstName ++ " " ++ agent.lastName

                                    Nothing ->
                                        "Loading..."
                                )
                            ]
                        , div [ class "flex flex-col gap-3" ]
                            [ a
                                [ href
                                    (case model.agent of
                                        Just agent ->
                                            "mailto:" ++ agent.email

                                        Nothing ->
                                            "#"
                                    )
                                , class "flex items-center gap-1.5 bg-[#F9F5FF] px-2.5 py-2 rounded hover:bg-[#F4EBFF] transition-colors min-w-[200px] w-fit"
                                ]
                                [ svg [ Svg.Attributes.width "16", Svg.Attributes.height "16", Svg.Attributes.viewBox "0 0 12 12", Svg.Attributes.fill "none" ]
                                    [ path [ Svg.Attributes.d "M1 6C1 4.1145 1 3.1715 1.586 2.586C2.1715 2 3.1145 2 5 2H7C8.8855 2 9.8285 2 10.414 2.586C11 3.1715 11 4.1145 11 6C11 7.8855 11 8.8285 10.414 9.414C9.8285 10 8.8855 10 7 10H5C3.1145 10 2.1715 10 1.586 9.414C1 8.8285 1 7.8855 1 6Z", Svg.Attributes.stroke "#03045E" ] []
                                    , path [ Svg.Attributes.d "M3 4L4.0795 4.9C4.998 5.665 5.457 6.0475 6 6.0475C6.543 6.0475 7.0025 5.665 7.9205 4.8995L9 4", Svg.Attributes.stroke "#03045E", Svg.Attributes.strokeLinecap "round", Svg.Attributes.strokeLinejoin "round" ] []
                                    ]
                                , span [ class "text-sm text-[#03045E]" ]
                                    [ text
                                        (case model.agent of
                                            Just agent ->
                                                agent.email

                                            Nothing ->
                                                "Loading..."
                                        )
                                    ]
                                ]
                            , a
                                [ href
                                    (case model.agent of
                                        Just agent ->
                                            "tel:" ++ String.filter (\c -> c >= '0' && c <= '9') agent.phone

                                        Nothing ->
                                            "#"
                                    )
                                , class "flex items-center gap-1.5 bg-[#F9F5FF] px-2.5 py-2 rounded hover:bg-[#F4EBFF] transition-colors min-w-[200px] w-fit"
                                ]
                                [ svg [ Svg.Attributes.width "16", Svg.Attributes.height "16", Svg.Attributes.viewBox "0 0 12 12", Svg.Attributes.fill "none" ]
                                    [ path
                                        [ Svg.Attributes.fillRule "evenodd"
                                        , Svg.Attributes.clipRule "evenodd"
                                        , Svg.Attributes.d "M1.75442 1.13022C2.80442 0.0802194 4.57692 0.160219 5.30817 1.47022L5.7138 2.19709C6.19067 3.05209 5.98755 4.13147 5.2888 4.83897C5.24752 4.90156 5.22497 4.97463 5.2238 5.04959C5.21567 5.20959 5.27255 5.58022 5.84692 6.15397C6.42067 6.72772 6.79067 6.78522 6.9513 6.77709C7.02626 6.77592 7.09934 6.75337 7.16192 6.71209C7.8688 6.01334 8.9488 5.81022 9.8038 6.28709L10.5307 6.69334C11.8407 7.42459 11.9207 9.19584 10.8707 10.2465C10.3088 10.8077 9.56255 11.3071 8.68442 11.3402C7.38442 11.3896 5.22442 11.0533 3.08567 8.91522C0.947548 6.77647 0.611298 4.61709 0.660673 3.31647C0.693798 2.43834 1.19317 1.69147 1.75442 1.13022ZM4.48942 1.92709C4.11442 1.25584 3.10817 1.10209 2.41755 1.79334C1.93317 2.27772 1.61755 2.81209 1.59755 3.35147C1.5563 4.43647 1.82442 6.32772 3.7488 8.25147C5.6738 10.1765 7.56442 10.4446 8.6488 10.4033C9.18817 10.3827 9.7238 10.0677 10.2075 9.58334C10.8988 8.89209 10.745 7.88584 10.0738 7.51147L9.34692 7.10584C8.89505 6.85397 8.25942 6.93959 7.8138 7.38584C7.77005 7.42959 7.4913 7.68959 6.99692 7.71334C6.49067 7.73834 5.87755 7.51084 5.18442 6.81709C4.49005 6.12334 4.26255 5.51022 4.28755 5.00334C4.3113 4.50897 4.57192 4.23022 4.61505 4.18647C5.0613 3.74084 5.14692 3.10584 4.89505 2.65397L4.48942 1.92709Z"
                                        , Svg.Attributes.fill "#03045E"
                                        ]
                                        []
                                    ]
                                , span [ class "text-sm text-[#03045E]" ]
                                    [ text
                                        (case model.agent of
                                            Just agent ->
                                                formatPhoneNumber agent.phone

                                            Nothing ->
                                                "Loading..."
                                        )
                                    ]
                                ]
                            ]
                        ]

                    -- Desktop divider before video
                    , div [ class "hidden sm:block w-[1px] bg-[#DCE2E5]" ] []

                    -- Video button section
                    , div [ class "hidden sm:flex flex-col justify-center items-center cursor-pointer gap-2 bg-[#F9F5FF] rounded-[10px] p-4 border border-[#DCE2E5] min-w-[200px] min-h-[160px]", onClick OpenGvsNVideo ]
                        [ p [ class "text-base font-bold text-[#03045E] -tracking-[0.03em] leading-[1.21] text-center" ] [ text "Learn About Plan G vs Plan N" ]
                        , div [ class "w-[33px] h-[33px] rounded-full border border-[#03045E] flex items-center justify-center" ]
                            [ div [ class "w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#03045E] border-b-[8px] border-b-transparent ml-1" ] []
                            ]
                        , p [ class "text-xs text-[#667085] -tracking-[0.03em] leading-[1.21] text-center" ] [ text "Watch the Video" ]
                        ]
                    ]
                ]
            , div [ class "block sm:hidden mt-2 mb-6 justify-center flex items-center w-full" ]
                [ div [ class "text-sm text-[#667085] text-center flex flex-wrap justify-center items-center gap-1" ]
                    [ text "Need a Quote for Someone else? "
                    , a [ href ("/self-onboarding/" ++ Maybe.withDefault "" model.orgSlug), class " underline" ] [ text "Start Here" ]
                    ]
                ]
            ]
        ]


viewPlanCard : Model -> String -> Plan -> Html Msg
viewPlanCard model planTypeCode plan =
    let
        isSelected =
            model.selectedPlan == Just plan

        ( badgeTextColor, badgeBgColor ) =
            if planTypeCode == "G" then
                ( "text-[#363F72]", "bg-[#F8F9FC]" )

            else
                ( "text-[#363F72]", "bg-[#F8F9FC]" )

        borderClass =
            if isSelected then
                "border-2 border-[#2563EB]"

            else
                "border border-[#D4D4D4]"
    in
    div [ class "flex flex-col" ]
        [ div
            [ class ("relative bg-white rounded-lg " ++ borderClass ++ " overflow-hidden cursor-pointer w-[calc(100vw-72px)] sm:w-[340px]")
            , onClick (SelectPlanCard plan)
            ]
            [ -- Top row with Plan type badge and radio
              div [ class "flex items-center justify-between p-2 sm:p-4" ]
                [ div [ class ("px-2.5 py-0.5 rounded-lg text-xs font-medium leading-5 " ++ badgeTextColor ++ " " ++ badgeBgColor) ]
                    [ text ("PLAN " ++ planTypeCode) ]
                , div [ class "flex items-center gap-1.5" ]
                    [ span [ class "text-sm sm:text-sm font-medium text-[#667085]" ] [ text "Select This Plan" ]
                    , if isSelected then
                        svg [ Svg.Attributes.width "18", Svg.Attributes.height "19", Svg.Attributes.viewBox "0 0 14 15", Svg.Attributes.fill "none" ]
                            [ Svg.rect [ Svg.Attributes.x "0.5", Svg.Attributes.y "1", Svg.Attributes.width "13", Svg.Attributes.height "13", Svg.Attributes.rx "6.5", Svg.Attributes.fill "#F9F5FF" ] []
                            , Svg.rect [ Svg.Attributes.x "0.5", Svg.Attributes.y "1", Svg.Attributes.width "13", Svg.Attributes.height "13", Svg.Attributes.rx "6.5", Svg.Attributes.stroke "#7F56D9" ] []
                            , Svg.path [ Svg.Attributes.d "M10.5 5.25L6 9.75L3.5 7.25", Svg.Attributes.stroke "#7F56D9", Svg.Attributes.strokeWidth "1.6666", Svg.Attributes.strokeLinecap "round", Svg.Attributes.strokeLinejoin "round" ] []
                            ]

                      else
                        svg [ Svg.Attributes.width "18", Svg.Attributes.height "19", Svg.Attributes.viewBox "0 0 14 15", Svg.Attributes.fill "none" ]
                            [ Svg.rect [ Svg.Attributes.x "0.5", Svg.Attributes.y "1", Svg.Attributes.width "13", Svg.Attributes.height "13", Svg.Attributes.rx "6.5", Svg.Attributes.fill "white" ] []
                            , Svg.rect [ Svg.Attributes.x "0.5", Svg.Attributes.y "1", Svg.Attributes.width "13", Svg.Attributes.height "13", Svg.Attributes.rx "6.5", Svg.Attributes.stroke "#D4D4D4" ] []
                            ]
                    ]
                ]

            -- Carrier Logo
            , div [ class "px-4 flex justify-center items-center min-h-[120px] py-4" ]
                [ img [ src plan.image, alt (plan.name ++ " logo"), class "h-20 max-w-[240px] object-contain" ] [] ]

            -- Rates
            , div [ class "flex justify-between items-center px-6 py-4 bg-[#F9FAFB]" ]
                [ div [ class "flex items-center" ]
                    [ span [ class "text-sm font-medium text-[#667085]" ] [ text "Standard:" ]
                    , span [ class "text-lg font-bold text-[#667085] ml-1" ] [ text ("$" ++ String.fromInt (floor plan.price)) ]
                    ]
                , div [ class "flex items-center" ]
                    [ div [ class "w-[1px] h-[24px] bg-[#DCE2E5] mx-4" ] [] ]
                , div [ class "flex items-center" ]
                    [ span [ class "text-sm font-medium text-[#667085]" ] [ text "Discount:" ]
                    , span [ class "text-lg font-bold text-[#667085] ml-1" ] [ text ("$" ++ String.fromInt (floor plan.priceDiscount)) ]
                    ]
                ]
            ]
        , div
            [ class
                ("overflow-hidden transition-all duration-300 ease-in-out "
                    ++ (if isSelected then
                            "max-h-[100px] opacity-100 mt-8 mb-8"

                        else
                            "max-h-0 opacity-0 mt-0 mb-0"
                       )
                )
            ]
            [ div [ class "flex justify-center" ]
                [ button
                    [ class "w-[200px] bg-[#03045E] text-white text-sm font-medium px-4 py-4 rounded-lg hover:bg-[#02034D] transition-colors"
                    , onClick (SelectPlan plan)
                    ]
                    [ text "See if I Qualify" ]
                ]
            ]
        ]


viewPlansSection : Model -> Html Msg
viewPlansSection model =
    div [ class "bg-white rounded-[10px] border border-[#DCE2E5] shadow-[0_1px_2px_rgba(16,24,40,0.05)]" ]
        [ -- Header (desktop only)
          div [ class "hidden sm:flex px-4 sm:px-6 py-4 flex-row items-center justify-between border-b border-[#DCE2E5] bg-[#F9F5FF] rounded-t-[10px]" ]
            [ div [ class "flex items-end gap-3" ]
                [ h2 [ class "text-2xl font-extrabold -tracking-[0.04em] text-[#101828] leading-[1.2]" ] [ text "Recommended Plans for You" ]
                , p [ class "text-[16px] font-medium text-[#667085] -tracking-[0.04em] leading-[1.2] pb-[2px]" ] [ text "Select one to see if you qualify" ]
                ]
            ]

        -- Mobile header
        , div [ class "block sm:hidden px-4 py-4 border-b border-[#DCE2E5] bg-[#F9F5FF] rounded-t-[10px]" ]
            [ h2 [ class "text-2xl font-extrabold -tracking-[0.04em] text-[#101828] leading-[1.2]" ] [ text "Recommended Plans" ]
            , p [ class "text-[16px] font-medium text-[#667085] -tracking-[0.04em] leading-[1.2]" ] [ text "Select one to continue" ]
            ]

        -- Plan G Section
        , div [ class "px-3 sm:px-4 py-6 bg-white" ]
            [ h3 [ class "text-xl font-extrabold -tracking-[0.02em] mb-6 text-[#101828]" ] [ text "Plan G Monthly Premiums" ]
            , div [ class "flex flex-wrap gap-8 justify-center sm:justify-start sm:pl-8" ]
                (List.map (viewPlanCard model "G") (getTopPlans model model.plans.planG 3))
            ]

        -- Plan N Section
        , div [ class "px-3 sm:px-4 py-6 bg-white" ]
            [ h3 [ class "text-xl font-extrabold -tracking-[0.02em] mb-6 text-[#101828]" ] [ text "Plan N Monthly Premiums" ]
            , div [ class "flex flex-wrap gap-8 justify-center sm:justify-start sm:pl-8" ]
                (List.map (viewPlanCard model "N") (getTopPlans model model.plans.planN 3))
            ]
        ]


view : Model -> Browser.Document Msg
view model =
    { title = "Quote - Medicare Max"
    , body =
        [ viewHeader model.orgLogo model.orgName
        , div [ class "bg-white min-h-screen pb-12 scroll-smooth" ]
            [ if model.loadingContact || model.isLoading then
                viewLoading

              else
                div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 space-y-8 sm:space-y-10" ]
                    [ -- Personal Quote Card
                      viewPersonalInfo model

                    -- Mobile video button
                    , div [ class "block sm:hidden mt-8 sm:mt-0" ]
                        [ div [ class "mx-auto max-w-[280px] bg-[#F9F5FF] rounded-[10px] p-4 flex flex-row items-center cursor-pointer gap-4 border border-[#DCE2E5]", onClick OpenGvsNVideo ]
                            [ div [ class "w-[33px] h-[33px] rounded-full border border-[#03045E] flex items-center justify-center flex-shrink-0" ]
                                [ div [ class "w-0 h-0 border-t-[8px] border-t-transparent border-l-[12px] border-l-[#03045E] border-b-[8px] border-b-transparent ml-1" ] []
                                ]
                            , div [ class "flex flex-col items-start" ]
                                [ p [ class "text-[16px] font-bold text-[#03045E] -tracking-[0.03em] leading-[1.21] text-left" ] [ text "Learn About Plan G vs N" ]
                                , p [ class "text-[12px] text-[#667085] -tracking-[0.03em] leading-[1.21]" ] [ text "Watch the Video" ]
                                ]
                            ]
                        ]

                    -- Plans Section
                    , viewPlansSection model
                    ]
            ]
        , viewGvsNModal model
        , viewQualificationModal model
        , viewRatesModal model
        , viewLocationModal model
        ]
    }


viewLoading : Html Msg
viewLoading =
    div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-4 text-center" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-purple-600 border-t-transparent" ] []
        , p [ class "text-center text-lg font-medium text-gray-600" ]
            [ text "Loading your personalized quote..." ]
        ]


viewError : String -> Maybe String -> Html Msg
viewError error orgSlug =
    div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-6 text-center px-4" ]
        [ div [ class "max-w-lg" ]
            [ h1 [ class "text-2xl font-semibold text-[#1A1A1A] mb-4" ]
                [ text "Unable to Load Quote" ]
            , p [ class "text-lg text-gray-600 mb-8" ]
                [ text "This quote link appears to be invalid or has expired. Please get a new quote to continue." ]
            , case orgSlug of
                Just slug ->
                    a
                        [ href ("/self-onboarding/" ++ slug)
                        , class "inline-block bg-[#03045E] text-white text-sm font-medium px-6 py-3 rounded hover:bg-[#02034D] transition-colors"
                        ]
                        [ text "Get a New Quote" ]

                Nothing ->
                    text ""
            ]
        ]


viewGvsNModal : Model -> Html Msg
viewGvsNModal model =
    if model.showGvsNVideo then
        div [ class "fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm" ]
            [ div [ class "bg-white rounded-lg p-4 sm:p-8 w-[95%] max-w-5xl mx-auto shadow-lg relative" ]
                [ button
                    [ class "absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl p-1"
                    , onClick CloseGvsNVideo
                    ]
                    [ text "×" ]
                , h2 [ class "text-xl sm:text-2xl font-bold mb-2 sm:mb-4 text-center" ] [ text "Plan G vs. Plan N" ]
                , p [ class "mb-2 sm:mb-4 text-center text-sm sm:text-base" ] [ text "Understanding the differences" ]
                , p [ class "mb-3 sm:mb-4 text-center text-sm sm:text-base" ] [ text "Watch this video to learn about the key differences between Plan G and Plan N" ]
                , div [ class "w-full max-w-3xl mx-auto" ]
                    [ div [ class "relative", style "padding-top" "100%" ]
                        [ iframe
                            [ src "https://player.vimeo.com/video/1018402330?autoplay=0&title=0&byline=0&portrait=0&responsive=1"
                            , class "w-full h-full absolute top-0 left-0"
                            , attribute "frameborder" "0"
                            , attribute "allow" "autoplay; fullscreen; picture-in-picture"
                            , attribute "allowfullscreen" ""
                            ]
                            []
                        ]
                    ]
                ]
            ]

    else
        text ""


viewQualificationModal : Model -> Html Msg
viewQualificationModal model =
    if model.showQualificationVideo then
        div [ class "fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm" ]
            [ div [ class "bg-white rounded-lg p-4 sm:p-8 w-[95%] max-w-5xl mx-auto shadow-lg" ]
                [ button
                    [ class "absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl p-1"
                    , onClick CloseQualificationVideo
                    ]
                    [ text "×" ]
                , h1 [ class "text-xl sm:text-2xl font-bold mb-2 sm:mb-4 text-center" ] [ text "Great Choice!" ]
                , h2 [ class "text-lg sm:text-xl font-bold mb-2 sm:mb-4 text-center" ] [ text "Now let's see if you qualify" ]
                , p [ class "mb-3 sm:mb-4 text-center text-sm sm:text-base" ] [ text "Watch this video to understand the process of qualifying for the plan you selected" ]
                , div [ class "w-full max-w-3xl mx-auto" ]
                    [ div [ class "relative", style "padding-top" "100%" ]
                        [ iframe
                            [ src "https://player.vimeo.com/video/1018421414?autoplay=0&title=0&byline=0&portrait=0&responsive=1"
                            , class "w-full h-full absolute top-0 left-0"
                            , attribute "frameborder" "0"
                            , attribute "allow" "autoplay; fullscreen; picture-in-picture"
                            , attribute "allowfullscreen" ""
                            ]
                            []
                        ]
                    ]
                , button
                    [ class "bg-purple-500 text-white px-4 sm:px-6 py-2 rounded hover:bg-purple-600 mt-4 w-full sm:w-auto"
                    , onClick CloseQualificationVideo
                    ]
                    [ text "Continue" ]
                ]
            ]

    else
        text ""


viewRatesModal : Model -> Html Msg
viewRatesModal model =
    if model.showRatesVideo then
        let
            rateText =
                case List.head (getSelectedPlans model) of
                    Just plan ->
                        "$" ++ String.fromFloat plan.price

                    Nothing ->
                        ""

            countyText =
                Maybe.withDefault "" model.county

            stateText =
                Maybe.withDefault "" model.state

            planTypeText =
                case model.selectedPlanType of
                    PlanG ->
                        "Plan G"

                    PlanN ->
                        "Plan N"
        in
        div [ class "fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm" ]
            [ div [ class "bg-white rounded-lg p-4 sm:p-8 w-[95%] max-w-5xl mx-auto shadow-lg" ]
                [ button
                    [ class "absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl p-1"
                    , onClick CloseRatesVideo
                    ]
                    [ text "×" ]
                , h1 [ class "text-xl sm:text-2xl font-bold mb-2 sm:mb-4 text-center" ] [ text "Good News!" ]
                , h2 [ class "text-base sm:text-xl font-bold mb-2 sm:mb-4 text-center leading-tight" ]
                    [ text ("We found " ++ planTypeText ++ " options as low as " ++ rateText ++ " in " ++ countyText ++ " County, " ++ stateText) ]
                , p [ class "mb-3 sm:mb-4 text-center text-sm sm:text-base" ] [ text "Watch this quick video for 3 things to consider while reviewing your quotes" ]
                , div [ class "w-full max-w-3xl mx-auto" ]
                    [ div [ class "relative", style "padding-top" "100%" ]
                        [ iframe
                            [ src "https://player.vimeo.com/video/1018421439?autoplay=0&title=0&byline=0&portrait=0&responsive=1"
                            , class "w-full h-full absolute top-0 left-0"
                            , attribute "frameborder" "0"
                            , attribute "allow" "autoplay; fullscreen; picture-in-picture"
                            , attribute "allowfullscreen" ""
                            ]
                            []
                        ]
                    ]
                , button
                    [ class "bg-purple-500 text-white px-4 sm:px-6 py-2 rounded hover:bg-purple-600 mt-4 w-full sm:w-auto"
                    , onClick CloseRatesVideo
                    ]
                    [ text "Continue" ]
                ]
            ]

    else
        text ""


viewLocationModal : Model -> Html Msg
viewLocationModal model =
    if model.showLocationModal then
        div [ class "fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm" ]
            [ div [ class "bg-white rounded-lg p-6 w-[95%] max-w-md mx-auto shadow-lg" ]
                [ div [ class "flex justify-between items-center mb-4" ]
                    [ h2 [ class "text-xl font-extrabold -tracking-[0.04em] text-[#101828]" ] [ text "Update Location" ]
                    , button
                        [ class "text-[#667085] hover:text-[#101828] transition-colors"
                        , onClick CloseLocationModal
                        ]
                        [ text "×" ]
                    ]
                , div [ class "mb-4" ]
                    [ label [ class "block text-sm font-medium text-[#667085] mb-1" ]
                        [ text "ZIP Code" ]
                    , input
                        [ type_ "text"
                        , class "w-full px-3 py-2 border border-[#DCE2E5] rounded-md focus:outline-none focus:ring-1 focus:ring-[#03045E] focus:border-[#03045E]"
                        , value (Maybe.withDefault "" model.editingZipCode)
                        , onInput UpdateZipCode
                        , maxlength 5
                        , pattern "[0-9]*"
                        ]
                        []
                    ]
                , if not (List.isEmpty model.availableCounties) then
                    div [ class "mb-4" ]
                        [ label [ class "block text-sm font-medium text-[#667085] mb-1" ]
                            [ text "County" ]
                        , select
                            [ class "w-full px-3 py-2 border border-[#DCE2E5] rounded-md focus:outline-none focus:ring-1 focus:ring-[#03045E] focus:border-[#03045E]"
                            , onInput UpdateCounty
                            , value (Maybe.withDefault "" model.editingCounty)
                            ]
                            (option [ value "" ] [ text "Select a county" ]
                                :: List.map
                                    (\county ->
                                        option [ value county ]
                                            [ text county ]
                                    )
                                    model.availableCounties
                            )
                        ]

                  else
                    text ""
                , if model.locationUpdateError /= Nothing then
                    div [ class "mb-4 text-red-600 text-sm" ]
                        [ text (Maybe.withDefault "" model.locationUpdateError) ]

                  else
                    text ""
                , div [ class "flex justify-end gap-3" ]
                    [ button
                        [ class "px-4 py-2 text-[#667085] hover:text-[#101828] transition-colors"
                        , onClick CloseLocationModal
                        ]
                        [ text "Cancel" ]
                    , button
                        [ class "px-4 py-2 bg-[#03045E] text-white rounded hover:bg-[#02034D] transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center min-w-[80px]"
                        , onClick SubmitLocationUpdate
                        , disabled
                            (String.length (Maybe.withDefault "" model.editingZipCode)
                                /= 5
                                || (not (List.isEmpty model.availableCounties)
                                        && Maybe.withDefault "" model.editingCounty
                                        == ""
                                   )
                                || model.submittingLocation
                            )
                        ]
                        [ if model.submittingLocation then
                            div [ class "animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2" ] []

                          else
                            text ""
                        , text
                            (if model.submittingLocation then
                                "Updating..."

                             else
                                "Update"
                            )
                        ]
                    ]
                ]
            ]

    else
        text ""


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        cleanPhone =
            String.filter (\c -> c >= '0' && c <= '9') phone
    in
    String.slice 0 3 cleanPhone ++ "-" ++ String.slice 3 6 cleanPhone ++ "-" ++ String.slice 6 10 cleanPhone


contactResponseDecoder : Decoder ContactResponse
contactResponseDecoder =
    D.map6 ContactResponse
        (D.field "contact" contactDecoder)
        (D.field "agent" agentDecoder)
        (D.field "orgSlug" D.string)
        (D.field "orgName" D.string)
        (D.field "orgLogo" (D.nullable D.string))
        (D.field "carrierContracts" (D.list carrierDecoder))


contactDecoder : Decoder Contact
contactDecoder =
    D.succeed Contact
        |> Pipeline.required "id" D.int
        |> Pipeline.required "firstName" D.string
        |> Pipeline.required "lastName" D.string
        |> Pipeline.required "email" D.string
        |> Pipeline.required "phoneNumber" D.string
        |> Pipeline.required "age" D.int
        |> Pipeline.required "gender" D.string
        |> Pipeline.required "tobacco" D.bool
        |> Pipeline.required "state" D.string
        |> Pipeline.required "zipCode" D.string
        |> Pipeline.optional "county" (D.nullable D.string) Nothing
        |> Pipeline.optional "currentCarrier" (D.nullable D.string) Nothing
        |> Pipeline.optional "planType" (D.nullable D.string) Nothing


agentDecoder : Decoder Agent
agentDecoder =
    D.map4 Agent
        (D.field "firstName" D.string)
        (D.field "lastName" D.string)
        (D.field "email" D.string)
        (D.field "phone" D.string)


locationUpdateResponseDecoder : Decoder LocationUpdateResponse
locationUpdateResponseDecoder =
    D.map4 LocationUpdateResponse
        (D.field "success" D.bool)
        (D.field "zipCode" D.string)
        (D.field "state" D.string)
        (D.field "counties" (D.list D.string))

================
File: src/Contact.elm
================
module Contact exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Events
import Browser.Navigation as Nav
import Date exposing (Date)
import Dict exposing (Dict)
import EmailScheduler exposing (EmailSchedule, PlanType(..), ScheduledEmail, getScheduledEmails, init, viewFutureActivity)
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onBlur, onClick, onInput, onSubmit)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Process
import Task
import Time exposing (Month(..), Posix, Zone)
import Utils.MyDate exposing (dateFromMonthDayYear)



-- TYPES


type alias Contact =
    { id : Int
    , firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , contactOwnerId : Maybe Int
    , contactOwner : Maybe User
    , currentCarrier : String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : Bool
    , gender : String
    , zipCode : String
    , planType : String
    , status : String
    , agentId : Maybe Int
    , lastEmailed : Maybe String
    }


type alias User =
    { id : Int
    , email : String
    , firstName : String
    , lastName : String
    , isAdmin : Bool
    , isAgent : Bool
    , organizationId : Int
    , isActive : Bool
    , phone : String
    }


type alias ContactForm =
    { id : Maybe Int
    , firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , contactOwnerId : Maybe Int
    , currentCarrier : String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : Bool
    , gender : String
    , zipCode : String
    , planType : String
    }


emptyForm : ContactForm
emptyForm =
    { id = Nothing
    , firstName = ""
    , lastName = ""
    , email = ""
    , phoneNumber = ""
    , state = ""
    , contactOwnerId = Nothing
    , currentCarrier = ""
    , effectiveDate = ""
    , birthDate = ""
    , tobaccoUser = False
    , gender = "M"
    , zipCode = ""
    , planType = ""
    }



-- MODEL


type alias Activity =
    { submissionDate : String
    , status : ActivityStatus
    , carrierSelected : Maybe String
    , planSelected : Maybe String
    , quoteAmount : Maybe Float
    }


type ActivityStatus
    = QuoteCreated
    | EmailOpened
    | EmailSent Int -- Int represents which email number (1, 2, etc.)


type QuestionType
    = MainQuestion
    | FollowUpQuestion Int -- Parent question ID


type alias EligibilityQuestion =
    { id : Int
    , text : String
    , questionType : QuestionType
    , answer : Maybe (Either Bool String)
    }


type Either a b
    = Left a
    | Right b


type Modal
    = NoModal
    | EditModal
    | DeleteConfirmModal
    | HealthAssessmentModal


type alias Model =
    { key : Nav.Key
    , contact : Maybe Contact
    , showModal : Modal
    , editForm : ContactForm
    , isSubmittingForm : Bool
    , error : Maybe String
    , activities : List Activity
    , isCheckingEmail : Bool
    , emailExists : Bool
    , isDeletingContact : Bool
    , emailSchedule : EmailSchedule
    , quoteUrl : Maybe String
    , isGeneratingQuote : Bool
    , healthStatus : Maybe HealthStatus
    , eligibilityQuestions : List EligibilityQuestion
    , followUps : List FollowUpRequest
    , timeZone : Zone
    , showAllFollowUps : Bool
    , orgSettings : Maybe Settings
    , emailSendSuccess : Bool
    }


type alias HealthStatus =
    { status : String
    , answers : Maybe String
    }


type alias FollowUpRequest =
    { type_ : String
    , quoteId : String
    , createdAt : Posix
    }


type alias Settings =
    { stateLicenses : List String
    , carrierContracts : List String
    , stateCarrierSettings : List StateCarrierSetting
    , allowAgentSettings : Bool
    , emailSendBirthday : Bool
    , emailSendPolicyAnniversary : Bool
    , emailSendAep : Bool
    , smartSendEnabled : Bool
    }


type alias StateCarrierSetting =
    { state : String
    , carrier : String
    , active : Bool
    , targetGI : Bool
    }



-- DECODERS


contactDecoder : Decoder Contact
contactDecoder =
    Decode.succeed Contact
        |> Pipeline.required "id" Decode.int
        |> Pipeline.required "first_name" Decode.string
        |> Pipeline.required "last_name" Decode.string
        |> Pipeline.required "email" Decode.string
        |> Pipeline.optional "phone_number" Decode.string ""
        |> Pipeline.required "state" Decode.string
        |> Pipeline.optional "contact_owner_id" (Decode.nullable Decode.int) Nothing
        |> Pipeline.optional "contact_owner" (Decode.nullable userDecoder) Nothing
        |> Pipeline.required "current_carrier" Decode.string
        |> Pipeline.required "effective_date" Decode.string
        |> Pipeline.required "birth_date" Decode.string
        |> Pipeline.required "tobacco_user" Decode.bool
        |> Pipeline.required "gender" Decode.string
        |> Pipeline.required "zip_code" Decode.string
        |> Pipeline.required "plan_type" Decode.string
        |> Pipeline.optional "status" Decode.string "New"
        |> Pipeline.required "agent_id" (Decode.nullable Decode.int)
        |> Pipeline.optional "last_emailed_date" (Decode.nullable Decode.string) Nothing


userDecoder : Decoder User
userDecoder =
    Decode.succeed User
        |> Pipeline.required "id" Decode.int
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "first_name" Decode.string
        |> Pipeline.required "last_name" Decode.string
        |> Pipeline.required "is_admin" Decode.bool
        |> Pipeline.required "is_agent" Decode.bool
        |> Pipeline.required "organization_id" Decode.int
        |> Pipeline.required "is_active" Decode.bool
        |> Pipeline.required "phone" Decode.string


healthStatusDecoder : Decoder HealthStatus
healthStatusDecoder =
    Decode.map2 HealthStatus
        (Decode.field "status" Decode.string)
        (Decode.field "answers" (Decode.nullable Decode.string))


settingsDecoder : Decoder Settings
settingsDecoder =
    Decode.field "success" Decode.bool
        |> Decode.andThen
            (\success ->
                if success then
                    Decode.field "orgSettings" settingsObjectDecoder

                else
                    Decode.fail "Settings request was not successful"
            )


settingsObjectDecoder : Decoder Settings
settingsObjectDecoder =
    Decode.map8 Settings
        (Decode.field "stateLicenses" (Decode.list Decode.string))
        (Decode.field "carrierContracts" (Decode.list Decode.string))
        (Decode.field "stateCarrierSettings" (Decode.list stateCarrierSettingDecoder))
        (Decode.field "allowAgentSettings" Decode.bool)
        (Decode.field "emailSendBirthday" Decode.bool)
        (Decode.field "emailSendPolicyAnniversary" Decode.bool)
        (Decode.field "emailSendAep" Decode.bool)
        (Decode.field "smartSendEnabled" Decode.bool)


stateCarrierSettingDecoder : Decoder StateCarrierSetting
stateCarrierSettingDecoder =
    Decode.map4 StateCarrierSetting
        (Decode.field "state" Decode.string)
        (Decode.field "carrier" Decode.string)
        (Decode.field "active" Decode.bool)
        (Decode.field "targetGI" Decode.bool)



-- INIT


type alias ZipInfo =
    { state : String
    , counties : List String
    , cities : List String
    }


init : Nav.Key -> String -> ( Model, Cmd Msg )
init key contactId =
    let
        initialSchedule =
            EmailScheduler.init
                (String.toInt contactId |> Maybe.withDefault 0)
                (Date.fromCalendarDate 2024 Jan 1)
                (Date.fromCalendarDate 2024 Jan 1)
                (Date.fromCalendarDate 2024 Jan 1)
                NoPlan
                ""
                -- Empty initial state
                []
                -- Empty initial state carrier settings
                []

        -- Empty initial state licenses
    in
    ( { key = key
      , contact = Nothing
      , showModal = NoModal
      , editForm = emptyForm
      , isSubmittingForm = False
      , error = Nothing
      , activities = []
      , isCheckingEmail = False
      , emailExists = False
      , isDeletingContact = False
      , emailSchedule = initialSchedule
      , quoteUrl = Nothing
      , isGeneratingQuote = False
      , healthStatus = Nothing
      , eligibilityQuestions = []
      , followUps = []
      , timeZone = Time.utc
      , showAllFollowUps = False
      , orgSettings = Nothing
      , emailSendSuccess = False
      }
    , Cmd.batch
        [ Http.get
            { url = "/api/contacts/" ++ contactId
            , expect = Http.expectJson GotContact contactDecoder
            }
        , Http.get
            { url = "/api/contacts/" ++ contactId ++ "/eligibility"
            , expect = Http.expectJson GotHealthStatus healthStatusDecoder
            }
        , Http.get
            { url = "/api/contacts/" ++ contactId ++ "/follow-ups"
            , expect = Http.expectJson GotFollowUps followUpsDecoder
            }
        , Task.perform GotCurrentTime Date.today
        , Task.perform GotTimeZone Time.here
        ]
    )



-- UPDATE


type Msg
    = NoOp
    | GotContact (Result Http.Error Contact)
    | GotCurrentTime Date
    | GotTimeZone Zone
    | ShowEditModal
    | CloseModal
    | BackToContacts
    | UpdateEditForm ContactFormField String
    | SubmitEditForm
    | ContactUpdated (Result Http.Error Contact)
    | CheckEmail String
    | EmailChecked (Result Http.Error { exists : Bool })
    | LookupZipCode String
    | GotZipLookup (Result Http.Error ZipInfo)
    | ShowDeleteConfirmModal
    | DeleteContact
    | ContactDeleted (Result Http.Error DeleteResponse)
    | GenerateQuoteLink
    | GotQuoteLink (Result Http.Error { quoteId : String, redirectUrl : String })
    | GotHealthStatus (Result Http.Error HealthStatus)
    | ShowHealthAssessmentModal
    | GotFollowUps (Result Http.Error (List FollowUpRequest))
    | ToggleFollowUps
    | GotOrgSettings (Result Http.Error Settings)
    | SendQuoteEmail
    | QuoteEmailSent (Result Http.Error { success : Bool, message : String })
    | ResetEmailSendState


type ContactFormField
    = FirstName
    | LastName
    | Email
    | PhoneNumber
    | State
    | ContactOwnerId
    | CurrentCarrier
    | EffectiveDate
    | BirthDate
    | TobaccoUser
    | Gender
    | ZipCode
    | PlanType


safeStringToDate : String -> Result String Date
safeStringToDate dateString =
    case Date.fromIsoString dateString of
        Ok date ->
            Ok date

        Err error ->
            case dateFromMonthDayYear dateString of
                Ok date ->
                    Ok date

                Err _ ->
                    Err error


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )

        GotContact (Ok contact) ->
            case safeStringToDate contact.effectiveDate of
                Ok effectiveDate ->
                    case safeStringToDate contact.birthDate of
                        Ok birthDate ->
                            let
                                planType =
                                    case contact.planType of
                                        "Plan N" ->
                                            PlanN

                                        "N" ->
                                            PlanN

                                        "Plan G" ->
                                            PlanG

                                        "G" ->
                                            PlanG

                                        _ ->
                                            NoPlan

                                ( stateCarrierSettings, stateLicenses ) =
                                    case model.orgSettings of
                                        Just settings ->
                                            ( settings.stateCarrierSettings, settings.stateLicenses )

                                        Nothing ->
                                            ( [], [] )

                                newSchedule =
                                    EmailScheduler.init
                                        contact.id
                                        effectiveDate
                                        birthDate
                                        model.emailSchedule.currentDate
                                        planType
                                        contact.state
                                        stateCarrierSettings
                                        stateLicenses
                            in
                            ( { model | contact = Just contact, emailSchedule = newSchedule }
                            , Cmd.batch
                                [ Http.get
                                    { url = "/api/quotes/generate/" ++ String.fromInt contact.id
                                    , expect = Http.expectJson GotQuoteLink quoteLinkDecoder
                                    }
                                , Http.get
                                    { url = "/api/settings"
                                    , expect = Http.expectJson GotOrgSettings settingsDecoder
                                    }
                                ]
                            )

                        Err _ ->
                            ( { model | error = Just "Invalid birth date format" }, Cmd.none )

                Err _ ->
                    ( { model | error = Just "Invalid effective date format" }, Cmd.none )

        GotContact (Err error) ->
            case error of
                Http.BadStatus 404 ->
                    ( { model | error = Just "Contact not found" }
                    , Cmd.none
                    )

                _ ->
                    ( { model | error = Just "Failed to load contact" }
                    , Cmd.none
                    )

        GotCurrentTime today ->
            let
                currentSchedule =
                    model.emailSchedule

                newSchedule =
                    { currentSchedule | currentDate = today }
            in
            ( { model | emailSchedule = newSchedule }
            , Cmd.none
            )

        GotTimeZone zone ->
            ( { model | timeZone = zone }, Cmd.none )

        ShowEditModal ->
            case model.contact of
                Just contact ->
                    ( { model
                        | showModal = EditModal
                        , editForm =
                            { id = Just contact.id
                            , firstName = contact.firstName
                            , lastName = contact.lastName
                            , email = contact.email
                            , phoneNumber = contact.phoneNumber
                            , state = contact.state
                            , contactOwnerId = contact.contactOwnerId
                            , currentCarrier = contact.currentCarrier
                            , effectiveDate = contact.effectiveDate
                            , birthDate = contact.birthDate
                            , tobaccoUser = contact.tobaccoUser
                            , gender = contact.gender
                            , zipCode = contact.zipCode
                            , planType = contact.planType
                            }
                      }
                    , Cmd.none
                    )

                Nothing ->
                    ( model, Cmd.none )

        CloseModal ->
            ( { model | showModal = NoModal }, Cmd.none )

        BackToContacts ->
            ( model, Nav.pushUrl model.key "/contacts" )

        UpdateEditForm field value ->
            let
                form =
                    model.editForm

                updatedForm =
                    case field of
                        FirstName ->
                            { form | firstName = value }

                        LastName ->
                            { form | lastName = value }

                        Email ->
                            { form | email = value }

                        PhoneNumber ->
                            { form | phoneNumber = String.filter Char.isDigit value |> String.left 10 }

                        State ->
                            { form | state = value }

                        ContactOwnerId ->
                            { form | contactOwnerId = String.toInt value }

                        CurrentCarrier ->
                            { form | currentCarrier = value }

                        EffectiveDate ->
                            { form | effectiveDate = value }

                        BirthDate ->
                            { form | birthDate = value }

                        TobaccoUser ->
                            { form | tobaccoUser = value == "true" }

                        Gender ->
                            { form | gender = value }

                        ZipCode ->
                            { form | zipCode = value }

                        PlanType ->
                            { form | planType = value }

                cmd =
                    if field == ZipCode && String.length value == 5 then
                        LookupZipCode value
                            |> Task.succeed
                            |> Task.perform identity

                    else if field == Email && String.length value > 0 then
                        checkEmail value

                    else
                        Cmd.none
            in
            ( { model
                | editForm = updatedForm
                , isCheckingEmail = field == Email && String.length value > 0
                , emailExists = False
                , error = Nothing
              }
            , cmd
            )

        SubmitEditForm ->
            case model.editForm.id of
                Just id ->
                    ( { model | isSubmittingForm = True }
                    , Http.request
                        { method = "PUT"
                        , headers = []
                        , url = "/api/contacts/" ++ String.fromInt id
                        , body = Http.jsonBody (encodeContactForm model.editForm)
                        , expect = Http.expectJson ContactUpdated contactDecoder
                        , timeout = Nothing
                        , tracker = Nothing
                        }
                    )

                Nothing ->
                    ( model, Cmd.none )

        ContactUpdated (Ok contact) ->
            ( { model
                | contact = Just contact
                , showModal = NoModal
                , isSubmittingForm = False
                , error = Nothing
              }
            , Cmd.none
            )

        ContactUpdated (Err _) ->
            ( { model
                | isSubmittingForm = False
                , error = Just "Failed to update contact"
              }
            , Cmd.none
            )

        CheckEmail email ->
            ( { model | isCheckingEmail = True }
            , checkEmail email
            )

        EmailChecked (Ok response) ->
            ( { model
                | isCheckingEmail = False
                , emailExists = response.exists
                , error =
                    if response.exists then
                        Just "A contact with this email already exists"

                    else
                        Nothing
              }
            , Cmd.none
            )

        EmailChecked (Err _) ->
            ( { model
                | isCheckingEmail = False
                , error = Just "Failed to check email. Please try again."
              }
            , Cmd.none
            )

        LookupZipCode zipCode ->
            ( model
            , Http.get
                { url = "/api/zip-lookup/" ++ zipCode
                , expect = Http.expectJson GotZipLookup zipInfoDecoder
                }
            )

        GotZipLookup (Ok zipInfo) ->
            let
                form =
                    model.editForm

                updatedForm =
                    { form | state = zipInfo.state }
            in
            ( { model | editForm = updatedForm }
            , Cmd.none
            )

        GotZipLookup (Err _) ->
            ( model, Cmd.none )

        ShowDeleteConfirmModal ->
            ( { model | showModal = DeleteConfirmModal }, Cmd.none )

        DeleteContact ->
            case model.contact of
                Just contact ->
                    ( { model | isDeletingContact = True }
                    , deleteContact contact.id
                    )

                Nothing ->
                    ( model, Cmd.none )

        ContactDeleted (Ok response) ->
            if response.success then
                ( model, Nav.pushUrl model.key "/contacts" )

            else
                ( { model | isDeletingContact = False, error = Just "Failed to delete contact" }, Cmd.none )

        ContactDeleted (Err _) ->
            ( { model | isDeletingContact = False, error = Just "Failed to delete contact" }, Cmd.none )

        GenerateQuoteLink ->
            case model.contact of
                Just contact ->
                    ( { model | isGeneratingQuote = True }
                    , Http.get
                        { url = "/api/quotes/generate/" ++ String.fromInt contact.id
                        , expect = Http.expectJson GotQuoteLink quoteLinkDecoder
                        }
                    )

                Nothing ->
                    ( model, Cmd.none )

        GotQuoteLink (Ok response) ->
            ( { model
                | quoteUrl =
                    case model.contact of
                        Just contact ->
                            let
                                orgId : Maybe String
                                orgId =
                                    response.quoteId
                                        |> String.split "-"
                                        |> List.head

                                outStr : String
                                outStr =
                                    "/compare?id=" ++ response.quoteId
                            in
                            Just outStr

                        Nothing ->
                            Just ("/compare?id=" ++ response.quoteId)
                , isGeneratingQuote = False
              }
            , Cmd.none
            )

        GotQuoteLink (Err _) ->
            ( { model
                | error = Just "Failed to generate quote link"
                , isGeneratingQuote = False
              }
            , Cmd.none
            )

        GotHealthStatus (Ok status) ->
            let
                parsedQuestions =
                    case status.answers of
                        Just answersJson ->
                            parseEligibilityAnswers answersJson

                        Nothing ->
                            []
            in
            ( { model
                | healthStatus = Just status
                , eligibilityQuestions = parsedQuestions
              }
            , Cmd.none
            )

        GotHealthStatus (Err _) ->
            ( model, Cmd.none )

        ShowHealthAssessmentModal ->
            ( { model | showModal = HealthAssessmentModal }, Cmd.none )

        GotFollowUps (Ok followUps) ->
            ( { model | followUps = followUps }
            , Cmd.none
            )

        GotFollowUps (Err _) ->
            ( model, Cmd.none )

        ToggleFollowUps ->
            ( { model | showAllFollowUps = not model.showAllFollowUps }, Cmd.none )

        GotOrgSettings (Ok settings) ->
            let
                currentSchedule =
                    model.emailSchedule

                updatedSchedule =
                    { currentSchedule
                        | stateCarrierSettings = settings.stateCarrierSettings
                        , stateLicenses = settings.stateLicenses
                    }
            in
            ( { model | orgSettings = Just settings, emailSchedule = updatedSchedule }
            , Cmd.none
            )

        GotOrgSettings (Err _) ->
            ( { model | error = Just "Failed to load organization settings" }
            , Cmd.none
            )

        SendQuoteEmail ->
            case model.contact of
                Just contact ->
                    let
                        orgId =
                            contact.contactOwner
                                |> Maybe.map (\owner -> owner.organizationId)
                                |> Maybe.withDefault 0

                        encodedBody =
                            Encode.object
                                [ ( "orgId", Encode.int orgId ) ]
                    in
                    ( { model | isGeneratingQuote = True, emailSendSuccess = False }
                    , Http.post
                        { url = "/api/contacts/" ++ String.fromInt contact.id ++ "/send-quote-email"
                        , body = Http.jsonBody encodedBody
                        , expect =
                            Http.expectJson QuoteEmailSent
                                (Decode.map2 (\s m -> { success = s, message = m })
                                    (Decode.field "success" Decode.bool)
                                    (Decode.field "message" Decode.string)
                                )
                        }
                    )

                Nothing ->
                    ( model, Cmd.none )

        QuoteEmailSent (Ok response) ->
            ( { model
                | isGeneratingQuote = False
                , emailSendSuccess = response.success
                , error =
                    if response.success then
                        Nothing

                    else
                        Just response.message
              }
            , if response.success then
                Process.sleep 5000
                    |> Task.perform (\_ -> ResetEmailSendState)

              else
                Cmd.none
            )

        QuoteEmailSent (Err _) ->
            ( { model
                | isGeneratingQuote = False
                , emailSendSuccess = False
                , error = Just "Failed to send quote email"
              }
            , Cmd.none
            )

        ResetEmailSendState ->
            ( { model | emailSendSuccess = False }, Cmd.none )



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Contact Details"
    , body =
        [ div [ class "min-h-screen bg-white" ]
            [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" ]
                [ viewBackButton
                , case model.contact of
                    Just contact ->
                        div []
                            [ viewHeader contact model
                            , viewContactSummary contact model.quoteUrl model.isGeneratingQuote model.healthStatus model.eligibilityQuestions model.followUps model.timeZone model.showAllFollowUps
                            , if model.orgSettings /= Nothing && isStateActive model.emailSchedule then
                                div [ class "bg-white rounded-lg border border-gray-200 p-6 mb-8" ]
                                    [ viewFutureActivity (getScheduledEmails model.emailSchedule) ]

                              else
                                div [ class "bg-white rounded-lg border border-gray-200 p-6 mb-8" ]
                                    [ h2 [ class "text-lg font-medium mb-4" ] [ text "Future Activity" ]
                                    , div [ class "flex justify-center items-center py-8" ]
                                        [ viewSpinner
                                        , span [ class "ml-3 text-gray-500" ] [ text "Loading future activities..." ]
                                        ]
                                    ]
                            , viewActivity model.activities
                            ]

                    Nothing ->
                        case model.error of
                            Just errorMsg ->
                                div [ class "text-center py-12" ]
                                    [ div [ class "text-red-600 text-lg mb-4" ] [ text errorMsg ]
                                    , button
                                        [ class "px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200"
                                        , onClick BackToContacts
                                        ]
                                        [ text "Back to Contacts" ]
                                    ]

                            Nothing ->
                                viewLoading
                ]
            ]
        , viewModals model
        ]
    }


viewBackButton : Html Msg
viewBackButton =
    button
        [ class "mb-6 inline-flex items-center text-sm text-gray-600 hover:text-gray-900"
        , onClick BackToContacts
        ]
        [ span [ class "mr-2" ] [ text "←" ]
        , text "Back to Contacts"
        ]


viewHeader : Contact -> Model -> Html Msg
viewHeader contact model =
    div [ class "flex justify-between items-center mb-8" ]
        [ div [ class "flex items-center gap-4" ]
            [ h1 [ class "text-2xl font-semibold" ]
                [ text (contact.firstName ++ " " ++ contact.lastName) ]
            , viewStatus contact.status
            ]
        , div [ class "flex gap-2" ]
            [ button
                [ class "px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors duration-200 flex items-center gap-2"
                , onClick
                    (if model.isGeneratingQuote || model.emailSendSuccess then
                        NoOp

                     else
                        SendQuoteEmail
                    )
                ]
                (if model.isGeneratingQuote then
                    [ viewSpinner
                    , text "Sending..."
                    ]

                 else if model.emailSendSuccess then
                    [ span [ class "text-green-600" ] [ text "✓" ]
                    , text "Email Sent"
                    ]

                 else
                    [ text "Send Quote Email" ]
                )
            , button
                [ class "px-4 py-2 text-sm font-medium text-purple-600 hover:text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors duration-200 flex items-center gap-2"
                , onClick ShowEditModal
                ]
                [ text "Edit" ]
            , button
                [ class "px-4 py-2 text-sm font-medium text-red-600 hover:text-red-700 bg-red-50 hover:bg-red-100 rounded-lg transition-colors duration-200 flex items-center gap-2"
                , onClick ShowDeleteConfirmModal
                ]
                [ text "Delete" ]
            ]
        ]


viewContactSummary : Contact -> Maybe String -> Bool -> Maybe HealthStatus -> List EligibilityQuestion -> List FollowUpRequest -> Zone -> Bool -> Html Msg
viewContactSummary contact quoteUrl isGeneratingQuote healthStatus eligibilityQuestions followUps zone showAllFollowUps =
    let
        followUpsSection =
            if not (List.isEmpty followUps) then
                div [ class "bg-white rounded-lg border border-gray-200 p-6 mb-8" ]
                    [ div [ class "flex justify-between items-center mb-6" ]
                        [ h2 [ class "text-lg font-medium" ] [ text "Follow-up Requests" ] ]
                    , div [ class "space-y-4" ]
                        (List.take
                            (if showAllFollowUps then
                                List.length followUps

                             else
                                2
                            )
                            followUps
                            |> List.map (viewFollowUpRequest zone)
                        )
                    , if not showAllFollowUps && List.length followUps > 2 then
                        div [ class "mt-4 text-center" ]
                            [ button
                                [ class "text-sm text-purple-600 hover:text-purple-800"
                                , onClick ToggleFollowUps
                                ]
                                [ text ("Show " ++ String.fromInt (List.length followUps - 2) ++ " More") ]
                            ]

                      else if showAllFollowUps then
                        div [ class "mt-4 text-center" ]
                            [ button
                                [ class "text-sm text-purple-600 hover:text-purple-800"
                                , onClick ToggleFollowUps
                                ]
                                [ text "Show Less" ]
                            ]

                      else
                        text ""
                    ]

            else
                text ""
    in
    div []
        [ div [ class "bg-white rounded-lg border border-gray-200 p-6 mb-8" ]
            [ h2 [ class "text-lg font-medium mb-6" ] [ text "Contact Summary" ]
            , div [ class "grid grid-cols-2 gap-x-8 gap-y-6" ]
                [ viewField "Date of Birth" contact.birthDate
                , viewField "Contact Owner" (Maybe.map .firstName contact.contactOwner |> Maybe.withDefault "Default")
                , viewField "Phone Number" (formatPhoneNumber contact.phoneNumber)
                , viewField "Email" contact.email
                , viewField "Current Carrier" contact.currentCarrier
                , viewField "Gender" contact.gender
                , viewField "Tobacco Use"
                    (if contact.tobaccoUser then
                        "Yes"

                     else
                        "No"
                    )
                , viewField "State" contact.state
                , viewField "Zip Code" contact.zipCode
                , viewField "Effective Date" contact.effectiveDate
                , viewField "Plan Type" contact.planType
                , viewQuoteField quoteUrl isGeneratingQuote
                , viewHealthStatusField healthStatus eligibilityQuestions
                ]
            ]
        , followUpsSection
        ]


viewQuoteField : Maybe String -> Bool -> Html Msg
viewQuoteField quoteUrl isGeneratingQuote =
    div []
        [ div [ class "text-sm font-medium text-gray-500" ] [ text "Quote Link" ]
        , div [ class "mt-1" ]
            [ case quoteUrl of
                Just url ->
                    a
                        [ href url
                        , class "text-sm text-blue-600 hover:text-blue-800 underline"
                        , target "_blank"
                        ]
                        [ text "View Quote" ]

                Nothing ->
                    if isGeneratingQuote then
                        viewSpinner

                    else
                        text "-"
            ]
        ]


viewHealthStatusField : Maybe HealthStatus -> List EligibilityQuestion -> Html Msg
viewHealthStatusField maybeStatus questions =
    div []
        [ div [ class "text-sm font-medium text-gray-500" ] [ text "Health Status" ]
        , div [ class "mt-1" ]
            [ case maybeStatus of
                Just status ->
                    let
                        hasYesAnswers =
                            List.any
                                (\q ->
                                    case q.answer of
                                        Just (Left True) ->
                                            q.questionType == MainQuestion

                                        _ ->
                                            False
                                )
                                questions
                    in
                    div [ class "flex items-center" ]
                        [ if hasYesAnswers then
                            div [ class "flex items-center text-red-600 text-sm" ]
                                [ span [ class "mr-1" ] [ text "✕" ]
                                , text "Issue Flagged"
                                ]

                          else
                            div [ class "flex items-center text-green-600 text-sm" ]
                                [ span [ class "mr-1" ] [ text "✓" ]
                                , text "Pass"
                                ]
                        , button
                            [ class "ml-3 text-blue-600 text-sm hover:text-blue-800 underline"
                            , onClick ShowHealthAssessmentModal
                            ]
                            [ text "View Details" ]
                        ]

                Nothing ->
                    div [ class "text-gray-600 text-sm" ]
                        [ text "Loading..." ]
            ]
        ]


viewField : String -> String -> Html Msg
viewField label value =
    div []
        [ div [ class "text-sm font-medium text-gray-500" ] [ text label ]
        , div [ class "mt-1 text-sm text-gray-900" ] [ text value ]
        ]


viewActivity : List Activity -> Html Msg
viewActivity activities =
    div [ class "bg-white rounded-lg border border-gray-200 p-6" ]
        [ h2 [ class "text-lg font-medium mb-6" ] [ text "Past Activity" ]
        , table [ class "min-w-full" ]
            [ thead [ class "bg-gray-50" ]
                [ tr []
                    [ th [ class "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" ] [ text "Submission Date" ]
                    , th [ class "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" ] [ text "Status" ]
                    , th [ class "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" ] [ text "Carrier Selected" ]
                    , th [ class "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" ] [ text "Plan Selected" ]
                    , th [ class "px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase" ] [ text "Quote Amount" ]
                    ]
                ]
            , tbody [ class "divide-y divide-gray-200" ]
                (List.map viewActivityRow activities)
            ]
        ]


viewActivityRow : Activity -> Html Msg
viewActivityRow activity =
    tr [ class "hover:bg-gray-50" ]
        [ td [ class "px-3 py-2 text-sm text-gray-900" ] [ text activity.submissionDate ]
        , td [ class "px-3 py-2 text-sm" ] [ viewActivityStatus activity.status ]
        , td [ class "px-3 py-2 text-sm text-gray-900" ] [ text (Maybe.withDefault "-" activity.carrierSelected) ]
        , td [ class "px-3 py-2 text-sm text-gray-900" ] [ text (Maybe.withDefault "-" activity.planSelected) ]
        , td [ class "px-3 py-2 text-sm text-gray-900" ]
            [ text
                (activity.quoteAmount
                    |> Maybe.map (\amount -> "$" ++ String.fromFloat amount)
                    |> Maybe.withDefault "-"
                )
            ]
        ]


viewActivityStatus : ActivityStatus -> Html Msg
viewActivityStatus status =
    let
        ( bgColor, textColor, statusText ) =
            case status of
                QuoteCreated ->
                    ( "bg-green-50", "text-green-700", "Quote Created" )

                EmailOpened ->
                    ( "bg-red-50", "text-red-700", "Email Opened" )

                EmailSent n ->
                    ( "bg-blue-50", "text-blue-700", "Email #" ++ String.fromInt n ++ " Sent" )
    in
    div [ class ("inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium " ++ bgColor ++ " " ++ textColor) ]
        [ text statusText ]


viewStatus : String -> Html Msg
viewStatus status =
    let
        ( bgColor, textColor ) =
            case status of
                "Quote Created" ->
                    ( "bg-green-50", "text-green-700" )

                "Opened Email" ->
                    ( "bg-red-50", "text-red-700" )

                "Email #2 Sent" ->
                    ( "bg-blue-50", "text-blue-700" )

                "Email #1 Sent" ->
                    ( "bg-blue-50", "text-blue-700" )

                "In Queue" ->
                    ( "bg-orange-50", "text-orange-700" )

                _ ->
                    ( "bg-gray-50", "text-gray-700" )
    in
    div [ class ("inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium " ++ bgColor ++ " " ++ textColor) ]
        [ text status ]


viewModals : Model -> Html Msg
viewModals model =
    case model.showModal of
        NoModal ->
            text ""

        EditModal ->
            viewEditModal model

        DeleteConfirmModal ->
            viewDeleteConfirmModal model

        HealthAssessmentModal ->
            viewHealthAssessmentModal model


viewEditModal : Model -> Html Msg
viewEditModal model =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-8" ]
        [ div [ class "bg-white rounded-xl p-10 max-w-5xl w-full mx-4 shadow-xl relative" ]
            [ button
                [ class "absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ text "×" ]
            , h2 [ class "text-2xl font-semibold text-gray-900 mb-8" ]
                [ text "Edit Contact" ]
            , viewContactForm model.editForm model.isSubmittingForm model
            ]
        ]


viewContactForm : ContactForm -> Bool -> Model -> Html Msg
viewContactForm form isSubmitting model =
    Html.form [ onSubmit SubmitEditForm ]
        [ div [ class "grid grid-cols-2 gap-x-8 gap-y-6" ]
            [ viewFormInput "First Name" "text" form.firstName FirstName True model
            , viewFormInput "Last Name" "text" form.lastName LastName True model
            , viewFormInput "Email" "email" form.email Email True model
            , viewFormInput "Phone Number" "text" (formatPhoneNumber form.phoneNumber) PhoneNumber True model
            , viewFormInput "Current Carrier" "text" form.currentCarrier CurrentCarrier True model
            , viewFormInput "Plan Type" "text" form.planType PlanType True model
            , viewFormInput "Effective Date" "date" form.effectiveDate EffectiveDate True model
            , viewFormInput "Birth Date" "date" form.birthDate BirthDate True model
            , viewFormRadioGroup "Tobacco User"
                (if form.tobaccoUser then
                    "true"

                 else
                    "false"
                )
                TobaccoUser
                [ ( "true", "Yes" ), ( "false", "No" ) ]
            , viewFormRadioGroup "Gender" form.gender Gender [ ( "M", "Male" ), ( "F", "Female" ) ]
            , div [ class "col-span-2 grid grid-cols-2 gap-x-8" ]
                [ viewFormInput "ZIP Code" "text" form.zipCode ZipCode True model
                , viewFormInput "State" "text" form.state State True model
                ]
            ]
        , div [ class "mt-10 flex justify-end space-x-4" ]
            [ button
                [ type_ "button"
                , onClick CloseModal
                , class "px-6 py-3 bg-white text-gray-700 text-sm font-medium rounded-lg border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors duration-200 focus:ring-4 focus:ring-purple-100"
                ]
                [ text "Cancel" ]
            , if isSubmitting then
                div [ class "px-6 py-3 flex items-center space-x-2" ] [ viewSpinner ]

              else
                button
                    [ type_ "submit"
                    , class "px-6 py-3 bg-purple-500 text-white text-sm font-medium rounded-lg hover:bg-purple-600 transition-colors duration-200 focus:ring-4 focus:ring-purple-200"
                    ]
                    [ text "Save Changes" ]
            ]
        ]


viewFormInput : String -> String -> String -> ContactFormField -> Bool -> Model -> Html Msg
viewFormInput labelText inputType inputValue field isRequired model =
    div [ class "form-group" ]
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-2" ]
            [ text labelText ]
        , if field == Email then
            div [ class "relative" ]
                [ Html.input
                    [ type_ inputType
                    , class
                        ("w-full px-4 py-3 bg-white border-[2.5px] rounded-lg text-gray-700 placeholder-gray-400 shadow-sm transition-all duration-200 "
                            ++ (if model.emailExists then
                                    "border-red-300 hover:border-red-400 focus:border-red-500 focus:ring-2 focus:ring-red-200"

                                else
                                    "border-purple-300 hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200"
                               )
                        )
                    , Html.Attributes.value inputValue
                    , onInput (UpdateEditForm field)
                    , onBlur (CheckEmail inputValue)
                    , required isRequired
                    ]
                    []
                , if model.isCheckingEmail then
                    div [ class "absolute right-3 top-3" ]
                        [ viewSpinner ]

                  else if model.emailExists then
                    div [ class "absolute right-3 top-3 text-red-500" ]
                        [ text "✕" ]

                  else if String.length inputValue > 0 then
                    div [ class "absolute right-3 top-3 text-green-500" ]
                        [ text "✓" ]

                  else
                    text ""
                ]

          else if field == State then
            Html.input
                [ type_ inputType
                , class "w-full px-4 py-3 bg-white border-[2.5px] border-gray-200 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200"
                , Html.Attributes.value inputValue
                , Html.Attributes.disabled True
                , required isRequired
                ]
                []

          else
            Html.input
                [ type_ inputType
                , class "w-full px-4 py-3 bg-white border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200"
                , Html.Attributes.value inputValue
                , onInput (UpdateEditForm field)
                , required isRequired
                ]
                []
        ]


viewFormRadioGroup : String -> String -> ContactFormField -> List ( String, String ) -> Html Msg
viewFormRadioGroup labelText selectedValue field options =
    div [ class "form-group" ]
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-2" ]
            [ text labelText ]
        , div [ class "flex gap-4" ]
            (List.map
                (\( val, txt ) ->
                    label
                        [ class
                            ("flex items-center px-4 py-2 rounded-lg border-2 cursor-pointer transition-all duration-200 "
                                ++ (if selectedValue == val then
                                        "border-purple-500 bg-purple-50 text-purple-700"

                                    else
                                        "border-gray-200 hover:border-purple-200"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value val
                            , checked (selectedValue == val)
                            , onInput (UpdateEditForm field)
                            , class "sr-only"
                            ]
                            []
                        , text txt
                        ]
                )
                options
            )
        ]


encodeContactForm : ContactForm -> Encode.Value
encodeContactForm form =
    Encode.object
        [ ( "first_name", Encode.string form.firstName )
        , ( "last_name", Encode.string form.lastName )
        , ( "email", Encode.string form.email )
        , ( "phone_number", Encode.string (String.filter Char.isDigit form.phoneNumber |> String.left 10) )
        , ( "state", Encode.string form.state )
        , ( "contact_owner_id", Maybe.map Encode.int form.contactOwnerId |> Maybe.withDefault Encode.null )
        , ( "current_carrier", Encode.string form.currentCarrier )
        , ( "effective_date", Encode.string form.effectiveDate )
        , ( "birth_date", Encode.string form.birthDate )
        , ( "tobacco_user", Encode.bool form.tobaccoUser )
        , ( "gender", Encode.string form.gender )
        , ( "zip_code", Encode.string form.zipCode )
        , ( "plan_type", Encode.string form.planType )
        ]


viewLoading : Html Msg
viewLoading =
    div [ class "flex justify-center items-center h-64" ]
        [ div [ class "animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent" ] [] ]


viewSpinner : Html msg
viewSpinner =
    div [ class "animate-spin rounded-full h-5 w-5 border-2 border-purple-500 border-t-transparent" ] []


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    if String.isEmpty phone then
        ""

    else
        let
            digits =
                String.filter Char.isDigit phone
                    |> String.left 10

            len =
                String.length digits
        in
        if len == 0 then
            ""

        else if len <= 3 then
            "(" ++ digits

        else if len <= 6 then
            "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

        else
            "(" ++ String.left 3 digits ++ ") " ++ String.slice 3 6 digits ++ "-" ++ String.dropLeft 6 digits



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions model =
    if model.showModal /= NoModal then
        Browser.Events.onKeyDown
            (Decode.map
                (\key ->
                    if key == "Escape" then
                        CloseModal

                    else
                        NoOp
                )
                (Decode.field "key" Decode.string)
            )

    else
        Sub.none


checkEmail : String -> Cmd Msg
checkEmail email =
    Http.get
        { url = "/api/contacts/check-email/" ++ email
        , expect = Http.expectJson EmailChecked (Decode.map (\exists -> { exists = exists }) (Decode.field "exists" Decode.bool))
        }


lookupZipCode : String -> Cmd Msg
lookupZipCode zipCode =
    Http.get
        { url = "/api/zip-lookup/" ++ zipCode
        , expect = Http.expectJson GotZipLookup zipInfoDecoder
        }


zipInfoDecoder : Decode.Decoder ZipInfo
zipInfoDecoder =
    Decode.succeed ZipInfo
        |> Pipeline.required "state" Decode.string
        |> Pipeline.required "counties" (Decode.list Decode.string)
        |> Pipeline.required "cities" (Decode.list Decode.string)


deleteContact : Int -> Cmd Msg
deleteContact contactId =
    Http.request
        { method = "DELETE"
        , headers = []
        , url = "/api/contacts"
        , body = Http.jsonBody (Encode.list Encode.int [ contactId ])
        , expect = Http.expectJson ContactDeleted deleteResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


type alias DeleteResponse =
    { success : Bool
    , deletedIds : List Int
    , message : String
    }


deleteResponseDecoder : Decode.Decoder DeleteResponse
deleteResponseDecoder =
    Decode.map3 DeleteResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "deleted_ids" (Decode.list Decode.int))
        (Decode.field "message" Decode.string)


viewDeleteConfirmModal : Model -> Html Msg
viewDeleteConfirmModal model =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-8" ]
        [ div [ class "bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-xl relative" ]
            [ button
                [ class "absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ text "×" ]
            , h2 [ class "text-xl font-semibold text-gray-900 mb-4" ]
                [ text "Delete Contact" ]
            , p [ class "text-sm text-gray-600 mb-6" ]
                [ text "Are you sure you want to delete this contact? This action cannot be undone." ]
            , div [ class "flex justify-end space-x-4" ]
                [ button
                    [ class "px-4 py-2 text-gray-700 text-sm font-medium rounded-lg border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors duration-200"
                    , onClick CloseModal
                    ]
                    [ text "Cancel" ]
                , if model.isDeletingContact then
                    div [ class "px-4 py-2 flex items-center" ]
                        [ viewSpinner ]

                  else
                    button
                        [ class "px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors duration-200"
                        , onClick DeleteContact
                        ]
                        [ text "Delete" ]
                ]
            ]
        ]


quoteLinkDecoder : Decode.Decoder { quoteId : String, redirectUrl : String }
quoteLinkDecoder =
    Decode.map2 (\id url -> { quoteId = id, redirectUrl = url })
        (Decode.field "quoteId" Decode.string)
        (Decode.field "redirectUrl" Decode.string)


followUpsDecoder : Decoder (List FollowUpRequest)
followUpsDecoder =
    Decode.list
        (Decode.map3 FollowUpRequest
            (Decode.field "type" Decode.string)
            (Decode.field "quoteId" Decode.string)
            (Decode.field "createdAt" posixDecoder)
        )


posixDecoder : Decoder Posix
posixDecoder =
    Decode.string
        |> Decode.andThen
            (\str ->
                let
                    parts =
                        String.split " " str

                    datePart =
                        List.head parts |> Maybe.withDefault ""

                    timePart =
                        List.drop 1 parts |> List.head |> Maybe.withDefault ""

                    dateParts =
                        String.split "-" datePart

                    year =
                        List.head dateParts |> Maybe.andThen String.toInt |> Maybe.withDefault 1970

                    month =
                        List.drop 1 dateParts |> List.head |> Maybe.andThen String.toInt |> Maybe.withDefault 1

                    day =
                        List.drop 2 dateParts |> List.head |> Maybe.andThen String.toInt |> Maybe.withDefault 1

                    timeComponents =
                        String.split ":" timePart

                    hour =
                        List.head timeComponents |> Maybe.andThen String.toInt |> Maybe.withDefault 0

                    minute =
                        List.drop 1 timeComponents |> List.head |> Maybe.andThen String.toInt |> Maybe.withDefault 0

                    second =
                        List.drop 2 timeComponents |> List.head |> Maybe.andThen (String.split "." >> List.head) |> Maybe.andThen String.toInt |> Maybe.withDefault 0

                    -- Calculate milliseconds since epoch
                    msPerDay =
                        86400000

                    msPerHour =
                        3600000

                    msPerMinute =
                        60000

                    msPerSecond =
                        1000

                    -- Start with Unix epoch (1970-01-01) and add days
                    daysFromEpoch =
                        (year - 1970)
                            * 365
                            + ((year - 1969) // 4)
                            + (case month of
                                1 ->
                                    0

                                2 ->
                                    31

                                3 ->
                                    59

                                4 ->
                                    90

                                5 ->
                                    120

                                6 ->
                                    151

                                7 ->
                                    181

                                8 ->
                                    212

                                9 ->
                                    243

                                10 ->
                                    273

                                11 ->
                                    304

                                12 ->
                                    334

                                _ ->
                                    0
                              )
                            + day
                            - 1

                    timestamp =
                        daysFromEpoch
                            * msPerDay
                            + hour
                            * msPerHour
                            + minute
                            * msPerMinute
                            + second
                            * msPerSecond
                in
                Decode.succeed (Time.millisToPosix timestamp)
            )


viewFollowUpRequest : Zone -> FollowUpRequest -> Html Msg
viewFollowUpRequest zone followUp =
    div [ class "flex items-center justify-between py-3 border-b border-gray-100 last:border-0" ]
        [ div [ class "flex items-center space-x-4" ]
            [ div [ class "text-sm text-gray-600" ]
                [ text (formatDate zone followUp.createdAt) ]
            , div [ class "text-sm font-medium" ]
                [ text
                    (case followUp.type_ of
                        "accept" ->
                            "Accepted - Ready to Switch"

                        "decline" ->
                            "Declined - Looking for Alternatives"

                        _ ->
                            "General Follow-up Request"
                    )
                ]
            ]
        ]


formatDate : Zone -> Posix -> String
formatDate zone time =
    let
        year =
            String.fromInt (Time.toYear zone time)

        month =
            case Time.toMonth zone time of
                Jan ->
                    "01"

                Feb ->
                    "02"

                Mar ->
                    "03"

                Apr ->
                    "04"

                May ->
                    "05"

                Jun ->
                    "06"

                Jul ->
                    "07"

                Aug ->
                    "08"

                Sep ->
                    "09"

                Oct ->
                    "10"

                Nov ->
                    "11"

                Dec ->
                    "12"

        day =
            String.padLeft 2 '0' (String.fromInt (Time.toDay zone time))

        hour =
            Time.toHour zone time

        ( displayHour, amPm ) =
            if hour == 0 then
                ( "12", "AM" )

            else if hour < 12 then
                ( String.fromInt hour, "AM" )

            else if hour == 12 then
                ( "12", "PM" )

            else
                ( String.fromInt (hour - 12), "PM" )

        minute =
            String.padLeft 2 '0' (String.fromInt (Time.toMinute zone time))
    in
    year ++ "-" ++ month ++ "-" ++ day ++ " at " ++ displayHour ++ ":" ++ minute ++ " " ++ amPm



-- HELPERS


isStateActive : EmailSchedule -> Bool
isStateActive schedule =
    List.member schedule.state schedule.stateLicenses



-- Helper function to parse eligibility answers from JSON string


parseEligibilityAnswers : String -> List EligibilityQuestion
parseEligibilityAnswers jsonStr =
    let
        jsonResult =
            Decode.decodeString (Decode.dict eligibilityQuestionDecoder) jsonStr
    in
    case jsonResult of
        Ok dict ->
            Dict.toList dict
                |> List.map
                    (\( idStr, question ) ->
                        let
                            id =
                                String.toInt idStr |> Maybe.withDefault 0
                        in
                        { question | id = id }
                    )
                |> List.sortBy .id

        Err _ ->
            []


eligibilityQuestionDecoder : Decode.Decoder EligibilityQuestion
eligibilityQuestionDecoder =
    Decode.map4 EligibilityQuestion
        (Decode.succeed 0)
        -- Temporary ID that will be replaced
        (Decode.field "question_text" Decode.string)
        (Decode.field "question_type" questionTypeDecoder)
        (Decode.field "answer" answerDecoder)


questionTypeDecoder : Decode.Decoder QuestionType
questionTypeDecoder =
    Decode.string
        |> Decode.andThen
            (\typeStr ->
                if typeStr == "main" then
                    Decode.succeed MainQuestion

                else if String.startsWith "followup_" typeStr then
                    let
                        parentIdStr =
                            String.dropLeft 9 typeStr

                        parentId =
                            String.toInt parentIdStr |> Maybe.withDefault 0
                    in
                    Decode.succeed (FollowUpQuestion parentId)

                else
                    Decode.fail ("Unknown question type: " ++ typeStr)
            )


answerDecoder : Decode.Decoder (Maybe (Either Bool String))
answerDecoder =
    Decode.oneOf
        [ Decode.bool |> Decode.map (\b -> Just (Left b))
        , Decode.string |> Decode.map (\s -> Just (Right s))
        , Decode.null Nothing
        ]


viewHealthAssessmentModal : Model -> Html Msg
viewHealthAssessmentModal model =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-4 sm:p-8 z-50 overflow-auto" ]
        [ div [ class "bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col" ]
            [ div [ class "px-6 py-4 border-b border-gray-200 flex justify-between items-center" ]
                [ h2 [ class "text-xl font-semibold text-gray-900" ]
                    [ text "Health Assessment Results" ]
                , button
                    [ class "text-gray-400 hover:text-gray-600 focus:outline-none"
                    , onClick CloseModal
                    ]
                    [ text "×" ]
                ]
            , div [ class "p-6 overflow-auto flex-grow" ]
                [ viewHealthAssessmentContent model.eligibilityQuestions ]
            , div [ class "px-6 py-4 border-t border-gray-200 flex justify-end" ]
                [ button
                    [ class "px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium"
                    , onClick CloseModal
                    ]
                    [ text "Close" ]
                ]
            ]
        ]


viewHealthAssessmentContent : List EligibilityQuestion -> Html Msg
viewHealthAssessmentContent questions =
    let
        mainQuestions =
            List.filter (\q -> q.questionType == MainQuestion) questions
                |> List.sortBy .id

        hasAnyYes =
            List.any
                (\q ->
                    case q.answer of
                        Just (Left True) ->
                            q.questionType == MainQuestion

                        _ ->
                            False
                )
                questions

        statusBorderClass =
            if hasAnyYes then
                "border-red-200 bg-red-50"

            else
                "border-green-200 bg-green-50"

        statusIconClass =
            if hasAnyYes then
                "bg-red-100 text-red-600"

            else
                "bg-green-100 text-green-600"

        statusTitleClass =
            if hasAnyYes then
                "text-red-800"

            else
                "text-green-800"

        statusTextClass =
            if hasAnyYes then
                "text-red-700"

            else
                "text-green-700"
    in
    div []
        [ div [ class ("mb-6 p-4 rounded-lg border " ++ statusBorderClass) ]
            [ div [ class "flex items-center" ]
                [ span [ class ("inline-flex items-center justify-center w-8 h-8 rounded-full " ++ statusIconClass) ]
                    [ if hasAnyYes then
                        text "!"

                      else
                        text "✓"
                    ]
                , div [ class "ml-3" ]
                    [ h3 [ class ("font-medium " ++ statusTitleClass) ]
                        [ if hasAnyYes then
                            text "Health Issues Identified"

                          else
                            text "All Health Checks Passed"
                        ]
                    , p [ class ("text-sm " ++ statusTextClass) ]
                        [ if hasAnyYes then
                            text "This contact has flagged health conditions that may affect their eligibility."

                          else
                            text "This contact has no health conditions that would affect their eligibility."
                        ]
                    ]
                ]
            ]
        , div [ class "space-y-6" ]
            (List.map (viewMainQuestionWithFollowups questions) mainQuestions)
        ]


viewMainQuestionWithFollowups : List EligibilityQuestion -> EligibilityQuestion -> Html Msg
viewMainQuestionWithFollowups allQuestions mainQuestion =
    let
        followUps =
            List.filter
                (\q ->
                    case q.questionType of
                        FollowUpQuestion parentId ->
                            parentId == mainQuestion.id

                        MainQuestion ->
                            False
                )
                allQuestions
                |> List.sortBy .id

        hasFollowUps =
            not (List.isEmpty followUps)

        isYes =
            case mainQuestion.answer of
                Just (Left True) ->
                    True

                _ ->
                    False

        borderClass =
            if isYes then
                "border-red-300"

            else
                "border-gray-200"
    in
    div [ class ("rounded-lg border " ++ borderClass ++ " overflow-hidden") ]
        [ div
            [ class
                ("p-4 "
                    ++ (if isYes then
                            "bg-red-50"

                        else
                            "bg-gray-50"
                       )
                )
            ]
            [ div [ class "flex items-start" ]
                [ div [ class "flex-grow" ]
                    [ div [ class "font-medium mb-1" ]
                        [ text mainQuestion.text ]
                    , div
                        [ class
                            ("text-sm font-medium "
                                ++ (if isYes then
                                        "text-red-700"

                                    else
                                        "text-green-700"
                                   )
                            )
                        ]
                        [ text
                            (if isYes then
                                "Yes"

                             else
                                "No"
                            )
                        ]
                    ]
                ]
            ]
        , if isYes && hasFollowUps then
            div [ class "divide-y divide-gray-100" ]
                (List.map viewFollowUpQuestionAnswer followUps)

          else
            text ""
        ]


viewFollowUpQuestionAnswer : EligibilityQuestion -> Html Msg
viewFollowUpQuestionAnswer question =
    div [ class "p-4 bg-white" ]
        [ div [ class "font-medium text-sm text-gray-700 mb-1" ]
            [ text question.text ]
        , div [ class "text-sm" ]
            [ case question.answer of
                Just (Left isYes) ->
                    div
                        [ class
                            (if isYes then
                                "text-red-600 font-medium"

                             else
                                "text-green-600 font-medium"
                            )
                        ]
                        [ text
                            (if isYes then
                                "Yes"

                             else
                                "No"
                            )
                        ]

                Just (Right textAnswer) ->
                    if String.isEmpty textAnswer then
                        div [ class "text-gray-500 italic" ]
                            [ text "No answer provided" ]

                    else
                        div [ class "text-gray-900 bg-gray-50 p-2 rounded border border-gray-200" ]
                            [ text textAnswer ]

                Nothing ->
                    div [ class "text-gray-500 italic" ]
                        [ text "No answer" ]
            ]
        ]

================
File: src/Contacts.elm
================
module Contacts exposing
    ( Model
    , Msg(..)
    , init
    , subscriptions
    , update
    , view
    )

-- Proper imports for CSV parsing

import Browser
import Browser.Events
import Browser.Navigation as Nav
import Components.LimitBanner as LimitBanner
import Csv.Decode as CsvDecode
import Csv.Parser as CsvParser
import CsvProcessor exposing (CarrierMapping, ColumnMapping, extractHeaders, extractUniqueValues, processCsvToContacts, suggestCarrierMappings, suggestColumnMappings)
import Dict exposing (Dict)
import File exposing (File)
import File.Download
import File.Select as Select
import Html exposing (Html, button, col, colgroup, details, div, h1, h2, h3, input, label, nav, option, p, select, span, summary, table, tbody, td, text, th, thead, tr)
import Html.Attributes exposing (attribute, checked, class, disabled, placeholder, required, selected, title, type_, value)
import Html.Events exposing (on, onClick, onInput, onSubmit, preventDefaultOn, stopPropagationOn)
import Http
import Json.Decode as Decode exposing (Decoder, bool, int, nullable, string)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import List.Extra
import Svg exposing (path, svg)
import Svg.Attributes exposing (d, fill, stroke, viewBox)
import Task
import Time
import Url exposing (Url)
import Url.Builder as Url



-- MAIN


main : Program () Model Msg
main =
    Browser.application
        { init = \flags url key -> init key Nothing
        , view = \model -> { title = "Dashboard", body = [ view model ] }
        , update = update
        , subscriptions = subscriptions
        , onUrlChange = \_ -> NoOp
        , onUrlRequest = \_ -> NoOp
        }



-- MODEL


type alias Contact =
    { id : Int
    , firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , contactOwnerId : Maybe Int
    , contactOwner : Maybe User
    , currentCarrier : Maybe String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : Bool
    , gender : String
    , zipCode : String
    , planType : Maybe String
    , status : String
    , agentId : Maybe Int
    , lastEmailed : Maybe String
    }


type Modal
    = NoModal
    | ContactChoiceModal
    | AddModal
    | EditModal Contact
    | CsvUploadModal UploadState
    | DeleteConfirmModal
    | ReassignAgentModal


type alias Model =
    { contacts : List Contact
    , selectedContacts : List Int
    , showModal : Modal
    , searchQuery : String
    , addForm : ContactForm
    , editForm : ContactForm
    , sortColumn : Maybe SortColumn
    , sortDirection : SortDirection
    , activeFilters : Filters
    , openFilter : Maybe FilterType
    , currentTime : Time.Posix
    , isLoadingContacts : Bool
    , isUploadingCsv : Bool
    , isDeletingContacts : Bool
    , isSubmittingForm : Bool
    , isCheckingEmail : Bool
    , emailExists : Bool
    , currentUser : Maybe User
    , showProfileMenu : Bool
    , error : Maybe String
    , saveOnUpdate : Bool
    , expandedContactId : Maybe Int
    , availableFilters : AvailableFilters
    , carriers : List String
    , agents : List User
    , key : Nav.Key
    , limitBanner : LimitBanner.Model
    , pagination : PaginationState -- Add this field
    }


type alias ContactForm =
    { id : Maybe Int
    , firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , contactOwnerId : Maybe Int
    , currentCarrier : Maybe String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : Bool
    , gender : String
    , zipCode : String
    , planType : Maybe String
    }


type SortColumn
    = NameCol
    | StatusCol
    | EmailCol
    | PhoneNumberCol
    | StateCol
    | ContactOwnerCol
    | CurrentCarrierCol
    | EffectiveDateCol


type SortDirection
    = Ascending
    | Descending


type alias Filters =
    { carriers : List String
    , states : List String
    , ageRange : Maybe ( Int, Int )
    , agents : List Int
    }


type alias ZipInfo =
    { state : String
    , counties : List String
    , cities : List String
    }


type alias UploadState =
    { dragOver : Bool
    , file : Maybe File
    , error : Maybe String
    , errorCsv : Maybe String
    , converted_carriers_csv : Maybe String
    , stats : Maybe UploadStats
    , overwriteDuplicates : Bool
    , selectedAgentId : Maybe Int
    , columnMapping : Maybe ColumnMapping
    , carrierMapping : Maybe CarrierMapping
    , detectedCarriers : List String
    , csvHeaders : List String
    , processingHeaders : Bool
    , extractingCarriers : Bool
    }


type alias UploadStats =
    { totalRows : Int
    , errorRows : Int
    , validRows : Int
    , converted_carrier_rows : Int
    , supported_carriers : List { name : String, aliases : List String }
    }


type alias DeleteResponse =
    { success : Bool
    , deletedIds : List Int
    , message : String
    }


type alias ReassignResponse =
    { success : Bool
    , updatedIds : List Int
    , message : String
    }


type alias User =
    { id : Int
    , email : String
    , firstName : String
    , lastName : String
    , isAdmin : Bool
    , isAgent : Bool
    , organizationId : Int
    , isActive : Bool
    , phone : String
    , carriers : List String
    , stateLicenses : List String
    }


type alias AvailableFilters =
    { carriers : List String
    , states : List String
    }


type alias ContactsResponse =
    { contacts : List Contact
    , filterOptions : AvailableFilters
    , total : Int
    , page : Int
    , limit : Int
    }


type alias PaginationState =
    { currentPage : Int
    , totalPages : Int
    , totalItems : Int
    , itemsPerPage : Int
    }


type alias ColumnMapping =
    { firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , currentCarrier : String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : String
    , gender : String
    , zipCode : String
    , planType : String
    }


type alias CarrierMapping =
    { detectedCarriers : List String
    , mappings : Dict String String -- Original carrier name -> Standardized carrier name
    }


type alias SuggestedMappings =
    { columnMappings : ColumnMapping
    , carrierMappings : Dict String String
    }


init : Nav.Key -> Maybe User -> ( Model, Cmd Msg )
init key maybeUser =
    let
        -- Create filtered model if the user is an agent but not an admin
        initialFilters =
            case maybeUser of
                Just user ->
                    if user.isAgent && not user.isAdmin then
                        -- Set initial filter to only show contacts assigned to this agent
                        { carriers = []
                        , states = []
                        , ageRange = Nothing
                        , agents = [ user.id ] -- Add the current agent ID to the filters
                        }

                    else
                        emptyFilters

                Nothing ->
                    emptyFilters

        -- Set default contact owner to current user if they are an agent
        defaultOwnerId =
            case maybeUser of
                Just user ->
                    if user.isAgent then
                        Just user.id

                    else
                        Nothing

                Nothing ->
                    Nothing

        initialAddForm =
            { emptyForm | contactOwnerId = defaultOwnerId }

        ( limitBannerModel, limitBannerCmd ) =
            LimitBanner.init

        initialPagination =
            { currentPage = 1
            , totalPages = 1
            , totalItems = 0
            , itemsPerPage = 100
            }

        initialModel =
            { contacts = []
            , selectedContacts = []
            , showModal = NoModal
            , searchQuery = ""
            , addForm = initialAddForm
            , editForm = emptyForm
            , sortColumn = Nothing
            , sortDirection = Ascending
            , activeFilters = initialFilters -- Use our potentially filtered initial state
            , openFilter = Nothing
            , currentTime = Time.millisToPosix 0
            , isLoadingContacts = True
            , isUploadingCsv = False
            , isDeletingContacts = False
            , isSubmittingForm = False
            , isCheckingEmail = False
            , emailExists = False
            , currentUser = maybeUser -- Use the passed in user immediately
            , showProfileMenu = False
            , error = Nothing
            , saveOnUpdate = False
            , expandedContactId = Nothing
            , availableFilters = { carriers = [], states = [] }
            , carriers = []
            , agents = []
            , key = key
            , limitBanner = limitBannerModel
            , pagination = initialPagination
            }
    in
    ( initialModel
    , Cmd.batch
        [ fetchContacts initialModel
        , if maybeUser == Nothing then
            -- Only fetch the user if not provided
            fetchCurrentUser

          else
            Cmd.none
        , Task.perform GotCurrentTime Time.now
        , fetchCarriers
        , fetchAgents
        , Cmd.map LimitBannerMsg limitBannerCmd
        ]
    )


emptyForm : ContactForm
emptyForm =
    { id = Nothing
    , firstName = ""
    , lastName = ""
    , email = ""
    , phoneNumber = ""
    , state = ""
    , contactOwnerId = Nothing
    , currentCarrier = Nothing
    , effectiveDate = ""
    , birthDate = ""
    , tobaccoUser = False
    , gender = "M"
    , zipCode = ""
    , planType = Nothing
    }


emptyFilters : Filters
emptyFilters =
    { carriers = []
    , states = []
    , ageRange = Nothing
    , agents = []
    }


emptyUploadState : Model -> UploadState
emptyUploadState model =
    let
        selectedAgentId =
            case model.currentUser of
                Just user ->
                    if user.isAgent && not user.isAdmin then
                        Just user.id

                    else
                        Nothing

                Nothing ->
                    Nothing

        overwriteOption =
            case model.currentUser of
                Just user ->
                    not (user.isAgent && not user.isAdmin)

                Nothing ->
                    True
    in
    { dragOver = False
    , file = Nothing
    , error = Nothing
    , errorCsv = Nothing
    , converted_carriers_csv = Nothing
    , stats = Nothing
    , overwriteDuplicates = overwriteOption
    , selectedAgentId = selectedAgentId
    , columnMapping = Nothing
    , carrierMapping = Nothing
    , detectedCarriers = []
    , csvHeaders = []
    , processingHeaders = False
    , extractingCarriers = False
    }



-- UPDATE


type Msg
    = NoOp
    | ShowContactChoiceModal
    | ChooseSingleContact
    | ChooseMultipleContacts
    | ShowAddModal
    | ShowEditModal Contact
    | CloseModal
    | UpdateSearchQuery String
    | UpdateAddForm ContactFormField String
    | UpdateEditForm ContactFormField String
    | SubmitAddForm
    | SubmitEditForm
    | CheckEmail String
    | EmailChecked (Result Http.Error { exists : Bool })
    | GotContacts (Result Http.Error ContactsResponse)
    | ContactAdded (Result Http.Error Contact)
    | ContactUpdated (Result Http.Error Contact)
    | HandleKeyDown String
    | SetSort SortColumn
    | ToggleFilter FilterType String
    | SetAgeFilter Int Int
    | ClearFilters
    | LookupZipCode String
    | GotZipLookup (Result Http.Error ZipInfo)
    | Batch (List Msg)
    | ToggleFilterDropdown FilterType
    | SelectAllFilter FilterType Bool
    | CloseFilterDropdown
    | GotCurrentTime Time.Posix
    | ToggleSelectContact Int
    | SelectAllContacts
    | DeselectAllContacts
    | EmailSelectedCarriers
    | EmailSelectedContacts
    | ShowCsvUploadModal
    | DragEnter
    | DragLeave
    | FileDrop File
    | FileSelected File
    | ClickedSelectFile
    | UploadCsv
    | CsvUploaded (Result Http.Error UploadResponse)
    | DownloadErrorCsv String
    | DownloadCarrierConversionsCsv String
    | ShowDeleteConfirmModal
    | DeleteSelectedContacts
    | ContactsDeleted (Result Http.Error DeleteResponse)
    | ToggleOverwriteDuplicates Bool
    | GotCurrentUser (Result Http.Error User)
    | NavigateToContact Int
    | GotCarriers (Result Http.Error (List String))
    | GotAgents (Result Http.Error (List User))
    | SelectUploadAgent Int
    | ShowReassignAgentModal
    | SelectReassignAgent Int
    | ReassignSelectedContacts
    | ContactsReassigned (Result Http.Error ReassignResponse)
    | LimitBannerMsg LimitBanner.Msg
    | ChangePage Int
    | ChangeItemsPerPage Int
    | UpdateColumnMapping String String
    | ExtractCsvHeaders File
    | CsvHeadersExtracted (Result String (List String))
    | SuggestedMappingsReceived (Result Http.Error SuggestedMappings)
    | ExtractCarrierValues
    | CarrierValuesExtracted (List String)
    | UpdateCarrierMapping String String
    | GotCarriersForMapping (List String) (Result Http.Error (List { name : String, aliases : List String }))


type ContactFormField
    = FirstName
    | LastName
    | Email
    | PhoneNumber
    | State
    | ContactOwnerId
    | CurrentCarrier
    | EffectiveDate
    | BirthDate
    | TobaccoUser
    | Gender
    | ZipCode
    | PlanType


type FilterType
    = CarrierFilter
    | StateFilter
    | AgeFilter
    | AgentFilter


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )

        ShowContactChoiceModal ->
            ( { model | showModal = ContactChoiceModal }, Cmd.none )

        ChooseSingleContact ->
            ( { model | showModal = AddModal }, Cmd.none )

        ChooseMultipleContacts ->
            ( { model | showModal = CsvUploadModal (emptyUploadState model) }, Cmd.none )

        ShowAddModal ->
            ( { model | showModal = AddModal }, Cmd.none )

        ShowEditModal contact ->
            ( { model
                | showModal = EditModal contact
                , editForm =
                    { id = Just contact.id
                    , firstName = contact.firstName
                    , lastName = contact.lastName
                    , email = contact.email
                    , phoneNumber = contact.phoneNumber
                    , state = contact.state
                    , contactOwnerId = contact.contactOwnerId
                    , currentCarrier = contact.currentCarrier
                    , effectiveDate = contact.effectiveDate
                    , birthDate = contact.birthDate
                    , tobaccoUser = contact.tobaccoUser
                    , gender = contact.gender
                    , zipCode = contact.zipCode
                    , planType = contact.planType
                    }
              }
            , Cmd.none
            )

        CloseModal ->
            ( { model
                | showModal = NoModal
                , addForm = emptyForm
                , editForm = emptyForm
                , isCheckingEmail = False
                , emailExists = False
                , error = Nothing
                , isSubmittingForm = False
              }
            , Cmd.none
            )

        UpdateSearchQuery query ->
            let
                updatedModel =
                    { model | searchQuery = query, isLoadingContacts = True }
            in
            ( updatedModel, fetchContacts updatedModel )

        UpdateAddForm field value ->
            let
                form =
                    model.addForm

                updatedForm =
                    case field of
                        FirstName ->
                            { form | firstName = value }

                        LastName ->
                            { form | lastName = value }

                        Email ->
                            { form | email = value }

                        PhoneNumber ->
                            { form | phoneNumber = String.filter Char.isDigit value |> String.left 10 }

                        State ->
                            { form | state = value }

                        ContactOwnerId ->
                            { form | contactOwnerId = String.toInt value }

                        CurrentCarrier ->
                            { form | currentCarrier = Just value }

                        EffectiveDate ->
                            { form | effectiveDate = value }

                        BirthDate ->
                            { form | birthDate = value }

                        TobaccoUser ->
                            { form | tobaccoUser = value == "true" }

                        Gender ->
                            { form | gender = value }

                        ZipCode ->
                            { form | zipCode = value }

                        PlanType ->
                            { form | planType = Just value }

                cmd =
                    if field == ZipCode && String.length value == 5 then
                        submitEditFormWithFlag updatedForm True

                    else if field == Email && String.length value > 0 then
                        checkEmail value

                    else
                        Cmd.none
            in
            case model.showModal of
                ContactChoiceModal ->
                    ( model, Cmd.none )

                AddModal ->
                    ( { model
                        | addForm = updatedForm
                        , isCheckingEmail = field == Email && String.length value > 0
                        , emailExists = False
                        , error = Nothing
                      }
                    , cmd
                    )

                EditModal _ ->
                    ( { model | editForm = updatedForm }, cmd )

                NoModal ->
                    ( model, Cmd.none )

                CsvUploadModal _ ->
                    ( model, Cmd.none )

                DeleteConfirmModal ->
                    ( model, Cmd.none )

                ReassignAgentModal ->
                    ( model, Cmd.none )

        UpdateEditForm field value ->
            let
                form =
                    model.editForm

                updatedForm =
                    case field of
                        FirstName ->
                            { form | firstName = value }

                        LastName ->
                            { form | lastName = value }

                        Email ->
                            { form | email = value }

                        PhoneNumber ->
                            { form | phoneNumber = String.filter Char.isDigit value |> String.left 10 }

                        State ->
                            { form | state = value }

                        ContactOwnerId ->
                            { form | contactOwnerId = String.toInt value }

                        CurrentCarrier ->
                            { form | currentCarrier = Just value }

                        EffectiveDate ->
                            { form | effectiveDate = value }

                        BirthDate ->
                            { form | birthDate = value }

                        TobaccoUser ->
                            { form | tobaccoUser = value == "true" }

                        Gender ->
                            { form | gender = value }

                        ZipCode ->
                            { form | zipCode = value }

                        PlanType ->
                            { form | planType = Just value }

                cmd =
                    if field == ZipCode && String.length value == 5 then
                        LookupZipCode value
                            |> Task.succeed
                            |> Task.perform identity

                    else if field == Email && String.length value > 0 then
                        checkEmail value

                    else
                        Cmd.none
            in
            case model.showModal of
                ContactChoiceModal ->
                    ( model, Cmd.none )

                AddModal ->
                    ( { model | addForm = updatedForm }, cmd )

                EditModal _ ->
                    ( { model | editForm = updatedForm }, cmd )

                NoModal ->
                    ( model, Cmd.none )

                CsvUploadModal _ ->
                    ( model, Cmd.none )

                DeleteConfirmModal ->
                    ( model, Cmd.none )

                ReassignAgentModal ->
                    ( model, Cmd.none )

        SubmitAddForm ->
            ( { model | isSubmittingForm = True }
            , submitAddForm model.addForm
            )

        SubmitEditForm ->
            ( { model
                | isSubmittingForm = True
                , saveOnUpdate = True
              }
            , submitEditFormWithFlag model.editForm False
            )

        CheckEmail email ->
            ( { model | isCheckingEmail = True }
            , checkEmail email
            )

        EmailChecked (Ok response) ->
            ( { model
                | isCheckingEmail = False
                , emailExists = response.exists
                , error =
                    if response.exists then
                        Just "A contact with this email already exists"

                    else
                        Nothing
              }
            , Cmd.none
            )

        EmailChecked (Err _) ->
            ( { model
                | isCheckingEmail = False
                , error = Just "Failed to check email. Please try again."
              }
            , Cmd.none
            )

        GotContacts (Ok response) ->
            ( { model
                | contacts = response.contacts
                , isLoadingContacts = False
                , availableFilters = response.filterOptions
                , pagination =
                    { currentPage = response.page
                    , totalItems = response.total
                    , itemsPerPage = response.limit
                    , totalPages = ceiling (toFloat response.total / toFloat response.limit)
                    }
              }
            , Cmd.none
            )

        GotContacts (Err error) ->
            ( { model | error = Just "Failed to load contacts" }, Cmd.none )

        ContactAdded (Ok contact) ->
            ( { model
                | contacts = contact :: model.contacts
                , showModal = NoModal
                , addForm = emptyForm
                , isSubmittingForm = False
              }
            , Cmd.none
            )

        ContactAdded (Err _) ->
            ( { model | isSubmittingForm = False }
            , Cmd.none
            )

        ContactUpdated (Ok contact) ->
            let
                updatedContacts =
                    updateContact contact model.contacts

                updatedModel =
                    if model.saveOnUpdate then
                        -- Close the modal for a final save
                        { model
                            | contacts = updatedContacts
                            , showModal = NoModal
                            , editForm = emptyForm
                            , isSubmittingForm = False
                            , error = Nothing
                            , saveOnUpdate = False
                        }

                    else
                        -- Just update the state field in the form
                        { model
                            | contacts = updatedContacts
                            , editForm =
                                model.editForm
                                    |> (\form -> { form | state = contact.state })
                            , isSubmittingForm = False
                            , error = Nothing
                        }
            in
            ( updatedModel, Cmd.none )

        ContactUpdated (Err error) ->
            ( { model
                | isSubmittingForm = False
                , error = Just "Failed to update contact. Please check the ZIP code is valid."
              }
            , Cmd.none
            )

        HandleKeyDown key ->
            if key == "Escape" then
                ( { model | showModal = NoModal }, Cmd.none )

            else
                ( model, Cmd.none )

        SetSort column ->
            let
                ( newColumn, newDirection ) =
                    case ( model.sortColumn, model.sortDirection ) of
                        ( Just currentColumn, direction ) ->
                            if currentColumn == column then
                                -- Toggle direction if same column
                                ( Just column
                                , if direction == Ascending then
                                    Descending

                                  else
                                    Ascending
                                )

                            else
                                -- New column, start with ascending
                                ( Just column, Ascending )

                        ( Nothing, _ ) ->
                            -- First time sorting, start with ascending
                            ( Just column, Ascending )
            in
            ( { model
                | sortColumn = newColumn
                , sortDirection = newDirection
              }
            , Cmd.none
            )

        ToggleFilter filterType value ->
            let
                updatedModel =
                    { model
                        | activeFilters = toggleFilter model.activeFilters filterType value
                        , isLoadingContacts = True
                    }
            in
            ( updatedModel, fetchContacts updatedModel )

        SetAgeFilter min max ->
            ( { model | activeFilters = setAgeFilter min max model.activeFilters }, Cmd.none )

        ClearFilters ->
            ( { model | activeFilters = emptyFilters }, Cmd.none )

        LookupZipCode zipCode ->
            ( model
            , Http.get
                { url = "/api/zip-lookup/" ++ zipCode
                , expect = Http.expectJson GotZipLookup zipInfoDecoder
                }
            )

        GotZipLookup (Ok zipInfo) ->
            let
                updateForm form =
                    { form | state = zipInfo.state }
            in
            case model.showModal of
                ContactChoiceModal ->
                    ( model, Cmd.none )

                AddModal ->
                    ( { model | addForm = updateForm model.addForm }, Cmd.none )

                EditModal _ ->
                    ( { model | editForm = updateForm model.editForm }, Cmd.none )

                NoModal ->
                    ( model, Cmd.none )

                CsvUploadModal _ ->
                    ( model, Cmd.none )

                DeleteConfirmModal ->
                    ( model, Cmd.none )

                ReassignAgentModal ->
                    ( model, Cmd.none )

        GotZipLookup (Err _) ->
            ( model, Cmd.none )

        Batch messages ->
            List.foldl
                (\msg_ ( model_, cmds ) ->
                    let
                        ( newModel, newCmd ) =
                            update msg_ model_
                    in
                    ( newModel, newCmd :: cmds )
                )
                ( model, [] )
                messages
                |> (\( m, cs ) -> ( m, Cmd.batch cs ))

        ToggleFilterDropdown filterType ->
            ( { model
                | openFilter =
                    if model.openFilter == Just filterType then
                        Nothing

                    else
                        Just filterType
              }
            , Cmd.none
            )

        SelectAllFilter filterType select ->
            let
                options =
                    case filterType of
                        CarrierFilter ->
                            model.availableFilters.carriers

                        StateFilter ->
                            model.availableFilters.states

                        AgentFilter ->
                            model.agents
                                |> List.filter (\agent -> agent.isAgent)
                                |> List.map (\agent -> agent.firstName ++ " " ++ agent.lastName)

                        _ ->
                            []

                updatedFilters =
                    case filterType of
                        CarrierFilter ->
                            { carriers =
                                if select then
                                    options

                                else
                                    []
                            , states = model.activeFilters.states
                            , ageRange = model.activeFilters.ageRange
                            , agents = model.activeFilters.agents
                            }

                        StateFilter ->
                            { carriers = model.activeFilters.carriers
                            , states =
                                if select then
                                    options

                                else
                                    []
                            , ageRange = model.activeFilters.ageRange
                            , agents = model.activeFilters.agents
                            }

                        AgentFilter ->
                            { carriers = model.activeFilters.carriers
                            , states = model.activeFilters.states
                            , ageRange = model.activeFilters.ageRange
                            , agents =
                                if select then
                                    model.agents
                                        |> List.filter (\agent -> agent.isAgent)
                                        |> List.map (\agent -> agent.id)

                                else
                                    []
                            }

                        _ ->
                            model.activeFilters

                updatedModel =
                    { model | activeFilters = updatedFilters }
            in
            ( updatedModel, fetchContacts updatedModel )

        CloseFilterDropdown ->
            -- Only close the dropdown, don't prevent further events
            ( { model | openFilter = Nothing }, Cmd.none )

        GotCurrentTime time ->
            ( { model | currentTime = time }, Cmd.none )

        ToggleSelectContact id ->
            ( { model
                | selectedContacts =
                    if List.member id model.selectedContacts then
                        List.filter (\x -> x /= id) model.selectedContacts

                    else
                        id :: model.selectedContacts
              }
            , Cmd.none
            )

        SelectAllContacts ->
            let
                visibleContacts =
                    model.contacts
                        |> filterContacts model.activeFilters model.searchQuery model.currentTime
                        |> List.map .id
            in
            ( { model | selectedContacts = visibleContacts }
            , Cmd.none
            )

        DeselectAllContacts ->
            ( { model | selectedContacts = [] }
            , Cmd.none
            )

        EmailSelectedCarriers ->
            -- For now, just a placeholder that does nothing
            ( model, Cmd.none )

        EmailSelectedContacts ->
            -- For now, just a placeholder that does nothing
            ( model, Cmd.none )

        ShowCsvUploadModal ->
            ( { model | showModal = CsvUploadModal (emptyUploadState model) }, Cmd.none )

        DragEnter ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | dragOver = True } }, Cmd.none )

                _ ->
                    ( model, Cmd.none )

        DragLeave ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | dragOver = False } }, Cmd.none )

                _ ->
                    ( model, Cmd.none )

        FileDrop file ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | file = Just file, dragOver = False, processingHeaders = True } }
                    , extractCsvHeaders file
                    )

                _ ->
                    ( model, Cmd.none )

        FileSelected file ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | file = Just file, processingHeaders = True } }
                    , extractCsvHeaders file
                    )

                _ ->
                    ( model, Cmd.none )

        ClickedSelectFile ->
            ( model
            , Select.file [ "text/csv" ] FileSelected
            )

        UploadCsv ->
            case model.showModal of
                CsvUploadModal state ->
                    case state.file of
                        Just file ->
                            ( { model
                                | showModal = CsvUploadModal { state | error = Nothing, errorCsv = Nothing, stats = Nothing }
                                , isUploadingCsv = True
                              }
                            , uploadCsv file state.overwriteDuplicates state.selectedAgentId model
                            )

                        Nothing ->
                            ( model, Cmd.none )

                _ ->
                    ( model, Cmd.none )

        CsvUploaded (Ok response) ->
            let
                errorMessage =
                    if response.success then
                        "Contacts imported successfully!"

                    else if String.startsWith "Missing required columns:" response.message then
                        let
                            missingColumns =
                                String.dropLeft (String.length "Missing required columns:") response.message
                                    |> String.trim
                                    |> String.split ","
                                    |> List.map String.trim
                                    |> String.join ", "
                        in
                        "Your CSV is missing the following required columns: " ++ missingColumns ++ ". Please add these columns and try again."

                    else
                        response.message

                -- Check if the message contains information about duplicates
                hasDuplicatesMessage =
                    String.contains "duplicate" response.message || String.contains "existing contact" response.message

                currentModal =
                    case model.showModal of
                        CsvUploadModal state ->
                            if response.success && response.errorRows == 0 && not hasDuplicatesMessage then
                                NoModal

                            else
                                CsvUploadModal
                                    { state
                                        | error = Just errorMessage
                                        , errorCsv = response.errorCsv
                                        , converted_carriers_csv = response.converted_carriers_csv
                                        , stats =
                                            Just
                                                { totalRows = response.totalRows
                                                , errorRows = response.errorRows
                                                , validRows = response.validRows
                                                , converted_carrier_rows = response.converted_carrier_rows
                                                , supported_carriers = response.supported_carriers
                                                }
                                    }

                        _ ->
                            model.showModal

                updatedModel =
                    { model
                        | showModal = currentModal
                        , isUploadingCsv = False
                    }
            in
            ( updatedModel
            , if response.success then
                fetchContacts updatedModel

              else
                Cmd.none
            )

        CsvUploaded (Err httpError) ->
            let
                errorMessage =
                    case httpError of
                        Http.BadUrl url ->
                            "Invalid URL: " ++ url

                        Http.BadStatus statusCode ->
                            if statusCode == 400 then
                                "The CSV format is invalid. Please check that all required columns are present and data is in the correct format."

                            else if statusCode == 413 then
                                "The file is too large. Please try a smaller file or split your data into multiple uploads."

                            else if statusCode == 403 then
                                "You don't have permission to upload contacts. Please contact your administrator."

                            else
                                "Server error (status " ++ String.fromInt statusCode ++ "). Please try again later."

                        Http.BadBody responseBody ->
                            "The server response was not in the expected format: " ++ responseBody

                        Http.NetworkError ->
                            "Network error. Please check your connection and try again."

                        Http.Timeout ->
                            "The upload timed out. Please try again."
            in
            case model.showModal of
                CsvUploadModal state ->
                    ( { model
                        | showModal = CsvUploadModal { state | error = Just errorMessage }
                        , isUploadingCsv = False
                      }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        DownloadErrorCsv csvContent ->
            ( model
            , File.Download.string "upload_errors.csv" "text/csv" csvContent
            )

        DownloadCarrierConversionsCsv csvContent ->
            ( model
            , File.Download.string "carrier_conversions.csv" "text/csv" csvContent
            )

        ShowDeleteConfirmModal ->
            ( { model | showModal = DeleteConfirmModal }, Cmd.none )

        DeleteSelectedContacts ->
            ( { model | isDeletingContacts = True, showModal = NoModal }
            , if List.isEmpty model.selectedContacts then
                Cmd.none

              else
                deleteContacts model.selectedContacts
            )

        ContactsDeleted (Ok response) ->
            if response.success then
                let
                    updatedModel =
                        { model
                            | contacts = List.filter (\c -> not (List.member c.id response.deletedIds)) model.contacts
                            , selectedContacts = []
                            , isDeletingContacts = False
                        }
                in
                ( updatedModel
                , fetchContacts updatedModel
                )

            else
                ( { model | isDeletingContacts = False }, Cmd.none )

        ContactsDeleted (Err _) ->
            ( model, Cmd.none )

        ToggleOverwriteDuplicates value ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | overwriteDuplicates = value } }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        GotCurrentUser (Ok user) ->
            ( { model | currentUser = Just user }, Cmd.none )

        GotCurrentUser (Err _) ->
            ( model, Cmd.none )

        NavigateToContact id ->
            ( model, Nav.pushUrl model.key ("/contact/" ++ String.fromInt id) )

        GotCarriers (Ok carriers) ->
            ( { model | carriers = carriers }
            , Cmd.none
            )

        GotCarriers (Err _) ->
            ( model, Cmd.none )

        GotAgents (Ok agents) ->
            ( { model | agents = agents }, Cmd.none )

        GotAgents (Err error) ->
            ( model, Cmd.none )

        SelectUploadAgent agentId ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model | showModal = CsvUploadModal { state | selectedAgentId = Just agentId } }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        ShowReassignAgentModal ->
            ( { model | showModal = ReassignAgentModal }, Cmd.none )

        SelectReassignAgent agentId ->
            let
                updatedForm =
                    model.editForm

                updatedFormWithAgent =
                    { updatedForm | contactOwnerId = Just agentId }
            in
            ( { model | editForm = updatedFormWithAgent }
            , Cmd.none
            )

        ReassignSelectedContacts ->
            if List.isEmpty model.selectedContacts then
                ( model, Cmd.none )

            else
                case model.editForm.contactOwnerId of
                    Just agentId ->
                        if agentId == 0 then
                            -- If "Default" (0) is selected, pass null for agent_id
                            ( { model | showModal = NoModal }
                            , reassignContacts model.selectedContacts 0
                            )

                        else
                            -- Normal agent reassignment
                            ( { model | showModal = NoModal }
                            , reassignContacts model.selectedContacts agentId
                            )

                    Nothing ->
                        ( { model | error = Just "Please select an agent to reassign contacts to" }
                        , Cmd.none
                        )

        ContactsReassigned (Ok response) ->
            let
                updatedModel =
                    { model | showModal = NoModal, selectedContacts = [], editForm = emptyForm }
            in
            ( updatedModel, fetchContacts updatedModel )

        ContactsReassigned (Err _) ->
            ( { model | error = Just "Failed to reassign contacts", showModal = NoModal }, Cmd.none )

        LimitBannerMsg limitBannerMsg ->
            let
                ( updatedLimitBannerModel, limitBannerCmd ) =
                    LimitBanner.update limitBannerMsg model.limitBanner
            in
            ( { model | limitBanner = updatedLimitBannerModel }
            , Cmd.map LimitBannerMsg limitBannerCmd
            )

        ChangePage page ->
            let
                updatedModel =
                    { model
                        | pagination =
                            model.pagination
                                |> (\p -> { p | currentPage = page })
                        , isLoadingContacts = True
                    }
            in
            ( updatedModel
            , fetchContacts updatedModel
            )

        ChangeItemsPerPage limit ->
            let
                updatedModel =
                    { model
                        | pagination =
                            model.pagination
                                |> (\p -> { p | itemsPerPage = limit, currentPage = 1 })
                        , isLoadingContacts = True
                    }
            in
            ( updatedModel
            , fetchContacts updatedModel
            )

        UpdateColumnMapping field value ->
            case model.showModal of
                CsvUploadModal state ->
                    let
                        updatedMapping =
                            case state.columnMapping of
                                Just mapping ->
                                    Just
                                        (case field of
                                            "firstName" ->
                                                { mapping | firstName = value }

                                            "lastName" ->
                                                { mapping | lastName = value }

                                            "email" ->
                                                { mapping | email = value }

                                            "phoneNumber" ->
                                                { mapping | phoneNumber = value }

                                            "state" ->
                                                { mapping | state = value }

                                            "currentCarrier" ->
                                                { mapping | currentCarrier = value }

                                            "effectiveDate" ->
                                                { mapping | effectiveDate = value }

                                            "birthDate" ->
                                                { mapping | birthDate = value }

                                            "tobaccoUser" ->
                                                { mapping | tobaccoUser = value }

                                            "gender" ->
                                                { mapping | gender = value }

                                            "zipCode" ->
                                                { mapping | zipCode = value }

                                            "planType" ->
                                                { mapping | planType = value }

                                            _ ->
                                                mapping
                                        )

                                Nothing ->
                                    Just
                                        { firstName =
                                            if field == "firstName" then
                                                value

                                            else
                                                ""
                                        , lastName =
                                            if field == "lastName" then
                                                value

                                            else
                                                ""
                                        , email =
                                            if field == "email" then
                                                value

                                            else
                                                ""
                                        , phoneNumber =
                                            if field == "phoneNumber" then
                                                value

                                            else
                                                ""
                                        , state =
                                            if field == "state" then
                                                value

                                            else
                                                ""
                                        , currentCarrier =
                                            if field == "currentCarrier" then
                                                value

                                            else
                                                ""
                                        , effectiveDate =
                                            if field == "effectiveDate" then
                                                value

                                            else
                                                ""
                                        , birthDate =
                                            if field == "birthDate" then
                                                value

                                            else
                                                ""
                                        , tobaccoUser =
                                            if field == "tobaccoUser" then
                                                value

                                            else
                                                ""
                                        , gender =
                                            if field == "gender" then
                                                value

                                            else
                                                ""
                                        , zipCode =
                                            if field == "zipCode" then
                                                value

                                            else
                                                ""
                                        , planType =
                                            if field == "planType" then
                                                value

                                            else
                                                ""
                                        }
                    in
                    ( { model | showModal = CsvUploadModal { state | columnMapping = updatedMapping } }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        ExtractCsvHeaders file ->
            ( model
            , Task.perform
                (\content -> CsvHeadersExtracted (extractHeadersFromCsv content))
                (File.toString file)
            )

        CsvHeadersExtracted result ->
            case model.showModal of
                CsvUploadModal state ->
                    case result of
                        Ok headers ->
                            ( { model | showModal = CsvUploadModal { state | csvHeaders = headers, processingHeaders = False } }
                            , suggestMappings headers
                            )

                        Err error ->
                            ( { model | showModal = CsvUploadModal { state | error = Just ("Failed to parse CSV headers: " ++ error), processingHeaders = False } }
                            , Cmd.none
                            )

                _ ->
                    ( model, Cmd.none )

        SuggestedMappingsReceived result ->
            case model.showModal of
                CsvUploadModal state ->
                    case result of
                        Ok suggestions ->
                            ( { model
                                | showModal =
                                    CsvUploadModal
                                        { state
                                            | columnMapping = Just suggestions.columnMappings
                                            , carrierMapping = Just { detectedCarriers = state.detectedCarriers, mappings = suggestions.carrierMappings }
                                        }
                              }
                            , Cmd.none
                            )

                        Err _ ->
                            ( { model | showModal = CsvUploadModal { state | error = Just "Failed to get column suggestions" } }
                            , Cmd.none
                            )

                _ ->
                    ( model, Cmd.none )

        ExtractCarrierValues ->
            case model.showModal of
                CsvUploadModal state ->
                    case state.file of
                        Just file ->
                            -- Get carrier column from the column mapping
                            let
                                carrierColumn =
                                    case state.columnMapping of
                                        Just mapping ->
                                            if String.isEmpty mapping.currentCarrier then
                                                Nothing

                                            else
                                                Just mapping.currentCarrier

                                        Nothing ->
                                            Nothing
                            in
                            case carrierColumn of
                                Just column ->
                                    ( { model | showModal = CsvUploadModal { state | extractingCarriers = True } }
                                    , Task.perform
                                        (\content -> CarrierValuesExtracted (extractUniqueCarriers content column))
                                        (File.toString file)
                                    )

                                Nothing ->
                                    ( model, Cmd.none )

                        Nothing ->
                            ( model, Cmd.none )

                _ ->
                    ( model, Cmd.none )

        CarrierValuesExtracted carrierValues ->
            case model.showModal of
                CsvUploadModal state ->
                    -- Instead of making a new API call, create a structure from the model's carriers list
                    let
                        -- Create a map of common carrier aliases for better matching
                        carrierAliases =
                            Dict.fromList
                                [ ( "Aetna", [ "aetna medicare", "aetna advantage", "aetna health", "aetna cvs" ] )
                                , ( "United Healthcare", [ "uhc", "united health", "united", "aarp", "aarp / uhc", "aarp/uhc" ] )
                                , ( "Humana", [ "humana gold", "humana gold plus", "humana choice", "humana value", "humana preferred" ] )
                                , ( "Cigna", [ "cigna healthspring", "cigna-healthspring", "cigna health", "connecticut general" ] )
                                , ( "Blue Cross Blue Shield", [ "bcbs", "blue cross", "blue shield", "anthem", "anthem bcbs" ] )
                                , ( "Wellcare", [ "wellcare by allwell", "allwell", "wellcare value", "wellcare essentials" ] )
                                , ( "Kaiser Permanente", [ "kaiser", "kp", "kaiser senior advantage" ] )
                                , ( "Anthem", [ "anthem blue", "anthem medicare", "anthem medigap" ] )
                                , ( "Molina", [ "molina healthcare", "molina advantage", "molina health" ] )
                                , ( "Ace Chubb", [ "ace / chubb", "ace/chubb", "ace chubb", "chubb" ] )
                                ]

                        -- Convert the simple carriers string list to the format expected by CsvProcessor
                        -- and enhance with known aliases
                        standardCarriers =
                            List.map
                                (\name ->
                                    { name = name
                                    , aliases = Dict.get name carrierAliases |> Maybe.withDefault []
                                    }
                                )
                                model.carriers

                        -- Use CsvProcessor to suggest carrier mappings
                        carrierMapping =
                            CsvProcessor.suggestCarrierMappings carrierValues standardCarriers
                    in
                    ( { model
                        | showModal =
                            CsvUploadModal
                                { state
                                    | detectedCarriers = carrierValues
                                    , carrierMapping = Just carrierMapping
                                    , extractingCarriers = False
                                }
                      }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        UpdateCarrierMapping original mapped ->
            case model.showModal of
                CsvUploadModal state ->
                    case state.carrierMapping of
                        Just mapping ->
                            let
                                updatedMappings =
                                    Dict.insert original mapped mapping.mappings

                                updatedMapping =
                                    { mapping | mappings = updatedMappings }
                            in
                            ( { model | showModal = CsvUploadModal { state | carrierMapping = Just updatedMapping } }
                            , Cmd.none
                            )

                        Nothing ->
                            ( model, Cmd.none )

                _ ->
                    ( model, Cmd.none )

        GotCarriersForMapping detectedCarriers (Ok carriers) ->
            let
                -- Use CsvProcessor to suggest carrier mappings with fuzzy matching
                carrierMapping =
                    CsvProcessor.suggestCarrierMappings detectedCarriers carriers
            in
            case model.showModal of
                CsvUploadModal state ->
                    ( { model
                        | showModal =
                            CsvUploadModal
                                { state
                                    | carrierMapping = Just carrierMapping
                                    , extractingCarriers = False
                                }
                      }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )

        GotCarriersForMapping _ (Err error) ->
            case model.showModal of
                CsvUploadModal state ->
                    ( { model
                        | showModal =
                            CsvUploadModal
                                { state
                                    | extractingCarriers = False
                                    , error = Just "Failed to fetch carrier data for matching"
                                }
                      }
                    , Cmd.none
                    )

                _ ->
                    ( model, Cmd.none )



-- TODO: Handle error
-- Add other update cases here...
-- VIEW


view : Model -> Html Msg
view model =
    div [ class "min-h-screen bg-white" ]
        [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" ]
            [ -- Limit banner - use our reusable component
              LimitBanner.view model.limitBanner
                |> Html.map LimitBannerMsg
            , -- Stats Section - Make more compact with reduced margins
              div [ class "grid grid-cols-4 gap-2 mb-3" ]
                [ statsCard "Total Contacts" (String.fromInt model.pagination.totalItems)
                , statsCard "Emails Sent" "1824"
                , statsCard "Emails Clicked" "425"
                , statsCard "Quotes Created" "385"
                ]
            , -- Table Container with overflow handling - reduced vertical spacing
              div [ class "overflow-x-auto max-w-7xl mx-auto" ]
                [ -- Add a container around both the header and the table to ensure they have the same width
                  div [ class "w-full" ]
                    [ -- Contacts header and filters - reduced margin bottom
                      div [ class "flex justify-between items-center mb-3 w-full" ]
                        [ div [ class "flex items-center gap-2" ]
                            [ h1 [ class "text-base font-semibold" ] [ text "Contacts " ]
                            , span [ class "text-sm text-gray-500" ]
                                [ text ("(" ++ String.fromInt model.pagination.totalItems ++ ")") ]
                            ]
                        , div [ class "flex items-center gap-2" ]
                            [ -- Only show Agent filter for admins
                              if isAdminOrAdminAgent model.currentUser then
                                div [ class "relative" ]
                                    [ button
                                        [ class "inline-flex items-center gap-1 px-2 py-1 border rounded-md text-sm text-gray-700 hover:bg-gray-50"
                                        , onClick (ToggleFilterDropdown AgentFilter)
                                        ]
                                        [ text "Agent"
                                        , viewIcon "M19 9l-7 7-7-7"
                                        ]
                                    , if model.openFilter == Just AgentFilter then
                                        viewFilterDropdown model AgentFilter

                                      else
                                        text ""
                                    ]

                              else
                                text ""
                            , div [ class "relative" ]
                                [ button
                                    [ class "inline-flex items-center gap-1 px-2 py-1 border rounded-md text-sm text-gray-700 hover:bg-gray-50"
                                    , onClick (ToggleFilterDropdown CarrierFilter)
                                    ]
                                    [ text "Carrier"
                                    , viewIcon "M19 9l-7 7-7-7"
                                    ]
                                , if model.openFilter == Just CarrierFilter then
                                    viewFilterDropdown model CarrierFilter

                                  else
                                    text ""
                                ]
                            , div [ class "relative" ]
                                [ button
                                    [ class "inline-flex items-center gap-1 px-2 py-1 border rounded-md text-sm text-gray-700 hover:bg-gray-50"
                                    , onClick (ToggleFilterDropdown StateFilter)
                                    ]
                                    [ text "State"
                                    , viewIcon "M19 9l-7 7-7-7"
                                    ]
                                , if model.openFilter == Just StateFilter then
                                    viewFilterDropdown model StateFilter

                                  else
                                    text ""
                                ]
                            , div [ class "relative" ]
                                [ input
                                    [ class "w-48 px-2 py-1 border rounded-md text-sm placeholder-gray-500 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                                    , placeholder "Search contacts..."
                                    , value model.searchQuery
                                    , onInput UpdateSearchQuery
                                    ]
                                    []
                                ]
                            , -- Add the add contact button with a different style
                              button
                                [ class "px-2 py-1 bg-black text-white rounded-md text-sm hover:bg-gray-800 transition-colors"
                                , onClick ShowContactChoiceModal
                                ]
                                [ text "+ Add Contact" ]
                            ]
                        ]
                    , table [ class "w-full" ]
                        [ colgroup []
                            [ col [ class "w-12" ] [] -- Checkbox
                            , col [ class "w-48" ] [] -- Name
                            , col [ class "w-32" ] [] -- Contact Status
                            , col [ class "w-48" ] [] -- Email
                            , col [ class "w-32" ] [] -- Phone Number
                            , col [ class "w-16" ] [] -- State
                            , col [ class "w-32" ] [] -- Assigned Agent
                            , col [ class "w-32" ] [] -- Current Carrier
                            , col [ class "w-28" ] [] -- Effective Date
                            , col [ class "w-20" ] [] -- Actions
                            ]
                        , thead [ class "bg-gray-50" ]
                            [ tr []
                                [ th [ class "sticky top-0 px-2 py-1 border-b border-gray-200 bg-gray-50" ]
                                    [ input
                                        [ type_ "checkbox"
                                        , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                        , checked (not (List.isEmpty model.contacts) && List.length model.selectedContacts == List.length model.contacts)
                                        , onClick
                                            (if not (List.isEmpty model.contacts) && List.length model.selectedContacts == List.length model.contacts then
                                                DeselectAllContacts

                                             else
                                                SelectAllContacts
                                            )
                                        ]
                                        []
                                    ]
                                , tableHeader "Name"
                                , tableHeader "Contact Status"
                                , tableHeader "Email"
                                , tableHeader "Phone Number"
                                , tableHeader "State"
                                , tableHeader "Assigned Agent"
                                , tableHeader "Current Carrier"
                                , tableHeader "Effective Date"
                                , tableHeader "Actions"
                                ]
                            ]
                        , tbody [ class "bg-white" ]
                            (if model.isLoadingContacts then
                                [ tr []
                                    [ td
                                        [ class "px-3 py-8 text-sm text-gray-500 text-center border-t border-gray-200"
                                        , attribute "colspan" "10"
                                        ]
                                        [ div [ class "flex items-center justify-center gap-3" ]
                                            [ viewSpinner
                                            , text "Loading contacts..."
                                            ]
                                        ]
                                    ]
                                ]

                             else if List.isEmpty model.contacts then
                                [ tr []
                                    [ td
                                        [ class "px-3 py-2 text-sm text-gray-500 text-center border-t border-gray-200"
                                        , attribute "colspan" "10"
                                        ]
                                        [ text "No contacts found" ]
                                    ]
                                ]

                             else
                                List.concatMap (viewTableRow model) model.contacts
                            )
                        ]
                    ]
                ]
            ]
        , viewModals model
        , if not (List.isEmpty model.selectedContacts) then
            viewBulkActionBar model

          else
            text ""
        , viewPaginationControls model -- Add pagination controls
        ]


viewBulkActionBar : Model -> Html Msg
viewBulkActionBar model =
    let
        isAdmin =
            isAdminOrAdminAgent model.currentUser
    in
    div
        [ class "fixed bottom-0 inset-x-0 bg-white border-t border-gray-200 shadow-lg transform transition-all duration-200" ]
        [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4" ]
            [ div [ class "flex justify-between items-center" ]
                [ div [ class "flex items-center gap-4" ]
                    [ span [ class "text-sm text-gray-600" ]
                        [ text (String.fromInt (List.length model.selectedContacts) ++ " contacts selected") ]
                    ]
                , div [ class "flex items-center gap-3" ]
                    [ button
                        [ class "px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900"
                        , onClick DeselectAllContacts
                        ]
                        [ text "Cancel" ]
                    , if isAdmin then
                        -- Reassign button (only for admins)
                        button
                            [ class "px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors duration-200 mr-2"
                            , onClick ShowReassignAgentModal
                            ]
                            [ text "Reassign Agent" ]

                      else
                        text ""
                    , button
                        [ class "px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors duration-200"
                        , onClick ShowDeleteConfirmModal
                        ]
                        [ if model.isDeletingContacts then
                            viewSpinner

                          else
                            text "Delete Selected"
                        ]
                    ]
                ]
            ]
        ]


statsCard : String -> String -> Html Msg
statsCard title value =
    div [ class "bg-white rounded-md border p-2 hover:shadow-md transition-shadow flex flex-col items-center" ]
        [ div [ class "text-xs text-gray-600 mb-0.5 text-center" ] [ text title ]
        , div [ class "text-xl font-semibold text-center" ] [ text value ]
        ]


tableHeader : String -> Html Msg
tableHeader headerText =
    th [ class "px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-200 bg-gray-50" ]
        [ text headerText ]


viewTableRow : Model -> Contact -> List (Html Msg)
viewTableRow model contact =
    let
        cellClass =
            "px-2 py-1 text-sm border-t border-gray-200"

        initials =
            String.left 1 contact.firstName ++ String.left 1 contact.lastName

        agentName =
            case contact.contactOwner of
                Just owner ->
                    owner.firstName ++ " " ++ owner.lastName

                Nothing ->
                    case contact.agentId of
                        Just agentId ->
                            -- Try to find the agent in our agents list
                            let
                                matchingAgent =
                                    List.filter (\agent -> agent.id == agentId) model.agents
                                        |> List.head
                            in
                            case matchingAgent of
                                Just agent ->
                                    agent.firstName ++ " " ++ agent.lastName

                                Nothing ->
                                    -- Fallback if agent not found in list
                                    "Agent #" ++ String.fromInt agentId

                        Nothing ->
                            "Default"

        currentCarrier =
            Maybe.withDefault "" contact.currentCarrier
    in
    [ tr [ class "hover:bg-gray-50 transition-colors duration-200" ]
        [ td
            [ class (cellClass ++ " text-center")
            ]
            [ input
                [ type_ "checkbox"
                , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                , checked (List.member contact.id model.selectedContacts)
                , onClick (ToggleSelectContact contact.id)
                ]
                []
            ]
        , td [ class cellClass ]
            [ div [ class "flex items-center" ]
                [ div [ class "h-8 w-8 rounded-full bg-purple-100 flex items-center justify-center text-sm text-purple-700 font-medium uppercase" ]
                    [ text initials ]
                , div [ class "ml-3 text-sm text-gray-900" ]
                    [ button
                        [ class "text-left text-gray-900 hover:text-purple-600 transition-colors duration-200"
                        , onClick (NavigateToContact contact.id)
                        ]
                        [ text (contact.firstName ++ " " ++ contact.lastName) ]
                    ]
                ]
            ]
        , td [ class cellClass ]
            [ viewStatus contact.status ]
        , td [ class cellClass ]
            [ text contact.email ]
        , td [ class cellClass ]
            [ text (formatPhoneNumber contact.phoneNumber) ]
        , td [ class cellClass ]
            [ text contact.state ]
        , td [ class cellClass ]
            [ text agentName ]
        , td [ class cellClass ]
            [ text currentCarrier ]
        , td [ class cellClass ]
            [ text contact.effectiveDate ]
        , td [ class cellClass ]
            [ button
                [ class "text-purple-600 hover:text-purple-800 transition-colors duration-200"
                , onClick (NavigateToContact contact.id)
                ]
                [ viewIcon "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" ]
            ]
        ]
    ]


viewStatus : String -> Html Msg
viewStatus status =
    let
        ( bgColor, textColor, statusText ) =
            case status of
                "Quote Created" ->
                    ( "bg-green-50", "text-green-700", "Quote Created" )

                "Opened Email" ->
                    ( "bg-red-50", "text-red-700", "Opened Email" )

                "Email #2 Sent" ->
                    ( "bg-blue-50", "text-blue-700", "Email #2 Sent" )

                "Email #1 Sent" ->
                    ( "bg-blue-50", "text-blue-700", "Email #1 Sent" )

                "In Queue" ->
                    ( "bg-orange-50", "text-orange-700", "In Queue" )

                _ ->
                    ( "bg-gray-50", "text-gray-700", status )
    in
    div [ class ("inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium " ++ bgColor ++ " " ++ textColor) ]
        [ text statusText ]



-- HELPERS


updateContact : Contact -> List Contact -> List Contact
updateContact updated contacts =
    List.map
        (\contact ->
            if contact.id == updated.id then
                updated

            else
                contact
        )
        contacts



-- HTTP


submitAddForm : ContactForm -> Cmd Msg
submitAddForm form =
    Http.post
        { url = "/api/contacts"
        , body = Http.jsonBody (encodeContactForm form)
        , expect = Http.expectJson ContactAdded contactDecoder
        }


submitEditFormWithFlag : ContactForm -> Bool -> Cmd Msg
submitEditFormWithFlag form isZipUpdate =
    case form.id of
        Just id ->
            let
                url =
                    if isZipUpdate then
                        "/api/contacts/" ++ String.fromInt id ++ "?zip_update=true"

                    else
                        "/api/contacts/" ++ String.fromInt id
            in
            Http.request
                { method = "PUT"
                , headers = []
                , url = url
                , body = Http.jsonBody (encodeContactForm form)
                , expect = Http.expectJson ContactUpdated contactDecoder
                , timeout = Nothing
                , tracker = Nothing
                }

        Nothing ->
            Cmd.none



-- JSON


contactDecoder : Decode.Decoder Contact
contactDecoder =
    Decode.succeed Contact
        |> Pipeline.required "id" Decode.int
        |> Pipeline.required "first_name" Decode.string
        |> Pipeline.required "last_name" Decode.string
        |> Pipeline.required "email" Decode.string
        |> Pipeline.optional "phone_number"
            (Decode.string
                |> Decode.andThen
                    (\val -> Decode.succeed val)
            )
            ""
        |> Pipeline.required "state" Decode.string
        |> Pipeline.optional "contact_owner_id" (Decode.nullable Decode.int) Nothing
        |> Pipeline.optional "contact_owner" (Decode.nullable userDecoder) Nothing
        |> Pipeline.optional "current_carrier" (Decode.nullable Decode.string) Nothing
        |> Pipeline.required "effective_date" Decode.string
        |> Pipeline.required "birth_date" Decode.string
        |> Pipeline.required "tobacco_user" Decode.bool
        |> Pipeline.required "gender" Decode.string
        |> Pipeline.required "zip_code" Decode.string
        |> Pipeline.optional "plan_type" (Decode.nullable Decode.string) Nothing
        |> Pipeline.optional "status" Decode.string "New"
        |> Pipeline.required "agent_id" (Decode.nullable Decode.int)
        |> Pipeline.required "last_emailed" (Decode.nullable Decode.string)


contactsDecoder : Decode.Decoder ContactsResponse
contactsDecoder =
    Decode.succeed ContactsResponse
        |> Pipeline.required "contacts" (Decode.list contactDecoder)
        |> Pipeline.required "filterOptions" filterOptionsDecoder
        |> Pipeline.required "total" Decode.int
        |> Pipeline.required "page" Decode.int
        |> Pipeline.required "limit" Decode.int


filterOptionsDecoder : Decode.Decoder AvailableFilters
filterOptionsDecoder =
    Decode.succeed AvailableFilters
        |> Pipeline.required "carriers" (Decode.list Decode.string)
        |> Pipeline.required "states" (Decode.list Decode.string)


encodeContactForm : ContactForm -> Encode.Value
encodeContactForm form =
    let
        planType =
            case form.planType of
                Just value ->
                    Encode.string value

                Nothing ->
                    Encode.null

        currentCarrier =
            case form.currentCarrier of
                Just value ->
                    Encode.string value

                Nothing ->
                    Encode.null
    in
    Encode.object
        [ ( "first_name", Encode.string form.firstName )
        , ( "last_name", Encode.string form.lastName )
        , ( "email", Encode.string form.email )
        , ( "phone_number", Encode.string (String.filter Char.isDigit form.phoneNumber |> String.left 10) )
        , ( "state", Encode.string form.state )
        , ( "contact_owner_id", Maybe.map Encode.int form.contactOwnerId |> Maybe.withDefault Encode.null )
        , ( "current_carrier", currentCarrier )
        , ( "effective_date", Encode.string form.effectiveDate )
        , ( "birth_date", Encode.string form.birthDate )
        , ( "tobacco_user", Encode.bool form.tobaccoUser )
        , ( "gender", Encode.string form.gender )
        , ( "zip_code", Encode.string form.zipCode )
        , ( "plan_type", planType )
        ]


viewModals : Model -> Html Msg
viewModals model =
    case model.showModal of
        NoModal ->
            text ""

        ContactChoiceModal ->
            viewContactChoiceModal

        AddModal ->
            viewAddModal model model.isSubmittingForm

        EditModal contact ->
            viewEditModal model model.isSubmittingForm

        CsvUploadModal state ->
            viewCsvUploadModal state model.isUploadingCsv model

        DeleteConfirmModal ->
            viewDeleteConfirmModal model

        ReassignAgentModal ->
            viewReassignAgentModal model


viewContactChoiceModal : Html Msg
viewContactChoiceModal =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-4" ]
        [ div [ class "bg-white rounded-md p-5 max-w-lg w-full mx-2 shadow-lg relative" ]
            [ button
                [ class "absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ viewIcon "M6 18L18 6M6 6l12 12" ]
            , h2 [ class "text-xl font-semibold text-gray-900 mb-2" ]
                [ text "Add Contacts" ]
            , div [ class "text-xs text-gray-600 mb-4" ]
                [ text "Select how you want to add your new contacts." ]
            , div [ class "grid grid-cols-2 gap-3" ]
                [ div
                    [ class "p-3 border border-gray-200 rounded-md hover:border-[#03045E] hover:bg-[#03045E]/5 cursor-pointer transition-colors"
                    , onClick ChooseSingleContact
                    ]
                    [ div [ class "flex items-center mb-2" ]
                        [ div [ class "h-6 w-6 rounded-full bg-purple-100 flex items-center justify-center text-xs text-purple-700 font-medium" ]
                            [ viewIcon "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" ]
                        ]
                    , h3 [ class "text-base font-medium text-gray-900 mb-1" ]
                        [ text "Single Contact" ]
                    , p [ class "text-xs text-gray-600" ]
                        [ text "Individual Form" ]
                    ]
                , div
                    [ class "p-3 border border-gray-200 rounded-md hover:border-[#03045E] hover:bg-[#03045E]/5 cursor-pointer transition-colors"
                    , onClick ChooseMultipleContacts
                    ]
                    [ div [ class "flex items-center mb-2" ]
                        [ div [ class "h-6 w-6 rounded-full bg-purple-100 flex items-center justify-center text-xs text-purple-700 font-medium" ]
                            [ viewIcon "M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" ]
                        ]
                    , h3 [ class "text-base font-medium text-gray-900 mb-1" ]
                        [ text "Multiple Contacts" ]
                    , p [ class "text-xs text-gray-600" ]
                        [ text "CSV Upload" ]
                    ]
                ]
            ]
        ]


viewAddModal : Model -> Bool -> Html Msg
viewAddModal model isSubmitting =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-4" ]
        [ div [ class "bg-white rounded-md p-5 max-w-lg w-full mx-2 shadow-lg relative max-h-[90vh] flex flex-col" ]
            [ button
                [ class "absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ viewIcon "M6 18L18 6M6 6l12 12" ]
            , h2 [ class "text-xl font-semibold text-gray-900 mb-4" ]
                [ text "Add New Client" ]
            , div [ class "overflow-y-auto pr-1 flex-grow" ]
                [ viewContactForm model model.addForm UpdateAddForm SubmitAddForm "Add Client" isSubmitting ]
            ]
        ]


viewEditModal : Model -> Bool -> Html Msg
viewEditModal model isSubmitting =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-4" ]
        [ div [ class "bg-white rounded-md p-5 max-w-lg w-full mx-2 shadow-lg relative max-h-[90vh] flex flex-col" ]
            [ button
                [ class "absolute top-2 right-2 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ viewIcon "M6 18L18 6M6 6l12 12" ]
            , h2 [ class "text-xl font-semibold text-gray-900 mb-4" ]
                [ text "Edit Client" ]
            , div [ class "overflow-y-auto pr-1 flex-grow" ]
                [ viewContactForm model model.editForm UpdateEditForm SubmitEditForm "Save Changes" isSubmitting ]
            ]
        ]


viewCsvUploadModal : UploadState -> Bool -> Model -> Html Msg
viewCsvUploadModal state isUploading model =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-8" ]
        [ div [ class "bg-white rounded-xl p-10 max-w-2xl w-full mx-4 shadow-xl relative max-h-[90vh] overflow-y-auto" ]
            [ button
                [ class "absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ viewIcon "M6 18L18 6M6 6l12 12" ]
            , h2 [ class "text-2xl font-semibold text-gray-900 mb-8" ]
                [ text "Upload CSV" ]
            , div [ class "mb-6 text-sm text-gray-600" ]
                [ text "Need help formatting your CSV? "
                , Html.a
                    [ class "text-purple-600 hover:text-purple-800 hover:underline"
                    , Html.Attributes.href "/example.csv"
                    , Html.Attributes.download "example.csv"
                    ]
                    [ text "Download example CSV file" ]
                ]

            -- Error display
            , if state.error /= Nothing then
                div [ class "mb-6" ]
                    [ if state.stats /= Nothing then
                        let
                            stats =
                                Maybe.withDefault
                                    { totalRows = 0
                                    , errorRows = 0
                                    , validRows = 0
                                    , converted_carrier_rows = 0
                                    , supported_carriers = []
                                    }
                                    state.stats
                        in
                        div []
                            [ if stats.errorRows > 0 then
                                div [ class "p-4 mb-4 bg-red-50 border border-red-200 rounded-lg" ]
                                    [ div [ class "flex items-start" ]
                                        [ div [ class "flex-shrink-0" ]
                                            [ viewIcon "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" ]
                                        , div [ class "ml-3" ]
                                            [ h3 [ class "text-sm font-medium text-red-800" ]
                                                [ text "Upload Errors" ]
                                            , div [ class "mt-2 text-sm text-red-700" ]
                                                [ text ("Found " ++ String.fromInt stats.errorRows ++ " rows with errors. Successfully imported " ++ String.fromInt stats.validRows ++ " rows.")
                                                , case state.errorCsv of
                                                    Just csvContent ->
                                                        div [ class "mt-2 font-medium" ]
                                                            [ button
                                                                [ class "text-purple-600 hover:text-purple-800 hover:underline"
                                                                , onClick (DownloadErrorCsv csvContent)
                                                                ]
                                                                [ text "Download and Fix Error Rows" ]
                                                            ]

                                                    Nothing ->
                                                        text ""
                                                ]
                                            ]
                                        ]
                                    ]

                              else
                                text ""
                            , if stats.converted_carrier_rows > 0 then
                                div [ class "p-4 bg-yellow-50 border border-yellow-200 rounded-lg" ]
                                    [ div [ class "flex items-start" ]
                                        [ div [ class "flex-shrink-0" ]
                                            [ viewIcon "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" ]
                                        , div [ class "ml-3" ]
                                            [ h3 [ class "text-sm font-medium text-yellow-800 mb-3" ]
                                                [ text "Carrier Conversions" ]
                                            , div [ class "space-y-4 text-sm text-yellow-700" ]
                                                [ p []
                                                    [ text (String.fromInt stats.converted_carrier_rows ++ " rows had carriers we do not currently recognize or provide quotes for. This is normal and expected -- we will still email these contacts with quotes from supported Carriers.") ]
                                                , p []
                                                    [ text "However, this can also happen if there is a misspelling of a supported carrier. Please review to ensure the data is correct." ]
                                                , case state.converted_carriers_csv of
                                                    Just csvContent ->
                                                        div [ class "pt-1" ]
                                                            [ button
                                                                [ class "text-purple-600 hover:text-purple-800 hover:underline font-medium"
                                                                , onClick (DownloadCarrierConversionsCsv csvContent)
                                                                ]
                                                                [ text "Download Unrecognized Carrier Rows" ]
                                                            ]

                                                    Nothing ->
                                                        text ""
                                                , div [ class "pt-2 border-t border-yellow-200" ]
                                                    [ details [ class "text-sm" ]
                                                        [ summary [ class "cursor-pointer text-purple-600 hover:text-purple-800 font-medium" ]
                                                            [ text "Click to see supported carriers" ]
                                                        , div [ class "mt-3 pl-4 space-y-2" ]
                                                            (List.map
                                                                (\carrier ->
                                                                    div [ class "flex items-baseline" ]
                                                                        [ span [ class "font-medium" ] [ text carrier.name ]
                                                                        , if not (List.isEmpty carrier.aliases) then
                                                                            span [ class "ml-4 text-yellow-800" ]
                                                                                [ text ("Also accepts: " ++ String.join ", " carrier.aliases) ]

                                                                          else
                                                                            text ""
                                                                        ]
                                                                )
                                                                stats.supported_carriers
                                                            )
                                                        ]
                                                    ]
                                                ]
                                            ]
                                        ]
                                    ]

                              else
                                text ""
                            ]

                      else
                        div [ class "p-4 bg-red-50 border border-red-200 rounded-lg" ]
                            [ div [ class "flex items-start" ]
                                [ div [ class "flex-shrink-0" ]
                                    [ viewIcon "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" ]
                                , div [ class "ml-3" ]
                                    [ h3 [ class "text-sm font-medium text-red-800" ]
                                        [ text "Error uploading CSV" ]
                                    , div [ class "mt-2 text-sm text-red-700" ]
                                        [ text (Maybe.withDefault "" state.error) ]
                                    ]
                                ]
                            ]
                    ]

              else
                text ""

            -- Form fields (agent selection, etc.)
            , div [ class "mb-4 space-y-4" ]
                [ case model.currentUser of
                    Just user ->
                        if user.isAdmin then
                            div [ class "flex items-center space-x-2" ]
                                [ input
                                    [ type_ "checkbox"
                                    , checked state.overwriteDuplicates
                                    , onInput (\val -> ToggleOverwriteDuplicates (val == "true"))
                                    , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                    ]
                                    []
                                , label [ class "text-sm text-gray-600" ]
                                    [ text "Overwrite existing contacts (matched on email address)" ]
                                ]

                        else
                            text ""

                    Nothing ->
                        text ""
                , div [ class "form-group" ]
                    [ Html.label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                        [ text "Assign to Agent" ]
                    , div [ class "relative" ]
                        [ if List.isEmpty model.agents then
                            div [ class "p-2 text-gray-500 border rounded" ]
                                [ text "Loading agents..." ]

                          else
                            case model.currentUser of
                                Just user ->
                                    if user.isAgent && not user.isAdmin then
                                        -- For non-admin agents, show their name as fixed value
                                        let
                                            agentName =
                                                model.agents
                                                    |> List.filter (\agent -> agent.id == user.id)
                                                    |> List.head
                                                    |> Maybe.map (\agent -> agent.firstName ++ " " ++ agent.lastName)
                                                    |> Maybe.withDefault (user.firstName ++ " " ++ user.lastName)
                                        in
                                        div [ class "w-full px-4 py-3 bg-gray-100 border-[2.5px] border-gray-300 rounded-lg text-gray-700" ]
                                            [ text agentName ]

                                    else
                                        -- For admins, show dropdown with all agents
                                        let
                                            agentOptions =
                                                List.map
                                                    (\agent ->
                                                        ( String.fromInt agent.id
                                                        , agent.firstName ++ " " ++ agent.lastName
                                                        )
                                                    )
                                                    model.agents
                                        in
                                        Html.select
                                            [ class "w-full px-4 py-3 bg-white border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 appearance-none"
                                            , value (String.fromInt (Maybe.withDefault 0 state.selectedAgentId))
                                            , onInput (\val -> SelectUploadAgent (String.toInt val |> Maybe.withDefault 0))
                                            ]
                                            (List.map
                                                (\( val, label ) ->
                                                    option [ value val ] [ text label ]
                                                )
                                                agentOptions
                                            )

                                Nothing ->
                                    text ""
                        ]
                    ]
                ]

            -- File upload area
            , if state.processingHeaders then
                -- Show loading indicator while processing CSV headers
                div [ class "w-full h-64 border-2 border-gray-200 rounded-lg flex flex-col items-center justify-center p-8" ]
                    [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4" ] []
                    , div [ class "text-gray-600 text-center" ]
                        [ span [ class "block font-medium mb-1" ]
                            [ text "Processing your CSV file" ]
                        , span [ class "text-sm" ]
                            [ text "We're analyzing your file to map the columns automatically..." ]
                        ]
                    ]

              else
                div
                    [ class
                        ("w-full h-64 border-2 border-dashed rounded-lg flex flex-col items-center justify-center p-8 transition-colors "
                            ++ (if state.dragOver then
                                    "border-purple-500 bg-purple-50"

                                else
                                    "border-gray-300 hover:border-purple-400"
                               )
                        )
                    , preventDefaultOn "dragenter" (Decode.succeed ( DragEnter, True ))
                    , preventDefaultOn "dragover" (Decode.succeed ( NoOp, True ))
                    , preventDefaultOn "dragleave" (Decode.succeed ( DragLeave, True ))
                    , preventDefaultOn "drop" (dropDecoder FileDrop)
                    ]
                    [ div [ class "text-gray-500 text-center" ]
                        [ span [ class "block text-lg font-medium mb-2" ]
                            [ text "Drag and drop your CSV file here, or " ]
                        , button
                            [ class "text-purple-600 font-semibold hover:text-purple-700 focus:outline-none focus:underline"
                            , onClick ClickedSelectFile
                            ]
                            [ text "browse" ]
                        , if state.file /= Nothing then
                            div [ class "mt-4 text-sm bg-green-50 text-green-800 px-3 py-2 rounded-lg" ]
                                [ text ("File selected: " ++ (Maybe.map File.name state.file |> Maybe.withDefault "")) ]

                          else
                            text ""
                        ]
                    ]

            -- Column mapping section
            , if state.file /= Nothing && not state.processingHeaders && not (List.isEmpty state.csvHeaders) then
                div [ class "mt-8 space-y-6" ]
                    [ viewColumnMapping state
                    , viewCarrierMapping state model.carriers
                    , div [ class "mt-4" ]
                        [ h3 [ class "text-sm font-medium text-gray-700 mb-2" ]
                            [ text "Available CSV Columns" ]
                        , div [ class "bg-gray-50 p-3 rounded-md text-sm" ]
                            [ span [ class "text-gray-400 mr-2" ]
                                [ text "Headers:" ]
                            , span [ class "text-gray-600" ]
                                [ text (String.join ", " state.csvHeaders) ]
                            ]
                        ]
                    ]

              else
                text ""

            -- Buttons
            , div [ class "mt-8 flex justify-end space-x-4" ]
                [ button
                    [ class "px-6 py-3 bg-gray-100 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200 focus:ring-4 focus:ring-gray-200"
                    , onClick CloseModal
                    ]
                    [ text "Cancel" ]
                , if isUploading then
                    div [ class "px-6 py-3 flex items-center space-x-2" ]
                        [ viewSpinner ]

                  else
                    button
                        [ type_ "submit"
                        , class "px-6 py-3 bg-purple-500 text-white text-sm font-medium rounded-lg hover:bg-purple-600 transition-colors duration-200 focus:ring-4 focus:ring-purple-200"
                        , onClick UploadCsv
                        , Html.Attributes.disabled (state.file == Nothing || state.processingHeaders)
                        ]
                        [ text "Upload" ]
                ]
            ]
        ]


viewColumnMapping : UploadState -> Html Msg
viewColumnMapping state =
    div [ class "space-y-4" ]
        [ h3 [ class "text-sm font-medium text-gray-700 flex justify-between" ]
            [ text "Column Mapping"
            , span [ class "text-xs text-purple-600" ]
                [ text ("Detected " ++ String.fromInt (List.length state.csvHeaders) ++ " columns in your CSV") ]
            ]
        , p [ class "text-xs text-gray-500" ]
            [ text "Map your CSV columns to our required fields." ]
        , div [ class "grid grid-cols-2 gap-3" ]
            [ viewColumnMapField "First Name" "firstName" state
            , viewColumnMapField "Last Name" "lastName" state
            , viewColumnMapField "Email" "email" state
            , viewColumnMapField "Phone Number" "phoneNumber" state
            , viewColumnMapField "State" "state" state
            , viewColumnMapField "Current Carrier" "currentCarrier" state
            , viewColumnMapField "Effective Date" "effectiveDate" state
            , viewColumnMapField "Birth Date" "birthDate" state
            , viewColumnMapField "Tobacco User" "tobaccoUser" state
            , viewColumnMapField "Gender" "gender" state
            , viewColumnMapField "ZIP Code" "zipCode" state
            , viewColumnMapField "Plan Type" "planType" state
            ]
        ]


viewCarrierMapping : UploadState -> List String -> Html Msg
viewCarrierMapping state supportedCarriers =
    let
        carrierColumnName =
            case state.columnMapping of
                Just mapping ->
                    mapping.currentCarrier

                Nothing ->
                    ""

        hasCarrierColumn =
            not (String.isEmpty carrierColumnName)

        hasExtractedCarriers =
            not (List.isEmpty state.detectedCarriers)
    in
    div [ class "mt-6 space-y-4 border-t pt-6" ]
        [ h3 [ class "text-sm font-medium text-gray-700" ]
            [ text "Carrier Mapping" ]
        , p [ class "text-xs text-gray-500" ]
            [ text "Map carrier names in your CSV to standard carrier names in our system." ]

        -- Show which column is used for carrier data
        , div [ class "mb-4" ]
            [ if hasCarrierColumn then
                div [ class "flex space-x-2" ]
                    [ div [ class "text-xs font-medium text-gray-600 py-1" ]
                        [ text ("Using column \"" ++ carrierColumnName ++ "\" for carrier data") ]
                    , button
                        [ class "px-3 py-1 bg-purple-500 text-white text-xs font-medium rounded hover:bg-purple-600 transition-colors"
                        , onClick ExtractCarrierValues
                        , disabled state.extractingCarriers
                        ]
                        [ if state.extractingCarriers then
                            div [ class "flex items-center" ]
                                [ viewSpinner
                                , span [ class "ml-2" ] [ text "Extracting..." ]
                                ]

                          else
                            text "Extract Carriers"
                        ]
                    ]

              else
                div [ class "text-xs text-gray-500 italic" ]
                    [ text "Select a column for \"Current Carrier\" in the mapping above to continue." ]
            ]

        -- Show carrier mappings once extracted
        , if hasExtractedCarriers then
            div [ class "border rounded-md p-4 bg-gray-50" ]
                [ p [ class "text-xs text-gray-600 mb-3" ]
                    [ text ("Found " ++ String.fromInt (List.length state.detectedCarriers) ++ " unique carrier names in your CSV.") ]
                , if List.isEmpty state.detectedCarriers then
                    div [ class "text-sm text-gray-500 italic" ]
                        [ text "No carrier names found in the selected column." ]

                  else
                    div [ class "space-y-2 max-h-64 overflow-y-auto pr-2" ]
                        (List.map
                            (\carrier -> viewCarrierMappingRow carrier state supportedCarriers)
                            state.detectedCarriers
                        )
                ]

          else if hasCarrierColumn then
            div [ class "text-sm text-gray-500 italic" ]
                [ text "Click 'Extract Carriers' to analyze carrier names in your CSV." ]

          else
            div [ class "text-sm text-gray-500 italic" ]
                [ text "Select the \"Current Carrier\" column in the mapping above to begin." ]
        ]


viewCarrierMappingRow : String -> UploadState -> List String -> Html Msg
viewCarrierMappingRow carrier state supportedCarriers =
    let
        currentMapping =
            case state.carrierMapping of
                Just mapping ->
                    Dict.get carrier mapping.mappings
                        |> Maybe.withDefault "Other"

                Nothing ->
                    "Other"
    in
    div [ class "flex justify-between items-center py-1 border-b border-gray-200" ]
        [ div [ class "text-sm text-gray-700" ]
            [ text carrier ]
        , div [ class "w-1/2" ]
            [ select
                [ class "w-full px-2 py-1 text-sm border rounded"
                , value currentMapping
                , onInput (UpdateCarrierMapping carrier)
                ]
                (option [ value "Other" ] [ text "Other/Unsupported" ]
                    :: List.map
                        (\c ->
                            option
                                [ value c
                                , selected (currentMapping == c)
                                ]
                                [ text c ]
                        )
                        supportedCarriers
                )
            ]
        ]


viewColumnMapField : String -> String -> UploadState -> Html Msg
viewColumnMapField labelText field state =
    div [ class "flex flex-col gap-1" ]
        [ label [ class "text-xs font-medium text-gray-600" ]
            [ text labelText ]
        , select
            [ class "w-full px-2 py-1 text-sm border rounded"
            , value (getColumnMapping field state)
            , onInput (UpdateColumnMapping field)
            ]
            (option [ value "" ] [ text "Select a column" ]
                :: List.map
                    (\header ->
                        option
                            [ value header
                            , selected (getColumnMapping field state == header)
                            ]
                            [ text header ]
                    )
                    state.csvHeaders
            )
        ]


getColumnMapping : String -> UploadState -> String
getColumnMapping field state =
    case state.columnMapping of
        Just mapping ->
            case field of
                "firstName" ->
                    mapping.firstName

                "lastName" ->
                    mapping.lastName

                "email" ->
                    mapping.email

                "phoneNumber" ->
                    mapping.phoneNumber

                "state" ->
                    mapping.state

                "currentCarrier" ->
                    mapping.currentCarrier

                "effectiveDate" ->
                    mapping.effectiveDate

                "birthDate" ->
                    mapping.birthDate

                "tobaccoUser" ->
                    mapping.tobaccoUser

                "gender" ->
                    mapping.gender

                "zipCode" ->
                    mapping.zipCode

                "planType" ->
                    mapping.planType

                _ ->
                    ""

        Nothing ->
            ""


dropDecoder : (File -> msg) -> Decoder ( msg, Bool )
dropDecoder toMsg =
    Decode.at [ "dataTransfer", "files" ] (Decode.index 0 File.decoder)
        |> Decode.map (\file -> ( toMsg file, True ))


uploadCsv : File -> Bool -> Maybe Int -> Model -> Cmd Msg
uploadCsv file overwriteDuplicates maybeAgentId model =
    let
        actualOverwriteValue =
            case model.currentUser of
                Just user ->
                    if user.isAgent && not user.isAdmin then
                        False

                    else
                        overwriteDuplicates

                Nothing ->
                    overwriteDuplicates
    in
    File.toString file
        |> Task.andThen
            (\csvContent ->
                case model.showModal of
                    CsvUploadModal state ->
                        case ( state.columnMapping, state.carrierMapping ) of
                            ( Just colMapping, Just carrierMapping ) ->
                                case CsvProcessor.processCsvToContacts csvContent colMapping carrierMapping of
                                    Ok contacts ->
                                        Http.task
                                            { method = "POST"
                                            , headers = []
                                            , url = "/api/contacts/bulk-import"
                                            , body =
                                                Http.jsonBody
                                                    (Encode.object
                                                        [ ( "contacts", Encode.list encodeProcessedContact contacts )
                                                        , ( "overwriteExisting", Encode.bool actualOverwriteValue )
                                                        , ( "agentId"
                                                          , case maybeAgentId of
                                                                Just id ->
                                                                    Encode.int id

                                                                Nothing ->
                                                                    Encode.null
                                                          )
                                                        ]
                                                    )
                                            , resolver =
                                                Http.stringResolver <|
                                                    \response ->
                                                        case response of
                                                            Http.GoodStatus_ _ body ->
                                                                case Decode.decodeString uploadResponseDecoder body of
                                                                    Ok value ->
                                                                        Ok value

                                                                    Err err ->
                                                                        Err (Http.BadBody (Decode.errorToString err))

                                                            Http.BadUrl_ url ->
                                                                Err (Http.BadUrl url)

                                                            Http.Timeout_ ->
                                                                Err Http.Timeout

                                                            Http.NetworkError_ ->
                                                                Err Http.NetworkError

                                                            Http.BadStatus_ metadata _ ->
                                                                Err (Http.BadStatus metadata.statusCode)
                                            , timeout = Nothing
                                            }
                                            |> Task.map Ok
                                            |> Task.onError (\err -> Task.succeed (Err err))

                                    Err err ->
                                        Task.succeed
                                            (Err
                                                (Http.BadBody
                                                    (case err of
                                                        CsvProcessor.ParseError msg ->
                                                            "Failed to parse CSV: " ++ msg

                                                        CsvProcessor.EmptyFile ->
                                                            "CSV file is empty"

                                                        CsvProcessor.NoHeaders ->
                                                            "CSV file has no headers"
                                                    )
                                                )
                                            )

                            _ ->
                                Task.succeed
                                    (Err
                                        (Http.BadBody "Column mapping or carrier mapping not configured")
                                    )

                    _ ->
                        Task.succeed
                            (Err
                                (Http.BadBody "Invalid modal state")
                            )
            )
        |> Task.perform CsvUploaded



-- Add encoder for processed contacts


encodeProcessedContact : CsvProcessor.ProcessedContact -> Encode.Value
encodeProcessedContact contact =
    Encode.object
        [ ( "first_name", Encode.string contact.firstName )
        , ( "last_name", Encode.string contact.lastName )
        , ( "email", Encode.string contact.email )
        , ( "phone_number", Encode.string contact.phoneNumber )
        , ( "state", Encode.string contact.state )
        , ( "current_carrier", Encode.string contact.currentCarrier )
        , ( "effective_date", Encode.string contact.effectiveDate )
        , ( "birth_date", Encode.string contact.birthDate )
        , ( "tobacco_user", Encode.bool contact.tobaccoUser )
        , ( "gender", Encode.string contact.gender )
        , ( "zip_code", Encode.string contact.zipCode )
        , ( "plan_type", Encode.string contact.planType )
        ]



-- Helper function to encode column mapping to JSON


encodeColumnMapping : ColumnMapping -> String
encodeColumnMapping mapping =
    Encode.encode 0
        (Encode.object
            [ ( "firstName", Encode.string mapping.firstName )
            , ( "lastName", Encode.string mapping.lastName )
            , ( "email", Encode.string mapping.email )
            , ( "phoneNumber", Encode.string mapping.phoneNumber )
            , ( "state", Encode.string mapping.state )
            , ( "currentCarrier", Encode.string mapping.currentCarrier )
            , ( "effectiveDate", Encode.string mapping.effectiveDate )
            , ( "birthDate", Encode.string mapping.birthDate )
            , ( "tobaccoUser", Encode.string mapping.tobaccoUser )
            , ( "gender", Encode.string mapping.gender )
            , ( "zipCode", Encode.string mapping.zipCode )
            , ( "planType", Encode.string mapping.planType )
            ]
        )



-- Helper function to encode carrier mapping to JSON


encodeCarrierMapping : CarrierMapping -> String
encodeCarrierMapping mapping =
    Encode.encode 0
        (Encode.object
            [ ( "detectedCarriers", Encode.list Encode.string mapping.detectedCarriers )
            , ( "mappings", Encode.dict identity Encode.string mapping.mappings )
            ]
        )


uploadResponseDecoder : Decode.Decoder UploadResponse
uploadResponseDecoder =
    let
        errorCsvDecoder =
            Decode.oneOf
                [ Decode.string |> Decode.map Just
                , Decode.null Nothing
                ]
    in
    Decode.succeed UploadResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.required "message" Decode.string
        |> Pipeline.required "error_csv" errorCsvDecoder
        |> Pipeline.required "converted_carriers_csv" errorCsvDecoder
        |> Pipeline.required "total_rows" Decode.int
        |> Pipeline.required "error_rows" Decode.int
        |> Pipeline.required "valid_rows" Decode.int
        |> Pipeline.required "converted_carrier_rows" Decode.int
        |> Pipeline.required "supported_carriers" (Decode.list carrierDecoder)


type alias UploadResponse =
    { success : Bool
    , message : String
    , errorCsv : Maybe String
    , converted_carriers_csv : Maybe String
    , totalRows : Int
    , errorRows : Int
    , validRows : Int
    , converted_carrier_rows : Int
    , supported_carriers : List { name : String, aliases : List String }
    }


formatUploadError : String -> String
formatUploadError message =
    if String.startsWith "Missing required columns:" message then
        let
            missingColumns =
                String.dropLeft (String.length "Missing required columns:") message
                    |> String.trim
                    |> String.split ","
                    |> List.map String.trim
                    |> String.join ", "
        in
        "Your CSV is missing the following required columns: " ++ missingColumns ++ ". Please add these columns and try again."

    else
        message



-- Add this new subscription function


subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.batch
        [ case model.showModal of
            NoModal ->
                Sub.none

            ContactChoiceModal ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))

            AddModal ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))

            EditModal _ ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))

            CsvUploadModal _ ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))

            DeleteConfirmModal ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))

            ReassignAgentModal ->
                Browser.Events.onKeyDown (Decode.map HandleKeyDown (Decode.field "key" Decode.string))
        , if model.openFilter /= Nothing then
            -- Only listen for clicks outside when a dropdown is open
            Browser.Events.onMouseDown (Decode.succeed CloseFilterDropdown)

          else
            Sub.none
        ]


sortContacts : Maybe SortColumn -> SortDirection -> List Contact -> List Contact
sortContacts maybeColumn direction contacts =
    case maybeColumn of
        Nothing ->
            contacts

        Just column ->
            let
                comparator =
                    case column of
                        NameCol ->
                            \a b ->
                                compare
                                    (a.firstName ++ " " ++ a.lastName)
                                    (b.firstName ++ " " ++ b.lastName)

                        StatusCol ->
                            \a b -> compare a.status b.status

                        EmailCol ->
                            \a b -> compare a.email b.email

                        PhoneNumberCol ->
                            \a b -> compare a.phoneNumber b.phoneNumber

                        StateCol ->
                            \a b -> compare a.state b.state

                        ContactOwnerCol ->
                            \a b ->
                                compare
                                    (Maybe.map .firstName a.contactOwner |> Maybe.withDefault "Default")
                                    (Maybe.map .firstName b.contactOwner |> Maybe.withDefault "Default")

                        CurrentCarrierCol ->
                            \a b ->
                                compare
                                    (Maybe.withDefault "" a.currentCarrier)
                                    (Maybe.withDefault "" b.currentCarrier)

                        EffectiveDateCol ->
                            \a b -> compare a.effectiveDate b.effectiveDate
            in
            List.sortWith
                (if direction == Ascending then
                    comparator

                 else
                    \a b -> comparator b a
                )
                contacts


filterContacts : Filters -> String -> Time.Posix -> List Contact -> List Contact
filterContacts filters searchQuery currentTime contacts =
    contacts
        |> filterBySearch searchQuery
        |> filterByCarriers filters.carriers
        |> filterByList .state filters.states
        |> filterByAge filters.ageRange
        |> filterByAgents filters.agents


filterByCarriers : List String -> List Contact -> List Contact
filterByCarriers carriers contacts =
    if List.isEmpty carriers then
        contacts

    else
        List.filter
            (\contact ->
                case contact.currentCarrier of
                    Just carrier ->
                        List.member carrier carriers

                    Nothing ->
                        False
            )
            contacts


filterBySearch : String -> List Contact -> List Contact
filterBySearch query contacts =
    if String.isEmpty query then
        contacts

    else
        let
            loweredQuery =
                String.toLower query
        in
        List.filter
            (\contact ->
                String.contains loweredQuery (String.toLower contact.firstName)
                    || String.contains loweredQuery (String.toLower contact.lastName)
                    || (case contact.currentCarrier of
                            Just carrier ->
                                String.contains loweredQuery (String.toLower carrier)

                            Nothing ->
                                False
                       )
            )
            contacts


filterByAge : Maybe ( Int, Int ) -> List Contact -> List Contact
filterByAge maybeRange contacts =
    case maybeRange of
        Nothing ->
            contacts

        Just ( min, max ) ->
            List.filter
                (\contact ->
                    let
                        age =
                            calculateAge contact.birthDate
                    in
                    age >= min && age <= max
                )
                contacts


calculateAge : String -> Int
calculateAge birthDate =
    -- This is a simplified version. You might want to use a proper date library
    2024 - (String.left 4 birthDate |> String.toInt |> Maybe.withDefault 0)


toggleFilter : Filters -> FilterType -> String -> Filters
toggleFilter filters filterType value =
    case filterType of
        CarrierFilter ->
            { filters | carriers = toggleList filters.carriers value }

        StateFilter ->
            { filters | states = toggleList filters.states value }

        AgeFilter ->
            { filters | ageRange = toggleAgeRange filters.ageRange value }

        AgentFilter ->
            { filters | agents = toggleAgentList filters.agents (String.toInt value |> Maybe.withDefault 0) }


toggleList : List String -> String -> List String
toggleList list value =
    if List.member value list then
        List.filter (\v -> v /= value) list

    else
        value :: list


toggleAgeRange : Maybe ( Int, Int ) -> String -> Maybe ( Int, Int )
toggleAgeRange maybeRange value =
    case maybeRange of
        Nothing ->
            Just ( String.toInt value |> Maybe.withDefault 0, String.toInt value |> Maybe.withDefault 0 )

        Just ( min, max ) ->
            if min == (String.toInt value |> Maybe.withDefault 0) then
                Just ( String.toInt value |> Maybe.withDefault 0, max )

            else if max == (String.toInt value |> Maybe.withDefault 0) then
                Just ( min, String.toInt value |> Maybe.withDefault 0 )

            else
                Just ( min, max )


setAgeFilter : Int -> Int -> Filters -> Filters
setAgeFilter min max filters =
    if max < 1 then
        { filters | ageRange = Nothing }
        -- Don't apply filter if max is 0 or negative

    else
        { filters | ageRange = Just ( min, max ) }



-- Helper function to get unique values from contacts


getUniqueValues : (Contact -> String) -> List Contact -> List String
getUniqueValues getter contacts =
    contacts
        |> List.map getter
        |> List.sort
        |> List.Extra.unique


zipInfoDecoder : Decode.Decoder ZipInfo
zipInfoDecoder =
    Decode.succeed ZipInfo
        |> Pipeline.required "state" Decode.string
        |> Pipeline.required "counties" (Decode.list Decode.string)
        |> Pipeline.required "cities" (Decode.list Decode.string)


filterByList : (Contact -> String) -> List String -> List Contact -> List Contact
filterByList getter selectedValues contacts =
    if List.isEmpty selectedValues then
        contacts

    else
        List.filter
            (\contact ->
                List.member (getter contact) selectedValues
            )
            contacts


viewContactForm : Model -> ContactForm -> (ContactFormField -> String -> Msg) -> Msg -> String -> Bool -> Html Msg
viewContactForm model form updateMsg submitMsg buttonText isSubmitting =
    let
        carrierOptions =
            ( "", "Select a carrier" ) :: List.map (\c -> ( c, c )) (model.carriers ++ [ "Other" ])

        planTypeOptions =
            [ ( "", "Select a plan type" ), ( "Plan N", "Plan N" ), ( "Plan G", "Plan G" ), ( "Other", "Other" ) ]

        -- Simple agent dropdown options - show all available agents
        agentOptions =
            if List.isEmpty model.agents then
                -- If no agents loaded, use current user as fallback if they're an agent
                case model.currentUser of
                    Just user ->
                        [ ( String.fromInt user.id, user.firstName ++ " " ++ user.lastName ) ]

                    Nothing ->
                        []

            else
                -- Just show all available agents
                List.map
                    (\agent ->
                        ( String.fromInt agent.id, agent.firstName ++ " " ++ agent.lastName )
                    )
                    model.agents

        -- Get the selected agent ID or default to first agent
        defaultAgentId =
            case List.head model.agents of
                Just agent ->
                    String.fromInt agent.id

                Nothing ->
                    -- Try current user as fallback
                    case model.currentUser of
                        Just user ->
                            String.fromInt user.id

                        Nothing ->
                            ""

        selectedAgentId =
            case form.contactOwnerId of
                Just id ->
                    String.fromInt id

                Nothing ->
                    defaultAgentId

        selectedCarrier =
            Maybe.withDefault "" form.currentCarrier

        emailField =
            div [ class "form-group mb-3 relative" ]
                [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
                    [ text "Email" ]
                , div [ class "relative" ]
                    [ Html.input
                        [ type_ "email"
                        , class
                            ("w-full px-2 py-1.5 bg-white border-[1.5px] rounded-md text-sm text-gray-700 placeholder-gray-400 shadow-sm transition-all duration-200 "
                                ++ (if model.emailExists then
                                        "border-red-300 hover:border-red-400 focus:border-red-500 focus:ring-1 focus:ring-red-200"

                                    else
                                        "border-purple-300 hover:border-purple-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-200"
                                   )
                            )
                        , value form.email
                        , onInput (updateMsg Email)
                        , required True
                        ]
                        []
                    , if model.isCheckingEmail then
                        div [ class "absolute right-2 top-1.5" ]
                            [ viewSpinner ]

                      else if model.emailExists then
                        div
                            [ class "absolute right-2 top-1.5 text-red-500" ]
                            [ viewIcon "M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" ]

                      else if String.length form.email > 0 then
                        div
                            [ class "absolute right-2 top-1.5 text-green-500" ]
                            [ viewIcon "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" ]

                      else
                        text ""
                    ]
                , if model.emailExists then
                    div [ class "mt-1 text-xs text-red-600" ]
                        [ text "A contact with this email already exists" ]

                  else
                    text ""
                ]
    in
    Html.form [ onSubmit submitMsg ]
        [ div [ class "grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-3" ]
            [ viewFormInput "First Name" "text" form.firstName FirstName updateMsg True
            , viewFormInput "Last Name" "text" form.lastName LastName updateMsg True
            , emailField
            , viewFormInput "Phone Number" "text" form.phoneNumber PhoneNumber updateMsg True
            , viewFormSelect "Current Carrier" selectedCarrier CurrentCarrier updateMsg carrierOptions
            , viewFormSelect "Plan Type" (Maybe.withDefault "" form.planType) PlanType updateMsg planTypeOptions
            , viewFormSelectWithValue "Assigned Agent" selectedAgentId ContactOwnerId updateMsg agentOptions
            , viewFormInput "Effective Date" "date" form.effectiveDate EffectiveDate updateMsg True
            , viewFormInput "Birth Date" "date" form.birthDate BirthDate updateMsg True
            , viewFormRadioGroup "Tobacco User"
                (if form.tobaccoUser then
                    "true"

                 else
                    "false"
                )
                TobaccoUser
                updateMsg
                [ ( "true", "Yes" ), ( "false", "No" ) ]
            , viewFormRadioGroup "Gender" form.gender Gender updateMsg [ ( "M", "Male" ), ( "F", "Female" ) ]
            , div [ class "col-span-1 sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4" ]
                [ viewZipCodeField model form
                , viewStateField form
                ]
            ]
        , if model.error /= Nothing && not model.emailExists then
            div [ class "mt-2 text-red-600 text-xs" ] [ text (Maybe.withDefault "" model.error) ]

          else
            text ""
        , div [ class "mt-4 flex justify-end space-x-2" ]
            [ button
                [ type_ "button"
                , onClick CloseModal
                , class "px-3 py-1.5 bg-white text-gray-700 text-sm font-medium rounded-md border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors duration-200 focus:ring-1 focus:ring-purple-100"
                ]
                [ text "Cancel" ]
            , if isSubmitting then
                div [ class "px-3 py-1.5 flex items-center" ] [ viewSpinner ]

              else
                let
                    isValid =
                        isContactFormValid form && not model.emailExists && not model.isCheckingEmail
                in
                button
                    [ type_ "submit"
                    , class
                        ("px-3 py-1.5 text-white text-sm font-medium rounded-md transition-colors duration-200 focus:ring-1 focus:ring-purple-200 "
                            ++ (if isValid then
                                    "bg-purple-500 hover:bg-purple-600"

                                else
                                    "bg-gray-300 cursor-not-allowed"
                               )
                        )
                    , Html.Attributes.disabled (not isValid)
                    ]
                    [ text buttonText ]
            ]
        ]


viewFormInput : String -> String -> String -> ContactFormField -> (ContactFormField -> String -> Msg) -> Bool -> Html Msg
viewFormInput labelText inputType inputValue field updateMsg isRequired =
    let
        displayValue =
            if field == PhoneNumber then
                formatPhoneNumber inputValue

            else
                inputValue

        inputHandler =
            if field == PhoneNumber then
                \val ->
                    let
                        digits =
                            String.filter Char.isDigit val |> String.left 10
                    in
                    updateMsg field digits

            else
                updateMsg field

        placeholderText =
            if field == PhoneNumber then
                "(555) 555-5555"

            else
                ""
    in
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text labelText ]
        , Html.input
            [ type_ inputType
            , class "w-full px-2 py-1.5 bg-white border-[1.5px] border-purple-300 rounded-md text-sm text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-200 focus:bg-white transition-all duration-200"
            , value displayValue
            , onInput inputHandler
            , required isRequired
            , placeholder placeholderText
            ]
            []
        ]


viewFormSelect : String -> String -> ContactFormField -> (ContactFormField -> String -> Msg) -> List ( String, String ) -> Html Msg
viewFormSelect labelText selectedValue field updateMsg options =
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text labelText ]
        , Html.select
            [ class "w-full px-2 py-1.5 bg-white border-[1.5px] border-purple-300 rounded-md text-sm text-gray-700 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-200 focus:bg-white transition-all duration-200"
            , value selectedValue
            , onInput (updateMsg field)
            ]
            (List.map
                (\( val, label ) ->
                    Html.option
                        [ value val, selected (val == selectedValue) ]
                        [ text label ]
                )
                options
            )
        ]


viewFormRadioGroup : String -> String -> ContactFormField -> (ContactFormField -> String -> Msg) -> List ( String, String ) -> Html Msg
viewFormRadioGroup labelText selectedValue field updateMsg options =
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text labelText ]
        , div [ class "flex gap-2" ]
            (List.map
                (\( val, txt ) ->
                    label
                        [ class
                            ("flex items-center px-2 py-1 rounded-md border text-sm cursor-pointer transition-all duration-200 "
                                ++ (if selectedValue == val then
                                        "border-purple-500 bg-purple-50 text-purple-700"

                                    else
                                        "border-gray-200 hover:border-purple-200"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value val
                            , checked (selectedValue == val)
                            , onInput (\_ -> updateMsg field val)
                            , class "sr-only" -- Hide the actual radio button
                            ]
                            []
                        , text txt
                        ]
                )
                options
            )
        ]


viewZipCodeField : Model -> ContactForm -> Html Msg
viewZipCodeField model form =
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text "ZIP Code" ]
        , Html.input
            [ type_ "text"
            , class "w-full px-2 py-1.5 bg-white border-[1.5px] border-purple-300 rounded-md text-sm text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-200 focus:bg-white transition-all duration-200"
            , value form.zipCode
            , onInput
                (\zip ->
                    Batch
                        [ case model.showModal of
                            AddModal ->
                                UpdateAddForm ZipCode zip

                            EditModal _ ->
                                UpdateEditForm ZipCode zip

                            _ ->
                                NoOp
                        , if String.length zip == 5 then
                            LookupZipCode zip

                          else
                            NoOp
                        ]
                )
            ]
            []
        ]


viewStateField : ContactForm -> Html Msg
viewStateField form =
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text "State" ]
        , Html.input
            [ type_ "text"
            , class "w-full px-2 py-1.5 bg-white border-[1.5px] border-gray-200 rounded-md text-sm text-gray-700 placeholder-gray-400 shadow-sm focus:ring-1 focus:ring-purple-200 focus:bg-white transition-all duration-200"
            , value form.state
            , Html.Attributes.disabled True
            ]
            []
        ]


viewSpinner : Html msg
viewSpinner =
    div [ class "animate-spin rounded-full h-5 w-5 border-2 border-purple-500 border-t-transparent" ] []


onClickOutside : msg -> Html.Attribute msg
onClickOutside msg =
    on "click" (Decode.succeed msg)


userDecoder : Decode.Decoder User
userDecoder =
    Decode.succeed User
        |> Pipeline.required "id" Decode.int
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "first_name" Decode.string
        |> Pipeline.required "last_name" Decode.string
        |> Pipeline.required "is_admin" Decode.bool
        |> Pipeline.required "is_agent" Decode.bool
        |> Pipeline.required "organization_id" Decode.int
        |> Pipeline.required "is_active" Decode.bool
        |> Pipeline.required "phone" Decode.string
        |> Pipeline.optional "carriers" (Decode.list Decode.string) []
        |> Pipeline.optional "stateLicenses" (Decode.list Decode.string) []


deleteContacts : List Int -> Cmd Msg
deleteContacts contactIds =
    Http.request
        { method = "DELETE"
        , headers = []
        , url = "/api/contacts"
        , body = Http.jsonBody (encodeContactIds contactIds)
        , expect = Http.expectJson ContactsDeleted deleteResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


encodeContactIds : List Int -> Encode.Value
encodeContactIds ids =
    Encode.list Encode.int ids


deleteResponseDecoder : Decode.Decoder DeleteResponse
deleteResponseDecoder =
    Decode.map3 DeleteResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "deleted_ids" (Decode.list Decode.int))
        (Decode.field "message" Decode.string)



-- HELPER FUNCTIONS


isAdminOrAdminAgent : Maybe User -> Bool
isAdminOrAdminAgent maybeUser =
    case maybeUser of
        Just user ->
            let
                isAdmin =
                    user.isAdmin
            in
            isAdmin

        Nothing ->
            False


viewExpandedContent : Contact -> Html Msg
viewExpandedContent contact =
    div
        [ class "grid grid-cols-5 gap-4 py-2 px-4 transition-all duration-200 ease-in-out" ]
        [ viewExpandedField "Birth Date" contact.birthDate
        , viewExpandedField "Tobacco User"
            (if contact.tobaccoUser then
                "Yes"

             else
                "No"
            )
        , viewExpandedField "Gender" contact.gender
        , viewExpandedField "ZIP Code" contact.zipCode
        , viewExpandedField "Plan Type" (Maybe.withDefault "" contact.planType)
        ]


viewExpandedField : String -> String -> Html Msg
viewExpandedField label value =
    div [ class "text-sm" ]
        [ span [ class "font-medium text-gray-500" ] [ text label ]
        , div [ class "mt-1 text-gray-900" ] [ text value ]
        ]


viewIcon : String -> Html Msg
viewIcon path =
    svg
        [ Svg.Attributes.class "w-4 h-4"
        , Svg.Attributes.fill "none"
        , Svg.Attributes.stroke "currentColor"
        , Svg.Attributes.viewBox "0 0 24 24"
        ]
        [ Svg.path [ Svg.Attributes.d path ] [] ]



-- HTTP FUNCTIONS


fetchContacts : Model -> Cmd Msg
fetchContacts model =
    let
        queryParams =
            [ ( "search", model.searchQuery )
            , ( "states", String.join "," model.activeFilters.states )
            , ( "carriers", String.join "," model.activeFilters.carriers )
            , ( "agents"
              , model.activeFilters.agents
                    |> List.map String.fromInt
                    |> String.join ","
              )
            , ( "page", String.fromInt model.pagination.currentPage )
            , ( "limit", String.fromInt model.pagination.itemsPerPage )
            ]
                |> List.filter (\( _, value ) -> not (String.isEmpty value))
                |> List.map (\( key, value ) -> Url.string key value)
    in
    Http.get
        { url = Url.absolute [ "api", "contacts" ] queryParams
        , expect = Http.expectJson GotContacts contactsDecoder
        }


fetchCurrentUser : Cmd Msg
fetchCurrentUser =
    Http.get
        { url = "/api/me"
        , expect = Http.expectJson GotCurrentUser userDecoder
        }


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    if String.isEmpty phone then
        ""

    else
        let
            digits =
                String.filter Char.isDigit phone
                    |> String.left 10

            len =
                String.length digits
        in
        if len == 0 then
            ""

        else if len <= 3 then
            "(" ++ digits

        else if len <= 6 then
            "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

        else
            "(" ++ String.left 3 digits ++ ") " ++ String.slice 3 6 digits ++ "-" ++ String.dropLeft 6 digits


viewFilterDropdown : Model -> FilterType -> Html Msg
viewFilterDropdown model filterType =
    let
        options =
            case filterType of
                CarrierFilter ->
                    model.availableFilters.carriers

                StateFilter ->
                    model.availableFilters.states

                AgentFilter ->
                    -- Add "Default" option for unassigned contacts
                    "Default"
                        :: (model.agents
                                |> List.filter (\agent -> agent.isAgent)
                                |> List.map
                                    (\agent ->
                                        agent.firstName ++ " " ++ agent.lastName
                                    )
                           )

                _ ->
                    []

        activeFilters =
            case filterType of
                CarrierFilter ->
                    model.activeFilters.carriers

                StateFilter ->
                    model.activeFilters.states

                AgentFilter ->
                    model.activeFilters.agents
                        |> List.map String.fromInt

                _ ->
                    []

        hasActiveFilters =
            not (List.isEmpty activeFilters)
    in
    div
        [ class "absolute left-0 mt-2 w-60 sm:w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"

        -- IMPORTANT: This mousedown handler prevents the dropdown from closing when clicking inside it
        , Html.Events.stopPropagationOn "mousedown" (Decode.succeed ( NoOp, True ))
        ]
        [ div [ class "py-1" ]
            [ div [ class "p-2 border-b border-gray-200" ]
                [ button
                    [ class
                        ("w-full text-left text-sm font-medium "
                            ++ (if hasActiveFilters then
                                    "text-purple-600 hover:text-purple-800 cursor-pointer"

                                else
                                    "text-gray-400 cursor-not-allowed"
                               )
                        )
                    , onClick (SelectAllFilter filterType False)
                    , Html.Attributes.disabled (not hasActiveFilters)
                    ]
                    [ text "Clear Filters" ]
                ]
            , div [ class "max-h-56 sm:max-h-48 overflow-y-auto p-2" ]
                (case filterType of
                    AgentFilter ->
                        -- Special handling for agent filter since it's using IDs
                        -- First add the Default option (agentId = 0 means unassigned/default)
                        label
                            [ class "flex items-center space-x-2 py-1" ]
                            [ input
                                [ type_ "checkbox"
                                , checked (List.member 0 model.activeFilters.agents)
                                , onClick (ToggleFilter filterType (String.fromInt 0))
                                , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                ]
                                []
                            , span [ class "text-sm text-gray-600" ]
                                [ text "Default" ]
                            ]
                            :: (model.agents
                                    |> List.filter (\agent -> agent.isAgent)
                                    |> List.map
                                        (\agent ->
                                            label
                                                [ class "flex items-center space-x-2 py-1" ]
                                                [ input
                                                    [ type_ "checkbox"
                                                    , checked (List.member agent.id model.activeFilters.agents)
                                                    , onClick (ToggleFilter filterType (String.fromInt agent.id))
                                                    , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                                    ]
                                                    []
                                                , span [ class "text-sm text-gray-600" ]
                                                    [ text (agent.firstName ++ " " ++ agent.lastName) ]
                                                ]
                                        )
                               )

                    _ ->
                        -- Original handling for other filters
                        List.map
                            (\option ->
                                label
                                    [ class "flex items-center space-x-2 py-1" ]
                                    [ input
                                        [ type_ "checkbox"
                                        , checked (List.member option activeFilters)
                                        , onClick (ToggleFilter filterType option)
                                        , class "rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                        ]
                                        []
                                    , span [ class "text-sm text-gray-600" ]
                                        [ text option ]
                                    ]
                            )
                            options
                )
            ]
        ]


isContactFormValid : ContactForm -> Bool
isContactFormValid form =
    String.length form.firstName
        > 0
        && String.length form.lastName
        > 0
        && String.length form.email
        > 0
        && String.length form.phoneNumber
        > 0
        && String.length form.state
        > 0
        && String.length form.effectiveDate
        > 0
        && String.length form.birthDate
        > 0
        && String.length form.zipCode
        > 0
        && isJust form.planType


isJust : Maybe a -> Bool
isJust maybeValue =
    case maybeValue of
        Just _ ->
            True

        Nothing ->
            False


fetchCarriers : Cmd Msg
fetchCarriers =
    Http.get
        { url = "/api/settings/carriers"
        , expect = Http.expectJson GotCarriers (Decode.list (Decode.field "name" Decode.string))
        }


fetchAgents : Cmd Msg
fetchAgents =
    Http.get
        { url = "/api/agents"
        , expect = Http.expectJson GotAgents (Decode.list agentDecoder)
        }


checkEmail : String -> Cmd Msg
checkEmail email =
    Http.get
        { url = "/api/contacts/check-email/" ++ email
        , expect = Http.expectJson EmailChecked emailCheckDecoder
        }


emailCheckDecoder : Decode.Decoder { exists : Bool }
emailCheckDecoder =
    Decode.map (\exists -> { exists = exists })
        (Decode.field "exists" Decode.bool)


carrierDecoder : Decode.Decoder { name : String, aliases : List String }
carrierDecoder =
    Decode.succeed (\name aliases -> { name = name, aliases = aliases })
        |> Pipeline.required "name" Decode.string
        |> Pipeline.required "aliases" (Decode.list Decode.string)


viewDeleteConfirmModal : Model -> Html Msg
viewDeleteConfirmModal model =
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-8" ]
        [ div [ class "bg-white rounded-xl p-8 max-w-md w-full mx-4 shadow-xl relative" ]
            [ button
                [ class "absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ text "×" ]
            , h2 [ class "text-xl font-semibold text-gray-900 mb-4" ]
                [ text "Delete Contacts" ]
            , p [ class "text-sm text-gray-600 mb-6" ]
                [ text ("Are you sure you want to delete " ++ String.fromInt (List.length model.selectedContacts) ++ " contacts? This action cannot be undone.") ]
            , div [ class "flex justify-end space-x-4" ]
                [ button
                    [ class "px-4 py-2 text-gray-700 text-sm font-medium rounded-lg border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors duration-200"
                    , onClick CloseModal
                    ]
                    [ text "Cancel" ]
                , if model.isDeletingContacts then
                    div [ class "px-4 py-2 flex items-center" ]
                        [ viewSpinner ]

                  else
                    button
                        [ class "px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors duration-200"
                        , onClick DeleteSelectedContacts
                        ]
                        [ text "Delete" ]
                ]
            ]
        ]



-- Add a new function to allow setting a custom selected value


viewFormSelectWithValue : String -> String -> ContactFormField -> (ContactFormField -> String -> Msg) -> List ( String, String ) -> Html Msg
viewFormSelectWithValue labelText selectedValue field updateMsg options =
    div [ class "form-group mb-3" ]
        [ Html.label [ class "block text-xs font-medium text-gray-700 mb-1" ]
            [ text labelText ]
        , div [ class "relative" ]
            [ Html.select
                [ class "w-full px-2 py-1.5 bg-white border-[1.5px] border-purple-300 rounded-md text-sm text-gray-700 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-1 focus:ring-purple-200 focus:bg-white transition-all duration-200 appearance-none"
                , value selectedValue
                , onInput (updateMsg field)
                ]
                (option [ value "", disabled True, selected (selectedValue == "") ] [ text "Select an Agent" ]
                    :: List.map (\( val, txt ) -> option [ value val, selected (val == selectedValue) ] [ text txt ]) options
                )
            , div [ class "absolute inset-y-0 right-0 flex items-center px-1 pointer-events-none text-gray-500" ]
                [ viewIcon "M19 9l-7 7-7-7" ]
            ]
        ]


agentDecoder : Decode.Decoder User
agentDecoder =
    Decode.succeed User
        |> Pipeline.required "id"
            (Decode.oneOf
                [ -- Try to decode as an integer directly
                  Decode.int
                , -- If that fails, try to decode as a string and convert to int
                  Decode.string
                    |> Decode.andThen
                        (\str ->
                            case String.toInt str of
                                Just intVal ->
                                    Decode.succeed intVal

                                Nothing ->
                                    Decode.fail ("Could not convert agent ID string to integer: " ++ str)
                        )
                ]
            )
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "firstName" Decode.string
        |> Pipeline.required "lastName" Decode.string
        |> Pipeline.required "isAdmin" Decode.bool
        |> Pipeline.required "isAgent" Decode.bool
        |> Pipeline.optional "organizationId" Decode.int 0
        -- Add default value for isActive since it's not in the API response
        |> Pipeline.hardcoded True
        -- Assume agents are active
        |> Pipeline.optional "phone" Decode.string ""
        |> Pipeline.optional "carriers" (Decode.list Decode.string) []
        |> Pipeline.optional "stateLicenses" (Decode.list Decode.string) []


viewReassignAgentModal : Model -> Html Msg
viewReassignAgentModal model =
    let
        -- Filter to only include actual agents
        agentList =
            model.agents
                |> List.filter (\user -> user.isAgent)

        -- Add a "Default" option (NULL agent_id)
        agentOptions =
            ( 0, "Default" )
                :: List.map
                    (\agent ->
                        ( agent.id
                        , agent.firstName ++ " " ++ agent.lastName
                        )
                    )
                    agentList
    in
    div [ class "fixed inset-0 bg-gray-500/75 flex items-center justify-center p-4 sm:p-8" ]
        [ div [ class "bg-white rounded-xl p-5 sm:p-8 md:p-10 max-w-2xl w-full mx-4 shadow-xl relative overflow-y-auto max-h-[90vh]" ]
            [ button
                [ class "absolute top-2 sm:top-4 right-2 sm:right-4 text-gray-400 hover:text-gray-600 transition-colors duration-200"
                , onClick CloseModal
                ]
                [ viewIcon "M6 18L18 6M6 6l12 12" ]
            , h2 [ class "text-2xl font-semibold text-gray-900 mb-8" ]
                [ text "Reassign Contacts" ]
            , div [ class "mb-6 text-sm text-gray-600" ]
                [ text "Select an agent to reassign the selected contacts to." ]
            , div [ class "form-group" ]
                [ Html.label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                    [ text "Select Agent" ]
                , div [ class "relative" ]
                    [ if List.isEmpty model.agents then
                        div [ class "p-2 text-gray-500 border rounded" ]
                            [ text "Loading agents..." ]

                      else
                        Html.select
                            [ class "w-full px-3 py-2 sm:px-4 sm:py-3 bg-white border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 appearance-none"
                            , value (String.fromInt (Maybe.withDefault 0 model.editForm.contactOwnerId))
                            , onInput (\val -> SelectReassignAgent (String.toInt val |> Maybe.withDefault 0))
                            ]
                            (List.map
                                (\( val, label ) ->
                                    option [ value (String.fromInt val) ] [ text label ]
                                )
                                agentOptions
                            )
                    , div [ class "absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none" ]
                        [ viewIcon "M19 9l-7 7-7-7" ]
                    ]
                ]
            , div [ class "mt-8 flex justify-end space-x-4" ]
                [ button
                    [ class "px-4 py-2 sm:px-6 sm:py-3 bg-white text-gray-700 text-sm font-medium rounded-lg border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors duration-200 focus:ring-4 focus:ring-purple-100"
                    , onClick CloseModal
                    ]
                    [ text "Cancel" ]
                , button
                    [ class "px-4 py-2 sm:px-6 sm:py-3 bg-purple-500 text-white text-sm font-medium rounded-lg hover:bg-purple-600 transition-colors duration-200 focus:ring-4 focus:ring-purple-200"
                    , onClick ReassignSelectedContacts
                    ]
                    [ text "Reassign" ]
                ]
            ]
        ]


reassignContacts : List Int -> Int -> Cmd Msg
reassignContacts contactIds agentId =
    Http.request
        { method = "PUT"
        , headers = []
        , url = "/api/contacts/reassign"
        , body =
            Http.jsonBody
                (Encode.object
                    [ ( "contact_ids", Encode.list Encode.int contactIds )
                    , ( "agent_id"
                      , if agentId == 0 then
                            -- Send null for Default option
                            Encode.null

                        else
                            Encode.int agentId
                      )
                    ]
                )
        , expect = Http.expectJson ContactsReassigned reassignResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


reassignResponseDecoder : Decode.Decoder ReassignResponse
reassignResponseDecoder =
    Decode.succeed ReassignResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.required "updated_ids" (Decode.list Decode.int)
        |> Pipeline.required "message" Decode.string


toggleAgentList : List Int -> Int -> List Int
toggleAgentList list value =
    if List.member value list then
        List.filter (\v -> v /= value) list

    else
        value :: list



-- Add the filterByAgents function


filterByAgents : List Int -> List Contact -> List Contact
filterByAgents agentIds contacts =
    if List.isEmpty agentIds then
        contacts

    else
        List.filter
            (\contact ->
                case contact.agentId of
                    Just agentId ->
                        List.member agentId agentIds

                    Nothing ->
                        False
            )
            contacts



-- Replace the old contact limit banner functions with this more streamlined one


viewPaginationControls : Model -> Html Msg
viewPaginationControls model =
    let
        totalPages =
            model.pagination.totalPages

        currentPage =
            model.pagination.currentPage

        itemsPerPage =
            model.pagination.itemsPerPage

        totalItems =
            model.pagination.totalItems

        -- Calculate range of items being displayed
        startItem =
            (currentPage - 1) * itemsPerPage + 1

        endItem =
            min (currentPage * itemsPerPage) totalItems

        -- Create a list of page numbers to show
        pageNumbers =
            if totalPages <= 7 then
                List.range 1 totalPages

            else if currentPage <= 4 then
                List.range 1 5 ++ [ -1, totalPages ]

            else if currentPage >= totalPages - 3 then
                1 :: -1 :: List.range (totalPages - 4) totalPages

            else
                1 :: -1 :: List.range (currentPage - 1) (currentPage + 1) ++ [ -1, totalPages ]

        -- Helper function to render a page button
        pageButton page =
            if page == -1 then
                -- Render ellipsis for skipped pages
                span [ class "px-3 py-2 text-gray-400" ] [ text "..." ]

            else
                button
                    [ class
                        ("px-3 py-2 text-sm font-medium rounded-md transition-colors "
                            ++ (if page == currentPage then
                                    "bg-purple-50 text-purple-600 border-purple-500"

                                else
                                    "text-gray-500 hover:bg-gray-50 hover:text-gray-700"
                               )
                        )
                    , onClick (ChangePage page)
                    ]
                    [ text (String.fromInt page) ]
    in
    div [ class "mt-4 flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6" ]
        [ div [ class "flex flex-1 justify-between sm:hidden" ]
            [ button
                [ class "relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                , onClick (ChangePage (currentPage - 1))
                , Html.Attributes.disabled (currentPage == 1)
                ]
                [ text "Previous" ]
            , button
                [ class "relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
                , onClick (ChangePage (currentPage + 1))
                , Html.Attributes.disabled (currentPage == totalPages)
                ]
                [ text "Next" ]
            ]
        , div [ class "hidden sm:flex sm:flex-1 sm:items-center sm:justify-between" ]
            [ div [ class "text-sm text-gray-700" ]
                [ span [] [ text "Showing " ]
                , span [ class "font-medium" ] [ text (String.fromInt startItem) ]
                , span [] [ text " to " ]
                , span [ class "font-medium" ] [ text (String.fromInt endItem) ]
                , span [] [ text " of " ]
                , span [ class "font-medium" ] [ text (String.fromInt totalItems) ]
                , span [] [ text " results" ]
                ]
            , div [ class "flex items-center space-x-4" ]
                [ div [ class "relative" ]
                    [ select
                        [ class "block w-full rounded-md border-gray-300 py-1.5 pl-3 pr-10 text-base focus:border-purple-500 focus:outline-none focus:ring-purple-500 sm:text-sm"
                        , onInput (\val -> ChangeItemsPerPage (Maybe.withDefault 100 (String.toInt val)))
                        , value (String.fromInt itemsPerPage)
                        ]
                        [ option [ value "50" ] [ text "50 per page" ]
                        , option [ value "100" ] [ text "100 per page" ]
                        , option [ value "250" ] [ text "250 per page" ]
                        ]
                    ]
                , nav
                    [ class "isolate inline-flex -space-x-px rounded-md shadow-sm"
                    , Html.Attributes.attribute "aria-label" "Pagination"
                    ]
                    (List.map pageButton pageNumbers)
                ]
            ]
        ]


extractCsvHeaders : File -> Cmd Msg
extractCsvHeaders file =
    Task.perform
        (\content -> CsvHeadersExtracted (extractHeadersFromCsv content))
        (File.toString file)


extractHeadersFromCsv : String -> Result String (List String)
extractHeadersFromCsv csvContent =
    case CsvProcessor.extractHeaders csvContent of
        Ok headers ->
            Ok headers

        Err CsvProcessor.EmptyFile ->
            Err "CSV file appears to be empty"

        Err CsvProcessor.NoHeaders ->
            Err "CSV file has no headers"

        Err (CsvProcessor.ParseError msg) ->
            Err ("Failed to parse CSV file: " ++ msg)


suggestMappings : List String -> Cmd Msg
suggestMappings headers =
    let
        -- Use the CsvProcessor to find best matches for column mappings locally
        columnMappings =
            CsvProcessor.suggestColumnMappings headers

        -- Create an empty carrier mapping for now (will be populated later)
        carrierMappings =
            Dict.empty
    in
    -- Return the suggested mappings directly instead of making an HTTP request
    Task.perform
        (\_ ->
            SuggestedMappingsReceived
                (Ok
                    { columnMappings = columnMappings
                    , carrierMappings = carrierMappings
                    }
                )
        )
        (Task.succeed ())


extractUniqueCarriers : String -> String -> List String
extractUniqueCarriers csvContent carrierColumn =
    case CsvProcessor.extractUniqueValues csvContent carrierColumn of
        Ok values ->
            values

        Err _ ->
            []



-- Helper function to get an element at a specific index


getAt : Int -> List a -> Maybe a
getAt index list =
    if index < 0 then
        Nothing

    else
        List.head (List.drop index list)



-- Add a function to fetch carriers and create CsvProcessor.CarrierMapping compatible format


fetchAndProcessCarriers : List String -> Cmd Msg
fetchAndProcessCarriers detectedCarriers =
    -- Use a model function instead of an API call
    -- We'll use this from the GotCarriers handler
    Cmd.none

================
File: src/CsvProcessor.elm
================
module CsvProcessor exposing
    ( CarrierMapping
    , ColumnMapping
    , Error(..)
    , ProcessedContact
    , extractHeaders
    , extractUniqueValues
    , findBestMatch
    , processCsvToContacts
    , suggestCarrierMappings
    , suggestColumnMappings
    , transformCsvData
    )

import Csv.Parser
import Dict exposing (Dict)
import Fuzzy
import List.Extra
import Set



-- TYPES


type Error
    = ParseError String
    | EmptyFile
    | NoHeaders


type alias ColumnMapping =
    { firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , currentCarrier : String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : String
    , gender : String
    , zipCode : String
    , planType : String
    }


type alias CarrierMapping =
    { detectedCarriers : List String
    , mappings : Dict String String -- Original carrier name -> Standardized carrier name
    }


type alias FieldVariations =
    Dict String (List String)


emptyColumnMapping : ColumnMapping
emptyColumnMapping =
    { firstName = ""
    , lastName = ""
    , email = ""
    , phoneNumber = ""
    , state = ""
    , currentCarrier = ""
    , effectiveDate = ""
    , birthDate = ""
    , tobaccoUser = ""
    , gender = ""
    , zipCode = ""
    , planType = ""
    }


emptyCarrierMapping : CarrierMapping
emptyCarrierMapping =
    { detectedCarriers = []
    , mappings = Dict.empty
    }



-- Add new type for processed contact data


type alias ProcessedContact =
    { firstName : String
    , lastName : String
    , email : String
    , phoneNumber : String
    , state : String
    , currentCarrier : String
    , effectiveDate : String
    , birthDate : String
    , tobaccoUser : Bool
    , gender : String
    , zipCode : String
    , planType : String
    }



-- EXTRACT CSV DATA


extractHeaders : String -> Result Error (List String)
extractHeaders csvContent =
    if String.isEmpty (String.trim csvContent) then
        Err EmptyFile

    else
        case Csv.Parser.parse { fieldSeparator = ',' } csvContent of
            Ok rows ->
                case List.head rows of
                    Just headerRow ->
                        Ok headerRow

                    Nothing ->
                        Err NoHeaders

            Err _ ->
                Err (ParseError "Failed to parse CSV file")


extractUniqueValues : String -> String -> Result Error (List String)
extractUniqueValues csvContent columnName =
    if String.isEmpty (String.trim csvContent) then
        Err EmptyFile

    else
        case Csv.Parser.parse { fieldSeparator = ',' } csvContent of
            Ok rows ->
                case List.head rows of
                    Just headerRow ->
                        -- Find the index of the column
                        let
                            columnIndex =
                                List.indexedMap (\i h -> ( i, h )) headerRow
                                    |> List.filter (\( _, h ) -> h == columnName)
                                    |> List.head
                                    |> Maybe.map Tuple.first
                        in
                        case columnIndex of
                            Just index ->
                                -- Get values from that column (skip header)
                                let
                                    values =
                                        List.drop 1 rows
                                            |> List.filterMap
                                                (\row ->
                                                    if index < List.length row then
                                                        Just (getAt index row |> Maybe.withDefault "")

                                                    else
                                                        Nothing
                                                )
                                            |> List.filter (not << String.isEmpty)
                                            |> List.map String.trim
                                            |> uniqueValues
                                in
                                Ok values

                            Nothing ->
                                Err (ParseError ("Column not found: " ++ columnName))

                    Nothing ->
                        Err NoHeaders

            Err _ ->
                Err (ParseError "Failed to parse CSV file")



-- FUZZY MATCHING AND SUGGESTIONS


suggestColumnMappings : List String -> ColumnMapping
suggestColumnMappings headers =
    let
        -- Field name variations
        fieldVariations =
            createFieldVariations

        -- For each field, find the best matching header
        findBestHeader : String -> List String -> List String -> String
        findBestHeader field variations allHeaders =
            let
                -- Try exact matches first
                exactMatches =
                    List.filter
                        (\h ->
                            List.member (String.toLower h) (List.map String.toLower (field :: variations))
                        )
                        allHeaders
            in
            case List.head exactMatches of
                Just match ->
                    match

                Nothing ->
                    -- Try fuzzy matching if no exact matches
                    findBestMatch field variations allHeaders
    in
    { firstName = findBestHeader "firstName" (Maybe.withDefault [] (Dict.get "firstName" fieldVariations)) headers
    , lastName = findBestHeader "lastName" (Maybe.withDefault [] (Dict.get "lastName" fieldVariations)) headers
    , email = findBestHeader "email" (Maybe.withDefault [] (Dict.get "email" fieldVariations)) headers
    , phoneNumber = findBestHeader "phoneNumber" (Maybe.withDefault [] (Dict.get "phoneNumber" fieldVariations)) headers
    , state = findBestHeader "state" (Maybe.withDefault [] (Dict.get "state" fieldVariations)) headers
    , currentCarrier = findBestHeader "currentCarrier" (Maybe.withDefault [] (Dict.get "currentCarrier" fieldVariations)) headers
    , effectiveDate = findBestHeader "effectiveDate" (Maybe.withDefault [] (Dict.get "effectiveDate" fieldVariations)) headers
    , birthDate = findBestHeader "birthDate" (Maybe.withDefault [] (Dict.get "birthDate" fieldVariations)) headers
    , tobaccoUser = findBestHeader "tobaccoUser" (Maybe.withDefault [] (Dict.get "tobaccoUser" fieldVariations)) headers
    , gender = findBestHeader "gender" (Maybe.withDefault [] (Dict.get "gender" fieldVariations)) headers
    , zipCode = findBestHeader "zipCode" (Maybe.withDefault [] (Dict.get "zipCode" fieldVariations)) headers
    , planType = findBestHeader "planType" (Maybe.withDefault [] (Dict.get "planType" fieldVariations)) headers
    }


suggestCarrierMappings : List String -> List { name : String, aliases : List String } -> CarrierMapping
suggestCarrierMappings detectedCarriers standardCarriers =
    let
        mappings =
            List.foldl
                (\carrier dict ->
                    let
                        matchedCarrier =
                            findBestCarrierMatch carrier standardCarriers
                    in
                    Dict.insert carrier matchedCarrier dict
                )
                Dict.empty
                detectedCarriers
    in
    { detectedCarriers = detectedCarriers
    , mappings = mappings
    }


findBestCarrierMatch : String -> List { name : String, aliases : List String } -> String
findBestCarrierMatch carrierName standardCarriers =
    let
        normalizedCarrierName =
            String.toLower (String.trim carrierName)

        -- Add special case handling for common patterns
        specialCaseMatch =
            case normalizedCarrierName of
                "aarp" ->
                    Just "United Healthcare"

                "aarp / uhc" ->
                    Just "United Healthcare"

                "aarp/uhc" ->
                    Just "United Healthcare"

                "aarp / uhica" ->
                    Just "United Healthcare"

                "aarp/uhica" ->
                    Just "United Healthcare"

                "uhc" ->
                    Just "United Healthcare"

                "uhica" ->
                    Just "United Healthcare"

                "ace / chubb" ->
                    Just "Ace Chubb"

                "ace/chubb" ->
                    Just "Ace Chubb"

                "ace chubb" ->
                    Just "Ace Chubb"

                "cigna healthspring" ->
                    Just "Cigna"

                "cigna-healthspring" ->
                    Just "Cigna"

                "bcbs" ->
                    Just "Blue Cross Blue Shield"

                "blue cross" ->
                    Just "Blue Cross Blue Shield"

                "blue shield" ->
                    Just "Blue Cross Blue Shield"

                "humana gold" ->
                    Just "Humana"

                "humana gold plus" ->
                    Just "Humana"

                "wellcare by allwell" ->
                    Just "Wellcare"

                "allwell" ->
                    Just "Wellcare"

                _ ->
                    Nothing

        -- First check for special case matches
        -- Then check for exact matches
        -- Then try fuzzy matching
        exactMatches =
            List.filter
                (\carrier ->
                    String.toLower carrier.name
                        == normalizedCarrierName
                        || List.member normalizedCarrierName (List.map String.toLower carrier.aliases)
                )
                standardCarriers

        -- Try fuzzy matching if no exact match
        fuzzyMatches =
            if List.isEmpty exactMatches then
                List.map
                    (\carrier ->
                        let
                            -- Match against carrier name
                            nameScore =
                                Fuzzy.match [] [] normalizedCarrierName (String.toLower carrier.name)

                            -- Match against aliases and take best score
                            aliasScores =
                                List.map
                                    (\alias -> Fuzzy.match [] [] normalizedCarrierName (String.toLower alias))
                                    carrier.aliases

                            bestAliasScore =
                                List.sortBy .score aliasScores
                                    |> List.head
                                    |> Maybe.withDefault { score = 100000, matches = [] }

                            -- Take the better of the name or alias match
                            bestScore =
                                if nameScore.score <= bestAliasScore.score then
                                    nameScore.score

                                else
                                    bestAliasScore.score
                        in
                        ( carrier.name, bestScore )
                    )
                    standardCarriers
                    |> List.sortBy Tuple.second
                    |> List.head

            else
                Nothing
    in
    case specialCaseMatch of
        Just name ->
            name

        Nothing ->
            case exactMatches of
                carrier :: _ ->
                    carrier.name

                [] ->
                    case fuzzyMatches of
                        Just ( name, score ) ->
                            -- Only use fuzzy match if the score is good enough
                            if score < 10 then
                                name

                            else
                                "Other"

                        Nothing ->
                            "Other"



-- Default to "Other" if no good match found


findBestMatch : String -> List String -> List String -> String
findBestMatch field variations candidates =
    let
        -- Normalize everything for comparison
        normalize s =
            String.toLower (String.trim s)

        normalizedField =
            normalize field

        normalizedVariations =
            List.map normalize variations

        normalizedCandidates =
            List.map normalize candidates

        -- Get the candidate with the best fuzzy match score
        allQueries =
            normalizedField :: normalizedVariations

        scoredCandidates =
            List.map2
                (\normalizedCandidate originalCandidate ->
                    let
                        scores =
                            List.map
                                (\query ->
                                    Fuzzy.match [] [] query normalizedCandidate
                                )
                                allQueries

                        bestScore =
                            List.sortBy .score scores
                                |> List.head
                                |> Maybe.withDefault { score = 100000, matches = [] }
                    in
                    ( originalCandidate, bestScore.score )
                )
                normalizedCandidates
                candidates

        bestMatch =
            List.sortBy Tuple.second scoredCandidates
                |> List.head
                |> Maybe.map Tuple.first
                |> Maybe.withDefault ""
    in
    bestMatch



-- HELPERS


getAt : Int -> List a -> Maybe a
getAt index list =
    if index < 0 then
        Nothing

    else
        List.head (List.drop index list)


uniqueValues : List String -> List String
uniqueValues list =
    list
        |> Set.fromList
        |> Set.toList


createFieldVariations : FieldVariations
createFieldVariations =
    Dict.fromList
        [ ( "firstName", [ "first_name", "firstname", "first name", "fname", "first", "given name", "givenname" ] )
        , ( "lastName", [ "last_name", "lastname", "last name", "lname", "last", "surname", "family name", "familyname" ] )
        , ( "email", [ "email_address", "emailaddress", "email address", "e_mail", "e-mail" ] )
        , ( "phoneNumber", [ "phone_number", "phonenumber", "phone", "cell", "mobile", "telephone", "contact_number", "contact number", "phone number", "cell number", "mobile number" ] )
        , ( "state", [ "st", "province", "region", "state code", "statecode" ] )
        , ( "currentCarrier", [ "current_carrier", "current carrier", "carrier", "insurance_provider", "insurance provider", "provider", "current_provider", "current provider", "insurance", "insurance carrier", "insurance_carrier", "insurancecarrier" ] )
        , ( "effectiveDate", [ "effective_date", "effectivedate", "effective date", "start_date", "startdate", "start date", "date_effective", "date effective", "coverage date", "plan start date" ] )
        , ( "birthDate", [ "birth_date", "birthdate", "birth date", "dob", "date_of_birth", "date of birth", "born", "birthday" ] )
        , ( "tobaccoUser", [ "tobacco_user", "tobaccouser", "tobacco user", "tobacco", "smoker", "tobacco_status", "tobacco status", "smokes", "is smoker", "smoking" ] )
        , ( "gender", [ "sex", "m/f", "male/female" ] )
        , ( "zipCode", [ "zip_code", "zipcode", "zip", "postal_code", "postalcode", "postal code", "postal", "zip code" ] )
        , ( "planType", [ "plan_type", "plantype", "plan type", "plan", "insurance_type", "insurancetype", "insurance type", "coverage type", "coverage" ] )
        ]



-- CSV TRANSFORMATION


transformCsvData : String -> ColumnMapping -> Result Error String
transformCsvData csvContent columnMapping =
    case Csv.Parser.parse { fieldSeparator = ',' } csvContent of
        Ok rows ->
            case List.head rows of
                Just headers ->
                    let
                        -- Create new standardized headers
                        standardHeaders =
                            [ "first_name"
                            , "last_name"
                            , "email"
                            , "phone_number"
                            , "state"
                            , "current_carrier"
                            , "effective_date"
                            , "birth_date"
                            , "tobacco_user"
                            , "gender"
                            , "zip_code"
                            , "plan_type"
                            ]

                        -- Create mapping from old to new headers
                        headerMapping =
                            [ ( columnMapping.firstName, "first_name" )
                            , ( columnMapping.lastName, "last_name" )
                            , ( columnMapping.email, "email" )
                            , ( columnMapping.phoneNumber, "phone_number" )
                            , ( columnMapping.state, "state" )
                            , ( columnMapping.currentCarrier, "current_carrier" )
                            , ( columnMapping.effectiveDate, "effective_date" )
                            , ( columnMapping.birthDate, "birth_date" )
                            , ( columnMapping.tobaccoUser, "tobacco_user" )
                            , ( columnMapping.gender, "gender" )
                            , ( columnMapping.zipCode, "zip_code" )
                            , ( columnMapping.planType, "plan_type" )
                            ]
                                |> Dict.fromList

                        -- Get indices of columns we want to keep
                        columnIndices =
                            headers
                                |> List.indexedMap Tuple.pair
                                |> List.filter
                                    (\( _, h ) ->
                                        List.member h
                                            [ columnMapping.firstName
                                            , columnMapping.lastName
                                            , columnMapping.email
                                            , columnMapping.phoneNumber
                                            , columnMapping.state
                                            , columnMapping.currentCarrier
                                            , columnMapping.effectiveDate
                                            , columnMapping.birthDate
                                            , columnMapping.tobaccoUser
                                            , columnMapping.gender
                                            , columnMapping.zipCode
                                            , columnMapping.planType
                                            ]
                                    )
                                |> List.map Tuple.first

                        -- Transform each row
                        transformedRows =
                            List.map
                                (\row ->
                                    List.filterMap (\i -> getAt i row) columnIndices
                                )
                                (List.drop 1 rows)

                        -- Convert back to CSV string
                        toCsvRow : List String -> String
                        toCsvRow row =
                            row
                                |> List.map
                                    (\cell ->
                                        if String.contains "," cell then
                                            "\"" ++ cell ++ "\""

                                        else
                                            cell
                                    )
                                |> String.join ","
                    in
                    Ok (String.join "\n" (toCsvRow standardHeaders :: List.map toCsvRow transformedRows))

                Nothing ->
                    Err NoHeaders

        Err _ ->
            Err (ParseError "Failed to parse CSV file")



-- Add function to process CSV data into contacts


processCsvToContacts : String -> ColumnMapping -> CarrierMapping -> Result Error (List ProcessedContact)
processCsvToContacts csvContent columnMapping carrierMapping =
    case Csv.Parser.parse { fieldSeparator = ',' } csvContent of
        Ok rows ->
            case List.head rows of
                Just headers ->
                    let
                        -- Get indices for each field
                        getColumnIndex : String -> Maybe Int
                        getColumnIndex columnName =
                            List.indexedMap Tuple.pair headers
                                |> List.filter (\( _, h ) -> h == columnName)
                                |> List.head
                                |> Maybe.map Tuple.first

                        -- Get indices for all required fields
                        indices =
                            { firstName = getColumnIndex columnMapping.firstName
                            , lastName = getColumnIndex columnMapping.lastName
                            , email = getColumnIndex columnMapping.email
                            , phoneNumber = getColumnIndex columnMapping.phoneNumber
                            , state = getColumnIndex columnMapping.state
                            , currentCarrier = getColumnIndex columnMapping.currentCarrier
                            , effectiveDate = getColumnIndex columnMapping.effectiveDate
                            , birthDate = getColumnIndex columnMapping.birthDate
                            , tobaccoUser = getColumnIndex columnMapping.tobaccoUser
                            , gender = getColumnIndex columnMapping.gender
                            , zipCode = getColumnIndex columnMapping.zipCode
                            , planType = getColumnIndex columnMapping.planType
                            }

                        -- Process each row into a contact
                        processRow : List String -> Maybe ProcessedContact
                        processRow row =
                            let
                                getValue : Maybe Int -> String
                                getValue maybeIndex =
                                    case maybeIndex of
                                        Just i ->
                                            if i < List.length row then
                                                row |> getAt i |> Maybe.withDefault ""

                                            else
                                                ""

                                        Nothing ->
                                            ""

                                -- Get carrier value and map it to standardized name
                                rawCarrier =
                                    getValue indices.currentCarrier

                                mappedCarrier =
                                    Dict.get rawCarrier carrierMapping.mappings
                                        |> Maybe.withDefault rawCarrier

                                -- Parse tobacco user value
                                parseTobaccoUser : String -> Bool
                                parseTobaccoUser val =
                                    let
                                        lower =
                                            String.toLower (String.trim val)
                                    in
                                    lower == "yes" || lower == "true" || lower == "1" || lower == "y"
                            in
                            Just
                                { firstName = getValue indices.firstName
                                , lastName = getValue indices.lastName
                                , email = getValue indices.email
                                , phoneNumber = getValue indices.phoneNumber |> String.filter Char.isDigit
                                , state = getValue indices.state
                                , currentCarrier = mappedCarrier
                                , effectiveDate = getValue indices.effectiveDate
                                , birthDate = getValue indices.birthDate
                                , tobaccoUser = getValue indices.tobaccoUser |> parseTobaccoUser
                                , gender = getValue indices.gender
                                , zipCode = getValue indices.zipCode
                                , planType = getValue indices.planType
                                }
                    in
                    -- Process all rows except header
                    rows
                        |> List.drop 1
                        |> List.filterMap processRow
                        |> Ok

                Nothing ->
                    Err NoHeaders

        Err _ ->
            Err (ParseError "Failed to parse CSV file")

================
File: src/Dashboard.elm
================
module Dashboard exposing (Model, Msg, init, subscriptions, update, view)

import Browser exposing (Document)
import Chart as C
import Chart.Attributes as CA
import Chart.Events as CE
import Chart.Item as CI
import Components.LimitBanner as LimitBanner exposing (LimitWarning(..))
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Time


type alias Model =
    { hovering : Maybe Point
    , limitBanner : LimitBanner.Model
    , showTutorialModal : Bool
    }


type alias Point =
    { x : Float
    , y : Float
    }


type alias ChartData =
    { x : Float
    , sends : Float
    , views : Float
    , followUps : Float
    }


type Msg
    = OnHover (Maybe Point)
    | NoOp
    | LimitBannerMsg LimitBanner.Msg
    | CloseTutorialModal
    | OpenTutorialModal


type alias Flags =
    { isPostPayment : Maybe Bool
    }


init : Flags -> ( Model, Cmd Msg )
init flags =
    let
        ( limitBannerModel, limitBannerCmd ) =
            LimitBanner.init
    in
    ( { hovering = Nothing
      , limitBanner = limitBannerModel
      , showTutorialModal = Maybe.withDefault False flags.isPostPayment
      }
    , Cmd.map LimitBannerMsg limitBannerCmd
    )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        OnHover point ->
            ( { model | hovering = point }
            , Cmd.none
            )

        LimitBannerMsg limitBannerMsg ->
            let
                ( limitBanner, cmd ) =
                    LimitBanner.update limitBannerMsg model.limitBanner
            in
            ( { model | limitBanner = limitBanner }
            , Cmd.map LimitBannerMsg cmd
            )

        CloseTutorialModal ->
            ( { model | showTutorialModal = False }
            , Cmd.none
            )

        OpenTutorialModal ->
            ( { model | showTutorialModal = True }
            , Cmd.none
            )

        NoOp ->
            ( model, Cmd.none )


view : Model -> Document Msg
view model =
    { title = "Dashboard"
    , body =
        [ div [ class "p-4 sm:p-6 max-w-7xl mx-auto" ]
            [ LimitBanner.view model.limitBanner
                |> Html.map LimitBannerMsg
            , if model.showTutorialModal then
                viewTutorialModal

              else
                text ""
            , div [ class "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" ]
                [ -- Stats cards
                  viewStatsCard "Quotes Sent" "912" "text-purple-600"
                , viewStatsCard "Quotes Viewed" "912" "text-purple-600"
                , viewStatsCard "Follow Ups Requested" "912" "text-purple-600"
                ]
            , div [ class "mt-6 sm:mt-8 grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6" ]
                [ div [ class "lg:col-span-3" ]
                    [ -- Chart section
                      div [ class "bg-white rounded-lg shadow p-4 sm:p-6" ]
                        [ h3 [ class "text-lg font-semibold mb-2 sm:mb-4" ] [ text "Quote Results" ]
                        , div [ class "h-64 overflow-x-auto overflow-y-hidden" ]
                            [ viewChart model ]
                        , div [ class "flex flex-col sm:flex-row justify-center mt-8 sm:mt-16 space-y-2 sm:space-y-0 sm:space-x-8 text-sm text-gray-600 border-t border-gray-200 pt-4 sm:pt-8" ]
                            [ div [ class "flex items-center" ]
                                [ div [ class "w-3 h-3 rounded-full bg-[#DCE2E5] mr-1.5 sm:mr-2" ] []
                                , text "Quotes Sent"
                                ]
                            , div [ class "flex items-center" ]
                                [ div [ class "w-3 h-3 rounded-full bg-[#53389E] mr-1.5 sm:mr-2" ] []
                                , text "Quotes Viewed"
                                ]
                            , div [ class "flex items-center" ]
                                [ div [ class "w-3 h-3 rounded-full bg-[#03045E] mr-1.5 sm:mr-2" ] []
                                , text "Follow-up Requests"
                                ]
                            ]
                        ]
                    ]
                , div [ class "lg:col-span-1" ]
                    [ -- Next Renewals section
                      div [ class "bg-white rounded-lg shadow p-4 sm:p-6" ]
                        [ h3 [ class "text-lg font-semibold mb-2 sm:mb-4" ] [ text "Next Renewals" ]
                        , div [ class "space-y-4" ]
                            [-- We'll add renewal items here later
                            ]
                        ]
                    ]
                ]
            ]
        ]
    }


viewTutorialModal : Html Msg
viewTutorialModal =
    div [ class "fixed inset-0 z-50 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4" ]
        [ div [ class "bg-white p-4 sm:p-6 rounded-lg shadow-lg max-w-2xl w-full" ]
            [ div [ class "flex justify-between items-center mb-4" ]
                [ h2 [ class "text-lg sm:text-xl font-semibold text-[#03045E]" ] [ text "Welcome to MedicareMax!" ]
                , button
                    [ class "text-gray-400 hover:text-gray-600 text-xl p-1", onClick CloseTutorialModal ]
                    [ text "×" ]
                ]
            , div [ class "mb-4 sm:mb-6" ]
                [ iframe
                    [ src "https://www.youtube.com/embed/dQw4w9WgXcQ" -- Replace with actual tutorial video
                    , class "w-full aspect-video max-h-[50vh] sm:h-96"
                    , attribute "allowfullscreen" ""
                    , attribute "frameborder" "0"
                    ]
                    []
                ]
            , p [ class "mb-4 text-gray-600 text-sm sm:text-base" ]
                [ text "This quick setup tutorial will help you get started with MedicareMax and show you how to make the most of its features." ]
            , div [ class "flex justify-end" ]
                [ button
                    [ class "px-4 py-2 bg-[#03045E] text-white rounded-md hover:bg-opacity-90 w-full sm:w-auto"
                    , onClick CloseTutorialModal
                    ]
                    [ text "Close" ]
                ]
            ]
        ]


viewStatsCard : String -> String -> String -> Html Msg
viewStatsCard title value colorClass =
    div [ class "bg-white rounded-lg shadow p-4 sm:p-6" ]
        [ div [ class "text-gray-600 text-xs sm:text-sm" ] [ text title ]
        , div [ class "text-2xl sm:text-4xl font-bold mt-1 sm:mt-2 text-[#03045E]" ] [ text value ]
        ]


viewChart : Model -> Html Msg
viewChart model =
    C.chart
        [ CA.height 300
        , CA.width 800 -- Fixed width, with overflow-x-auto on container
        , CA.margin { top = 10, bottom = 45, left = 30, right = 10 }
        -- CA.responsive is not available in this version
        ]
        [ C.xLabels
            [ CA.withGrid
            , CA.amount 12
            , CA.fontSize 12
            , CA.moveDown 35
            , CA.format
                (\x ->
                    case round x of
                        0 ->
                            "Jan"

                        1 ->
                            "Feb"

                        2 ->
                            "Mar"

                        3 ->
                            "Apr"

                        4 ->
                            "May"

                        5 ->
                            "Jun"

                        6 ->
                            "Jul"

                        7 ->
                            "Aug"

                        8 ->
                            "Sep"

                        9 ->
                            "Oct"

                        10 ->
                            "Nov"

                        11 ->
                            "Dec"

                        _ ->
                            ""
                )
            ]
        , C.yLabels [ CA.withGrid ]
        , C.bars []
            [ C.stacked
                [ C.bar .sends [ CA.color "#DCE2E5" ]
                , C.bar .views [ CA.color "#53389E" ]
                , C.bar .followUps [ CA.color "#03045E" ]
                ]
            ]
            chartData
        ]


chartData : List ChartData
chartData =
    [ { x = 0, sends = 10, views = 8, followUps = 5 }
    , { x = 1, sends = 15, views = 12, followUps = 8 }
    , { x = 2, sends = 8, views = 6, followUps = 4 }
    , { x = 3, sends = 12, views = 10, followUps = 7 }
    , { x = 4, sends = 20, views = 15, followUps = 10 }
    , { x = 5, sends = 18, views = 14, followUps = 9 }
    , { x = 6, sends = 25, views = 20, followUps = 15 }
    , { x = 7, sends = 22, views = 18, followUps = 12 }
    , { x = 8, sends = 28, views = 22, followUps = 16 }
    , { x = 9, sends = 30, views = 25, followUps = 18 }
    , { x = 10, sends = 35, views = 28, followUps = 20 }
    , { x = 11, sends = 40, views = 32, followUps = 25 }
    ]


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Decline.elm
================
module Decline exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onInput, onSubmit)
import Http
import Json.Decode as D
import Json.Encode as E
import Url.Parser.Query as Query


type alias Model =
    { name : String
    , email : String
    , isSubmitting : Bool
    , error : Maybe String
    , success : Bool
    , quoteId : Maybe String
    , key : Nav.Key
    }


type Msg
    = UpdateName String
    | UpdateEmail String
    | SubmitForm
    | GotSubmitResponse (Result Http.Error ())
    | GotContactInfo (Result Http.Error ContactInfo)


type alias ContactInfo =
    { email : String
    , firstName : String
    , lastName : String
    }


init : Nav.Key -> Maybe String -> ( Model, Cmd Msg )
init key maybeQuoteId =
    ( { name = ""
      , email = ""
      , isSubmitting = False
      , error = Nothing
      , success = False
      , quoteId = maybeQuoteId
      , key = key
      }
    , case maybeQuoteId of
        Just quoteId ->
            Http.get
                { url = "/api/quotes/decode/" ++ quoteId
                , expect = Http.expectJson GotContactInfo contactInfoDecoder
                }

        Nothing ->
            Cmd.none
    )


contactInfoDecoder : D.Decoder ContactInfo
contactInfoDecoder =
    D.field "contact"
        (D.map3 ContactInfo
            (D.field "email" D.string)
            (D.field "firstName" D.string)
            (D.field "lastName" D.string)
        )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateName name ->
            ( { model | name = name }, Cmd.none )

        UpdateEmail email ->
            ( { model | email = email }, Cmd.none )

        SubmitForm ->
            ( { model | isSubmitting = True }
            , Http.post
                { url = "/api/contact-request"
                , body = Http.jsonBody (encodeForm model)
                , expect = Http.expectWhatever GotSubmitResponse
                }
            )

        GotSubmitResponse result ->
            case result of
                Ok _ ->
                    ( { model | isSubmitting = False, success = True }, Cmd.none )

                Err _ ->
                    ( { model | isSubmitting = False, error = Just "Failed to submit form. Please try again." }, Cmd.none )

        GotContactInfo result ->
            case result of
                Ok info ->
                    ( { model
                        | email = info.email
                        , name = info.firstName ++ " " ++ info.lastName
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( model, Cmd.none )


encodeForm : Model -> E.Value
encodeForm model =
    E.object
        [ ( "name", E.string model.name )
        , ( "email", E.string model.email )
        , ( "type", E.string "decline" )
        , ( "quoteId", Maybe.map E.string model.quoteId |> Maybe.withDefault E.null )
        ]


view : Model -> Browser.Document Msg
view model =
    { title = "Not Eligible - Medicare Max"
    , body =
        [ div [ class "min-h-screen bg-white" ]
            [ nav [ class "bg-white border-b border-gray-200" ]
                [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" ]
                    [ div [ class "flex justify-between h-16 items-center" ]
                        [ div [ class "flex-shrink-0" ]
                            [ img [ src "/images/medicare-max-logo.png", class "h-8 w-auto", alt "Medicare Max" ] [] ]
                        ]
                    ]
                ]
            , div [ class "max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12" ]
                [ if model.success then
                    div [ class "text-center" ]
                        [ h1 [ class "text-3xl font-bold text-gray-900 mb-4" ]
                            [ text "Thank You" ]
                        , p [ class "text-gray-600" ]
                            [ text "We'll be in touch soon to discuss your options." ]
                        ]

                  else
                    div []
                        [ h1 [ class "text-3xl font-bold text-center text-gray-900 mb-4" ]
                            [ text "We Need to Talk" ]
                        , p [ class "text-gray-600 text-center mb-8" ]
                            [ text "Based on your answers, you may not qualify for this plan. However, we'd love to help you find a different plan that's a perfect fit for your needs." ]
                        , case model.error of
                            Just error ->
                                div [ class "bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" ]
                                    [ text error ]

                            Nothing ->
                                text ""
                        , Html.form [ onSubmit SubmitForm, class "space-y-6 max-w-lg mx-auto" ]
                            [ div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                    [ text "Name" ]
                                , input
                                    [ type_ "text"
                                    , class "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                    , value model.name
                                    , onInput UpdateName
                                    , required True
                                    ]
                                    []
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                    [ text "Email" ]
                                , input
                                    [ type_ "email"
                                    , class "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500"
                                    , value model.email
                                    , onInput UpdateEmail
                                    , required True
                                    ]
                                    []
                                ]
                            , button
                                [ class "w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-200 disabled:opacity-50"
                                , type_ "submit"
                                , disabled model.isSubmitting
                                ]
                                [ if model.isSubmitting then
                                    text "Submitting..."

                                  else
                                    text "Request Follow-up"
                                ]
                            ]
                        ]
                ]
            ]
        ]
    }


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Eligibility.elm
================
module Eligibility exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Dict exposing (Dict)
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput, onSubmit)
import Http
import Json.Decode as D
import Json.Encode as E
import MyIcon
import Url.Builder as Builder
import Utils.QuoteHeader exposing (viewHeader)



-- TYPES


type Color
    = DangerColor
    | BlueColor
    | AmberColor
    | SuccessColor
    | PurpleColor
    | BrandColor


type AnswerType
    = BooleanAnswer (Maybe Bool)
    | TextAnswer String


type alias FollowUpQuestion =
    { id : Int
    , text : String
    , answerType : AnswerType
    }


type alias Question =
    { id : Int
    , icon : Icon
    , title : String
    , text : String
    , color : Color
    , answer : Maybe Bool
    , followUpQuestions : List FollowUpQuestion
    , isExpanded : Bool
    }


type alias Model =
    { key : Nav.Key
    , questions : List Question
    , quoteId : Maybe String
    , orgId : String
    , orgName : Maybe String
    , orgLogo : Maybe String
    , isSubmitting : Bool
    , submissionError : Maybe String
    , isLoading : Bool
    }


type Msg
    = AnswerQuestion Int Bool
    | ToggleExpand Int
    | UpdateFollowUpText Int Int String
    | AnswerFollowUpQuestion Int Int Bool
    | SubmitAnswers
    | SkipQuestions
    | GotSubmitResponse (Result Http.Error ContactResponse)
    | GotTempContactResponse (Result Http.Error String)
    | GotOrgDetails (Result Http.Error OrgDetailsResponse)
    | GotExistingAnswers (Result Http.Error ExistingAnswersResponse)


type alias ContactResponse =
    { contactId : String
    , orgName : String
    , orgLogo : Maybe String
    }


type alias OrgDetailsResponse =
    { orgName : String
    , orgLogo : Maybe String
    }


type Icon
    = HeartIcon
    | LungsIcon
    | AlertCircleIcon
    | DropletsIcon
    | BrainIcon
    | Building2Icon
    | StethoscopeIcon


type alias ExistingAnswersResponse =
    { answers : List ExistingAnswer
    , orgName : String
    , orgLogo : Maybe String
    }


type alias ExistingAnswer =
    { questionId : Int
    , questionText : String
    , questionType : String
    , answer : Bool
    }



-- INIT


defaultQuestions : List Question
defaultQuestions =
    [ { id = 1
      , icon = HeartIcon
      , title = "Heart Health"
      , text = "Have you ever been diagnosed with or treated for any heart condition, including but not limited to heart failure, coronary artery disease, angina, atrial fibrillation, or heart valve problems?"
      , color = DangerColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions =
            [ { id = 101
              , text = "What specific heart condition(s) have you been diagnosed with?"
              , answerType = TextAnswer ""
              }
            , { id = 102
              , text = "In the past 2 years, have you been hospitalized, had surgery, or any cardiac procedures (like angioplasty or stenting) for this condition?"
              , answerType = BooleanAnswer Nothing
              }
            , { id = 103
              , text = "Are you currently taking 3 or more medications for this heart condition, or using oxygen or nitroglycerin?"
              , answerType = BooleanAnswer Nothing
              }
            ]
      }
    , { id = 2
      , icon = LungsIcon
      , title = "Lung Health"
      , text = "Have you ever been diagnosed with or treated for a chronic lung condition such as COPD, emphysema, chronic bronchitis, or cystic fibrosis?"
      , color = BlueColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions =
            [ { id = 201
              , text = "What specific lung condition(s) have you been diagnosed with?"
              , answerType = TextAnswer ""
              }
            , { id = 202
              , text = "Does this condition require you to use oxygen at home or a nebulizer?"
              , answerType = BooleanAnswer Nothing
              }
            , { id = 203
              , text = "In the past year, have you been hospitalized due to lung problems or had frequent (3 or more) respiratory infections requiring antibiotics or steroids?"
              , answerType = BooleanAnswer Nothing
              }
            ]
      }
    , { id = 3
      , icon = AlertCircleIcon
      , title = "Cancer History"
      , text = "Have you ever been diagnosed with or treated for cancer, leukemia, or lymphoma (excluding basal cell skin cancer)?"
      , color = AmberColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions =
            [ { id = 301
              , text = "What type of cancer were you diagnosed with?"
              , answerType = TextAnswer ""
              }
            , { id = 302
              , text = "When were you initially diagnosed?"
              , answerType = TextAnswer ""
              }
            , { id = 303
              , text = "Are you currently undergoing active cancer treatment (chemotherapy, radiation, immunotherapy, targeted therapy, or hormone therapy)?"
              , answerType = BooleanAnswer Nothing
              }
            ]
      }
    , { id = 4
      , icon = DropletsIcon
      , title = "Diabetes with Complications"
      , text = "Have you ever been diagnosed with diabetes that has resulted in any complications affecting your eyes (retinopathy), nerves (neuropathy), kidneys (nephropathy), circulation (vascular disease), or heart?"
      , color = SuccessColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions =
            [ { id = 401
              , text = "Which complications of diabetes have you experienced? (e.g., Neuropathy, Retinopathy, Kidney Problems, Vascular Disease, Heart Problems)"
              , answerType = TextAnswer ""
              }
            , { id = 402
              , text = "Do you require insulin to manage your diabetes, and if so, what is your typical daily insulin dosage?"
              , answerType = TextAnswer ""
              }
            ]
      }
    , { id = 5
      , icon = BrainIcon
      , title = "Memory or Cognitive Health"
      , text = "Do you have any concerns about your memory, thinking, or cognitive function, OR have you ever been diagnosed with dementia, Alzheimer's disease, or any other cognitive impairment?"
      , color = PurpleColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions =
            [ { id = 501
              , text = "Have you been formally diagnosed with any cognitive impairment? If yes, what diagnosis?"
              , answerType = TextAnswer ""
              }
            , { id = 502
              , text = "Do you require assistance with activities of daily living such as remembering medications, managing finances, or personal care due to cognitive impairment?"
              , answerType = BooleanAnswer Nothing
              }
            ]
      }
    , { id = 6
      , icon = Building2Icon
      , title = "Recent and Current Hospitalizations"
      , text = "In the past 2 years, have you been hospitalized overnight in a hospital more than two times for any medical condition (excluding planned surgeries)?"
      , color = BrandColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions = []
      }
    , { id = 7
      , icon = StethoscopeIcon
      , title = "Current Hospitalization or Medical Test"
      , text = "Are you currently hospitalized or waiting on results from a medical test, or been recommended by a doctor to have a medical test performed?"
      , color = BlueColor
      , answer = Nothing
      , isExpanded = False
      , followUpQuestions = []
      }
    ]


init : Nav.Key -> { quoteId : Maybe String, orgId : Maybe String } -> ( Model, Cmd Msg )
init key { quoteId, orgId } =
    let
        extractedOrgId =
            case ( orgId, quoteId ) of
                ( Nothing, Just id ) ->
                    id
                        |> String.split "-"
                        |> List.head
                        |> Maybe.withDefault ""

                ( Just orgIdValue, _ ) ->
                    orgIdValue

                ( Nothing, Nothing ) ->
                    ""

        initialModel =
            { key = key
            , questions = defaultQuestions
            , quoteId = quoteId
            , orgId = extractedOrgId
            , orgName = Nothing
            , orgLogo = Nothing
            , isSubmitting = False
            , submissionError = Nothing
            , isLoading = True
            }

        loadOrgDetails =
            if String.isEmpty extractedOrgId then
                Cmd.none

            else
                Http.get
                    { url = "/api/org/" ++ extractedOrgId ++ "/details"
                    , expect = Http.expectJson GotOrgDetails orgDetailsResponseDecoder
                    }

        loadExistingAnswers =
            case quoteId of
                Just id ->
                    let
                        contactId =
                            String.split "-" id
                                |> List.drop 1
                                |> List.head
                                |> Maybe.withDefault ""
                    in
                    if not (String.isEmpty contactId) then
                        Http.get
                            { url = "/api/org/" ++ extractedOrgId ++ "/eligibility-answers/" ++ contactId
                            , expect = Http.expectJson GotExistingAnswers existingAnswersResponseDecoder
                            }

                    else
                        Cmd.none

                Nothing ->
                    Cmd.none
    in
    ( initialModel
    , Cmd.batch [ loadOrgDetails, loadExistingAnswers ]
    )



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        SkipQuestions ->
            ( model
            , Nav.pushUrl model.key
                (Builder.absolute [ "schedule" ]
                    ([ Builder.string "orgId" model.orgId ]
                        ++ (case model.quoteId of
                                Just id ->
                                    [ Builder.string "id" id ]

                                Nothing ->
                                    []
                           )
                    )
                )
            )

        AnswerQuestion id answer ->
            ( { model
                | questions =
                    List.map
                        (\q ->
                            if q.id == id then
                                { q
                                    | answer = Just answer
                                    , isExpanded = answer -- Auto-expand when answered Yes
                                }

                            else
                                q
                        )
                        model.questions
              }
            , Cmd.none
            )

        ToggleExpand id ->
            ( { model
                | questions =
                    List.map
                        (\q ->
                            if q.id == id then
                                { q | isExpanded = not q.isExpanded }

                            else
                                q
                        )
                        model.questions
              }
            , Cmd.none
            )

        UpdateFollowUpText questionId answerId text ->
            ( { model
                | questions =
                    List.map
                        (\q ->
                            if q.id == questionId then
                                { q
                                    | followUpQuestions =
                                        List.map
                                            (\f ->
                                                if f.id == answerId then
                                                    { f | answerType = TextAnswer text }

                                                else
                                                    f
                                            )
                                            q.followUpQuestions
                                }

                            else
                                q
                        )
                        model.questions
              }
            , Cmd.none
            )

        AnswerFollowUpQuestion questionId answerId answer ->
            ( { model
                | questions =
                    List.map
                        (\q ->
                            if q.id == questionId then
                                { q
                                    | followUpQuestions =
                                        List.map
                                            (\f ->
                                                if f.id == answerId then
                                                    { f | answerType = BooleanAnswer (Just answer) }

                                                else
                                                    f
                                            )
                                            q.followUpQuestions
                                }

                            else
                                q
                        )
                        model.questions
              }
            , Cmd.none
            )

        GotSubmitResponse result ->
            case result of
                Ok response ->
                    let
                        anyYes =
                            List.any (\q -> q.answer == Just True) model.questions

                        nextUrl =
                            Builder.absolute [ "schedule" ]
                                ([ Builder.string "orgId" model.orgId
                                 , Builder.string "status"
                                    (if anyYes then
                                        "decline"

                                     else
                                        "accept"
                                    )
                                 ]
                                    ++ (case model.quoteId of
                                            Just id ->
                                                [ Builder.string "id" id ]

                                            Nothing ->
                                                [ Builder.string "contactId" response.contactId ]
                                       )
                                )
                    in
                    ( { model
                        | isSubmitting = False
                        , orgName = Just response.orgName
                        , orgLogo = response.orgLogo
                      }
                    , Nav.pushUrl model.key nextUrl
                    )

                Err error ->
                    ( { model
                        | isSubmitting = False
                        , submissionError = Just "Failed to save your answers. Please try again."
                      }
                    , Cmd.none
                    )

        GotTempContactResponse result ->
            case result of
                Ok contactId ->
                    -- Now that we have a temporary contact, submit the answers
                    let
                        relevantQuestions =
                            getRelevantQuestions model

                        encodedAnswers =
                            encodeAnswers relevantQuestions
                    in
                    ( model
                    , Http.post
                        { url = "/api/org/" ++ model.orgId ++ "/eligibility-answers"
                        , body =
                            Http.jsonBody <|
                                E.object
                                    [ ( "contact_id", E.string contactId )
                                    , ( "answers", encodedAnswers )
                                    ]
                        , expect = Http.expectJson GotSubmitResponse contactResponseDecoder
                        }
                    )

                Err error ->
                    ( { model
                        | isSubmitting = False
                        , submissionError = Just "Failed to create temporary contact. Please try again."
                      }
                    , Cmd.none
                    )

        GotOrgDetails result ->
            case result of
                Ok response ->
                    ( { model
                        | orgName = Just response.orgName
                        , orgLogo = response.orgLogo
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | isLoading = False }
                    , Cmd.none
                    )

        GotExistingAnswers result ->
            case result of
                Ok response ->
                    let
                        updatedQuestions =
                            List.map
                                (\q ->
                                    case List.filter (\a -> a.questionId == q.id) response.answers of
                                        existingAnswer :: _ ->
                                            { q
                                                | answer = Just existingAnswer.answer
                                                , isExpanded = existingAnswer.answer -- Auto-expand if answered Yes
                                            }

                                        [] ->
                                            q
                                )
                                model.questions
                    in
                    ( { model
                        | questions = updatedQuestions
                        , orgName = Just response.orgName
                        , orgLogo = response.orgLogo
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | isLoading = False }
                    , Cmd.none
                    )

        SubmitAnswers ->
            let
                relevantQuestions =
                    getRelevantQuestions model

                allRelevantQuestionsAnswered =
                    List.all
                        (\q ->
                            case q.followUpQuestions of
                                [] ->
                                    q.answer /= Nothing

                                followUps ->
                                    List.all
                                        (\fq ->
                                            case fq.answerType of
                                                TextAnswer _ ->
                                                    True

                                                BooleanAnswer _ ->
                                                    q.answer /= Nothing
                                        )
                                        followUps
                        )
                        relevantQuestions

                encodedAnswers =
                    encodeAnswers relevantQuestions
            in
            if allRelevantQuestionsAnswered then
                case model.quoteId of
                    Just quoteId ->
                        -- If we have a quote ID, submit answers directly
                        ( { model | isSubmitting = True, submissionError = Nothing }
                        , submitAnswers model
                        )

                    Nothing ->
                        -- If no quote ID, first create a temporary contact
                        ( { model | isSubmitting = True, submissionError = Nothing }
                        , Http.post
                            { url = "/api/org/" ++ model.orgId ++ "/temp-contact"
                            , body = Http.jsonBody <| E.object [] -- Minimal data for temp contact
                            , expect = Http.expectString GotTempContactResponse
                            }
                        )

            else
                ( model
                , Cmd.none
                )



-- Helper functions


getRelevantQuestions : Model -> List Question
getRelevantQuestions model =
    let
        answeredQuestions =
            List.filter (\q -> q.answer /= Nothing) model.questions
    in
    answeredQuestions


encodeAnswers : List Question -> E.Value
encodeAnswers questions =
    E.object
        (List.filterMap
            (\q ->
                if q.answer == Nothing then
                    Nothing

                else
                    let
                        questionType =
                            case q.color of
                                DangerColor ->
                                    "main"

                                BlueColor ->
                                    "lung_health"

                                AmberColor ->
                                    "cancer_history"

                                SuccessColor ->
                                    "diabetes_with_complications"

                                PurpleColor ->
                                    "memory_or_cognitive_health"

                                BrandColor ->
                                    "recent_and_current_hospitalizations"

                        answerValue =
                            case q.answer of
                                Just ans ->
                                    E.bool ans

                                Nothing ->
                                    E.null
                    in
                    Just
                        ( String.fromInt q.id
                        , E.object
                            [ ( "question_text", E.string q.text )
                            , ( "question_type", E.string questionType )
                            , ( "answer", answerValue )
                            ]
                        )
            )
            questions
        )


iconToSvg : Icon -> Color -> Html msg
iconToSvg icon color =
    let
        iconColor =
            case color of
                DangerColor ->
                    "text-[#DC2626]"

                BlueColor ->
                    "text-[#0075F2]"

                AmberColor ->
                    "text-amber-500"

                SuccessColor ->
                    "text-medicare-success"

                PurpleColor ->
                    "text-[#7F56D9]"

                BrandColor ->
                    "text-[#03045E]"
    in
    case icon of
        HeartIcon ->
            div [ class iconColor ] [ MyIcon.heartPulse 24 "currentColor" ]

        LungsIcon ->
            div [ class iconColor ] [ MyIcon.lungs 24 "currentColor" ]

        AlertCircleIcon ->
            div [ class iconColor ] [ MyIcon.activity 24 "currentColor" ]

        DropletsIcon ->
            div [ class iconColor ] [ MyIcon.droplets 24 "currentColor" ]

        BrainIcon ->
            div [ class iconColor ] [ MyIcon.brain 24 "currentColor" ]

        Building2Icon ->
            div [ class iconColor ] [ MyIcon.building2 24 "currentColor" ]

        StethoscopeIcon ->
            div [ class iconColor ] [ MyIcon.stethoscope 24 "currentColor" ]


colorToClasses : Color -> Bool -> { card : String, title : String, indicator : String }
colorToClasses color isActive =
    case color of
        DangerColor ->
            { card =
                if isActive then
                    "bg-[#DC2626]/10"

                else
                    "bg-white"
            , title = "text-[#DC2626]"
            , indicator = "bg-[#DC2626]/10"
            }

        BlueColor ->
            { card =
                if isActive then
                    "bg-[#0075F2]/20"

                else
                    "bg-white"
            , title = "text-[#0075F2]"
            , indicator = "bg-[#0075F2]/10"
            }

        AmberColor ->
            { card =
                if isActive then
                    "bg-amber-50"

                else
                    "bg-white"
            , title = "text-amber-500"
            , indicator = "bg-amber-50"
            }

        SuccessColor ->
            { card =
                if isActive then
                    "bg-medicare-success-light"

                else
                    "bg-white"
            , title = "text-medicare-success"
            , indicator = "bg-medicare-success-light"
            }

        PurpleColor ->
            { card =
                if isActive then
                    "bg-[#7F56D9]/20"

                else
                    "bg-white"
            , title = "text-[#7F56D9]"
            , indicator = "bg-[#7F56D9]/10"
            }

        BrandColor ->
            { card =
                if isActive then
                    "bg-[#03045E]/20"

                else
                    "bg-white"
            , title = "text-[#03045E]"
            , indicator = "bg-[#03045E]/10"
            }



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Underwriting Assessment"
    , body =
        [ div [ class "min-h-screen bg-white" ]
            [ if model.isLoading then
                div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-4 text-center" ]
                    [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-[#03045E] border-t-transparent" ] []
                    , p [ class "text-center text-lg font-medium text-gray-600" ]
                        [ text "Loading assessment..." ]
                    ]

              else
                div [ class "max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8" ]
                    [ -- Organization Logo/Name
                      viewHeader model.orgLogo model.orgName
                    , h1 [ class "text-2xl sm:text-3xl font-bold text-center text-gray-900 mb-2 sm:mb-3" ]
                        [ text "Underwriting Assessment" ]
                    , p [ class "text-gray-600 px-5 md:px-0 text-center mb-6 sm:mb-8 text-sm sm:text-base max-w-xl mx-auto" ]
                        [ text "In order to qualify for a new Supplemental plan you must pass medical underwriting. Please answer all questions to the best of your knowledge." ]
                    , if model.submissionError /= Nothing then
                        div [ class "mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm" ]
                            [ text (Maybe.withDefault "" model.submissionError) ]

                      else
                        text ""
                    , Html.form [ onSubmit SubmitAnswers, class "space-y-4 sm:space-y-6" ]
                        (viewQuestionsWithFollowUps model
                            ++ [ viewSubmitButton model ]
                        )
                    , div [ class "text-center mt-3 sm:mt-4" ]
                        [ button
                            [ onClick SkipQuestions
                            , class "text-blue-600 hover:text-blue-800 underline text-sm py-2"
                            , type_ "button"
                            , disabled model.isSubmitting
                            ]
                            [ text "Skip" ]
                        ]
                    ]
            ]
        ]
    }


viewQuestionsWithFollowUps : Model -> List (Html Msg)
viewQuestionsWithFollowUps model =
    List.map
        (\q ->
            div [ class "mb-6 transition-all duration-200" ]
                [ viewQuestion q ]
        )
        model.questions


viewQuestion : Question -> Html Msg
viewQuestion question =
    let
        colorClasses =
            colorToClasses question.color (question.answer == Just True)

        shouldShowFollowUps =
            question.answer == Just True && question.isExpanded

        hasFollowUps =
            not (List.isEmpty question.followUpQuestions)

        bgColorClass =
            if question.answer == Just True then
                case question.color of
                    DangerColor ->
                        "bg-[#DC2626]/10"

                    BlueColor ->
                        "bg-[#0075F2]/10"

                    AmberColor ->
                        "bg-amber-50"

                    SuccessColor ->
                        "bg-medicare-success-light"

                    PurpleColor ->
                        "bg-[#7F56D9]/10"

                    BrandColor ->
                        "bg-[#03045E]/10"

            else
                "bg-white"
    in
    div
        [ class <|
            "rounded-lg shadow-card overflow-hidden transition-all duration-300 border border-[#DCE2E5] "
                ++ bgColorClass
        ]
        [ div [ class "p-3 sm:p-5" ]
            [ div [ class "flex items-start gap-2 sm:gap-4" ]
                [ div [ class "flex-shrink-0 mt-0.5 sm:mt-1" ]
                    [ iconToSvg question.icon question.color ]
                , div [ class "flex-1 min-w-0" ]
                    [ div [ class "flex justify-between items-start" ]
                        [ h3 [ class <| "font-semibold text-base sm:text-lg mb-1.5 sm:mb-2 " ++ colorClasses.title ]
                            [ text question.title ]
                        ]
                    , p [ class "text-gray-700 text-sm sm:text-base mb-3 sm:mb-4" ]
                        [ text question.text ]
                    , div [ class "flex gap-2 sm:gap-3" ]
                        [ viewAnswerButton question True
                        , viewAnswerButton question False
                        ]
                    ]
                ]
            ]
        , if shouldShowFollowUps then
            div [ class "mt-4 space-y-4 border-t border-[#DCE2E5] pt-4 pb-4 sm:pb-5" ]
                (List.map (\f -> viewFollowUpQuestion f question.id) question.followUpQuestions)

          else
            text ""
        ]


viewFollowUpQuestion : FollowUpQuestion -> Int -> Html Msg
viewFollowUpQuestion followUp parentId =
    div [ class "px-3 sm:px-5" ]
        [ p [ class "text-gray-700 text-sm sm:text-base mb-2" ]
            [ text followUp.text ]
        , case followUp.answerType of
            TextAnswer textValue ->
                div [ class "mt-2" ]
                    [ textarea
                        [ class "w-full p-2.5 sm:p-3 text-sm sm:text-base bg-white border border-[#DCE2E5] rounded-lg focus:ring-2 focus:ring-[#03045E] focus:border-[#03045E]"
                        , rows 2
                        , placeholder "Please provide details..."
                        , value textValue
                        , onInput (\text -> UpdateFollowUpText parentId followUp.id text)
                        ]
                        []
                    ]

            BooleanAnswer answer ->
                div [ class "flex gap-2 sm:gap-3" ]
                    [ button
                        [ type_ "button"
                        , onClick (AnswerFollowUpQuestion parentId followUp.id True)
                        , class <|
                            "flex-1 py-2 sm:py-2.5 px-3 sm:px-4 text-sm sm:text-base rounded-lg font-medium transition-colors border "
                                ++ (if answer == Just True then
                                        "bg-[#03045E] text-white border-[#03045E]"

                                    else
                                        "bg-white text-gray-700 border-[#DCE2E5] hover:bg-gray-50"
                                   )
                        ]
                        [ text "Yes" ]
                    , button
                        [ type_ "button"
                        , onClick (AnswerFollowUpQuestion parentId followUp.id False)
                        , class <|
                            "flex-1 py-2 sm:py-2.5 px-3 sm:px-4 text-sm sm:text-base rounded-lg font-medium transition-colors border "
                                ++ (if answer == Just False then
                                        "bg-gray-900 text-white border-gray-900"

                                    else
                                        "bg-white text-gray-700 border-[#DCE2E5] hover:bg-gray-50"
                                   )
                        ]
                        [ text "No" ]
                    ]
        ]


viewRadioButton : Question -> String -> Bool -> Html Msg
viewRadioButton question labelText value =
    label
        [ class
            ("flex items-center justify-center px-3 sm:px-4 py-2 sm:py-2.5 rounded-md border text-sm sm:text-base cursor-pointer transition-all duration-200 w-full "
                ++ (if question.answer == Just value then
                        if value then
                            "border-blue-500 bg-blue-50 text-blue-700 font-medium shadow-sm"

                        else
                            "border-gray-500 bg-gray-50 text-gray-700 font-medium shadow-sm"

                    else
                        "border-gray-200 hover:border-blue-200 hover:bg-gray-50 text-gray-700"
                   )
            )
        , onClick (AnswerQuestion question.id value)
        ]
        [ input
            [ type_ "radio"
            , name ("question-" ++ String.fromInt question.id)
            , checked (question.answer == Just value)
            , class "sr-only"
            ]
            []
        , span [ class "font-medium" ] [ text labelText ]
        ]


viewAnswerButton : Question -> Bool -> Html Msg
viewAnswerButton question isYes =
    button
        [ type_ "button"
        , onClick (AnswerQuestion question.id isYes)
        , class <|
            "flex-1 py-2 sm:py-2.5 px-3 sm:px-4 text-sm sm:text-base rounded-lg font-medium transition-colors border "
                ++ (if question.answer == Just isYes then
                        if isYes then
                            "bg-[#03045E] text-white border-[#03045E]"

                        else
                            "bg-gray-900 text-white border-gray-900"

                    else
                        "bg-white text-gray-700 border-gray-300 hover:bg-gray-50"
                   )
        ]
        [ text
            (if isYes then
                "Yes"

             else
                "No"
            )
        ]


viewSubmitButton : Model -> Html Msg
viewSubmitButton model =
    let
        -- Check if all main questions are answered
        allMainQuestionsAnswered =
            List.all (\q -> q.answer /= Nothing) model.questions

        -- For any "Yes" answers with follow-up questions, check if all boolean follow-ups are answered
        allRequiredFollowUpsAnswered =
            List.all
                (\q ->
                    case q.answer of
                        Just True ->
                            -- If answered Yes, check follow-up questions
                            List.all
                                (\fq ->
                                    case fq.answerType of
                                        TextAnswer _ ->
                                            -- Text answers are optional
                                            True

                                        BooleanAnswer answer ->
                                            -- Boolean answers must be answered
                                            answer /= Nothing
                                )
                                q.followUpQuestions

                        _ ->
                            -- If not answered Yes, follow-ups don't matter
                            True
                )
                model.questions

        canSubmit =
            allMainQuestionsAnswered && allRequiredFollowUpsAnswered && not model.isSubmitting

        buttonClass =
            "w-full py-2.5 sm:py-3 rounded-lg text-white font-medium transition-colors duration-200 mt-4 sm:mt-6 text-sm sm:text-base shadow-sm "
                ++ (if canSubmit then
                        "bg-[#03045E] hover:bg-[#03045E]/90"

                    else
                        "bg-[#03045E]/70 cursor-not-allowed"
                   )
    in
    button
        [ class buttonClass
        , type_ "submit"
        , disabled (not canSubmit)
        ]
        [ if model.isSubmitting then
            text "Submitting..."

          else
            text "Next"
        ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none



-- Add this near other decoders


contactResponseDecoder : D.Decoder ContactResponse
contactResponseDecoder =
    D.map3 ContactResponse
        (D.field "contactId" D.string)
        (D.field "orgName" D.string)
        (D.field "orgLogo" (D.nullable D.string))


orgDetailsResponseDecoder : D.Decoder OrgDetailsResponse
orgDetailsResponseDecoder =
    D.map2 OrgDetailsResponse
        (D.field "name" D.string)
        (D.field "logo_data" (D.nullable D.string))


submitAnswers : Model -> Cmd Msg
submitAnswers model =
    Http.post
        { url = "/api/org/" ++ model.orgId ++ "/eligibility-answers"
        , body =
            Http.jsonBody <|
                E.object
                    [ ( "quote_id", E.string (Maybe.withDefault "" model.quoteId) )
                    , ( "answers", encodeAnswers (getRelevantQuestions model) )
                    ]
        , expect = Http.expectJson GotSubmitResponse contactResponseDecoder
        }


existingAnswersResponseDecoder : D.Decoder ExistingAnswersResponse
existingAnswersResponseDecoder =
    D.map3 ExistingAnswersResponse
        (D.field "answers" (D.dict existingAnswerDecoder |> D.map dictToAnswerList))
        (D.field "orgName" D.string)
        (D.field "orgLogo" (D.nullable D.string))


existingAnswerDecoder : D.Decoder ExistingAnswer
existingAnswerDecoder =
    D.map4 ExistingAnswer
        (D.succeed 0)
        -- Will be replaced with the key from the dict
        (D.field "question_text" D.string)
        (D.field "question_type" D.string)
        (D.field "answer" D.bool)


dictToAnswerList : Dict String ExistingAnswer -> List ExistingAnswer
dictToAnswerList dict =
    Dict.toList dict
        |> List.map
            (\( key, answer ) ->
                { answer | questionId = String.toInt key |> Maybe.withDefault 0 }
            )

================
File: src/EmailScheduler.elm
================
module EmailScheduler exposing
    ( EmailSchedule
    , PlanType(..)
    , ScheduledEmail
    , ScheduledEmailStatus(..)
    , ScheduledEmailType(..)
    , getScheduledEmails
    , init
    , scheduledEmailTypeToString
    , viewFutureActivity
    , viewScheduledEmail
    )

{-| This module manages email scheduling for various events such as birthdays,
anniversaries, New Year greetings, and October blasts. It supports different plan
types and provides functionality to schedule emails, check their status, and display upcoming activities.

The module includes:

  - Type definitions for email schedules and statuses.
  - Initialization of email schedules.
  - Logic to calculate scheduled emails with status checks.
  - Views to display future scheduled emails in a user-friendly table format.

Dependencies:

  - `Date` for handling dates.
  - `Html` for rendering views.

-}

import BirthdayRules exposing (canPresentDifferentPlanOnly, getDelayedEmailDate, getStateRule, isInBirthdayRuleWindow, isInContinuousOpenEnrollment)
import Date exposing (Date)
import Html exposing (Html, div, h2, span, table, tbody, td, text, th, thead, tr)
import Html.Attributes exposing (class)
import Time exposing (Month(..))



-- TYPES


{-| Represents an email schedule for a contact, including key dates and plan information.

  - `contactId`: Unique identifier for the contact.
  - `effectiveDate`: The date when the plan became effective.
  - `birthDate`: The contact's birth date.
  - `currentDate`: The current date for reference.
  - `planType`: The type of plan (PlanN, PlanG, or NoPlan).
  - `state`: The state of the contact.
  - `stateCarrierSettings`: List of state carrier settings.
  - `stateLicenses`: List of state licenses.

-}
type alias EmailSchedule =
    { contactId : Int
    , effectiveDate : Date
    , birthDate : Date
    , currentDate : Date
    , planType : PlanType
    , state : String
    , stateCarrierSettings : List StateCarrierSetting
    , stateLicenses : List String
    }


{-| Represents a scheduled email with its type, scheduled time, and status.

  - `emailType`: The type of email (e.g., Birthday, Anniversary).
  - `scheduledTime`: The date when the email is scheduled to be sent.
  - `status`: The status of the email (Scheduled or Skipped with a reason).

-}
type alias ScheduledEmail =
    { emailType : ScheduledEmailType
    , scheduledTime : Date
    , status : ScheduledEmailStatus
    }


{-| Represents the status of a scheduled email.

  - `Scheduled`: The email is scheduled to be sent.
  - `Skipped reason`: The email was skipped, with a reason provided.
  - `Delayed reason`: The email was delayed due to birthday rules, with a reason provided.

-}
type ScheduledEmailStatus
    = Scheduled
    | Skipped String
    | Delayed String


{-| Represents the type of scheduled email, associated with a plan type.

  - `Birthday`: Email for the contact's birthday.
  - `Anniversary`: Email for the plan's anniversary.
  - `NewYear`: Email for New Year greetings.
  - `OctoberBlast`: Email for an October promotional blast.
  - `NoEmails`: No scheduled emails.

-}
type ScheduledEmailType
    = Birthday
    | Anniversary
    | NewYear
    | OctoberBlast
    | NoEmails


{-| Represents the plan type for a contact.

  - `PlanN`: Plan N (specific benefits).
  - `PlanG`: Plan G (specific benefits).
  - `NoPlan`: No plan assigned.

-}
type PlanType
    = PlanN
    | PlanG
    | NoPlan


{-| Represents a state carrier setting.

  - `state`: The state.
  - `carrier`: The carrier.
  - `active`: Whether the setting is active.
  - `targetGI`: Whether the setting targets GI.

-}
type alias StateCarrierSetting =
    { state : String
    , carrier : String
    , active : Bool
    , targetGI : Bool
    }



-- INITIALIZATION


{-| Initializes an email schedule for a contact.

  - `contactId`: Unique identifier for the contact.
  - `effective`: The effective date of the plan.
  - `birth`: The contact's birth date.
  - `current`: The current date for scheduling reference.
  - `plan`: The plan type.
  - `state`: The state of the contact.
  - `settings`: List of state carrier settings.
  - `licenses`: List of state licenses.
    Returns an `EmailSchedule` record with the provided values.

-}
init : Int -> Date -> Date -> Date -> PlanType -> String -> List StateCarrierSetting -> List String -> EmailSchedule
init contactId effective birth current plan state settings licenses =
    { contactId = contactId
    , effectiveDate = effective
    , birthDate = birth
    , currentDate = current
    , planType = plan
    , state = state
    , stateCarrierSettings = settings
    , stateLicenses = licenses
    }



-- CALCULATIONS


{-| Checks if a contact's state is active.

  - `schedule`: The email schedule to check.
    Returns `True` if the contact's state is active, otherwise `False`.

-}
isStateActive : EmailSchedule -> Bool
isStateActive schedule =
    List.member schedule.state schedule.stateLicenses


{-| Calculates the list of scheduled emails for a given email schedule.

  - `schedule`: The email schedule to process.
    Returns a list of `ScheduledEmail` records, each with a type, scheduled time, and status.
    Emails are scheduled for:
  - The contact's next birthday.
  - The plan's next anniversary.
  - The next New Year (January 1st).
  - The next October blast (October 1st).
    Emails within the first year of the effective date are skipped.
    Emails for contacts in states with continuous open enrollment are skipped.
    Emails for contacts in their birthday rule window are delayed.

-}
getScheduledEmails : EmailSchedule -> List ScheduledEmail
getScheduledEmails schedule =
    if not (isStateActive schedule) then
        [ { emailType = NoEmails
          , scheduledTime = schedule.currentDate
          , status = Skipped "Contact's state is not active"
          }
        ]

    else if isInContinuousOpenEnrollment schedule.state then
        [ { emailType = NoEmails
          , scheduledTime = schedule.currentDate
          , status = Skipped "Contact's state has continuous open enrollment"
          }
        ]

    else
        let
            -- Calculate the date one year after the effective date for status checks.
            oneYearAfterEffective : Date
            oneYearAfterEffective =
                Date.add Date.Years 1 schedule.effectiveDate

            -- Calculate the next occurrence of an event based on the email type and base date.
            nextOccurrence : ScheduledEmailType -> Date -> Date
            nextOccurrence emailType baseDate =
                let
                    currentYear : Int
                    currentYear =
                        Date.year schedule.currentDate

                    -- Calculate next year's date for birthday and anniversary
                    nextBirthdayOrAnniversaryYear : Date -> Int
                    nextBirthdayOrAnniversaryYear date =
                        let
                            thisYearDate =
                                Date.fromCalendarDate currentYear (Date.month date) (Date.day date)
                        in
                        if Date.compare thisYearDate schedule.currentDate == LT then
                            currentYear + 1

                        else
                            currentYear

                    -- Calculate next New Year's date
                    nextNewYearDate : Date
                    nextNewYearDate =
                        let
                            nextJan1 =
                                Date.fromCalendarDate (currentYear + 1) Jan 1
                        in
                        nextJan1

                    -- For October blast, use current year if October hasn't passed yet
                    octoberThisYear : Date
                    octoberThisYear =
                        Date.fromCalendarDate currentYear Oct 1

                    shouldUseNextYearForOctober : Bool
                    shouldUseNextYearForOctober =
                        Date.compare octoberThisYear schedule.currentDate == LT

                    result =
                        case emailType of
                            Birthday ->
                                Date.fromCalendarDate
                                    (nextBirthdayOrAnniversaryYear baseDate)
                                    (Date.month baseDate)
                                    (Date.day baseDate)

                            Anniversary ->
                                Date.fromCalendarDate
                                    (nextBirthdayOrAnniversaryYear baseDate)
                                    (Date.month baseDate)
                                    (Date.day baseDate)

                            NewYear ->
                                nextNewYearDate

                            OctoberBlast ->
                                Date.fromCalendarDate
                                    (if shouldUseNextYearForOctober then
                                        currentYear + 1

                                     else
                                        currentYear
                                    )
                                    Oct
                                    1

                            NoEmails ->
                                schedule.currentDate
                in
                result

            -- Check if an email should be delayed due to birthday rules
            checkBirthdayRuleDelay : ScheduledEmailType -> Date -> ( Date, ScheduledEmailStatus )
            checkBirthdayRuleDelay emailType scheduledDate =
                let
                    -- Check if the scheduled date falls within a birthday rule window
                    isScheduledDateInWindow : Date -> Date -> Bool
                    isScheduledDateInWindow referenceDate dateToCheck =
                        -- Get the rule for the state
                        case getStateRule schedule.state of
                            Just rule ->
                                let
                                    -- Calculate the start and end dates of the window for the scheduled year
                                    scheduledYear =
                                        Date.year dateToCheck

                                    adjustedReferenceDate =
                                        Date.fromCalendarDate scheduledYear (Date.month referenceDate) (Date.day referenceDate)

                                    -- For Nevada, the window starts on the first day of the birth month
                                    windowStartDate =
                                        if rule.state == "NV" then
                                            Date.fromCalendarDate scheduledYear (Date.month referenceDate) 1

                                        else
                                            -- For other states, subtract the days before birthday from the birthday
                                            Date.add Date.Days -rule.daysBeforeBirthday adjustedReferenceDate

                                    windowEndDate =
                                        Date.add Date.Days rule.totalDays windowStartDate
                                in
                                -- Check if the scheduled date falls within the window
                                Date.compare dateToCheck windowStartDate /= LT && Date.compare dateToCheck windowEndDate /= GT

                            Nothing ->
                                False
                in
                case emailType of
                    Birthday ->
                        -- For birthday emails, check if the state is Missouri (which doesn't have a birthday rule)
                        if schedule.state == "MO" then
                            -- Missouri only has anniversary rule, not birthday rule
                            ( scheduledDate, Scheduled )
                            -- For other states, check if the scheduled date falls within the birthday rule window

                        else if isScheduledDateInWindow schedule.birthDate scheduledDate then
                            -- If it does, delay until after the window
                            let
                                delayedDate =
                                    getDelayedEmailDate schedule.state schedule.birthDate scheduledDate
                            in
                            ( delayedDate, Delayed "due to birthday rule window" )

                        else
                            ( scheduledDate, Scheduled )

                    Anniversary ->
                        -- For Missouri anniversary rule
                        if schedule.state == "MO" then
                            -- Check if the scheduled date falls within the anniversary rule window
                            if isScheduledDateInWindow schedule.effectiveDate scheduledDate then
                                -- If the contact already has Plan G and we're sending a Plan G email, delay it
                                if schedule.planType == PlanG then
                                    let
                                        delayedDate =
                                            getDelayedEmailDate schedule.state schedule.effectiveDate scheduledDate
                                    in
                                    ( delayedDate, Delayed "due to anniversary rule window" )

                                else
                                    -- If it's a different plan type, we can send it during the window
                                    ( scheduledDate, Scheduled )

                            else
                                -- Outside the window, schedule normally
                                ( scheduledDate, Scheduled )

                        else
                            -- For other states, no delay for anniversary emails
                            ( scheduledDate, Scheduled )

                    _ ->
                        -- No delay for other email types
                        ( scheduledDate, Scheduled )

            -- Create a scheduled email with the appropriate status.
            createScheduledEmail : ScheduledEmailType -> Date -> ScheduledEmail
            createScheduledEmail emailType baseDate =
                let
                    scheduledTime : Date
                    scheduledTime =
                        nextOccurrence emailType baseDate

                    ( finalScheduledTime, birthdayRuleStatus ) =
                        checkBirthdayRuleDelay emailType scheduledTime

                    status : ScheduledEmailStatus
                    status =
                        if Date.compare scheduledTime schedule.currentDate == LT then
                            -- Skip if the date is in the past
                            Skipped "Date is in the past"

                        else if
                            Date.compare scheduledTime oneYearAfterEffective
                                == LT
                                && Date.compare scheduledTime schedule.effectiveDate
                                == GT
                        then
                            Skipped "Within first year of effective date"

                        else
                            birthdayRuleStatus
                in
                { emailType = emailType
                , scheduledTime =
                    if status == Delayed "due to birthday rule window" || status == Delayed "due to anniversary rule window" then
                        finalScheduledTime

                    else
                        scheduledTime
                , status = status
                }

            -- Helper function to create plan-specific emails for each event type.
            planSpecificEmail : ScheduledEmailType -> ScheduledEmail
            planSpecificEmail emailType =
                let
                    baseDate =
                        case emailType of
                            Birthday ->
                                schedule.birthDate

                            Anniversary ->
                                schedule.effectiveDate

                            NewYear ->
                                -- For New Year, we don't need a base date since we always use Jan 1
                                Date.fromCalendarDate (Date.year schedule.currentDate) Jan 1

                            OctoberBlast ->
                                -- For October blast, we don't need a base date since we always use Oct 1
                                Date.fromCalendarDate (Date.year schedule.currentDate) Oct 1

                            NoEmails ->
                                schedule.currentDate
                in
                createScheduledEmail emailType baseDate

            emails =
                [ planSpecificEmail Birthday
                , planSpecificEmail Anniversary
                , planSpecificEmail NewYear
                , planSpecificEmail OctoberBlast
                ]
        in
        -- Include both scheduled and delayed emails, but filter out skipped ones
        List.filter
            (\email ->
                case email.status of
                    Scheduled ->
                        True

                    Delayed _ ->
                        True

                    Skipped _ ->
                        False
            )
            emails
            |> List.sortWith
                (\a b ->
                    Date.compare a.scheduledTime b.scheduledTime
                )



-- VIEW FUNCTIONS


{-| Displays a table of future scheduled emails.

  - `scheduledEmails`: The list of scheduled emails to display.
    Returns an HTML view with a table showing the email type, scheduled date, and status.

-}
viewFutureActivity : List ScheduledEmail -> Html msg
viewFutureActivity scheduledEmails =
    div []
        [ h2 [ class "text-lg font-medium text-gray-900 mb-4" ] [ text "Future Activity" ]
        , table [ class "min-w-full divide-y divide-gray-300" ]
            [ thead [ class "bg-gray-50" ]
                [ tr []
                    [ th [ class "px-3 py-3.5 text-left text-sm font-semibold text-gray-900" ] [ text "TYPE" ]
                    , th [ class "px-3 py-3.5 text-left text-sm font-semibold text-gray-900" ] [ text "SCHEDULED DATE" ]
                    , th [ class "px-3 py-3.5 text-left text-sm font-semibold text-gray-900" ] [ text "STATUS" ]
                    ]
                ]
            , tbody [ class "divide-y divide-gray-200 bg-white" ]
                (List.map
                    (\email ->
                        tr [ class "hover:bg-gray-50" ]
                            [ td [ class "px-3 py-2 text-sm text-gray-900" ]
                                [ text (scheduledEmailTypeToString email.emailType) ]
                            , td [ class "px-3 py-2 text-sm text-gray-900" ]
                                [ text (Date.format "MMMM ddd, yyyy" email.scheduledTime) ]
                            , td [ class "px-3 py-2 text-sm" ]
                                [ case email.status of
                                    Scheduled ->
                                        span [ class "text-green-600" ] [ text "Scheduled" ]

                                    Skipped reason ->
                                        span [ class "text-orange-600" ] [ text ("Skipped: " ++ reason) ]

                                    Delayed reason ->
                                        span [ class "text-blue-600" ] [ text ("Scheduled - Delayed " ++ reason) ]
                                ]
                            ]
                    )
                    scheduledEmails
                )
            ]
        ]


{-| Displays a single scheduled email as a table row.

  - `email`: The scheduled email to display.
    Returns an HTML table row with the email type, scheduled date, and status.

-}
viewScheduledEmail : ScheduledEmail -> Html msg
viewScheduledEmail email =
    tr [ class "hover:bg-gray-50" ]
        [ td [ class "px-3 py-2 text-sm text-gray-900" ]
            [ text (scheduledEmailTypeToString email.emailType) ]
        , td [ class "px-3 py-2 text-sm text-gray-900" ]
            [ text (Date.format "MMMM ddd, y" email.scheduledTime) ]
        , td [ class "px-3 py-2 text-sm" ]
            [ case email.status of
                Scheduled ->
                    span [ class "text-green-600" ] [ text "Scheduled" ]

                Skipped reason ->
                    span [ class "text-orange-600" ] [ text ("Skipped: " ++ reason) ]

                Delayed reason ->
                    span [ class "text-blue-600" ] [ text ("Delayed " ++ reason) ]
            ]
        ]


{-| Converts a scheduled email type to a human-readable string.

  - `emailType`: The scheduled email type to convert.
    Returns a string representation, including the plan type (e.g., "Birthday (Plan N)").

-}
scheduledEmailTypeToString : ScheduledEmailType -> String
scheduledEmailTypeToString emailType =
    case emailType of
        Birthday ->
            "Birthday"

        Anniversary ->
            "Anniversary"

        NewYear ->
            "New Year"

        OctoberBlast ->
            "AEP Blast"

        NoEmails ->
            "No Scheduled Emails"

================
File: src/Home.elm
================
port module Home exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onMouseEnter, onMouseLeave)
import Http
import Json.Decode as Decode
import MyIcon exposing (activity, brightArrow, chatBubbles, commandKey, envelope, heartBubble, lightning, smilieyChat)
import Ports exposing (getOrgSlug, receiveOrgSlug)
import Process
import Set exposing (Set)
import Svg exposing (Svg)
import Task
import Time


port viewingPhone : (Bool -> msg) -> Sub msg



-- MODEL


type alias Model =
    { key : Nav.Key
    , sessionState : SessionState
    , activeExperienceTab : ExperienceTab
    , carouselActive : Bool
    , expandedFaqs : Set String
    , expandedFeature : Maybe String
    }


type SessionState
    = Unknown
    | Checking
    | Valid
    | Invalid


type ExperienceTab
    = Email
    | Quote
    | Underwriting


type Msg
    = CheckSession
    | GotSessionResponse (Result Http.Error SessionResponse)
    | NavigateSignup
    | SetExperienceTab ExperienceTab
    | StartCarousel
    | StopCarousel
    | RotateCarousel Time.Posix
    | ToggleFaq String
    | ToggleFeature String
    | PhoneSectionVisible Bool
    | NoOp


type alias SessionResponse =
    { valid : Bool }


init : Nav.Key -> ( Model, Cmd Msg )
init key =
    ( { key = key
      , sessionState = Unknown
      , activeExperienceTab = Email
      , carouselActive = True
      , expandedFaqs = Set.empty
      , expandedFeature = Nothing
      }
    , checkSession
    )


checkSession : Cmd Msg
checkSession =
    Http.get
        { url = "/api/auth/session"
        , expect = Http.expectJson GotSessionResponse sessionResponseDecoder
        }


sessionResponseDecoder : Decode.Decoder SessionResponse
sessionResponseDecoder =
    Decode.map SessionResponse
        (Decode.field "valid" Decode.bool)



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        CheckSession ->
            ( { model | sessionState = Checking }
            , checkSession
            )

        GotSessionResponse result ->
            case result of
                Ok response ->
                    ( { model
                        | sessionState =
                            if response.valid then
                                Valid

                            else
                                Invalid
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | sessionState = Invalid }
                    , Cmd.none
                    )

        NavigateSignup ->
            ( model
            , Nav.pushUrl model.key "/waitlist"
            )

        SetExperienceTab tab ->
            ( { model | activeExperienceTab = tab, carouselActive = False }
            , Cmd.batch
                [ Process.sleep 5000
                    |> Task.perform (\_ -> StartCarousel)
                ]
            )

        StartCarousel ->
            ( { model | carouselActive = True }
            , Cmd.none
            )

        StopCarousel ->
            ( { model | carouselActive = False }
            , Cmd.none
            )

        RotateCarousel _ ->
            if model.carouselActive then
                let
                    nextTab =
                        case model.activeExperienceTab of
                            Email ->
                                Quote

                            Quote ->
                                Underwriting

                            Underwriting ->
                                Email
                in
                ( { model | activeExperienceTab = nextTab }
                , Cmd.none
                )

            else
                ( model, Cmd.none )

        ToggleFaq id ->
            ( { model
                | expandedFaqs =
                    if Set.member id model.expandedFaqs then
                        Set.remove id model.expandedFaqs

                    else
                        Set.insert id model.expandedFaqs
              }
            , Cmd.none
            )

        ToggleFeature id ->
            ( { model
                | expandedFeature =
                    if model.expandedFeature == Just id then
                        Nothing

                    else
                        Just id
              }
            , Cmd.none
            )

        PhoneSectionVisible isVisible ->
            if isVisible then
                ( { model | activeExperienceTab = Email, carouselActive = True }
                , Cmd.none
                )

            else
                ( model, Cmd.none )

        NoOp ->
            ( model, Cmd.none )



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Medicare Max - Boost Your Medigap Renewals with AI"
    , body =
        [ div [ class "min-h-screen bg-white md:snap-y md:snap-mandatory overflow-y-auto h-screen scroll-smooth" ]
            [ nav [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8 py-4 sm:py-6 sticky top-0 z-50 bg-white hidden xl:block" ]
                [ div [ class "flex justify-between items-center" ]
                    [ div [ class "flex items-center" ]
                        [ img
                            [ src "/images/medicare-max-logo.png"
                            , class "h-6 sm:h-8 w-auto"
                            , alt "Medicare Max logo"
                            ]
                            []
                        ]
                    , div [ class "flex items-center" ]
                        [ button
                            [ onClick NavigateSignup
                            , class "bg-[#03045E] text-white px-4 sm:px-6 py-2 rounded-lg text-sm font-medium hover:bg-[#1a1f5f] transition-colors duration-200"
                            ]
                            [ text "Get Early Access" ]
                        ]
                    ]
                ]
            , div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8 pt-8 sm:pt-16 pb-16 sm:pb-32 min-h-screen flex items-center md:snap-start" ]
                [ div [ class "grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16 items-center" ]
                    [ div [ class "relative" ]
                        [ nav [ class "mb-8 xl:hidden" ]
                            [ div [ class "flex justify-between items-center" ]
                                [ div [ class "flex items-center" ]
                                    [ img
                                        [ src "/images/medicare-max-logo.png"
                                        , class "h-6 sm:h-8 w-auto"
                                        , alt "Medicare Max logo"
                                        ]
                                        []
                                    ]
                                , div [ class "flex items-center" ]
                                    [ button
                                        [ onClick NavigateSignup
                                        , class "bg-[#03045E] text-white px-4 sm:px-6 py-2 rounded-lg text-sm font-medium hover:bg-[#1a1f5f] transition-colors duration-200"
                                        ]
                                        [ text "Get Early Access" ]
                                    ]
                                ]
                            ]
                        , div [ class "flex justify-center sm:justify-start w-full" ]
                            [ div [ class "inline-flex items-center rounded-full bg-[#F9F5FF] mt-16 sm:mt-0 px-0 sm:px-0 py-1 mb-6 sm:mb-8" ]
                                [ div [ class "bg-[#03045E] rounded-full px-3 sm:px-3.5 py-1" ]
                                    [ span [ class "text-xs sm:text-sm text-white" ] [ text "Old book of business?" ]
                                    ]
                                , div [ class "flex items-center px-2 sm:px-3" ]
                                    [ span [ class "text-xs sm:text-sm font-medium text-[#03045E]" ] [ text "Renew with ease" ]
                                    , span [ class "ml-1 text-[#03045E]" ] [ text "→" ]
                                    ]
                                ]
                            ]
                        , h1
                            [ class "text-3xl sm:text-4xl lg:text-5xl xl:text-6xl tracking-tight font-semibold text-[#141B29] leading-[1.2] text-center sm:text-left" ]
                            [ text "Boost Your Medigap Renewals with AI" ]
                        , p
                            [ class "mt-4 sm:mt-6 text-base sm:text-lg text-[#475467] leading-[1.5] text-center sm:text-left" ]
                            [ text "Our AI-powered system handles client outreach, quotes, health underwriting, and e-apps — magically resetting your residuals so you can focus on growing your book." ]
                        , div [ class "mt-6 sm:mt-10 flex justify-center sm:justify-start" ]
                            [ button
                                [ onClick NavigateSignup
                                , class "w-full sm:w-auto inline-flex items-center justify-center px-4 sm:px-6 py-3 sm:py-4 rounded-lg text-base sm:text-lg font-semibold text-white bg-[#03045E] hover:bg-[#1a1f5f] transition-colors duration-200"
                                ]
                                [ text "Get Early Access" ]
                            ]
                        ]
                    , div [ class "relative" ]
                        [ div [ class "mx-auto w-full max-w-sm sm:max-w-none relative rounded-lg overflow-hidden" ]
                            [ img
                                [ src "/images/hero.png"
                                , class "w-full"
                                , alt "Dashboard with agent statistics"
                                ]
                                []
                            ]
                        ]
                    ]
                ]
            , div [ class "bg-white py-8 sm:py-16 min-h-screen flex items-center md:snap-start" ]
                [ div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8" ]
                    [ div [ class "mb-8 sm:mb-12 text-left" ]
                        [ span [ class "text-[#03045E] font-semibold text-sm sm:text-base" ] [ text "It's quite simple" ]
                        , h2 [ class "mt-2 sm:mt-3 text-2xl sm:text-3xl md:text-4xl font-semibold text-gray-900" ] [ text "Here's how it works" ]
                        , p [ class "mt-2 sm:mt-4 text-base sm:text-lg text-gray-600" ] [ text "3 easy steps to setup your book and automate your retention." ]
                        ]
                    , div [ class "grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-8 mt-8 sm:mt-16" ]
                        [ div [ class "bg-[#F9FAFB] p-4 sm:p-6 rounded-lg flex flex-row sm:flex-col items-center sm:items-center" ]
                            [ div [ class "bg-[#03045E] w-10 sm:w-12 h-10 sm:h-12 flex items-center justify-center rounded-lg mr-4 sm:mr-0 sm:mb-6 flex-shrink-0" ]
                                [ lightning 24 "#FFFFFF"
                                ]
                            , div [ class "flex-1 sm:text-center" ]
                                [ h3 [ class "text-lg sm:text-xl font-semibold text-gray-900 text-left sm:text-center" ] [ text "Upload" ]
                                , p [ class "mt-2 text-sm sm:text-base text-gray-600 text-left sm:text-center" ] [ text "Upload your book of business effortlessly. Our system tracks policy age, renewal windows, and client details automatically." ]
                                ]
                            ]
                        , div [ class "bg-[#F9FAFB] p-4 sm:p-6 rounded-lg flex flex-row sm:flex-col items-center sm:items-center" ]
                            [ div [ class "bg-[#03045E] w-10 sm:w-12 h-10 sm:h-12 flex items-center justify-center rounded-lg mr-4 sm:mr-0 sm:mb-6 flex-shrink-0" ]
                                [ envelope 24 "#FFFFFF"
                                ]
                            , div [ class "flex-1 sm:text-center" ]
                                [ h3 [ class "text-lg sm:text-xl font-semibold text-gray-900 text-left sm:text-center" ] [ text "Engage" ]
                                , p [ class "mt-2 text-sm sm:text-base text-gray-600 text-left sm:text-center" ] [ text "Clients receive personalized quotes showing your preferred carriers, underwriting pre-checks, and renewal options at key moments—without manual outreach." ]
                                ]
                            ]
                        , div [ class "bg-[#F9FAFB] p-4 sm:p-6 rounded-lg flex flex-row sm:flex-col items-center sm:items-center" ]
                            [ div [ class "bg-[#03045E] w-10 sm:w-12 h-10 sm:h-12 flex items-center justify-center rounded-lg mr-4 sm:mr-0 sm:mb-6 flex-shrink-0" ]
                                [ brightArrow 24 "#FFFFFF"
                                ]
                            , div [ class "flex-1 sm:text-center" ]
                                [ h3 [ class "text-lg sm:text-xl font-semibold text-gray-900 text-left sm:text-center" ] [ text "Retain & Reset" ]
                                , p [ class "mt-2 text-sm sm:text-base text-gray-600 text-left sm:text-center" ] [ text "Clients complete 95% of the underwriting and application on their own. You simply verify details in a quick 5-minute call and submit the application." ]
                                ]
                            ]
                        ]
                    ]
                ]
            , div [ class "py-8 max-w-7xl mx-auto px-6 sm:px-6 lg:px-8 min-h-screen flex flex-col justify-center md:snap-start" ]
                [ div [ class "lg:block hidden text-left md:mb-10 max-w-3xl" ]
                    [ h2 [ class "text-2xl sm:text-3xl md:text-4xl font-semibold text-gray-900" ]
                        [ text "Your Client's Personalized Experience" ]
                    , p [ class "mt-3 text-base sm:text-lg text-gray-600" ]
                        [ text "Hover over each section to see what your client will experience along their journey to resetting the clock." ]
                    ]
                , div [ class "relative" ]
                    [ div [ class "absolute right-0 top-0 lg:-mt-40 lg:-mr-4 z-0 hidden lg:block" ]
                        [ div
                            [ class "relative h-[650px] w-[340px] lg:w-[380px] lg:h-[770px] rounded-[40px] transform lg:rotate-[3deg] overflow-hidden"
                            ]
                            [ div [ class (phoneContentClass model.activeExperienceTab Email) ]
                                [ img
                                    [ src "/images/email.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover rounded-[40px]"
                                    , alt "Personalized email preview"
                                    ]
                                    []
                                ]
                            , div [ class (phoneContentClass model.activeExperienceTab Quote) ]
                                [ img
                                    [ src "/images/quote.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover rounded-[40px]"
                                    , alt "Medicare quote comparison"
                                    ]
                                    []
                                ]
                            , div [ class (phoneContentClass model.activeExperienceTab Underwriting) ]
                                [ img
                                    [ src "/images/underwriting.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover rounded-[40px]"
                                    , alt "Underwriting and scheduling interface"
                                    ]
                                    []
                                ]
                            , div
                                [ class "absolute inset-0 pointer-events-none z-10"
                                , style "box-shadow" "inset 0 0 25px 20px #F9FAFB"
                                , style "border-radius" "40px"
                                ]
                                []
                            , div
                                [ class "absolute bottom-0 left-0 right-0 h-[30%] pointer-events-none"
                                , style "background" "linear-gradient(to top, #F9FAFB 0%, rgba(249, 250, 251, 0) 100%)"
                                ]
                                []
                            , div
                                [ class "absolute top-0 left-0 right-0 h-[20%] pointer-events-none"
                                , style "background" "linear-gradient(to bottom, #F9FAFB 0%, rgba(249, 250, 251, 0) 100%)"
                                ]
                                []
                            , div
                                [ class "absolute -left-[50px] -right-[50px] -bottom-[50px] h-[100px] pointer-events-none"
                                , style "background" "#F9FAFB"
                                , style "filter" "blur(40px)"
                                ]
                                []
                            ]
                        ]
                    , div [ class "lg:hidden flex flex-col items-center" ]
                        [ h2 [ class "text-2xl sm:text-3xl font-semibold text-gray-900 text-center mt-2 mb-4" ]
                            [ text "Your Client's Personalized Experience" ]
                        , div
                            [ class "relative h-[400px] w-[280px] rounded-[30px] overflow-hidden mb-4"
                            ]
                            [ div [ class (phoneContentClass model.activeExperienceTab Email) ]
                                [ img
                                    [ src "/images/email_crop.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover object-center rounded-[30px]"
                                    , alt "Personalized email preview"
                                    ]
                                    []
                                ]
                            , div [ class (phoneContentClass model.activeExperienceTab Quote) ]
                                [ img
                                    [ src "/images/quote_crop.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover object-center rounded-[30px]"
                                    , alt "Medicare quote comparison"
                                    ]
                                    []
                                ]
                            , div [ class (phoneContentClass model.activeExperienceTab Underwriting) ]
                                [ img
                                    [ src "/images/underwriting_crop.jpeg"
                                    , class "absolute inset-0 w-full h-full object-cover object-center rounded-[30px]"
                                    , alt "Underwriting and scheduling interface"
                                    ]
                                    []
                                ]
                            , div
                                [ class "absolute inset-0 pointer-events-none z-10"
                                , style "box-shadow" "inset 0 0 15px 10px #F9FAFB"
                                , style "border-radius" "30px"
                                ]
                                []
                            ]
                        ]
                    , div [ class "lg:hidden w-full" ]
                        [ div [ class "grid grid-cols-3 gap-1 mb-1" ]
                            [ div
                                [ class (tabContainerClass model.activeExperienceTab Email)
                                , onClick (SetExperienceTab Email)
                                ]
                                [ text "Email" ]
                            , div
                                [ class (tabContainerClass model.activeExperienceTab Quote)
                                , onClick (SetExperienceTab Quote)
                                ]
                                [ text "Quotes" ]
                            , div
                                [ class (tabContainerClass model.activeExperienceTab Underwriting)
                                , onClick (SetExperienceTab Underwriting)
                                ]
                                [ text "Underwriting" ]
                            ]
                        , div [ class "bg-white p-4 rounded-b-lg shadow-sm border-t-0" ]
                            [ div
                                [ class
                                    (if model.activeExperienceTab == Email then
                                        "block"

                                     else
                                        "hidden"
                                    )
                                ]
                                [ h3 [ class "text-lg font-semibold text-gray-900" ]
                                    [ text "Your Client Receives a Personalized Email" ]
                                , p [ class "mt-2 text-gray-600" ]
                                    [ text "Your client gets a tailored email with their name, plan info, and helpful next steps—making them feel seen, supported, and confident in their Medicare decision." ]
                                ]
                            , div
                                [ class
                                    (if model.activeExperienceTab == Quote then
                                        "block"

                                     else
                                        "hidden"
                                    )
                                ]
                                [ h3 [ class "text-lg font-semibold text-gray-900" ]
                                    [ text "They Review the Quotes" ]
                                , p [ class "mt-2 text-gray-600" ]
                                    [ text "Your client can easily review their personalized Medicare quotes—clear, side-by-side comparisons that make choosing the right plan simple and stress-free." ]
                                ]
                            , div
                                [ class
                                    (if model.activeExperienceTab == Underwriting then
                                        "block"

                                     else
                                        "hidden"
                                    )
                                ]
                                [ h3 [ class "text-lg font-semibold text-gray-900" ]
                                    [ text "And Then Complete Underwriting & Schedules" ]
                                , p [ class "mt-2 text-gray-600" ]
                                    [ text "Your client answers a few quick health questions and picks a time that works best for them—keeping the process smooth, secure, and completely on their terms." ]
                                ]
                            ]
                        ]
                    , div [ class "relative w-full lg:w-3/5 space-y-8 z-10 hidden lg:block" ]
                        [ div
                            [ class (experienceTabClass model.activeExperienceTab Email)
                            , onMouseEnter (SetExperienceTab Email)
                            , onMouseLeave StartCarousel
                            , onClick (SetExperienceTab Email)
                            ]
                            [ h3 [ class "text-xl font-semibold text-gray-900" ]
                                [ text "Your Client Receives a Personalized Email" ]
                            , p [ class "mt-2 text-gray-600" ]
                                [ text "Your client gets a tailored email with their name, plan info, and helpful next steps—making them feel seen, supported, and confident in their Medicare decision." ]
                            ]
                        , div
                            [ class (experienceTabClass model.activeExperienceTab Quote)
                            , onMouseEnter (SetExperienceTab Quote)
                            , onMouseLeave StartCarousel
                            , onClick (SetExperienceTab Quote)
                            ]
                            [ h3 [ class "text-xl font-semibold text-gray-900" ]
                                [ text "They Review the Quotes" ]
                            , p [ class "mt-2 text-gray-600" ]
                                [ text "Your client can easily review their personalized Medicare quotes—clear, side-by-side comparisons that make choosing the right plan simple and stress-free." ]
                            ]
                        , div
                            [ class (experienceTabClass model.activeExperienceTab Underwriting)
                            , onMouseEnter (SetExperienceTab Underwriting)
                            , onMouseLeave StartCarousel
                            , onClick (SetExperienceTab Underwriting)
                            ]
                            [ h3 [ class "text-xl font-semibold text-gray-900" ]
                                [ text "And Then Complete Underwriting & Schedules" ]
                            , p [ class "mt-2 text-gray-600" ]
                                [ text "Your client answers a few quick health questions and picks a time that works best for them—keeping the process smooth, secure, and completely on their terms." ]
                            ]
                        ]
                    ]
                ]
            , div [ class "py-12 sm:py-16 bg-white relative overflow-hidden min-h-[50vh] sm:min-h-screen flex items-center md:snap-start" ]
                [ div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8" ]
                    [ div [ class "text-center mb-8" ]
                        [ h2 [ class "text-3xl sm:text-4xl font-semibold text-gray-900" ] [ text "All you need to reset your commissions" ]
                        , p [ class "mt-4 text-lg text-gray-600" ] [ text "It's like having a new team member that's only focused on retention." ]
                        ]
                    , div [ class "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-16" ]
                        [ featureCard model "quote-flow" "Simple Quote to Call Flow" "Streamline your workflow with a automated process that takes clients from initial quote to final application in just a few clicks." (chatBubbles 24 "#03045E")
                        , featureCard model "protection" "Non-Commissionable Protection" "Our AI-powered logic engine only sends emails to clients that are fully commissionable." (lightning 24 "#03045E")
                        , featureCard model "analytics" "Live Analytics" "Track real-time engagement metrics, conversion rates, and upcoming renewal opportunities in your personalized dashboard." (activity 24 "#03045E")
                        , featureCard model "notifications" "Activity Notifications" "Get instant alerts when clients review quotes, complete underwriting, or request follow-ups, so you never miss an opportunity to connect." (smilieyChat 24 "#03045E")
                        , featureCard model "carrier-control" "Carrier and Licensing Control" "Customize which carriers and plans to showcase based on your licenses and preferred partnerships." (commandKey 24 "#03045E")
                        , featureCard model "agency-setup" "Agent or Agency Setup" "Configure individual agent profiles or manage your entire agency with customizable roles and white-labeled client communications." (heartBubble 24 "#03045E")
                        ]
                    ]
                ]
            , div [ class "py-12 sm:py-16 bg-white relative overflow-hidden min-h-[50vh] sm:min-h-screen flex items-center md:snap-start" ]
                [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-20 w-full" ]
                    [ div [ class "grid grid-cols-1 gap-8 mt-16" ]
                        [ -- Mobile layout (hidden on larger screens)
                          div [ class "flex flex-col items-center md:hidden" ]
                            [ div [ class "w-full text-center px-4 mb-8" ]
                                [ h2 [ class "text-2xl font-semibold text-gray-900" ]
                                    [ text "Residuals don't need to vanish. We make sure they don't." ]
                                ]
                            , div [ class "w-full mb-6" ]
                                [ div [ class "mx-auto max-w-xs" ]
                                    [ img [ src "/images/flap.png", class "w-full h-auto", alt "Dashboard interface" ] [] ]
                                ]
                            , div [ class "w-full text-center p-4" ]
                                [ div [ class "space-y-3 mt-8" ]
                                    [ div [ class "flex gap-3 items-start" ]
                                        [ div [ class "text-[#03045E] text-lg flex-shrink-0" ] [ text "✓" ]
                                        , p [ class "text-base text-gray-600 text-left" ] [ text "White-Labeled Tools" ]
                                        ]
                                    , div [ class "flex gap-3 items-start" ]
                                        [ div [ class "text-[#03045E] text-lg flex-shrink-0" ] [ text "✓" ]
                                        , p [ class "text-base text-gray-600 text-left" ] [ text "5 Minute Setup" ]
                                        ]
                                    , div [ class "flex gap-3 items-start" ]
                                        [ div [ class "text-[#03045E] text-lg flex-shrink-0" ] [ text "✓" ]
                                        , p [ class "text-base text-gray-600 text-left" ] [ text "Automated Retention" ]
                                        ]
                                    ]
                                , div [ class "mt-6 flex justify-center" ]
                                    [ button
                                        [ onClick NavigateSignup
                                        , class "inline-flex items-center px-5 py-2 rounded-lg text-base font-medium text-white bg-[#03045E] hover:bg-[#1a1f5f] transition-colors duration-200"
                                        ]
                                        [ text "Get Early Access" ]
                                    ]
                                ]
                            ]

                        -- Desktop layout (hidden on small screens)
                        , div [ class "hidden md:flex flex-col items-center justify-center relative w-full min-h-[700px]" ]
                            [ div [ class "max-w-4xl mx-auto text-center" ]
                                [ h2 [ class "text-6xl font-semibold text-gray-900 mb-12" ]
                                    [ text "Residuals don't need to vanish. We make sure they don't." ]
                                , div [ class "flex justify-center items-center gap-24" ]
                                    [ div [ class "space-y-6 text-left" ]
                                        [ div [ class "flex gap-4 items-start" ]
                                            [ div [ class "text-[#03045E] text-2xl" ] [ text "✓" ]
                                            , p [ class "text-xl text-gray-600" ] [ text "White-Labeled Tools" ]
                                            ]
                                        , div [ class "flex gap-4 items-start" ]
                                            [ div [ class "text-[#03045E] text-2xl" ] [ text "✓" ]
                                            , p [ class "text-xl text-gray-600" ] [ text "5 Minute Setup" ]
                                            ]
                                        , div [ class "flex gap-4 items-start" ]
                                            [ div [ class "text-[#03045E] text-2xl" ] [ text "✓" ]
                                            , p [ class "text-xl text-gray-600" ] [ text "Automated Retention" ]
                                            ]
                                        , div [ class "mt-10" ]
                                            [ button
                                                [ onClick NavigateSignup
                                                , class "inline-flex items-center px-8 py-4 rounded-lg text-lg font-medium text-white bg-[#03045E] hover:bg-[#1a1f5f] transition-colors duration-200"
                                                ]
                                                [ text "Get Early Access" ]
                                            ]
                                        ]
                                    , div [ class "relative w-[500px]" ]
                                        [ img [ src "/images/flap.png", class "w-full h-auto", alt "Dashboard interface" ] [] ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            , div [ class "py-8 sm:py-16 min-h-[50vh] sm:min-h-screen flex items-center md:snap-start" ]
                [ div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8" ]
                    [ div [ class "text-center mb-8 sm:mb-12" ]
                        [ h2 [ class "text-3xl sm:text-4xl font-semibold text-gray-900" ] [ text "Frequently asked questions" ]
                        , p [ class "mt-4 text-lg text-gray-600" ] [ text "Everything you need to know." ]
                        ]
                    , div [ class "max-w-3xl mx-auto divide-y divide-gray-200" ]
                        [ faqItem "How many emails can I send?"
                            "Our system sends regular, automated emails to every client in your book of business. Each plan tier supports different numbers of contacts - so you can choose the right level for your agency size. The emails continue indefinitely to keep your book engaged and ready for renewal opportunities."
                            model
                        , faqItem "How do I know my Client data is protected?"
                            "We take data security extremely seriously. All client data is encrypted both in transit and at rest using industry-standard encryption protocols. Additionally, each agency gets their own dedicated database instance, ensuring complete data separation between different agencies' client records."
                            model
                        , faqItem "Will I be notified when someone requests a quote?"
                            "Yes, you'll receive real-time notifications whenever a client requests a quote or takes any significant action. You can customize your notification preferences in your dashboard settings."
                            model
                        , faqItem "Will the emails come from me?"
                            "Yes, all communications are white-labeled and will appear to come directly from you. You can customize the email sender name and signature to maintain your personal brand and relationship with your clients."
                            model
                        ]
                    , div [ class "mt-16 text-center hidden md:block" ]
                        [ h3 [ class "text-2xl font-semibold text-gray-900" ] [ text "Want to be notified on launch day?" ]
                        , p [ class "mt-4 text-lg text-gray-600" ] [ text "Join agents all across the US ready to reset their books." ]
                        , div [ class "mt-8" ]
                            [ button
                                [ onClick NavigateSignup
                                , class "inline-flex items-center px-6 py-3 rounded-lg text-base font-medium text-white bg-[#03045E] hover:bg-[#1a1f5f] transition-colors duration-200"
                                ]
                                [ text "Get Early Access" ]
                            ]
                        ]
                    ]
                ]
            , div [ class "py-8 sm:py-14 min-h-[40vh] sm:min-h-screen flex items-center md:snap-start md:hidden" ]
                [ div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8" ]
                    [ div [ class "text-center" ]
                        [ h3 [ class "text-2xl font-semibold text-gray-900" ] [ text "Want to be notified on launch day?" ]
                        , p [ class "mt-4 text-lg text-gray-600" ] [ text "Join agents all across the US ready to reset their books." ]
                        , div [ class "mt-8" ]
                            [ button
                                [ onClick NavigateSignup
                                , class "inline-flex items-center px-6 py-3 rounded-lg text-base font-medium text-white bg-[#03045E] hover:bg-[#1a1f5f] transition-colors duration-200 w-full sm:w-auto justify-center"
                                ]
                                [ text "Get Early Access" ]
                            ]
                        ]
                    ]
                ]
            , footer [ class "bg-[#141B29] text-white py-6 sm:py-8 md:py-16 md:snap-start" ]
                [ div [ class "max-w-7xl mx-auto px-6 sm:px-6 lg:px-8" ]
                    [ div [ class "flex flex-col md:flex-row justify-between pb-4 sm:pb-6" ]
                        [ div [ class "mb-4 md:mb-0" ]
                            [ div [ class "flex items-center" ]
                                [ img [ src "/images/whiteIcon.svg", class "h-6 sm:h-8 w-auto", alt "Medicare Max logo" ] []
                                ]
                            , p [ class "mt-2 text-sm sm:text-base text-[#94969C]" ] [ text "Retention technology that has your back." ]
                            ]
                        ]
                    , div [ class "flex gap-3 sm:gap-4 mb-4" ]
                        [ span [ class "text-sm sm:text-base text-[#94969C]" ]
                            [ text "email: "
                            , a [ href "mailto:information@medicaremax.ai", class "text-[#94969C] hover:text-white" ] [ text "information@medicaremax.ai" ]
                            ]
                        ]
                    , div [ class "border-t border-[#1F242F] pt-4 sm:pt-5 text-[#94969C] text-sm sm:text-base" ]
                        [ p [] [ text "© 2025 Medicare Max. All rights reserved." ] ]
                    ]
                ]
            ]
        ]
    }


imageVisibilityClass : ExperienceTab -> ExperienceTab -> String
imageVisibilityClass activeTab tab =
    if activeTab == tab then
        "absolute inset-0 w-full h-full object-cover transition-opacity duration-500 opacity-100"

    else
        "absolute inset-0 w-full h-full object-cover transition-opacity duration-500 opacity-0"


experienceTabClass : ExperienceTab -> ExperienceTab -> String
experienceTabClass activeTab tab =
    let
        baseClass =
            "border-l-4 pl-4 sm:pl-6 py-4 sm:py-5 cursor-pointer transition-all duration-300 ease-in-out"
    in
    if activeTab == tab then
        baseClass ++ " border-[#03045E]"

    else
        baseClass ++ " border-gray-200 hover:border-gray-400"


phoneContentClass : ExperienceTab -> ExperienceTab -> String
phoneContentClass activeTab tab =
    if activeTab == tab then
        "absolute inset-0 w-full h-full transition-opacity duration-500 opacity-100"

    else
        "absolute inset-0 w-full h-full transition-opacity duration-500 opacity-0"


featureCard : Model -> String -> String -> String -> Svg Msg -> Html Msg
featureCard model id title description icon =
    let
        -- Base classes shared across all sizes
        baseCardClass =
            "rounded-lg transition-all duration-300 ease-in-out flex flex-col h-full"

        -- Mobile-specific classes (non-expandable, more compact)
        mobileCardClass =
            "md:hidden " ++ baseCardClass ++ " bg-[#F9FAFB] p-4 mx-4"

        -- Desktop-specific classes
        desktopCardClass =
            "hidden md:flex " ++ baseCardClass ++ " bg-[#F9FAFB] p-4 sm:p-5"

        -- Mobile title classes
        mobileTitleClass =
            "md:hidden text-base font-semibold text-gray-900 text-center"

        -- Desktop title classes
        desktopTitleClass =
            "hidden md:block text-base sm:text-lg font-semibold text-gray-900 text-center"

        -- Mobile icon container
        mobileIconContainerClass =
            "md:hidden w-10 h-10 mx-auto mb-3 rounded-lg flex items-center justify-center shadow-sm"

        -- Desktop icon container
        desktopIconContainerClass =
            "hidden md:flex w-10 h-10 sm:w-11 sm:h-11 mx-auto mb-3 sm:mb-4 rounded-lg items-center justify-center shadow-md"
    in
    div []
        [ -- Mobile version (non-expandable)
          div
            [ class mobileCardClass ]
            [ div [ class mobileIconContainerClass ] [ icon ]
            , h3 [ class mobileTitleClass ] [ text title ]
            , p [ class "md:hidden mt-2 text-xs text-gray-600 text-center" ] [ text description ]
            ]

        -- Desktop version
        , div [ class desktopCardClass ]
            [ div [ class desktopIconContainerClass ] [ icon ]
            , h3 [ class desktopTitleClass ] [ text title ]
            , p [ class "hidden md:block mt-2 text-xs sm:text-sm text-gray-600 text-center" ] [ text description ]
            ]
        ]


faqItem : String -> String -> Model -> Html Msg
faqItem question answer model =
    let
        isExpanded =
            Set.member question model.expandedFaqs
    in
    div [ class "py-4 sm:py-6" ]
        [ div
            [ class "flex justify-between items-start cursor-pointer group"
            , onClick (ToggleFaq question)
            ]
            [ h3 [ class "text-base sm:text-lg font-medium text-gray-900 group-hover:text-gray-700 transition-colors duration-200" ] [ text question ]
            , button
                [ class "ml-4 sm:ml-6 h-6 sm:h-7 w-6 sm:w-7 flex items-center justify-center rounded-full group-hover:bg-gray-100 transition-colors duration-200"
                ]
                [ span
                    [ class "text-gray-500 text-lg sm:text-xl transition-transform duration-200"
                    , style "transform"
                        (if isExpanded then
                            "rotate(180deg)"

                         else
                            "rotate(0deg)"
                        )
                    ]
                    [ text
                        (if isExpanded then
                            "-"

                         else
                            "+"
                        )
                    ]
                ]
            ]
        , div
            [ class "mt-2 text-sm sm:text-base text-gray-600 overflow-hidden transition-all duration-300 ease-in-out"
            , style "max-height"
                (if isExpanded then
                    "500px"

                 else
                    "0"
                )
            , style "opacity"
                (if isExpanded then
                    "1"

                 else
                    "0"
                )
            ]
            [ text answer ]
        ]



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions model =
    let
        carouselMsg =
            if model.carouselActive then
                Time.every 4000 RotateCarousel

            else
                Sub.none
    in
    Sub.batch
        [ carouselMsg
        , viewingPhone PhoneSectionVisible
        ]


mobileTabButtonClass : ExperienceTab -> ExperienceTab -> String
mobileTabButtonClass activeTab tab =
    let
        baseClass =
            "px-4 py-2 text-sm font-medium rounded-lg transition-colors duration-200"
    in
    if activeTab == tab then
        baseClass ++ " bg-[#03045E] text-white"

    else
        baseClass ++ " bg-gray-100 text-gray-700 hover:bg-gray-200"


tabContainerClass : ExperienceTab -> ExperienceTab -> String
tabContainerClass activeTab tab =
    let
        baseClass =
            "py-2 text-center text-sm font-medium cursor-pointer transition-colors duration-200 border-t-2"
    in
    if activeTab == tab then
        baseClass ++ " bg-white text-gray-900 border-t-2 border-[#03045E]"

    else
        baseClass ++ " bg-gray-100 text-gray-600 border-t-2 border-transparent"

================
File: src/Login.elm
================
module Login exposing (Model, Msg, init, subscriptions, update, view)

import Basics
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput, onSubmit)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Time
import Url
import Url.Parser as Parser exposing ((</>), (<?>), Parser, s, string)
import Url.Parser.Query as Query


type alias Model =
    { email : String
    , status : Status
    , isLoggedIn : Bool
    , key : Nav.Key
    , resendAvailableAt : Maybe Time.Posix
    , isFromOnboarding : Bool
    , prefilledEmail : Maybe String
    }


type Status
    = Idle
    | Submitting
    | Success
    | Failed String
    | LinkSent


type alias LoginResponse =
    { success : Bool
    }


type alias SessionCheckResponse =
    { valid : Bool }


type Msg
    = EmailChanged String
    | SubmitForm
    | GotLoginResponse (Result Http.Error LoginResponse)
    | GotSessionCheck (Result Http.Error SessionCheckResponse)
    | LogOut
    | NoOp
    | CheckResendAvailable Time.Posix
    | ResendLink


init : Nav.Key -> Bool -> Url.Url -> ( Model, Cmd Msg )
init key isLoggedIn url =
    let
        queryParams =
            extractQueryParams url
    in
    ( { email = Maybe.withDefault "" queryParams.email
      , status = Idle
      , isLoggedIn = isLoggedIn
      , key = key
      , resendAvailableAt = Nothing
      , isFromOnboarding = queryParams.onboarding
      , prefilledEmail = queryParams.email
      }
    , Cmd.none
    )



-- Helper to extract query parameters


extractQueryParams : Url.Url -> { onboarding : Bool, email : Maybe String }
extractQueryParams url =
    let
        parser =
            Query.map2
                (\onboarding email -> { onboarding = onboarding == Just "completed", email = email })
                (Query.string "onboarding")
                (Query.string "email")

        route =
            { url | path = "" }
                |> Parser.parse (Parser.top <?> parser)
    in
    Maybe.withDefault { onboarding = False, email = Nothing } route


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        EmailChanged email ->
            ( { model | email = email, status = Idle }
            , Cmd.none
            )

        SubmitForm ->
            if String.isEmpty model.email then
                ( { model | status = Failed "Please enter your email address" }
                , Cmd.none
                )

            else
                ( { model | status = Submitting }
                , Http.get
                    { url = "/api/auth/session"
                    , expect = Http.expectJson GotSessionCheck sessionCheckDecoder
                    }
                )

        GotSessionCheck result ->
            case result of
                Ok response ->
                    if response.valid then
                        -- If session is valid, redirect to dashboard
                        ( model
                        , Nav.pushUrl model.key "/dashboard"
                        )

                    else
                        -- If no valid session, proceed with login
                        let
                            -- Set resend cooldown to 60 seconds from now
                            now =
                                Time.millisToPosix 0

                            -- Placeholder, would normally use actual current time
                            cooldownTime =
                                Time.millisToPosix (Time.posixToMillis now + 60000)
                        in
                        ( { model | resendAvailableAt = Just cooldownTime }
                        , Http.post
                            { url = "/api/auth/login"
                            , body = Http.jsonBody (encodeLoginBody model.email)
                            , expect = Http.expectJson GotLoginResponse loginResponseDecoder
                            }
                        )

                Err _ ->
                    -- On error checking session, proceed with normal login flow
                    let
                        -- Set resend cooldown to 60 seconds from now
                        now =
                            Time.millisToPosix 0

                        -- Placeholder, would normally use actual current time
                        cooldownTime =
                            Time.millisToPosix (Time.posixToMillis now + 60000)
                    in
                    ( { model | resendAvailableAt = Just cooldownTime }
                    , Http.post
                        { url = "/api/auth/login"
                        , body = Http.jsonBody (encodeLoginBody model.email)
                        , expect = Http.expectJson GotLoginResponse loginResponseDecoder
                        }
                    )

        NoOp ->
            ( model, Cmd.none )

        LogOut ->
            ( { model
                | isLoggedIn = False
                , status = Idle
              }
            , Http.post
                { url = "/api/auth/logout"
                , body = Http.emptyBody
                , expect = Http.expectWhatever (\_ -> NoOp)
                }
            )

        GotLoginResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | status = LinkSent }
                        , Cmd.none
                        )

                    else
                        ( { model | status = Failed "Failed to send login link. Please try again." }
                        , Cmd.none
                        )

                Err _ ->
                    ( { model | status = Failed "Failed to send login link. Please try again." }
                    , Cmd.none
                    )

        CheckResendAvailable currentTime ->
            case model.resendAvailableAt of
                Just availableAt ->
                    if Time.posixToMillis currentTime >= Time.posixToMillis availableAt then
                        ( { model | resendAvailableAt = Nothing }, Cmd.none )

                    else
                        ( model, Cmd.none )

                Nothing ->
                    ( model, Cmd.none )

        ResendLink ->
            update SubmitForm model


viewLoginForm : Model -> { title : String, body : List (Html Msg) }
viewLoginForm model =
    { title = "Login"
    , body =
        [ div [ class "min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8" ]
            [ div [ class "sm:mx-auto sm:w-full sm:max-w-md" ]
                [ h2 [ class "mt-6 text-center text-3xl font-extrabold text-gray-900" ]
                    [ if model.isFromOnboarding then
                        text "Activate Your Account"

                      else
                        text "Welcome Back To MedicareMax"
                    ]
                ]
            , div [ class "mt-8 sm:mx-auto sm:w-full sm:max-w-md" ]
                [ div [ class "bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10" ]
                    [ if model.isFromOnboarding then
                        div [ class "mb-6 bg-blue-50 p-4 rounded-md border border-blue-200" ]
                            [ p [ class "text-blue-800" ]
                                [ text "Your account has been created successfully! Please check your email for an activation link to continue to your new account." ]
                            ]

                      else
                        text ""
                    , Html.form [ onSubmit SubmitForm ]
                        [ div []
                            [ label [ for "email", class "block text-sm font-medium text-gray-700" ]
                                [ text "Email address" ]
                            , div [ class "mt-1" ]
                                [ input
                                    [ type_ "email"
                                    , name "email"
                                    , id "email"
                                    , class "appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    , placeholder "you@example.com"
                                    , value model.email
                                    , onInput EmailChanged
                                    ]
                                    []
                                ]
                            ]
                        , div [ class "mt-6" ]
                            [ button
                                [ type_ "submit"
                                , class "w-full flex justify-center py-2 px-4 sm:py-2.5 sm:px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                ]
                                [ text "Send login link" ]
                            ]
                        ]
                    , viewStatus model.status model
                    , div [ class "mt-4 text-center text-sm" ]
                        [ text "Not Yet a MedicareMax User? "
                        , a [ href "/signup", class "font-medium text-indigo-600 hover:text-indigo-500" ]
                            [ text "Sign Up Here" ]
                        ]
                    ]
                ]
            ]
        ]
    }


viewStatus : Status -> Model -> Html Msg
viewStatus status model =
    case status of
        LinkSent ->
            div [ class "mt-4 p-4 bg-green-50 rounded-md" ]
                [ p [ class "text-sm text-green-700 text-center" ]
                    [ p [ class "mb-2" ] [ text "If your email is registered, you'll receive a login link soon." ]
                    , p [] [ text "Check your inbox and spam folder." ]
                    ]
                , div [ class "mt-2 text-center" ]
                    [ viewResendLink model ]
                ]

        Failed error ->
            div [ class "mt-4 p-4 bg-red-50 rounded-md" ]
                [ p [ class "text-sm text-red-700" ]
                    [ text error ]
                ]

        Submitting ->
            div [ class "mt-4 text-center text-gray-600" ]
                [ text "Sending login link..." ]

        _ ->
            text ""


viewResendLink : Model -> Html Msg
viewResendLink model =
    case model.resendAvailableAt of
        Just availableAt ->
            let
                currentTime =
                    Time.millisToPosix 0

                -- Placeholder, would normally use actual current time
                diff =
                    Basics.max 0 ((Time.posixToMillis availableAt - Time.posixToMillis currentTime) // 1000)
            in
            if diff <= 0 then
                button
                    [ onClick ResendLink
                    , class "text-sm text-blue-600 hover:text-blue-800 underline"
                    ]
                    [ text "Resend link" ]

            else
                span [ class "text-sm text-gray-600" ]
                    [ text ("Resend link in " ++ String.fromInt diff ++ " seconds") ]

        Nothing ->
            button
                [ onClick ResendLink
                , class "text-sm text-blue-600 hover:text-blue-800 underline"
                ]
                [ text "Resend link" ]


encodeLoginBody : String -> Encode.Value
encodeLoginBody email =
    Encode.object
        [ ( "email", Encode.string email )
        ]


loginResponseDecoder : Decode.Decoder LoginResponse
loginResponseDecoder =
    Decode.map LoginResponse
        (Decode.field "success" Decode.bool)


sessionCheckDecoder : Decode.Decoder SessionCheckResponse
sessionCheckDecoder =
    Decode.map SessionCheckResponse
        (Decode.field "valid" Decode.bool)


subscriptions : Model -> Sub Msg
subscriptions model =
    case model.resendAvailableAt of
        Just _ ->
            Time.every 1000 CheckResendAvailable

        Nothing ->
            Sub.none


view : Model -> { title : String, body : List (Html Msg) }
view model =
    if model.isLoggedIn then
        { title = "Already Logged In"
        , body =
            [ div [ class "min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8" ]
                [ div [ class "sm:mx-auto sm:w-full sm:max-w-md" ]
                    [ h2 [ class "mt-6 text-center text-3xl font-extrabold text-gray-900" ]
                        [ text "Already Logged In" ]
                    , div [ class "mt-8 sm:mx-auto sm:w-full sm:max-w-md" ]
                        [ div [ class "bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10" ]
                            [ p [ class "text-center text-gray-600 mb-6" ]
                                [ text "You are already logged in." ]
                            , button
                                [ onClick LogOut
                                , class "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                                ]
                                [ text "Log Out" ]
                            ]
                        ]
                    ]
                ]
            ]
        }

    else
        viewLoginForm model

================
File: src/Logout.elm
================
module Logout exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Http


type alias Model =
    { key : Nav.Key }


type Msg
    = LogoutCompleted (Result Http.Error ())
    | NoOp


init : Nav.Key -> ( Model, Cmd Msg )
init key =
    ( { key = key }
    , Http.post
        { url = "/api/auth/logout"
        , body = Http.emptyBody
        , expect = Http.expectWhatever LogoutCompleted
        }
    )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        LogoutCompleted (Ok _) ->
            ( model
            , Nav.load "/"
            )

        LogoutCompleted (Err _) ->
            -- Even if the logout request fails, we'll redirect to home
            ( model
            , Nav.load "/"
            )

        NoOp ->
            ( model, Cmd.none )


view : Model -> Browser.Document Msg
view _ =
    { title = "Logging out..."
    , body =
        [ div [ class "min-h-screen bg-gray-50 flex items-center justify-center" ]
            [ div [ class "animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent" ] []
            ]
        ]
    }


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Main.elm
================
module Main exposing (main)

import AddAgent
import Browser exposing (Document)
import Browser.Events
import Browser.Navigation as Nav
import ChangePlan
import ChoosePlan
import Compare exposing (CompareParams)
import Components.AccountStatusBanner as AccountStatusBanner
import Contact
import Contacts
import Dashboard
import Eligibility
import Home
import Html exposing (Html, a, button, div, h1, img, nav, p, text)
import Html.Attributes exposing (alt, class, href, src)
import Html.Events exposing (onClick, stopPropagationOn)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as E
import Login
import Logout
import Onboarding.Onboarding as Onboarding
import Process
import Profile
import Quote
import Schedule
import SelfServiceOnboarding
import Settings
import Signup
import Svg exposing (path, svg)
import Svg.Attributes exposing (d, fill, viewBox)
import Task
import TempLanding
import Url exposing (Url)
import Url.Parser as Parser exposing ((</>), (<?>), Parser, map, oneOf, s, string, top)
import Url.Parser.Query as Query
import Waitlist
import Walkthrough



-- ONBOARDING STEP TYPES


type OnboardingStep
    = PlanStep
    | PersonalStep
    | CompanyStep
    | LicensingStep
    | AgentsStep
    | PaymentStep
    | EnterpriseStep



-- PORTS
-- Send a message to JavaScript to clear the session cookie


type alias VerificationResponse =
    { success : Bool
    , redirectUrl : String
    , session : String
    , email : String
    , orgSlug : String
    }


type alias SessionResponse =
    { valid : Bool
    , session : String
    , email : String
    , organizationSlug : String
    , firstName : String
    , lastName : String
    , id : String
    }


verificationDecoder : Decoder VerificationResponse
verificationDecoder =
    Decode.map5 VerificationResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "redirectUrl" Decode.string)
        (Decode.field "session" Decode.string)
        (Decode.field "email" Decode.string)
        (Decode.field "orgSlug" Decode.string)


sessionDecoder : Decoder SessionResponse
sessionDecoder =
    Decode.map7 SessionResponse
        (Decode.field "valid" Decode.bool)
        (Decode.field "session" Decode.string)
        (Decode.field "email" Decode.string)
        (Decode.field "organizationSlug" Decode.string)
        (Decode.oneOf
            [ Decode.field "firstName" Decode.string
            , Decode.field "first_name" Decode.string
            ]
        )
        (Decode.oneOf
            [ Decode.field "lastName" Decode.string
            , Decode.field "last_name" Decode.string
            ]
        )
        (Decode.field "id" (Decode.map String.fromInt Decode.int))


type alias User =
    { id : String
    , email : String
    , isAdmin : Bool
    , isAgent : Bool
    , organizationSlug : String
    , organizationId : String
    , firstName : String
    , lastName : String
    , subscriptionTier : String
    , accountStatus : Maybe AccountStatusBanner.AccountStatusDetails
    }



-- Account status types


type alias AccountStatus =
    String


type alias AccountStatusDetails =
    { status : AccountStatus
    , message : String
    , organizationId : Int
    , organizationName : String
    , organizationSlug : String
    , subscriptionTier : String
    , subscriptionStatus : String
    , agentLimit : Int
    , contactLimit : Int
    , currentAgentCount : Int
    , currentContactCount : Int
    , billingCycleEnd : Maybe String
    , paymentFailureCount : Int
    }


type alias Model =
    { key : Nav.Key
    , url : Url
    , page : Page
    , session : SessionState
    , currentUser : Maybe User
    , isSetup : Bool
    , intendedDestination : Maybe String
    , showDropdown : Bool
    , showStatusBanner : Bool
    }


type SessionState
    = Unknown -- Initial state
    | Verified String -- Has valid session
    | NoSession -- Definitely no valid session


type Page
    = NotFoundPage
    | LoginPage Login.Model
    | ContactsPage Contacts.Model
    | TempLandingPage TempLanding.Model
    | SettingsPage Settings.Model
    | Signup Signup.Model
    | ChoosePlanPage ChoosePlan.Model
    | ChangePlanPage ChangePlan.Model
    | AddAgentsPage AddAgent.Model
    | ProfilePage Profile.Model
    | LoadingPage
    | HomePage Home.Model
    | ContactPage Contact.Model
    | ComparePage Compare.Model
    | QuotePage Quote.Model
    | EligibilityPage Eligibility.Model
    | SchedulePage Schedule.Model
    | DashboardPage Dashboard.Model
    | LogoutPage Logout.Model
    | OnboardingPage Onboarding.Model
    | WalkthroughPage Walkthrough.Model
    | SelfOnboardingPage SelfServiceOnboarding.Model
    | WaitlistPage Waitlist.Model


type Msg
    = LinkClicked Browser.UrlRequest
    | InternalLinkClicked String
    | UrlChanged Url
    | LoginMsg Login.Msg
    | ContactsMsg Contacts.Msg
    | TempLandingMsg TempLanding.Msg
    | SettingsMsg Settings.Msg
    | SignupMsg Signup.Msg
    | ChoosePlanMsg ChoosePlan.Msg
    | ChangePlanMsg ChangePlan.Msg
    | AddAgentsMsg AddAgent.Msg
    | GotVerification (Result Http.Error VerificationResponse)
    | GotSession (Result Http.Error SessionResponse)
    | ProfileMsg Profile.Msg
    | HomeMsg Home.Msg
    | ContactMsg Contact.Msg
    | CompareMsg Compare.Msg
    | QuoteMsg Quote.Msg
    | EligibilityMsg Eligibility.Msg
    | ScheduleMsg Schedule.Msg
    | DashboardMsg Dashboard.Msg
    | NoOp
    | GotCurrentUser (Result Http.Error CurrentUserResponse)
    | OrgFinalized (Result Http.Error ())
    | LogoutMsg Logout.Msg
    | OnboardingMsg Onboarding.Msg
    | ToggleDropdown
    | CloseDropdown
    | InitiateLogout
    | GotAccountStatus (Result Http.Error AccountStatusResponse)
    | CloseStatusBanner
    | WalkthroughMsg Walkthrough.Msg
    | ShowDropdown
    | HideDropdown
    | ToggleStatusBanner
    | PerformRedirect String
    | DirectPageUpdate
    | SelfOnboardingMsg SelfServiceOnboarding.Msg
    | WaitlistMsg Waitlist.Msg


type alias Flags =
    {}


type alias CompareFlags =
    { state : String
    , zip : String
    , county : String
    , gender : String
    , tobacco : Bool
    , age : Int
    , planType : String
    , currentCarrier : Maybe String
    , dateOfBirth : String
    , quoteId : Maybe String
    }


main : Program Flags Model Msg
main =
    Browser.application
        { init = init
        , view = view
        , update = update
        , subscriptions = subscriptions
        , onUrlChange = UrlChanged
        , onUrlRequest = LinkClicked
        }


type alias AccountStatusResponse =
    { success : Bool
    , status : AccountStatusDetails
    }


accountStatusDecoder : Decoder AccountStatusDetails
accountStatusDecoder =
    Decode.succeed AccountStatusDetails
        |> Pipeline.required "status" Decode.string
        |> Pipeline.required "message" Decode.string
        |> Pipeline.required "organizationId" Decode.int
        |> Pipeline.required "organizationName" Decode.string
        |> Pipeline.required "organizationSlug" Decode.string
        |> Pipeline.required "subscriptionTier" Decode.string
        |> Pipeline.required "subscriptionStatus" Decode.string
        |> Pipeline.required "agentLimit" Decode.int
        |> Pipeline.required "contactLimit" Decode.int
        |> Pipeline.required "currentAgentCount" Decode.int
        |> Pipeline.required "currentContactCount" Decode.int
        |> Pipeline.optional "billingCycleEnd" (Decode.nullable Decode.string) Nothing
        |> Pipeline.required "paymentFailureCount" Decode.int


accountStatusResponseDecoder : Decoder AccountStatusResponse
accountStatusResponseDecoder =
    Decode.succeed AccountStatusResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.required "status" accountStatusDecoder


init : Flags -> Url.Url -> Nav.Key -> ( Model, Cmd Msg )
init flags url key =
    let
        initialSession =
            Unknown

        -- Parse the initial route to determine if we're on a public page
        initialRoute =
            Parser.parse routeParser url

        -- Determine if this is a public route that can be rendered immediately
        isPublicRoute =
            case initialRoute of
                Just (PublicRoute _) ->
                    True

                _ ->
                    False

        -- Set initial page appropriately
        initialPage =
            if isPublicRoute then
                -- For public routes, we'll immediately handle this in updatePageForcePublic below
                LoadingPage

            else
                -- For protected routes, we need to wait for session verification
                LoadingPage

        model =
            { key = key
            , url = url
            , page = initialPage
            , session = initialSession
            , currentUser = Nothing
            , isSetup = False
            , intendedDestination = Nothing
            , showDropdown = False
            , showStatusBanner = True
            }

        checkSession =
            Http.get
                { url = "/api/auth/session"
                , expect = Http.expectJson GotSession sessionDecoder
                }

        -- Use a very short timer for the initial direct page update for public routes
        directPageUpdate =
            Task.perform (\_ -> DirectPageUpdate) (Process.sleep 50)

        -- Check session and also immediately try to render public routes
        cmds =
            case initialSession of
                Verified _ ->
                    -- If we have a session, also fetch the current user immediately
                    Cmd.batch [ checkSession, fetchCurrentUser, directPageUpdate ]

                _ ->
                    Cmd.batch [ checkSession, directPageUpdate ]
    in
    -- For public routes, immediately try to render without waiting for session
    if isPublicRoute then
        -- Try to render public route immediately
        updatePageForcePublic url ( model, cmds )

    else
        -- For protected routes, wait for session verification
        ( model, cmds )


type alias CompareParams =
    { quoteId : Maybe String
    , orgId : Maybe String
    }


type alias CompareParamsPartial1 =
    { state : Maybe String
    , zip : Maybe String
    , county : Maybe String
    , gender : Maybe String
    }


type alias CompareParamsPartial2 =
    { tobacco : Bool
    , age : Maybe Int
    , planType : Maybe String
    , currentCarrier : Maybe String
    }


type Route
    = PublicRoute PublicPage
    | ProtectedRoute ProtectedPage
    | AdminRoute AdminPage
    | SetupRoute SetupPage
    | NotFound


type VerifyParams
    = VerifyParams String String


type PublicPage
    = HomeRoute
    | LoginRoute
    | SignupRoute
    | OnboardingRoute OnboardingStep
    | VerifyRoute VerifyParams
    | CompareRoute CompareParams
    | QuoteRoute { quoteId : Maybe String, trackingId : Maybe String, planType : Maybe String, orgId : Maybe String }
    | EligibilityRoute ( Maybe String, Maybe String, Maybe String ) -- Change from String to Maybe String
    | ScheduleRoute ( Maybe String, Maybe String, Maybe String )
    | SelfOnboardingRoute String
    | WaitlistRoute


type ProtectedPage
    = ContactsRoute
    | ProfileRoute
    | TempLandingRoute
    | ContactRoute String
    | DashboardRoute
    | ChangePlanRoute
    | WalkthroughRoute


type AdminPage
    = SettingsRoute
    | AgentsRoute


type SetupPage
    = ChoosePlanRoute (Maybe SetupProgress)
    | SetupSettingsRoute (Maybe SetupProgress)
    | AddAgentsRoute (Maybe SetupProgress)


type alias SetupProgress =
    { plan : Maybe String
    , orgSettings : Bool
    }


type RouteAccess
    = Public -- No auth needed (login, home)
    | Protected -- Requires valid session
    | Setup -- Special setup flow routes


setupProgressDecoder : Query.Parser (Maybe SetupProgress)
setupProgressDecoder =
    Query.map2
        (\plan org ->
            case ( plan, org ) of
                ( Just p, Just o ) ->
                    Just
                        { plan = Just p
                        , orgSettings = o == "complete"
                        }

                _ ->
                    Nothing
        )
        (Query.string "plan")
        (Query.string "org")


compareParamsParser : Query.Parser CompareParams
compareParamsParser =
    Query.map2 CompareParams
        (Query.string "id")
        (Query.string "orgId")



-- Parse the orgId


routeParser : Parser (Route -> a) a
routeParser =
    oneOf
        [ map (PublicRoute HomeRoute) top
        , map (PublicRoute WaitlistRoute) (s "waitlist")
        , map (PublicRoute LoginRoute) (s "login")
        , map (PublicRoute SignupRoute) (s "signup")
        , map (PublicRoute (OnboardingRoute PlanStep)) (s "onboarding" </> s "plan")
        , map (PublicRoute (OnboardingRoute PersonalStep)) (s "onboarding" </> s "personal")
        , map (PublicRoute (OnboardingRoute CompanyStep)) (s "onboarding" </> s "company")
        , map (PublicRoute (OnboardingRoute LicensingStep)) (s "onboarding" </> s "licensing")
        , map (PublicRoute (OnboardingRoute AgentsStep)) (s "onboarding" </> s "agents")
        , map (PublicRoute (OnboardingRoute PaymentStep)) (s "onboarding" </> s "payment")
        , map (PublicRoute (OnboardingRoute EnterpriseStep)) (s "onboarding" </> s "enterprise")
        , map (PublicRoute (OnboardingRoute PlanStep)) (s "onboarding") -- Default to plan step
        , map (\orgSlug token -> PublicRoute (VerifyRoute (VerifyParams orgSlug token)))
            (s "auth" </> s "verify" </> string </> string)
        , map (PublicRoute << CompareRoute) (s "compare" <?> compareParamsParser)
        , map (PublicRoute << QuoteRoute)
            (s "quote"
                <?> Query.map4
                        (\id tid planType orgId ->
                            { quoteId = id, trackingId = tid, planType = planType, orgId = orgId }
                        )
                        (Query.string "id")
                        (Query.string "tid")
                        (Query.string "planType")
                        (Query.string "orgId")
            )
        , map (PublicRoute << EligibilityRoute)
            (s "eligibility"
                <?> Query.map3
                        (\id tid orgId ->
                            ( id, tid, orgId )
                        )
                        (Query.string "id")
                        (Query.string "tid")
                        (Query.string "orgId")
            )
        , map (PublicRoute << ScheduleRoute)
            (s "schedule"
                <?> Query.map3 (\id status tid -> ( id, status, tid ))
                        (Query.string "id")
                        (Query.string "status")
                        (Query.string "tid")
            )
        , map (\orgSlug -> PublicRoute (SelfOnboardingRoute orgSlug))
            (s "self-onboarding" </> string)
        , map (ProtectedRoute ChangePlanRoute) (s "change-plan")
        , map (ProtectedRoute ContactsRoute) (s "contacts")
        , map (AdminRoute SettingsRoute) (s "settings")
        , map (ProtectedRoute ProfileRoute) (s "profile")
        , map (ProtectedRoute TempLandingRoute) (s "templanding")
        , map (ProtectedRoute WalkthroughRoute) (s "walkthrough")
        , map (AdminRoute AgentsRoute) (s "add-agents")
        , map (ProtectedRoute DashboardRoute) (s "dashboard")
        , map (\id -> ProtectedRoute (ContactRoute id)) (s "contact" </> string)
        , map (\progress -> SetupRoute (ChoosePlanRoute progress))
            (s "choose-plan" <?> setupProgressDecoder)
        , map (\progress -> SetupRoute (SetupSettingsRoute progress))
            (s "setup" </> s "settings" <?> setupProgressDecoder)
        , map (\progress -> SetupRoute (AddAgentsRoute progress))
            (s "setup" </> s "add-agents" <?> setupProgressDecoder)
        ]


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        DirectPageUpdate ->
            -- Force updatePage even if we're in Unknown session state
            updatePageForcePublic model.url ( model, Cmd.none )

        LinkClicked urlRequest ->
            case urlRequest of
                Browser.Internal url ->
                    ( model
                    , Nav.pushUrl model.key (Url.toString url)
                    )

                Browser.External href ->
                    ( model
                    , Nav.load href
                    )

        InternalLinkClicked frag ->
            ( { model | showDropdown = False }
            , Nav.pushUrl model.key frag
            )

        UrlChanged url ->
            ( { model | url = url }
            , Cmd.none
            )
                |> updatePage url

        LoginMsg subMsg ->
            case model.page of
                LoginPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Login.update subMsg pageModel
                    in
                    ( { model | page = LoginPage newPageModel }
                    , Cmd.map LoginMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ContactsMsg subMsg ->
            case model.page of
                ContactsPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Contacts.update subMsg pageModel
                    in
                    ( { model | page = ContactsPage newPageModel }
                    , Cmd.map ContactsMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        TempLandingMsg subMsg ->
            case model.page of
                TempLandingPage pageModel ->
                    case subMsg of
                        TempLanding.NavigateTo path ->
                            ( model
                            , Nav.pushUrl model.key path
                            )

                _ ->
                    ( model, Cmd.none )

        SettingsMsg subMsg ->
            case model.page of
                SettingsPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Settings.update subMsg pageModel
                    in
                    ( { model | page = SettingsPage newPageModel }
                    , Cmd.map SettingsMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        SignupMsg subMsg ->
            case model.page of
                Signup signupModel ->
                    let
                        ( newSignupModel, newCmd ) =
                            Signup.update subMsg signupModel
                    in
                    ( { model | page = Signup newSignupModel }
                    , Cmd.map SignupMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ChoosePlanMsg subMsg ->
            case model.page of
                ChoosePlanPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            ChoosePlan.update subMsg pageModel
                    in
                    ( { model | page = ChoosePlanPage newPageModel }
                    , Cmd.map ChoosePlanMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ChangePlanMsg subMsg ->
            case model.page of
                ChangePlanPage pageModel ->
                    let
                        ( updatedPageModel, updatedCmd ) =
                            ChangePlan.update subMsg pageModel
                    in
                    ( { model | page = ChangePlanPage updatedPageModel }
                    , Cmd.map ChangePlanMsg updatedCmd
                    )

                _ ->
                    ( model, Cmd.none )

        AddAgentsMsg subMsg ->
            case model.page of
                AddAgentsPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            AddAgent.update subMsg pageModel
                    in
                    ( { model | page = AddAgentsPage newPageModel }
                    , Cmd.map AddAgentsMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        GotVerification result ->
            case result of
                Ok response ->
                    if response.success then
                        let
                            ( choosePlanModel, choosePlanCmd ) =
                                ChoosePlan.init response.orgSlug response.session model.key False

                            -- Only set isSetup to True if we're being redirected to a setup route
                            isInSetup =
                                String.startsWith "/choose-plan" response.redirectUrl
                                    || String.startsWith "/setup" response.redirectUrl

                            newModel =
                                { model
                                    | session = Verified response.session
                                    , currentUser =
                                        Just
                                            { id = ""
                                            , email = response.email
                                            , isAdmin = False
                                            , isAgent = False
                                            , organizationSlug = response.orgSlug
                                            , organizationId = response.orgSlug
                                            , firstName = ""
                                            , lastName = ""
                                            , subscriptionTier = ""
                                            , accountStatus = Nothing
                                            }
                                    , isSetup = isInSetup
                                    , page = LoadingPage -- Force to loading page to prevent UI flicker during redirection
                                }
                        in
                        ( newModel
                        , Cmd.batch
                            [ -- Instead of direct navigation, use a message to redirect
                              case model.intendedDestination of
                                Just destination ->
                                    Task.perform PerformRedirect (Task.succeed destination)

                                Nothing ->
                                    Task.perform PerformRedirect (Task.succeed response.redirectUrl)
                            , fetchCurrentUser
                            ]
                        )

                    else
                        ( model, Nav.pushUrl model.key "/login" )

                Err error ->
                    ( model, Nav.pushUrl model.key "/login" )

        PerformRedirect url ->
            -- Navigate to the specified URL
            ( model, Nav.pushUrl model.key url )

        GotSession result ->
            case result of
                Ok response ->
                    if response.valid then
                        let
                            user =
                                { id = response.id
                                , email = response.email
                                , isAdmin = False -- We'll get this from /api/me endpoint
                                , isAgent = False -- We'll get this from /api/me endpoint
                                , organizationSlug = response.organizationSlug
                                , organizationId = response.organizationSlug -- Use the org slug as org ID for now
                                , firstName = response.firstName
                                , lastName = response.lastName
                                , subscriptionTier = ""
                                , accountStatus = Nothing
                                }

                            -- Only set isSetup to True if we're in the middle of setup
                            isInSetup =
                                case Parser.parse routeParser model.url of
                                    Just (SetupRoute _) ->
                                        True

                                    _ ->
                                        False

                            newModel =
                                { model
                                    | session = Verified response.session
                                    , currentUser = Just user
                                    , isSetup = isInSetup
                                }
                        in
                        Cmd.batch [ fetchCurrentUser, updatePage model.url ( newModel, Cmd.none ) |> Tuple.second ]
                            |> (\cmd -> ( newModel, cmd ))

                    else
                        let
                            newModel =
                                { model | session = NoSession }
                        in
                        -- For invalid session, update page which will handle redirects
                        updatePage model.url ( newModel, Cmd.none )

                Err error ->
                    let
                        newModel =
                            { model | session = NoSession }
                    in
                    -- For session error, update page which will handle redirects
                    updatePage model.url ( newModel, Cmd.none )

        ProfileMsg subMsg ->
            case model.page of
                ProfilePage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Profile.update subMsg pageModel
                    in
                    ( { model | page = ProfilePage newPageModel }
                    , case subMsg of
                        Profile.NavigateTo path ->
                            Nav.pushUrl model.key path

                        _ ->
                            Cmd.map ProfileMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        HomeMsg subMsg ->
            case model.page of
                HomePage pageModel ->
                    let
                        ( newPageModel, homeCmd ) =
                            Home.update subMsg pageModel
                    in
                    ( { model | page = HomePage newPageModel }
                    , Cmd.map HomeMsg homeCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ContactMsg subMsg ->
            case model.page of
                ContactPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Contact.update subMsg pageModel
                    in
                    ( { model | page = ContactPage newPageModel }
                    , Cmd.map ContactMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        CompareMsg subMsg ->
            case model.page of
                ComparePage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Compare.update subMsg pageModel
                    in
                    ( { model | page = ComparePage newPageModel }
                    , Cmd.map CompareMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        QuoteMsg subMsg ->
            case model.page of
                QuotePage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Quote.update subMsg pageModel
                    in
                    ( { model | page = QuotePage newPageModel }
                    , Cmd.map QuoteMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        EligibilityMsg subMsg ->
            case model.page of
                EligibilityPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Eligibility.update subMsg pageModel
                    in
                    ( { model | page = EligibilityPage newPageModel }
                    , Cmd.map EligibilityMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ScheduleMsg subMsg ->
            case model.page of
                SchedulePage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Schedule.update subMsg pageModel
                    in
                    ( { model | page = SchedulePage newPageModel }
                    , Cmd.map ScheduleMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        DashboardMsg subMsg ->
            case model.page of
                DashboardPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Dashboard.update subMsg pageModel
                    in
                    ( { model | page = DashboardPage newPageModel }
                    , Cmd.map DashboardMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        WaitlistMsg subMsg ->
            case model.page of
                WaitlistPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Waitlist.update subMsg pageModel
                    in
                    ( { model | page = WaitlistPage newPageModel }
                    , Cmd.map WaitlistMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        GotCurrentUser result ->
            case result of
                Ok response ->
                    case response.user of
                        Just user ->
                            let
                                currentUser =
                                    Just
                                        { id = user.id
                                        , email = user.email
                                        , isAdmin = user.isAdmin
                                        , isAgent = user.isAgent
                                        , organizationSlug = user.organizationSlug
                                        , organizationId = user.organizationId
                                        , firstName = user.firstName
                                        , lastName = user.lastName
                                        , subscriptionTier = user.subscriptionTier
                                        , accountStatus = Nothing -- Will fetch this separately
                                        }

                                newModel =
                                    { model | currentUser = currentUser }

                                -- Fetch account status after user is loaded
                                cmd =
                                    fetchAccountStatus user.organizationSlug
                            in
                            -- Check if we were already on the right page with the right data
                            -- Only update the page if something meaningful has changed
                            case model.currentUser of
                                Just existingUser ->
                                    if existingUser.id == user.id && existingUser.organizationSlug == user.organizationSlug then
                                        -- We already have the same user, just update the model without triggering updatePage
                                        ( newModel, cmd )

                                    else
                                        -- User has changed, update the page
                                        updatePage model.url ( newModel, cmd )

                                Nothing ->
                                    -- We didn't have a user before, update the page
                                    updatePage model.url ( newModel, cmd )

                        Nothing ->
                            -- No user data, but we should still update the page to avoid being stuck
                            updatePage model.url ( model, Cmd.none )

                Err error ->
                    -- Error retrieving user data, but we should still update the page to avoid being stuck
                    updatePage model.url ( model, Cmd.none )

        GotAccountStatus result ->
            case result of
                Ok response ->
                    if response.success then
                        -- Update user with account status
                        let
                            updatedUser =
                                model.currentUser
                                    |> Maybe.map
                                        (\user ->
                                            { user | accountStatus = Just response.status }
                                        )

                            updatedModel =
                                { model | currentUser = updatedUser }
                        in
                        -- Now that we have all data (session, user, account status), update the page
                        updatePage model.url ( updatedModel, Cmd.none )

                    else
                        ( model, Cmd.none )

                Err _ ->
                    -- Even if there's an error getting account status, we should still update the page
                    -- rather than staying on the loading screen
                    updatePage model.url ( model, Cmd.none )

        CloseStatusBanner ->
            ( { model | showStatusBanner = False }
            , Cmd.none
            )

        OrgFinalized result ->
            case result of
                Ok _ ->
                    ( model, Cmd.none )

                -- Navigation already happened
                Err _ ->
                    ( { model | page = LoadingPage }
                    , Nav.pushUrl model.key "/settings"
                      -- Redirect to settings on error
                    )

        LogoutMsg subMsg ->
            case model.page of
                LogoutPage logoutModel ->
                    let
                        ( newLogoutModel, logoutCmd ) =
                            Logout.update subMsg logoutModel
                    in
                    ( { model | page = LogoutPage newLogoutModel }
                    , Cmd.map LogoutMsg logoutCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ToggleDropdown ->
            ( { model | showDropdown = not model.showDropdown }
            , Cmd.none
            )

        CloseDropdown ->
            ( { model | showDropdown = False }
            , Cmd.none
            )

        InitiateLogout ->
            ( { model
                | session = NoSession
                , currentUser = Nothing
                , showDropdown = False
              }
            , Cmd.batch
                [ Nav.pushUrl model.key "/"
                , Http.post
                    { url = "/api/auth/logout"
                    , body = Http.emptyBody
                    , expect = Http.expectWhatever (\_ -> NoOp)
                    }
                ]
            )

        NoOp ->
            ( model, Cmd.none )

        OnboardingMsg subMsg ->
            case model.page of
                OnboardingPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Onboarding.update subMsg pageModel
                    in
                    ( { model | page = OnboardingPage newPageModel }
                    , Cmd.map OnboardingMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        WalkthroughMsg subMsg ->
            case model.page of
                WalkthroughPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            Walkthrough.update subMsg pageModel
                    in
                    ( { model | page = WalkthroughPage newPageModel }
                    , Cmd.map WalkthroughMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        SelfOnboardingMsg subMsg ->
            case model.page of
                SelfOnboardingPage pageModel ->
                    let
                        ( newPageModel, newCmd ) =
                            SelfServiceOnboarding.update subMsg pageModel
                    in
                    ( { model | page = SelfOnboardingPage newPageModel }
                    , Cmd.map SelfOnboardingMsg newCmd
                    )

                _ ->
                    ( model, Cmd.none )

        ShowDropdown ->
            ( { model | showDropdown = True }, Cmd.none )

        HideDropdown ->
            ( { model | showDropdown = False }, Cmd.none )

        ToggleStatusBanner ->
            ( { model | showStatusBanner = not model.showStatusBanner }, Cmd.none )


view : Model -> Browser.Document Msg
view model =
    let
        viewPage =
            case model.page of
                NotFoundPage ->
                    viewNotFound

                WaitlistPage waitlistModel ->
                    let
                        waitlistView =
                            Waitlist.view waitlistModel
                    in
                    { title = waitlistView.title
                    , body = [ viewWithNav model (Html.map WaitlistMsg (div [] waitlistView.body)) ]
                    }

                LoginPage loginModel ->
                    let
                        loginView =
                            Login.view loginModel
                    in
                    { title = loginView.title
                    , body = List.map (Html.map LoginMsg) loginView.body
                    }

                ContactsPage contactsModel ->
                    { title = "Contacts"
                    , body = [ viewWithNav model (Html.map ContactsMsg (Contacts.view contactsModel)) ]
                    }

                TempLandingPage landingModel ->
                    let
                        landingView =
                            TempLanding.view landingModel
                    in
                    { title = landingView.title
                    , body = [ viewWithNav model (Html.map TempLandingMsg (div [] landingView.body)) ]
                    }

                SettingsPage settingsModel ->
                    let
                        settingsView =
                            Settings.view settingsModel
                    in
                    { title = settingsView.title
                    , body = [ viewWithNav model (Html.map SettingsMsg (div [] settingsView.body)) ]
                    }

                Signup signupModel ->
                    let
                        signupView =
                            Signup.view signupModel
                    in
                    { title = signupView.title
                    , body = [ viewWithNav model (Html.map SignupMsg (div [] signupView.body)) ]
                    }

                ChoosePlanPage choosePlanModel ->
                    let
                        choosePlanView =
                            ChoosePlan.view choosePlanModel
                    in
                    { title = choosePlanView.title
                    , body = [ viewWithNav model (Html.map ChoosePlanMsg (div [] choosePlanView.body)) ]
                    }

                ChangePlanPage changePlanModel ->
                    let
                        changePlanView =
                            ChangePlan.view changePlanModel
                    in
                    { title = changePlanView.title
                    , body = [ viewWithNav model (Html.map ChangePlanMsg (div [] changePlanView.body)) ]
                    }

                AddAgentsPage addAgentModel ->
                    let
                        addAgentView =
                            AddAgent.view addAgentModel
                    in
                    { title = addAgentView.title
                    , body =
                        if addAgentModel.isSetup then
                            -- In setup flow, don't show the header
                            [ Html.map AddAgentsMsg (div [] addAgentView.body) ]

                        else
                            -- Not in setup flow, show the header
                            [ viewWithNav model (Html.map AddAgentsMsg (div [] addAgentView.body)) ]
                    }

                ProfilePage profileModel ->
                    let
                        profileView =
                            Profile.view profileModel
                    in
                    { title = profileView.title
                    , body = [ viewWithNav model (Html.map ProfileMsg (div [] profileView.body)) ]
                    }

                LoadingPage ->
                    { title = "Loading..."
                    , body = [ viewLoading ]
                    }

                HomePage homeModel ->
                    let
                        homeView =
                            Home.view homeModel
                    in
                    { title = homeView.title
                    , body = List.map (Html.map HomeMsg) homeView.body
                    }

                ContactPage contactModel ->
                    let
                        contactView =
                            Contact.view contactModel
                    in
                    { title = contactView.title
                    , body = [ viewWithNav model (Html.map ContactMsg (div [] contactView.body)) ]
                    }

                ComparePage compareModel ->
                    let
                        compareView =
                            Compare.view compareModel
                    in
                    { title = compareView.title
                    , body = [ viewWithNav model (Html.map CompareMsg (div [] compareView.body)) ]
                    }

                QuotePage quoteModel ->
                    let
                        quoteView =
                            Quote.view quoteModel
                    in
                    { title = quoteView.title
                    , body = [ viewWithNav model (Html.map QuoteMsg (div [] quoteView.body)) ]
                    }

                EligibilityPage eligibilityModel ->
                    let
                        eligibilityView =
                            Eligibility.view eligibilityModel
                    in
                    { title = eligibilityView.title
                    , body = [ viewWithNav model (Html.map EligibilityMsg (div [] eligibilityView.body)) ]
                    }

                SchedulePage scheduleModel ->
                    let
                        scheduleView =
                            Schedule.view scheduleModel
                    in
                    { title = scheduleView.title
                    , body = [ viewWithNav model (Html.map ScheduleMsg (div [] scheduleView.body)) ]
                    }

                DashboardPage dashboardModel ->
                    let
                        dashboardView =
                            Dashboard.view dashboardModel
                    in
                    { title = dashboardView.title
                    , body = [ viewWithNav model (Html.map DashboardMsg (div [] dashboardView.body)) ]
                    }

                LogoutPage logoutModel ->
                    let
                        logoutView =
                            Logout.view logoutModel
                    in
                    { title = logoutView.title
                    , body = List.map (Html.map LogoutMsg) logoutView.body
                    }

                OnboardingPage pageModel ->
                    let
                        onboardingView =
                            Onboarding.view pageModel
                    in
                    { title = onboardingView.title
                    , body = [ Html.map OnboardingMsg (div [] onboardingView.body) ]
                    }

                WalkthroughPage pageModel ->
                    let
                        walkthroughView =
                            Walkthrough.view pageModel
                    in
                    { title = walkthroughView.title
                    , body = [ viewWithNav model (Html.map WalkthroughMsg (div [] walkthroughView.body)) ]
                    }

                SelfOnboardingPage pageModel ->
                    let
                        selfOnboardingView =
                            SelfServiceOnboarding.view pageModel
                    in
                    { title = selfOnboardingView.title
                    , body = [ viewWithNav model (Html.map SelfOnboardingMsg (div [] selfOnboardingView.body)) ]
                    }
    in
    viewPage


viewWithNav : Model -> Html Msg -> Html Msg
viewWithNav model content =
    div []
        [ if model.isSetup then
            -- Don't show header during setup flow
            content

          else
            -- Show header for regular pages
            div []
                [ viewNavHeader model
                , content
                ]
        ]


viewNavHeader : Model -> Html Msg
viewNavHeader model =
    let
        -- Check if current page is one of the quote flow pages that should have simplified header
        isQuoteFlowPage =
            case model.page of
                QuotePage _ ->
                    True

                ComparePage _ ->
                    True

                EligibilityPage _ ->
                    True

                SchedulePage _ ->
                    True

                SelfOnboardingPage _ ->
                    True

                WaitlistPage _ ->
                    -- not quote flow, but should have simplified header
                    True

                _ ->
                    False
    in
    if isQuoteFlowPage then
        text ""
        {--
        -- Simplified header with just the logo for quote flow pages
        nav [ class "bg-white border-b border-gray-200" ]
            [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" ]
                [ div [ class "flex justify-center h-14 sm:h-16" ]
                    [ div [ class "shrink-0 flex items-center" ]
                        [ img
                            [ src "/images/medicare-max-logo.png"
                            , class "h-6 sm:h-6 w-auto"
                            , alt "Medicare Max logo"
                            ]
                            []
                        ]
                    ]
                ]
            ]
        --}

    else
        -- Full header with navigation for other pages
        nav [ class "bg-white border-b border-gray-200" ]
            [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8" ]
                [ div [ class "flex justify-between h-16" ]
                    [ div [ class "flex items-center" ]
                        [ div [ class "shrink-0 flex items-center" ]
                            [ a
                                [ href "#"
                                , onClick (InternalLinkClicked "/")
                                , class "cursor-pointer"
                                ]
                                [ img
                                    [ src "/images/medicare-max-logo.png"
                                    , class "h-6 sm:h-6 w-auto mr-2 sm:mr-8"
                                    , alt "Medicare Max logo"
                                    ]
                                    []
                                ]
                            ]
                        , div [ class "hidden sm:flex items-center space-x-4" ]
                            [ button
                                [ class "px-3 py-1.5 text-gray-700 text-sm font-medium hover:bg-[#DCE2E5] rounded-md transition-colors duration-200"
                                , onClick (InternalLinkClicked "/dashboard")
                                ]
                                [ text "Dashboard" ]
                            , button
                                [ class "px-3 py-1.5 text-gray-700 text-sm font-medium hover:bg-[#DCE2E5] rounded-md transition-colors duration-200"
                                , onClick (InternalLinkClicked "/contacts")
                                ]
                                [ text "Contacts" ]
                            ]
                        ]
                    , div [ class "flex items-center" ]
                        [ div [ class "relative" ]
                            [ button
                                [ class "flex items-center space-x-1 sm:space-x-2 px-2 sm:px-3 py-1.5 text-gray-700 text-xs sm:text-sm font-medium hover:bg-[#DCE2E5] rounded-md transition-colors duration-200"
                                , onClick ToggleDropdown
                                , stopPropagationOn "mousedown" (Decode.succeed ( NoOp, True ))
                                ]
                                [ case model.currentUser of
                                    Just user ->
                                        text (user.firstName ++ " " ++ user.lastName)

                                    Nothing ->
                                        text "Menu"
                                , div [ class "w-4 h-4 flex-shrink-0" ]
                                    [ svg
                                        [ Svg.Attributes.viewBox "0 0 20 20"
                                        , Svg.Attributes.fill "currentColor"
                                        ]
                                        [ path
                                            [ Svg.Attributes.d "M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" ]
                                            []
                                        ]
                                    ]
                                ]
                            , if model.showDropdown then
                                div
                                    [ class "absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 z-50"
                                    , stopPropagationOn "mousedown" (Decode.succeed ( NoOp, True ))
                                    ]
                                    [ -- Always show on mobile
                                      div [ class "block sm:hidden" ]
                                        [ button
                                            [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                            , onClick (InternalLinkClicked "/dashboard")
                                            ]
                                            [ text "Dashboard" ]
                                        , button
                                            [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                            , onClick (InternalLinkClicked "/contacts")
                                            ]
                                            [ text "Contacts" ]
                                        ]
                                    , if isAdmin model.currentUser then
                                        button
                                            [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                            , onClick (InternalLinkClicked "/profile")
                                            ]
                                            [ text "Profile" ]

                                      else
                                        text ""
                                    , if isAdmin model.currentUser then
                                        button
                                            [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                            , onClick (InternalLinkClicked "/settings")
                                            ]
                                            [ text "Organization Settings" ]

                                      else
                                        text ""
                                    , if isAdmin model.currentUser then
                                        button
                                            [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                            , onClick (InternalLinkClicked "/add-agents")
                                            ]
                                            [ text "Agents" ]

                                      else
                                        text ""
                                    , button
                                        [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                        , onClick (InternalLinkClicked "/change-plan")
                                        ]
                                        [ text "Change Plan" ]
                                    , button
                                        [ class "block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-[#DCE2E5]"
                                        , onClick InitiateLogout
                                        ]
                                        [ text "Log out" ]
                                    ]

                              else
                                text ""
                            ]
                        ]
                    ]
                ]
            ]


isAdminOrAdminAgent : Maybe User -> Bool
isAdminOrAdminAgent maybeUser =
    case maybeUser of
        Just user ->
            user.isAdmin && user.isAgent

        Nothing ->
            False


isAdmin : Maybe User -> Bool
isAdmin maybeUser =
    case maybeUser of
        Just user ->
            user.isAdmin

        Nothing ->
            False


viewNotFound : Browser.Document msg
viewNotFound =
    { title = "404 - Page Not Found"
    , body =
        [ div [ class "min-h-screen bg-gray-50 flex flex-col items-center justify-center" ]
            [ h1 [ class "text-4xl font-bold text-gray-900 mb-4" ]
                [ text "404 - Page Not Found" ]
            , p [ class "text-gray-600" ]
                [ text "The page you're looking for doesn't exist." ]
            ]
        ]
    }


viewLoading : Html msg
viewLoading =
    div [ class "min-h-screen bg-gray-50 flex items-center justify-center" ]
        [ div [ class "animate-spin rounded-full h-8 w-8 border-2 border-purple-500 border-t-transparent" ] []
        ]


subscriptions : Model -> Sub Msg
subscriptions model =
    let
        dropdownSub =
            if model.showDropdown then
                Browser.Events.onMouseDown (Decode.succeed CloseDropdown)

            else
                Sub.none

        pageSubs =
            case model.page of
                LoadingPage ->
                    Sub.none

                WaitlistPage pageModel ->
                    Sub.map WaitlistMsg (Waitlist.subscriptions pageModel)

                LoginPage pageModel ->
                    Sub.map LoginMsg (Login.subscriptions pageModel)

                ContactsPage pageModel ->
                    Sub.map ContactsMsg (Contacts.subscriptions pageModel)

                TempLandingPage pageModel ->
                    Sub.map TempLandingMsg (TempLanding.subscriptions pageModel)

                SettingsPage pageModel ->
                    Sub.map SettingsMsg (Settings.subscriptions pageModel)

                Signup signupModel ->
                    Sub.map SignupMsg (Signup.subscriptions signupModel)

                ChoosePlanPage pageModel ->
                    Sub.map ChoosePlanMsg (ChoosePlan.subscriptions pageModel)

                ChangePlanPage pageModel ->
                    Sub.map ChangePlanMsg (ChangePlan.subscriptions pageModel)

                AddAgentsPage pageModel ->
                    Sub.map AddAgentsMsg (AddAgent.subscriptions pageModel)

                ProfilePage pageModel ->
                    Sub.map ProfileMsg (Profile.subscriptions pageModel)

                HomePage pageModel ->
                    Sub.map HomeMsg (Home.subscriptions pageModel)

                ContactPage pageModel ->
                    Sub.map ContactMsg (Contact.subscriptions pageModel)

                ComparePage pageModel ->
                    Sub.map CompareMsg (Compare.subscriptions pageModel)

                QuotePage pageModel ->
                    Sub.map QuoteMsg (Quote.subscriptions pageModel)

                EligibilityPage pageModel ->
                    Sub.map EligibilityMsg (Eligibility.subscriptions pageModel)

                SchedulePage pageModel ->
                    Sub.map ScheduleMsg (Schedule.subscriptions pageModel)

                DashboardPage pageModel ->
                    Sub.map DashboardMsg (Dashboard.subscriptions pageModel)

                NotFoundPage ->
                    Sub.none

                LogoutPage pageModel ->
                    Sub.map LogoutMsg (Logout.subscriptions pageModel)

                OnboardingPage pageModel ->
                    Sub.map OnboardingMsg (Onboarding.subscriptions pageModel)

                WalkthroughPage pageModel ->
                    Sub.map WalkthroughMsg (Walkthrough.subscriptions pageModel)

                SelfOnboardingPage _ ->
                    Sub.none
    in
    Sub.batch [ dropdownSub, pageSubs ]


routeAccessType : Route -> RouteAccess
routeAccessType route =
    case route of
        PublicRoute _ ->
            Public

        ProtectedRoute _ ->
            Protected

        AdminRoute _ ->
            Protected

        -- Still Protected, but we'll check admin status separately
        SetupRoute _ ->
            Setup

        NotFound ->
            Public


userDecoder : Decoder User
userDecoder =
    Decode.succeed User
        |> Pipeline.required "id" (Decode.map String.fromInt Decode.int)
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "is_admin"
            (Decode.oneOf
                [ Decode.bool
                , Decode.int |> Decode.map (\n -> n == 1)
                ]
            )
        |> Pipeline.required "is_agent"
            (Decode.oneOf
                [ Decode.bool
                , Decode.int |> Decode.map (\n -> n == 1)
                ]
            )
        |> Pipeline.required "organization_slug" Decode.string
        |> Pipeline.required "organization_id" (Decode.map String.fromInt Decode.int)
        |> Pipeline.required "firstName" Decode.string
        |> Pipeline.required "lastName" Decode.string
        |> Pipeline.required "subscription_tier" Decode.string
        |> Pipeline.optional "accountStatus" (Decode.nullable accountStatusDecoder) Nothing


type SetupStep
    = NotStarted
    | PlanSelection
    | OrganizationSetup
    | AgentSetup
    | Complete


getSetupStep : Model -> SetupStep
getSetupStep model =
    case model.currentUser of
        Nothing ->
            NotStarted

        Just user ->
            if not model.isSetup then
                PlanSelection

            else if not (hasOrganizationSettings user) then
                OrganizationSetup

            else if not (hasAgents user) then
                AgentSetup

            else
                Complete


hasOrganizationSettings : User -> Bool
hasOrganizationSettings user =
    -- Check if both organization and brand settings are configured
    case user.organizationSlug of
        "" ->
            False

        _ ->
            -- For now return True since we've merged brand settings into org settings
            -- TODO: Add actual check for required settings once API is updated
            True


hasAgents : User -> Bool
hasAgents user =
    -- TODO: Add actual check for agents
    True


redirectToSetupStep : Model -> ( Model, Cmd Msg )
redirectToSetupStep model =
    case getSetupStep model of
        NotStarted ->
            ( model, Nav.pushUrl model.key "/login" )

        PlanSelection ->
            ( model, Nav.pushUrl model.key "/choose-plan" )

        OrganizationSetup ->
            case model.currentUser of
                Just user ->
                    ( model
                    , Nav.pushUrl model.key
                        ("/setup/settings?plan=" ++ user.organizationSlug)
                    )

                Nothing ->
                    ( model, Nav.pushUrl model.key "/setup/settings" )

        AgentSetup ->
            case model.currentUser of
                Just user ->
                    ( model
                    , Nav.pushUrl model.key
                        ("/setup/add-agents?plan=" ++ user.organizationSlug ++ "&org=complete")
                    )

                Nothing ->
                    ( model, Nav.pushUrl model.key "/setup/add-agents" )

        Complete ->
            ( model, Nav.pushUrl model.key "/contacts" )


shouldRedirectAdminRoute : Route -> Model -> Maybe String
shouldRedirectAdminRoute route model =
    case route of
        AdminRoute _ ->
            case model.currentUser of
                Just user ->
                    if user.isAdmin then
                        Nothing
                        -- Admin user, no redirect needed

                    else
                        Just "/contacts"

                -- Non-admin user, redirect to contacts
                Nothing ->
                    Just "/login"

        -- Not logged in, redirect to login
        _ ->
            Nothing


shouldRedirectToLogin : Route -> Model -> Bool
shouldRedirectToLogin route model =
    let
        result =
            case route of
                PublicRoute _ ->
                    False

                NotFound ->
                    False

                AdminRoute _ ->
                    case model.session of
                        Verified _ ->
                            False

                        _ ->
                            True

                _ ->
                    case model.session of
                        Verified _ ->
                            False

                        _ ->
                            True
    in
    -- Add a debug log for the redirect check
    result


shouldRedirectToSetup : Route -> Model -> Bool
shouldRedirectToSetup route model =
    -- Only check setup state if we're in setup mode
    if model.isSetup then
        case route of
            SetupRoute _ ->
                -- Already in a setup route, no redirect needed
                False

            PublicRoute _ ->
                -- Public routes are always accessible
                False

            NotFound ->
                -- Not found routes don't redirect
                False

            AdminRoute _ ->
                -- Admin routes redirect if setup is not complete
                getSetupStep model /= Complete

            ProtectedRoute _ ->
                -- Protected routes redirect if setup is not complete
                getSetupStep model /= Complete

    else
        False


updatePage : Url -> ( Model, Cmd Msg ) -> ( Model, Cmd Msg )
updatePage url ( model, cmd ) =
    case model.session of
        Unknown ->
            -- When session state is Unknown, still allow public routes to render
            case Parser.parse routeParser url of
                Just route ->
                    case routeAccessType route of
                        Public ->
                            -- For public routes, redirect to the force update function
                            updatePageForcePublic url ( model, cmd )

                        _ ->
                            -- For non-public routes, keep showing loading while we wait
                            ( { model | page = LoadingPage }
                            , cmd
                            )

                Nothing ->
                    ( { model | page = NotFoundPage }
                    , cmd
                    )

        -- Rest of the function remains the same for Verified and NoSession states
        _ ->
            case Parser.parse routeParser url of
                Just route ->
                    let
                        -- Update isSetup based on the route
                        modelWithUpdatedSetup =
                            updateIsSetup model route

                        adminRedirect =
                            shouldRedirectAdminRoute route modelWithUpdatedSetup

                        -- Determine if we should make authenticated requests based on session state
                        -- Only fetch user data if we have a verified session AND don't already have user info
                        authCmd =
                            case ( model.session, model.currentUser ) of
                                ( Verified _, Nothing ) ->
                                    -- Only fetch user data if we have a verified session but no user data
                                    fetchCurrentUser

                                _ ->
                                    -- Don't make authenticated requests if no session or already have user data
                                    Cmd.none
                    in
                    case adminRedirect of
                        Just redirectUrl ->
                            ( modelWithUpdatedSetup, Nav.pushUrl modelWithUpdatedSetup.key redirectUrl )

                        Nothing ->
                            let
                                needsLogin =
                                    shouldRedirectToLogin route modelWithUpdatedSetup

                                needsSetup =
                                    shouldRedirectToSetup route modelWithUpdatedSetup
                            in
                            if needsLogin then
                                ( { modelWithUpdatedSetup
                                    | intendedDestination = Just (Url.toString url)
                                    , page = LoginPage (Login.init modelWithUpdatedSetup.key False url |> Tuple.first)
                                  }
                                , if String.contains "/login" (Url.toString url) then
                                    -- Already on login page, don't redirect
                                    Cmd.none

                                  else
                                    Nav.pushUrl modelWithUpdatedSetup.key "/login"
                                )

                            else if needsSetup then
                                -- Check if we're already on a setup route to prevent redirect loops
                                case route of
                                    SetupRoute _ ->
                                        -- Already on a setup route, just update the page
                                        ( modelWithUpdatedSetup, authCmd )

                                    _ ->
                                        redirectToSetupStep modelWithUpdatedSetup

                            else
                                -- Continue with the original logic for handling different routes
                                -- Rest of the function remains the same
                                case route of
                                    PublicRoute HomeRoute ->
                                        -- Home page handles its own session checking
                                        let
                                            ( homeModel, homeCmd ) =
                                                Home.init modelWithUpdatedSetup.key
                                        in
                                        ( { modelWithUpdatedSetup | page = HomePage homeModel }
                                        , Cmd.map HomeMsg homeCmd
                                        )

                                    PublicRoute WaitlistRoute ->
                                        let
                                            ( waitlistModel, waitlistCmd ) =
                                                Waitlist.init
                                        in
                                        ( { modelWithUpdatedSetup | page = WaitlistPage waitlistModel }
                                        , Cmd.map WaitlistMsg waitlistCmd
                                        )

                                    PublicRoute LoginRoute ->
                                        let
                                            ( loginModel, loginCmd ) =
                                                Login.init modelWithUpdatedSetup.key False url
                                        in
                                        ( { modelWithUpdatedSetup | page = LoginPage loginModel }
                                        , Cmd.map LoginMsg loginCmd
                                        )

                                    PublicRoute SignupRoute ->
                                        -- Initialize signup page without making authenticated API calls
                                        let
                                            ( signupModel, signupCmd ) =
                                                Signup.init modelWithUpdatedSetup.key
                                        in
                                        ( { modelWithUpdatedSetup | page = Signup signupModel }
                                        , Cmd.map SignupMsg signupCmd
                                        )

                                    PublicRoute (OnboardingRoute step) ->
                                        -- Check if we already have an onboarding page
                                        case model.page of
                                            OnboardingPage existingModel ->
                                                -- We already have an onboarding model, update the step and reset initialization flags
                                                let
                                                    newStep =
                                                        onboardingStepToStep step

                                                    updatedModel =
                                                        { existingModel
                                                            | step = newStep

                                                            -- Reset initialization flags based on the new step
                                                            , userDetailsInitialized =
                                                                if newStep == Onboarding.UserDetailsStep then
                                                                    False

                                                                else
                                                                    existingModel.userDetailsInitialized
                                                            , companyDetailsInitialized =
                                                                if newStep == Onboarding.CompanyDetailsStep then
                                                                    False

                                                                else
                                                                    existingModel.companyDetailsInitialized
                                                            , licensingSettingsInitialized =
                                                                if newStep == Onboarding.LicensingSettingsStep then
                                                                    False

                                                                else
                                                                    existingModel.licensingSettingsInitialized
                                                            , addAgentsInitialized =
                                                                if newStep == Onboarding.AddAgentsStep then
                                                                    False

                                                                else
                                                                    existingModel.addAgentsInitialized
                                                            , paymentInitialized =
                                                                if newStep == Onboarding.PaymentStep then
                                                                    False

                                                                else
                                                                    existingModel.paymentInitialized
                                                            , enterpriseFormInitialized =
                                                                if newStep == Onboarding.EnterpriseFormStep then
                                                                    False

                                                                else
                                                                    existingModel.enterpriseFormInitialized
                                                        }
                                                in
                                                ( { model | page = OnboardingPage updatedModel }
                                                , Cmd.map OnboardingMsg (Task.perform (\_ -> Onboarding.InitializeCurrentStep) (Task.succeed ()))
                                                )

                                            _ ->
                                                -- Initialize onboarding without authenticated calls for new users
                                                let
                                                    ( onboardingModel, onboardingCmd ) =
                                                        Onboarding.init
                                                            model.key
                                                            (model.currentUser
                                                                |> Maybe.map .organizationSlug
                                                                |> Maybe.withDefault ""
                                                            )
                                                            (extractSession model.session)
                                                            (onboardingStepToStep step)
                                                in
                                                ( { model | page = OnboardingPage onboardingModel }
                                                , Cmd.map OnboardingMsg onboardingCmd
                                                )

                                    PublicRoute (VerifyRoute params) ->
                                        -- For verification, we need to make an API call
                                        let
                                            verifyUrl =
                                                case params of
                                                    VerifyParams orgSlug token ->
                                                        "/api/auth/verify/" ++ orgSlug ++ "/" ++ token

                                            verifyCmd =
                                                Http.get
                                                    { url = verifyUrl
                                                    , expect = Http.expectJson GotVerification verificationDecoder
                                                    }
                                        in
                                        ( model, verifyCmd )

                                    PublicRoute (CompareRoute params) ->
                                        case params.quoteId of
                                            Just quoteId ->
                                                -- We have a quote ID, which is what we prefer
                                                let
                                                    ( compareModel, compareCmd ) =
                                                        Compare.init model.key (Just params)
                                                in
                                                ( { model | page = ComparePage compareModel }
                                                , Cmd.map CompareMsg compareCmd
                                                )

                                            Nothing ->
                                                -- No quote ID, check if we have a valid orgId
                                                if isValidOrgId params.orgId then
                                                    -- We have a valid orgId but no quoteId, so use the params
                                                    let
                                                        ( compareModel, compareCmd ) =
                                                            Compare.init model.key (Just params)
                                                    in
                                                    ( { model | page = ComparePage compareModel }
                                                    , Cmd.map CompareMsg compareCmd
                                                    )

                                                else
                                                    -- No valid orgId either, redirect to 404
                                                    ( { model | page = NotFoundPage }
                                                    , Nav.pushUrl model.key "/404"
                                                    )

                                    PublicRoute (QuoteRoute params) ->
                                        -- First check if there's a valid quoteId
                                        if isValidQuoteId params.quoteId then
                                            let
                                                initialValues =
                                                    { zipCode = Nothing
                                                    , dateOfBirth = Nothing
                                                    , tobacco = Nothing
                                                    , gender = Nothing
                                                    , quoteId = params.quoteId
                                                    , planType = params.planType
                                                    , orgId = params.orgId -- Pass orgId even if it's Nothing
                                                    }

                                                ( quoteModel, quoteCmd ) =
                                                    Quote.init model.key initialValues
                                            in
                                            ( { model | page = QuotePage quoteModel }
                                            , Cmd.map QuoteMsg quoteCmd
                                            )
                                            -- If there's no valid quoteId, show error

                                        else
                                            -- Redirect to an error page or show an error
                                            ( { model | page = NotFoundPage }
                                            , Nav.pushUrl model.key "/error?message=Missing%20or%20invalid%20quote%20ID"
                                            )

                                    PublicRoute (EligibilityRoute params) ->
                                        let
                                            ( quoteId, _, orgIdStr ) =
                                                params
                                        in
                                        if isValidOrgId orgIdStr then
                                            let
                                                ( eligibilityModel, eligibilityCmd ) =
                                                    Eligibility.init model.key { quoteId = quoteId, orgId = orgIdStr }
                                            in
                                            ( { model | page = EligibilityPage eligibilityModel }
                                            , Cmd.map EligibilityMsg eligibilityCmd
                                            )

                                        else
                                            -- Redirect to an error page or show an error
                                            ( { model | page = NotFoundPage }
                                            , Nav.pushUrl model.key "/error?message=Missing%20or%20invalid%20organization%20ID"
                                            )

                                    PublicRoute (ScheduleRoute params) ->
                                        let
                                            ( scheduleModel, scheduleCmd ) =
                                                Schedule.init model.key
                                                    ((\( id, _, _ ) -> id) params)
                                                    ((\( _, status, _ ) -> status) params)
                                        in
                                        ( { model | page = SchedulePage scheduleModel }
                                        , Cmd.map ScheduleMsg scheduleCmd
                                        )

                                    ProtectedRoute ContactsRoute ->
                                        let
                                            -- Convert Main.elm User to Contacts.elm User format
                                            contactsUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = String.toInt user.id |> Maybe.withDefault 0
                                                            , email = user.email
                                                            , firstName = user.firstName
                                                            , lastName = user.lastName
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            , organizationId = String.toInt user.organizationId |> Maybe.withDefault 0
                                                            , isActive = True -- Assume active
                                                            , phone = "" -- Default empty
                                                            , carriers = [] -- Default empty
                                                            , stateLicenses = [] -- Default empty
                                                            }
                                                        )

                                            ( contactsModel, contactsCmd ) =
                                                Contacts.init modelWithUpdatedSetup.key contactsUser
                                        in
                                        ( { modelWithUpdatedSetup | page = ContactsPage contactsModel }
                                        , Cmd.batch
                                            [ Cmd.map ContactsMsg contactsCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute ProfileRoute ->
                                        let
                                            ( profileModel, profileCmd ) =
                                                Profile.init ()
                                        in
                                        ( { modelWithUpdatedSetup | page = ProfilePage profileModel }
                                        , Cmd.batch
                                            [ Cmd.map ProfileMsg profileCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute TempLandingRoute ->
                                        let
                                            ( tempLandingModel, tempLandingCmd ) =
                                                TempLanding.init ()
                                        in
                                        ( { modelWithUpdatedSetup | page = TempLandingPage tempLandingModel }
                                        , Cmd.batch
                                            [ Cmd.map TempLandingMsg tempLandingCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute (ContactRoute id) ->
                                        let
                                            ( contactModel, contactCmd ) =
                                                Contact.init modelWithUpdatedSetup.key id
                                        in
                                        ( { modelWithUpdatedSetup | page = ContactPage contactModel }
                                        , Cmd.batch
                                            [ Cmd.map ContactMsg contactCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute ChangePlanRoute ->
                                        let
                                            ( changePlanModel, changePlanCmd ) =
                                                ChangePlan.init
                                                    { key = modelWithUpdatedSetup.key
                                                    , session = extractSession modelWithUpdatedSetup.session
                                                    , orgSlug = modelWithUpdatedSetup.currentUser |> Maybe.map .organizationSlug |> Maybe.withDefault ""
                                                    }
                                        in
                                        ( { modelWithUpdatedSetup | page = ChangePlanPage changePlanModel }
                                        , Cmd.batch
                                            [ Cmd.map ChangePlanMsg changePlanCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute DashboardRoute ->
                                        let
                                            dashboardFlags =
                                                { isPostPayment =
                                                    case
                                                        Parser.parse
                                                            (Parser.s "dashboard" <?> Query.string "payment_success")
                                                            url
                                                    of
                                                        Just (Just "true") ->
                                                            Just True

                                                        _ ->
                                                            Nothing
                                                }

                                            ( dashboardModel, dashboardCmd ) =
                                                Dashboard.init dashboardFlags
                                        in
                                        ( { modelWithUpdatedSetup | page = DashboardPage dashboardModel }
                                        , Cmd.batch
                                            [ Cmd.map DashboardMsg dashboardCmd
                                            , authCmd
                                            ]
                                        )

                                    ProtectedRoute WalkthroughRoute ->
                                        let
                                            currentUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = user.id
                                                            , name = user.firstName ++ " " ++ user.lastName
                                                            , email = user.email
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            }
                                                        )

                                            ( walkthroughModel, walkthroughCmd ) =
                                                Walkthrough.init modelWithUpdatedSetup.key currentUser
                                        in
                                        ( { modelWithUpdatedSetup | page = WalkthroughPage walkthroughModel }
                                        , Cmd.batch
                                            [ Cmd.map WalkthroughMsg walkthroughCmd
                                            , authCmd
                                            ]
                                        )

                                    AdminRoute SettingsRoute ->
                                        let
                                            -- Convert Main.elm User to Settings.elm CurrentUser format
                                            settingsUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = user.id
                                                            , email = user.email
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            , organizationSlug = user.organizationSlug
                                                            , organizationId = user.organizationId
                                                            }
                                                        )

                                            ( settingsModel, settingsCmd ) =
                                                Settings.init
                                                    { isSetup = False
                                                    , key = modelWithUpdatedSetup.key
                                                    , currentUser = settingsUser
                                                    , planType =
                                                        modelWithUpdatedSetup.currentUser
                                                            |> Maybe.map .subscriptionTier
                                                            |> Maybe.withDefault ""
                                                    }
                                        in
                                        ( { modelWithUpdatedSetup | page = SettingsPage settingsModel }
                                        , Cmd.batch
                                            [ Cmd.map SettingsMsg settingsCmd
                                            , authCmd
                                            ]
                                        )

                                    AdminRoute AgentsRoute ->
                                        let
                                            -- Convert Main.elm User to AddAgent.elm CurrentUser format
                                            addAgentUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = user.id
                                                            , email = user.email
                                                            , firstName = user.firstName
                                                            , lastName = user.lastName
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            , phone = ""
                                                            }
                                                        )

                                            ( addAgentModel, addAgentCmd ) =
                                                AddAgent.init
                                                    False
                                                    modelWithUpdatedSetup.key
                                                    addAgentUser
                                                    (modelWithUpdatedSetup.currentUser
                                                        |> Maybe.map .subscriptionTier
                                                        |> Maybe.withDefault ""
                                                    )
                                        in
                                        ( { modelWithUpdatedSetup | page = AddAgentsPage addAgentModel }
                                        , Cmd.batch
                                            [ Cmd.map AddAgentsMsg addAgentCmd
                                            , authCmd
                                            ]
                                        )

                                    SetupRoute (ChoosePlanRoute progress) ->
                                        let
                                            orgSlug =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map .organizationSlug
                                                    |> Maybe.withDefault ""

                                            session =
                                                extractSession modelWithUpdatedSetup.session

                                            ( choosePlanModel, choosePlanCmd ) =
                                                ChoosePlan.init orgSlug session modelWithUpdatedSetup.key True
                                        in
                                        ( { modelWithUpdatedSetup | page = ChoosePlanPage choosePlanModel }
                                        , Cmd.batch
                                            [ Cmd.map ChoosePlanMsg choosePlanCmd
                                            , authCmd
                                            ]
                                        )

                                    SetupRoute (SetupSettingsRoute progress) ->
                                        let
                                            -- Get plan type from progress if available, otherwise use subscription tier
                                            planType =
                                                progress
                                                    |> Maybe.andThen .plan
                                                    |> Maybe.withDefault
                                                        (modelWithUpdatedSetup.currentUser
                                                            |> Maybe.map .subscriptionTier
                                                            |> Maybe.withDefault ""
                                                        )

                                            -- Convert Main.elm User to Settings.elm CurrentUser format
                                            settingsUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = user.id
                                                            , email = user.email
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            , organizationSlug = user.organizationSlug
                                                            , organizationId = user.organizationId
                                                            }
                                                        )

                                            ( settingsModel, settingsCmd ) =
                                                Settings.init
                                                    { isSetup = True
                                                    , key = modelWithUpdatedSetup.key
                                                    , currentUser = settingsUser
                                                    , planType = planType
                                                    }
                                        in
                                        ( { modelWithUpdatedSetup | page = SettingsPage settingsModel }
                                        , Cmd.batch
                                            [ Cmd.map SettingsMsg settingsCmd
                                            , authCmd
                                            ]
                                        )

                                    SetupRoute (AddAgentsRoute progress) ->
                                        let
                                            -- Get plan type from progress if available, otherwise use subscription tier
                                            planType =
                                                progress
                                                    |> Maybe.andThen .plan
                                                    |> Maybe.withDefault
                                                        (modelWithUpdatedSetup.currentUser
                                                            |> Maybe.map .subscriptionTier
                                                            |> Maybe.withDefault ""
                                                        )

                                            -- Convert Main.elm User to AddAgent.elm CurrentUser format
                                            addAgentUser =
                                                modelWithUpdatedSetup.currentUser
                                                    |> Maybe.map
                                                        (\user ->
                                                            { id = user.id
                                                            , email = user.email
                                                            , firstName = user.firstName
                                                            , lastName = user.lastName
                                                            , isAdmin = user.isAdmin
                                                            , isAgent = user.isAgent
                                                            , phone = ""
                                                            }
                                                        )

                                            ( addAgentModel, addAgentCmd ) =
                                                AddAgent.init True modelWithUpdatedSetup.key addAgentUser planType
                                        in
                                        ( { modelWithUpdatedSetup | page = AddAgentsPage addAgentModel }
                                        , Cmd.batch
                                            [ Cmd.map AddAgentsMsg addAgentCmd
                                            , authCmd
                                            ]
                                        )

                                    NotFound ->
                                        ( modelWithUpdatedSetup, Cmd.none )

                                    PublicRoute (SelfOnboardingRoute orgSlug) ->
                                        let
                                            ( selfOnboardingModel, selfOnboardingCmd ) =
                                                SelfServiceOnboarding.init model.key url
                                        in
                                        ( { model | page = SelfOnboardingPage selfOnboardingModel }
                                        , Cmd.map SelfOnboardingMsg selfOnboardingCmd
                                        )

                Nothing ->
                    ( { model | page = NotFoundPage }
                    , cmd
                    )


type alias CurrentUserResponse =
    { success : Bool
    , user : Maybe User
    }


fetchCurrentUser : Cmd Msg
fetchCurrentUser =
    Http.get
        { url = "/api/me"
        , expect = Http.expectJson GotCurrentUser currentUserResponseDecoder
        }


fetchAccountStatus : String -> Cmd Msg
fetchAccountStatus orgSlug =
    Http.get
        { url = "/api/organizations/" ++ orgSlug ++ "/account-status"
        , expect = Http.expectJson GotAccountStatus accountStatusResponseDecoder
        }


currentUserResponseDecoder : Decoder CurrentUserResponse
currentUserResponseDecoder =
    Decode.map2 CurrentUserResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "user"
            (Decode.nullable
                (Decode.value
                    |> Decode.andThen
                        (\_ ->
                            userDecoder
                        )
                )
            )
        )



-- Wrap the user in Just since our type expects Maybe User


isBasicPlan : Model -> Bool
isBasicPlan model =
    case model.currentUser of
        Just user ->
            user.organizationSlug == "basic"

        Nothing ->
            True


finalizeOrganization : String -> Cmd Msg
finalizeOrganization orgId =
    Http.post
        { url = "/api/organizations/" ++ orgId ++ "/finalize"
        , body = Http.emptyBody
        , expect = Http.expectWhatever OrgFinalized
        }



-- Helper function to extract session string from SessionState


extractSession : SessionState -> String
extractSession sessionState =
    case sessionState of
        Verified session ->
            session

        _ ->
            ""



-- Helper function to map Document msg to Document Msg


mapDocument : (msg -> Msg) -> Browser.Document msg -> Browser.Document Msg
mapDocument toMsg document =
    { title = document.title
    , body = List.map (Html.map toMsg) document.body
    }



-- Update the isSetup flag based on the current URL and route


updateIsSetup : Model -> Route -> Model
updateIsSetup model route =
    let
        -- Determine if we're in setup mode based on the route
        newIsSetup =
            case route of
                SetupRoute _ ->
                    True

                _ ->
                    -- For non-setup routes, only keep isSetup = True if we're in the middle
                    -- of setup flow (haven't completed it yet)
                    model.isSetup && (getSetupStep model /= Complete)
    in
    { model | isSetup = newIsSetup }



-- Convert Main.OnboardingStep to Onboarding.Step


onboardingStepToStep : OnboardingStep -> Onboarding.Step
onboardingStepToStep step =
    case step of
        PlanStep ->
            Onboarding.PlanSelectionStep

        PersonalStep ->
            Onboarding.UserDetailsStep

        CompanyStep ->
            Onboarding.CompanyDetailsStep

        LicensingStep ->
            Onboarding.LicensingSettingsStep

        AgentsStep ->
            Onboarding.AddAgentsStep

        PaymentStep ->
            Onboarding.PaymentStep

        EnterpriseStep ->
            Onboarding.EnterpriseFormStep



-- Add a new function to force update public routes


updatePageForcePublic : Url -> ( Model, Cmd Msg ) -> ( Model, Cmd Msg )
updatePageForcePublic url ( model, cmd ) =
    case Parser.parse routeParser url of
        Just route ->
            case route of
                PublicRoute HomeRoute ->
                    let
                        ( homeModel, homeCmd ) =
                            Home.init model.key
                    in
                    ( { model | page = HomePage homeModel }
                    , Cmd.map HomeMsg homeCmd
                    )

                PublicRoute WaitlistRoute ->
                    let
                        ( waitlistModel, waitlistCmd ) =
                            Waitlist.init
                    in
                    ( { model | page = WaitlistPage waitlistModel }
                    , Cmd.map WaitlistMsg waitlistCmd
                    )

                PublicRoute LoginRoute ->
                    let
                        ( loginModel, loginCmd ) =
                            Login.init model.key False url
                    in
                    ( { model | page = LoginPage loginModel }
                    , Cmd.map LoginMsg loginCmd
                    )

                PublicRoute SignupRoute ->
                    let
                        ( signupModel, signupCmd ) =
                            Signup.init model.key
                    in
                    ( { model | page = Signup signupModel }
                    , Cmd.map SignupMsg signupCmd
                    )

                PublicRoute (OnboardingRoute step) ->
                    case model.page of
                        OnboardingPage existingModel ->
                            let
                                newStep =
                                    onboardingStepToStep step

                                updatedModel =
                                    { existingModel | step = newStep }
                            in
                            ( { model | page = OnboardingPage updatedModel }
                            , Cmd.map OnboardingMsg (Task.perform (\_ -> Onboarding.InitializeCurrentStep) (Task.succeed ()))
                            )

                        _ ->
                            let
                                ( onboardingModel, onboardingCmd ) =
                                    Onboarding.init
                                        model.key
                                        (model.currentUser
                                            |> Maybe.map .organizationSlug
                                            |> Maybe.withDefault ""
                                        )
                                        (extractSession model.session)
                                        (onboardingStepToStep step)
                            in
                            ( { model | page = OnboardingPage onboardingModel }
                            , Cmd.map OnboardingMsg onboardingCmd
                            )

                PublicRoute (VerifyRoute params) ->
                    let
                        verifyUrl =
                            case params of
                                VerifyParams orgSlug token ->
                                    "/api/auth/verify/" ++ orgSlug ++ "/" ++ token
                    in
                    ( model
                    , Http.get
                        { url = verifyUrl
                        , expect = Http.expectJson GotVerification verificationDecoder
                        }
                    )

                PublicRoute (CompareRoute params) ->
                    case params.quoteId of
                        Just quoteId ->
                            let
                                ( compareModel, compareCmd ) =
                                    Compare.init model.key (Just params)
                            in
                            ( { model | page = ComparePage compareModel }
                            , Cmd.map CompareMsg compareCmd
                            )

                        Nothing ->
                            if isValidOrgId params.orgId then
                                let
                                    ( compareModel, compareCmd ) =
                                        Compare.init model.key (Just params)
                                in
                                ( { model | page = ComparePage compareModel }
                                , Cmd.map CompareMsg compareCmd
                                )

                            else
                                ( { model | page = NotFoundPage }
                                , Nav.pushUrl model.key "/404"
                                )

                PublicRoute (QuoteRoute params) ->
                    if isValidQuoteId params.quoteId then
                        let
                            initialValues =
                                { zipCode = Nothing
                                , dateOfBirth = Nothing
                                , tobacco = Nothing
                                , gender = Nothing
                                , quoteId = params.quoteId
                                , planType = params.planType
                                , orgId = params.orgId
                                }

                            ( quoteModel, quoteCmd ) =
                                Quote.init model.key initialValues
                        in
                        ( { model | page = QuotePage quoteModel }
                        , Cmd.map QuoteMsg quoteCmd
                        )

                    else
                        ( { model | page = NotFoundPage }
                        , Nav.pushUrl model.key "/error?message=Missing%20or%20invalid%20quote%20ID"
                        )

                PublicRoute (EligibilityRoute params) ->
                    let
                        ( quoteId, _, orgIdStr ) =
                            params
                    in
                    if isValidOrgId orgIdStr then
                        let
                            ( eligibilityModel, eligibilityCmd ) =
                                Eligibility.init model.key { quoteId = quoteId, orgId = orgIdStr }
                        in
                        ( { model | page = EligibilityPage eligibilityModel }
                        , Cmd.map EligibilityMsg eligibilityCmd
                        )

                    else
                        ( { model | page = NotFoundPage }
                        , Nav.pushUrl model.key "/error?message=Missing%20or%20invalid%20organization%20ID"
                        )

                PublicRoute (ScheduleRoute params) ->
                    let
                        ( scheduleModel, scheduleCmd ) =
                            Schedule.init model.key
                                ((\( id, _, _ ) -> id) params)
                                ((\( _, status, _ ) -> status) params)
                    in
                    ( { model | page = SchedulePage scheduleModel }
                    , Cmd.map ScheduleMsg scheduleCmd
                    )

                PublicRoute (SelfOnboardingRoute orgSlug) ->
                    let
                        ( selfOnboardingModel, selfOnboardingCmd ) =
                            SelfServiceOnboarding.init model.key url
                    in
                    ( { model | page = SelfOnboardingPage selfOnboardingModel }
                    , Cmd.map SelfOnboardingMsg selfOnboardingCmd
                    )

                ProtectedRoute _ ->
                    updatePage url ( model, cmd )

                AdminRoute _ ->
                    updatePage url ( model, cmd )

                SetupRoute _ ->
                    updatePage url ( model, cmd )

                NotFound ->
                    ( { model | page = NotFoundPage }, cmd )

        Nothing ->
            ( { model | page = NotFoundPage }
            , cmd
            )



-- Add a helper function to check if an organization ID is valid
-- It should return True only if the orgId is not empty, not "default", and is a proper string


isValidOrgId : Maybe String -> Bool
isValidOrgId maybeOrgId =
    case maybeOrgId of
        Just orgId ->
            not (String.isEmpty orgId) && orgId /= "default"

        Nothing ->
            False



-- Add a helper function to check if a quote ID is valid


isValidQuoteId : Maybe String -> Bool
isValidQuoteId maybeQuoteId =
    case maybeQuoteId of
        Just quoteId ->
            not (String.isEmpty quoteId)

        Nothing ->
            False

================
File: src/main.ts
================
import './styles.css'
import { Elm } from './Main.elm'
import './stripe-integration.js'
import { loadStripeScript } from './stripe-integration'

const root = document.querySelector('#app')
if (!root) {
  console.error('Could not find root element')
  throw new Error('Could not find root element')
}



// Favicon is now set directly in index.html

try {
  console.log('Initializing Elm application...');
  
  // Verify the Elm object exists and has required properties
  if (!Elm) {
    throw new Error('Elm object is not defined');
  }
  
  if (!Elm.Main) {
    throw new Error('Elm.Main is not defined. Make sure the Elm application is correctly compiled.');
  }
  
  if (typeof Elm.Main.init !== 'function') {
    throw new Error('Elm.Main.init is not a function. The Elm application might not be correctly compiled.');
  }
  
  // Log Elm details for debugging
  console.log('Elm available:', !!Elm);
  console.log('Elm.Main available:', !!Elm.Main);
  console.log('Elm.Main.init available:', !!(Elm.Main && typeof Elm.Main.init === 'function'));
  
  // Create the flags object with only what's needed by Elm

    
  // @ts-ignore - Will be used for ports in the future
  const app = Elm.Main.init({
    node: root  
  });
  
  // Expose app and Elm objects for debugging
  (window as any).elmApp = app;
  (window as any).elmDebug = Elm;
  
  // Setup IntersectionObserver for phone section
  if (app.ports && app.ports.viewingPhone) {
    // Wait for the DOM to be fully rendered
    setTimeout(() => {
      // Find the phone section container - being more specific with the selector
      const phoneSection = document.querySelector('.relative.h-\\[400px\\].w-\\[280px\\].rounded-\\[30px\\].overflow-hidden')
      
      if (phoneSection) {
        console.log('Found phone section, setting up IntersectionObserver')
        
        // Create an observer
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            // When the section becomes visible, send true through the port
            if (entry.isIntersecting) {
              console.log('Phone section is now visible')
              app.ports.viewingPhone.send(true)
            } else {
              console.log('Phone section is no longer visible')
              app.ports.viewingPhone.send(false)
            }
          })
        }, {
          threshold: 0.2 // Fire when at least 20% of the element is visible
        })
        
        // Start observing the phone section
        observer.observe(phoneSection)
      } else {
        console.warn('Could not find phone section for carousel')
      }
    }, 1000) // Give the app time to render
  }
  
  // Stripe integration ports
  if (app.ports) {
    // Initialize Stripe
    if (app.ports.initializeStripe) {
      app.ports.initializeStripe.subscribe((publishableKey: string) => {
        console.log('Initializing Stripe with key:', publishableKey.substring(0, 8) + '...')
        try {
          // @ts-ignore - stripeIntegration is attached to window
          const initialized = window.stripeIntegration.initializeStripe(publishableKey)
          if (app.ports.stripeInitialized) {
            app.ports.stripeInitialized.send(initialized)
          }
        } catch (error) {
          console.error('Failed to initialize Stripe:', error)
          if (app.ports.stripeInitialized) {
            app.ports.stripeInitialized.send(false)
          }
        }
      })
    }

    // get org slug
    if (app.ports.getOrgSlug) {
      app.ports.getOrgSlug.subscribe(() => {
        app.ports.receiveOrgSlug.send("")
      })
    }

    // Process payment
    if (app.ports.processPayment) {
      app.ports.processPayment.subscribe((clientSecret: string) => {
        console.log('Processing payment with client secret:', clientSecret.substring(0, 8) + '...')
        try {
          // @ts-ignore - stripeIntegration is attached to window
          window.stripeIntegration.processPayment(clientSecret)
            .then((result: any) => {
              if (app.ports.paymentProcessed) {
                app.ports.paymentProcessed.send(result)
              }
            })
            .catch((error: Error) => {
              console.error('Payment processing error:', error)
              if (app.ports.paymentProcessed) {
                app.ports.paymentProcessed.send({ success: false, error: error.message })
              }
            })
        } catch (error) {
          console.error('Failed to process payment:', error)
          if (app.ports.paymentProcessed) {
            app.ports.paymentProcessed.send({ success: false, error: 'Failed to process payment' })
          }
        }
      })
    }

    // Clean up Stripe
    if (app.ports.cleanupStripe) {
      app.ports.cleanupStripe.subscribe(() => {
        console.log('Cleaning up Stripe')
        try {
          // @ts-ignore - stripeIntegration is attached to window
          window.stripeIntegration.cleanupStripe()
        } catch (error) {
          console.error('Failed to clean up Stripe:', error)
        }
      })
    }
    
    // Copy to clipboard
    if (app.ports.copyToClipboard) {
      app.ports.copyToClipboard.subscribe((text: string) => {
        console.log('Copying to clipboard:', text.substring(0, 20) + '...')
        try {
          navigator.clipboard.writeText(text)
            .then(() => {
              console.log('Text copied to clipboard')
              if (app.ports.onCopyResult) {
                app.ports.onCopyResult.send(true)
              }
            })
            .catch((error) => {
              console.error('Failed to copy text to clipboard:', error)
              if (app.ports.onCopyResult) {
                app.ports.onCopyResult.send(false)
              }
            })
        } catch (error) {
          console.error('Clipboard API not available:', error)
          if (app.ports.onCopyResult) {
            app.ports.onCopyResult.send(false)
          }
        }
      })
    }

    // Debug info ports
    if (app.ports.saveDebugInfo) {
      app.ports.saveDebugInfo.subscribe((debugInfo: string) => {
        console.log('Debug info:', debugInfo);
        localStorage.setItem('selfservice_debug_info', debugInfo);
        
        // Write to console with more details for better visibility
        console.warn('SELF-SERVICE DEBUG:', debugInfo);
        
        // Also log to session storage in case localStorage is cleared
        sessionStorage.setItem('selfservice_debug_info', debugInfo);
      });
    }

    if (app.ports.clearDebugInfo) {
      app.ports.clearDebugInfo.subscribe(() => {
        console.log('Clearing debug info');
        localStorage.removeItem('selfservice_debug_info');
        sessionStorage.removeItem('selfservice_debug_info');
      });
    }

    // Handle checkout session for contact-based pricing
    if (app.ports.createContactBasedCheckout) {
      app.ports.createContactBasedCheckout.subscribe(async (checkoutData: any) => {
        try {
          // Make the API call to create a checkout session
          const response = await fetch('/api/subscription/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contactTier: checkoutData.tier })
          });
          
          if (!response.ok) {
            throw new Error(`Error ${response.status}: ${await response.text()}`);
          }
          
          const data = await response.json();
          
          if (data.clientSecret) {
            // Initialize the Stripe Elements instance and confirm the payment
            console.log('Processing payment with Stripe Elements');
            // @ts-ignore - stripeIntegration is attached to window
            window.stripeIntegration.processPayment(data.clientSecret)
              .then((result: any) => {
                if (app.ports.checkoutCompleted) {
                  app.ports.checkoutCompleted.send({
                    success: result.success,
                    error: result.error,
                    subscriptionId: data.subscriptionId
                  });
                }
              })
              .catch((error: Error) => {
                console.error('Error processing checkout:', error);
                if (app.ports.checkoutCompleted) {
                  app.ports.checkoutCompleted.send({
                    success: false,
                    error: error.message
                  });
                }
              });
          } else {
            throw new Error('No client secret in response');
          }
        } catch (error) {
          console.error('Error creating checkout session:', error);
          if (app.ports.checkoutCompleted) {
            app.ports.checkoutCompleted.send({
              success: false,
              error: error instanceof Error ? error.message : 'Unknown error'
            });
          }
        }
      });
    }

    // Add this listener in the ports section to handle Stripe pricing table selection
    document.addEventListener('priceSelected', (e: any) => {
      if (app.ports.stripeTableSelected) {
        // Send the selected price ID to Elm
        app.ports.stripeTableSelected.send(e.detail.priceId);
      }
    });
  }

  // Add this line to the initialization part
  loadStripeScript();
} catch (error) {
  console.error('Error initializing Elm application:', error);
  
  // Display a user-friendly error message
  if (root) {
    root.innerHTML = `
      <div style="max-width: 800px; margin: 50px auto; padding: 20px; font-family: sans-serif; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px;">
        <h1 style="color: #721c24;">Elm Initialization Error</h1>
        <p style="margin-bottom: 20px; font-size: 16px;">There was a problem initializing the application:</p>
        <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; max-height: 300px;">${error}</pre>
        <p style="margin-top: 20px; font-size: 14px;">Try refreshing the page or clearing your browser cache.</p>
        <button onclick="window.location.reload()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Refresh Page</button>
      </div>
    `;
  }
}

================
File: src/MyIcon.elm
================
module MyIcon exposing (..)

import Svg exposing (Svg, rect, svg)
import Svg.Attributes exposing (..)


heartPulse : Int -> String -> Svg msg
heartPulse size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" ] []
        , Svg.path [ d "M3.22 12H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27" ] []
        ]


stethoscope : Int -> String -> Svg msg
stethoscope size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M11 2v2" ] []
        , Svg.path [ d "M5 2v2" ] []
        , Svg.path [ d "M5 3H4a2 2 0 0 0-2 2v4a6 6 0 0 0 12 0V5a2 2 0 0 0-2-2h-1" ] []
        , Svg.path [ d "M8 15a6 6 0 0 0 12 0v-3" ] []
        , Svg.circle [ cx "20", cy "10", r "2" ] []
        ]


syringe : Int -> String -> Svg msg
syringe size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "m18 2 4 4" ] []
        , Svg.path [ d "m17 7 3-3" ] []
        , Svg.path [ d "M19 9 8.7 19.3c-1 1-2.5 1-3.4 0l-.6-.6c-1-1-1-2.5 0-3.4L15 5" ] []
        , Svg.path [ d "m9 11 4 4" ] []
        , Svg.path [ d "m5 19-3 3" ] []
        , Svg.path [ d "m14 4 6 6" ] []
        ]


lungs : Int -> String -> Svg msg
lungs size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M10 10v.2A3 3 0 0 1 8.9 16H5a3 3 0 0 1-1-5.8V10a3 3 0 0 1 6 0Z" ] []
        , Svg.path [ d "M7 16v6" ] []
        , Svg.path [ d "M13 19v3" ] []
        , Svg.path [ d "M12 19h8.3a1 1 0 0 0 .7-1.7L18 14h.3a1 1 0 0 0 .7-1.7L16 9h.2a1 1 0 0 0 .8-1.7L13 3l-1.4 1.5" ] []
        ]


droplets : Int -> String -> Svg msg
droplets size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z" ] []
        , Svg.path [ d "M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97" ] []
        ]


brain : Int -> String -> Svg msg
brain size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z" ] []
        , Svg.path [ d "M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z" ] []
        , Svg.path [ d "M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4" ] []
        , Svg.path [ d "M17.599 6.5a3 3 0 0 0 .399-1.375" ] []
        , Svg.path [ d "M6.003 5.125A3 3 0 0 0 6.401 6.5" ] []
        , Svg.path [ d "M3.477 10.896a4 4 0 0 1 .585-.396" ] []
        , Svg.path [ d "M19.938 10.5a4 4 0 0 1 .585.396" ] []
        , Svg.path [ d "M6 18a4 4 0 0 1-1.967-.516" ] []
        , Svg.path [ d "M19.967 17.484A4 4 0 0 1 18 18" ] []
        ]


building2 : Int -> String -> Svg msg
building2 size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z" ] []
        , Svg.path [ d "M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2" ] []
        , Svg.path [ d "M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2" ] []
        , Svg.path [ d "M10 6h4" ] []
        , Svg.path [ d "M10 10h4" ] []
        , Svg.path [ d "M10 14h4" ] []
        , Svg.path [ d "M10 18h4" ] []
        ]


activity : Int -> String -> Svg msg
activity size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2" ] []
        ]


heartScan : Int -> String -> Svg msg
heartScan size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M11.246 16.657a1 1 0 0 0 1.508 0l3.57-4.101A2.75 2.75 0 1 0 12 9.168a2.75 2.75 0 1 0-4.324 3.388z" ] []
        , Svg.path [ d "M17 3h2a2 2 0 0 1 2 2v2" ] []
        , Svg.path [ d "M21 17v2a2 2 0 0 1-2 2h-2" ] []
        , Svg.path [ d "M3 7V5a2 2 0 0 1 2-2h2" ] []
        , Svg.path [ d "M7 21H5a2 2 0 0 1-2-2v-2" ] []
        ]


hospital : Int -> String -> Svg msg
hospital size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M12 6v4" ] []
        , Svg.path [ d "M14 14h-4" ] []
        , Svg.path [ d "M14 18h-4" ] []
        , Svg.path [ d "M14 8h-4" ] []
        , Svg.path [ d "M18 12h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-9a2 2 0 0 1 2-2h2" ] []
        , Svg.path [ d "M18 22V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v18" ] []
        ]


squareActivity : Int -> String -> Svg msg
squareActivity size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ rect [ width "18", height "18", x "3", y "3", rx "2" ] []
        , Svg.path [ d "M17 12h-2l-2 5-2-10-2 5H7" ] []
        ]


clipboardPlus : Int -> String -> Svg msg
clipboardPlus size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.rect [ width "8", height "4", x "8", y "2", rx "1", ry "1" ] []
        , Svg.path [ d "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" ] []
        , Svg.path [ d "M9 14h6" ] []
        , Svg.path [ d "M12 17v-6" ] []
        ]


undo2 : Int -> String -> Svg msg
undo2 size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M9 14 4 9l5-5" ] []
        , Svg.path [ d "M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11" ] []
        ]


calendarDays : Int -> String -> Svg msg
calendarDays size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M8 2v4" ] []
        , Svg.path [ d "M16 2v4" ] []
        , Svg.rect [ width "18", height "18", x "3", y "4", rx "2" ] []
        , Svg.path [ d "M3 10h18" ] []
        , Svg.path [ d "M8 14h.01" ] []
        , Svg.path [ d "M12 14h.01" ] []
        , Svg.path [ d "M16 14h.01" ] []
        , Svg.path [ d "M8 18h.01" ] []
        , Svg.path [ d "M12 18h.01" ] []
        , Svg.path [ d "M16 18h.01" ] []
        ]


phoneOutgoing : Int -> String -> Svg msg
phoneOutgoing size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.polyline [ points "22 8 22 2 16 2" ] []
        , Svg.line [ x1 "16", x2 "22", y1 "8", y2 "2" ] []
        , Svg.path [ d "M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" ] []
        ]


clipboardPaste : Int -> String -> Svg msg
clipboardPaste size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M15 2H9a1 1 0 0 0-1 1v2c0 .6.4 1 1 1h6c.6 0 1-.4 1-1V3c0-.6-.4-1-1-1Z" ] []
        , Svg.path [ d "M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2M16 4h2a2 2 0 0 1 2 2v2M11 14h10" ] []
        , Svg.path [ d "m17 10 4 4-4 4" ] []
        ]



-- home page


lightning : Int -> String -> Svg msg
lightning size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M13 2L4.09347 12.6879C3.74466 13.1064 3.57026 13.3157 3.56759 13.4925C3.56528 13.6461 3.63375 13.7923 3.75327 13.8889C3.89076 14 4.16319 14 4.70805 14H12L11 22L19.9066 11.3121C20.2554 10.8936 20.4298 10.6843 20.4324 10.5075C20.4348 10.3539 20.3663 10.2077 20.2468 10.1111C20.1093 10 19.8368 10 19.292 10H12L13 2Z" ] []
        ]


envelope : Int -> String -> Svg msg
envelope size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 25 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M2.33334 7L10.4983 12.7154C11.1594 13.1783 11.49 13.4097 11.8496 13.4993C12.1672 13.5785 12.4994 13.5785 12.8171 13.4993C13.1767 13.4097 13.5073 13.1783 14.1684 12.7154L22.3333 7M7.13334 20H17.5333C19.2135 20 20.0536 20 20.6953 19.673C21.2598 19.3854 21.7187 18.9265 22.0064 18.362C22.3333 17.7202 22.3333 16.8802 22.3333 15.2V8.8C22.3333 7.11984 22.3333 6.27976 22.0064 5.63803C21.7187 5.07354 21.2598 4.6146 20.6953 4.32698C20.0536 4 19.2135 4 17.5333 4H7.13334C5.45319 4 4.61311 4 3.97137 4.32698C3.40689 4.6146 2.94794 5.07354 2.66032 5.63803C2.33334 6.27976 2.33334 7.11984 2.33334 8.8V15.2C2.33334 16.8802 2.33334 17.7202 2.66032 18.362C2.94794 18.9265 3.40689 19.3854 3.97137 19.673C4.61311 20 5.45319 20 7.13334 20Z" ] []
        ]


brightArrow : Int -> String -> Svg msg
brightArrow size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 25 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M11.6666 3H8.46663C6.78647 3 5.94639 3 5.30465 3.32698C4.74017 3.6146 4.28123 4.07354 3.99361 4.63803C3.66663 5.27976 3.66663 6.11984 3.66663 7.8V16.2C3.66663 17.8802 3.66663 18.7202 3.99361 19.362C4.28123 19.9265 4.74017 20.3854 5.30465 20.673C5.94639 21 6.78647 21 8.46663 21H16.8666C18.5468 21 19.3869 21 20.0286 20.673C20.5931 20.3854 21.052 19.9265 21.3396 19.362C21.6666 18.7202 21.6666 17.8802 21.6666 16.2V13M12.6666 8H16.6666V12M16.1666 3.5V2M20.106 4.56066L21.1666 3.5M21.1769 8.5H22.6769M3.66663 13.3471C4.31857 13.4478 4.9865 13.5 5.66663 13.5C10.053 13.5 13.932 11.3276 16.2863 8" ] []
        ]


chatBubbles : Int -> String -> Svg msg
chatBubbles size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M6.09436 11.2288C6.03221 10.8282 5.99996 10.4179 5.99996 10C5.99996 5.58172 9.60525 2 14.0526 2C18.4999 2 22.1052 5.58172 22.1052 10C22.1052 10.9981 21.9213 11.9535 21.5852 12.8345C21.5154 13.0175 21.4804 13.109 21.4646 13.1804C21.4489 13.2512 21.4428 13.301 21.4411 13.3735C21.4394 13.4466 21.4493 13.5272 21.4692 13.6883L21.8717 16.9585C21.9153 17.3125 21.9371 17.4895 21.8782 17.6182C21.8266 17.731 21.735 17.8205 21.6211 17.8695C21.4911 17.9254 21.3146 17.8995 20.9617 17.8478L17.7765 17.3809C17.6101 17.3565 17.527 17.3443 17.4512 17.3448C17.3763 17.3452 17.3245 17.3507 17.2511 17.3661C17.177 17.3817 17.0823 17.4172 16.893 17.4881C16.0097 17.819 15.0524 18 14.0526 18C13.6344 18 13.2237 17.9683 12.8227 17.9073M7.63158 22C10.5965 22 13 19.5376 13 16.5C13 13.4624 10.5965 11 7.63158 11C4.66668 11 2.26316 13.4624 2.26316 16.5C2.26316 17.1106 2.36028 17.6979 2.53955 18.2467C2.61533 18.4787 2.65322 18.5947 2.66566 18.6739C2.67864 18.7567 2.68091 18.8031 2.67608 18.8867C2.67145 18.9668 2.65141 19.0573 2.61134 19.2383L2 22L4.9948 21.591C5.15827 21.5687 5.24 21.5575 5.31137 21.558C5.38652 21.5585 5.42641 21.5626 5.50011 21.5773C5.5701 21.5912 5.67416 21.6279 5.88227 21.7014C6.43059 21.8949 7.01911 22 7.63158 22Z" ] []
        ]


smilieyChat : Int -> String -> Svg msg
smilieyChat size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M8.99962 14C8.99962 14 10.3121 15.5 12.4996 15.5C14.6871 15.5 15.9996 14 15.9996 14M15.2496 9H15.2596M9.74962 9H9.75962M12.4996 20C17.194 20 20.9996 16.1944 20.9996 11.5C20.9996 6.80558 17.194 3 12.4996 3C7.8052 3 3.99962 6.80558 3.99962 11.5C3.99962 12.45 4.15547 13.3636 4.443 14.2166C4.55119 14.5376 4.60529 14.6981 4.61505 14.8214C4.62469 14.9432 4.6174 15.0286 4.58728 15.1469C4.55677 15.2668 4.48942 15.3915 4.35472 15.6408L2.71906 18.6684C2.48575 19.1002 2.36909 19.3161 2.3952 19.4828C2.41794 19.6279 2.50337 19.7557 2.6288 19.8322C2.7728 19.9201 3.01692 19.8948 3.50517 19.8444L8.62619 19.315C8.78127 19.299 8.85881 19.291 8.92949 19.2937C8.999 19.2963 9.04807 19.3029 9.11586 19.3185C9.18478 19.3344 9.27145 19.3678 9.44478 19.4345C10.3928 19.7998 11.4228 20 12.4996 20ZM15.7496 9C15.7496 9.27614 15.5258 9.5 15.2496 9.5C14.9735 9.5 14.7496 9.27614 14.7496 9C14.7496 8.72386 14.9735 8.5 15.2496 8.5C15.5258 8.5 15.7496 8.72386 15.7496 9ZM10.2496 9C10.2496 9.27614 10.0258 9.5 9.74962 9.5C9.47348 9.5 9.24962 9.27614 9.24962 9C9.24962 8.72386 9.47348 8.5 9.74962 8.5C10.0258 8.5 10.2496 8.72386 10.2496 9Z" ] []
        ]


commandKey : Int -> String -> Svg msg
commandKey size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M9 9V6C9 4.34315 7.65685 3 6 3C4.34315 3 3 4.34315 3 6C3 7.65685 4.34315 9 6 9H9ZM9 9V15M9 9H15M9 15V18C9 19.6569 7.65685 21 6 21C4.34315 21 3 19.6569 3 18C3 16.3431 4.34315 15 6 15H9ZM9 15H15M15 15H18C19.6569 15 21 16.3431 21 18C21 19.6569 19.6569 21 18 21C16.3431 21 15 19.6569 15 18V15ZM15 15V9M15 9V6C15 4.34315 16.3431 3 18 3C19.6569 3 21 4.34315 21 6C21 7.65685 19.6569 9 18 9H15Z" ] []
        ]


heartBubble : Int -> String -> Svg msg
heartBubble size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M20.9996 11.5C20.9996 16.1944 17.194 20 12.4996 20C11.4228 20 10.3928 19.7998 9.44478 19.4345C9.27145 19.3678 9.18478 19.3344 9.11586 19.3185C9.04807 19.3029 8.999 19.2963 8.92949 19.2937C8.85881 19.291 8.78127 19.299 8.62619 19.315L3.50517 19.8444C3.01692 19.8948 2.7728 19.9201 2.6288 19.8322C2.50337 19.7557 2.41794 19.6279 2.3952 19.4828C2.36909 19.3161 2.48575 19.1002 2.71906 18.6684L4.35472 15.6408C4.48942 15.3915 4.55677 15.2668 4.58728 15.1469C4.6174 15.0286 4.62469 14.9432 4.61505 14.8214C4.60529 14.6981 4.55119 14.5376 4.443 14.2166C4.15547 13.3636 3.99962 12.45 3.99962 11.5C3.99962 6.80558 7.8052 3 12.4996 3C17.194 3 20.9996 6.80558 20.9996 11.5Z" ] []
        , Svg.path [ d "M12.4965 8.94925C11.5968 7.9104 10.0965 7.63095 8.96924 8.58223C7.84196 9.5335 7.68326 11.124 8.56851 12.2491C9.11696 12.9461 10.4935 14.2191 11.4616 15.087C11.8172 15.4057 11.995 15.5651 12.2084 15.6293C12.3914 15.6844 12.6017 15.6844 12.7847 15.6293C12.9981 15.5651 13.1759 15.4057 13.5315 15.087C14.4996 14.2191 15.8761 12.9461 16.4246 12.2491C17.3098 11.124 17.1705 9.5235 16.0238 8.58223C14.8772 7.64096 13.3963 7.9104 12.4965 8.94925Z" ] []
        ]


circleMinus : Int -> String -> Svg msg
circleMinus size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M8 12H16M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12Z" ] []
        ]


circlePlus : Int -> String -> Svg msg
circlePlus size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 24 24"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M12 10V18M8 14H16M22 14C22 19.5228 17.5228 24 12 24C6.47715 24 2 19.5228 2 14C2 8.47715 6.47715 4 12 4C17.5228 4 22 8.47715 22 14Z" ] []
        ]


maxLogo : Int -> String -> Svg msg
maxLogo size color =
    svg
        [ width (String.fromInt size)
        , height (String.fromInt size)
        , viewBox "0 0 246 34"
        , fill "none"
        , stroke color
        , strokeWidth "2"
        , strokeLinecap "round"
        , strokeLinejoin "round"
        ]
        [ Svg.path [ d "M28.0608 2.05762C27.5512 1.90329 27.0107 1.82031 26.4509 1.82031H11.6131L21.1611 19.295L28.0608 2.05762Z", fill "white" ] []
        , Svg.path [ d "M5.27168 1.82713C2.33588 1.97181 0 4.3998 0 7.37378V18.0748C0.63094 18.0398 1.35488 18.0179 2.21965 18.0179C2.95641 18.0179 3.383 17.8859 3.63477 17.7535C3.86366 17.6332 4.0932 17.4384 4.3236 17.0378C4.86375 16.0985 5.27168 14.2768 5.27168 10.9835V1.82713Z", fill "white" ] []
        , Svg.path [ d "M0 23.6386V26.6258C0 29.6929 2.48443 32.1793 5.54913 32.1793H21.8764L10.8108 11.9272C10.7435 15.0062 10.3224 17.7398 9.13305 19.808C8.43859 21.0155 7.47738 22.0066 6.21494 22.6702C4.97538 23.3217 3.61007 23.5714 2.21965 23.5714C1.31899 23.5714 0.609185 23.5976 0 23.6386Z", fill "white" ] []
        , Svg.path [ d "M21.9817 32.1793H26.4509C29.5156 32.1793 32 29.6929 32 26.6258V7.37378C32 7.30239 31.9987 7.23132 31.996 7.16059L21.9817 32.1793Z", fill "white" ] []
        , Svg.path [ d "M42.24 29V9.008H48.652L53.104 22.364H53.188L57.64 9.008H64.08V29H59.376V17.296H59.236C59.068 17.968 58.844 18.808 58.48 19.816L55.288 29H51.06L47.868 19.816C47.504 18.808 47.252 17.968 47.112 17.296H46.972V29H42.24ZM75.46 29.42C70.616 29.42 66.892 25.724 66.892 21.132C66.892 16.568 70.616 12.984 75.46 12.984C80.332 12.984 84.028 16.792 84.028 21.524C84.028 21.86 84 22.448 83.972 22.756H71.932C72.184 24.352 73.668 24.94 75.516 24.94C76.832 24.94 77.924 24.632 78.428 23.596H83.72C82.712 27.068 79.52 29.42 75.46 29.42ZM72.1 19.536H78.736C78.54 18.668 77.308 17.464 75.376 17.464C73.444 17.464 72.24 18.5 72.1 19.536ZM92.6798 29.42C88.6198 29.42 85.5678 25.78 85.5678 21.216C85.5678 16.624 88.6198 12.984 92.6798 12.984C95.0598 12.984 97.1038 14.16 97.9718 15.812H98.1118V9.008H102.928V29H98.2518V26.76H98.1118C96.6838 28.832 94.7798 29.42 92.6798 29.42ZM94.0798 24.94C96.2638 24.94 97.5518 23.4 97.5518 21.216C97.5518 19.004 96.2638 17.464 94.0798 17.464C91.8678 17.464 90.6918 19.004 90.6918 21.216C90.6918 23.4 91.8678 24.94 94.0798 24.94ZM108.923 11.36C107.439 11.36 106.235 10.156 106.235 8.672C106.235 7.216 107.439 6.012 108.923 6.012C110.379 6.012 111.583 7.216 111.583 8.672C111.583 10.156 110.379 11.36 108.923 11.36ZM106.515 28.944V13.404H111.331V28.944H106.515ZM121.965 29.364C117.401 29.364 113.677 25.668 113.677 21.076C113.677 16.512 117.401 12.816 121.965 12.816C124.345 12.816 126.501 13.824 128.013 15.42L124.905 18.556C124.261 17.8 123.309 17.324 121.965 17.324C120.033 17.324 118.493 18.892 118.493 21.076C118.493 23.288 120.033 24.856 121.965 24.856C123.197 24.856 124.065 24.464 124.709 23.82L127.817 26.956C126.305 28.468 124.261 29.364 121.965 29.364ZM135.534 29.42C131.222 29.42 128.142 25.78 128.142 21.216C128.142 16.624 131.222 12.984 135.534 12.984C137.942 12.984 139.846 14.16 140.714 15.812H140.854V13.404H145.53V29H140.854V26.76H140.714C139.286 28.832 137.662 29.42 135.534 29.42ZM136.654 24.94C138.866 24.94 140.154 23.4 140.154 21.216C140.154 19.004 138.866 17.464 136.654 17.464C134.47 17.464 133.266 19.004 133.266 21.216C133.266 23.4 134.47 24.94 136.654 24.94ZM149.144 29V13.404H158.524V17.884H153.96V29H149.144ZM167.937 29.42C163.093 29.42 159.369 25.724 159.369 21.132C159.369 16.568 163.093 12.984 167.937 12.984C172.809 12.984 176.505 16.792 176.505 21.524C176.505 21.86 176.477 22.448 176.449 22.756H164.409C164.661 24.352 166.145 24.94 167.993 24.94C169.309 24.94 170.401 24.632 170.905 23.596H176.197C175.189 27.068 171.997 29.42 167.937 29.42ZM164.577 19.536H171.213C171.017 18.668 169.785 17.464 167.853 17.464C165.921 17.464 164.717 18.5 164.577 19.536ZM185.029 29V9.008H191.441L195.893 22.364H195.977L200.429 9.008H206.869V29H202.165V17.296H202.025C201.857 17.968 201.633 18.808 201.269 19.816L198.077 29H193.849L190.657 19.816C190.293 18.808 190.041 17.968 189.901 17.296H189.761V29H185.029ZM217.073 29.42C212.761 29.42 209.681 25.78 209.681 21.216C209.681 16.624 212.761 12.984 217.073 12.984C219.481 12.984 221.385 14.16 222.253 15.812H222.393V13.404H227.069V29H222.393V26.76H222.253C220.825 28.832 219.201 29.42 217.073 29.42ZM218.193 24.94C220.405 24.94 221.693 23.4 221.693 21.216C221.693 19.004 220.405 17.464 218.193 17.464C216.009 17.464 214.805 19.004 214.805 21.216C214.805 23.4 216.009 24.94 218.193 24.94ZM228.611 29L234.071 20.992L228.835 13.404H234.575L236.703 17.044L238.831 13.404H244.571L239.335 20.992L244.795 29H239.111L236.703 25.024L234.323 29H228.611Z", fill "white" ] []
        ]

================
File: src/OnboardingNew.elm
================
port module OnboardingNew exposing
    ( Model
    , Msg(..)
    , Step(..)
    , init
    , subscriptions
    , update
    , view
    )

import Browser
import Browser.Dom as Dom
import Browser.Navigation as Nav
import Components.SetupLayout as SetupLayout
import Html exposing (..)
import Html.Attributes exposing (alt, checked, class, for, href, id, placeholder, src, type_, value)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline exposing (optional, required)
import Json.Encode as Encode
import Random
import Task
import Url
import Utils.RandomOrgName exposing (generateOrgName)



-- Subscription Tier Type


type alias SubscriptionTier =
    { id : String
    , name : String
    , description : String
    , price : Float
    , features : List String
    , maxAgents : Int
    , maxContacts : Int
    }



-- Ports for onboarding cookie management


port setOnboardingCookie : { sessionId : String, planType : String, step : Int } -> Cmd msg


port getOnboardingCookie : () -> Cmd msg


port onboardingCookieReceived : (Maybe { sessionId : String, planType : String, step : Int } -> msg) -> Sub msg



-- Ports for storing section data


port storeOnboardingData : { section : String, data : Encode.Value } -> Cmd msg


port getOnboardingData : String -> Cmd msg


port onboardingDataReceived : (Maybe Encode.Value -> msg) -> Sub msg



-- TYPES


type Step
    = PlanSelectionStep
    | UserDetailsStep
    | CompanyDetailsStep
    | LicensingSettingsStep
    | AddAgentsStep
    | PaymentStep
    | EnterpriseFormStep


type alias UserDetails =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    }


userDetailsInit : UserDetails
userDetailsInit =
    { firstName = ""
    , lastName = ""
    , email = ""
    , phone = ""
    }


userDetailsDecoder : Decoder UserDetails
userDetailsDecoder =
    Decode.succeed UserDetails
        |> required "firstName" Decode.string
        |> required "lastName" Decode.string
        |> required "email" Decode.string
        |> required "phone" Decode.string


userDetailsEncoder : UserDetails -> Encode.Value
userDetailsEncoder details =
    Encode.object
        [ ( "firstName", Encode.string details.firstName )
        , ( "lastName", Encode.string details.lastName )
        , ( "email", Encode.string details.email )
        , ( "phone", Encode.string details.phone )
        ]


type alias CompanyDetails =
    { agencyName : String
    , website : String
    , phone : String
    , primaryColor : String
    , secondaryColor : String
    , logo : Maybe String
    }


companyDetailsInit : CompanyDetails
companyDetailsInit =
    { agencyName = ""
    , website = ""
    , phone = ""
    , primaryColor = "#6B46C1"
    , secondaryColor = "#9F7AEA"
    , logo = Nothing
    }


companyDetailsDecoder : Decoder CompanyDetails
companyDetailsDecoder =
    Decode.succeed CompanyDetails
        |> required "agencyName" Decode.string
        |> required "website" Decode.string
        |> optional "phone" Decode.string ""
        |> optional "primaryColor" Decode.string ""
        |> optional "secondaryColor" Decode.string ""
        |> optional "logo" (Decode.nullable Decode.string) Nothing


companyDetailsEncoder : CompanyDetails -> Encode.Value
companyDetailsEncoder details =
    Encode.object
        [ ( "agencyName", Encode.string details.agencyName )
        , ( "website", Encode.string details.website )
        , ( "phone", Encode.string details.phone )
        , ( "primaryColor", Encode.string details.primaryColor )
        , ( "secondaryColor", Encode.string details.secondaryColor )
        , ( "logo"
          , case details.logo of
                Just logoPath ->
                    Encode.string logoPath

                Nothing ->
                    Encode.null
          )
        ]


type alias LicensingSettings =
    { carrierContracts : List String
    , useSmartSendForGI : Bool
    }


licensingSettingsInit : LicensingSettings
licensingSettingsInit =
    { carrierContracts = []
    , useSmartSendForGI = True
    }


licensingSettingsDecoder : Decoder LicensingSettings
licensingSettingsDecoder =
    Decode.succeed LicensingSettings
        |> required "carrierContracts" (Decode.list Decode.string)
        |> required "useSmartSendForGI" Decode.bool


licensingSettingsEncoder : LicensingSettings -> Encode.Value
licensingSettingsEncoder settings =
    Encode.object
        [ ( "carrierContracts", Encode.list Encode.string settings.carrierContracts )
        , ( "useSmartSendForGI", Encode.bool settings.useSmartSendForGI )
        ]


type alias Agent =
    { id : String
    , firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    }


agentInit : Agent
agentInit =
    { id = ""
    , firstName = ""
    , lastName = ""
    , email = ""
    , phone = ""
    , isAdmin = False
    , isAgent = True
    }


agentDecoder : Decoder Agent
agentDecoder =
    Decode.succeed Agent
        |> required "id" Decode.string
        |> required "firstName" Decode.string
        |> required "lastName" Decode.string
        |> required "email" Decode.string
        |> required "phone" Decode.string
        |> required "isAdmin" Decode.bool
        |> optional "isAgent" Decode.bool True


agentEncoder : Agent -> Encode.Value
agentEncoder agent =
    Encode.object
        [ ( "id", Encode.string agent.id )
        , ( "firstName", Encode.string agent.firstName )
        , ( "lastName", Encode.string agent.lastName )
        , ( "email", Encode.string agent.email )
        , ( "phone", Encode.string agent.phone )
        , ( "isAdmin", Encode.bool agent.isAdmin )
        , ( "isAgent", Encode.bool agent.isAgent )
        ]


type alias NewAgentForm =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    }


newAgentInit : NewAgentForm
newAgentInit =
    { firstName = ""
    , lastName = ""
    , email = ""
    , phone = ""
    , isAdmin = False
    , isAgent = True
    }


type alias AddAgents =
    { agents : List Agent
    , newAgent : NewAgentForm
    , agentEmailStatus : EmailStatus
    }


addAgentsInit : AddAgents
addAgentsInit =
    { agents = []
    , newAgent = newAgentInit
    , agentEmailStatus = NotChecked
    }


addAgentsEncoder : AddAgents -> Encode.Value
addAgentsEncoder addAgents =
    Encode.object
        [ ( "agents", Encode.list agentEncoder addAgents.agents ) ]


type EmailStatus
    = NotChecked
    | Checking
    | Valid
    | Invalid String


type alias Payment =
    { paymentSucceeded : Bool
    , paymentError : Maybe String
    , extraAgents : Int
    , extraContacts : Int
    }


paymentInit : Payment
paymentInit =
    { paymentSucceeded = False
    , paymentError = Nothing
    , extraAgents = 0
    , extraContacts = 0
    }


paymentDecoder : Decoder Payment
paymentDecoder =
    Decode.succeed Payment
        |> required "paymentSucceeded" Decode.bool
        |> optional "paymentError" (Decode.nullable Decode.string) Nothing
        |> optional "extraAgents" Decode.int 0
        |> optional "extraContacts" Decode.int 0


paymentEncoder : Payment -> Encode.Value
paymentEncoder payment =
    Encode.object
        [ ( "paymentSucceeded", Encode.bool payment.paymentSucceeded )
        , ( "paymentError"
          , case payment.paymentError of
                Just err ->
                    Encode.string err

                Nothing ->
                    Encode.null
          )
        , ( "extraAgents", Encode.int payment.extraAgents )
        , ( "extraContacts", Encode.int payment.extraContacts )
        ]


type alias EnterpriseForm =
    { enterpriseName : String
    , enterpriseEmail : String
    , enterprisePhone : String
    , message : String
    }


enterpriseFormInit : EnterpriseForm
enterpriseFormInit =
    { enterpriseName = ""
    , enterpriseEmail = ""
    , enterprisePhone = ""
    , message = ""
    }


enterpriseFormDecoder : Decoder EnterpriseForm
enterpriseFormDecoder =
    Decode.succeed EnterpriseForm
        |> required "enterpriseName" Decode.string
        |> required "enterpriseEmail" Decode.string
        |> required "enterprisePhone" Decode.string
        |> required "message" Decode.string


enterpriseFormEncoder : EnterpriseForm -> Encode.Value
enterpriseFormEncoder form =
    Encode.object
        [ ( "enterpriseName", Encode.string form.enterpriseName )
        , ( "enterpriseEmail", Encode.string form.enterpriseEmail )
        , ( "enterprisePhone", Encode.string form.enterprisePhone )
        , ( "message", Encode.string form.message )
        ]


type FormStatus
    = NotSubmitted
    | Submitted
    | SubmittedSuccessfully
    | SubmittedWithError String


type alias OnboardingSession =
    { sessionId : String
    , planType : String
    , currentStep : Int
    }


type alias Model =
    { step : Step
    , userDetails : UserDetails
    , userEmailStatus : EmailStatus
    , companyDetails : CompanyDetails
    , licensingSettings : LicensingSettings
    , addAgents : AddAgents
    , payment : Payment
    , enterpriseForm : EnterpriseForm
    , enterpriseEmailStatus : EmailStatus
    , enterpriseFormStatus : FormStatus
    , session : Maybe OnboardingSession
    , orgSlug : String
    , isBasicPlan : Bool
    , error : Maybe String
    , isLoading : Bool
    , key : Nav.Key
    , stepHistory : List Step
    , subscriptionTiers : List SubscriptionTier
    }


init : Nav.Key -> String -> String -> Step -> ( Model, Cmd Msg )
init key initialOrgSlug sessionToken initialStep =
    let
        model =
            { step = initialStep
            , userDetails = userDetailsInit
            , userEmailStatus = NotChecked
            , companyDetails = companyDetailsInit
            , licensingSettings = licensingSettingsInit
            , addAgents = addAgentsInit
            , payment = paymentInit
            , enterpriseForm = enterpriseFormInit
            , enterpriseEmailStatus = NotChecked
            , enterpriseFormStatus = NotSubmitted
            , session =
                if String.isEmpty sessionToken then
                    Nothing

                else
                    Just { sessionId = sessionToken, planType = "basic", currentStep = 1 }
            , orgSlug = initialOrgSlug
            , isBasicPlan = True
            , error = Nothing
            , isLoading = False
            , key = key
            , stepHistory = []
            , subscriptionTiers = []
            }
    in
    ( model, fetchSubscriptionTiers )


type alias EmailCheckResponse =
    { available : Bool
    , message : String
    }


type alias SaveResponse =
    { success : Bool
    , message : String
    , slug : String
    }


type alias OnboardingSettingsResponse =
    { userDetails : Maybe UserDetails
    , companyDetails : Maybe CompanyDetails
    , licensingSettings : Maybe LicensingSettings
    , agents : Maybe (List Agent)
    , paymentInfo : Maybe Payment
    , enterpriseForm : Maybe EnterpriseForm
    , currentStep : Int
    , planType : String
    }


onboardingSettingsDecoder : Decoder OnboardingSettingsResponse
onboardingSettingsDecoder =
    Decode.succeed OnboardingSettingsResponse
        |> optional "userDetails" (Decode.nullable userDetailsDecoder) Nothing
        |> optional "companyDetails" (Decode.nullable companyDetailsDecoder) Nothing
        |> optional "licensingSettings" (Decode.nullable licensingSettingsDecoder) Nothing
        |> optional "agents" (Decode.nullable (Decode.list agentDecoder)) Nothing
        |> optional "paymentInfo" (Decode.nullable paymentDecoder) Nothing
        |> optional "enterpriseForm" (Decode.nullable enterpriseFormDecoder) Nothing
        |> required "currentStep" Decode.int
        |> required "planType" Decode.string


type
    Msg
    -- Session Management
    = OnboardingCookieReceived (Maybe { sessionId : String, planType : String, step : Int })
    | OnboardingDataReceived (Maybe Encode.Value)
    | FetchOnboardingData String
    | GotOnboardingSettings (Result Http.Error OnboardingSettingsResponse)
    | StartOnboarding String -- planType
    | OnboardingStarted (Result Http.Error { sessionId : String, planType : String, step : Int })
      -- User Details
    | UpdateUserFirstName String
    | UpdateUserLastName String
    | UpdateUserEmail String
    | UserEmailBlurred
    | UserEmailFocused
    | GotUserEmailCheckResponse (Result Http.Error EmailCheckResponse)
    | UpdateUserPhone String
    | SaveUserDetails
    | UserDetailsSaved (Result Http.Error SaveResponse)
      -- Company Details
    | UpdateAgencyName String
    | UpdateWebsite String
    | UpdatePhone String
    | UpdatePrimaryColor String
    | UpdateSecondaryColor String
    | SaveCompanyDetails
    | CompanyDetailsSaved (Result Http.Error SaveResponse)
      -- Licensing Settings
    | AddCarrierContract String
    | RemoveCarrierContract String
    | ToggleSection String
    | ToggleAllCarriers Bool
    | ToggleSmartSendForGI Bool
    | SaveLicensingSettings
    | LicensingSettingsSaved (Result Http.Error SaveResponse)
      -- Add Agents
    | UpdateAgentFirstName String
    | UpdateAgentLastName String
    | UpdateAgentEmail String
    | AgentEmailBlurred
    | AgentEmailFocused
    | UpdateAgentPhone String
    | UpdateAgentCheckbox Bool
    | UpdateAgentRole Bool
    | AddAgent
    | SaveAgent
    | CancelAddAgent
    | GotAgentEmailCheckResponse (Result Http.Error EmailCheckResponse)
    | AgentSaved (Result Http.Error SaveResponse)
      -- Payment
    | UpdateExtraAgents Int
    | UpdateExtraContacts Int
    | CompletePayment
    | PaymentCompleted (Result Http.Error SaveResponse)
      -- Enterprise Form
    | UpdateEnterpriseName String
    | UpdateEnterpriseEmail String
    | UpdateEnterprisePhone String
    | UpdateEnterpriseMessage String
    | SaveEnterpriseForm
    | EnterpriseFormSaved (Result Http.Error SaveResponse)
      -- Navigation
    | NavigateToStep Step
    | NavigateBack
    | SkipStep
    | CompleteOnboarding
    | OnboardingCompleted (Result Http.Error SaveResponse)
    | RandomOrgNameGenerated String
    | ScrollToTop
    | NoOp
      -- Subscription Tiers
    | GotSubscriptionTiers (Result Http.Error (List SubscriptionTier))
    | SelectPlanType String



-- HTTP Fetches


fetchSubscriptionTiers : Cmd Msg
fetchSubscriptionTiers =
    Http.get
        { url = "/api/organizations/subscription-tiers"
        , expect = Http.expectJson GotSubscriptionTiers subscriptionTiersDecoder
        }


subscriptionTiersDecoder : Decoder (List SubscriptionTier)
subscriptionTiersDecoder =
    Decode.field "tiers" <|
        Decode.list
            (Decode.map7 SubscriptionTier
                (Decode.field "id" Decode.string)
                (Decode.field "name" Decode.string)
                (Decode.oneOf
                    [ Decode.field "description" Decode.string
                    , Decode.succeed ""
                    ]
                )
                (Decode.map
                    (\priceStr ->
                        String.replace "$" "" priceStr
                            |> String.replace "/mo" ""
                            |> String.toFloat
                            |> Maybe.withDefault 0
                    )
                    (Decode.field "price" Decode.string)
                )
                (Decode.field "features" (Decode.list Decode.string))
                (Decode.field "agentLimit" Decode.int)
                (Decode.field "contactLimit" Decode.int)
            )


fetchOnboardingSettings : String -> Cmd Msg
fetchOnboardingSettings sessionId =
    Http.request
        { method = "GET"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/settings"
        , body = Http.emptyBody
        , expect = Http.expectJson GotOnboardingSettings onboardingSettingsDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


startOnboarding : String -> Cmd Msg
startOnboarding planType =
    Http.post
        { url = "/api/onboarding/start"
        , body = Http.jsonBody (Encode.object [ ( "planType", Encode.string planType ) ])
        , expect = Http.expectJson OnboardingStarted onboardingSessionDecoder
        }


onboardingSessionDecoder : Decoder { sessionId : String, planType : String, step : Int }
onboardingSessionDecoder =
    Decode.map3 (\id plan step -> { sessionId = id, planType = plan, step = step })
        (Decode.field "sessionId" Decode.string)
        (Decode.field "planType" Decode.string)
        (Decode.field "step" Decode.int)


saveUserDetails : String -> UserDetails -> Cmd Msg
saveUserDetails sessionId userDetails =
    let
        -- Only add the session header if a non-empty session ID is provided
        headers =
            if String.isEmpty sessionId then
                []

            else
                [ Http.header "X-Onboarding-Session" sessionId ]
    in
    Http.request
        { method = "POST"
        , headers = headers
        , url = "/api/onboarding/user-details"
        , body = Http.jsonBody (userDetailsEncoder userDetails)
        , expect = Http.expectJson UserDetailsSaved saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


saveResponseDecoder : Decoder SaveResponse
saveResponseDecoder =
    Decode.map3 SaveResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "message" Decode.string)
        (Decode.oneOf
            [ Decode.field "slug" Decode.string
            , Decode.succeed "" -- Default to empty string if no slug is provided
            ]
        )


saveCompanyDetails : String -> CompanyDetails -> Cmd Msg
saveCompanyDetails sessionId companyDetails =
    let
        -- Only add the session header if a non-empty session ID is provided
        headers =
            if String.isEmpty sessionId then
                []

            else
                [ Http.header "X-Onboarding-Session" sessionId ]
    in
    Http.request
        { method = "POST"
        , headers = headers
        , url = "/api/onboarding/company-details"
        , body = Http.jsonBody (companyDetailsEncoder companyDetails)
        , expect = Http.expectJson CompanyDetailsSaved saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


saveLicensingSettings : String -> LicensingSettings -> Cmd Msg
saveLicensingSettings sessionId licensingSettings =
    let
        -- Only add the session header if a non-empty session ID is provided
        headers =
            if String.isEmpty sessionId then
                []

            else
                [ Http.header "X-Onboarding-Session" sessionId ]
    in
    Http.request
        { method = "POST"
        , headers = headers
        , url = "/api/onboarding/licensing-settings"
        , body = Http.jsonBody (licensingSettingsEncoder licensingSettings)
        , expect = Http.expectJson LicensingSettingsSaved saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


saveAgent : String -> Agent -> Cmd Msg
saveAgent sessionId agent =
    Http.request
        { method = "POST"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/agents"
        , body = Http.jsonBody (agentEncoder agent)
        , expect = Http.expectJson AgentSaved saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


completePayment : String -> Payment -> Cmd Msg
completePayment sessionId payment =
    Http.request
        { method = "POST"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/payment"
        , body = Http.jsonBody (paymentEncoder payment)
        , expect = Http.expectJson PaymentCompleted saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


saveEnterpriseForm : String -> EnterpriseForm -> Cmd Msg
saveEnterpriseForm sessionId form =
    Http.request
        { method = "POST"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/enterprise"
        , body = Http.jsonBody (enterpriseFormEncoder form)
        , expect = Http.expectJson EnterpriseFormSaved saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


completeOnboardingRequest : String -> Cmd Msg
completeOnboardingRequest sessionId =
    Http.request
        { method = "POST"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/complete"
        , body = Http.emptyBody
        , expect = Http.expectJson OnboardingCompleted saveResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


checkEmail : String -> String -> Cmd Msg
checkEmail email endpoint =
    Http.post
        { url = "/api/onboarding/check-email"
        , body = Http.jsonBody (Encode.object [ ( "email", Encode.string email ), ( "endpoint", Encode.string endpoint ) ])
        , expect = Http.expectJson GotUserEmailCheckResponse emailCheckResponseDecoder
        }


emailCheckResponseDecoder : Decoder EmailCheckResponse
emailCheckResponseDecoder =
    Decode.map2 EmailCheckResponse
        (Decode.field "available" Decode.bool)
        (Decode.field "message" Decode.string)


checkAgentEmail : String -> String -> Cmd Msg
checkAgentEmail email sessionId =
    Http.request
        { method = "POST"
        , headers = [ Http.header "X-Onboarding-Session" sessionId ]
        , url = "/api/onboarding/check-agent-email"
        , body = Http.jsonBody (Encode.object [ ( "email", Encode.string email ) ])
        , expect = Http.expectJson GotAgentEmailCheckResponse emailCheckResponseDecoder
        , timeout = Nothing
        , tracker = Nothing
        }



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        -- Session Management
        OnboardingCookieReceived maybeCookie ->
            case maybeCookie of
                Just cookie ->
                    -- If we have a cookie, fetch all onboarding data from the backend
                    let
                        session =
                            { sessionId = cookie.sessionId
                            , planType = cookie.planType
                            , currentStep = cookie.step
                            }

                        isBasicPlan =
                            cookie.planType == "basic"

                        newStep =
                            case cookie.step of
                                1 ->
                                    UserDetailsStep

                                2 ->
                                    CompanyDetailsStep

                                3 ->
                                    LicensingSettingsStep

                                4 ->
                                    AddAgentsStep

                                5 ->
                                    PaymentStep

                                6 ->
                                    EnterpriseFormStep

                                _ ->
                                    PlanSelectionStep
                    in
                    ( { model
                        | session = Just session
                        , isBasicPlan = isBasicPlan
                        , step = newStep
                      }
                    , fetchOnboardingSettings cookie.sessionId
                    )

                Nothing ->
                    -- No cookie, stay on initial step
                    ( model, Cmd.none )

        OnboardingDataReceived maybeData ->
            -- Not used directly, as we use specific endpoints instead of generic data
            ( model, Cmd.none )

        FetchOnboardingData sectionName ->
            -- For now, we'll fetch all settings at once
            case model.session of
                Just session ->
                    ( model, fetchOnboardingSettings session.sessionId )

                Nothing ->
                    ( model, Cmd.none )

        GotOnboardingSettings result ->
            case result of
                Ok settings ->
                    -- Update all models with the retrieved settings
                    let
                        updatedUserDetails =
                            Maybe.withDefault model.userDetails settings.userDetails

                        updatedCompanyDetails =
                            Maybe.withDefault model.companyDetails settings.companyDetails

                        updatedLicensingSettings =
                            Maybe.withDefault model.licensingSettings settings.licensingSettings

                        updatedAddAgents =
                            case settings.agents of
                                Just agents ->
                                    { newAgent = model.addAgents.newAgent
                                    , agents = agents
                                    , agentEmailStatus = NotChecked
                                    }

                                Nothing ->
                                    model.addAgents

                        updatedPayment =
                            Maybe.withDefault model.payment settings.paymentInfo

                        updatedEnterpriseForm =
                            Maybe.withDefault model.enterpriseForm settings.enterpriseForm

                        isBasicPlan =
                            settings.planType == "basic"

                        newStep =
                            case settings.currentStep of
                                1 ->
                                    UserDetailsStep

                                2 ->
                                    CompanyDetailsStep

                                3 ->
                                    LicensingSettingsStep

                                4 ->
                                    AddAgentsStep

                                5 ->
                                    PaymentStep

                                6 ->
                                    EnterpriseFormStep

                                _ ->
                                    PlanSelectionStep

                        -- Update the session if needed
                        updatedSession =
                            case model.session of
                                Just session ->
                                    Just { session | currentStep = settings.currentStep, planType = settings.planType }

                                Nothing ->
                                    model.session
                    in
                    ( { model
                        | userDetails = updatedUserDetails
                        , companyDetails = updatedCompanyDetails
                        , licensingSettings = updatedLicensingSettings
                        , addAgents = updatedAddAgents
                        , payment = updatedPayment
                        , enterpriseForm = updatedEnterpriseForm
                        , isBasicPlan = isBasicPlan
                        , step = newStep
                        , session = updatedSession
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | error = Just "Failed to load onboarding settings.", isLoading = False }, Cmd.none )

        StartOnboarding planType ->
            ( { model | isLoading = True }, startOnboarding planType )

        OnboardingStarted result ->
            case result of
                Ok response ->
                    -- Store the session in a cookie and update the model
                    let
                        session =
                            { sessionId = response.sessionId
                            , planType = response.planType
                            , currentStep = response.step
                            }

                        isBasicPlan =
                            response.planType == "basic"

                        -- Update the cookie
                        cookieCmd =
                            setOnboardingCookie
                                { sessionId = response.sessionId
                                , planType = response.planType
                                , step = response.step
                                }
                    in
                    ( { model
                        | session = Just session
                        , isBasicPlan = isBasicPlan
                        , step = UserDetailsStep
                        , isLoading = False
                      }
                    , Cmd.batch [ cookieCmd, Nav.pushUrl model.key "/onboarding/personal" ]
                    )

                Err _ ->
                    ( { model | error = Just "Failed to start onboarding process.", isLoading = False }, Cmd.none )

        -- User Details
        UpdateUserFirstName firstName ->
            let
                userDetails =
                    model.userDetails
            in
            ( { model | userDetails = { userDetails | firstName = firstName } }, Cmd.none )

        UpdateUserLastName lastName ->
            let
                userDetails =
                    model.userDetails
            in
            ( { model | userDetails = { userDetails | lastName = lastName } }, Cmd.none )

        UpdateUserEmail email ->
            let
                userDetails =
                    model.userDetails
            in
            ( { model | userDetails = { userDetails | email = email }, userEmailStatus = NotChecked }, Cmd.none )

        UserEmailBlurred ->
            -- Check email availability when field loses focus
            if String.length model.userDetails.email > 0 then
                ( { model | userEmailStatus = Checking }, checkEmail model.userDetails.email "user" )

            else
                ( model, Cmd.none )

        UserEmailFocused ->
            -- Reset validation when field gets focus
            ( { model | userEmailStatus = NotChecked }, Cmd.none )

        GotUserEmailCheckResponse result ->
            case result of
                Ok response ->
                    if response.available then
                        ( { model | userEmailStatus = Valid }, Cmd.none )

                    else
                        ( { model | userEmailStatus = Invalid response.message }, Cmd.none )

                Err _ ->
                    ( { model | userEmailStatus = Invalid "Error checking email." }, Cmd.none )

        UpdateUserPhone phone ->
            let
                userDetails =
                    model.userDetails
            in
            ( { model | userDetails = { userDetails | phone = phone } }, Cmd.none )

        SaveUserDetails ->
            -- Always proceed with submitting the form, even without a session
            ( { model | isLoading = True, error = Nothing }
            , case model.session of
                Just session ->
                    saveUserDetails session.sessionId model.userDetails

                Nothing ->
                    -- If no session ID, just call the function without a session ID
                    saveUserDetails "" model.userDetails
            )

        UserDetailsSaved result ->
            case result of
                Ok response ->
                    -- Update the org slug with the one returned from the server
                    let
                        -- Move to the next step
                        nextStep =
                            getNextStep UserDetailsStep model.isBasicPlan

                        -- Store the updated onboarding state in a cookie
                        cookieCmd =
                            case model.session of
                                Just session ->
                                    setOnboardingCookie
                                        { sessionId = session.sessionId
                                        , planType = session.planType
                                        , step = 2 -- UserDetails is step 1, next is 2
                                        }

                                Nothing ->
                                    Cmd.none
                    in
                    ( { model
                        | orgSlug = response.slug
                        , step = nextStep
                        , isLoading = False
                        , stepHistory = model.step :: model.stepHistory
                      }
                    , Cmd.batch [ cookieCmd, Nav.pushUrl model.key (getStepUrl nextStep) ]
                    )

                Err _ ->
                    ( { model | error = Just "Failed to save user details.", isLoading = False }, Cmd.none )

        -- Company Details
        UpdateAgencyName agencyName ->
            let
                companyDetails =
                    model.companyDetails
            in
            ( { model | companyDetails = { companyDetails | agencyName = agencyName } }, Cmd.none )

        UpdateWebsite website ->
            let
                companyDetails =
                    model.companyDetails
            in
            ( { model | companyDetails = { companyDetails | website = website } }, Cmd.none )

        UpdatePhone phone ->
            let
                companyDetails =
                    model.companyDetails
            in
            ( { model | companyDetails = { companyDetails | phone = phone } }, Cmd.none )

        UpdatePrimaryColor color ->
            let
                companyDetails =
                    model.companyDetails
            in
            ( { model | companyDetails = { companyDetails | primaryColor = color } }, Cmd.none )

        UpdateSecondaryColor color ->
            let
                companyDetails =
                    model.companyDetails
            in
            ( { model | companyDetails = { companyDetails | secondaryColor = color } }, Cmd.none )

        SaveCompanyDetails ->
            -- Always proceed with submitting the form, even without a session
            ( { model | isLoading = True, error = Nothing }
            , case model.session of
                Just session ->
                    saveCompanyDetails session.sessionId model.companyDetails

                Nothing ->
                    -- If no session ID, just call the function without a session ID
                    saveCompanyDetails "" model.companyDetails
            )

        CompanyDetailsSaved result ->
            case result of
                Ok _ ->
                    -- Move to the next step
                    let
                        nextStep =
                            getNextStep CompanyDetailsStep model.isBasicPlan

                        -- Store the updated onboarding state in a cookie
                        cookieCmd =
                            case model.session of
                                Just session ->
                                    setOnboardingCookie
                                        { sessionId = session.sessionId
                                        , planType = session.planType
                                        , step = 3 -- Company details is step 2, next is 3
                                        }

                                Nothing ->
                                    Cmd.none
                    in
                    ( { model
                        | step = nextStep
                        , isLoading = False
                        , stepHistory = model.step :: model.stepHistory
                      }
                    , Cmd.batch [ cookieCmd, Nav.pushUrl model.key (getStepUrl nextStep) ]
                    )

                Err error ->
                    let
                        errorMsg =
                            case error of
                                Http.BadUrl url ->
                                    "Invalid URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus code ->
                                    "Server error: " ++ String.fromInt code

                                Http.BadBody message ->
                                    "Data error: " ++ message
                    in
                    ( { model | error = Just ("Failed to save company details: " ++ errorMsg), isLoading = False }, Cmd.none )

        -- Licensing Settings
        AddCarrierContract carrier ->
            let
                settings =
                    model.licensingSettings

                updatedCarriers =
                    if List.member carrier settings.carrierContracts then
                        settings.carrierContracts

                    else
                        carrier :: settings.carrierContracts
            in
            ( { model | licensingSettings = { settings | carrierContracts = updatedCarriers } }, Cmd.none )

        RemoveCarrierContract carrier ->
            let
                settings =
                    model.licensingSettings

                updatedCarriers =
                    List.filter (\c -> c /= carrier) settings.carrierContracts
            in
            ( { model | licensingSettings = { settings | carrierContracts = updatedCarriers } }, Cmd.none )

        ToggleSection _ ->
            -- This is a UI-only change, doesn't affect the model
            ( model, Cmd.none )

        ToggleAllCarriers selected ->
            let
                settings =
                    model.licensingSettings

                newSettings =
                    if selected then
                        { settings | carrierContracts = allCarriers }

                    else
                        { settings | carrierContracts = [] }
            in
            ( { model | licensingSettings = newSettings }, Cmd.none )

        ToggleSmartSendForGI value ->
            let
                settings =
                    model.licensingSettings
            in
            ( { model | licensingSettings = { settings | useSmartSendForGI = value } }, Cmd.none )

        SaveLicensingSettings ->
            -- Always proceed with submitting the form, even without a session
            ( { model | isLoading = True, error = Nothing }
            , case model.session of
                Just session ->
                    saveLicensingSettings session.sessionId model.licensingSettings

                Nothing ->
                    -- If no session ID, just call the function without a session ID
                    saveLicensingSettings "" model.licensingSettings
            )

        LicensingSettingsSaved result ->
            case result of
                Ok _ ->
                    -- Move to the next step, depends on plan type
                    let
                        nextStep =
                            getNextStep LicensingSettingsStep model.isBasicPlan

                        -- Store the updated onboarding state in a cookie
                        cookieCmd =
                            case model.session of
                                Just session ->
                                    setOnboardingCookie
                                        { sessionId = session.sessionId
                                        , planType = session.planType
                                        , step =
                                            if model.isBasicPlan then
                                                5

                                            else
                                                4

                                        -- Skip AgentsStep if basic plan
                                        }

                                Nothing ->
                                    Cmd.none
                    in
                    ( { model
                        | step = nextStep
                        , isLoading = False
                        , stepHistory = model.step :: model.stepHistory
                      }
                    , Cmd.batch [ cookieCmd, Nav.pushUrl model.key (getStepUrl nextStep) ]
                    )

                Err _ ->
                    ( { model | error = Just "Failed to save licensing settings.", isLoading = False }, Cmd.none )

        -- Add Agents
        UpdateAgentFirstName name ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | firstName = name }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent } }, Cmd.none )

        UpdateAgentLastName name ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | lastName = name }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent } }, Cmd.none )

        UpdateAgentEmail email ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | email = email }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent, agentEmailStatus = NotChecked } }, Cmd.none )

        AgentEmailBlurred ->
            -- Check email availability when field loses focus
            let
                agentEmail =
                    model.addAgents.newAgent.email
            in
            if String.length agentEmail > 0 then
                case model.session of
                    Just session ->
                        let
                            addAgents =
                                model.addAgents
                        in
                        ( { model | addAgents = { addAgents | agentEmailStatus = Checking } }
                        , checkAgentEmail agentEmail session.sessionId
                        )

                    Nothing ->
                        ( model, Cmd.none )

            else
                ( model, Cmd.none )

        AgentEmailFocused ->
            -- Reset validation when field gets focus
            let
                addAgents =
                    model.addAgents
            in
            ( { model | addAgents = { addAgents | agentEmailStatus = NotChecked } }, Cmd.none )

        GotAgentEmailCheckResponse result ->
            case result of
                Ok response ->
                    let
                        addAgents =
                            model.addAgents

                        newStatus =
                            if response.available then
                                Valid

                            else
                                Invalid response.message
                    in
                    ( { model | addAgents = { addAgents | agentEmailStatus = newStatus } }, Cmd.none )

                Err _ ->
                    let
                        addAgents =
                            model.addAgents
                    in
                    ( { model | addAgents = { addAgents | agentEmailStatus = Invalid "Error checking email." } }, Cmd.none )

        UpdateAgentPhone phone ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | phone = phone }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent } }, Cmd.none )

        UpdateAgentCheckbox isAdmin ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | isAdmin = isAdmin }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent } }, Cmd.none )

        UpdateAgentRole isAgent ->
            let
                addAgents =
                    model.addAgents

                newAgent =
                    addAgents.newAgent

                updatedNewAgent =
                    { newAgent | isAgent = isAgent }
            in
            ( { model | addAgents = { addAgents | newAgent = updatedNewAgent } }, Cmd.none )

        AddAgent ->
            -- Create a new agent from the form data
            let
                addAgents =
                    model.addAgents

                newAgentForm =
                    addAgents.newAgent

                -- Create a new agent with a temporary ID
                newAgent =
                    { id = String.fromInt (List.length addAgents.agents + 1)
                    , firstName = newAgentForm.firstName
                    , lastName = newAgentForm.lastName
                    , email = newAgentForm.email
                    , phone = newAgentForm.phone
                    , isAdmin = newAgentForm.isAdmin
                    , isAgent = newAgentForm.isAgent
                    }

                updatedAgents =
                    newAgent :: addAgents.agents
            in
            case model.session of
                Just session ->
                    -- Save the agent to the server and then clear the form
                    ( { model | isLoading = True }
                    , saveAgent session.sessionId newAgent
                    )

                Nothing ->
                    -- Just add to the local list and clear the form
                    ( { model | addAgents = { addAgents | agents = updatedAgents, newAgent = newAgentInit } }, Cmd.none )

        SaveAgent ->
            -- Add the current agent being edited
            -- For simplicity, this is the same as AddAgent in this implementation
            update AddAgent model

        CancelAddAgent ->
            -- Clear the form without adding the agent
            let
                addAgents =
                    model.addAgents
            in
            ( { model | addAgents = { addAgents | newAgent = newAgentInit, agentEmailStatus = NotChecked } }, Cmd.none )

        AgentSaved result ->
            case result of
                Ok _ ->
                    -- Refresh the agents list from the server
                    case model.session of
                        Just session ->
                            ( { model | isLoading = False }
                            , fetchOnboardingSettings session.sessionId
                            )

                        Nothing ->
                            -- Just clear the form
                            let
                                addAgents =
                                    model.addAgents
                            in
                            ( { model | isLoading = False, addAgents = { addAgents | newAgent = newAgentInit, agentEmailStatus = NotChecked } }, Cmd.none )

                Err _ ->
                    ( { model | error = Just "Failed to save agent.", isLoading = False }, Cmd.none )

        -- Payment
        UpdateExtraAgents count ->
            let
                payment =
                    model.payment
            in
            ( { model | payment = { payment | extraAgents = count } }, Cmd.none )

        UpdateExtraContacts count ->
            let
                payment =
                    model.payment
            in
            ( { model | payment = { payment | extraContacts = count } }, Cmd.none )

        CompletePayment ->
            case model.session of
                Just session ->
                    ( { model | isLoading = True }
                    , completePayment session.sessionId model.payment
                    )

                Nothing ->
                    ( { model | error = Just "No active session." }, Cmd.none )

        PaymentCompleted result ->
            case result of
                Ok _ ->
                    -- Complete the onboarding process
                    ( { model | isLoading = False }, update CompleteOnboarding model |> Tuple.second )

                Err _ ->
                    ( { model | error = Just "Failed to process payment.", isLoading = False }, Cmd.none )

        -- Enterprise Form
        UpdateEnterpriseName name ->
            let
                form =
                    model.enterpriseForm
            in
            ( { model | enterpriseForm = { form | enterpriseName = name } }, Cmd.none )

        UpdateEnterpriseEmail email ->
            let
                form =
                    model.enterpriseForm
            in
            ( { model | enterpriseForm = { form | enterpriseEmail = email } }, Cmd.none )

        UpdateEnterprisePhone phone ->
            let
                form =
                    model.enterpriseForm
            in
            ( { model | enterpriseForm = { form | enterprisePhone = phone } }, Cmd.none )

        UpdateEnterpriseMessage message ->
            let
                form =
                    model.enterpriseForm
            in
            ( { model | enterpriseForm = { form | message = message } }, Cmd.none )

        SaveEnterpriseForm ->
            case model.session of
                Just session ->
                    ( { model | enterpriseFormStatus = Submitted, isLoading = True }
                    , saveEnterpriseForm session.sessionId model.enterpriseForm
                    )

                Nothing ->
                    ( { model | error = Just "No active session." }, Cmd.none )

        EnterpriseFormSaved result ->
            case result of
                Ok _ ->
                    -- Return to plan selection
                    ( { model
                        | enterpriseFormStatus = SubmittedSuccessfully
                        , isLoading = False
                      }
                    , Nav.pushUrl model.key "/onboarding/plan"
                    )

                Err _ ->
                    ( { model
                        | enterpriseFormStatus = SubmittedWithError "Failed to submit enterprise form."
                        , isLoading = False
                      }
                    , Cmd.none
                    )

        -- Navigation
        NavigateToStep step ->
            -- Handle navigation between steps
            let
                newHistory =
                    model.step :: model.stepHistory
            in
            ( { model | step = step, stepHistory = newHistory }
            , Nav.pushUrl model.key (getStepUrl step)
            )

        NavigateBack ->
            -- Go back to previous step
            case model.stepHistory of
                prevStep :: restHistory ->
                    ( { model | step = prevStep, stepHistory = restHistory }
                    , Nav.pushUrl model.key (getStepUrl prevStep)
                    )

                [] ->
                    -- No history, stay on current step
                    ( model, Cmd.none )

        SkipStep ->
            -- Skip to the next step
            let
                nextStep =
                    getNextStep model.step model.isBasicPlan
            in
            ( { model | step = nextStep, stepHistory = model.step :: model.stepHistory }
            , Nav.pushUrl model.key (getStepUrl nextStep)
            )

        CompleteOnboarding ->
            -- Complete the onboarding process
            case model.session of
                Just session ->
                    ( { model | isLoading = True }
                    , completeOnboardingRequest session.sessionId
                    )

                Nothing ->
                    ( { model | error = Just "No active session." }, Cmd.none )

        OnboardingCompleted result ->
            case result of
                Ok _ ->
                    -- Redirect to login with special parameters
                    ( { model | isLoading = False }
                    , Nav.pushUrl model.key ("/login?onboarding=completed&email=" ++ Url.percentEncode model.userDetails.email)
                    )

                Err _ ->
                    ( { model | error = Just "Failed to complete onboarding.", isLoading = False }, Cmd.none )

        RandomOrgNameGenerated orgName ->
            -- After generating a random organization name, start onboarding with this name
            ( { model | orgSlug = orgName }
            , startOnboarding
                (if model.isBasicPlan then
                    "basic"

                 else
                    "pro"
                )
            )

        ScrollToTop ->
            ( model, Task.perform (\_ -> NoOp) (Dom.setViewport 0 0) )

        NoOp ->
            ( model, Cmd.none )

        -- Subscription Tiers
        GotSubscriptionTiers result ->
            case result of
                Ok tiers ->
                    -- Store the subscription tiers and use them in the UI
                    ( { model | subscriptionTiers = tiers, isLoading = False }, Cmd.none )

                Err _ ->
                    ( { model | error = Just "Failed to load subscription plans.", isLoading = False }, Cmd.none )

        SelectPlanType planType ->
            -- When a plan is selected, set isBasicPlan flag
            ( { model | isBasicPlan = planType == "basic" }, Cmd.none )



-- Helper functions for navigation


getStepUrl : Step -> String
getStepUrl step =
    "/onboarding/"
        ++ (case step of
                PlanSelectionStep ->
                    "plan"

                UserDetailsStep ->
                    "personal"

                CompanyDetailsStep ->
                    "company"

                LicensingSettingsStep ->
                    "licensing"

                AddAgentsStep ->
                    "agents"

                PaymentStep ->
                    "payment"

                EnterpriseFormStep ->
                    "enterprise"
           )


getNextStep : Step -> Bool -> Step
getNextStep currentStep isBasicPlan =
    case currentStep of
        PlanSelectionStep ->
            UserDetailsStep

        UserDetailsStep ->
            CompanyDetailsStep

        CompanyDetailsStep ->
            LicensingSettingsStep

        LicensingSettingsStep ->
            if isBasicPlan then
                -- Skip adding agents for basic plan
                PaymentStep

            else
                AddAgentsStep

        AddAgentsStep ->
            PaymentStep

        PaymentStep ->
            -- Last step, don't advance
            PaymentStep

        EnterpriseFormStep ->
            -- Special case, goes back to plan selection
            PlanSelectionStep



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.batch
        [ onboardingCookieReceived OnboardingCookieReceived
        , onboardingDataReceived OnboardingDataReceived
        ]



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = getStepTitle model.step
    , body =
        [ div []
            [ if model.isLoading then
                -- Show loading spinner when loading
                div [ class "flex justify-center items-center h-screen" ]
                    [ div [ class "animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500" ] [] ]

              else
                div []
                    [ viewHeader model
                    , SetupLayout.view
                        (mapStepToSetupStep model.step)
                        model.isBasicPlan
                        (getStepNumber model.step)
                        [ div [ class "max-w-3xl mx-auto" ]
                            [ case model.error of
                                Just errorMsg ->
                                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" ]
                                        [ text errorMsg ]

                                Nothing ->
                                    text ""
                            , viewCurrentStep model
                            , viewNavigationControls model
                            ]
                        ]
                    ]
            ]
        ]
    }


viewHeader : Model -> Html Msg
viewHeader model =
    header [ class "bg-white shadow" ]
        [ div [ class "max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center justify-between" ]
            [ div [ class "flex items-center" ]
                [ div [ class "flex-shrink-0 mr-4" ]
                    [ if not (String.isEmpty model.companyDetails.agencyName) && String.isEmpty (Maybe.withDefault "" model.companyDetails.logo) then
                        -- If no logo but has company name, show initials
                        div [ class "w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xl" ]
                            [ text (String.left 1 model.companyDetails.agencyName) ]

                      else if not (String.isEmpty (Maybe.withDefault "" model.companyDetails.logo)) then
                        -- If logo exists, show it
                        img [ class "h-10 w-auto", src (Maybe.withDefault "" model.companyDetails.logo), alt "Company Logo" ] []

                      else
                        -- Default Medicare Portal logo
                        div [ class "w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xl" ]
                            [ text "M" ]
                    ]
                ]
            , div [ class "hidden md:block" ]
                [ div [ class "text-sm text-gray-600" ]
                    [ text "Need help? "
                    , a [ href "mailto:support@medicareportal.org", class "text-blue-600 hover:text-blue-800" ]
                        [ text "Contact Support" ]
                    ]
                ]
            ]
        ]


viewCurrentStep : Model -> Html Msg
viewCurrentStep model =
    case model.step of
        PlanSelectionStep ->
            viewPlanSelection model

        UserDetailsStep ->
            viewUserDetails model

        CompanyDetailsStep ->
            viewCompanyDetails model

        LicensingSettingsStep ->
            viewLicensingSettings model

        AddAgentsStep ->
            if model.isBasicPlan then
                div [ class "text-center p-8" ]
                    [ text "This step is not available for the basic plan. Please continue to payment."
                    , div [ class "mt-4" ]
                        [ button
                            [ class "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                            , onClick (NavigateToStep PaymentStep)
                            ]
                            [ text "Continue to Payment" ]
                        ]
                    ]

            else
                viewAddAgents model

        PaymentStep ->
            viewPayment model

        EnterpriseFormStep ->
            viewEnterpriseForm model


viewPlanSelection : Model -> Html Msg
viewPlanSelection model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Choose your plan" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Select a plan that best fits your organization's needs" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div []
                [ div [ class "grid grid-cols-1 md:grid-cols-3 gap-4" ]
                    (if List.isEmpty model.subscriptionTiers then
                        -- Fallback to hardcoded plans if no tiers available
                        [ viewPlanOption
                            "basic"
                            "Basic"
                            "$29/month"
                            [ "1 agent seat"
                            , "Up to 100 clients"
                            , "Medicare Advantage quotes"
                            , "Medicare Supplement quotes"
                            , "PDP quotes"
                            , "Client management"
                            ]
                            1
                            100
                            model.isBasicPlan
                        , viewPlanOption
                            "pro"
                            "Pro"
                            "$99/month"
                            [ "Up to 3 agent seats"
                            , "Up to 1,000 clients"
                            , "Medicare Advantage quotes"
                            , "Medicare Supplement quotes"
                            , "PDP quotes"
                            , "Client management"
                            , "Team collaboration"
                            , "Advanced reporting"
                            , "Email campaigns"
                            ]
                            3
                            1000
                            (not model.isBasicPlan && not (model.step == EnterpriseFormStep))
                        , viewPlanOption
                            "enterprise"
                            "Enterprise"
                            "Contact Us"
                            [ "Custom agent seats"
                            , "Unlimited clients"
                            , "Medicare Advantage quotes"
                            , "Medicare Supplement quotes"
                            , "PDP quotes"
                            , "Client management"
                            , "Team collaboration"
                            , "Advanced reporting"
                            , "Email campaigns"
                            , "Custom integrations"
                            , "Dedicated account manager"
                            , "Priority support"
                            ]
                            -1
                            -1
                            (model.step == EnterpriseFormStep)
                        ]

                     else
                        -- Use tiers from the database
                        List.map
                            (\tier ->
                                viewPlanOption
                                    tier.id
                                    tier.name
                                    (if tier.id == "enterprise" then
                                        "Contact Us"

                                     else
                                        "$" ++ String.fromFloat tier.price ++ "/month"
                                    )
                                    tier.features
                                    tier.maxAgents
                                    tier.maxContacts
                                    (if tier.id == "basic" then
                                        model.isBasicPlan

                                     else if tier.id == "enterprise" then
                                        model.step == EnterpriseFormStep

                                     else
                                        not model.isBasicPlan && not (model.step == EnterpriseFormStep)
                                    )
                            )
                            model.subscriptionTiers
                    )
                , if canAddMoreResources model then
                    viewExtraResources model

                  else
                    text ""
                , if model.error /= Nothing then
                    div [ class "mt-4 text-red-500" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "mt-8 flex justify-center" ]
                    [ button
                        [ class
                            ("px-6 py-3 rounded-lg transition-colors duration-200 "
                                ++ (if not (isPlanBasic model) && not (isPlanPro model) && not (isPlanEnterprise model) then
                                        "bg-[#2563EB]/50 cursor-not-allowed text-white"

                                    else
                                        "bg-[#2563EB] hover:bg-[#1D4ED8] text-white"
                                   )
                            )
                        , onClick
                            (if isPlanEnterprise model then
                                NavigateToStep EnterpriseFormStep

                             else
                                StartOnboarding
                                    (if model.isBasicPlan then
                                        "basic"

                                     else
                                        "pro"
                                    )
                            )
                        , Html.Attributes.disabled (not (isPlanBasic model) && not (isPlanPro model) && not (isPlanEnterprise model))
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewLoading : Html msg
viewLoading =
    div [ class "text-center" ]
        [ div [ class "animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mx-auto" ] []
        , p [ class "mt-4 text-gray-500" ]
            [ text "Loading subscription tiers..." ]
        ]


viewPlanOption : String -> String -> String -> List String -> Int -> Int -> Bool -> Html Msg
viewPlanOption id name price features agentLimit contactLimit isSelected =
    div
        [ class
            ("p-6 rounded-lg cursor-pointer transition-all "
                ++ (if isSelected then
                        "bg-[#2563EB]/10 ring-2 ring-[#2563EB]"

                    else
                        "bg-gray-50 hover:bg-gray-100"
                   )
            )
        , onClick
            (if id == "enterprise" then
                NavigateToStep EnterpriseFormStep

             else
                SelectPlanType id
            )
        ]
        [ div [ class "space-y-4" ]
            [ div []
                [ h3 [ class "text-xl font-semibold text-gray-900" ] [ text name ]
                , p [ class "text-3xl font-bold text-gray-900 mt-2" ]
                    [ text price ]
                ]
            , div [ class "space-y-2 py-4 border-t border-b border-gray-200" ]
                [ if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "5+ agent seats"

                             else if agentLimit == -1 then
                                "Unlimited agent seats"

                             else if agentLimit == 1 then
                                "1 agent seat"

                             else
                                "Up to " ++ String.fromInt agentLimit ++ " agent seats"
                            )
                        ]

                  else
                    div [ class "text-gray-600" ]
                        [ text "Custom agent seats" ]
                , if id /= "enterprise" then
                    div [ class "text-gray-600" ]
                        [ text
                            (if id == "pro" then
                                "5,000+ clients"

                             else if contactLimit == -1 then
                                "Unlimited clients"

                             else if contactLimit == 1000 then
                                "1,000 clients"

                             else
                                "Up to " ++ String.fromInt contactLimit ++ " clients"
                            )
                        ]

                  else
                    div [ class "text-gray-600" ]
                        [ text "Unlimited clients" ]
                ]
            , div [ class "mt-4" ]
                [ p [ class "text-sm font-medium text-gray-900 mb-2" ] [ text "Features:" ]
                , ul [ class "space-y-2" ]
                    (List.map
                        (\feature ->
                            li [ class "flex items-center text-sm text-gray-600" ]
                                [ span [ class "text-[#059669] mr-2" ] [ text "✓" ]
                                , text feature
                                ]
                        )
                        features
                    )
                ]
            ]
        ]


viewExtraResources : Model -> Html Msg
viewExtraResources model =
    div [ class "mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200" ]
        [ h3 [ class "text-lg font-semibold text-gray-900 mb-4" ]
            [ text "Additional Resources" ]
        , div [ class "grid grid-cols-1 md:grid-cols-2 gap-6" ]
            [ div [ class "space-y-2" ]
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Extra Agents" ]
                , p [ class "text-xs text-gray-500" ]
                    [ text "Add more agent seats beyond your plan's included limit ($20/agent seat/month)" ]
                , div [ class "flex items-center" ]
                    [ button
                        [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                        , onClick (UpdateExtraAgents (max 0 (model.payment.extraAgents - 1)))
                        ]
                        [ text "-" ]
                    , input
                        [ type_ "number"
                        , class "w-16 text-center border-y border-gray-200 py-1"
                        , value (String.fromInt model.payment.extraAgents)
                        , onInput (\val -> UpdateExtraAgents (String.toInt val |> Maybe.withDefault 0))
                        ]
                        []
                    , button
                        [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                        , onClick (UpdateExtraAgents (model.payment.extraAgents + 1))
                        ]
                        [ text "+" ]
                    , span [ class "ml-2 text-sm font-medium" ]
                        [ text ("$" ++ String.fromInt (model.payment.extraAgents * 20) ++ "/mo") ]
                    ]
                ]
            , div [ class "space-y-2" ]
                [ label [ class "block text-sm font-medium text-gray-700" ]
                    [ text "Extra Clients" ]
                , p [ class "text-xs text-gray-500" ]
                    [ text "Add more clients beyond your plan's included limit ($50/5,000 clients/month)" ]
                , div [ class "flex items-center" ]
                    [ button
                        [ class "bg-gray-200 px-3 py-1 rounded-l-md hover:bg-gray-300"
                        , onClick (UpdateExtraContacts (max 0 (model.payment.extraContacts - 5000)))
                        ]
                        [ text "-" ]
                    , input
                        [ type_ "number"
                        , class "w-20 text-center border-y border-gray-200 py-1"
                        , value (String.fromInt model.payment.extraContacts)
                        , onInput (\val -> UpdateExtraContacts (String.toInt val |> Maybe.withDefault 0))
                        , Html.Attributes.step "5000"
                        ]
                        []
                    , button
                        [ class "bg-gray-200 px-3 py-1 rounded-r-md hover:bg-gray-300"
                        , onClick (UpdateExtraContacts (model.payment.extraContacts + 5000))
                        ]
                        [ text "+" ]
                    , span [ class "ml-2 text-sm font-medium" ]
                        [ text ("$" ++ String.fromInt (model.payment.extraContacts // 5000 * 50) ++ "/mo") ]
                    ]
                ]
            ]
        ]


viewEnterpriseForm : Model -> Html Msg
viewEnterpriseForm model =
    div [ class "py-8" ]
        [ h2 [ class "text-2xl font-semibold mb-6" ] [ text "Enterprise Inquiry" ]
        , div [ class "bg-white shadow rounded-lg p-6" ]
            [ p [ class "mb-6 text-gray-600" ]
                [ text "Please fill in the details below, and our team will contact you with a customized enterprise quote." ]
            , div [ class "space-y-6" ]
                [ div []
                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "enterpriseName" ] [ text "Company Name" ]
                    , input
                        [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        , id "enterpriseName"
                        , type_ "text"
                        , placeholder "Enter your company name"
                        , value model.enterpriseForm.enterpriseName
                        , onInput UpdateEnterpriseName
                        ]
                        []
                    ]
                , div []
                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "enterpriseEmail" ] [ text "Contact Email" ]
                    , input
                        [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        , id "enterpriseEmail"
                        , type_ "email"
                        , placeholder "Enter your contact email"
                        , value model.enterpriseForm.enterpriseEmail
                        , onInput UpdateEnterpriseEmail
                        ]
                        []
                    ]
                , div []
                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "enterprisePhone" ] [ text "Contact Phone" ]
                    , input
                        [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        , id "enterprisePhone"
                        , type_ "tel"
                        , placeholder "Enter your contact phone"
                        , value model.enterpriseForm.enterprisePhone
                        , onInput UpdateEnterprisePhone
                        ]
                        []
                    ]
                , div []
                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "enterpriseMessage" ] [ text "Additional Information" ]
                    , textarea
                        [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                        , id "enterpriseMessage"
                        , placeholder "Tell us about your needs, team size, and any specific requirements"
                        , value model.enterpriseForm.message
                        , onInput UpdateEnterpriseMessage
                        , Html.Attributes.rows 4
                        ]
                        []
                    ]
                , div [ class "flex space-x-4 mt-6" ]
                    [ button
                        [ class "flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                        , onClick SaveEnterpriseForm
                        ]
                        [ text "Submit Inquiry" ]
                    , button
                        [ class "flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                        , onClick (NavigateToStep PlanSelectionStep)
                        ]
                        [ text "Back to Plans" ]
                    ]
                ]
            , if model.enterpriseFormStatus == SubmittedSuccessfully then
                div [ class "mt-6 p-4 bg-green-100 text-green-700 rounded" ]
                    [ text "Thank you for your inquiry! Our team will contact you shortly." ]

              else if model.enterpriseFormStatus == Submitted then
                div [ class "mt-6 p-4 bg-blue-100 text-blue-700 rounded" ]
                    [ text "Submitting your inquiry..." ]

              else
                text ""
            ]
        ]


viewNavigationControls : Model -> Html Msg
viewNavigationControls model =
    div [ class "flex justify-between mt-8 border-t pt-4" ]
        [ if not (List.isEmpty model.stepHistory) then
            button
                [ class "px-4 py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50"
                , onClick NavigateBack
                ]
                [ text "Back" ]

          else
            div [] []

        -- Empty spacer
        , let
            canSkip =
                case model.step of
                    PlanSelectionStep ->
                        False

                    -- Can't skip plan selection
                    PaymentStep ->
                        False

                    -- Can't skip payment
                    EnterpriseFormStep ->
                        False

                    -- Can't skip enterprise form
                    _ ->
                        True

            -- Can skip other steps
            nextStep =
                getNextStep model.step model.isBasicPlan

            isLastStep =
                model.step == PaymentStep
          in
          if canSkip && not isLastStep then
            button
                [ class "px-4 py-2 text-gray-600 hover:text-gray-800"
                , onClick SkipStep
                ]
                [ text ("Skip to " ++ getStepTitle nextStep) ]

          else
            div [] []

        -- Empty spacer
        ]


mapStepToSetupStep : Step -> SetupLayout.SetupStep
mapStepToSetupStep step =
    case step of
        PlanSelectionStep ->
            SetupLayout.PlanSelection

        UserDetailsStep ->
            SetupLayout.OrganizationSetup

        CompanyDetailsStep ->
            SetupLayout.OrganizationSetup

        LicensingSettingsStep ->
            SetupLayout.OrganizationSetup

        AddAgentsStep ->
            SetupLayout.AgentSetup

        PaymentStep ->
            SetupLayout.OrganizationSetup

        EnterpriseFormStep ->
            SetupLayout.OrganizationSetup


getStepTitle : Step -> String
getStepTitle step =
    case step of
        PlanSelectionStep ->
            "Choose Your Plan"

        UserDetailsStep ->
            "Personal Details"

        CompanyDetailsStep ->
            "Company Details"

        LicensingSettingsStep ->
            "Licensing & Carriers"

        AddAgentsStep ->
            "Add Team Members"

        PaymentStep ->
            "Payment"

        EnterpriseFormStep ->
            "Enterprise Form"


getStepNumber : Step -> Int
getStepNumber step =
    case step of
        PlanSelectionStep ->
            1

        UserDetailsStep ->
            2

        CompanyDetailsStep ->
            3

        LicensingSettingsStep ->
            4

        AddAgentsStep ->
            5

        PaymentStep ->
            6

        EnterpriseFormStep ->
            7


viewUserDetails : Model -> Html Msg
viewUserDetails model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Personal Details" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Tell us about yourself" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "bg-white shadow rounded-lg p-6" ]
                    [ div [ class "space-y-6" ]
                        [ div [ class "grid grid-cols-1 sm:grid-cols-2 gap-6" ]
                            [ div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "First Name" ]
                                , input
                                    [ type_ "text"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value model.userDetails.firstName
                                    , onInput UpdateUserFirstName
                                    , placeholder "Enter your first name"
                                    ]
                                    []
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Last Name" ]
                                , input
                                    [ type_ "text"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value model.userDetails.lastName
                                    , onInput UpdateUserLastName
                                    , placeholder "Enter your last name"
                                    ]
                                    []
                                ]
                            ]
                        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-6 pt-2" ]
                            [ div [ class "relative pb-6" ]
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Email" ]
                                , div [ class "relative" ]
                                    [ input
                                        [ type_ "email"
                                        , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                        , value model.userDetails.email
                                        , onInput UpdateUserEmail
                                        , onFocus UserEmailFocused
                                        , onBlur UserEmailBlurred
                                        , placeholder "you@example.com"
                                        ]
                                        []
                                    , viewEmailStatus model.userEmailStatus
                                    ]
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700" ]
                                    [ text "Phone" ]
                                , input
                                    [ type_ "tel"
                                    , class "mt-1 block w-full px-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                    , value (formatPhoneNumber model.userDetails.phone)
                                    , onInput UpdateUserPhone
                                    , placeholder "(555) 555-5555"
                                    ]
                                    []
                                ]
                            ]
                        ]
                    ]
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class
                            (if isUserDetailsFormValid model then
                                "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"

                             else
                                "px-4 py-2 sm:px-6 sm:py-3 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed"
                            )
                        , onClick SaveUserDetails
                        , Html.Attributes.disabled (not (isUserDetailsFormValid model))
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewEmailStatus : EmailStatus -> Html msg
viewEmailStatus status =
    case status of
        NotChecked ->
            -- When not checked, explicitly render an empty div structure to properly replace any previous status
            div []
                [ div [ class "absolute right-0 inset-y-0" ] [ text "" ]
                , text "" -- Empty text element to replace any error message
                ]

        Checking ->
            -- Show loading spinner while checking
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "animate-spin h-5 w-5 text-blue-500" ]
                            [ text "•" ]

                        -- Simple spinner replacement
                        ]
                    ]
                , text "" -- Empty text element to replace any error message
                ]

        Valid ->
            -- Show only the success icon for available emails
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "text-green-500" ]
                            [ text "✓" ]

                        -- Simple checkmark
                        ]
                    ]
                , text "" -- Empty text element to replace the error message
                ]

        Invalid message ->
            -- For unavailable emails, show icon and error message
            div []
                [ div
                    [ class "absolute right-0 inset-y-0" ]
                    [ div
                        [ class "absolute right-0 inset-y-0 flex items-center pr-3" ]
                        [ div
                            [ class "text-red-500" ]
                            [ text "✗" ]

                        -- Simple X mark
                        ]
                    ]
                , p
                    [ class "text-xs text-red-600 mt-1 absolute left-0 top-full w-full" ]
                    [ text message ]
                ]


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        digits =
            String.filter Char.isDigit phone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "("
            ++ String.left 3 digits
            ++ ") "
            ++ String.slice 3 6 digits
            ++ "-"
            ++ String.dropLeft 6 digits


isUserDetailsFormValid : Model -> Bool
isUserDetailsFormValid model =
    let
        emailValid =
            case model.userEmailStatus of
                Valid ->
                    True

                -- If the email hasn't been checked yet, consider it invalid
                NotChecked ->
                    False

                -- Email is being checked, consider it invalid until check completes
                Checking ->
                    False

                -- Email is unavailable (error state)
                Invalid _ ->
                    False
    in
    not (String.isEmpty (String.trim model.userDetails.firstName))
        && not (String.isEmpty (String.trim model.userDetails.lastName))
        && not (String.isEmpty (String.trim model.userDetails.email))
        && not (String.isEmpty (String.trim model.userDetails.phone))
        && emailValid


viewLicensingSettings : Model -> Html Msg
viewLicensingSettings model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Licensing & Carriers" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Select carrier contracts you currently have" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "bg-white shadow rounded-lg p-6" ]
                    [ div [ class "space-y-6" ]
                        [ div []
                            [ h3 [ class "text-lg font-medium mb-3" ] [ text "Carrier Contracts" ]
                            , div [ class "mb-4 flex items-center" ]
                                [ viewSelectAllCarriers model.licensingSettings ]
                            , div [ class "grid grid-cols-1 md:grid-cols-2 gap-3" ]
                                (List.map
                                    (\carrier ->
                                        viewCarrierCheckbox carrier model.licensingSettings
                                    )
                                    allCarriers
                                )
                            ]
                        , div [ class "mt-4" ]
                            [ label [ class "flex items-center space-x-2 cursor-pointer" ]
                                [ input
                                    [ class "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                    , type_ "checkbox"
                                    , checked model.licensingSettings.useSmartSendForGI
                                    , onCheck ToggleSmartSendForGI
                                    ]
                                    []
                                , span [ class "text-sm font-medium text-gray-700" ] [ text "Use SmartSend for Group Insurance" ]
                                ]
                            ]
                        ]
                    ]
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick SaveLicensingSettings
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewSelectAllCarriers : LicensingSettings -> Html Msg
viewSelectAllCarriers settings =
    label [ class "flex items-center space-x-3 mb-4" ]
        [ input
            [ type_ "checkbox"
            , checked (List.length settings.carrierContracts == List.length allCarriers)
            , onCheck ToggleAllCarriers
            , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            ]
            []
        , span [ class "text-gray-700" ] [ text "Select All Carriers" ]
        ]


viewCarrierCheckbox : String -> LicensingSettings -> Html Msg
viewCarrierCheckbox carrier settings =
    let
        isChecked =
            List.member carrier settings.carrierContracts
    in
    label [ class "flex items-center space-x-2 cursor-pointer p-2 border rounded hover:bg-gray-50" ]
        [ input
            [ class "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            , type_ "checkbox"
            , checked isChecked
            , onClick
                (if isChecked then
                    RemoveCarrierContract carrier

                 else
                    AddCarrierContract carrier
                )
            ]
            []
        , span [ class "text-sm font-medium text-gray-700" ] [ text carrier ]
        ]


viewAddAgents : Model -> Html Msg
viewAddAgents model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Add Team Members" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Add your team members to get started" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "mb-8 bg-white shadow rounded-lg overflow-hidden" ]
                    [ if List.isEmpty model.addAgents.agents then
                        div [ class "p-6 text-center text-gray-500" ]
                            [ text "No team members added yet. Use the form below to add your first team member." ]

                      else
                        div []
                            [ table [ class "min-w-full divide-y divide-gray-200" ]
                                [ thead [ class "bg-gray-50" ]
                                    [ tr []
                                        [ th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ] [ text "Name" ]
                                        , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ] [ text "Email" ]
                                        , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ] [ text "Phone" ]
                                        , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ] [ text "Role" ]
                                        ]
                                    ]
                                , tbody [ class "bg-white divide-y divide-gray-200" ]
                                    (List.map viewAgentRow model.addAgents.agents)
                                ]
                            ]
                    ]
                , div [ class "bg-white shadow rounded-lg p-6" ]
                    [ h3 [ class "text-lg font-medium mb-4" ] [ text "Add New Team Member" ]
                    , div [ class "space-y-4" ]
                        [ div [ class "grid grid-cols-1 md:grid-cols-2 gap-4" ]
                            [ div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "agentFirstName" ] [ text "First Name" ]
                                , input
                                    [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    , id "agentFirstName"
                                    , type_ "text"
                                    , placeholder "First Name"
                                    , value model.addAgents.newAgent.firstName
                                    , onInput UpdateAgentFirstName
                                    ]
                                    []
                                ]
                            , div []
                                [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "agentLastName" ] [ text "Last Name" ]
                                , input
                                    [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    , id "agentLastName"
                                    , type_ "text"
                                    , placeholder "Last Name"
                                    , value model.addAgents.newAgent.lastName
                                    , onInput UpdateAgentLastName
                                    ]
                                    []
                                ]
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "agentEmail" ] [ text "Email" ]
                            , input
                                [ class
                                    ("w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 "
                                        ++ (case model.addAgents.agentEmailStatus of
                                                Valid ->
                                                    "border-green-500"

                                                Invalid _ ->
                                                    "border-red-500"

                                                _ ->
                                                    "border-gray-300"
                                           )
                                    )
                                , id "agentEmail"
                                , type_ "email"
                                , placeholder "Email"
                                , value model.addAgents.newAgent.email
                                , onInput UpdateAgentEmail
                                , onBlur AgentEmailBlurred
                                , onFocus AgentEmailFocused
                                ]
                                []
                            , viewEmailStatus model.addAgents.agentEmailStatus
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "agentPhone" ] [ text "Phone" ]
                            , input
                                [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                , id "agentPhone"
                                , type_ "tel"
                                , placeholder "Phone Number"
                                , value (formatPhoneNumber model.addAgents.newAgent.phone)
                                , onInput UpdateAgentPhone
                                ]
                                []
                            ]
                        , div [ class "flex items-center mt-4" ]
                            [ input
                                [ class "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                , id "adminRole"
                                , type_ "checkbox"
                                , checked model.addAgents.newAgent.isAdmin
                                , onCheck UpdateAgentCheckbox
                                ]
                                []
                            , label [ class "ml-2 block text-sm text-gray-900", for "adminRole" ] [ text "Admin access" ]
                            ]
                        , div [ class "flex space-x-4 mt-6" ]
                            [ button
                                [ class "flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                , onClick AddAgent
                                ]
                                [ text "Add Team Member" ]
                            , button
                                [ class "flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
                                , onClick CancelAddAgent
                                ]
                                [ text "Clear Form" ]
                            ]
                        ]
                    ]
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick SkipStep
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewAgentRow : Agent -> Html Msg
viewAgentRow agent =
    tr []
        [ td [ class "px-6 py-4 whitespace-nowrap" ]
            [ div [ class "text-sm font-medium text-gray-900" ] [ text (agent.firstName ++ " " ++ agent.lastName) ] ]
        , td [ class "px-6 py-4 whitespace-nowrap" ]
            [ div [ class "text-sm text-gray-900" ] [ text agent.email ] ]
        , td [ class "px-6 py-4 whitespace-nowrap" ]
            [ div [ class "text-sm text-gray-900" ] [ text (formatPhoneNumber agent.phone) ] ]
        , td [ class "px-6 py-4 whitespace-nowrap" ]
            [ if agent.isAdmin then
                span [ class "px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800" ] [ text "Admin" ]

              else
                span [ class "px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800" ] [ text "Agent" ]
            ]
        ]


viewCompanyDetails : Model -> Html Msg
viewCompanyDetails model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Company Details" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Tell us about your company" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "bg-white shadow rounded-lg p-6" ]
                    [ div [ class "space-y-6" ]
                        [ div []
                            [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "agencyName" ]
                                [ text "Agency Name" ]
                            , input
                                [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                , id "agencyName"
                                , type_ "text"
                                , placeholder "Enter your agency name"
                                , value model.companyDetails.agencyName
                                , onInput UpdateAgencyName
                                ]
                                []
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "website" ]
                                [ text "Website" ]
                            , input
                                [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                , id "website"
                                , type_ "text"
                                , placeholder "https://example.com"
                                , value model.companyDetails.website
                                , onInput UpdateWebsite
                                ]
                                []
                            ]
                        , div []
                            [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "companyPhone" ]
                                [ text "Company Phone" ]
                            , input
                                [ class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                , id "companyPhone"
                                , type_ "tel"
                                , placeholder "(555) 555-5555"
                                , value (formatPhoneNumber model.companyDetails.phone)
                                , onInput UpdatePhone
                                ]
                                []
                            ]
                        , div [ class "mt-6" ]
                            [ h3 [ class "text-lg font-medium mb-3" ] [ text "Brand Colors" ]
                            , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4" ]
                                [ div []
                                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "primaryColor" ]
                                        [ text "Primary Color" ]
                                    , input
                                        [ class "h-10 w-full cursor-pointer"
                                        , id "primaryColor"
                                        , type_ "color"
                                        , value
                                            (if String.isEmpty model.companyDetails.primaryColor then
                                                "#2563EB"

                                             else
                                                model.companyDetails.primaryColor
                                            )
                                        , onInput UpdatePrimaryColor
                                        ]
                                        []
                                    ]
                                , div []
                                    [ label [ class "block text-sm font-medium text-gray-700 mb-1", for "secondaryColor" ]
                                        [ text "Secondary Color" ]
                                    , input
                                        [ class "h-10 w-full cursor-pointer"
                                        , id "secondaryColor"
                                        , type_ "color"
                                        , value
                                            (if String.isEmpty model.companyDetails.secondaryColor then
                                                "#10B981"

                                             else
                                                model.companyDetails.secondaryColor
                                            )
                                        , onInput UpdateSecondaryColor
                                        ]
                                        []
                                    ]
                                ]
                            ]
                        ]
                    ]
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick SaveCompanyDetails
                        ]
                        [ text "Continue" ]
                    ]
                ]
        ]


viewPayment : Model -> Html Msg
viewPayment model =
    div [ class "space-y-8" ]
        [ div [ class "mb-8" ]
            [ h1 [ class "text-2xl font-semibold text-gray-900" ]
                [ text "Complete Your Subscription" ]
            , p [ class "text-gray-600 mt-2" ]
                [ text "Enter your payment information to complete registration" ]
            ]
        , if model.isLoading then
            viewLoading

          else
            div [ class "space-y-6" ]
                [ div [ class "bg-white shadow rounded-lg overflow-hidden" ]
                    [ div [ class "md:flex" ]
                        [ div [ class "p-6 bg-gray-50 md:w-1/3" ]
                            [ h3 [ class "text-lg font-semibold mb-4" ] [ text "Order Summary" ]
                            , div [ class "space-y-3" ]
                                [ div [ class "flex justify-between" ]
                                    [ span [ class "text-gray-600" ] [ text "Plan Type" ]
                                    , span [ class "font-medium" ]
                                        [ text
                                            (if model.isBasicPlan then
                                                "Basic"

                                             else
                                                "Pro"
                                            )
                                        ]
                                    ]
                                , div [ class "flex justify-between" ]
                                    [ span [ class "text-gray-600" ] [ text "Base Price" ]
                                    , span [ class "font-medium" ]
                                        [ text
                                            (if model.isBasicPlan then
                                                "$29/month"

                                             else
                                                "$99/month"
                                            )
                                        ]
                                    ]
                                , if model.payment.extraAgents > 0 then
                                    div [ class "flex justify-between" ]
                                        [ span [ class "text-gray-600" ]
                                            [ text ("Extra Agents (" ++ String.fromInt model.payment.extraAgents ++ ")") ]
                                        , span [ class "font-medium" ]
                                            [ text ("$" ++ String.fromInt (model.payment.extraAgents * 20) ++ "/month") ]
                                        ]

                                  else
                                    text ""
                                , if model.payment.extraContacts > 0 then
                                    div [ class "flex justify-between" ]
                                        [ span [ class "text-gray-600" ]
                                            [ text ("Extra Clients (" ++ String.fromInt model.payment.extraContacts ++ ")") ]
                                        , span [ class "font-medium" ]
                                            [ text ("$" ++ String.fromInt (model.payment.extraContacts // 5000 * 50) ++ "/month") ]
                                        ]

                                  else
                                    text ""
                                , div [ class "pt-3 mt-3 border-t border-gray-200" ]
                                    [ div [ class "flex justify-between" ]
                                        [ span [ class "font-medium text-gray-900" ] [ text "Total" ]
                                        , span [ class "font-bold text-blue-600" ]
                                            [ text
                                                ("$"
                                                    ++ String.fromInt
                                                        ((if model.isBasicPlan then
                                                            29

                                                          else
                                                            99
                                                         )
                                                            + (model.payment.extraAgents * 20)
                                                            + (model.payment.extraContacts // 5000 * 50)
                                                        )
                                                    ++ "/month"
                                                )
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        , div [ class "p-6 md:w-2/3" ]
                            [ h3 [ class "text-lg font-semibold mb-4" ] [ text "Payment Information" ]
                            , div [ class "space-y-4" ]
                                [ div [ class "mb-4" ]
                                    [ label [ class "block text-sm font-medium text-gray-700 mb-1" ]
                                        [ text "Credit Card" ]
                                    , div [ class "p-4 bg-gray-100 text-center rounded-md" ]
                                        [ text "Credit card form will be displayed here" ]
                                    ]
                                , div [ class "flex items-center mt-6" ]
                                    [ input
                                        [ class "h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                        , id "agreeTerms"
                                        , type_ "checkbox"
                                        , checked False -- Simplified for now, without using the missing field
                                        ]
                                        []
                                    , label [ class "ml-2 block text-sm text-gray-900", for "agreeTerms" ]
                                        [ text "I agree to the "
                                        , a [ class "text-blue-600 hover:underline" ] [ text "Terms of Service" ]
                                        , text " and "
                                        , a [ class "text-blue-600 hover:underline" ] [ text "Privacy Policy" ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                , if model.error /= Nothing then
                    div [ class "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" ]
                        [ text (Maybe.withDefault "" model.error) ]

                  else
                    text ""
                , div [ class "flex justify-center" ]
                    [ button
                        [ class "px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                        , onClick CompletePayment
                        , Html.Attributes.disabled False
                        ]
                        [ text "Complete Registration" ]
                    ]
                ]
        ]



-- Helper functions for checking plan types


isPlanBasic : Model -> Bool
isPlanBasic model =
    model.isBasicPlan


isPlanPro : Model -> Bool
isPlanPro model =
    not model.isBasicPlan && not (model.step == EnterpriseFormStep)


isPlanEnterprise : Model -> Bool
isPlanEnterprise model =
    model.step == EnterpriseFormStep


canAddMoreResources : Model -> Bool
canAddMoreResources model =
    not model.isBasicPlan && model.step /= EnterpriseFormStep



-- CONSTANTS


allCarriers : List String
allCarriers =
    [ "Aetna"
    , "Humana"
    , "UnitedHealthcare"
    , "Cigna"
    , "BlueCross BlueShield"
    , "Kaiser Permanente"
    , "Anthem"
    , "Molina Healthcare"
    ]

================
File: src/Ports.elm
================
port module Ports exposing
    ( checkoutCompleted
    , clearDebugInfo
    , copyToClipboard
    , createContactBasedCheckout
    , getOrgSlug
    , onCopyResult
    , receiveOrgSlug
    , saveDebugInfo
    , viewingPhone
    )

-- Port for requesting the orgSlug from JavaScript


port getOrgSlug : () -> Cmd msg



-- Port for receiving the orgSlug from JavaScript


port receiveOrgSlug : (String -> msg) -> Sub msg



-- Port for copying text to clipboard


port copyToClipboard : String -> Cmd msg



-- Port for receiving copy result from JavaScript


port onCopyResult : (Bool -> msg) -> Sub msg



-- Port for creating a contact-based checkout session


port createContactBasedCheckout : { tier : Int } -> Cmd msg



-- Port for receiving checkout completion result from JavaScript


port checkoutCompleted : ({ success : Bool, error : Maybe String, subscriptionId : Maybe String } -> msg) -> Sub msg



-- Port for saving debug info


port saveDebugInfo : String -> Cmd msg



-- Port for clearing debug info


port clearDebugInfo : () -> Cmd msg



-- Port for tracking when the user is viewing the phone preview


port viewingPhone : (Bool -> msg) -> Sub msg

================
File: src/Profile.elm
================
module Profile exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes as SvgAttr
import Time



-- MODEL


type alias Model =
    { currentUser : Maybe User
    , originalUser : Maybe User -- Store original user data for comparison
    , isLoading : Bool
    , error : Maybe String
    , pendingSave : Bool
    }


type alias User =
    { id : Int
    , email : String
    , firstName : String
    , lastName : String
    , phone : String
    , isAdmin : Bool
    , isAgent : Bool
    , calendarUrl : String
    }


init : () -> ( Model, Cmd Msg )
init _ =
    ( { currentUser = Nothing
      , originalUser = Nothing
      , isLoading = True
      , error = Nothing
      , pendingSave = False
      }
    , fetchCurrentUser
    )



-- UPDATE


type Msg
    = GotCurrentUser (Result Http.Error CurrentUserResponse)
    | UpdateField String String
    | SaveProfile
    | ProfileSaved (Result Http.Error ())
    | NavigateTo String
    | WatchTutorial


type alias CurrentUserResponse =
    { success : Bool
    , user : Maybe User
    }


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GotCurrentUser (Ok response) ->
            ( { model
                | currentUser = response.user
                , originalUser = response.user -- Store original user data
                , isLoading = False
              }
            , Cmd.none
            )

        GotCurrentUser (Err error) ->
            ( { model
                | error = Just "Failed to load profile"
                , isLoading = False
              }
            , Cmd.none
            )

        UpdateField field value ->
            case model.currentUser of
                Just user ->
                    let
                        updatedUser =
                            case field of
                                "firstName" ->
                                    { user | firstName = value }

                                "lastName" ->
                                    { user | lastName = value }

                                "phone" ->
                                    { user | phone = String.filter Char.isDigit value }

                                "calendarUrl" ->
                                    { user | calendarUrl = value }

                                _ ->
                                    user
                    in
                    ( { model | currentUser = Just updatedUser }
                    , Cmd.none
                    )

                Nothing ->
                    ( model, Cmd.none )

        SaveProfile ->
            ( { model | pendingSave = True }
            , case model.currentUser of
                Just user ->
                    saveProfile user

                Nothing ->
                    Cmd.none
            )

        ProfileSaved (Ok _) ->
            ( { model
                | pendingSave = False
                , originalUser = model.currentUser -- Update original user after successful save
              }
            , Cmd.none
            )

        ProfileSaved (Err _) ->
            ( { model
                | pendingSave = False
                , error = Just "Failed to save profile changes"
              }
            , Cmd.none
            )

        NavigateTo path ->
            ( model, Cmd.none )

        WatchTutorial ->
            ( model, Cmd.none )



-- Main.elm will handle the actual navigation
-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Profile"
    , body =
        [ div [ class "min-h-screen bg-gray-50" ]
            [ div [ class "max-w-3xl mx-auto py-6 sm:py-12 px-4 sm:px-6 lg:px-8" ]
                [ h1 [ class "text-3xl font-bold text-gray-900 mb-8" ]
                    [ text "Profile" ]
                , viewContent model
                ]
            ]
        ]
    }


viewContent : Model -> Html Msg
viewContent model =
    if model.isLoading then
        div [ class "flex justify-center items-center h-64" ]
            [ viewSpinner ]

    else
        case model.currentUser of
            Just user ->
                div [ class "bg-white shadow rounded-lg p-6 space-y-6" ]
                    [ div [ class "mb-4 flex justify-end space-x-4" ]
                        [ button
                            [ class "flex items-center text-sm text-blue-600 hover:text-blue-800"
                            , onClick (NavigateTo "/dashboard?payment_success=true")
                            ]
                            [ div [ class "mr-2" ]
                                [ svg
                                    [ SvgAttr.class "h-5 w-5"
                                    , SvgAttr.viewBox "0 0 20 20"
                                    , SvgAttr.fill "currentColor"
                                    ]
                                    [ path
                                        [ SvgAttr.d "M10 12a2 2 0 100-4 2 2 0 000 4z" ]
                                        []
                                    , path
                                        [ SvgAttr.fillRule "evenodd"
                                        , SvgAttr.d "M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z"
                                        , SvgAttr.clipRule "evenodd"
                                        ]
                                        []
                                    ]
                                ]
                            , text "Watch Setup Tutorial"
                            ]
                        , if user.isAdmin then
                            button
                                [ class "flex items-center text-sm text-purple-600 hover:text-purple-800"
                                , onClick (NavigateTo "/change-plan")
                                ]
                                [ div [ class "mr-2" ]
                                    [ svg
                                        [ SvgAttr.class "h-5 w-5"
                                        , SvgAttr.viewBox "0 0 20 20"
                                        , SvgAttr.fill "currentColor"
                                        ]
                                        [ path
                                            [ SvgAttr.d "M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" ]
                                            []
                                        , path
                                            [ SvgAttr.fillRule "evenodd"
                                            , SvgAttr.d "M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                                            , SvgAttr.clipRule "evenodd"
                                            ]
                                            []
                                        ]
                                    ]
                                , text "Subscription & Payments"
                                ]

                          else
                            text ""
                        ]
                    , viewBasicInfo user
                    , viewSaveButton model
                    ]

            Nothing ->
                div [ class "text-center text-gray-600" ]
                    [ text "Failed to load profile" ]


viewBasicInfo : User -> Html Msg
viewBasicInfo user =
    div [ class "space-y-6" ]
        [ div [ class "border-b border-gray-200 pb-4" ]
            [ h2 [ class "text-lg font-medium text-gray-900" ]
                [ text "Basic Information" ]
            ]
        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4" ]
            [ viewField "First Name" "text" user.firstName "firstName"
            , viewField "Last Name" "text" user.lastName "lastName"
            , viewField "Email" "email" user.email "email"
            , viewField "Phone" "tel" user.phone "phone"
            , viewField "Calendar URL" "url" user.calendarUrl "calendarUrl"
            ]
        , viewRoleInfo user
        ]


viewField : String -> String -> String -> String -> Html Msg
viewField label inputType value field =
    div []
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-2" ]
            [ text label ]
        , input
            [ type_ inputType
            , class "mt-1 px-3.5 py-2.5 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100 disabled:text-gray-500"
            , Html.Attributes.value
                (if field == "phone" then
                    formatPhoneNumber value

                 else
                    value
                )
            , onInput (UpdateField field)
            , disabled (field == "email") -- Email cannot be changed
            ]
            []
        ]


viewRoleInfo : User -> Html Msg
viewRoleInfo user =
    if user.isAdmin then
        div [ class "mb-6" ]
            [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
                [ text "Role" ]
            , div [ class "mt-2 text-sm text-gray-500" ]
                [ text "You have administrator privileges" ]
            ]

    else
        text ""


viewSaveButton : Model -> Html Msg
viewSaveButton model =
    div [ class "mt-8 flex justify-center" ]
        [ if model.pendingSave then
            div [ class "px-6 py-3 flex items-center space-x-2" ]
                [ viewSpinner ]

          else
            button
                [ class "px-4 py-2 sm:px-6 sm:py-3 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-blue-600"
                , onClick SaveProfile
                , disabled (not (hasChanges model))
                ]
                [ text "Save Changes" ]
        ]


viewSpinner : Html Msg
viewSpinner =
    div [ class "animate-spin rounded-full h-5 w-5 border-2 border-blue-500 border-t-transparent" ] []



-- HTTP


fetchCurrentUser : Cmd Msg
fetchCurrentUser =
    Http.get
        { url = "/api/me"
        , expect = Http.expectJson GotCurrentUser currentUserResponseDecoder
        }


saveProfile : User -> Cmd Msg
saveProfile user =
    Http.request
        { method = "PUT"
        , headers = []
        , url = "/api/profile"
        , body = Http.jsonBody (encodeUser user)
        , expect = Http.expectWhatever ProfileSaved
        , timeout = Nothing
        , tracker = Nothing
        }



-- DECODERS


currentUserResponseDecoder : Decoder CurrentUserResponse
currentUserResponseDecoder =
    Decode.map2 CurrentUserResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "user" (Decode.nullable userDecoder))


userDecoder : Decoder User
userDecoder =
    Decode.succeed User
        |> Pipeline.required "id" Decode.int
        |> Pipeline.required "email" Decode.string
        |> Pipeline.required "firstName" Decode.string
        |> Pipeline.required "lastName" Decode.string
        |> Pipeline.required "phone" Decode.string
        |> Pipeline.required "is_admin" Decode.bool
        |> Pipeline.required "is_agent" Decode.bool
        |> Pipeline.optional "calendar_url" Decode.string ""



-- ENCODERS


encodeUser : User -> Encode.Value
encodeUser user =
    Encode.object
        [ ( "firstName", Encode.string user.firstName )
        , ( "lastName", Encode.string user.lastName )
        , ( "email", Encode.string user.email )
        , ( "phone", Encode.string user.phone )
        , ( "calendar_url", Encode.string user.calendarUrl )
        ]



-- HELPERS


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        digits =
            String.filter Char.isDigit phone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "("
            ++ String.left 3 digits
            ++ ") "
            ++ String.slice 3 6 digits
            ++ "-"
            ++ String.dropLeft 6 digits


formatRole : User -> String
formatRole user =
    if user.isAdmin && user.isAgent then
        "Admin"

    else if user.isAdmin then
        "Admin"

    else if user.isAgent then
        "Agent"

    else
        "User"


isAgent : User -> Bool
isAgent user =
    user.isAgent



-- Add this helper function to check for changes


hasChanges : Model -> Bool
hasChanges model =
    case ( model.currentUser, model.originalUser ) of
        ( Just current, Just original ) ->
            current.firstName
                /= original.firstName
                || current.lastName
                /= original.lastName
                || current.phone
                /= original.phone

        _ ->
            False



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/Quote.elm
================
module Quote exposing (Model, Msg(..), init, subscriptions, update, view)

import AgeCalc exposing (getAgeNextMonth)
import Browser
import Browser.Navigation as Nav
import Date exposing (Date)
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput, onSubmit)
import Http
import Json.Decode as D
import Task
import Time
import Url.Builder as Builder
import Url.Parser as Parser exposing ((<?>), Parser)
import Url.Parser.Query as Query


type alias Model =
    { zipCode : String
    , dateOfBirth : String
    , key : Nav.Key
    , tobacco : Bool
    , gender : String
    , currentDate : Maybe Date
    , quoteId : Maybe String
    , error : Maybe String
    , currentCarrier : Maybe String
    , planType : Maybe String
    , state : Maybe String
    , counties : List String
    , selectedCounty : Maybe String
    , isLoadingZipData : Bool
    , zipError : Maybe String
    , orgId : Maybe String
    }


type Msg
    = UpdateZipCode String
    | UpdateDateOfBirth String
    | UpdateTobacco String
    | UpdateGender String
    | SubmitForm
    | GotCurrentDate Date
    | GotQuoteInfo (Result Http.Error QuoteInfo)
    | GotZipInfo (Result Http.Error ZipInfo)
    | UpdateSelectedCounty String


type alias InitialValues =
    { zipCode : Maybe String
    , dateOfBirth : Maybe String
    , tobacco : Maybe Bool
    , gender : Maybe String
    , quoteId : Maybe String
    , planType : Maybe String
    , orgId : Maybe String
    }


type alias QuoteInfo =
    { zipCode : String
    , dateOfBirth : String
    , tobacco : Bool
    , gender : String
    , currentCarrier : Maybe String
    , orgId : String
    }


type alias ZipInfo =
    { state : String
    , counties : List String
    }


init : Nav.Key -> InitialValues -> ( Model, Cmd Msg )
init key initialValues =
    let
        model =
            { zipCode = Maybe.withDefault "" initialValues.zipCode
            , dateOfBirth = Maybe.withDefault "" initialValues.dateOfBirth
            , key = key
            , tobacco = Maybe.withDefault False initialValues.tobacco
            , gender = Maybe.withDefault "M" initialValues.gender
            , currentDate = Nothing
            , quoteId = initialValues.quoteId
            , error = Nothing
            , currentCarrier = Nothing
            , planType = initialValues.planType
            , state = Nothing
            , counties = []
            , selectedCounty = Nothing
            , isLoadingZipData = False
            , zipError = Nothing
            , orgId = initialValues.orgId
            }

        commands =
            [ Task.perform GotCurrentDate Date.today
            , case initialValues.quoteId of
                Just id ->
                    fetchQuoteInfo id

                Nothing ->
                    Cmd.none
            ]
                ++ (if String.length model.zipCode == 5 then
                        [ fetchZipInfo model.zipCode ]

                    else
                        []
                   )
    in
    ( model, Cmd.batch commands )


fetchQuoteInfo : String -> Cmd Msg
fetchQuoteInfo quoteId =
    Http.get
        { url = "/api/quotes/decode/" ++ quoteId
        , expect = Http.expectJson GotQuoteInfo quoteInfoDecoder
        }


fetchZipInfo : String -> Cmd Msg
fetchZipInfo zipCode =
    Http.get
        { url = "/api/zipinfo/" ++ zipCode
        , expect = Http.expectJson GotZipInfo zipInfoDecoder
        }


quoteInfoDecoder : D.Decoder QuoteInfo
quoteInfoDecoder =
    D.field "success" D.bool
        |> D.andThen
            (\success ->
                if success then
                    D.map6 QuoteInfo
                        (D.at [ "contact", "zipCode" ] D.string)
                        (D.at [ "contact", "dateOfBirth" ] D.string)
                        (D.at [ "contact", "tobacco" ] D.bool)
                        (D.at [ "contact", "gender" ] D.string)
                        (D.at [ "contact", "currentCarrier" ] (D.nullable D.string))
                        (D.field "orgId" D.string)

                else
                    D.field "error" D.string
                        |> D.andThen (\error -> D.fail error)
            )


zipInfoDecoder : D.Decoder ZipInfo
zipInfoDecoder =
    D.field "success" D.bool
        |> D.andThen
            (\success ->
                if success then
                    D.field "data"
                        (D.map2 ZipInfo
                            (D.field "state" D.string)
                            (D.field "counties" (D.list D.string))
                        )

                else
                    D.field "error" D.string
                        |> D.andThen (\error -> D.fail error)
            )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateZipCode zip ->
            let
                filteredZip =
                    String.filter Char.isDigit zip |> String.left 5

                cmd =
                    if String.length filteredZip == 5 && filteredZip /= model.zipCode then
                        fetchZipInfo filteredZip

                    else
                        Cmd.none
            in
            ( { model
                | zipCode = filteredZip
                , isLoadingZipData = String.length filteredZip == 5 && filteredZip /= model.zipCode
                , state =
                    if String.length filteredZip /= 5 then
                        Nothing

                    else
                        model.state
                , counties =
                    if String.length filteredZip /= 5 then
                        []

                    else
                        model.counties
                , selectedCounty =
                    if String.length filteredZip /= 5 then
                        Nothing

                    else
                        model.selectedCounty
                , zipError = Nothing
              }
            , cmd
            )

        UpdateDateOfBirth dob ->
            ( { model | dateOfBirth = dob }, Cmd.none )

        UpdateTobacco value ->
            ( { model | tobacco = value == "true" }, Cmd.none )

        UpdateGender value ->
            ( { model | gender = value }, Cmd.none )

        GotCurrentDate date ->
            ( { model | currentDate = Just date }, Cmd.none )

        GotQuoteInfo result ->
            case result of
                Ok quoteInfo ->
                    let
                        updatedModel =
                            { model
                                | zipCode = quoteInfo.zipCode
                                , dateOfBirth = quoteInfo.dateOfBirth
                                , tobacco = quoteInfo.tobacco
                                , gender = quoteInfo.gender
                                , currentCarrier = quoteInfo.currentCarrier
                                , orgId = Just quoteInfo.orgId
                            }

                        cmd =
                            if String.length quoteInfo.zipCode == 5 then
                                fetchZipInfo quoteInfo.zipCode

                            else
                                Cmd.none
                    in
                    ( updatedModel, cmd )

                Err err ->
                    let
                        errorMessage =
                            case err of
                                Http.BadBody errorBody ->
                                    if String.contains "Contact not found" errorBody then
                                        "Quote not found or expired. Please try again or contact support."

                                    else
                                        "Failed to load quote information: " ++ errorBody

                                Http.BadStatus 404 ->
                                    "Quote not found or expired. Please try again or contact support."

                                _ ->
                                    "Failed to load quote information. Please try again."
                    in
                    ( { model | error = Just errorMessage }, Cmd.none )

        GotZipInfo result ->
            case result of
                Ok zipInfo ->
                    let
                        -- Always select the first county as default
                        selectedCounty =
                            List.head zipInfo.counties
                    in
                    ( { model
                        | state = Just zipInfo.state
                        , counties = zipInfo.counties
                        , selectedCounty = selectedCounty
                        , isLoadingZipData = False
                        , zipError = Nothing
                      }
                    , Cmd.none
                    )

                Err error ->
                    ( { model
                        | state = Nothing
                        , counties = []
                        , selectedCounty = Nothing
                        , isLoadingZipData = False
                        , zipError = Just (httpErrorToString error)
                      }
                    , Cmd.none
                    )

        UpdateSelectedCounty county ->
            ( { model | selectedCounty = Just county }, Cmd.none )

        SubmitForm ->
            if String.length model.zipCode /= 5 then
                ( { model | zipError = Just "Please enter a valid 5-digit zip code" }, Cmd.none )

            else if model.state == Nothing then
                ( { model | zipError = Just "Unable to determine state from zip code" }, Cmd.none )

            else
                let
                    age =
                        case model.currentDate of
                            Just currentDate ->
                                getAgeNextMonth model.dateOfBirth currentDate
                                    |> String.fromInt

                            Nothing ->
                                "65"

                    -- Get the selected county or the first one from the list
                    county =
                        case model.selectedCounty of
                            Just c ->
                                c

                            Nothing ->
                                List.head model.counties
                                    |> Maybe.withDefault ""

                    state =
                        model.state
                            |> Maybe.withDefault ""

                    -- If we have a quoteId, use that for navigation first
                    compareUrl =
                        case model.quoteId of
                            Just id ->
                                -- When we have a quoteId, we don't need other parameters
                                Builder.absolute [ "compare" ] [ Builder.string "id" id ]

                            Nothing ->
                                -- Otherwise build the URL with all parameters
                                Builder.absolute [ "compare" ]
                                    ([ Builder.string "zip" model.zipCode
                                     , Builder.string "state" state
                                     , Builder.string "county" county
                                     , Builder.string "gender" model.gender
                                     , Builder.string "tobacco"
                                        (if model.tobacco then
                                            "true"

                                         else
                                            "false"
                                        )
                                     , Builder.string "age" age
                                     , Builder.string "dateOfBirth" model.dateOfBirth
                                     ]
                                        ++ (case model.currentCarrier of
                                                Just carrier ->
                                                    [ Builder.string "currentCarrier" carrier ]

                                                Nothing ->
                                                    []
                                           )
                                        ++ (case model.planType of
                                                Just planType ->
                                                    [ Builder.string "planType" planType ]

                                                Nothing ->
                                                    [ Builder.string "planType" "G" ]
                                            -- Default to G if no plan type provided
                                           )
                                    )
                in
                ( model
                , Nav.pushUrl model.key compareUrl
                )


view : Model -> Browser.Document Msg
view model =
    { title = "Get Your Quote - Medicare Max"
    , body =
        [ div [ class "container mx-auto px-4 py-6 sm:py-8 max-w-xl" ]
            [ h1 [ class "text-2xl sm:text-3xl font-bold text-center mb-4 sm:mb-6" ]
                [ text "Get Your Quote" ]
            , div [ class "flex justify-center mb-6 sm:mb-8" ]
                [ button
                    [ class "flex items-center gap-1 sm:gap-2 px-3 sm:px-4 py-1.5 sm:py-2 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-50 transition-colors text-sm"
                    ]
                    [ span [ class "text-xs sm:text-sm" ] [ text "▶ Video" ]
                    , text "Rates and Plan Options"
                    ]
                ]
            , if model.error /= Nothing || (model.quoteId /= Nothing && String.isEmpty model.zipCode) then
                -- Show error or loading message when we have a quoteId but no data yet
                let
                    message =
                        case model.error of
                            Just error ->
                                div [ class "bg-red-100 border border-red-400 text-red-700 px-3 sm:px-4 py-2 sm:py-3 rounded mb-4 text-sm" ]
                                    [ text error ]

                            Nothing ->
                                if model.quoteId /= Nothing && String.isEmpty model.zipCode then
                                    div [ class "bg-blue-100 border border-blue-400 text-blue-700 px-3 sm:px-4 py-2 sm:py-3 rounded mb-4 text-sm" ]
                                        [ text "Loading your quote information..." ]

                                else
                                    text ""
                in
                div [] [ message, viewFormForManualEntry model ]

              else
                -- Standard form
                Html.form [ onSubmit SubmitForm, class "space-y-4 sm:space-y-6" ]
                    [ viewFormInput "Zip Code" "text" model.zipCode UpdateZipCode True

                    -- Show zip code loading state or error if any
                    , if model.isLoadingZipData then
                        div [ class "text-xs sm:text-sm text-blue-600" ]
                            [ text "Looking up location..." ]

                      else if model.zipError /= Nothing then
                        div [ class "text-xs sm:text-sm text-red-600" ]
                            [ text (Maybe.withDefault "Invalid zip code" model.zipError) ]

                      else
                        text ""

                    -- Only show the county dropdown if there are multiple counties
                    , if List.length model.counties > 1 then
                        viewCountyDropdown model.counties model.selectedCounty

                      else
                        text ""
                    , viewFormInput "Date of Birth" "date" model.dateOfBirth UpdateDateOfBirth True
                    , viewFormRadioGroup "Tobacco User"
                        (if model.tobacco then
                            "true"

                         else
                            "false"
                        )
                        UpdateTobacco
                        [ ( "true", "Yes" ), ( "false", "No" ) ]
                    , viewFormRadioGroup "Gender"
                        model.gender
                        UpdateGender
                        [ ( "M", "Male" ), ( "F", "Female" ) ]
                    , button
                        [ class "w-full bg-purple-600 text-white py-3 sm:py-4 rounded-lg hover:bg-purple-700 transition-colors mt-6 sm:mt-8 text-base sm:text-lg"
                        , type_ "submit"
                        ]
                        [ text "Next" ]
                    ]
            ]
        ]
    }


viewCountyDropdown : List String -> Maybe String -> Html Msg
viewCountyDropdown counties selectedCounty =
    div [ class "form-group" ]
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-1.5 sm:mb-2" ]
            [ text "County" ]
        , select
            [ class "w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-white border-[2px] sm:border-[2.5px] border-purple-300 rounded-lg text-gray-700 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 text-sm sm:text-base"
            , onInput UpdateSelectedCounty
            , required True
            ]
            (option [ value "", disabled True, selected (selectedCounty == Nothing) ]
                [ text "Select your county" ]
                :: List.map
                    (\county ->
                        option
                            [ value county
                            , selected (selectedCounty == Just county)
                            ]
                            [ text county ]
                    )
                    counties
            )
        ]


viewFormInput : String -> String -> String -> (String -> Msg) -> Bool -> Html Msg
viewFormInput labelText inputType inputValue msg isRequired =
    div [ class "form-group" ]
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-1.5 sm:mb-2" ]
            [ text labelText ]
        , if inputType == "date" then
            input
                [ type_ inputType
                , class "w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-white border-[2px] sm:border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 text-sm sm:text-base"
                , Html.Attributes.value inputValue
                , onInput msg
                , required isRequired
                ]
                []

          else if labelText == "Zip Code" then
            input
                [ type_ inputType
                , class "w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-white border-[2px] sm:border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 text-sm sm:text-base"
                , Html.Attributes.value (formatZipCode inputValue)
                , onInput msg
                , required isRequired
                , Html.Attributes.maxlength 5
                , Html.Attributes.pattern "[0-9]*"
                ]
                []

          else
            input
                [ type_ inputType
                , class "w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-white border-[2px] sm:border-[2.5px] border-purple-300 rounded-lg text-gray-700 placeholder-gray-400 shadow-sm hover:border-purple-400 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 focus:bg-white transition-all duration-200 text-sm sm:text-base"
                , Html.Attributes.value inputValue
                , onInput msg
                , required isRequired
                ]
                []
        ]


viewFormRadioGroup : String -> String -> (String -> Msg) -> List ( String, String ) -> Html Msg
viewFormRadioGroup labelText selectedValue msg options =
    div [ class "form-group" ]
        [ Html.label [ class "block text-sm font-medium text-gray-700 mb-1.5 sm:mb-2" ]
            [ text labelText ]
        , div [ class "flex flex-col sm:flex-row gap-2 sm:gap-4 w-full" ]
            (List.map
                (\( val, txt ) ->
                    label
                        [ class
                            ("flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg border-2 cursor-pointer transition-all duration-200 flex-1 "
                                ++ (if selectedValue == val then
                                        "border-purple-500 bg-purple-50 text-purple-700"

                                    else
                                        "border-gray-200 hover:border-purple-200"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value val
                            , checked (selectedValue == val)
                            , onInput msg
                            , class "sr-only"
                            ]
                            []
                        , text txt
                        ]
                )
                options
            )
        ]


formatZipCode : String -> String
formatZipCode zip =
    String.filter Char.isDigit zip |> String.left 5


httpErrorToString : Http.Error -> String
httpErrorToString error =
    case error of
        Http.BadUrl url ->
            "Bad URL: " ++ url

        Http.Timeout ->
            "Request timed out"

        Http.NetworkError ->
            "Network error"

        Http.BadStatus statusCode ->
            "Bad status: " ++ String.fromInt statusCode

        Http.BadBody message ->
            "Data error: " ++ message


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none



-- Function to display a form that allows manual entry when quote loading fails


viewFormForManualEntry : Model -> Html Msg
viewFormForManualEntry model =
    div []
        [ p [ class "text-center text-gray-600 mb-6" ]
            [ text "You can manually enter your information below to get a quote." ]
        , Html.form [ onSubmit SubmitForm, class "space-y-4 sm:space-y-6" ]
            [ viewFormInput "Zip Code" "text" model.zipCode UpdateZipCode True
            , viewFormInput "Date of Birth" "date" model.dateOfBirth UpdateDateOfBirth True
            , viewFormRadioGroup "Tobacco User"
                (if model.tobacco then
                    "true"

                 else
                    "false"
                )
                UpdateTobacco
                [ ( "true", "Yes" ), ( "false", "No" ) ]
            , viewFormRadioGroup "Gender"
                model.gender
                UpdateGender
                [ ( "M", "Male" ), ( "F", "Female" ) ]
            , button
                [ class "w-full bg-purple-600 text-white py-3 sm:py-4 rounded-lg hover:bg-purple-700 transition-colors mt-6 sm:mt-8 text-base sm:text-lg"
                , type_ "submit"
                ]
                [ text "Next" ]
            ]
        ]

================
File: src/QuoteBirthdayRules.elm
================
module QuoteBirthdayRules exposing
    ( PlanRestriction(..)
    , canPresentPlan
    , getQuotePlanRestriction
    )

{-| This module handles birthday rule restrictions for the quote page.
It determines which plans can be presented based on the contact's state and current plan.
-}

import BirthdayRules exposing (canPresentDifferentPlanOnly, isInBirthdayRuleWindow)
import Date exposing (Date)


{-| Represents the plan restriction for a quote.
-}
type PlanRestriction
    = NoRestriction
    | DifferentPlanOnly
    | NoQuoteAllowed


{-| Determines which plans can be presented based on the contact's state, birth date, and current plan.
-}
getQuotePlanRestriction : String -> Date -> Date -> String -> PlanRestriction
getQuotePlanRestriction state birthDate currentDate currentPlan =
    if isInBirthdayRuleWindow state birthDate currentDate then
        if canPresentDifferentPlanOnly state then
            DifferentPlanOnly

        else
            NoQuoteAllowed

    else
        NoRestriction


{-| Checks if a plan can be presented based on the restriction and the contact's current plan.
-}
canPresentPlan : PlanRestriction -> String -> String -> Bool
canPresentPlan restriction currentPlan planToPresent =
    case restriction of
        NoRestriction ->
            True

        NoQuoteAllowed ->
            False

        DifferentPlanOnly ->
            -- Only allow presenting a different plan type
            -- For example, if current plan is "Plan G", only allow "Plan N" and vice versa
            case ( currentPlan, planToPresent ) of
                ( "Plan G", "Plan N" ) ->
                    True

                ( "G", "Plan N" ) ->
                    True

                ( "G", "N" ) ->
                    True

                ( "Plan G", "N" ) ->
                    True

                ( "Plan N", "Plan G" ) ->
                    True

                ( "N", "Plan G" ) ->
                    True

                ( "N", "G" ) ->
                    True

                ( "Plan N", "G" ) ->
                    True

                _ ->
                    False

================
File: src/Schedule.elm
================
module Schedule exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick, onInput, onSubmit)
import Http
import Json.Decode as D
import Json.Encode as E
import List.Extra
import MyIcon
import Svg
import Svg.Attributes as SvgAttr
import Url
import Utils.QuoteHeader exposing (viewHeader)


type EligibilityStatus
    = Accept
    | Decline
    | Generic


type alias OrgInfo =
    { orgName : Maybe String
    , orgLogo : Maybe String
    , orgSlug : String
    }


type alias AgentInfo =
    { name : String
    , firstName : String
    , phone : String
    }


type alias ContactInfo =
    { email : String
    , firstName : String
    , lastName : String
    , phoneNumber : String
    }


type alias ScheduleInfo =
    { contact : ContactInfo
    , organization : OrgInfo
    , agent : AgentInfo
    }


type alias Model =
    { name : Maybe String
    , email : Maybe String
    , phoneNumber : Maybe String
    , isSubmitting : Bool
    , isSubmittingAEP : Bool
    , isSubmittingFollowUp : Bool
    , error : Maybe String
    , success : Bool
    , quoteId : Maybe String
    , key : Nav.Key
    , status : EligibilityStatus
    , redirectUrl : Maybe String
    , scheduleInfo : Maybe ScheduleInfo
    , isLoading : Bool
    }


type Msg
    = UpdateName String
    | UpdateEmail String
    | UpdatePhoneNumber String
    | SubmitForm
    | GotSubmitResponse (Result Http.Error SubmitResponse)
    | GotScheduleInfo (Result Http.Error ScheduleInfo)
    | RequestAEP
    | GotAEPResponse (Result Http.Error SubmitResponse)
    | RequestFollowUp
    | GotFollowUpResponse (Result Http.Error SubmitResponse)
    | CalendlyOpened


type alias SubmitResponse =
    { success : Bool
    , message : String
    }


init : Nav.Key -> Maybe String -> Maybe String -> ( Model, Cmd Msg )
init key maybeQuoteId maybeStatus =
    let
        status =
            case maybeStatus of
                Just "accept" ->
                    Accept

                Just "decline" ->
                    Decline

                _ ->
                    Generic

        commands =
            case maybeQuoteId of
                Just quoteId ->
                    [ Http.get
                        { url = "/api/schedule/info/" ++ quoteId
                        , expect = Http.expectJson GotScheduleInfo scheduleInfoDecoder
                        }
                    ]

                Nothing ->
                    []
    in
    ( { name = Nothing
      , email = Nothing
      , phoneNumber = Nothing
      , isSubmitting = False
      , isSubmittingAEP = False
      , isSubmittingFollowUp = False
      , error = Nothing
      , success = False
      , quoteId = maybeQuoteId
      , key = key
      , status = status
      , redirectUrl = Just "https://calendly.com/medicareschool-max/30min"
      , scheduleInfo = Nothing
      , isLoading = True
      }
    , Cmd.batch commands
    )


contactInfoDecoder : D.Decoder ContactInfo
contactInfoDecoder =
    D.map4 ContactInfo
        (D.field "email" D.string)
        (D.field "firstName" D.string)
        (D.field "lastName" D.string)
        (D.field "phoneNumber" D.string)


agentInfoDecoder : D.Decoder AgentInfo
agentInfoDecoder =
    D.map3 AgentInfo
        (D.field "name" D.string)
        (D.field "firstName" D.string)
        (D.field "phone" D.string)


orgInfoDecoder : D.Decoder OrgInfo
orgInfoDecoder =
    D.map3 OrgInfo
        (D.at [ "name" ] (D.nullable D.string))
        (D.at [ "logo" ] (D.nullable D.string))
        (D.at [ "slug" ] D.string)


scheduleInfoDecoder : D.Decoder ScheduleInfo
scheduleInfoDecoder =
    D.map3 ScheduleInfo
        (D.field "contact" contactInfoDecoder)
        (D.field "organization" orgInfoDecoder)
        (D.field "agent" agentInfoDecoder)


submitResponseDecoder : D.Decoder SubmitResponse
submitResponseDecoder =
    D.map2 SubmitResponse
        (D.field "success" D.bool)
        (D.field "message" D.string)


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateName name ->
            ( { model | name = Just name }, Cmd.none )

        UpdateEmail email ->
            ( { model | email = Just email }, Cmd.none )

        UpdatePhoneNumber phoneNumber ->
            ( { model | phoneNumber = Just (stripPhoneNumber phoneNumber) }, Cmd.none )

        SubmitForm ->
            ( { model | isSubmitting = True }
            , Http.post
                { url = "/api/contact-request"
                , body = Http.jsonBody (encodeForm model)
                , expect = Http.expectJson GotSubmitResponse submitResponseDecoder
                }
            )

        GotSubmitResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | isSubmitting = False, success = True }
                        , Cmd.none
                        )

                    else
                        ( { model | isSubmitting = False, error = Just response.message }
                        , Cmd.none
                        )

                Err _ ->
                    ( { model | isSubmitting = False, error = Just "Failed to submit form. Please try again." }
                    , Cmd.none
                    )

        GotScheduleInfo result ->
            case result of
                Ok info ->
                    ( { model
                        | scheduleInfo = Just info
                        , email = Just info.contact.email
                        , name = Just (info.contact.firstName ++ " " ++ info.contact.lastName)
                        , phoneNumber = Just info.contact.phoneNumber
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | isLoading = False }, Cmd.none )

        RequestAEP ->
            case model.quoteId of
                Just quoteId ->
                    ( { model | isSubmittingAEP = True }
                    , Http.post
                        { url = "/api/schedule/aep-request/" ++ quoteId
                        , body = Http.emptyBody
                        , expect = Http.expectJson GotAEPResponse submitResponseDecoder
                        }
                    )

                Nothing ->
                    ( { model | error = Just "Unable to process AEP request" }, Cmd.none )

        GotAEPResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | success = True, isSubmittingAEP = False }, Cmd.none )

                    else
                        ( { model | error = Just response.message, isSubmittingAEP = False }, Cmd.none )

                Err _ ->
                    ( { model | error = Just "Failed to submit AEP request. Please try again.", isSubmittingAEP = False }
                    , Cmd.none
                    )

        RequestFollowUp ->
            case model.quoteId of
                Just quoteId ->
                    ( { model | isSubmittingFollowUp = True }
                    , Http.post
                        { url = "/api/schedule/request-follow-up/" ++ quoteId
                        , body = Http.emptyBody
                        , expect = Http.expectJson GotFollowUpResponse submitResponseDecoder
                        }
                    )

                Nothing ->
                    ( { model | error = Just "Unable to process follow-up request" }, Cmd.none )

        GotFollowUpResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | success = True, isSubmittingFollowUp = False }, Cmd.none )

                    else
                        ( { model | error = Just response.message, isSubmittingFollowUp = False }, Cmd.none )

                Err error ->
                    ( { model | error = Just "Failed to submit follow-up request. Please try again.", isSubmittingFollowUp = False }
                    , Cmd.none
                    )

        CalendlyOpened ->
            ( { model | success = True }, Cmd.none )


stripPhoneNumber : String -> String
stripPhoneNumber phoneNumber =
    String.filter Char.isDigit phoneNumber


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    if String.isEmpty phone then
        ""

    else
        let
            digits =
                String.filter Char.isDigit phone
                    |> String.left 10

            len =
                String.length digits
        in
        if len == 0 then
            ""

        else if len <= 3 then
            "(" ++ digits

        else if len <= 6 then
            "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

        else
            "(" ++ String.left 3 digits ++ ") " ++ String.slice 3 6 digits ++ "-" ++ String.dropLeft 6 digits


encodeForm : Model -> E.Value
encodeForm model =
    E.object
        [ ( "name", model.name |> Maybe.map Url.percentEncode |> Maybe.map E.string |> Maybe.withDefault E.null )
        , ( "email", model.email |> Maybe.map Url.percentEncode |> Maybe.map E.string |> Maybe.withDefault E.null )
        , ( "phoneNumber", model.phoneNumber |> Maybe.map stripPhoneNumber |> Maybe.map E.string |> Maybe.withDefault E.null )
        , ( "type"
          , E.string
                (case model.status of
                    Accept ->
                        "accept"

                    Decline ->
                        "decline"

                    Generic ->
                        "generic"
                )
          )
        , ( "quoteId", Maybe.map E.string model.quoteId |> Maybe.withDefault E.null )
        ]


view : Model -> Browser.Document Msg
view model =
    { title = getTitle model.status
    , body =
        [ if model.isLoading then
            viewLoading

          else
            div [ class "min-h-screen bg-[#F9FAFB]" ]
                [ div [ class "max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-12" ]
                    [ -- Organization Logo/Name
                      div [ class "flex justify-center items-center mb-8 px-4" ]
                        [ case model.scheduleInfo of
                            Just info ->
                                viewHeader info.organization.orgLogo info.organization.orgName

                            Nothing ->
                                text ""
                        ]
                    , if model.success then
                        div [ class "text-center" ]
                            [ h1 [ class "text-2xl sm:text-3xl font-bold text-gray-900 mb-3 sm:mb-4" ]
                                [ text "Thank You" ]
                            , p [ class "text-gray-600 text-base sm:text-lg" ]
                                [ text "We'll be in touch soon to discuss your options." ]
                            , div [ class "mt-8" ]
                                [ case model.scheduleInfo of
                                    Just info ->
                                        a
                                            [ href ("/self-onboarding/" ++ info.organization.orgSlug)
                                            , class "inline-flex items-center gap-2 text-[#03045E] hover:text-[#0077B6] transition-colors"
                                            ]
                                            [ MyIcon.clipboardPaste 24 "currentColor"
                                            , span [ class "font-medium" ] [ text "Help someone else get started" ]
                                            ]

                                    Nothing ->
                                        text ""
                                ]
                            ]

                      else
                        div [ class "flex flex-col max-w-xl mx-auto" ]
                            [ div [ class "text-center" ]
                                [ div [ class "border border-[#DCE2E5] shadow-sm overflow-hidden rounded-lg" ]
                                    [ div [ class "bg-[#F9F5FF] p-6" ]
                                        [ h1 [ class "text-3xl sm:text-4xl font-extrabold text-black mb-6" ]
                                            [ text (getHeading model.status) ]
                                        , p [ class "text-black text-base sm:text-lg leading-relaxed" ]
                                            [ text (getMessage model.status) ]
                                        ]
                                    , div [ class "bg-white p-6 sm:p-8" ]
                                        [ p [ class "text-[#667085] text-sm font-medium mb-6" ]
                                            [ text "Select an Option Below" ]
                                        , case model.error of
                                            Just error ->
                                                div [ class "bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 text-base" ]
                                                    [ text error ]

                                            Nothing ->
                                                text ""
                                        , case model.scheduleInfo of
                                            Just info ->
                                                case model.status of
                                                    Accept ->
                                                        viewAcceptButtons model info

                                                    Decline ->
                                                        viewDeclineButtons model info

                                                    Generic ->
                                                        viewGenericButtons model info

                                            Nothing ->
                                                text ""
                                        ]
                                    ]
                                ]
                            ]
                    ]
                ]
        ]
    }


viewAcceptButtons : Model -> ScheduleInfo -> Html Msg
viewAcceptButtons model info =
    div [ class "space-y-4" ]
        [ a
            [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
            , href (makeCalendlyUrl model)
            , target "_blank"
            , onClick CalendlyOpened
            ]
            [ div [ class "flex items-center space-x-3" ]
                [ span [ class "w-6 h-6 flex items-center justify-center" ]
                    [ MyIcon.calendarDays 24 "#03045E" ]
                , span [ class "font-semibold text-base" ]
                    [ text ("Schedule a Call with " ++ info.agent.firstName) ]
                ]
            ]
        , if model.isSubmittingFollowUp then
            button
                [ class "flex items-center justify-center w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] transition cursor-wait"
                , type_ "button"
                ]
                [ div [ class "animate-spin rounded-full h-5 w-5 border-2 border-[#03045E] border-t-transparent" ] [] ]

          else
            button
                [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
                , type_ "button"
                , onClick RequestFollowUp
                ]
                [ div [ class "flex items-center space-x-3" ]
                    [ span [ class "w-6 h-6 flex items-center justify-center" ]
                        [ MyIcon.phoneOutgoing 24 "#03045E" ]
                    , span [ class "font-semibold text-base" ]
                        [ text ("Request a Call from " ++ info.agent.firstName) ]
                    ]
                ]
        , if not (String.isEmpty info.agent.phone) then
            div [ class "text-center text-[#03045E] font-bold text-base mt-6 space-y-2" ]
                [ div [] [ text ("or give " ++ info.agent.firstName ++ " a call at:") ]
                , div []
                    [ a [ href ("tel:" ++ info.agent.phone), class "text-[#03045E]" ]
                        [ text (formatPhoneNumber info.agent.phone) ]
                    ]
                ]

          else
            text ""
        ]


viewDeclineButtons : Model -> ScheduleInfo -> Html Msg
viewDeclineButtons model info =
    div [ class "space-y-4" ]
        [ a
            [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
            , href (makeCalendlyUrl model)
            , target "_blank"
            , onClick CalendlyOpened
            ]
            [ div [ class "flex items-center space-x-3" ]
                [ span [ class "w-6 h-6 flex items-center justify-center" ]
                    [ MyIcon.calendarDays 24 "#03045E" ]
                , span [ class "font-semibold text-base" ]
                    [ text ("Schedule a Call with " ++ info.agent.firstName) ]
                ]
            ]
        , div [ class "mt-8 mb-4" ]
            [ h3 [ class "text-[#03045E] font-bold text-base mb-3" ]
                [ text "Interested in an Advantage Plan?" ]
            , p [ class "text-[#03045E] text-sm mb-6 leading-relaxed" ]
                [ text "We can switch you to an Advantage Plan during the Annual Enrollment Period (Oct. 7 - Dec. 7) - Click below so we know to contact you during AEP." ]
            , if model.isSubmittingAEP then
                button
                    [ class "flex items-center justify-center w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] transition cursor-wait"
                    , type_ "button"
                    ]
                    [ div [ class "animate-spin rounded-full h-5 w-5 border-2 border-[#03045E] border-t-transparent" ] [] ]

              else
                button
                    [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
                    , type_ "button"
                    , onClick RequestAEP
                    ]
                    [ div [ class "flex items-center space-x-3" ]
                        [ span [ class "w-6 h-6 flex items-center justify-center" ]
                            [ MyIcon.clipboardPlus 24 "#03045E" ]
                        , span [ class "font-semibold text-base" ]
                            [ text "Get on the Advantage Plan List" ]
                        ]
                    ]
            ]
        , if not (String.isEmpty info.agent.phone) then
            div [ class "text-center text-[#03045E] font-bold text-base mt-6 space-y-2" ]
                [ div [] [ text ("or give " ++ info.agent.firstName ++ " a call at:") ]
                , div []
                    [ a [ href ("tel:" ++ info.agent.phone), class "text-[#03045E]" ]
                        [ text (formatPhoneNumber info.agent.phone) ]
                    ]
                ]

          else
            text ""
        ]


viewGenericButtons : Model -> ScheduleInfo -> Html Msg
viewGenericButtons model info =
    div [ class "space-y-4" ]
        [ a
            [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
            , href (makeCalendlyUrl model)
            , target "_blank"
            , onClick CalendlyOpened
            ]
            [ div [ class "flex items-center space-x-3" ]
                [ span [ class "w-6 h-6 flex items-center justify-center" ]
                    [ MyIcon.calendarDays 24 "#03045E" ]
                , span [ class "font-semibold text-base" ]
                    [ text ("Schedule a Call with " ++ info.agent.firstName) ]
                ]
            ]
        , if model.isSubmittingFollowUp then
            button
                [ class "flex items-center justify-center w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] transition cursor-wait"
                , type_ "button"
                ]
                [ div [ class "animate-spin rounded-full h-5 w-5 border-2 border-[#03045E] border-t-transparent" ] [] ]

          else
            button
                [ class "flex items-center justify-between w-full px-4 py-4 border border-[#03045E] rounded-md text-[#03045E] hover:bg-gray-50 transition"
                , type_ "button"
                , onClick RequestFollowUp
                ]
                [ div [ class "flex items-center space-x-3" ]
                    [ span [ class "w-6 h-6 flex items-center justify-center" ]
                        [ MyIcon.phoneOutgoing 24 "#03045E" ]
                    , span [ class "font-semibold text-base" ]
                        [ text ("Request a Call from " ++ info.agent.firstName) ]
                    ]
                ]
        , if not (String.isEmpty info.agent.phone) then
            div [ class "text-center text-[#03045E] font-bold text-base mt-6 space-y-2" ]
                [ div [] [ text ("or give " ++ info.agent.firstName ++ " a call at:") ]
                , div []
                    [ a [ href ("tel:" ++ info.agent.phone), class "text-[#03045E]" ]
                        [ text (formatPhoneNumber info.agent.phone) ]
                    ]
                ]

          else
            text ""
        ]


viewLoading : Html Msg
viewLoading =
    div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-4 text-center" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-[#03045E] border-t-transparent" ] []
        , p [ class "text-center text-lg font-medium text-gray-600" ]
            [ text "Loading your schedule page..." ]
        ]


makeCalendlyUrl : Model -> String
makeCalendlyUrl model =
    case model.redirectUrl of
        Just url ->
            List.Extra.zip
                [ "email", "name", "location" ]
                [ model.email
                , model.name
                , model.phoneNumber
                ]
                |> List.filterMap
                    (\( key, value ) ->
                        case value of
                            Just s ->
                                case key of
                                    "location" ->
                                        Just (key ++ "=1" ++ Url.percentEncode s)

                                    _ ->
                                        Just (key ++ "=" ++ Url.percentEncode s)

                            Nothing ->
                                Nothing
                    )
                |> String.join "&"
                |> (\s -> url ++ "?" ++ s)

        Nothing ->
            "#"


getTitle : EligibilityStatus -> String
getTitle status =
    case status of
        Accept ->
            "Good News! - Medicare Max"

        Decline ->
            "Not Eligible - Medicare Max"

        Generic ->
            "Schedule Follow-up - Medicare Max"


getHeading : EligibilityStatus -> String
getHeading status =
    case status of
        Accept ->
            "Great News..."

        Decline ->
            "Here are some options..."

        Generic ->
            "Let's Connect"


getMessage : EligibilityStatus -> String
getMessage status =
    case status of
        Accept ->
            "Based on your answers, you look like a good candidate to switch plans. Let's schedule a follow-up to discuss your options or jump on a call now."

        Decline ->
            "Based on your answers, you may not qualify for this plan. However, there are some options and we'd love to help you find a different plan that's a perfect fit for your needs."

        Generic ->
            "Let's schedule a follow-up call to discuss your Medicare options and find the best plan for your needs."


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/SelfServiceOnboarding.elm
================
port module SelfServiceOnboarding exposing (..)

import Browser
import Browser.Navigation as Nav
import CarrierNaic exposing (Carrier, carrierDecoder)
import Date exposing (Date)
import Dict
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Encode as Encode
import Task
import Time
import Url exposing (Url)
import Url.Builder as Builder
import Url.Parser as Parser exposing ((</>), Parser, oneOf, string)
import Utils.QuoteHeader exposing (viewHeader)



-- PORTS


port saveDebugInfo : String -> Cmd msg


port clearDebugInfo : () -> Cmd msg



-- MODEL


type alias Model =
    { orgId : Maybe String
    , orgSlug : Maybe String
    , logo : Maybe String
    , orgName : Maybe String
    , email : String
    , firstName : String
    , lastName : String
    , zipCode : String
    , dateOfBirth : String
    , gender : String
    , tobacco : Bool
    , phoneNumber : String
    , currentPremium : String
    , currentCarrier : String
    , optInQuarterlyUpdates : Bool
    , emailReadOnly : Bool
    , isSubmitting : Bool
    , isGeneratingQuote : Bool
    , error : Maybe String
    , success : Bool
    , key : Nav.Key
    , currentDate : Maybe Date
    , state : Maybe String
    , counties : List String
    , selectedCounty : Maybe String
    , isLoadingZipData : Bool
    , zipError : Maybe String
    }



-- INIT


type Route
    = SlugRoute String
    | QueryRoute


routeParser : Parser (Route -> a) a
routeParser =
    oneOf
        [ Parser.map SlugRoute (Parser.s "self-onboarding" </> string)
        , Parser.map QueryRoute Parser.top
        ]


parseUrl : Url -> Route
parseUrl url =
    Parser.parse routeParser url |> Maybe.withDefault QueryRoute


type alias UrlParams =
    { orgId : Maybe String
    , email : Maybe String
    , hash : Maybe String
    , quoteId : Maybe String
    }


init : Nav.Key -> Url -> ( Model, Cmd Msg )
init key url =
    let
        route =
            parseUrl url

        initialModel =
            { orgId = Nothing
            , orgSlug = Nothing
            , logo = Nothing
            , orgName = Nothing
            , email = ""
            , firstName = ""
            , lastName = ""
            , zipCode = ""
            , dateOfBirth = ""
            , gender = "M"
            , tobacco = False
            , phoneNumber = ""
            , currentPremium = ""
            , currentCarrier = ""
            , optInQuarterlyUpdates = True
            , emailReadOnly = False
            , isSubmitting = False
            , isGeneratingQuote = False
            , error = Nothing
            , success = False
            , key = key
            , currentDate = Nothing
            , state = Nothing
            , counties = []
            , selectedCounty = Nothing
            , isLoadingZipData = False
            , zipError = Nothing
            }

        commands =
            [ Task.perform GotCurrentDate Date.today ]

        -- Clear any previous debug info
        clearCmd =
            clearDebugInfo ()
    in
    case route of
        SlugRoute slug ->
            let
                params =
                    parseUrlParams url

                email =
                    params.email

                quoteId =
                    params.quoteId

                debugInfo =
                    "Initializing with slug="
                        ++ slug
                        ++ ", email="
                        ++ (email |> Maybe.withDefault "none")
                        ++ ", quoteId="
                        ++ (quoteId |> Maybe.withDefault "none")
                        ++ ", url.query="
                        ++ (url.query |> Maybe.withDefault "none")

                fetchOrgDetailsCmd =
                    let
                        queryParams =
                            List.filterMap identity
                                [ Maybe.map (\e -> ( "email", e )) email
                                , Maybe.map (\q -> ( "id", q )) quoteId
                                ]
                                |> List.map (\( k, v ) -> k ++ "=" ++ Url.percentEncode v)
                                |> String.join "&"

                        apiUrl =
                            "/api/self-service/"
                                ++ slug
                                ++ (if String.isEmpty queryParams then
                                        ""

                                    else
                                        "?" ++ queryParams
                                   )
                    in
                    Cmd.batch
                        [ saveDebugInfo <| "Fetching org details: " ++ apiUrl
                        , Http.get
                            { url = apiUrl
                            , expect = Http.expectJson GotOrgDetails orgDetailsDecoder
                            }
                        ]
            in
            ( { initialModel | orgSlug = Just slug }
            , Cmd.batch
                (clearCmd
                    :: saveDebugInfo debugInfo
                    :: fetchOrgDetailsCmd
                    :: commands
                )
            )

        QueryRoute ->
            -- Handle query parameters for backward compatibility
            let
                params =
                    parseUrlParams url

                orgId =
                    params.orgId

                email =
                    params.email

                hash =
                    params.hash

                quoteId =
                    params.quoteId

                debugInfo =
                    "Initializing with orgId="
                        ++ (orgId |> Maybe.withDefault "none")
                        ++ ", email="
                        ++ (email |> Maybe.withDefault "none")
                        ++ ", quoteId="
                        ++ (quoteId |> Maybe.withDefault "none")

                initCmd =
                    case orgId of
                        Just oid ->
                            -- If we have an org ID, fetch org details which will include contact if found
                            let
                                queryParams =
                                    List.filterMap identity
                                        [ Maybe.map (\e -> ( "email", e )) email
                                        , Maybe.map (\q -> ( "id", q )) quoteId
                                        , Maybe.map (\h -> ( "hash", h )) hash
                                        ]
                                        |> List.map (\( k, v ) -> k ++ "=" ++ Url.percentEncode v)
                                        |> String.join "&"

                                apiUrl =
                                    "/api/self-service/"
                                        ++ oid
                                        ++ (if String.isEmpty queryParams then
                                                ""

                                            else
                                                "?" ++ queryParams
                                           )
                            in
                            Cmd.batch
                                [ saveDebugInfo <| "Fetching org details: " ++ apiUrl
                                , Http.get
                                    { url = apiUrl
                                    , expect = Http.expectJson GotOrgDetails orgDetailsDecoder
                                    }
                                ]

                        Nothing ->
                            Cmd.none
            in
            ( { initialModel | orgId = orgId }
            , Cmd.batch (clearCmd :: saveDebugInfo debugInfo :: initCmd :: commands)
            )


parseUrlParams : Url -> UrlParams
parseUrlParams url =
    -- This function parses query parameters for backward compatibility
    let
        queryParams =
            url.query
                |> Maybe.map (String.split "&")
                |> Maybe.withDefault []
                |> List.map (String.split "=")
                |> List.filterMap
                    (\parts ->
                        case parts of
                            [ key, value ] ->
                                Just ( key, Url.percentDecode value |> Maybe.withDefault value )

                            _ ->
                                Nothing
                    )
                |> Dict.fromList

        getParam name =
            Dict.get name queryParams
    in
    { orgId = getParam "orgId"
    , email = getParam "email"
    , hash = getParam "hash"
    , quoteId = getParam "id"
    }


fetchOrgDetails : String -> Cmd Msg
fetchOrgDetails slug =
    let
        url =
            "/api/self-service/" ++ slug
    in
    Cmd.batch
        [ saveDebugInfo <| "Fetching org details: " ++ url
        , Http.get
            { url = url
            , expect = Http.expectJson GotOrgDetails orgDetailsDecoder
            }
        ]


fetchZipInfo : String -> Cmd Msg
fetchZipInfo zipCode =
    Http.get
        { url = "/api/zipinfo/" ++ zipCode
        , expect = Http.expectJson GotZipInfo zipInfoDecoder
        }



-- UPDATE


type Msg
    = GotInitResponse (Result Http.Error InitResponse)
    | GotOrgDetails (Result Http.Error OrgDetails)
    | GotContactData (Result Http.Error ContactResponse)
    | UpdateEmail String
    | UpdateFirstName String
    | UpdateLastName String
    | UpdateZipCode String
    | UpdateDateOfBirth String
    | UpdateGender String
    | UpdateTobacco String
    | UpdatePhoneNumber String
    | UpdateCurrentPremium String
    | UpdateCurrentCarrier String
    | UpdateSelectedCounty String
    | SubmitForm
    | GotCurrentDate Date
    | GotZipInfo (Result Http.Error ZipInfo)
    | GotSignupResponse (Result Http.Error SignupResponse)
    | GotQuoteResponse (Result Http.Error QuoteResponse)
    | GoToQuote


type alias InitResponse =
    { contact : Maybe Contact
    , email : Maybe String
    , emailReadOnly : Bool
    }


type alias OrgDetails =
    { orgId : String
    , orgSlug : String
    , contact : Maybe Contact
    , logo : Maybe String
    , orgName : Maybe String
    }


type alias Contact =
    { firstName : String
    , lastName : String
    , email : String
    , phone : String
    , dateOfBirth : String
    , gender : String
    , tobacco : Bool
    , state : String
    , zipCode : String
    , currentCarrier : Maybe String
    , planType : Maybe String
    , optInQuarterlyUpdates : Bool
    }


type alias ZipInfo =
    { state : String
    , counties : List String
    }


type alias SignupResponse =
    { success : Bool
    , contactId : Int
    , email : String
    }


type alias QuoteResponse =
    { success : Bool
    , contactId : Int
    , quoteId : String
    , redirectUrl : String
    , error : Maybe String
    }


type alias ContactResponse =
    { success : Bool
    , orgSlug : String
    , carrierContracts : List Carrier
    , contact : Contact
    }


zipInfoDecoder : Decoder ZipInfo
zipInfoDecoder =
    Decode.field "success" Decode.bool
        |> Decode.andThen
            (\success ->
                if success then
                    Decode.field "data"
                        (Decode.map2 ZipInfo
                            (Decode.field "state" Decode.string)
                            (Decode.field "counties" (Decode.list Decode.string))
                        )

                else
                    Decode.field "error" Decode.string
                        |> Decode.andThen (\error -> Decode.fail error)
            )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GotOrgDetails result ->
            case result of
                Ok details ->
                    let
                        -- Extract contact info if it exists
                        contact =
                            details.contact

                        debugInfo =
                            "OrgDetails: orgId="
                                ++ details.orgId
                                ++ ", orgSlug="
                                ++ details.orgSlug
                                ++ ", hasContact="
                                ++ (if details.contact /= Nothing then
                                        "true"

                                    else
                                        "false"
                                   )
                                ++ (if details.contact /= Nothing then
                                        ", contactEmail=" ++ (Maybe.map .email contact |> Maybe.withDefault "none")

                                    else
                                        ""
                                   )
                    in
                    ( { model
                        | orgId = Just details.orgId
                        , orgSlug = Just details.orgSlug
                        , orgName = details.orgName
                        , logo = details.logo
                        , email = Maybe.map .email contact |> Maybe.withDefault model.email
                        , firstName = Maybe.map .firstName contact |> Maybe.withDefault model.firstName
                        , lastName = Maybe.map .lastName contact |> Maybe.withDefault model.lastName
                        , phoneNumber = Maybe.map .phone contact |> Maybe.withDefault model.phoneNumber
                        , dateOfBirth = Maybe.map .dateOfBirth contact |> Maybe.withDefault model.dateOfBirth
                        , gender = Maybe.map .gender contact |> Maybe.withDefault model.gender
                        , tobacco = Maybe.map .tobacco contact |> Maybe.withDefault model.tobacco
                        , zipCode = Maybe.map .zipCode contact |> Maybe.withDefault model.zipCode
                        , currentCarrier = Maybe.map .currentCarrier contact |> Maybe.withDefault Nothing |> Maybe.withDefault model.currentCarrier
                        , optInQuarterlyUpdates = Maybe.map .optInQuarterlyUpdates contact |> Maybe.withDefault model.optInQuarterlyUpdates
                        , error = Nothing
                      }
                    , Cmd.batch
                        [ saveDebugInfo debugInfo

                        -- If we have a zip code from contact, fetch the zip info
                        , case Maybe.map .zipCode contact of
                            Just zip ->
                                if String.length zip == 5 then
                                    fetchZipInfo zip

                                else
                                    Cmd.none

                            Nothing ->
                                Cmd.none
                        ]
                    )

                Err error ->
                    ( { model | error = Just "Organization not found or invalid link." }
                    , saveDebugInfo <| "OrgDetails error: " ++ httpErrorToString error
                    )

        GotInitResponse result ->
            case result of
                Ok response ->
                    let
                        email =
                            response.email |> Maybe.withDefault ""

                        contact =
                            response.contact

                        firstName =
                            contact |> Maybe.map .firstName |> Maybe.withDefault ""

                        lastName =
                            contact |> Maybe.map .lastName |> Maybe.withDefault ""

                        optIn =
                            contact |> Maybe.map .optInQuarterlyUpdates |> Maybe.withDefault False

                        debugInfo =
                            "InitResponse: email="
                                ++ email
                                ++ ", firstName="
                                ++ firstName
                                ++ ", lastName="
                                ++ lastName
                                ++ ", optIn="
                                ++ (if optIn then
                                        "true"

                                    else
                                        "false"
                                   )
                    in
                    ( { model
                        | email = email
                        , firstName = firstName
                        , lastName = lastName
                        , optInQuarterlyUpdates = optIn
                        , emailReadOnly = response.emailReadOnly
                        , error = Nothing
                      }
                    , saveDebugInfo debugInfo
                    )

                Err error ->
                    ( { model | error = Just "Failed to load existing contact details. Please try again." }
                    , saveDebugInfo <| "InitResponse error: " ++ httpErrorToString error
                    )

        UpdateEmail newEmail ->
            ( { model
                | email =
                    if model.emailReadOnly then
                        model.email

                    else
                        newEmail
              }
            , Cmd.none
            )

        UpdateFirstName newFirstName ->
            ( { model | firstName = newFirstName }, Cmd.none )

        UpdateLastName newLastName ->
            ( { model | lastName = newLastName }, Cmd.none )

        UpdateZipCode zip ->
            let
                filteredZip =
                    String.filter Char.isDigit zip |> String.left 5

                cmd =
                    if String.length filteredZip == 5 && filteredZip /= model.zipCode then
                        fetchZipInfo filteredZip

                    else
                        Cmd.none
            in
            ( { model
                | zipCode = filteredZip
                , isLoadingZipData = String.length filteredZip == 5 && filteredZip /= model.zipCode
                , state =
                    if String.length filteredZip /= 5 || (String.length filteredZip == 5 && filteredZip /= model.zipCode) then
                        Nothing

                    else
                        model.state
                , counties =
                    if String.length filteredZip /= 5 || (String.length filteredZip == 5 && filteredZip /= model.zipCode) then
                        []

                    else
                        model.counties
                , selectedCounty =
                    if String.length filteredZip /= 5 || (String.length filteredZip == 5 && filteredZip /= model.zipCode) then
                        Nothing

                    else
                        model.selectedCounty
                , zipError = Nothing
              }
            , cmd
            )

        GotZipInfo result ->
            case result of
                Ok zipInfo ->
                    let
                        -- Always select the first county as default
                        selectedCounty =
                            List.head zipInfo.counties
                    in
                    ( { model
                        | state = Just zipInfo.state
                        , counties = zipInfo.counties
                        , selectedCounty = selectedCounty
                        , isLoadingZipData = False
                        , zipError = Nothing
                      }
                    , Cmd.none
                    )

                Err error ->
                    ( { model
                        | state = Nothing
                        , counties = []
                        , selectedCounty = Nothing
                        , isLoadingZipData = False
                        , zipError = Just (httpErrorToString error)
                      }
                    , Cmd.none
                    )

        UpdateSelectedCounty county ->
            ( { model | selectedCounty = Just county }, Cmd.none )

        UpdateDateOfBirth dob ->
            ( { model | dateOfBirth = dob }, Cmd.none )

        UpdateGender value ->
            ( { model | gender = value }, Cmd.none )

        UpdateTobacco value ->
            ( { model | tobacco = value == "true" }, Cmd.none )

        UpdatePhoneNumber phone ->
            ( { model | phoneNumber = String.filter Char.isDigit phone |> String.left 10 }, Cmd.none )

        UpdateCurrentPremium value ->
            ( { model | currentPremium = String.filter (\c -> Char.isDigit c || c == '.') value }, Cmd.none )

        UpdateCurrentCarrier carrier ->
            ( { model | currentCarrier = carrier }, Cmd.none )

        GotCurrentDate date ->
            ( { model | currentDate = Just date }, Cmd.none )

        SubmitForm ->
            if isFormValid model then
                ( { model | isSubmitting = True, error = Nothing }
                , submitForm model
                )

            else
                ( { model | error = Just "Please fill out all required fields" }
                , Cmd.none
                )

        GotSignupResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model
                            | isSubmitting = False
                            , success = True
                            , error = Nothing
                            , isGeneratingQuote = True
                          }
                        , Cmd.batch
                            [ saveDebugInfo <| "SignupResponse: contactId=" ++ String.fromInt response.contactId ++ ", email=" ++ response.email
                            , generateQuote model.orgId response.contactId response.email
                            ]
                        )

                    else
                        ( { model | isSubmitting = False, error = Just "Signup failed. Please try again." }
                        , saveDebugInfo <| "SignupResponse: failed (success=false)"
                        )

                Err error ->
                    ( { model | isSubmitting = False, error = Just "Signup failed. Please try again." }
                    , saveDebugInfo <| "SignupResponse error: " ++ httpErrorToString error
                    )

        GotQuoteResponse result ->
            case result of
                Ok response ->
                    if response.success then
                        ( { model | isGeneratingQuote = False }
                        , Cmd.batch
                            [ saveDebugInfo <| "QuoteResponse: quoteId=" ++ response.quoteId ++ ", redirectUrl=" ++ response.redirectUrl
                            , Nav.pushUrl model.key (Builder.absolute [ "compare" ] [ Builder.string "id" response.quoteId ])
                            ]
                        )

                    else
                        ( { model | isGeneratingQuote = False, error = Just "Failed to generate quote. Please try again." }
                        , saveDebugInfo <| "QuoteResponse: failed (success=false), error=" ++ (response.error |> Maybe.withDefault "No error message")
                        )

                Err error ->
                    ( { model | isGeneratingQuote = False, error = Just "Failed to generate quote. Please try again." }
                    , saveDebugInfo <| "QuoteResponse error: " ++ httpErrorToString error
                    )

        GoToQuote ->
            if isFormValid model then
                let
                    county =
                        case model.selectedCounty of
                            Just c ->
                                c

                            Nothing ->
                                List.head model.counties
                                    |> Maybe.withDefault ""

                    state =
                        model.state
                            |> Maybe.withDefault ""

                    compareUrl =
                        Builder.absolute [ "compare" ]
                            [ Builder.string "zip" model.zipCode
                            , Builder.string "state" state
                            , Builder.string "county" county
                            , Builder.string "gender" model.gender
                            , Builder.string "tobacco"
                                (if model.tobacco then
                                    "true"

                                 else
                                    "false"
                                )
                            , Builder.string "dateOfBirth" model.dateOfBirth
                            ]
                in
                ( model
                , Nav.pushUrl model.key compareUrl
                )

            else
                ( { model | error = Just "Please fill out all required fields for a quote" }
                , Cmd.none
                )

        GotContactData result ->
            case result of
                Ok response ->
                    let
                        contact =
                            response.contact
                    in
                    ( { model
                        | orgId = Just response.orgSlug
                        , email = contact.email
                        , firstName = contact.firstName
                        , lastName = contact.lastName
                        , phoneNumber = contact.phone
                        , dateOfBirth = contact.dateOfBirth
                        , gender = contact.gender
                        , tobacco = contact.tobacco
                        , zipCode = contact.zipCode
                        , currentCarrier = Maybe.withDefault "" contact.currentCarrier
                        , optInQuarterlyUpdates = contact.optInQuarterlyUpdates
                        , error = Nothing
                      }
                    , Cmd.batch
                        [ saveDebugInfo <|
                            "ContactData: success="
                                ++ (if response.success then
                                        "true"

                                    else
                                        "false"
                                   )
                                ++ ", orgSlug="
                                ++ response.orgSlug
                        ]
                    )

                Err error ->
                    ( { model | error = Just "Failed to load contact data. Please try again." }
                    , saveDebugInfo <| "ContactData error: " ++ httpErrorToString error
                    )


isFormValid : Model -> Bool
isFormValid model =
    let
        isValidDate str =
            case String.split "-" str of
                [ year, month, day ] ->
                    String.length year
                        == 4
                        && String.length month
                        == 2
                        && String.length day
                        == 2
                        && String.all Char.isDigit year
                        && String.all Char.isDigit month
                        && String.all Char.isDigit day

                _ ->
                    False
    in
    -- Contact info (required)
    not (String.isEmpty model.email)
        && not (String.isEmpty model.firstName)
        && not (String.isEmpty model.lastName)
        && model.orgId
        /= Nothing
        -- Quote info (required)
        && String.length model.zipCode
        == 5
        && not (String.isEmpty model.dateOfBirth)
        && isValidDate model.dateOfBirth
        && not (String.isEmpty model.gender)
        -- Tobacco status is now explicitly required
        && (model.tobacco == True || model.tobacco == False)
        -- Must agree to receive updates
        && model.optInQuarterlyUpdates
        == True


httpErrorToString : Http.Error -> String
httpErrorToString error =
    case error of
        Http.BadUrl url ->
            "Bad URL: " ++ url

        Http.Timeout ->
            "Request timed out"

        Http.NetworkError ->
            "Network error"

        Http.BadStatus statusCode ->
            "Bad status: " ++ String.fromInt statusCode

        Http.BadBody message ->
            "Data error: " ++ message


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    if String.isEmpty phone then
        ""

    else
        let
            digits =
                String.filter Char.isDigit phone
                    |> String.left 10

            len =
                String.length digits
        in
        if len == 0 then
            ""

        else if len <= 3 then
            "(" ++ digits

        else if len <= 6 then
            "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

        else
            "(" ++ String.left 3 digits ++ ") " ++ String.slice 3 6 digits ++ "-" ++ String.dropLeft 6 digits



-- FORM SUBMISSION


submitForm : Model -> Cmd Msg
submitForm model =
    Http.post
        { url = "/api/self-service/signup"
        , body = Http.jsonBody (encodeForm model)
        , expect = Http.expectJson GotSignupResponse signupResponseDecoder
        }


generateQuote : Maybe String -> Int -> String -> Cmd Msg
generateQuote maybeOrgId contactId email =
    case maybeOrgId of
        Just orgId ->
            Http.post
                { url = "/api/self-service/generate-quote"
                , body =
                    Http.jsonBody
                        (Encode.object
                            [ ( "orgId", Encode.string orgId )
                            , ( "contactEmail", Encode.string email )
                            ]
                        )
                , expect = Http.expectJson GotQuoteResponse quoteResponseDecoder
                }

        Nothing ->
            Cmd.none


encodeForm : Model -> Encode.Value
encodeForm model =
    Encode.object
        [ ( "orgId", Encode.string (Maybe.withDefault "" model.orgId) )
        , ( "email", Encode.string model.email )
        , ( "firstName", Encode.string model.firstName )
        , ( "lastName", Encode.string model.lastName )
        , ( "zipCode", Encode.string model.zipCode )
        , ( "dateOfBirth", Encode.string model.dateOfBirth )
        , ( "gender", Encode.string model.gender )
        , ( "tobacco", Encode.bool model.tobacco )
        , ( "phoneNumber", Encode.string model.phoneNumber )
        , ( "currentPremium", Encode.string model.currentPremium )
        , ( "currentCarrier", Encode.string model.currentCarrier )
        , ( "state", Encode.string (Maybe.withDefault "" model.state) )
        , ( "county", Encode.string (Maybe.withDefault "" model.selectedCounty) )
        , ( "optInQuarterlyUpdates", Encode.bool model.optInQuarterlyUpdates )
        ]



-- DECODERS


initResponseDecoder : Decoder InitResponse
initResponseDecoder =
    Decode.map3 InitResponse
        (Decode.maybe (Decode.field "contact" contactDecoder))
        (Decode.maybe (Decode.field "email" Decode.string))
        (Decode.field "emailReadOnly" Decode.bool)


contactDecoder : Decoder Contact
contactDecoder =
    Decode.map4
        (\fn ln em ph ->
            { firstName = fn
            , lastName = ln
            , email = em
            , phone = ph
            , dateOfBirth = ""
            , gender = "M"
            , tobacco = False
            , state = ""
            , zipCode = ""
            , currentCarrier = Nothing
            , planType = Nothing
            , optInQuarterlyUpdates = True
            }
        )
        (Decode.field "firstName" Decode.string)
        (Decode.field "lastName" Decode.string)
        (Decode.field "email" Decode.string)
        (Decode.field "phone" Decode.string)
        |> Decode.andThen
            (\c ->
                Decode.map4
                    (\dob gndr tbc st ->
                        { c
                            | dateOfBirth = dob
                            , gender = gndr
                            , tobacco = tbc
                            , state = st
                        }
                    )
                    (Decode.field "dateOfBirth" Decode.string)
                    (Decode.field "gender" Decode.string)
                    (Decode.field "tobacco" Decode.bool)
                    (Decode.field "state" Decode.string)
            )
        |> Decode.andThen
            (\c ->
                Decode.map3
                    (\zip cc pt ->
                        { c
                            | zipCode = zip
                            , currentCarrier = cc
                            , planType = pt
                        }
                    )
                    (Decode.field "zipCode" Decode.string)
                    (Decode.field "currentCarrier" (Decode.nullable Decode.string))
                    (Decode.field "planType" (Decode.nullable Decode.string))
            )
        |> Decode.andThen
            (\c ->
                Decode.maybe (Decode.field "optInQuarterlyUpdates" Decode.bool)
                    |> Decode.map (Maybe.withDefault True)
                    |> Decode.map (\optIn -> { c | optInQuarterlyUpdates = optIn })
            )


orgDetailsDecoder : Decoder OrgDetails
orgDetailsDecoder =
    Decode.map5 OrgDetails
        (Decode.field "orgId" Decode.string)
        (Decode.field "orgSlug" Decode.string)
        (Decode.maybe (Decode.field "contact" contactDecoder))
        (Decode.maybe (Decode.field "logo" Decode.string))
        (Decode.maybe (Decode.field "orgName" Decode.string))


signupResponseDecoder : Decoder SignupResponse
signupResponseDecoder =
    Decode.map3 SignupResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "contactId" Decode.int)
        (Decode.field "email" Decode.string)


quoteResponseDecoder : Decoder QuoteResponse
quoteResponseDecoder =
    Decode.map5 QuoteResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "contactId" Decode.int)
        (Decode.field "quoteId" Decode.string)
        (Decode.field "redirectUrl" Decode.string)
        (Decode.maybe (Decode.field "error" Decode.string))


contactResponseDecoder : Decoder ContactResponse
contactResponseDecoder =
    Decode.map4 ContactResponse
        (Decode.field "success" Decode.bool)
        (Decode.field "orgSlug" Decode.string)
        (Decode.field "carrierContracts" (Decode.list carrierDecoder))
        (Decode.field "contact" contactDecoder)


fetchContactData : String -> Cmd Msg
fetchContactData quoteId =
    Http.get
        { url = "/api/quotes/decode/" ++ quoteId
        , expect = Http.expectJson GotContactData contactResponseDecoder
        }



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Get Your Medicare Supplement Quote"
    , body =
        [ viewForm model
        ]
    }


viewForm : Model -> Html Msg
viewForm model =
    div [ class "max-w-4xl mx-auto bg-white rounded-xl shadow-md p-4 sm:p-8" ]
        [ if model.isSubmitting || model.isGeneratingQuote then
            div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-4 text-center" ]
                [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-[#03045E] border-t-transparent" ] []
                , p [ class "text-center text-lg font-medium text-gray-600" ]
                    [ text
                        (if model.isSubmitting then
                            "Submitting your information..."

                         else
                            "Generating your quote..."
                        )
                    ]
                ]

          else if model.orgId == Nothing && model.error == Nothing then
            div [ class "fixed inset-0 bg-white flex flex-col items-center justify-center gap-4 text-center" ]
                [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-[#03045E] border-t-transparent" ] []
                , p [ class "text-center text-lg font-medium text-gray-600" ]
                    [ text "Loading organization details..." ]
                ]

          else
            viewFormStep model
        ]


viewFormStep : Model -> Html Msg
viewFormStep model =
    div []
        [ viewHeader model.logo model.orgName
        , div [ class "text-center mb-6 px-2 sm:px-0" ]
            [ h1 [ class "text-2xl sm:text-3xl font-bold text-[#101828]" ] [ text "Let's Get Some Details" ]
            , p [ class "text-[#475467] mt-2 text-sm sm:text-base" ] [ text "We use this information to get you the most accurate quote for your area." ]
            ]
        , viewCombinedForm model
        , viewError model.error
        , button
            [ type_ "button"
            , class "w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#03045E] hover:bg-[#02034e] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#3DBDEC] mt-6"
            , onClick SubmitForm
            , disabled (model.isSubmitting || not (isFormValid model))
            ]
            [ text
                (if model.isSubmitting then
                    "Submitting..."

                 else
                    "Submit"
                )
            ]
        ]


viewCombinedForm : Model -> Html Msg
viewCombinedForm model =
    div [ class "px-2 sm:px-0 space-y-6 sm:space-y-6" ]
        [ div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-4" ]
            [ inputField "First Name" "text" model.firstName UpdateFirstName False
            , inputField "Last Name" "text" model.lastName UpdateLastName False
            , inputField "Phone Number" "tel" (formatPhoneNumber model.phoneNumber) UpdatePhoneNumber False
            , inputField "Email Address" "email" model.email UpdateEmail model.emailReadOnly
            ]
        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-4" ]
            [ div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ] [ text "Date of Birth" ]
                , input
                    [ type_ "date"
                    , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"
                    , Html.Attributes.value model.dateOfBirth
                    , onInput UpdateDateOfBirth
                    , required True
                    , Html.Attributes.max (model.currentDate |> Maybe.map Date.toIsoString |> Maybe.withDefault "")
                    ]
                    []
                ]
            , div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ] [ text "Zip Code" ]
                , input
                    [ type_ "text"
                    , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"
                    , placeholder "XXXXX"
                    , Html.Attributes.value model.zipCode
                    , onInput UpdateZipCode
                    , Html.Attributes.maxlength 5
                    , Html.Attributes.pattern "[0-9]*"
                    , required True
                    ]
                    []
                , if model.isLoadingZipData then
                    div [ class "text-xs text-blue-600 mt-1" ]
                        [ text "Looking up location..." ]

                  else if model.zipError /= Nothing then
                    div [ class "text-xs text-red-600 mt-1" ]
                        [ text (Maybe.withDefault "Invalid zip code" model.zipError) ]

                  else if model.state /= Nothing then
                    div [ class "text-xs text-green-600 mt-1" ]
                        [ text ("Found: " ++ Maybe.withDefault "" model.state) ]

                  else
                    text ""
                ]
            ]
        , if List.length model.counties > 1 then
            div [ class "mb-4" ]
                [ viewCountyDropdown model.counties model.selectedCounty ]

          else
            text ""
        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-4" ]
            [ div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-2" ] [ text "Gender" ]
                , div [ class "grid grid-cols-2 gap-2" ]
                    [ label
                        [ class
                            ("flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg border-2 cursor-pointer transition-all text-sm sm:text-base "
                                ++ (if model.gender == "M" then
                                        "border-[#03045E] bg-[#F9F5FF] text-[#03045E]"

                                    else
                                        "border-[#D0D5DD] hover:border-[#3DBDEC] text-[#344054]"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value "M"
                            , checked (model.gender == "M")
                            , onInput UpdateGender
                            , class "sr-only"
                            ]
                            []
                        , text "Male"
                        ]
                    , label
                        [ class
                            ("flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg border-2 cursor-pointer transition-all text-sm sm:text-base "
                                ++ (if model.gender == "F" then
                                        "border-[#03045E] bg-[#F9F5FF] text-[#03045E]"

                                    else
                                        "border-[#D0D5DD] hover:border-[#3DBDEC] text-[#344054]"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value "F"
                            , checked (model.gender == "F")
                            , onInput UpdateGender
                            , class "sr-only"
                            ]
                            []
                        , text "Female"
                        ]
                    ]
                ]
            , div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-2" ] [ text "Do you use tobacco products?" ]
                , div [ class "grid grid-cols-2 gap-2" ]
                    [ label
                        [ class
                            ("flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg border-2 cursor-pointer transition-all text-sm sm:text-base "
                                ++ (if model.tobacco then
                                        "border-[#03045E] bg-[#F9F5FF] text-[#03045E]"

                                    else
                                        "border-[#D0D5DD] hover:border-[#3DBDEC] text-[#344054]"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value "true"
                            , checked model.tobacco
                            , onInput UpdateTobacco
                            , class "sr-only"
                            ]
                            []
                        , text "Yes"
                        ]
                    , label
                        [ class
                            ("flex items-center justify-center px-3 sm:px-4 py-2 rounded-lg border-2 cursor-pointer transition-all text-sm sm:text-base "
                                ++ (if not model.tobacco then
                                        "border-[#03045E] bg-[#F9F5FF] text-[#03045E]"

                                    else
                                        "border-[#D0D5DD] hover:border-[#3DBDEC] text-[#344054]"
                                   )
                            )
                        ]
                        [ input
                            [ type_ "radio"
                            , value "false"
                            , checked (not model.tobacco)
                            , onInput UpdateTobacco
                            , class "sr-only"
                            ]
                            []
                        , text "No"
                        ]
                    ]
                ]
            ]
        , h3 [ class "font-medium text-base sm:text-lg mb-4 text-gray-700" ] [ text "Current Coverage" ]
        , div [ class "grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-4" ]
            [ div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ] [ text "Current Carrier (optional)" ]
                , div [ class "relative" ]
                    [ input
                        [ type_ "text"
                        , class "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"
                        , Html.Attributes.value model.currentCarrier
                        , onInput UpdateCurrentCarrier
                        ]
                        []
                    , div [ class "absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none" ]
                        [ span [ class "text-gray-500" ] [ text "▼" ] ]
                    ]
                ]
            , div [ class "col-span-1" ]
                [ label [ class "block text-sm font-medium text-gray-700 mb-1" ] [ text "Current Monthly Premium (optional)" ]
                , div [ class "relative" ]
                    [ div [ class "absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none" ]
                        [ span [ class "text-gray-500" ] [ text "$" ] ]
                    , input
                        [ type_ "text"
                        , class "w-full pl-7 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"
                        , Html.Attributes.value model.currentPremium
                        , onInput UpdateCurrentPremium
                        , Html.Attributes.pattern "[0-9]*"
                        , Html.Attributes.attribute "inputmode" "numeric"
                        , placeholder "0.00"
                        ]
                        []
                    ]
                ]
            ]
        , div [ class "mt-6 text-center" ]
            [ p [ class "text-sm text-[#475467]" ]
                [ text "By clicking below, you agree to receive Medicare Supplement plan updates that can help you save money." ]
            ]
        ]


inputField : String -> String -> String -> (String -> Msg) -> Bool -> Html Msg
inputField labelText inputType inputValue msg isDisabled =
    div [ class "mb-0" ]
        [ label [ class "block text-sm font-medium text-[#344054] mb-1" ] [ text labelText ]
        , input
            [ type_ inputType
            , class "w-full px-3 py-2 border border-[#D0D5DD] rounded-md shadow-sm focus:outline-none focus:ring-[#3DBDEC] focus:border-[#3DBDEC]"
            , placeholder
                (case inputType of
                    "tel" ->
                        "XXX-XXX-XXXX"

                    "email" ->
                        "example@example.com"

                    _ ->
                        ""
                )
            , Html.Attributes.value inputValue
            , onInput msg
            , disabled isDisabled
            ]
            []
        ]


viewCountyDropdown : List String -> Maybe String -> Html Msg
viewCountyDropdown counties selectedCounty =
    div [ class "mb-4" ]
        [ label [ class "block text-sm font-medium text-[#344054] mb-1" ]
            [ text "County" ]
        , select
            [ class "w-full px-3 py-2 border border-[#D0D5DD] rounded-md shadow-sm focus:outline-none focus:ring-[#3DBDEC] focus:border-[#3DBDEC]"
            , onInput UpdateSelectedCounty
            , required True
            ]
            (option [ value "", disabled True, selected (selectedCounty == Nothing) ]
                [ text "Select your county" ]
                :: List.map
                    (\county ->
                        option
                            [ value county
                            , selected (selectedCounty == Just county)
                            ]
                            [ text county ]
                    )
                    counties
            )
        ]


viewError : Maybe String -> Html msg
viewError maybeError =
    case maybeError of
        Just error ->
            div [ class "mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded" ]
                [ text error ]

        Nothing ->
            text ""


viewFormSummary : Model -> Html Msg
viewFormSummary model =
    div [ class "border rounded-md p-3 sm:p-4 mb-4" ]
        [ h3 [ class "font-medium text-base sm:text-lg mb-3" ] [ text "Review Your Information" ]
        , summaryItem "Email" model.email
        , summaryItem "Name" (model.firstName ++ " " ++ model.lastName)
        , summaryItem "Phone" (formatPhoneNumber model.phoneNumber)
        , summaryItem "Zip Code" model.zipCode
        , summaryItem "State"
            (model.state
                |> Maybe.withDefault "Unknown"
            )
        , summaryItem "County"
            (model.selectedCounty
                |> Maybe.withDefault "Unknown"
            )
        , summaryItem "Date of Birth" model.dateOfBirth
        , summaryItem "Gender"
            (if model.gender == "M" then
                "Male"

             else
                "Female"
            )
        , summaryItem "Tobacco User"
            (if model.tobacco then
                "Yes"

             else
                "No"
            )
        , if not (String.isEmpty model.currentPremium) then
            summaryItem "Current Premium" ("$" ++ model.currentPremium)

          else
            text ""
        , if not (String.isEmpty model.currentCarrier) then
            summaryItem "Current Carrier" model.currentCarrier

          else
            text ""
        , summaryItem "Agree to Receive Updates"
            (if model.optInQuarterlyUpdates then
                "Yes"

             else
                "No"
            )
        ]


summaryItem : String -> String -> Html Msg
summaryItem label value =
    div [ class "flex justify-between py-1 border-b last:border-b-0 text-sm sm:text-base" ]
        [ span [ class "text-gray-600" ] [ text label ]
        , span [ class "font-medium" ] [ text value ]
        ]



-- MAIN


main : Program () Model Msg
main =
    Browser.application
        { init = \_ url key -> init key url
        , view = view
        , update = update
        , subscriptions = \_ -> Sub.none
        , onUrlChange = \_ -> GotInitResponse (Err (Http.BadUrl "URL changed"))
        , onUrlRequest = \_ -> GotInitResponse (Err (Http.BadUrl "URL requested"))
        }

================
File: src/Settings.elm
================
module Settings exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Components.ProgressIndicator
import Components.SetupLayout as SetupLayout
import File exposing (File)
import File.Select as Select
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onCheck, onClick, onInput)
import Http exposing (expectJson, jsonBody)
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Ports
import StateRegions exposing (Region(..), getRegionStates, regionToString)
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)
import Task



-- Constants


allCarriers : List String
allCarriers =
    [ "Aetna"
    , "Humana"
    , "UnitedHealthcare"
    , "Cigna"
    , "Aflac"
    , "Allstate"
    , "Mutual of Omaha"
    , "Ace Chubb"
    ]


type Carrier
    = Aetna
    | Humana
    | UnitedHealthcare
    | Cigna
    | Aflac
    | Allstate
    | MutualOfOmaha
    | AceChubb



-- Add new type for GI selection mode


type GISelectionMode
    = GIAll
    | GINone
    | GIRecommended


type alias InitFlags =
    { isSetup : Bool
    , key : Nav.Key
    , currentUser : Maybe CurrentUser
    , planType : String
    }


type alias CurrentUser =
    { id : String
    , email : String
    , isAdmin : Bool
    , isAgent : Bool
    , organizationSlug : String
    , organizationId : String
    }



-- Add new type for deactivated carrier-state pairs


type alias DeactivatedPair =
    { carrier : String
    }


type alias Model =
    { orgSettings : Maybe Settings
    , status : Status
    , expandedSections : List String
    , recommendedGICombos : List StateCarrierSetting
    , isSetup : Bool
    , key : Nav.Key
    , currentUser : Maybe CurrentUser
    , isLoading : Bool
    , isSaving : Bool
    , planType : String
    , error : Maybe String
    , selectedCarrier : Maybe String
    , loadedCarriers : List String
    , linkCopied : Bool
    , selfOnboardingUrl : Maybe String
    , logo : Maybe String
    }


type alias StateCarrierSetting =
    { carrier : String
    , active : Bool
    , targetGI : Bool
    }


type alias Settings =
    { carrierContracts : List String
    , stateCarrierSettings : List StateCarrierSetting
    , allowAgentSettings : Bool
    , emailSendBirthday : Bool
    , emailSendPolicyAnniversary : Bool
    , emailSendAep : Bool
    , smartSendEnabled : Bool
    , brandName : String
    , primaryColor : String
    , secondaryColor : String
    , logo : Maybe String
    }


type Status
    = Loading
    | Loaded
    | Saving
    | Error String


type Msg
    = GotSettings (Result Http.Error SettingsResponse)
    | SaveSettings
    | SettingsSaved (Result Http.Error Settings)
    | ToggleEmailBirthday Bool
    | ToggleEmailAnniversary Bool
    | ToggleEmailAep Bool
    | ToggleSmartSend Bool
    | AddCarrierContract String
    | RemoveCarrierContract String
    | UpdateStateCarrierSetting String Bool Bool
    | ToggleSection String
    | ToggleAllCarriers Bool
    | ApplyGISelection GISelectionMode
    | GotRecommendedGICombos (Result Http.Error (List StateCarrierSetting))
    | ToggleAllowAgentSettings Bool
    | FinishSetup
    | UpdateBrandName String
    | UpdatePrimaryColor String
    | UpdateSecondaryColor String
    | UploadLogo
    | GotLogo File
    | GotLogoUrl String
    | LogoUploaded (Result Http.Error String)
    | NoOp
    | OrgFinalized (Result Http.Error ())
    | SelectCarrier String
    | GotCarriers (Result Http.Error (List String))
    | CopySelfOnboardingLink
    | LinkCopied Bool
    | GotSelfOnboardingUrl (Result Http.Error SelfOnboardingUrlResponse)


type alias SettingsResponse =
    { orgSettings : Settings
    , logo : Maybe String
    , canEditOrgSettings : Bool
    }


type alias SelfOnboardingUrlResponse =
    { selfOnboardingUrl : String
    }


init : InitFlags -> ( Model, Cmd Msg )
init flags =
    ( { orgSettings = Nothing
      , status = Loading
      , expandedSections = []
      , recommendedGICombos = []
      , isSetup = flags.isSetup
      , key = flags.key
      , currentUser = flags.currentUser
      , isLoading = True
      , isSaving = False
      , planType = flags.planType
      , error = Nothing
      , selectedCarrier = Nothing
      , loadedCarriers = []
      , linkCopied = False
      , selfOnboardingUrl = Nothing
      , logo = Nothing
      }
    , Cmd.batch
        [ fetchSettings
        , fetchRecommendedGICombos
        , fetchCarriers
        , fetchSelfOnboardingUrl
        ]
    )


fetchSettings : Cmd Msg
fetchSettings =
    Http.get
        { url = "/api/settings"
        , expect = Http.expectJson GotSettings settingsDecoder
        }


fetchRecommendedGICombos : Cmd Msg
fetchRecommendedGICombos =
    Http.get
        { url = "/api/settings/gi-recommendations"
        , expect = Http.expectJson GotRecommendedGICombos recommendationsDecoder
        }


fetchCarriers : Cmd Msg
fetchCarriers =
    Http.get
        { url = "/api/settings/carriers"
        , expect = Http.expectJson GotCarriers (Decode.list (Decode.field "name" Decode.string))
        }


fetchSelfOnboardingUrl : Cmd Msg
fetchSelfOnboardingUrl =
    let
        slug =
            -- This is a placeholder, we'll get the actual slug in the backend
            "latest"
    in
    Http.get
        { url = "/api/self-service/" ++ slug
        , expect = Http.expectJson GotSelfOnboardingUrl selfOnboardingUrlDecoder
        }


selfOnboardingUrlDecoder : Decoder SelfOnboardingUrlResponse
selfOnboardingUrlDecoder =
    Decode.map SelfOnboardingUrlResponse
        (Decode.field "selfOnboardingUrl" Decode.string)


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )

        GotSettings result ->
            case result of
                Ok response ->
                    ( { model
                        | orgSettings = Just response.orgSettings
                        , logo = response.logo
                        , status = Loaded
                        , isLoading = False
                      }
                    , Cmd.none
                    )

                Err error ->
                    let
                        errorMsg =
                            case error of
                                Http.BadUrl url ->
                                    "Bad URL: " ++ url

                                Http.Timeout ->
                                    "Request timed out"

                                Http.NetworkError ->
                                    "Network error"

                                Http.BadStatus status ->
                                    "Bad status: " ++ String.fromInt status

                                Http.BadBody message ->
                                    "Bad body: " ++ message
                    in
                    ( { model | status = Error errorMsg, isLoading = False }
                    , Cmd.none
                    )

        GotCarriers result ->
            case result of
                Ok carriers ->
                    ( { model | loadedCarriers = carriers }
                    , Cmd.none
                    )

                Err _ ->
                    ( model, Cmd.none )

        SaveSettings ->
            ( { model | status = Saving }
            , Cmd.none
            )

        SettingsSaved result ->
            case result of
                Ok settings ->
                    ( { model | orgSettings = Just settings, status = Loaded }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model | status = Error "Failed to save settings" }
                    , Cmd.none
                    )

        ToggleEmailBirthday value ->
            updateSettings model (\s -> { s | emailSendBirthday = value })

        ToggleEmailAnniversary value ->
            updateSettings model (\s -> { s | emailSendPolicyAnniversary = value })

        ToggleEmailAep value ->
            updateSettings model (\s -> { s | emailSendAep = value })

        ToggleSmartSend value ->
            updateSettings model (\s -> { s | smartSendEnabled = value })

        AddCarrierContract carrier ->
            updateSettings model
                (\s ->
                    if List.member carrier s.carrierContracts then
                        s

                    else
                        { s
                            | carrierContracts = carrier :: s.carrierContracts
                            , stateCarrierSettings = List.map (\setting -> { setting | active = True }) s.stateCarrierSettings
                        }
                )

        RemoveCarrierContract carrier ->
            updateSettings model
                (\s ->
                    { s
                        | carrierContracts = List.filter (\x -> x /= carrier) s.carrierContracts
                        , stateCarrierSettings = List.filter (\setting -> setting.carrier /= carrier) s.stateCarrierSettings
                    }
                )

        UpdateStateCarrierSetting carrier active targetGI ->
            updateSettings model
                (\s ->
                    let
                        existingSetting =
                            List.filter
                                (\setting ->
                                    setting.carrier == carrier
                                )
                                s.stateCarrierSettings
                                |> List.head

                        newSettings =
                            case existingSetting of
                                Just _ ->
                                    List.map
                                        (\setting ->
                                            if setting.carrier == carrier then
                                                { setting | active = active, targetGI = targetGI }

                                            else
                                                setting
                                        )
                                        s.stateCarrierSettings

                                Nothing ->
                                    { carrier = carrier
                                    , active = active
                                    , targetGI = targetGI
                                    }
                                        :: s.stateCarrierSettings
                    in
                    { s | stateCarrierSettings = newSettings }
                )

        ToggleSection title ->
            ( { model
                | expandedSections =
                    if List.member title model.expandedSections then
                        List.filter ((/=) title) model.expandedSections

                    else
                        title :: model.expandedSections
              }
            , Cmd.none
            )

        ToggleAllCarriers checked ->
            case model.orgSettings of
                Just settings ->
                    let
                        carriersToUse =
                            if List.isEmpty model.loadedCarriers then
                                allCarriers

                            else
                                model.loadedCarriers

                        newSettings =
                            { settings
                                | carrierContracts =
                                    if checked then
                                        carriersToUse

                                    else
                                        []
                                , stateCarrierSettings =
                                    if checked then
                                        List.map
                                            (\carrier ->
                                                { carrier = carrier
                                                , active = True
                                                , targetGI = False
                                                }
                                            )
                                            carriersToUse

                                    else
                                        []
                            }
                    in
                    ( { model | orgSettings = Just newSettings }
                    , saveSettings { settings = Just newSettings, logo = model.logo }
                    )

                Nothing ->
                    ( model, Cmd.none )

        ApplyGISelection mode ->
            case model.orgSettings of
                Just settings ->
                    let
                        newSettings =
                            case mode of
                                GIAll ->
                                    { settings
                                        | stateCarrierSettings =
                                            List.map
                                                (\carrier ->
                                                    { carrier = carrier
                                                    , active = True
                                                    , targetGI = True
                                                    }
                                                )
                                                settings.carrierContracts
                                    }

                                GINone ->
                                    { settings
                                        | stateCarrierSettings =
                                            List.map
                                                (\carrier ->
                                                    { carrier = carrier
                                                    , active = True
                                                    , targetGI = False
                                                    }
                                                )
                                                settings.carrierContracts
                                    }

                                GIRecommended ->
                                    { settings
                                        | stateCarrierSettings =
                                            List.map
                                                (\carrier ->
                                                    { carrier = carrier
                                                    , active = True
                                                    , targetGI =
                                                        List.any
                                                            (\rec -> rec.carrier == carrier)
                                                            model.recommendedGICombos
                                                    }
                                                )
                                                settings.carrierContracts
                                    }
                    in
                    ( { model | orgSettings = Just newSettings }
                    , saveSettings { settings = Just newSettings, logo = model.logo }
                    )

                Nothing ->
                    ( model, Cmd.none )

        GotRecommendedGICombos result ->
            case result of
                Ok combos ->
                    ( { model | recommendedGICombos = combos }
                    , Cmd.none
                    )

                Err error ->
                    ( { model | status = Error "Failed to load GI recommendations" }
                    , Cmd.none
                    )

        ToggleAllowAgentSettings value ->
            updateSettings model (\s -> { s | allowAgentSettings = value })

        FinishSetup ->
            case model.currentUser of
                Just user ->
                    if model.planType == "basic" then
                        ( { model | isLoading = True }
                        , finalizeOrganization user.organizationSlug
                        )

                    else
                        ( model
                        , Nav.pushUrl model.key "/dashboard"
                        )

                Nothing ->
                    ( model
                    , Nav.pushUrl model.key "/dashboard"
                    )

        OrgFinalized result ->
            case result of
                Ok _ ->
                    ( { model | isLoading = False }
                    , Nav.pushUrl model.key "/dashboard"
                    )

                Err error ->
                    let
                        errorMessage =
                            case error of
                                Http.BadStatus 500 ->
                                    "Failed to set up your organization's database. Please contact support at help@medicaremax.com and we'll help you get started."

                                Http.BadBody message ->
                                    message ++ "\nPlease contact support at help@medicaremax.com and we'll help you get started."

                                _ ->
                                    "An unexpected error occurred. Please contact support at help@medicaremax.com and we'll help you get started."
                    in
                    ( { model
                        | isLoading = False
                        , error = Just errorMessage
                      }
                    , Cmd.none
                    )

        SelectCarrier carrier ->
            ( { model | selectedCarrier = Just carrier }, Cmd.none )

        UpdateBrandName name ->
            updateSettings model (\s -> { s | brandName = name })

        UpdatePrimaryColor color ->
            updateSettings model (\s -> { s | primaryColor = color })

        UpdateSecondaryColor color ->
            updateSettings model (\s -> { s | secondaryColor = color })

        UploadLogo ->
            ( model
            , Select.file [ "image/png", "image/jpeg" ] GotLogo
            )

        GotLogo file ->
            ( model
            , Task.perform GotLogoUrl (File.toUrl file)
            )

        GotLogoUrl url ->
            case model.orgSettings of
                Just settings ->
                    ( { model | logo = Just url, orgSettings = Just { settings | logo = Just url } }
                    , saveSettings { settings = Just { settings | logo = Just url }, logo = Just url }
                    )

                Nothing ->
                    ( model, Cmd.none )

        LogoUploaded result ->
            case result of
                Ok url ->
                    updateSettings model (\s -> { s | logo = Just url })

                Err _ ->
                    ( { model | status = Error "Failed to upload logo" }, Cmd.none )

        CopySelfOnboardingLink ->
            let
                slug =
                    model.currentUser
                        |> Maybe.map .organizationSlug
                        |> Maybe.withDefault ""

                url =
                    model.selfOnboardingUrl
                        |> Maybe.withDefault ("http://localhost:5173/self-onboarding/" ++ slug)

                -- Command to copy link to clipboard using ports
                copyCmd =
                    Ports.copyToClipboard url
            in
            ( { model | linkCopied = False }, copyCmd )

        LinkCopied success ->
            ( { model | linkCopied = success }, Cmd.none )

        GotSelfOnboardingUrl result ->
            case result of
                Ok response ->
                    ( { model | selfOnboardingUrl = Just response.selfOnboardingUrl }, Cmd.none )

                Err _ ->
                    ( model, Cmd.none )


updateSettings : Model -> (Settings -> Settings) -> ( Model, Cmd Msg )
updateSettings model updateFn =
    case model.orgSettings of
        Just settings ->
            let
                newSettings =
                    updateFn settings
            in
            ( { model | orgSettings = Just newSettings }
            , saveSettings { settings = Just newSettings, logo = model.logo }
            )

        Nothing ->
            ( model, Cmd.none )


saveSettings : { settings : Maybe Settings, logo : Maybe String } -> Cmd Msg
saveSettings { settings, logo } =
    Http.request
        { method = "PUT"
        , headers = []
        , url = "/api/settings/org"
        , body = jsonBody (Encode.object [ ( "settings", Maybe.withDefault Encode.null (Maybe.map encodeSettings settings) ), ( "logo", Maybe.withDefault Encode.null (Maybe.map Encode.string logo) ) ])
        , expect = expectJson SettingsSaved settingsObjectDecoder
        , timeout = Nothing
        , tracker = Nothing
        }


encodeSettings : Settings -> Encode.Value
encodeSettings settings =
    Encode.object
        [ ( "carrierContracts", Encode.list Encode.string settings.carrierContracts )
        , ( "stateCarrierSettings", Encode.list stateCarrierSettingEncoder settings.stateCarrierSettings )
        , ( "allowAgentSettings", Encode.bool settings.allowAgentSettings )
        , ( "emailSendBirthday", Encode.bool settings.emailSendBirthday )
        , ( "emailSendPolicyAnniversary", Encode.bool settings.emailSendPolicyAnniversary )
        , ( "emailSendAep", Encode.bool settings.emailSendAep )
        , ( "smartSendEnabled", Encode.bool settings.smartSendEnabled )
        , ( "brandName", Encode.string settings.brandName )
        , ( "primaryColor", Encode.string settings.primaryColor )
        , ( "secondaryColor", Encode.string settings.secondaryColor )
        , ( "logo", Maybe.withDefault Encode.null (Maybe.map Encode.string settings.logo) )
        ]


stateCarrierSettingEncoder : StateCarrierSetting -> Encode.Value
stateCarrierSettingEncoder setting =
    Encode.object
        [ ( "carrier", Encode.string setting.carrier )
        , ( "active", Encode.bool setting.active )
        , ( "targetGI", Encode.bool setting.targetGI )
        ]


view : Model -> Browser.Document Msg
view model =
    { title =
        if model.isSetup then
            "Organization Setup - Settings"

        else
            "Settings"
    , body =
        [ if model.isSetup then
            SetupLayout.view SetupLayout.OrganizationSetup
                (model.planType == "basic")
                5
                [ if model.isLoading then
                    viewLoading

                  else
                    viewSettings model
                ]

          else
            div [ class "min-h-screen bg-gray-50" ]
                [ viewHeader
                , div [ class "max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8" ]
                    [ if model.isLoading then
                        viewLoading

                      else
                        viewSettings model
                    ]
                ]
        ]
    }


viewSetupHeader : Html Msg
viewSetupHeader =
    div [ class "mb-8" ]
        [ h1 [ class "text-3xl font-bold text-gray-900" ]
            [ text "Set Up Your Organization" ]
        , p [ class "mt-2 text-gray-600" ]
            [ text "Configure your organization's settings to get started" ]
        ]


viewNormalHeader : Html Msg
viewNormalHeader =
    h1 [ class "text-2xl font-semibold text-[#03045E] mb-6" ]
        [ text "Organization Settings" ]


viewBottomBar : Model -> Html Msg
viewBottomBar model =
    div
        [ class """sticky bottom-0 left-0 right-0 bg-white border-t border-gray-200 
                  px-4 py-4 sm:px-6 lg:px-8 flex justify-end items-center
                  mt-8 max-w-4xl mx-auto"""
        ]
        [ case model.error of
            Just errorMsg ->
                div [ class "text-red-600 text-sm max-w-xl" ]
                    [ text errorMsg ]

            Nothing ->
                text ""
        ]


viewSettingsContent : Maybe Settings -> Bool -> List String -> String -> Model -> Html Msg
viewSettingsContent maybeSettings canEdit expandedSections planType model =
    case maybeSettings of
        Just settings ->
            div [ class "space-y-6" ]
                [ viewBrandSettings settings model
                , viewEmailSettings settings
                , viewSelfOnboardingLink model
                , viewExpandableSection "Carrier Contracts"
                    (viewCarriersGrid settings model)
                    expandedSections
                , viewExpandableSection "State & Carrier Settings"
                    (viewStateCarrierGrid settings model)
                    expandedSections
                ]

        Nothing ->
            div [ class "text-gray-500 italic" ]
                [ text "Using organization settings" ]


viewBrandSettings : Settings -> Model -> Html Msg
viewBrandSettings settings model =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ h2 [ class "text-lg font-medium mb-4" ] [ text "Agency Settings" ]
        , div [ class "space-y-6" ]
            [ div [ class "space-y-4" ]
                [ viewFormGroup "Agency Name"
                    (input
                        [ type_ "text"
                        , class "w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        , value settings.brandName
                        , onInput UpdateBrandName
                        ]
                        []
                    )
                , viewFormGroup "Primary Color"
                    (div [ class "flex items-center space-x-4" ]
                        [ input
                            [ type_ "color"
                            , class "w-16 h-10 p-1 border border-gray-300 rounded"
                            , value settings.primaryColor
                            , onInput UpdatePrimaryColor
                            ]
                            []
                        , input
                            [ type_ "text"
                            , class "flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                            , value settings.primaryColor
                            , onInput UpdatePrimaryColor
                            ]
                            []
                        ]
                    )
                , viewFormGroup "Secondary Color"
                    (div [ class "flex items-center space-x-4" ]
                        [ input
                            [ type_ "color"
                            , class "w-16 h-10 p-1 border border-gray-300 rounded"
                            , value settings.secondaryColor
                            , onInput UpdateSecondaryColor
                            ]
                            []
                        , input
                            [ type_ "text"
                            , class "flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                            , value settings.secondaryColor
                            , onInput UpdateSecondaryColor
                            ]
                            []
                        ]
                    )
                , viewFormGroup "Logo"
                    (div [ class "flex items-center space-x-4" ]
                        [ case model.logo of
                            Just logoUrl ->
                                div [ class "flex items-center space-x-4" ]
                                    [ img
                                        [ src logoUrl
                                        , class "h-16 w-16 object-contain border border-gray-200 rounded"
                                        ]
                                        []
                                    , button
                                        [ class "px-4 py-2 text-sm text-purple-600 hover:text-purple-800"
                                        , onClick UploadLogo
                                        ]
                                        [ text "Change Logo" ]
                                    ]

                            Nothing ->
                                button
                                    [ class "px-4 py-2 text-sm text-purple-600 hover:text-purple-800 border border-purple-200 rounded"
                                    , onClick UploadLogo
                                    ]
                                    [ text "Upload Logo" ]
                        ]
                    )
                ]
            ]
        ]


viewFormGroup : String -> Html Msg -> Html Msg
viewFormGroup labelText content =
    div [ class "mb-4" ]
        [ label [ class "block text-sm font-medium text-gray-700 mb-2" ]
            [ text labelText ]
        , content
        ]


viewEmailSettings : Settings -> Html Msg
viewEmailSettings settings =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ h2 [ class "text-lg font-medium mb-4" ] [ text "Email Settings" ]
        , div [ class "space-y-4" ]
            [ checkbox "Enable smart send" settings.smartSendEnabled ToggleSmartSend
            ]
        ]


viewSelfOnboardingLink : Model -> Html Msg
viewSelfOnboardingLink model =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ h2 [ class "text-lg font-medium mb-4" ] [ text "Self Onboarding" ]
        , div [ class "space-y-4" ]
            [ p [ class "mb-4 text-gray-600" ]
                [ text "Share this link with companies that need to self-onboard into your platform." ]
            , div [ class "flex items-center space-x-3" ]
                [ let
                    slug =
                        model.currentUser
                            |> Maybe.map .organizationSlug
                            |> Maybe.withDefault ""

                    selfOnboardingUrl =
                        model.selfOnboardingUrl
                            |> Maybe.withDefault ("/self-onboarding/" ++ slug)
                  in
                  div [ class "flex-1 flex items-center space-x-4" ]
                    [ input
                        [ type_ "text"
                        , class "flex-1 px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 bg-gray-50"
                        , value selfOnboardingUrl
                        , readonly True
                        ]
                        []
                    , button
                        [ class "px-4 py-2 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
                        , onClick CopySelfOnboardingLink
                        ]
                        [ text
                            (if model.linkCopied then
                                "Copied!"

                             else
                                "Copy Link"
                            )
                        ]
                    ]
                ]
            ]
        ]


checkbox : String -> Bool -> (Bool -> msg) -> Html msg
checkbox labelText isChecked onToggle =
    Html.label [ class "flex items-center space-x-3" ]
        [ input
            [ type_ "checkbox"
            , checked isChecked
            , onCheck onToggle
            , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            ]
            []
        , span [ class "text-gray-700" ] [ text labelText ]
        ]


viewExpandableSection : String -> Html Msg -> List String -> Html Msg
viewExpandableSection title content expandedSections =
    let
        isExpanded =
            List.member title expandedSections
    in
    div [ class "bg-white shadow rounded-lg overflow-hidden" ]
        [ button
            [ class "w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50"
            , onClick (ToggleSection title)
            ]
            [ h2 [ class "text-lg font-medium" ] [ text title ]
            , div
                [ class "transform transition-transform"
                , classList [ ( "rotate-180", isExpanded ) ]
                ]
                [ text "▼" ]
            ]
        , div
            [ class "px-6 pb-6"
            , classList [ ( "hidden", not isExpanded ) ]
            ]
            [ content ]
        ]


viewCarriersGrid : Settings -> Model -> Html Msg
viewCarriersGrid settings model =
    let
        carriersToUse =
            if List.isEmpty model.loadedCarriers then
                allCarriers

            else
                model.loadedCarriers
    in
    div []
        [ div [ class "mb-4 flex items-center" ]
            [ checkbox "Select All Carriers"
                (List.length settings.carrierContracts == List.length carriersToUse)
                ToggleAllCarriers
            ]
        , div [ class "grid grid-cols-2 sm:grid-cols-3 gap-4" ]
            (List.map
                (\carrier ->
                    checkbox carrier
                        (List.member carrier settings.carrierContracts)
                        (\checked ->
                            if checked then
                                AddCarrierContract carrier

                            else
                                RemoveCarrierContract carrier
                        )
                )
                carriersToUse
            )
        ]


viewStateCarrierGrid : Settings -> Model -> Html Msg
viewStateCarrierGrid settings model =
    let
        carriersToUse =
            if List.isEmpty model.loadedCarriers then
                allCarriers

            else
                model.loadedCarriers
    in
    div []
        [ div [ class "mb-6" ]
            [ h3 [ class "text-sm font-medium text-gray-700 mb-2" ]
                [ text "SmartSend for Guaranteed Issue" ]
            , div [ class "flex items-start p-4 bg-blue-50 rounded-md mb-6" ]
                [ div [ class "flex items-center h-5" ]
                    [ input
                        [ type_ "checkbox"
                        , checked settings.smartSendEnabled
                        , onCheck ToggleSmartSend
                        , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        ]
                        []
                    ]
                , div [ class "ml-3 text-sm" ]
                    [ label [ class "font-medium text-gray-700" ]
                        [ text "Use SmartSend for Guaranteed Issue" ]
                    , p [ class "text-gray-500 mt-1" ]
                        [ text "When enabled, SmartSend will automatically identify which carriers offer full compensation for Guaranteed Issue (GI) policies." ]
                    ]
                ]
            , div [ class "mt-4 p-4 bg-gray-50 rounded-md mb-8" ]
                [ h3 [ class "text-md font-medium text-gray-900 mb-2" ]
                    [ text "How SmartSend Works" ]
                , p [ class "text-gray-600" ]
                    [ text "SmartSend analyzes each carrier to determine which ones offer full carrier compensation for Guaranteed Issue policies. This helps maximize your commissions while ensuring your quotes are always compliant with the latest carrier regulations." ]
                ]
            ]
        ]


option : List (Attribute msg) -> List (Html msg) -> Html msg
option attributes children =
    Html.option attributes children



-- Helper functions for state/carrier grid


hasDefaultSettings : Settings -> Bool
hasDefaultSettings settings =
    List.all
        (\setting -> setting.active && not setting.targetGI)
        settings.stateCarrierSettings


findStateCarrierSetting : Settings -> String -> StateCarrierSetting
findStateCarrierSetting settings carrier =
    settings.stateCarrierSettings
        |> List.filter (\s -> s.carrier == carrier)
        |> List.head
        |> Maybe.withDefault
            { carrier = carrier
            , active = True
            , targetGI = False
            }


viewStateCarrierCell : StateCarrierSetting -> Html Msg
viewStateCarrierCell setting =
    div [ class "flex flex-col items-center gap-1" ]
        [ label [ class "flex items-center gap-2 cursor-pointer" ]
            [ input
                [ type_ "checkbox"
                , checked setting.active
                , onCheck (\active -> UpdateStateCarrierSetting setting.carrier active setting.targetGI)
                , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                ]
                []
            , span [ class "text-sm text-gray-600" ] [ text "Active" ]
            ]
        , label [ class "flex items-center gap-2 cursor-pointer" ]
            [ input
                [ type_ "checkbox"
                , checked setting.targetGI
                , onCheck (\targetGI -> UpdateStateCarrierSetting setting.carrier setting.active targetGI)
                , class "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                ]
                []
            , span [ class "text-xs ml-1" ] [ text "GI" ]
            ]
        ]



-- Encoders and Decoders


settingsDecoder : Decoder SettingsResponse
settingsDecoder =
    let
        boolDecoder =
            Decode.oneOf
                [ Decode.bool
                , Decode.map (\n -> n == 1) Decode.int
                ]
    in
    Decode.field "success" Decode.bool
        |> Decode.andThen
            (\success ->
                if success then
                    Decode.map3 SettingsResponse
                        (Decode.field "orgSettings" settingsObjectDecoder)
                        (Decode.field "logo" (Decode.nullable Decode.string))
                        (Decode.field "canEditOrgSettings" boolDecoder)

                else
                    Decode.fail "Settings request was not successful"
            )


settingsObjectDecoder : Decoder Settings
settingsObjectDecoder =
    let
        stateCarrierSettingsDecoder =
            Decode.field "stateCarrierSettings" <|
                Decode.oneOf
                    [ Decode.list stateCarrierSettingDecoder
                    , Decode.null []
                    ]
    in
    Decode.succeed Settings
        |> Pipeline.required "carrierContracts" (Decode.list Decode.string)
        |> Pipeline.custom stateCarrierSettingsDecoder
        |> Pipeline.required "allowAgentSettings" Decode.bool
        |> Pipeline.required "emailSendBirthday" Decode.bool
        |> Pipeline.required "emailSendPolicyAnniversary" Decode.bool
        |> Pipeline.required "emailSendAep" Decode.bool
        |> Pipeline.required "smartSendEnabled" Decode.bool
        |> Pipeline.optional "brandName" Decode.string ""
        |> Pipeline.optional "primaryColor" Decode.string "#6B46C1"
        |> Pipeline.optional "secondaryColor" Decode.string "#9F7AEA"
        |> Pipeline.optional "logo" (Decode.nullable Decode.string) Nothing


stateCarrierSettingDecoder : Decoder StateCarrierSetting
stateCarrierSettingDecoder =
    Decode.map3 StateCarrierSetting
        (Decode.field "carrier" Decode.string)
        (Decode.field "active" Decode.bool)
        (Decode.field "targetGI" Decode.bool)


recommendationsDecoder : Decoder (List StateCarrierSetting)
recommendationsDecoder =
    Decode.list
        (Decode.map3 StateCarrierSetting
            (Decode.field "carrier" Decode.string)
            (Decode.field "active" Decode.bool)
            (Decode.field "targetGI" Decode.bool)
        )


subscriptions : Model -> Sub Msg
subscriptions _ =
    Ports.onCopyResult LinkCopied


tab : String -> Bool -> Bool -> msg -> Html msg
tab label isActive isDisabled msg =
    button
        [ class "px-3 py-2 font-medium text-sm rounded-md -mb-px"
        , classList
            [ ( "text-indigo-600 border-indigo-500 border-b-2", isActive )
            , ( "text-gray-500 hover:text-gray-700 hover:border-gray-300 border-transparent border-b-2"
              , not isActive && not isDisabled
              )
            , ( "text-gray-400 cursor-not-allowed", isDisabled )
            ]
        , onClick msg
        , disabled isDisabled
        ]
        [ text label ]


viewNavLink : String -> String -> Html Msg
viewNavLink label path =
    a
        [ class "text-gray-700 hover:text-gray-900 hover:bg-gray-50 group flex items-center px-3 py-2 text-sm font-medium rounded-md"
        , href path
        ]
        [ text label ]


viewNavigation : Model -> Html Msg
viewNavigation model =
    nav []
        [ case model.currentUser of
            Just user ->
                if user.isAdmin then
                    viewNavLink "Manage Agents" "/agents"

                else
                    text ""

            Nothing ->
                text ""
        ]


viewLoading : Html msg
viewLoading =
    div [ class "flex justify-center items-center h-64" ]
        [ div [ class "animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent" ] []
        ]


viewHeader : Html msg
viewHeader =
    nav [ class "bg-white border-b border-gray-200" ]
        [ div [ class "max-w-4xl mx-auto px-4 sm:px-6 lg:px-8" ]
            [ div [ class "flex justify-between h-16" ]
                [ div [ class "flex" ]
                    [ div [ class "flex-shrink-0 flex items-center" ]
                        [ h1 [ class "text-xl font-semibold text-purple-600" ]
                            [ text "Organization Settings" ]
                        ]
                    ]
                ]
            ]
        ]


viewSettings : Model -> Html Msg
viewSettings model =
    div [ class "space-y-8" ]
        [ case model.orgSettings of
            Just settings ->
                div [ class "space-y-6" ]
                    [ viewBrandSettings settings model
                    , viewEmailSettings settings
                    , viewSelfOnboardingLink model
                    , viewExpandableSection "Carrier Contracts"
                        (viewCarriersGrid settings model)
                        model.expandedSections
                    , viewExpandableSection "State & Carrier Settings"
                        (viewStateCarrierGrid settings model)
                        model.expandedSections
                    ]

            Nothing ->
                div [ class "text-gray-500 italic" ]
                    [ text "Loading settings..." ]
        , viewBottomBar model
        ]


finalizeOrganization : String -> Cmd Msg
finalizeOrganization orgSlug =
    Http.post
        { url = "/api/organizations/" ++ orgSlug ++ "/setup-database"
        , body = Http.emptyBody
        , expect = Http.expectWhatever OrgFinalized
        }

================
File: src/Signup.elm
================
module Signup exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Components.ProgressIndicator as ProgressIndicator exposing (Step)
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onBlur, onInput, onSubmit)
import Http
import Json.Decode as Decode
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes exposing (d, fill, stroke, strokeLinecap, strokeLinejoin, strokeWidth, viewBox)
import Url



-- MODEL


type alias Model =
    { organizationName : String
    , adminFirstName : String
    , adminLastName : String
    , adminEmail : String
    , error : Maybe String
    , isSubmitting : Bool
    , submitted : Bool
    , orgNameStatus : OrgNameStatus
    , emailStatus : EmailStatus
    , currentStep : SignupStep
    , key : Nav.Key
    }


type OrgNameStatus
    = NotChecked
    | Checking
    | Valid
    | Invalid String


type EmailStatus
    = EmailNotChecked
    | EmailChecking
    | EmailValid
    | EmailInvalid String


type Msg
    = UpdateOrganizationName String
    | CheckOrganizationName
    | GotOrgNameResponse (Result Http.Error OrgNameResponse)
    | UpdateAdminFirstName String
    | UpdateAdminLastName String
    | UpdateAdminEmail String
    | CheckAdminEmail
    | GotEmailResponse (Result Http.Error EmailResponse)
    | SubmitForm
    | GotSignupResponse (Result Http.Error SignupResponse)


type alias SignupResponse =
    { success : Bool
    , message : String
    }


type alias OrgNameResponse =
    { available : Bool
    , message : String
    }


type alias EmailResponse =
    { available : Bool
    , message : String
    }


type SignupStep
    = AccountSetup
    | CompanyDetails
    | CompanyStyle
    | SetupPayment


init : Nav.Key -> ( Model, Cmd Msg )
init key =
    ( { organizationName = ""
      , adminFirstName = ""
      , adminLastName = ""
      , adminEmail = ""
      , error = Nothing
      , isSubmitting = False
      , submitted = False
      , orgNameStatus = NotChecked
      , emailStatus = EmailNotChecked
      , currentStep = AccountSetup
      , key = key
      }
    , Cmd.none
    )



-- UPDATE


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateOrganizationName value ->
            ( { model
                | organizationName = value
                , orgNameStatus = NotChecked -- Clear status when typing
              }
            , Cmd.none
            )

        CheckOrganizationName ->
            if String.length model.organizationName >= 1 then
                ( { model | orgNameStatus = Checking }
                  -- Show loading state
                , checkOrgName model.organizationName
                )

            else
                ( { model | orgNameStatus = NotChecked }
                , Cmd.none
                )

        GotOrgNameResponse (Ok response) ->
            ( { model
                | orgNameStatus =
                    if response.available then
                        Valid

                    else
                        Invalid response.message
              }
            , Cmd.none
            )

        GotOrgNameResponse (Err _) ->
            ( { model
                | orgNameStatus = Invalid "Failed to check organization name"
              }
            , Cmd.none
            )

        UpdateAdminFirstName value ->
            ( { model | adminFirstName = value }, Cmd.none )

        UpdateAdminLastName value ->
            ( { model | adminLastName = value }, Cmd.none )

        UpdateAdminEmail value ->
            ( { model
                | adminEmail = value
                , emailStatus = EmailNotChecked
              }
            , Cmd.none
            )

        CheckAdminEmail ->
            if String.isEmpty (String.trim model.adminEmail) then
                ( { model | emailStatus = EmailNotChecked }
                , Cmd.none
                )

            else if model.emailStatus == EmailChecking then
                ( model, Cmd.none )

            else
                ( { model | emailStatus = EmailChecking }
                , checkEmail model.adminEmail
                )

        GotEmailResponse result ->
            case result of
                Ok response ->
                    ( { model
                        | emailStatus =
                            if response.available then
                                EmailValid

                            else
                                EmailInvalid response.message
                      }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model
                        | emailStatus = EmailInvalid "Failed to check email availability"
                      }
                    , Cmd.none
                    )

        SubmitForm ->
            if isFormValid model then
                ( { model | isSubmitting = True }
                , Nav.pushUrl model.key "/onboarding"
                )

            else
                ( { model | error = Just "Please fill out all fields and ensure email and organization name are valid" }
                , Cmd.none
                )

        GotSignupResponse (Ok response) ->
            if response.success then
                ( { model
                    | isSubmitting = False
                    , submitted = True
                    , error = Nothing
                  }
                , Cmd.none
                )

            else
                ( { model
                    | error = Just response.message
                    , isSubmitting = False
                  }
                , Cmd.none
                )

        GotSignupResponse (Err _) ->
            ( { model
                | error = Just "Failed to create organization. Please try again."
                , isSubmitting = False
              }
            , Cmd.none
            )


validateForm : Model -> Bool
validateForm model =
    not (String.isEmpty model.organizationName)
        && not (String.isEmpty model.adminFirstName)
        && not (String.isEmpty model.adminLastName)
        && not (String.isEmpty model.adminEmail)


submitForm : Model -> Cmd Msg
submitForm model =
    Http.post
        { url = "/api/organizations/signup"
        , body =
            Http.jsonBody
                (Encode.object
                    [ ( "organizationName", Encode.string model.organizationName )
                    , ( "adminFirstName", Encode.string model.adminFirstName )
                    , ( "adminLastName", Encode.string model.adminLastName )
                    , ( "adminEmail", Encode.string model.adminEmail )
                    ]
                )
        , expect =
            Http.expectJson GotSignupResponse
                (Decode.map2 SignupResponse
                    (Decode.field "success" Decode.bool)
                    (Decode.field "message" Decode.string)
                )
        }



-- Add this function to check organization name


checkOrgName : String -> Cmd Msg
checkOrgName name =
    if String.isEmpty (String.trim name) then
        Cmd.none

    else
        Http.get
            { url = "/api/organizations/check-name/" ++ Url.percentEncode (String.trim name)
            , expect =
                Http.expectJson GotOrgNameResponse
                    (Decode.map2 OrgNameResponse
                        (Decode.field "available" Decode.bool)
                        (Decode.field "message" Decode.string)
                    )
            }



-- Add this function to check email


checkEmail : String -> Cmd Msg
checkEmail email =
    Http.get
        { url = "/api/organizations/check-email/" ++ Url.percentEncode email
        , expect = Http.expectJson GotEmailResponse emailResponseDecoder
        }


emailResponseDecoder : Decode.Decoder EmailResponse
emailResponseDecoder =
    Decode.map2 EmailResponse
        (Decode.field "available" Decode.bool)
        (Decode.field "message" Decode.string)



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Create Organization"
    , body =
        [ div [ class "min-h-screen bg-gray-50 flex" ]
            [ viewProgress model
            , div [ class "flex-1 ml-80" ]
                [ div [ class "max-w-2xl mx-auto py-12 px-8" ]
                    [ if model.submitted then
                        viewSuccess

                      else
                        viewForm model
                    ]
                ]
            ]
        ]
    }


viewSuccess : Html Msg
viewSuccess =
    div [ class "text-center" ]
        [ div [ class "mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100" ]
            [ -- Checkmark icon
              svg
                [ Svg.Attributes.class "h-6 w-6 text-green-600"
                , Svg.Attributes.fill "none"
                , Svg.Attributes.viewBox "0 0 24 24"
                , Svg.Attributes.stroke "currentColor"
                ]
                [ path
                    [ Svg.Attributes.strokeLinecap "round"
                    , Svg.Attributes.strokeLinejoin "round"
                    , Svg.Attributes.strokeWidth "2"
                    , Svg.Attributes.d "M5 13l4 4L19 7"
                    ]
                    []
                ]
            ]
        , h3 [ class "mt-3 text-lg font-medium text-gray-900" ]
            [ text "Check your email" ]
        , p [ class "mt-2 text-sm text-gray-500" ]
            [ text "We've sent you a magic link to verify your account and complete the setup." ]
        ]


viewForm : Model -> Html Msg
viewForm model =
    Html.form [ onSubmit SubmitForm, class "space-y-6 max-w-md" ]
        [ h1 [ class "text-2xl font-semibold text-[#101828] mb-2" ]
            [ text "Agent Details" ]
        , p [ class "text-[#667085] text-base mb-8" ]
            [ text "Let's get to know you" ]
        , -- Form fields
          div [ class "space-y-6" ]
            [ -- Email field first
              div []
                [ label [ for "admin-email", class "block text-sm font-medium text-[#344054] mb-1.5" ]
                    [ text "Email" ]
                , div [ class "mt-1" ]
                    [ input
                        [ type_ "email"
                        , id "admin-email"
                        , value model.adminEmail
                        , onInput UpdateAdminEmail
                        , onBlur CheckAdminEmail
                        , class "block w-full px-3.5 py-2.5 bg-white border border-[#d0d5dd] rounded-lg shadow-sm text-[#101828] focus:outline-none focus:ring-2 focus:ring-[#03045e] focus:border-[#03045e] sm:text-sm"
                        , placeholder "Enter your email"
                        ]
                        []
                    , viewEmailStatus model.emailStatus
                    ]
                ]

            -- Organization name field second
            , div []
                [ label [ for "organization-name", class "block text-sm font-medium text-[#344054] mb-1.5" ]
                    [ text "Organization name" ]
                , div [ class "mt-1" ]
                    [ input
                        [ type_ "text"
                        , id "organization-name"
                        , value model.organizationName
                        , onInput UpdateOrganizationName
                        , onBlur CheckOrganizationName
                        , class "block w-full px-3.5 py-2.5 bg-white border border-[#d0d5dd] rounded-lg shadow-sm text-[#101828] focus:outline-none focus:ring-2 focus:ring-[#03045e] focus:border-[#03045e] sm:text-sm"
                        , placeholder "Enter organization name"
                        ]
                        []
                    , viewOrgNameStatus model.orgNameStatus
                    ]
                ]

            -- First Name field third
            , div []
                [ label [ for "admin-first-name", class "block text-sm font-medium text-[#344054] mb-1.5" ]
                    [ text "First Name" ]
                , div [ class "mt-1" ]
                    [ input
                        [ type_ "text"
                        , id "admin-first-name"
                        , value model.adminFirstName
                        , onInput UpdateAdminFirstName
                        , class "block w-full px-3 sm:px-3.5 py-3 sm:py-2.5 bg-white border border-[#d0d5dd] rounded-lg shadow-sm text-[#101828] focus:outline-none focus:ring-2 focus:ring-[#03045e] focus:border-[#03045e] sm:text-sm"
                        , placeholder "Enter your first name"
                        ]
                        []
                    ]
                ]

            -- Last Name field fourth
            , div []
                [ label [ for "admin-last-name", class "block text-sm font-medium text-[#344054] mb-1.5" ]
                    [ text "Last Name" ]
                , div [ class "mt-1" ]
                    [ input
                        [ type_ "text"
                        , id "admin-last-name"
                        , value model.adminLastName
                        , onInput UpdateAdminLastName
                        , class "block w-full px-3 sm:px-3.5 py-3 sm:py-2.5 bg-white border border-[#d0d5dd] rounded-lg shadow-sm text-[#101828] focus:outline-none focus:ring-2 focus:ring-[#03045e] focus:border-[#03045e] sm:text-sm"
                        , placeholder "Enter your last name"
                        ]
                        []
                    ]
                ]
            ]
        , -- Submit button
          button
            [ type_ "submit"
            , class (submitButtonClass model)
            , disabled (not (isFormValid model) || model.isSubmitting)
            ]
            [ if model.isSubmitting then
                text "Creating Organization..."

              else
                text "Continue"
            ]
        ]


viewOrgNameStatus : OrgNameStatus -> Html Msg
viewOrgNameStatus status =
    div [ class "mt-1 transition-all duration-200" ]
        [ case status of
            NotChecked ->
                text ""

            Checking ->
                div [ class "text-blue-600 text-sm flex items-center" ]
                    [ -- Loading spinner
                      div [ class "animate-spin h-4 w-4 mr-2 border-2 border-blue-600 border-t-transparent rounded-full" ] []
                    , text "Checking availability..."
                    ]

            Valid ->
                div [ class "text-green-600 text-sm flex items-center" ]
                    [ -- Checkmark icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M5 13l4 4L19 7"
                            ]
                            []
                        ]
                    , text "Organization name is available"
                    ]

            Invalid message ->
                div [ class "text-red-600 text-sm flex items-center" ]
                    [ -- X icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M6 18L18 6M6 6l12 12"
                            ]
                            []
                        ]
                    , text message
                    ]
        ]


viewEmailStatus : EmailStatus -> Html Msg
viewEmailStatus status =
    div [ class "mt-1 transition-all duration-200" ]
        [ case status of
            EmailNotChecked ->
                text ""

            EmailChecking ->
                div [ class "text-blue-600 text-sm flex items-center" ]
                    [ div [ class "animate-spin h-4 w-4 mr-2 border-2 border-blue-600 border-t-transparent rounded-full" ] []
                    , text "Checking availability..."
                    ]

            EmailValid ->
                div [ class "text-green-600 text-sm flex items-center" ]
                    [ -- Checkmark icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M5 13l4 4L19 7"
                            ]
                            []
                        ]
                    , text "Email is available"
                    ]

            EmailInvalid message ->
                div [ class "text-red-600 text-sm flex items-center" ]
                    [ -- X icon
                      svg
                        [ Svg.Attributes.class "h-4 w-4 mr-1"
                        , Svg.Attributes.fill "none"
                        , Svg.Attributes.viewBox "0 0 24 24"
                        , Svg.Attributes.stroke "currentColor"
                        ]
                        [ path
                            [ Svg.Attributes.strokeLinecap "round"
                            , Svg.Attributes.strokeLinejoin "round"
                            , Svg.Attributes.strokeWidth "2"
                            , Svg.Attributes.d "M6 18L18 6M6 6l12 12"
                            ]
                            []
                        ]
                    , text message
                    ]
        ]


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none



-- Add this helper function


isFormValid : Model -> Bool
isFormValid model =
    let
        isEmailValid =
            not (String.isEmpty (String.trim model.adminEmail))
                && String.contains "@" model.adminEmail
                && String.contains "." model.adminEmail
                && model.emailStatus
                == EmailValid

        isOrgValid =
            not (String.isEmpty (String.trim model.organizationName))
                && model.orgNameStatus
                == Valid

        areNamesValid =
            not (String.isEmpty (String.trim model.adminFirstName))
                && not (String.isEmpty (String.trim model.adminLastName))
    in
    isEmailValid && isOrgValid && areNamesValid



-- Add helper function for submit button classes


submitButtonClass : Model -> String
submitButtonClass model =
    "w-full flex justify-center py-3 sm:py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium transition-colors "
        ++ (if isFormValid model then
                "text-white bg-[#03045e] hover:bg-[#03045e]/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#03045e]"

            else
                "text-white bg-[#03045e]/60 cursor-not-allowed"
           )


viewProgress : Model -> Html Msg
viewProgress model =
    let
        currentStep =
            case model.currentStep of
                AccountSetup ->
                    1

                CompanyDetails ->
                    2

                CompanyStyle ->
                    3

                SetupPayment ->
                    4

        makeStep : Int -> String -> String -> String -> Step
        makeStep stepNum icon title description =
            { icon = icon
            , title = title
            , description = description
            , isCompleted = stepNum < currentStep
            , isActive = stepNum == currentStep
            }
    in
    ProgressIndicator.view
        [ makeStep 1 "👤" "Your Details" "Please provide your name and email"
        , makeStep 2 "🏢" "Company Details" "General info for your Company"
        , makeStep 3 "⚙️" "Company Style" "Style your platform"
        , makeStep 4 "💳" "Setup Payment" "The final step to get started"
        ]

================
File: src/StateRegions.elm
================
module StateRegions exposing (Region(..), allRegions, getRegionStates, regionToString, stringToRegion)


type Region
    = WestCoast
    | EastCoast
    | South
    | Midwest


allRegions : List Region
allRegions =
    [ WestCoast, EastCoast, South, Midwest ]


regionToString : Region -> String
regionToString region =
    case region of
        WestCoast ->
            "West Coast"

        EastCoast ->
            "East Coast"

        South ->
            "South"

        Midwest ->
            "Midwest"


stringToRegion : String -> Maybe Region
stringToRegion str =
    case str of
        "west" ->
            Just WestCoast

        "east" ->
            Just EastCoast

        "south" ->
            Just South

        "midwest" ->
            Just Midwest

        _ ->
            Nothing


getRegionStates : Region -> List String
getRegionStates region =
    case region of
        WestCoast ->
            [ "CA", "OR", "WA", "AK", "HI" ]

        EastCoast ->
            [ "ME", "NH", "VT", "MA", "RI", "CT", "NY", "NJ", "PA", "DE", "MD", "DC" ]

        South ->
            [ "VA", "NC", "SC", "GA", "FL", "AL", "MS", "LA", "AR", "TN", "KY", "WV", "TX", "OK" ]

        Midwest ->
            [ "OH", "MI", "IN", "IL", "WI", "MN", "IA", "MO", "ND", "SD", "NE", "KS", "MT", "WY", "CO", "ID", "NV", "NM", "AZ", "UT" ]

================
File: src/Subscription.elm
================
module Subscription exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Http
import Json.Decode as Decode exposing (Decoder)
import Json.Decode.Pipeline as Pipeline
import Json.Encode as Encode
import Svg exposing (path, svg)
import Svg.Attributes exposing (clipRule, d, fill, fillRule, viewBox)
import Time



-- MODEL


type alias Model =
    { subscriptionData : Maybe SubscriptionData
    , paymentMethods : List PaymentMethod
    , billingHistory : List BillingRecord
    , isLoading : Bool
    , error : Maybe String
    , activeTab : Tab
    , contactCount : Int
    , autoUpgradeLimit : Int
    , upgradeModalOpen : Bool
    , selectedTier : Int
    }


type Tab
    = PlanTab
    | PaymentTab
    | BillingTab


type alias SubscriptionData =
    { id : String
    , status : String
    , tier : Int
    , contactLimit : Int
    , currentPeriodEnd : String
    , cancelAtPeriodEnd : Bool
    , features : List String
    }


type alias PaymentMethod =
    { id : String
    , brand : String
    , last4 : String
    , expiryMonth : Int
    , expiryYear : Int
    , isDefault : Bool
    }


type alias BillingRecord =
    { id : String
    , date : String
    , amount : Float
    , status : String
    , description : String
    , invoiceUrl : Maybe String
    }


init : () -> ( Model, Cmd Msg )
init _ =
    ( { subscriptionData = Nothing
      , paymentMethods = []
      , billingHistory = []
      , isLoading = True
      , error = Nothing
      , activeTab = PlanTab
      , contactCount = 0
      , autoUpgradeLimit = 0
      , upgradeModalOpen = False
      , selectedTier = 1
      }
    , Cmd.batch
        [ fetchSubscriptionData
        , fetchPaymentMethods
        , fetchBillingHistory
        ]
    )



-- UPDATE


type Msg
    = GotSubscriptionData (Result Http.Error SubscriptionDataResponse)
    | GotPaymentMethods (Result Http.Error (List PaymentMethod))
    | GotBillingHistory (Result Http.Error (List BillingRecord))
    | ChangeTier Int
    | UpgradeTier Int
    | UpgradeTierResult (Result Http.Error UpgradeResponse)
    | AddPaymentMethod
    | RemovePaymentMethod String
    | SetDefaultPaymentMethod String
    | PaymentMethodUpdated (Result Http.Error (List PaymentMethod))
    | DownloadInvoice String
    | ChangeTab Tab
    | OpenUpgradeModal Int
    | CloseUpgradeModal
    | SetAutoUpgradeLimit Int
    | AutoUpgradeLimitUpdated (Result Http.Error AutoUpgradeResponse)
    | CreateCheckoutSession Int
    | GotCheckoutSession (Result Http.Error CheckoutResponse)
    | NoOp


type alias SubscriptionDataResponse =
    { subscription : Maybe SubscriptionData
    , contactCount : Int
    , autoUpgradeLimit : Int
    }


type alias UpgradeResponse =
    { success : Bool
    , previousTier : Maybe Int
    , newTier : Maybe Int
    , contactLimit : Maybe Int
    , message : Maybe String
    }


type alias AutoUpgradeResponse =
    { success : Bool
    , autoUpgradeLimit : Int
    }


type alias CheckoutResponse =
    { clientSecret : String
    , subscriptionId : String
    }


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GotSubscriptionData (Ok response) ->
            ( { model
                | subscriptionData = response.subscription
                , contactCount = response.contactCount
                , autoUpgradeLimit = response.autoUpgradeLimit
                , isLoading = False
              }
            , Cmd.none
            )

        GotSubscriptionData (Err _) ->
            ( { model | error = Just "Failed to load subscription data", isLoading = False }, Cmd.none )

        GotPaymentMethods (Ok methods) ->
            ( { model | paymentMethods = methods, isLoading = False }, Cmd.none )

        GotPaymentMethods (Err _) ->
            ( { model | error = Just "Failed to load payment methods", isLoading = False }, Cmd.none )

        GotBillingHistory (Ok history) ->
            ( { model | billingHistory = history, isLoading = False }, Cmd.none )

        GotBillingHistory (Err _) ->
            ( { model | error = Just "Failed to load billing history", isLoading = False }, Cmd.none )

        ChangeTier tier ->
            ( { model | selectedTier = tier }, Cmd.none )

        OpenUpgradeModal tier ->
            ( { model | upgradeModalOpen = True, selectedTier = tier }, Cmd.none )

        CloseUpgradeModal ->
            ( { model | upgradeModalOpen = False }, Cmd.none )

        UpgradeTier tier ->
            ( { model | isLoading = True, upgradeModalOpen = False }
            , upgradeTier tier
            )

        UpgradeTierResult (Ok response) ->
            if response.success then
                case model.subscriptionData of
                    Just subscription ->
                        let
                            updatedSubscription =
                                { subscription
                                    | tier = Maybe.withDefault subscription.tier response.newTier
                                    , contactLimit = Maybe.withDefault subscription.contactLimit response.contactLimit
                                }
                        in
                        ( { model
                            | subscriptionData = Just updatedSubscription
                            , isLoading = False
                          }
                        , Cmd.none
                        )

                    Nothing ->
                        -- Should not happen, but handle it gracefully
                        ( { model | isLoading = False }
                        , fetchSubscriptionData
                        )

            else
                ( { model
                    | error = Just (Maybe.withDefault "Failed to upgrade subscription" response.message)
                    , isLoading = False
                  }
                , Cmd.none
                )

        UpgradeTierResult (Err _) ->
            ( { model | error = Just "Failed to upgrade subscription", isLoading = False }, Cmd.none )

        AddPaymentMethod ->
            -- In a real implementation, this would open a Stripe form or similar
            ( model, Cmd.none )

        RemovePaymentMethod id ->
            ( { model | isLoading = True }, removePaymentMethod id )

        SetDefaultPaymentMethod id ->
            ( { model | isLoading = True }, setDefaultPaymentMethod id )

        PaymentMethodUpdated (Ok methods) ->
            ( { model | paymentMethods = methods, isLoading = False }, Cmd.none )

        PaymentMethodUpdated (Err _) ->
            ( { model | error = Just "Failed to update payment method", isLoading = False }, Cmd.none )

        DownloadInvoice url ->
            -- This would trigger a download in a real implementation
            ( model, Cmd.none )

        ChangeTab tab ->
            ( { model | activeTab = tab }, Cmd.none )

        SetAutoUpgradeLimit limit ->
            ( { model | isLoading = True }
            , updateAutoUpgradeLimit limit
            )

        AutoUpgradeLimitUpdated (Ok response) ->
            if response.success then
                ( { model
                    | autoUpgradeLimit = response.autoUpgradeLimit
                    , isLoading = False
                  }
                , Cmd.none
                )

            else
                ( { model
                    | error = Just "Failed to update auto-upgrade limit"
                    , isLoading = False
                  }
                , Cmd.none
                )

        AutoUpgradeLimitUpdated (Err _) ->
            ( { model
                | error = Just "Failed to update auto-upgrade limit"
                , isLoading = False
              }
            , Cmd.none
            )

        CreateCheckoutSession tier ->
            ( { model | isLoading = True }
            , createCheckoutSession tier
            )

        GotCheckoutSession (Ok response) ->
            -- In a real implementation, this would redirect to Stripe checkout
            -- For now, we just update the state and let JavaScript handle it
            ( model, Cmd.none )

        GotCheckoutSession (Err _) ->
            ( { model
                | error = Just "Failed to create checkout session"
                , isLoading = False
              }
            , Cmd.none
            )

        NoOp ->
            ( model, Cmd.none )



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Subscription & Payments"
    , body =
        [ div [ class "min-h-screen bg-gray-50" ]
            [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" ]
                [ h1 [ class "text-2xl font-semibold text-[#03045E] mb-6" ]
                    [ text "Subscription & Payments" ]
                , if model.isLoading then
                    viewLoading

                  else
                    div []
                        [ viewTabs model
                        , viewTabContent model
                        ]
                , if model.upgradeModalOpen then
                    viewUpgradeModal model

                  else
                    text ""
                ]
            ]
        ]
    }


viewTabs : Model -> Html Msg
viewTabs model =
    div [ class "border-b border-gray-200 mb-6" ]
        [ div [ class "flex -mb-px" ]
            [ viewTab "Subscription Plan" (model.activeTab == PlanTab) (ChangeTab PlanTab)
            , viewTab "Payment Methods" (model.activeTab == PaymentTab) (ChangeTab PaymentTab)
            , viewTab "Billing History" (model.activeTab == BillingTab) (ChangeTab BillingTab)
            ]
        ]


viewTab : String -> Bool -> Msg -> Html Msg
viewTab label isActive msg =
    button
        [ class
            ("px-4 py-2 font-medium text-sm "
                ++ (if isActive then
                        "border-b-2 border-[#03045E] text-[#03045E]"

                    else
                        "text-gray-500 hover:text-gray-700 hover:border-gray-300"
                   )
            )
        , onClick msg
        ]
        [ text label ]


viewTabContent : Model -> Html Msg
viewTabContent model =
    case model.activeTab of
        PlanTab ->
            viewSubscriptionPlan model

        PaymentTab ->
            viewPaymentMethods model

        BillingTab ->
            viewBillingHistory model


viewLoading : Html Msg
viewLoading =
    div [ class "flex justify-center items-center h-64" ]
        [ div [ class "animate-spin rounded-full h-8 w-8 border-4 border-[#03045E] border-t-transparent" ] [] ]


viewSubscriptionPlan : Model -> Html Msg
viewSubscriptionPlan model =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ case model.subscriptionData of
            Just subscription ->
                div [ class "space-y-6" ]
                    [ div [ class "flex justify-between items-center" ]
                        [ div []
                            [ h2 [ class "text-lg font-medium text-gray-900" ]
                                [ text "Current Plan" ]
                            , div [ class "mt-1 text-sm text-gray-500" ]
                                [ text "Contact-based subscription" ]
                            ]
                        , div [ class "px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium" ]
                            [ text subscription.status ]
                        ]
                    , div [ class "border-t border-gray-200 pt-4" ]
                        [ div [ class "flex items-baseline" ]
                            [ span [ class "text-3xl font-bold text-gray-900" ]
                                [ text ("Tier " ++ String.fromInt subscription.tier) ]
                            , span [ class "ml-3 text-gray-500" ]
                                [ text (String.fromInt subscription.contactLimit ++ " contacts") ]
                            ]
                        , div [ class "mt-1 text-sm text-gray-500" ]
                            [ text ("Current usage: " ++ String.fromInt model.contactCount ++ " contacts") ]
                        , div [ class "mt-1 text-sm text-gray-500" ]
                            [ text ("Next billing date: " ++ subscription.currentPeriodEnd) ]
                        ]
                    , div [ class "border-t border-gray-200 pt-4" ]
                        [ h3 [ class "text-md font-medium text-gray-900 mb-2" ]
                            [ text "Features" ]
                        , ul [ class "space-y-2" ]
                            (List.map
                                (\feature ->
                                    li [ class "flex items-center text-gray-600" ]
                                        [ div [ class "mr-2 text-green-500" ]
                                            [ viewCheckIcon ]
                                        , text feature
                                        ]
                                )
                                subscription.features
                            )
                        ]
                    , div [ class "border-t border-gray-200 pt-4" ]
                        [ h3 [ class "text-md font-medium text-gray-900 mb-3" ]
                            [ text "Auto-Upgrade Settings" ]
                        , div [ class "flex items-center space-x-4" ]
                            [ div [ class "text-sm text-gray-700" ]
                                [ text "Automatically upgrade when contacts exceed limit up to: " ]
                            , select
                                [ class "form-select rounded-md border-gray-300 text-sm"
                                , onInput (\value -> SetAutoUpgradeLimit (Maybe.withDefault 0 (String.toInt value)))
                                , value (String.fromInt model.autoUpgradeLimit)
                                ]
                                [ option [ value "0" ] [ text "Disabled (require manual approval)" ]
                                , option [ value "1000" ] [ text "1,000 contacts" ]
                                , option [ value "1500" ] [ text "1,500 contacts" ]
                                , option [ value "2000" ] [ text "2,000 contacts" ]
                                , option [ value "2500" ] [ text "2,500 contacts" ]
                                , option [ value "5000" ] [ text "5,000 contacts" ]
                                ]
                            ]
                        ]
                    , div [ class "border-t border-gray-200 pt-4" ]
                        [ h3 [ class "text-md font-medium text-gray-900 mb-3" ]
                            [ text "Upgrade Your Plan" ]
                        , div [ class "grid grid-cols-3 gap-4" ]
                            (List.map
                                (\tier ->
                                    viewTierCard
                                        tier
                                        (tier * 500)
                                        (if tier == 1 then
                                            60

                                         else
                                            60 + ((tier - 1) * 40)
                                        )
                                        subscription.tier
                                )
                                [ 1, 2, 3, 4, 5, 10 ]
                            )
                        ]
                    ]

            Nothing ->
                div [ class "space-y-6" ]
                    [ div [ class "text-center text-gray-500 py-8" ]
                        [ text "No subscription active. Subscribe to start using the service." ]
                    , div [ class "grid grid-cols-3 gap-4" ]
                        (List.map
                            (\tier ->
                                viewTierCard
                                    tier
                                    (tier * 500)
                                    (if tier == 1 then
                                        60

                                     else
                                        60 + ((tier - 1) * 40)
                                    )
                                    0
                            )
                            [ 1, 2, 3, 4, 5, 10 ]
                        )
                    ]
        ]


viewTierCard : Int -> Int -> Int -> Int -> Html Msg
viewTierCard tier contactLimit price currentTier =
    let
        isCurrentTier =
            tier == currentTier
    in
    div
        [ class
            ("border rounded-lg p-4 "
                ++ (if isCurrentTier then
                        "border-[#03045E] bg-blue-50"

                    else
                        "border-gray-200"
                   )
            )
        ]
        [ div [ class "flex justify-between items-center mb-2" ]
            [ h4 [ class "font-medium text-gray-900" ]
                [ text ("Tier " ++ String.fromInt tier) ]
            , if isCurrentTier then
                span [ class "px-2 py-1 bg-[#03045E] text-white text-xs rounded-full" ]
                    [ text "Current" ]

              else
                text ""
            ]
        , div [ class "flex items-baseline mb-2" ]
            [ span [ class "text-xl font-bold text-gray-900" ]
                [ text ("$" ++ String.fromInt price) ]
            , span [ class "ml-1 text-gray-500 text-sm" ]
                [ text "/month" ]
            ]
        , div [ class "text-sm text-gray-600 mb-4" ]
            [ text (String.fromInt contactLimit ++ " contacts") ]
        , if isCurrentTier then
            button
                [ class "w-full px-3 py-2 text-sm font-medium text-gray-500 bg-gray-100 rounded-md cursor-not-allowed"
                , disabled True
                ]
                [ text "Current Plan" ]

          else if currentTier == 0 then
            button
                [ class "w-full px-3 py-2 text-sm font-medium text-white bg-[#03045E] rounded-md hover:bg-opacity-90"
                , onClick (CreateCheckoutSession tier)
                ]
                [ text "Subscribe" ]

          else if tier > currentTier then
            button
                [ class "w-full px-3 py-2 text-sm font-medium text-white bg-[#03045E] rounded-md hover:bg-opacity-90"
                , onClick (OpenUpgradeModal tier)
                ]
                [ text "Upgrade" ]

          else
            button
                [ class "w-full px-3 py-2 text-sm font-medium text-gray-500 bg-gray-100 rounded-md cursor-not-allowed"
                , disabled True
                ]
                [ text "Lower Tier" ]
        ]


viewUpgradeModal : Model -> Html Msg
viewUpgradeModal model =
    let
        currentTier =
            case model.subscriptionData of
                Just sub ->
                    sub.tier

                Nothing ->
                    0

        currentLimit =
            case model.subscriptionData of
                Just sub ->
                    sub.contactLimit

                Nothing ->
                    0

        newLimit =
            model.selectedTier * 500

        price =
            if model.selectedTier == 1 then
                60

            else
                60 + ((model.selectedTier - 1) * 40)

        currentPrice =
            if currentTier == 1 then
                60

            else
                60 + ((currentTier - 1) * 40)

        priceDifference =
            price - currentPrice
    in
    div [ class "fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50" ]
        [ div [ class "bg-white rounded-lg max-w-lg w-full mx-4" ]
            [ div [ class "p-6" ]
                [ h3 [ class "text-lg font-medium text-gray-900 mb-4" ]
                    [ text "Upgrade Subscription" ]
                , p [ class "text-gray-600 mb-4" ]
                    [ text ("You are upgrading from Tier " ++ String.fromInt currentTier ++ " (" ++ String.fromInt currentLimit ++ " contacts) to Tier " ++ String.fromInt model.selectedTier ++ " (" ++ String.fromInt newLimit ++ " contacts).") ]
                , p [ class "text-gray-600 mb-4" ]
                    [ text ("Your monthly price will increase by $" ++ String.fromInt priceDifference ++ ", from $" ++ String.fromInt currentPrice ++ " to $" ++ String.fromInt price ++ ".") ]
                , p [ class "text-gray-600 mb-6" ]
                    [ text "This change will take effect immediately, and you will be charged a prorated amount for the remainder of your billing cycle." ]
                , div [ class "flex justify-end space-x-4" ]
                    [ button
                        [ class "px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200"
                        , onClick CloseUpgradeModal
                        ]
                        [ text "Cancel" ]
                    , button
                        [ class "px-4 py-2 text-sm font-medium text-white bg-[#03045E] rounded-md hover:bg-opacity-90"
                        , onClick (UpgradeTier model.selectedTier)
                        ]
                        [ text "Confirm Upgrade" ]
                    ]
                ]
            ]
        ]


viewPaymentMethods : Model -> Html Msg
viewPaymentMethods model =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ div [ class "flex justify-between items-center mb-4" ]
            [ h2 [ class "text-lg font-medium text-gray-900" ]
                [ text "Payment Methods" ]
            , button
                [ class "px-4 py-2 text-sm font-medium text-white bg-[#03045E] rounded-md hover:bg-opacity-90"
                , onClick AddPaymentMethod
                ]
                [ text "Add Payment Method" ]
            ]
        , if List.isEmpty model.paymentMethods then
            div [ class "text-center text-gray-500 py-8" ]
                [ text "No payment methods added yet" ]

          else
            div [ class "space-y-4" ]
                (List.map viewPaymentMethod model.paymentMethods)
        ]


viewPaymentMethod : PaymentMethod -> Html Msg
viewPaymentMethod method =
    div [ class "border rounded-lg p-4 flex justify-between items-center" ]
        [ div [ class "flex items-center" ]
            [ div [ class "flex-shrink-0 w-10 h-6 bg-gray-100 rounded flex items-center justify-center mr-3" ]
                [ text (String.left 1 method.brand) ]
            , div []
                [ div [ class "text-gray-900" ]
                    [ text (method.brand ++ " •••• " ++ method.last4) ]
                , div [ class "text-sm text-gray-500" ]
                    [ text ("Expires " ++ String.fromInt method.expiryMonth ++ "/" ++ String.fromInt method.expiryYear) ]
                ]
            ]
        , div [ class "flex items-center space-x-2" ]
            [ if method.isDefault then
                span [ class "px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full" ]
                    [ text "Default" ]

              else
                button
                    [ class "text-sm text-blue-600 hover:text-blue-800"
                    , onClick (SetDefaultPaymentMethod method.id)
                    ]
                    [ text "Set Default" ]
            , button
                [ class "text-sm text-red-600 hover:text-red-800"
                , onClick (RemovePaymentMethod method.id)
                ]
                [ text "Remove" ]
            ]
        ]


viewBillingHistory : Model -> Html Msg
viewBillingHistory model =
    div [ class "bg-white shadow rounded-lg p-6" ]
        [ h2 [ class "text-lg font-medium text-gray-900 mb-4" ]
            [ text "Billing History" ]
        , if List.isEmpty model.billingHistory then
            div [ class "text-center text-gray-500 py-8" ]
                [ text "No billing history available" ]

          else
            div [ class "overflow-x-auto" ]
                [ table [ class "min-w-full divide-y divide-gray-200" ]
                    [ thead [ class "bg-gray-50" ]
                        [ tr []
                            [ th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ]
                                [ text "Date" ]
                            , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ]
                                [ text "Description" ]
                            , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ]
                                [ text "Amount" ]
                            , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ]
                                [ text "Status" ]
                            , th [ class "px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" ]
                                [ text "Actions" ]
                            ]
                        ]
                    , tbody [ class "bg-white divide-y divide-gray-200" ]
                        (List.map viewBillingRecord model.billingHistory)
                    ]
                ]
        ]


viewBillingRecord : BillingRecord -> Html Msg
viewBillingRecord record =
    tr []
        [ td [ class "px-6 py-4 whitespace-nowrap text-sm text-gray-500" ]
            [ text record.date ]
        , td [ class "px-6 py-4 whitespace-nowrap text-sm text-gray-900" ]
            [ text record.description ]
        , td [ class "px-6 py-4 whitespace-nowrap text-sm text-gray-500" ]
            [ text ("$" ++ String.fromFloat record.amount) ]
        , td [ class "px-6 py-4 whitespace-nowrap" ]
            [ span
                [ class
                    ("px-2 py-1 text-xs rounded-full "
                        ++ (case record.status of
                                "Paid" ->
                                    "bg-green-100 text-green-800"

                                "Failed" ->
                                    "bg-red-100 text-red-800"

                                "Pending" ->
                                    "bg-yellow-100 text-yellow-800"

                                _ ->
                                    "bg-gray-100 text-gray-800"
                           )
                    )
                ]
                [ text record.status ]
            ]
        , td [ class "px-6 py-4 whitespace-nowrap text-sm text-gray-500" ]
            [ case record.invoiceUrl of
                Just url ->
                    button
                        [ class "text-blue-600 hover:text-blue-800"
                        , onClick (DownloadInvoice url)
                        ]
                        [ text "Download" ]

                Nothing ->
                    text "—"
            ]
        ]



-- Helper Functions and Icons


viewCheckIcon : Html msg
viewCheckIcon =
    svg
        [ Svg.Attributes.class "h-5 w-5"
        , viewBox "0 0 20 20"
        , fill "currentColor"
        ]
        [ path
            [ fillRule "evenodd"
            , clipRule "evenodd"
            , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            ]
            []
        ]


viewSmallCheckIcon : Html msg
viewSmallCheckIcon =
    svg
        [ Svg.Attributes.class "h-4 w-4"
        , viewBox "0 0 20 20"
        , fill "currentColor"
        ]
        [ path
            [ fillRule "evenodd"
            , clipRule "evenodd"
            , d "M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            ]
            []
        ]



-- HTTP


fetchSubscriptionData : Cmd Msg
fetchSubscriptionData =
    Http.get
        { url = "/api/subscription/status"
        , expect = Http.expectJson GotSubscriptionData subscriptionDataDecoder
        }


subscriptionDataDecoder : Decoder SubscriptionDataResponse
subscriptionDataDecoder =
    Decode.succeed SubscriptionDataResponse
        |> Pipeline.required "subscription" (Decode.nullable subscriptionDecoder)
        |> Pipeline.required "contactCount" Decode.int
        |> Pipeline.required "autoUpgradeLimit" Decode.int


subscriptionDecoder : Decoder SubscriptionData
subscriptionDecoder =
    Decode.succeed SubscriptionData
        |> Pipeline.required "id" Decode.string
        |> Pipeline.required "status" Decode.string
        |> Pipeline.required "tier" Decode.int
        |> Pipeline.required "contactLimit" Decode.int
        |> Pipeline.required "currentPeriodEnd" Decode.string
        |> Pipeline.required "cancelAtPeriodEnd" Decode.bool
        |> Pipeline.hardcoded [ "Contact-based pricing", "Email scheduling", "Analytics dashboard" ]


fetchPaymentMethods : Cmd Msg
fetchPaymentMethods =
    Http.get
        { url = "/api/payment-methods"
        , expect = Http.expectJson GotPaymentMethods (Decode.list paymentMethodDecoder)
        }


paymentMethodDecoder : Decoder PaymentMethod
paymentMethodDecoder =
    Decode.succeed PaymentMethod
        |> Pipeline.required "id" Decode.string
        |> Pipeline.required "brand" Decode.string
        |> Pipeline.required "last4" Decode.string
        |> Pipeline.required "expiryMonth" Decode.int
        |> Pipeline.required "expiryYear" Decode.int
        |> Pipeline.required "isDefault" Decode.bool


fetchBillingHistory : Cmd Msg
fetchBillingHistory =
    Http.get
        { url = "/api/billing-history"
        , expect = Http.expectJson GotBillingHistory (Decode.list billingRecordDecoder)
        }


billingRecordDecoder : Decoder BillingRecord
billingRecordDecoder =
    Decode.succeed BillingRecord
        |> Pipeline.required "id" Decode.string
        |> Pipeline.required "date" Decode.string
        |> Pipeline.required "amount" Decode.float
        |> Pipeline.required "status" Decode.string
        |> Pipeline.required "description" Decode.string
        |> Pipeline.optional "invoiceUrl" (Decode.nullable Decode.string) Nothing


upgradeTier : Int -> Cmd Msg
upgradeTier tier =
    Http.post
        { url = "/api/subscription/upgrade"
        , body = Http.jsonBody (Encode.object [ ( "newTier", Encode.int tier ) ])
        , expect = Http.expectJson UpgradeTierResult upgradeResponseDecoder
        }


upgradeResponseDecoder : Decoder UpgradeResponse
upgradeResponseDecoder =
    Decode.succeed UpgradeResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.optional "previousTier" (Decode.nullable Decode.int) Nothing
        |> Pipeline.optional "newTier" (Decode.nullable Decode.int) Nothing
        |> Pipeline.optional "contactLimit" (Decode.nullable Decode.int) Nothing
        |> Pipeline.optional "message" (Decode.nullable Decode.string) Nothing


updateAutoUpgradeLimit : Int -> Cmd Msg
updateAutoUpgradeLimit limit =
    Http.post
        { url = "/api/subscription/auto-upgrade"
        , body = Http.jsonBody (Encode.object [ ( "autoUpgradeLimit", Encode.int limit ) ])
        , expect = Http.expectJson AutoUpgradeLimitUpdated autoUpgradeLimitDecoder
        }


autoUpgradeLimitDecoder : Decoder AutoUpgradeResponse
autoUpgradeLimitDecoder =
    Decode.succeed AutoUpgradeResponse
        |> Pipeline.required "success" Decode.bool
        |> Pipeline.required "autoUpgradeLimit" Decode.int


createCheckoutSession : Int -> Cmd Msg
createCheckoutSession tier =
    Http.post
        { url = "/api/subscription/checkout"
        , body = Http.jsonBody (Encode.object [ ( "contactTier", Encode.int tier ) ])
        , expect = Http.expectJson GotCheckoutSession checkoutResponseDecoder
        }


checkoutResponseDecoder : Decoder CheckoutResponse
checkoutResponseDecoder =
    Decode.succeed CheckoutResponse
        |> Pipeline.required "clientSecret" Decode.string
        |> Pipeline.required "subscriptionId" Decode.string


removePaymentMethod : String -> Cmd Msg
removePaymentMethod id =
    Http.post
        { url = "/api/payment-methods/remove"
        , body = Http.jsonBody (Encode.object [ ( "id", Encode.string id ) ])
        , expect = Http.expectJson PaymentMethodUpdated (Decode.list paymentMethodDecoder)
        }


setDefaultPaymentMethod : String -> Cmd Msg
setDefaultPaymentMethod id =
    Http.post
        { url = "/api/payment-methods/set-default"
        , body = Http.jsonBody (Encode.object [ ( "id", Encode.string id ) ])
        , expect = Http.expectJson PaymentMethodUpdated (Decode.list paymentMethodDecoder)
        }



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/TempLanding.elm
================
module TempLanding exposing (Model, Msg(..), init, subscriptions, update, view)

import Browser
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (onClick)


type alias Model =
    {}


type Msg
    = NavigateTo String


init : () -> ( Model, Cmd Msg )
init _ =
    ( {}, Cmd.none )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NavigateTo _ ->
            ( model, Cmd.none )


view : Model -> Browser.Document Msg
view model =
    { title = "Welcome"
    , body =
        [ div [ class "min-h-screen bg-gray-50 flex flex-col justify-center" ]
            [ div [ class "text-center space-y-8" ]
                [ h1 [ class "text-4xl font-bold text-gray-900" ]
                    [ text "Welcome! You're logged in!" ]
                , div [ class "flex justify-center space-x-4" ]
                    [ button
                        [ class "inline-flex items-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        , onClick (NavigateTo "/dashboard")
                        ]
                        [ text "Go to Dashboard" ]
                    , button
                        [ class "inline-flex items-center px-4 py-2 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        , onClick (NavigateTo "/settings")
                        ]
                        [ text "Go to Settings" ]
                    ]
                ]
            ]
        ]
    }


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: src/vite-env.d.ts
================
/// <reference types="vite/client" />

declare module "*.elm" {
  export const Elm: any;
}

================
File: src/Waitlist.elm
================
module Waitlist exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Html exposing (Html, a, button, div, form, h1, img, input, label, p, span, text)
import Html.Attributes exposing (class, disabled, for, href, id, min, placeholder, type_, value)
import Html.Events exposing (onInput, onSubmit)
import Http
import Json.Encode


type alias Model =
    { name : String
    , email : String
    , phone : String
    , displayPhone : String
    , numAgents : String
    , bookSize : String
    , formState : FormState
    , errorMessage : Maybe String
    }


type FormState
    = Editing
    | Submitting
    | Success
    | Error


type Msg
    = UpdateName String
    | UpdateEmail String
    | UpdatePhone String
    | UpdateNumAgents String
    | UpdateBookSize String
    | SubmitForm
    | GotSubmitResponse (Result Http.Error ())


init : ( Model, Cmd Msg )
init =
    ( { name = ""
      , email = ""
      , phone = ""
      , displayPhone = ""
      , numAgents = ""
      , bookSize = ""
      , formState = Editing
      , errorMessage = Nothing
      }
    , Cmd.none
    )


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        UpdateName value ->
            ( { model | name = value }, Cmd.none )

        UpdateEmail value ->
            ( { model | email = value }, Cmd.none )

        UpdatePhone value ->
            let
                digitsOnly =
                    String.filter Char.isDigit value
                        |> String.left 10
            in
            ( { model
                | phone = digitsOnly
                , displayPhone = formatPhoneNumber digitsOnly
              }
            , Cmd.none
            )

        UpdateNumAgents value ->
            if String.all Char.isDigit value || value == "" then
                ( { model | numAgents = value }, Cmd.none )

            else
                ( model, Cmd.none )

        UpdateBookSize value ->
            if String.all Char.isDigit value || value == "" then
                ( { model | bookSize = value }, Cmd.none )

            else
                ( model, Cmd.none )

        SubmitForm ->
            if isValidForm model then
                ( { model | formState = Submitting }
                , submitForm model
                )

            else
                ( { model | errorMessage = Just "Please fill out all fields correctly." }
                , Cmd.none
                )

        GotSubmitResponse result ->
            case result of
                Ok _ ->
                    ( { model | formState = Success }
                    , Cmd.none
                    )

                Err _ ->
                    ( { model
                        | formState = Error
                        , errorMessage = Just "Something went wrong. Please try again."
                      }
                    , Cmd.none
                    )


isValidForm : Model -> Bool
isValidForm model =
    not (String.isEmpty model.name)
        && isValidEmail model.email
        && not (String.isEmpty model.phone)
        && isValidPositiveInt model.numAgents
        && isValidPositiveInt model.bookSize


isValidEmail : String -> Bool
isValidEmail email =
    let
        trimmedEmail =
            String.trim email
    in
    not (String.isEmpty trimmedEmail)
        && String.contains "@" trimmedEmail
        && String.contains "." trimmedEmail
        && not (String.startsWith "@" trimmedEmail)
        && not (String.endsWith "@" trimmedEmail)
        && not (String.endsWith "." trimmedEmail)
        && (String.indexes "@" trimmedEmail |> List.length)
        == 1
        && String.length (String.dropLeft (String.length (String.left (String.indexes "." trimmedEmail |> List.head |> Maybe.withDefault 0) trimmedEmail)) trimmedEmail)
        > 1


isValidPositiveInt : String -> Bool
isValidPositiveInt str =
    case String.toInt str of
        Just n ->
            n > 0

        Nothing ->
            False


submitForm : Model -> Cmd Msg
submitForm model =
    Http.post
        { url = "/api/waitlist"
        , body =
            Http.jsonBody
                (encodeFormData model)
        , expect = Http.expectWhatever GotSubmitResponse
        }


encodeFormData : Model -> Json.Encode.Value
encodeFormData model =
    Json.Encode.object
        [ ( "name", Json.Encode.string model.name )
        , ( "email", Json.Encode.string model.email )
        , ( "phone", Json.Encode.string model.phone )
        , ( "numAgents", Json.Encode.string model.numAgents )
        , ( "bookSize", Json.Encode.string model.bookSize )
        ]


view : Model -> Browser.Document Msg
view model =
    { title = "Join the Waitlist - Medicare Max"
    , body =
        [ div [ class "min-h-screen bg-white py-16 px-4 sm:px-6 lg:px-8" ]
            [ div [ class "max-w-md mx-auto" ]
                [ div [ class "text-center mb-8" ]
                    [ a [ href "/", class "block" ]
                        [ img
                            [ Html.Attributes.src "/images/medicare-max-logo.png"
                            , Html.Attributes.alt "Medicare Max Logo"
                            , class "mx-auto mb-6 h-12"
                            ]
                            []
                        ]
                    , h1 [ class "text-3xl font-bold text-gray-900" ]
                        [ text "Join the Waitlist" ]
                    , p [ class "mt-2 text-sm text-gray-600" ]
                        [ text "Be the first to know when we launch." ]
                    ]
                , case model.formState of
                    Success ->
                        div [ class "bg-green-50 p-4 rounded-md" ]
                            [ p [ class "text-green-800 text-center" ]
                                [ text "Thanks for joining! We'll be in touch soon." ]
                            ]

                    _ ->
                        formView model
                ]
            ]
        ]
    }


formView : Model -> Html Msg
formView model =
    form [ onSubmit SubmitForm, class "space-y-8" ]
        [ div [ class "space-y-2" ]
            [ label [ for "name", class "block text-sm font-medium text-gray-700" ]
                [ text "Name" ]
            , div [ class "mt-1" ]
                [ input
                    [ type_ "text"
                    , id "name"
                    , value model.name
                    , onInput UpdateName
                    , class "shadow-sm focus:ring-[#03045E] focus:border-[#03045E] block w-full sm:text-sm border-gray-300 rounded-md px-3.5 py-2.5"
                    , placeholder "John Smith"
                    ]
                    []
                ]
            ]
        , div [ class "space-y-2" ]
            [ label [ for "email", class "block text-sm font-medium text-gray-700" ]
                [ text "Email" ]
            , div [ class "mt-1" ]
                [ input
                    [ type_ "email"
                    , id "email"
                    , value model.email
                    , onInput UpdateEmail
                    , class "shadow-sm focus:ring-[#03045E] focus:border-[#03045E] block w-full sm:text-sm border-gray-300 rounded-md px-3.5 py-2.5"
                    , placeholder "you@example.com"
                    ]
                    []
                ]
            ]
        , div [ class "space-y-2" ]
            [ label [ for "phone", class "block text-sm font-medium text-gray-700" ]
                [ text "Phone Number" ]
            , div [ class "mt-1" ]
                [ input
                    [ type_ "tel"
                    , id "phone"
                    , value model.displayPhone
                    , onInput UpdatePhone
                    , class "shadow-sm focus:ring-[#03045E] focus:border-[#03045E] block w-full sm:text-sm border-gray-300 rounded-md px-3.5 py-2.5"
                    , placeholder "(555) 555-5555"
                    ]
                    []
                ]
            ]
        , div [ class "space-y-2" ]
            [ label [ for "numAgents", class "block text-sm font-medium text-gray-700" ]
                [ text "Number of Agents" ]
            , div [ class "mt-1" ]
                [ input
                    [ type_ "number"
                    , id "numAgents"
                    , value model.numAgents
                    , onInput UpdateNumAgents
                    , class "shadow-sm focus:ring-[#03045E] focus:border-[#03045E] block w-full sm:text-sm border-gray-300 rounded-md px-3.5 py-2.5"
                    , Html.Attributes.min "1"
                    , placeholder "1"
                    ]
                    []
                ]
            ]
        , div [ class "space-y-2" ]
            [ label [ for "bookSize", class "block text-sm font-medium text-gray-700" ]
                [ text "Current Book Size" ]
            , div [ class "mt-1" ]
                [ input
                    [ type_ "number"
                    , id "bookSize"
                    , value model.bookSize
                    , onInput UpdateBookSize
                    , class "shadow-sm focus:ring-[#03045E] focus:border-[#03045E] block w-full sm:text-sm border-gray-300 rounded-md px-3.5 py-2.5"
                    , Html.Attributes.min "1"
                    , placeholder "100"
                    ]
                    []
                ]
            ]
        , if model.errorMessage /= Nothing then
            div [ class "text-red-600 text-sm" ]
                [ text (Maybe.withDefault "" model.errorMessage) ]

          else
            text ""
        , div []
            [ button
                [ type_ "submit"
                , class "w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#03045E] hover:bg-[#1a1f5f] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#03045E]"
                , disabled (model.formState == Submitting)
                ]
                [ text
                    (if model.formState == Submitting then
                        "Submitting..."

                     else
                        "Join Waitlist"
                    )
                ]
            ]
        ]


subscriptions : Model -> Sub Msg
subscriptions model =
    Sub.none


formatPhoneNumber : String -> String
formatPhoneNumber phone =
    let
        digits =
            String.filter Char.isDigit phone
                |> String.left 10

        len =
            String.length digits
    in
    if len == 0 then
        ""

    else if len <= 3 then
        "(" ++ digits

    else if len <= 6 then
        "(" ++ String.left 3 digits ++ ") " ++ String.dropLeft 3 digits

    else
        "(" ++ String.left 3 digits ++ ") " ++ String.slice 3 6 digits ++ "-" ++ String.dropLeft 6 digits

================
File: src/Walkthrough.elm
================
module Walkthrough exposing (Model, Msg, init, subscriptions, update, view)

import Browser
import Browser.Navigation as Nav
import Html exposing (..)
import Html.Attributes exposing (..)
import Html.Events exposing (..)
import Json.Decode as Decode



-- MODEL


type alias Model =
    { key : Nav.Key
    , currentUser : Maybe CurrentUser
    }


type alias CurrentUser =
    { id : String
    , name : String
    , email : String
    , isAdmin : Bool
    , isAgent : Bool
    }


init : Nav.Key -> Maybe CurrentUser -> ( Model, Cmd Msg )
init key currentUser =
    ( { key = key
      , currentUser = currentUser
      }
    , Cmd.none
    )



-- UPDATE


type Msg
    = NoOp


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        NoOp ->
            ( model, Cmd.none )



-- VIEW


view : Model -> Browser.Document Msg
view model =
    { title = "Welcome to Medicare Max"
    , body =
        [ div [ class "min-h-screen bg-gray-50" ]
            [ div [ class "max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10" ]
                [ div [ class "bg-white shadow-md rounded-lg overflow-hidden" ]
                    [ div [ class "px-6 py-4 border-b border-gray-200 bg-[#03045E] text-white" ]
                        [ h1 [ class "text-2xl font-semibold" ]
                            [ text "Welcome to Medicare Max" ]
                        ]
                    , div [ class "p-6" ]
                        [ div [ class "mb-8 text-center" ]
                            [ h2 [ class "text-xl font-medium text-gray-800 mb-2" ]
                                [ text "Get Started with Our Platform" ]
                            , p [ class "text-gray-600 max-w-2xl mx-auto" ]
                                [ text "Watch this video walkthrough to learn how to use Medicare Max and make the most of its features." ]
                            ]
                        , div [ class "mx-auto max-w-4xl bg-gray-100 rounded-lg p-6 aspect-video flex items-center justify-center" ]
                            [ div [ class "text-center" ]
                                [ div [ class "text-6xl text-gray-400 mb-4" ]
                                    [ text "▶️" ]
                                , p [ class "text-gray-500 font-medium" ]
                                    [ text "Video Walkthrough Coming Soon" ]
                                , p [ class "text-gray-400 text-sm mt-2" ]
                                    [ text "This video will demonstrate how to use the Medicare Max platform" ]
                                ]
                            ]
                        , div [ class "mt-10 max-w-3xl mx-auto" ]
                            [ h3 [ class "text-lg font-medium text-gray-800 mb-4" ]
                                [ text "Quick Start Guide" ]
                            , div [ class "bg-blue-50 rounded-lg p-5 border border-blue-100" ]
                                [ ul [ class "space-y-4" ]
                                    [ li [ class "flex" ]
                                        [ div [ class "shrink-0 flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full mr-3" ]
                                            [ text "1" ]
                                        , div []
                                            [ h4 [ class "font-medium text-blue-800" ]
                                                [ text "Set Up Your Profile" ]
                                            , p [ class "text-blue-700 mt-1 text-sm" ]
                                                [ text "Complete your profile information to personalize your experience." ]
                                            ]
                                        ]
                                    , li [ class "flex" ]
                                        [ div [ class "shrink-0 flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full mr-3" ]
                                            [ text "2" ]
                                        , div []
                                            [ h4 [ class "font-medium text-blue-800" ]
                                                [ text "Add Clients" ]
                                            , p [ class "text-blue-700 mt-1 text-sm" ]
                                                [ text "Start adding your clients to manage their information and policies." ]
                                            ]
                                        ]
                                    , li [ class "flex" ]
                                        [ div [ class "shrink-0 flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full mr-3" ]
                                            [ text "3" ]
                                        , div []
                                            [ h4 [ class "font-medium text-blue-800" ]
                                                [ text "Generate Quotes" ]
                                            , p [ class "text-blue-700 mt-1 text-sm" ]
                                                [ text "Use our quoting tools to find the best options for your clients." ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ]
        ]
    }



-- SUBSCRIPTIONS


subscriptions : Model -> Sub Msg
subscriptions _ =
    Sub.none

================
File: vite.config.ts
================
import { defineConfig } from 'vite'
import elmPlugin from 'vite-plugin-elm'
import { resolve } from 'path'
import tailwindcss from '@tailwindcss/vite'

export default defineConfig({
  plugins: [
    elmPlugin({
      // Set a custom temp directory inside your project
      cwd: resolve(__dirname, 'elm-temp')
    }),
    tailwindcss(),
  ],
  resolve: {
    extensions: ['.ts', '.js', '.elm']
  },
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        secure: false,
        configure: (proxy, _options) => {
          proxy.on('error', (err) => {
            console.log('proxy error', err);
          });
          proxy.on('proxyReq', (proxyReq) => {
            console.log('Sending Request:', proxyReq.method, proxyReq.path);
          });
          proxy.on('proxyRes', (proxyRes) => {
            console.log('Received Response:', proxyRes.statusCode);
          });
        }
      }
    },
    allowedHosts: ['localhost', '127.0.0.1', 'medicaremax.ngrok.dev']
  },
  build: {
    outDir: '../dist',
    emptyOutDir: true,
    assetsDir: 'assets',
    rollupOptions: {
      input: {
        main: resolve(__dirname, 'index.html')
      }
    }
  }
})



================================================================
End of Codebase
================================================================
